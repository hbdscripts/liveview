KEXO analytics mapping (UI → API → server → DB)
Generated: 2026-02-14 (origin/main@60569dc)
Timezone: Europe/London (ADMIN_TIMEZONE)

This is the human-readable companion to `audit/map.json`.

---

PAGES → TABLES/CHARTS → ENDPOINTS

Dashboard

- /dashboard/overview (`server/public/dashboard/overview.html`, data-page="dashboard")
  - Tables:
    - Top Products (`dash-top-products`) → GET /api/dashboard-series?range=...
      - UI render: `server/public/app.js` (`renderDashboard`)
      - Server handler: `server/routes/dashboardSeries.js` (`getDashboardSeries`)
      - DB: `orders_shopify_line_items` (paid orders line items) + `sessions` (tracked product landings) + `shopifyProductMetaCache` (handle/title)
      - Metrics (as currently implemented):
        - Revenue: SUM(line_revenue) for paid, non-test, non-cancelled orders containing product (GBP)
        - Orders: COUNT(DISTINCT order_id) for those orders
        - CR%: Orders / product landing sessions × 100 (null if sessions=0)
    - Top Countries (`dash-top-countries`) → GET /api/dashboard-series?range=...
      - DB: `orders_shopify` (paid orders; shipping/billing country extracted from raw_json) + `sessions` by country
    - Trending Up / Trending Down (`dash-trending-up`, `dash-trending-down`) → GET /api/dashboard-series?range=...
      - DB: `orders_shopify_line_items` + `sessions` (now vs prev window) + product meta cache
  - Charts:
    - Revenue / Orders / Sessions / Conv Rate → GET /api/dashboard-series?range=...
    - Revenue vs Ad Spend → GET /api/dashboard-series?range=... (includes google_ads_spend_hourly when available)
  - KPIs:
    - GET /api/kpis?range=...
    - GET /api/kpis-expanded-extra?range=...

- /dashboard/live (`server/public/dashboard/live.html`, data-page="live")
  - Table: Live Sessions (`sessions-table`) → GET /api/sessions?filter=active
  - Table: Latest sales (`latest-sales-table`) → GET /api/latest-sales?limit=5
  - Chart: Online now (map/time-series) → GET /api/sessions/online-series?minutes=5&stepMinutes=1
  - Session side-panel events → GET /api/sessions/:id/events?limit=20

- /dashboard/sales (`server/public/dashboard/sales.html`, data-page="sales")
  - Table: Recent Sales sessions (`sessions-table`) → GET /api/sessions?range=sales&limit=...&offset=...&timezone=...
  - Chart: Sales Trend → GET /api/dashboard-series?range=...

- /dashboard/table (`server/public/dashboard/table.html`, data-page="date")
  - Table: Sessions (`sessions-table`) → GET /api/sessions?range=...&limit=...&offset=...&timezone=...
  - Chart: Sessions & Orders Trend → GET /api/dashboard-series?range=...

Insights

- /insights/countries (`server/public/insights/countries.html`, data-page="countries")
  - Table: Country (`country-table`) → GET /api/stats?range=...
  - Table: Country + Product (`best-geo-products-table`) → GET /api/stats?range=...
  - Chart: Geographic Distribution map → GET /api/stats?range=...

- /insights/products (`server/public/insights/products.html`, data-page="products")
  - Chart: Revenue by Product (`products-chart`) → GET /api/shopify-best-sellers?shop=...&range=...
  - Table: Best Sellers (`best-sellers-table`) → GET /api/shopify-best-sellers?shop=...&range=...&page=...&pageSize=...&sort=...&dir=...
  - Table: Variant (`best-variants-table`) → GET /api/shopify-best-variants?shop=...&range=...&page=...&pageSize=...
  - Tables: Type tables (Necklaces/Bracelets/Earrings/Sets/Charms/Extras) → GET /api/shopify-leaderboard?shop=...&range=...&topProducts=...&topTypes=...
  - Variant breakdown cards:
    - GET /api/shopify-finishes?shop=...&range=...
    - GET /api/shopify-lengths?shop=...&range=...
    - GET /api/shopify-chain-styles?shop=...&range=...

- /insights/variants (`server/public/insights/variants.html`, data-page="variants")
  - Dynamic per-config tables → GET /api/insights-variants?shop=...&range=...
  - Mapping suggestions → GET /api/insights-variants-suggestions?range=...
  - Apply suggestions → POST /api/insights-variants-suggestions/apply

- /insights/abandoned-carts (`server/public/insights/abandoned-carts.html`, data-page="abandoned-carts")
  - Mode selector: Abandoned Carts (cart) / Abandoned Checkouts (checkout) affects all queries.
  - Chart: Abandoned value trend → GET /api/abandoned-carts/series?range=...&mode=...&timezone=...
    - Response: series[].abandoned (count), series[].abandoned_value_gbp (GBP), totalAbandonedGbp.
  - Table: Countries (`abandoned-carts-countries-table`) → GET /api/abandoned-carts/top-countries?range=...&mode=...&timezone=...&limit=5
    - Abandoned: COUNT(abandoned sessions) in range
    - Checkout: COUNT(checkout_started sessions) in range (context metric + checkout-mode denominator)
    - % Abandoned: Abandoned / (cart sessions started in range OR checkout sessions started in range) × 100 (NULL if denom=0)
    - Value: SUM(cart_value converted to GBP) for abandoned sessions in range
  - Table: Country + Product (`abandoned-carts-country-products-table`) → GET /api/abandoned-carts/top-country-products?range=...&mode=...&timezone=...&limit=5
    - Same metrics as Countries, but grouped by (country, first_product_handle). Titles are best-effort Shopify meta.
  - Table: Abandoned sessions (`sessions-table`) → GET /api/abandoned-carts/sessions?range=...&mode=...&timezone=...&limit=...&offset=...
    - Response mirrors the sessions table schema but is filtered to abandoned rows.

Acquisition (Attribution + Devices)

- /acquisition/attribution (`server/public/acquisition/attribution.html`, data-page="attribution")
  - Table: Attribution (`attribution-table`) → GET /api/attribution/report?range=...
  - Chart: Acquisition · Attribution (`attribution-chart`) → GET /api/attribution/report?range=...

- /acquisition/devices (`server/public/acquisition/devices.html`, data-page="devices")
  - Table: Devices (`devices-table`) → GET /api/devices/report?range=...
  - Chart: Acquisition · Devices (`devices-chart`) → GET /api/devices/report?range=...

Integrations

- /integrations/google-ads (`server/public/integrations/google-ads.html`, data-page="ads")
  - Chart: Campaign Sales, Spend & ROAS (`ads-overview-chart`) → GET /api/ads/summary?range=...
  - Table: Google Ads campaigns (`ads-root`) → GET /api/ads/summary?range=...
  - Modal: campaign detail + attributed sales → GET /api/ads/campaign-detail?range=...&campaignId=...

Tools

- /tools/compare-conversion-rate (`server/public/tools/compare-conversion-rate.html`, data-page="compare-conversion-rate")
  - Catalog search → GET /api/tools/catalog-search?q=...
  - Load variants (Shopify variants or mapped groups) → GET /api/tools/compare-cr/variants... and /api/tools/compare-cr/mapped-groups...
  - Compare before/after → POST /api/tools/compare-cr/compare
  - Results table is rendered client-side into #results using KEXO_TOOLS_TABLE_DEFS.

- /tools/shipping-cr (`server/public/tools/shipping-cr.html`, data-page="shipping-cr")
  - Results → POST /api/tools/shipping-cr/labels
  - Backfill labels → POST /api/tools/shipping-cr/backfill/start and polling GET /api/tools/shipping-cr/backfill/status?job_id=...

- /tools/ads (`server/public/tools/ads.html`, data-page="ads") is a legacy Tools wrapper for the same Ads UI; redirects exist.

Shared modals/endpoints (reachable from many pages)

- Product Insights modal → GET /api/product-insights?handle=...&range=... (or product_id=...)
- Page Insights modal → GET /api/page-insights?url=...&range=...
- Store base URL + shop domain → GET /api/store-base-url
- Theme/settings/config diagnostics → GET /api/settings, GET /api/theme-defaults, GET /api/config-status
- Settings assets:
  - Read overrides → GET /api/asset-overrides
  - Upload asset (R2) → POST /api/assets/upload?slot=... (multipart/form-data)

