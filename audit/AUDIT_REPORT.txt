KEXO reporting audit (end-to-end)
Generated: 2026-02-14 (origin/main@60569dc)

This is a living audit report focused on data consistency and metric correctness across the UI (tables/charts/KPIs).
Companion files:
- audit/map.json (machine-readable UI → API → handler → DB mapping)
- audit/METRICS_MAP.txt (human summary of the mapping)
- audit/METRICS.txt (canonical metric definitions)

---

Scope (so far)

- Phase 0 (Inventory & mapping): Completed for the primary analytics pages (Dashboard/Insights/Traffic/Integrations/Tools) and refreshed to include newer Insights/Settings additions.
- Phase 1 (Metric definitions): Core metric semantics documented in audit/METRICS.txt.
- Fixes shipped: Dashboard CR% guardrails + stats caching normalization + shared metric helper + unit tests + range-key normalization fixes where needed.

---

Findings and fixes

1) Dashboard > Top Products table showed “Orders > 0 but CR% = 0.0%”

- Symptom:
  - Dashboard Overview “Top Products” could show nonzero Orders (from Shopify truth) but CR% rendered as 0.0%.
- Root causes:
  - Server-side CR% calculation treated sessions=0 as CR%=0 (coercion instead of undefined).
  - Session attribution for product landings was narrower than other product reports (handle only from `first_product_handle`), undercounting sessions.
- Fix (shipped):
  - `/api/dashboard-series` now returns `cr: null` when Sessions=0 (undefined ratio).
  - Product landing sessions attribution now resolves handle from `first_path`, then `first_product_handle`, then `entry_url` (aligned with Products → Best Sellers).
  - UI guardrail: when Sessions=0, CR% is rendered as `—` (tooltip when Orders>0) so stale cached payloads can’t show misleading 0.0%.

2) `/api/stats` caching key stability (custom range support)

- Finding:
  - `/api/stats` accepted `range=` but cache key metadata was not consistently tied to the requested range bounds.
- Fix (shipped):
  - `/api/stats` now normalizes `range` keys and uses that range’s computed bounds for cache key metadata.

3) Shared ratio/percent helper + tests

- Finding:
  - Ratio metrics (CR%, bounce rate, etc.) were computed with multiple ad-hoc patterns across routes.
- Fix (shipped):
  - Added `server/metrics.js` with `percentOrNull()` + `roundTo()`.
  - Added unit tests (`npm test`) to lock in divide-by-zero and rounding behaviour.

4) Insights → Variants range mismatch (“Last 7 days” fell back to Today)

- Symptom:
  - UI could send `range=7days/14days/30days` but `/api/insights-variants` expected `7d/14d/30d`; unnormalized values fell back to `today`, under-reporting data.
- Fix (shipped):
  - `/api/insights-variants` now normalizes `7days→7d`, `14days→14d`, `30days→30d` (mirrors other range normalization patterns).

5) Inventory refresh: Insights → Abandoned Carts + Settings asset endpoints

- Finding:
  - New page `/insights/abandoned-carts` and API `/api/abandoned-carts/*` exist (plus Settings assets endpoints `GET /api/asset-overrides`, `POST /api/assets/upload`) and must be included in mapping/definitions to keep the audit current.
- Update (this refresh):
  - `audit/map.json` and `audit/METRICS_MAP.txt` now include Abandoned Carts tables/chart and the new asset endpoints.
  - `audit/METRICS.txt` now documents Abandoned Carts/Checkouts metric semantics and range-key normalization expectations.

---

Open items / next steps

- Deep-audit each analytics endpoint for:
  - consistent filters (paid/test/cancelled, bot filtering)
  - consistent time columns (`created_at` vs `processed_at` semantics)
  - attribution parity (sessions → product/country/source)
  - performance (avoid N+1/meta fetch hot paths; cache correctness)
- Integration testing:
  - Added an integration-style test for `/api/dashboard-series` (requires only `npm test`; uses `SQLITE_DB_PATH` to isolate a test DB).
  - Next: add at least one more integration test for another high-value endpoint/table (target: `/api/abandoned-carts/top-countries` to lock in NULL ratio semantics + range normalization).
- Add reconciliation harness to reproduce and validate key edge cases (including “orders > 0 but denominator = 0” => CR% undefined).

