// @generated from client/app - do not edit. Run: npm run build:app
// checksum: d201ff74db3ecf82
!function(){
// Shared formatters + scheduling/fetch helpers — reduces UI jank + duplicate requests.
function formatMoney(amount,currencyCode){if(null==amount||"number"!=typeof amount)return"";var code=(currencyCode||"GBP").toUpperCase();return("GBP"===code?"£":"USD"===code?"$":"EUR"===code?"€":code+" ")+(amount%1==0?amount:amount.toFixed(2))}function formatMoneyCompact(amount,currencyCode){if(null==amount||"number"!=typeof amount)return"";var code=(currencyCode||"GBP").toUpperCase(),sym="GBP"===code?"£":"USD"===code?"$":"EUR"===code?"€":code+" ",n=Number.isFinite(amount)?amount:0;return(n<0?"-":"")+sym+function(amount){var v,raw="number"==typeof amount?amount:Number(amount),n=Number.isFinite(raw)?Math.abs(raw):0;if(n<1e3)return String(Math.round(n));if(n>=1e9){var dec=(v=n/1e9)<100?1:0;return v.toFixed(dec).replace(/\.0$/,"")+"b"}if(n>=1e6)return dec=(v=n/1e6)<100?1:0,v.toFixed(dec).replace(/\.0$/,"")+"m";return dec=(v=n/1e3)<100?1:0,v.toFixed(dec).replace(/\.0$/,"")+"k"}(n)}function fmtPct(n){return null!=n&&Number.isFinite(n)?n.toFixed(1)+"%":"—"}function fmtMoneyGbp(n){var x="number"==typeof n?n:Number(n);if(!Number.isFinite(x))return"—";try{return"£"+x.toLocaleString("en-GB",{minimumFractionDigits:2,maximumFractionDigits:2})}catch(_){return"£"+x.toFixed(2)}}function fetchJson(url,opts){var options=Object.assign({credentials:"same-origin",cache:"no-store"},opts||{});return fetch(url,options).then(function(r){return r.json()})}function kexoDebounce(fn,waitMs){var t=null,lastArgs=null,lastThis=null,wait=Math.max(0,Number(waitMs)||0);function run(){t=null;var args=lastArgs;lastArgs=null;var ctx=lastThis;lastThis=null;try{fn.apply(ctx,args||[])}catch(e){throw e}}function debounced(){if(lastArgs=arguments,lastThis=this,t)try{clearTimeout(t)}catch(_){}t=setTimeout(run,wait)}return debounced.cancel=function(){if(t)try{clearTimeout(t)}catch(_){}t=null,lastArgs=null,lastThis=null},debounced}function kexoThrottle(fn,waitMs){var wait=Math.max(0,Number(waitMs)||0),last=0,t=null,lastArgs=null,lastThis=null;function invoke(){t=null,last=Date.now();var args=lastArgs;lastArgs=null;var ctx=lastThis;lastThis=null;try{fn.apply(ctx,args||[])}catch(e){throw e}}function throttled(){var now=Date.now();lastArgs=arguments,lastThis=this;var remaining=wait-(now-last);if(remaining<=0||remaining>wait){if(t){try{clearTimeout(t)}catch(_){}t=null}invoke()}else t||(t=setTimeout(invoke,remaining))}return throttled.cancel=function(){if(t)try{clearTimeout(t)}catch(_){}t=null,lastArgs=null,lastThis=null},throttled}
// registerCleanup isn't always available in standalone pages; provide a safe wrapper.
var _kexoFallbackCleanupWired=!1,_kexoFallbackCleanupFns=[];function kexoRegisterCleanup(fn){try{return registerCleanup(fn)}catch(_){}if("function"==typeof fn&&_kexoFallbackCleanupFns.push(fn),!_kexoFallbackCleanupWired){_kexoFallbackCleanupWired=!0;try{window.addEventListener("beforeunload",run)}catch(_){}try{window.addEventListener("pagehide",run)}catch(_){}}function run(){_kexoFallbackCleanupFns.forEach(function(f){try{f()}catch(_){}})}}var _kexoJsonStableCache=new Map;function kexoFetchJsonStable(url,opts,ttlMs){var ttl=Math.max(0,Number(ttlMs)||0),method=opts&&opts.method?String(opts.method).toUpperCase():"GET";if("GET"!==method||!ttl)return fetchJson(url,opts);var key=method+" "+String(url),now=Date.now(),cur=_kexoJsonStableCache.get(key)||null;if(cur&&void 0!==cur.value&&cur.expiresAt&&now<cur.expiresAt)return Promise.resolve(cur.value);if(cur&&cur.inFlight)return cur.inFlight;var p=fetchJson(url,Object.assign({},opts||{},{cache:"default"})).then(function(json){return _kexoJsonStableCache.set(key,{value:json,expiresAt:now+ttl,inFlight:null}),json}).catch(function(err){var existing=_kexoJsonStableCache.get(key)||null;throw existing&&existing.inFlight&&_kexoJsonStableCache.set(key,{value:existing.value,expiresAt:existing.expiresAt,inFlight:null}),err});return _kexoJsonStableCache.set(key,{value:cur?cur.value:void 0,expiresAt:cur?cur.expiresAt:0,inFlight:p}),p}new Map;function kexoFetchOkJson(url,opts){var options=Object.assign({credentials:"same-origin",cache:"no-store"},opts||{});return fetch(url,options).then(function(r){return r&&r.ok?r.json():null})}var _kexoOkJsonStableCache=new Map;function kexoFetchOkJsonStable(url,opts,ttlMs){var ttl=Math.max(0,Number(ttlMs)||0),method=opts&&opts.method?String(opts.method).toUpperCase():"GET";if("GET"!==method||!ttl)return kexoFetchOkJson(url,opts);var key=method+" "+String(url),now=Date.now(),cur=_kexoOkJsonStableCache.get(key)||null;if(cur&&void 0!==cur.value&&cur.expiresAt&&now<cur.expiresAt)return Promise.resolve(cur.value);if(cur&&cur.inFlight)return cur.inFlight;var p=kexoFetchOkJson(url,Object.assign({},opts||{},{cache:"default"})).then(function(json){return _kexoOkJsonStableCache.set(key,{value:json,expiresAt:now+ttl,inFlight:null}),json}).catch(function(err){var existing=_kexoOkJsonStableCache.get(key)||null;throw existing&&existing.inFlight&&_kexoOkJsonStableCache.set(key,{value:existing.value,expiresAt:existing.expiresAt,inFlight:null}),err});return _kexoOkJsonStableCache.set(key,{value:cur?cur.value:void 0,expiresAt:cur?cur.expiresAt:0,inFlight:p}),p}function normalizePaymentProviderKey(v){if(null==v)return null;var s=String(v).trim().toLowerCase();return s?"null"===s||"undefined"===s||"true"===s||"false"===s||"[object object]"===s?null:(s=s.replace(/[^a-z0-9_-]+/g,"-").replace(/-+/g,"-").replace(/^-|-$/g,""))?("american-express"===s&&(s="americanexpress"),"amex"===s&&(s="americanexpress"),"apple-pay"===s&&(s="applepay"),"shop-pay"===s&&(s="shop-pay"),"shopify-payments"!==s&&"shopifypayments"!==s||(s="shopify-payments"),s.length>64?s.slice(0,64):s):null:null}function paymentProviderMeta(key){var k=normalizePaymentProviderKey(key);if(!k)return null;return{visa:{label:"Visa",iconKey:"payment-method-visa",iconClass:"fa-brands fa-cc-visa"},mastercard:{label:"Mastercard",iconKey:"payment-method-mastercard",iconClass:"fa-brands fa-cc-mastercard"},americanexpress:{label:"American Express",iconKey:"payment-method-amex",iconClass:"fa-brands fa-cc-amex"},paypal:{label:"PayPal",iconKey:"payment-method-paypal",iconClass:"fa-brands fa-paypal"},applepay:{label:"Apple Pay",iconKey:"payment-method-apple_pay",iconClass:"fa-brands fa-apple-pay"},"google-pay":{label:"Google Pay",iconKey:"payment-method-google_pay",iconClass:"fa-brands fa-google-pay"},klarna:{label:"Klarna",iconKey:"payment-method-klarna",iconClass:"fa-light fa-credit-card"},"shop-pay":{label:"Shop Pay",iconKey:"payment-method-shop_pay",iconClass:"fa-light fa-bag-shopping"},"shopify-payments":{label:"Shopify Payments",iconKey:"payment-method-shop_pay",iconClass:"fa-light fa-bag-shopping"}}[k]||{label:k,iconKey:"payment-method-other",iconClass:"fa-light fa-credit-card"}}function paymentProviderIconHtml(providerKey,opts){function esc(value){return String(null==value?"":value).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}var meta=paymentProviderMeta(providerKey);if(!meta)return"";var extraClass=opts&&opts.extraClass?String(opts.extraClass).trim():"",label=meta.label?String(meta.label):"",iconClass=meta.iconClass?String(meta.iconClass):"fa-light fa-credit-card",iconKey=meta.iconKey?String(meta.iconKey):"payment-method-other";return'<i class="'+esc([iconClass,extraClass].join(" ").trim())+'" data-icon-key="'+esc(iconKey)+'" aria-label="'+esc(label)+'" title="'+esc(label)+'" aria-hidden="true"></i>'}const PAGE=document.body&&document.body.getAttribute("data-page")||"";try{"function"==typeof window.kexoSetContext&&window.kexoSetContext(PAGE||"unknown",{page:PAGE||"unknown"})}catch(_){}try{"function"==typeof window.kexoBreadcrumb&&window.kexoBreadcrumb("app","init",{page:PAGE})}catch(_){}function captureChartError(err,context,extra){try{if("function"!=typeof window.kexoCaptureError)return;var payload={context:context||"chart",page:PAGE||"unknown"};extra&&"object"==typeof extra&&Object.keys(extra).forEach(function(k){payload[k]=extra[k]}),window.kexoCaptureError(err,payload)}catch(_){}}function captureChartMessage(message,context,extra,level){try{if("function"!=typeof window.kexoCaptureMessage)return;var payload={context:context||"chart",page:PAGE||"unknown"};extra&&"object"==typeof extra&&Object.keys(extra).forEach(function(k){payload[k]=extra[k]}),window.kexoCaptureMessage(String(message||""),payload,level||"error")}catch(_){}}function normalizePageLoaderEnabledV1(cfg){const base={v:1,pages:{dashboard:!0,live:!0,sales:!0,date:!0,
// Snapshot uses its own in-card loaders and never calls report-build finish().
snapshot:!1,countries:!0,products:!0,variants:!0,"abandoned-carts":!0,"checkout-funnel":!0,attribution:!0,devices:!0,ads:!0,"compare-conversion-rate":!0,"shipping-cr":!0,"click-order-lookup":!0,"change-pins":!0,
// Settings must never show the page overlay loader.
settings:!1,
// Upgrade page is static marketing (see docs/UPGRADE.md); never show the overlay loader there.
upgrade:!1,
// Admin must never show the overlay loader.
admin:!1}},out={v:1,pages:Object.assign({},base.pages)};if(!cfg||"object"!=typeof cfg)return out;if(1!==Number(cfg.v))return out;const pages=cfg.pages&&"object"==typeof cfg.pages?cfg.pages:null;return pages?(Object.keys(out.pages).forEach(function(key){Object.prototype.hasOwnProperty.call(pages,key)&&(out.pages[key]=!1!==pages[key])}),
// Backwards compatibility: legacy Traffic pages.
"boolean"!=typeof out.pages.attribution&&"boolean"==typeof pages.channels&&(out.pages.attribution=!1!==pages.channels),"boolean"!=typeof out.pages.devices&&"boolean"==typeof pages.type&&(out.pages.devices=!1!==pages.type),out.pages.settings=!1,out.pages.admin=!1,out.pages.snapshot=!1,out):out}var pageLoaderEnabledV1=null;try{var cachedLoaderCfg=safeReadLocalStorageJson("kexo:page-loader-enabled:v1");cachedLoaderCfg&&1===cachedLoaderCfg.v&&(pageLoaderEnabledV1=normalizePageLoaderEnabledV1(cachedLoaderCfg))}catch(_){}function applyPageLoaderEnabledV1(cfg){pageLoaderEnabledV1=normalizePageLoaderEnabledV1(cfg);try{window.__kexoPageLoaderEnabledV1=pageLoaderEnabledV1}catch(_){}try{safeWriteLocalStorageJson("kexo:page-loader-enabled:v1",pageLoaderEnabledV1)}catch(_){}return pageLoaderEnabledV1}function isPageLoaderEnabled(pageKey){var k=String(null==pageKey?"":pageKey).trim().toLowerCase();if(k||(k=String(PAGE||"").trim().toLowerCase()),!k)return!0;if("settings"===k)return!1;if("admin"===k)return!1;if("snapshot"===k)return!1;var cfg=pageLoaderEnabledV1,pages=cfg&&cfg.pages&&"object"==typeof cfg.pages?cfg.pages:null;return!pages||(!Object.prototype.hasOwnProperty.call(pages,k)||!1!==pages[k])}pageLoaderEnabledV1||(pageLoaderEnabledV1={v:1,pages:{dashboard:!0,live:!0,sales:!0,date:!0,snapshot:!1,countries:!0,products:!0,variants:!0,"abandoned-carts":!0,"checkout-funnel":!0,attribution:!0,devices:!0,ads:!0,"compare-conversion-rate":!0,"shipping-cr":!0,"click-order-lookup":!0,"change-pins":!0,settings:!1,upgrade:!1,admin:!1}});try{window.__kexoIsPageLoaderEnabled=isPageLoaderEnabled}catch(_){}try{window.__kexoApplyPageLoaderEnabledV1=applyPageLoaderEnabledV1}catch(_){}var _silentOverlayDepth=0;function kexoWithSilentOverlay(fn){_silentOverlayDepth=Math.max(0,Number(_silentOverlayDepth||0))+1;try{return fn()}finally{_silentOverlayDepth=Math.max(0,Number(_silentOverlayDepth||0)-1)}}function kexoSilentOverlayActive(){return Number(_silentOverlayDepth||0)>0}try{window.__kexoWithSilentOverlay=kexoWithSilentOverlay}catch(_){}try{window.__kexoSilentOverlayActive=kexoSilentOverlayActive}catch(_){}
// Change Pins (timeline annotations) — cached for dashboard chart overlays.
var _changePinsCache=null,_changePinsFetchedAt=0,_changePinsInFlight=null;try{window.__kexoGetChangePinsRecent=function(days,force){var fresh=_changePinsCache&&_changePinsFetchedAt&&Date.now()-_changePinsFetchedAt<6e4;return!force&&fresh?Promise.resolve(_changePinsCache):_changePinsInFlight||(_changePinsInFlight=function(days){var d="number"==typeof days&&isFinite(days)?Math.max(7,Math.min(400,Math.floor(days))):120,url="/api/tools/change-pins/recent?days="+encodeURIComponent(String(d));return fetch(url,{credentials:"same-origin",cache:"default"}).then(function(r){return r&&r.ok?r.json().catch(function(){return null}):null}).then(function(json){var pins=json&&json.ok&&Array.isArray(json.pins)?json.pins:null;return pins?(_changePinsCache=pins,_changePinsFetchedAt=Date.now(),pins):null}).catch(function(err){try{"function"==typeof window.kexoCaptureError&&window.kexoCaptureError(err,{context:"changePins.fetch"})}catch(_){}return null})}(days).finally(function(){_changePinsInFlight=null}))}}catch(_){}try{window.__kexoReadChangePinsRecentCache=function(){return _changePinsCache}}catch(_){}
// ?????? Admin preview mode (UI-only) ????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
// Preview is an admin tool: it affects client UI gating only and cannot bypass server auth.
function normalizePreviewTier(raw){var t=null==raw?"":String(raw).trim().toLowerCase();return t&&new Set(["starter","growth","scale","max","admin"]).has(t)?t:""}function clearPreviewConfig(){try{localStorage.removeItem("kexo:preview:v1")}catch(_){}}function isRealAdminViewer(me){return!(!me||"object"!=typeof me)&&(!0===me.isMaster||(raw=me.role,"admin"===(r=null==raw?"":String(raw).trim().toLowerCase())||"master"===r));var raw,r}function getEffectiveViewer(realMe){var me=realMe&&"object"==typeof realMe?realMe:window.__kexoMe&&"object"==typeof window.__kexoMe?window.__kexoMe:null,realIsAdmin=isRealAdminViewer(me),previewStored=function(){try{var raw=localStorage.getItem("kexo:preview:v1");if(!raw)return null;var parsed=JSON.parse(raw);if(!parsed||"object"!=typeof parsed)return null;if(1!==Number(parsed.v))return null;if(!0!==parsed.enabled)return null;var tier=normalizePreviewTier(parsed.tier);return tier?{v:1,enabled:!0,tier:tier}:null}catch(_){return null}}(),preview=null;realIsAdmin?preview=previewStored:me&&previewStored&&
// Safety: preview should not leak into normal user sessions.
clearPreviewConfig();var previewTier=preview&&preview.tier?String(preview.tier):"",previewEnabled=!!previewTier,effectiveIsAdmin=realIsAdmin;previewEnabled&&(effectiveIsAdmin="admin"===previewTier);var tier=previewEnabled?previewTier:me&&null!=me.tier?String(me.tier).trim().toLowerCase():"",permissions=me&&me.permissions&&"object"==typeof me.permissions?me.permissions:{};return{email:me&&me.email?String(me.email):null,role:effectiveIsAdmin?"admin":"user",tier:tier||null,isAdmin:effectiveIsAdmin,
// Keep legacy name for existing code paths.
isMaster:effectiveIsAdmin,permissions:permissions,preview:{enabled:previewEnabled,tier:previewTier||""},real:{role:me&&null!=me.role?String(me.role):null,tier:me&&null!=me.tier?String(me.tier):null,isAdmin:realIsAdmin}}}function ensurePreviewExitMenuItem(viewer){var menu=document.getElementById("navbar-settings-menu");if(menu){var btn=menu.querySelector('[data-kexo-preview-exit="1"]'),div=menu.querySelector('[data-kexo-preview-divider="1"]');if(btn||((btn=document.createElement("button")).type="button",btn.className="dropdown-item kexo-top-strip-settings-item",btn.setAttribute("data-kexo-preview-exit","1"),btn.innerHTML='<i class="fa-jelly fa-eye kexo-top-strip-settings-item-icon" aria-hidden="true"></i><span data-kexo-preview-exit-label>Preview</span>',btn.addEventListener("click",function(){try{clearPreviewConfig()}catch(_){}try{window.location.reload()}catch(_){}}),menu.insertBefore(btn,menu.firstChild)),div||((div=document.createElement("div")).className="dropdown-divider",div.setAttribute("data-kexo-preview-divider","1"),btn.nextSibling?menu.insertBefore(div,btn.nextSibling):menu.appendChild(div)),!!(viewer&&viewer.preview&&viewer.preview.enabled)){var tier,t,text="Preview: "+(tier=viewer.preview.tier,("starter"===(t=normalizePreviewTier(tier))?"Starter":"growth"===t?"Growth":"scale"===t?"Scale":"max"===t?"Max":"admin"===t?"Admin":"")||"Preview")+" (Exit)",span=btn.querySelector("[data-kexo-preview-exit-label]");span?span.textContent=text:btn.textContent=text;try{btn.classList.remove("d-none")}catch(_){}try{div.classList.remove("d-none")}catch(_){}}else{try{btn.classList.add("d-none")}catch(_){}try{div.classList.add("d-none")}catch(_){}}}}function applyEffectiveViewer(){var v=getEffectiveViewer(window.__kexoMe);0;try{window.__kexoEffectiveViewer=v}catch(_){}try{window.__kexoEffectiveIsAdmin=!!v.isAdmin}catch(_){}try{!function(isAdmin){try{var els=document.querySelectorAll?document.querySelectorAll(".kexo-admin-only"):[];if(!els||!els.length)return;els.forEach(function(el){el&&el.classList&&(isAdmin?el.classList.remove("d-none"):el.classList.add("d-none"))})}catch(_){}}(!!v.isAdmin)}catch(_){}try{!function(permissions){try{var els=document.querySelectorAll?document.querySelectorAll("[data-kexo-perm]"):[];if(!els||!els.length)return;var perms=permissions&&"object"==typeof permissions?permissions:{},showAll=0===Object.keys(perms).length;
// When no permissions (e.g. Shopify embed, no OAuth), show all so nav items are visible.
els.forEach(function(el){if(el&&el.classList){var perm=el.getAttribute&&el.getAttribute("data-kexo-perm");perm&&(showAll||!0===perms[perm]?el.classList.remove("d-none"):el.classList.add("d-none"))}});
// Settings left nav: hide empty categories (no visible children).
try{var cats=document.querySelectorAll?document.querySelectorAll(".settings-nav-category"):[];if(!cats||!cats.length)return;cats.forEach(function(cat){if(cat&&cat.classList&&cat.querySelectorAll&&!cat.classList.contains("kexo-admin-only"))
// Admin-only categories are handled by applyAdminOnlyVisibility().
{var catPerm=cat.getAttribute&&cat.getAttribute("data-kexo-perm");
// Never override permission-based hiding.
if(catPerm&&!0!==perms[catPerm]){try{cat.removeAttribute("data-kexo-empty-hidden")}catch(_){}var lockedLink=cat.querySelector("a[data-settings-tab]:not(.settings-nav-child)");if(lockedLink)try{lockedLink.removeAttribute("data-kexo-empty-hidden")}catch(_){}}else{var children=cat.querySelectorAll(".settings-nav-children a.settings-nav-child"),anyVisible=!1;children&&children.length&&children.forEach(function(a){a&&a.classList&&(a.classList.contains("d-none")||(anyVisible=!0))});var catLink=cat.querySelector("a[data-settings-tab]:not(.settings-nav-child)"),isEmptyHidden=cat.getAttribute&&"1"===cat.getAttribute("data-kexo-empty-hidden");if(anyVisible){if(isEmptyHidden){try{cat.removeAttribute("data-kexo-empty-hidden")}catch(_){}try{cat.classList.remove("d-none")}catch(_){}}if(catLink&&"1"===catLink.getAttribute("data-kexo-empty-hidden")){try{catLink.removeAttribute("data-kexo-empty-hidden")}catch(_){}try{catLink.classList.remove("d-none")}catch(_){}}}else{if(!isEmptyHidden){try{cat.setAttribute("data-kexo-empty-hidden","1")}catch(_){}try{cat.classList.add("d-none")}catch(_){}}if(catLink&&"1"!==catLink.getAttribute("data-kexo-empty-hidden")){try{catLink.setAttribute("data-kexo-empty-hidden","1")}catch(_){}try{catLink.classList.add("d-none")}catch(_){}}}}}})}catch(_){}}catch(_){}}(v.permissions)}catch(_){}try{ensurePreviewExitMenuItem(v)}catch(_){}try{window.dispatchEvent(new CustomEvent("kexo:viewer-changed",{detail:v}))}catch(_){}return v}try{window.__kexoGetEffectiveViewer=function(){return getEffectiveViewer(window.__kexoMe)}}catch(_){}try{window.__kexoApplyEffectiveViewer=applyEffectiveViewer}catch(_){}try{window.__kexoSetPreviewTier=function(tierOrOff){!function(tierOrOff){var tier=normalizePreviewTier(tierOrOff);if(!tier){try{localStorage.removeItem("kexo:preview:v1")}catch(_){}return""}try{localStorage.setItem("kexo:preview:v1",JSON.stringify({v:1,enabled:!0,tier:tier}))}catch(_){}}(tierOrOff),applyEffectiveViewer()}}catch(_){}const TABLE_CLASS_CONFIG=Object.freeze({dashboard:Object.freeze({defaultRows:5,rowOptions:Object.freeze([5,10])}),product:Object.freeze({defaultRows:10,rowOptions:Object.freeze([10,15,20])}),live:Object.freeze({defaultRows:20,rowOptions:Object.freeze([20,30,40,50])})}),TABLE_CLASS_FALLBACK_BY_ID=Object.freeze({"sessions-table":"live","dash-top-products":"dashboard","dash-top-countries":"dashboard","dash-trending":"dashboard","best-sellers-table":"product","best-variants-table":"product","type-necklaces-table":"product","type-bracelets-table":"product","type-earrings-table":"product","type-sets-table":"product","type-charms-table":"product","type-extras-table":"product","country-table":"live","best-geo-products-table":"live","ads-root":"live"});
// Long-lived timers (setInterval / setTimeout that outlive a single view) should call registerCleanup
// with a function that clears them, so pagehide/beforeunload can tear down without leaking.
var _kexoCleanupFns=[];function registerCleanup(fn){"function"==typeof fn&&_kexoCleanupFns.push(fn)}function runCleanup(){_kexoCleanupFns.forEach(function(f){try{f()}catch(_){}});
// Do not clear _kexoCleanupFns so bfcache restore can re-init and next pagehide still cleans up
}try{window.addEventListener("beforeunload",runCleanup),window.addEventListener("pagehide",runCleanup)}catch(_){}!function(){
// Debounce hot resize work to reduce layout jank.
function run(){var mounts=document.querySelectorAll("[data-kexo-table]");if(mounts.length){var build="function"==typeof window.buildKexoGridTable?window.buildKexoGridTable:null,buildNative="function"==typeof window.buildKexoNativeTable?window.buildKexoNativeTable:null,defs=window.KEXO_TABLE_DEFS,nativeDefs=window.KEXO_NATIVE_TABLE_DEFS;(build||buildNative)&&mounts.forEach(function(mount){var tableId=mount.getAttribute("data-kexo-table");if(tableId){var def=defs&&defs[tableId],nativeDef=nativeDefs&&nativeDefs[tableId];if(def&&build){
// Live View: hide Exit column only on /dashboard/live.
var cols=Array.isArray(def.columns)?def.columns.slice():[];try{"live"===String(PAGE||"").trim().toLowerCase()&&"sessions-table"===String(tableId||"").trim().toLowerCase()&&(cols=cols.filter(function(c){return"exit"!==(c&&null!=c.key?String(c.key).trim().toLowerCase():"")}))}catch(_){}var config=Object.assign({},def,{tableId:tableId,wrapId:(mount.id||tableId+"-mount")+"-wrap",bodyId:def.bodyId||tableId+"-body",columns:cols});mount.outerHTML=build(config)}else if(nativeDef&&buildNative){if(["dash-top-products","dash-top-countries","dash-trending"].indexOf(tableId)>=0){var wrapId=tableId+"-wrap",bodyId=tableId+"-body";mount.outerHTML='<div id="'+wrapId+'"><div id="'+bodyId+'" class="kexo-dash-top-list" role="list" aria-label="'+tableId.replace(/-/g," ")+' list"></div></div>'}else{var nativeConfig=Object.assign({},nativeDef,{tableId:tableId});mount.outerHTML=buildNative(nativeConfig)}}}})}}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",run):run()}();const tableRowsCache={};var pageBody,overlay,tablesUiConfigV1=null;
// Hydrate table layout/pagination prefs from localStorage for first paint.
try{var cachedTables=safeReadLocalStorageJson("kexo:tables-ui-config:v1");if(cachedTables&&1===cachedTables.v&&Array.isArray(cachedTables.pages)){tablesUiConfigV1=cachedTables;try{window.__kexoTablesUiConfigV1=cachedTables}catch(_){}}}catch(_){}function normalizeUiPageKey(key){return String(null==key?"":key).trim().toLowerCase()||""}function normalizeUiTableId(id){return String(null==id?"":id).trim().toLowerCase()}function getTablesUiPageCfg(pageKey){var cfg=tablesUiConfigV1;if(!cfg||1!==cfg.v||!Array.isArray(cfg.pages))return null;var pk=normalizeUiPageKey(pageKey||PAGE);if(!pk)return null;for(var i=0;i<cfg.pages.length;i++){var p=cfg.pages[i];if(p&&"object"==typeof p){var k=null!=p.key?normalizeUiPageKey(p.key):"";if(k&&k===pk)return p}}return null}function resolveVariantsTableId(tableId,pageKey){var id=String(null==tableId?"":tableId).trim().toLowerCase(),pk=normalizeUiPageKey(pageKey||PAGE);return 0===id.indexOf("variants-table-")&&"variants"===pk?"insights-variants-tables":id}function getTablesUiTableCfg(tableId,pageKey){var p=getTablesUiPageCfg(pageKey||PAGE);if(!p||!Array.isArray(p.tables))return null;var id=normalizeUiTableId(resolveVariantsTableId(tableId,pageKey));if(!id)return null;for(var i=0;i<p.tables.length;i++){var t=p.tables[i];if(t&&"object"==typeof t){var tid=null!=t.id?normalizeUiTableId(t.id):"";if(tid&&tid===id)return t}}return null}function tablesUiConfigSignature(cfg){try{return JSON.stringify(cfg||null)}catch(_){return""}}function applyTablesUiConfigV1(cfg){if(!cfg||"object"!=typeof cfg||1!==cfg.v||!Array.isArray(cfg.pages))return!1;var prevSig=tablesUiConfigSignature(tablesUiConfigV1),nextSig=tablesUiConfigSignature(cfg);tablesUiConfigV1=cfg;try{window.__kexoTablesUiConfigV1=cfg}catch(_){}try{safeWriteLocalStorageJson("kexo:tables-ui-config:v1",cfg)}catch(_){}try{Object.keys(tableRowsCache).forEach(function(k){delete tableRowsCache[k]})}catch(_){}var changed=prevSig!==nextSig;if(changed)try{!function(cfg){
// Dashboard tables are frequently configured in Settings/Modals, but a stale per-table localStorage
// override can take precedence and make "Default rows" appear ignored. When the UI config changes,
// sync dashboard table row overrides to the configured defaults so the saved setting wins.
if(!cfg||1!==cfg.v||!Array.isArray(cfg.pages))return;for(var dashPage=null,i=0;i<cfg.pages.length;i++){var p=cfg.pages[i];if(p&&"object"==typeof p&&"dashboard"===normalizeUiPageKey(p.key)){dashPage=p;break}}if(!dashPage||!Array.isArray(dashPage.tables))return;dashPage.tables.forEach(function(t){if(t&&"object"==typeof t){var tableId=null!=t.id?normalizeUiTableId(t.id):"";if(tableId)if("dashboard"===getTableClassByTableId(tableId,"dashboard")&&t.rows&&"object"==typeof t.rows){var defaultRows=t.rows.default;if("number"==typeof defaultRows&&Number.isFinite(defaultRows)&&!((defaultRows=Math.round(defaultRows))<=0||defaultRows>200)){var rowOptions=null,opts=Array.isArray(t.rows.options)?t.rows.options:null;if(opts&&opts.length){var seen={},normalized=[];opts.forEach(function(n){var x=Math.round(Number(n));!Number.isFinite(x)||x<=0||x>200||seen[x]||(seen[x]=!0,normalized.push(x))}),normalized.sort(function(a,b){return a-b}),normalized.length&&(rowOptions=normalized.slice(0,12))}if(!rowOptions||!rowOptions.length){var fallback=tableClassConfig("dashboard");rowOptions=Array.isArray(fallback&&fallback.rowOptions)?fallback.rowOptions.slice():[5,10]}if(rowOptions.indexOf(defaultRows)<0){for(var nearest=rowOptions[0],nearestDiff=Math.abs(nearest-defaultRows),j=1;j<rowOptions.length;j++){var diff=Math.abs(rowOptions[j]-defaultRows);diff<nearestDiff&&(nearest=rowOptions[j],nearestDiff=diff)}defaultRows=nearest}tableRowsCache[tableId]=defaultRows;try{localStorage.setItem(tableRowsStorageKey(tableId),String(defaultRows))}catch(_){}}}}})}(cfg)}catch(_){}return changed}function tableRowsConfigForTableId(tableId,classKey){var cfg=tableClassConfig(classKey),defaultRows=cfg&&"number"==typeof cfg.defaultRows?cfg.defaultRows:20,rowOptions=Array.isArray(cfg&&cfg.rowOptions)?cfg.rowOptions.slice():[defaultRows],ui=getTablesUiTableCfg(tableId,PAGE);if(ui&&ui.rows&&"object"==typeof ui.rows){var opts=Array.isArray(ui.rows.options)?ui.rows.options:null;if(opts&&opts.length){var seen={},normalized=[];opts.forEach(function(n){var x=Math.round(Number(n));!Number.isFinite(x)||x<=0||x>200||seen[x]||(seen[x]=!0,normalized.push(x))}),normalized.sort(function(a,b){return a-b}),normalized.length&&(rowOptions=normalized.slice(0,12))}var dr=ui.rows.default;"number"==typeof dr&&Number.isFinite(dr)&&(defaultRows=Math.round(dr))}if(rowOptions.length||(rowOptions=[defaultRows]),rowOptions.indexOf(defaultRows)<0){for(
// Pick nearest allowed option for robustness.
var nearest=rowOptions[0],nearestDiff=Math.abs(nearest-defaultRows),i=1;i<rowOptions.length;i++){var d=Math.abs(rowOptions[i]-defaultRows);d<nearestDiff&&(nearest=rowOptions[i],nearestDiff=d)}defaultRows=nearest}return{defaultRows:defaultRows,rowOptions:rowOptions}}function syncPageBodyLoaderOffset(scope){try{if(!scope||!scope.classList||!scope.classList.contains("page-body"))return;var rect=scope.getBoundingClientRect?scope.getBoundingClientRect():null,top=rect&&Number.isFinite(rect.top)?Math.max(0,Math.round(rect.top)):0;scope.style.setProperty("--kexo-loader-page-top",String(top)+"px")}catch(_){}}function normalizeTableClass(classKey){var key=String(null==classKey?"":classKey).trim().toLowerCase();return key&&TABLE_CLASS_CONFIG[key]?key:"live"}function tableClassConfig(classKey){return TABLE_CLASS_CONFIG[normalizeTableClass(classKey)]||TABLE_CLASS_CONFIG.live}function clampTableRows(value,tableId,classKey){var cfg=tableRowsConfigForTableId(tableId,classKey),opts=Array.isArray(cfg&&cfg.rowOptions)?cfg.rowOptions:[cfg.defaultRows],n=Number(value);if(!Number.isFinite(n))return cfg.defaultRows;if(n=Math.round(n),opts.indexOf(n)>=0)return n;
// Pick nearest allowed option for robustness against stale values.
for(var nearest=opts[0],nearestDiff=Math.abs(nearest-n),i=1;i<opts.length;i++){var d=Math.abs(opts[i]-n);d<nearestDiff&&(nearest=opts[i],nearestDiff=d)}return nearest}function findTableCardById(tableId){var id=String(null==tableId?"":tableId).trim();if(!id||!document||!document.querySelector)return null;var byCardAttr=document.querySelector('.card[data-table-id="'+id+'"]');if(byCardAttr)return byCardAttr;var tableEl=document.getElementById(id);return tableEl&&tableEl.closest?tableEl.closest(".card"):null}function applyTablesUiLayoutForPage(){try{if("settings"===String(PAGE||"").toLowerCase())return;var pageCfg=getTablesUiPageCfg(PAGE);if(!pageCfg||!Array.isArray(pageCfg.tables))return;
// Titles (opt-in via data attr to avoid clobbering dynamic headers).
pageCfg.tables.forEach(function(t){if(t&&"object"==typeof t){var tableId=null!=t.id?String(t.id).trim():"";if(tableId){var name=null!=t.name?String(t.name).trim():"";if(name){var card=findTableCardById(tableId);if(card&&card.querySelector){var titleEl=card.querySelector('[data-kexo-table-title="1"]');titleEl&&(titleEl.textContent=name)}}}}});
// Per group (row/stats-row): order + grid/full width
var groups=new Map;pageCfg.tables.forEach(function(t){if(t&&"object"==typeof t){var tableId=null!=t.id?String(t.id).trim():"";if(tableId){var card=findTableCardById(tableId);if(card&&card.closest){var group=card.closest(".stats-row, .row");if(group){var unit=card;try{group.classList&&group.classList.contains("row")&&card.parentElement&&function(el){if(!el||!el.classList)return!1;for(var i=0;i<el.classList.length;i++){var c=el.classList[i];if("col"===c||0===String(c).indexOf("col-"))return!0}return!1}(card.parentElement)&&card.parentElement.parentElement===group&&(unit=card.parentElement)}catch(_){}var inGrid=!(!1===t.inGrid);unit!==card?
// Bootstrap column wrapper
function(colEl,full){if(colEl){var orig=colEl.getAttribute("data-kexo-orig-col-class");if(!orig){try{colEl.setAttribute("data-kexo-orig-col-class",colEl.className||"")}catch(_){}orig=colEl.className||""}if(full){var keep=[];String(orig||"").split(/\s+/g).filter(Boolean).forEach(function(cls){"col"!==cls&&0!==String(cls).indexOf("col-")&&keep.push(cls)}),keep.push("col-12"),colEl.className=keep.join(" ")}else colEl.className=orig}}(unit,!inGrid):
// Flex/grid card
card.classList.toggle("kexo-layout-full",!inGrid);var list=groups.get(group)||[];list.push({order:Number(t.order)||0,unit:unit}),groups.set(group,list)}}}}}),groups.forEach(function(list,group){!group||!Array.isArray(list)||list.length<2||(list.sort(function(a,b){return(a.order||0)-(b.order||0)}),list.forEach(function(it){if(it&&it.unit&&it.unit.parentElement)try{group.appendChild(it.unit)}catch(_){}}))})}catch(_){}}function getTableClassByTableId(tableId,fallbackClassKey){var id=String(null==tableId?"":tableId).trim(),card=findTableCardById(id);return card&&card.dataset&&card.dataset.tableClass?normalizeTableClass(card.dataset.tableClass):id&&TABLE_CLASS_FALLBACK_BY_ID[id]?normalizeTableClass(TABLE_CLASS_FALLBACK_BY_ID[id]):normalizeTableClass(fallbackClassKey||"live")}function tableRowsStorageKey(tableId){var id=String(null==tableId?"":tableId).trim().toLowerCase();return"kexo:table-rows:v1:"+(resolveVariantsTableId(id,PAGE)||id)}function getTableRowsPerPage(tableId,fallbackClassKey){var id=String(null==tableId?"":tableId).trim();if(!id)return tableClassConfig(fallbackClassKey||"live").defaultRows;var resolved=resolveVariantsTableId(id,PAGE);if(Object.prototype.hasOwnProperty.call(tableRowsCache,id))return tableRowsCache[id];var classKey=getTableClassByTableId(id,fallbackClassKey),cfg=tableRowsConfigForTableId(resolved||id,classKey),raw=null;
// Dashboard tables: "Default rows" in UI config should always win.
// Ignore stale persisted overrides (common cause of Trending Up/Down stuck at 10).
if("dashboard"!==classKey)try{raw=localStorage.getItem(tableRowsStorageKey(id))}catch(_){raw=null}var value=clampTableRows(null==raw?cfg.defaultRows:Number(raw),resolved||id,classKey);return tableRowsCache[id]=value,value}pageBody=document.querySelector(".page-body"),overlay=document.getElementById("page-body-loader"),pageBody&&overlay&&(syncPageBodyLoaderOffset(pageBody),pageBody.classList.remove("report-building"),overlay.classList.add("is-hidden")),function(){try{if(!tablesUiConfigV1)return;"loading"===document.readyState?document.addEventListener("DOMContentLoaded",function(){try{scheduleTablesUiApply()}catch(_){}}):scheduleTablesUiApply()}catch(_){}}();
// Desktop date picker is mounted into the page header right slot.
// Page progress bar (Tabler Turbo-style): refcount + width animation
var _progressEl=null,_progressBarEl=null,_progressActive=0,_progressHideTimer=null;function _syncStripWidth(){try{var w=document.documentElement&&document.documentElement.clientWidth;"number"==typeof w&&w>=0&&document.documentElement.style.setProperty("--kexo-strip-viewport-width",w+"px")}catch(_){}}function _ensureProgress(){_progressEl||(_syncStripWidth(),(_progressEl=document.createElement("div")).className="page-progress",_progressEl.innerHTML='<div class="page-progress-bar"></div>',document.body.prepend(_progressEl),_progressBarEl=_progressEl.querySelector(".page-progress-bar"))}function showPageProgress(){_ensureProgress(),_progressActive+=1;try{document.body.classList.add("kexo-page-progress-active")}catch(_){}_progressEl.classList.add("active"),_progressBarEl&&(_progressBarEl.style.width="",_progressBarEl.offsetHeight,_progressBarEl.style.width="70%"),_progressHideTimer&&(clearTimeout(_progressHideTimer),_progressHideTimer=null)}function hidePageProgress(){if((_progressActive=Math.max(0,_progressActive-1))>0||!_progressEl||!_progressBarEl){if(0===_progressActive)try{document.body.classList.remove("kexo-page-progress-active")}catch(_){}}else _progressBarEl.style.width="100%",_progressHideTimer=setTimeout(function(){_progressHideTimer=null,_progressEl.classList.remove("active"),_progressBarEl.style.width="0%";try{document.body.classList.remove("kexo-page-progress-active")}catch(_){}},200)}try{"undefined"!=typeof window&&(window.__kexoShowPageProgress=showPageProgress,window.__kexoHidePageProgress=hidePageProgress)}catch(_){}!function(){_syncStripWidth(),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",function(){_ensureProgress(),_syncStripWidth()}):_ensureProgress();try{var _kexoTablesProgressOnResize=kexoDebounce(function(){_syncStripWidth()},120);window.addEventListener("resize",_kexoTablesProgressOnResize,{passive:!0});try{kexoRegisterCleanup(function(){try{window.removeEventListener("resize",_kexoTablesProgressOnResize)}catch(_){}try{_kexoTablesProgressOnResize&&_kexoTablesProgressOnResize.cancel&&_kexoTablesProgressOnResize.cancel()}catch(_){}})}catch(_){}}catch(_){}}();let kpisSpinnerShownOnce=!1,updateAvailable=!1;let rowsPerPage=getTableRowsPerPage("sessions-table","live"),sessions=[],sessionsLoadError=null,statsCache={},attributionCache=null,devicesCache=null,browsersCache=null,attributionExpandedChannels=null,attributionExpandedSources=null,devicesExpanded=null,dateRange="sales"===PAGE?"sales":"date"===PAGE||"dashboard"===PAGE||"abandoned-carts"===PAGE||"checkout-funnel"===PAGE?"today":"live",customRangeStartYmd=null,customRangeEndYmd=null,pendingCustomRangeStartYmd=null,pendingCustomRangeEndYmd=null,customCalendarLastPayload=null;let abandonedMode="cart";// cart | checkout
/** When dateRange is 'live' or 'sales', stats/KPIs use today's data; only the main table shows those special views. */function normalizeRangeKeyForApi(key){const k=(null==key?"":String(key)).trim().toLowerCase();
// UI uses friendly labels (7days/14days/30days) but APIs + server payload keys use 7d/14d/30d.
return"7days"===k?"7d":"14days"===k?"14d":"30days"===k?"30d":k}function normalizeAbandonedMode(value){var s=null!=value?String(value).trim().toLowerCase():"";return"checkout"===s||"checkouts"===s?"checkout":"cart"}function abandonedModeDisplayLabel(mode){return"checkout"===normalizeAbandonedMode(mode)?"Abandoned Checkouts":"Abandoned Carts"}function syncAbandonedModeUi(){if("abandoned-carts"===PAGE){var titleTextEl=document.getElementById("abandoned-page-title-text");titleTextEl&&(titleTextEl.textContent=abandonedModeDisplayLabel(abandonedMode));var switchEl=document.getElementById("abandoned-mode-switch");if(switchEl){var next="checkout"===normalizeAbandonedMode(abandonedMode)?"cart":"checkout";switchEl.textContent="Switch to "+abandonedModeDisplayLabel(next),switchEl.setAttribute("data-abandoned-mode",next),switchEl.setAttribute("aria-label","Switch to "+abandonedModeDisplayLabel(next))}var tableTitle=document.getElementById("table-title-text");tableTitle&&(tableTitle.textContent=abandonedModeDisplayLabel(abandonedMode))}}function setAbandonedMode(nextMode,opts){var next=normalizeAbandonedMode(nextMode);if(next!==abandonedMode){if(abandonedMode=next,function(mode){try{localStorage.setItem("kexo:abandoned-mode:v1",normalizeAbandonedMode(mode))}catch(_){}}(next),syncAbandonedModeUi(),"abandoned-carts"===PAGE){abandonedCartsChartKey="",abandonedCartsTopCacheKey="";try{refreshAbandonedCarts({force:!1})}catch(_){try{fetchSessions()}catch(_){}}}}else syncAbandonedModeUi()}
// Abandoned Carts page: init mode dropdown state + bindings.
if("abandoned-carts"===PAGE){try{abandonedMode=function(){var raw="";try{raw=localStorage.getItem("kexo:abandoned-mode:v1")||""}catch(_){raw=""}return normalizeAbandonedMode(raw)}()}catch(_){abandonedMode="cart"}syncAbandonedModeUi();try{var switchEl=document.getElementById("abandoned-mode-switch");switchEl&&"1"!==switchEl.getAttribute("data-kexo-bound")&&(switchEl.setAttribute("data-kexo-bound","1"),switchEl.addEventListener("keydown",function(e){if(e&&("Enter"===e.key||" "===e.key)){e.preventDefault();try{switchEl.click()}catch(_){}}}))}catch(_){}try{document.addEventListener("click",function(e){var t=e&&e.target?e.target:null,btn=t&&t.closest?t.closest("[data-abandoned-mode]"):null;btn&&(e.preventDefault(),setAbandonedMode(btn.getAttribute("data-abandoned-mode")||"cart"))})}catch(_){}}function getStatsRange(){return normalizeRangeKeyForApi("live"===dateRange||"sales"===dateRange||"1h"===dateRange?"today":dateRange)}function getKpiData(){const statsRange=getStatsRange();return kpiCache&&kpiCacheRange===statsRange?kpiCache:"today"===statsRange?{}:statsCache||{}}
// Shopify embedded app: keep the signed query params on internal navigation.
// Without this, moving from `/?shop=...&hmac=...` to `/dashboard/overview` drops the signature and API calls can 401.
!function(){try{const cur=new URL(window.location.href),sp=cur.searchParams,shop=sp.get("shop"),hmac=sp.get("hmac"),ts=sp.get("timestamp");if(!shop||!hmac||!ts)return;if(!/\.myshopify\.com$/i.test(shop))return;const signedEntries=[];sp.forEach(function(v,k){signedEntries.push([k,v])});const signedKeys=new Set(signedEntries.map(function(e){return e[0]})),isAssetPath=function(p){return!!p&&(!!p.startsWith("/assets/")||/\.(css|js|png|webp|jpg|jpeg|gif|svg|ico|map|txt)$/i.test(p))};document.querySelectorAll("a[href]").forEach(function(a){const rawHref=a.getAttribute("href");if(!rawHref)return;const h=rawHref.trim();if(!h||"#"===h[0])return;if(/^(javascript:|mailto:|tel:)/i.test(h))return;let u;try{u=new URL(h,cur.origin)}catch(_){return}if(u.origin!==cur.origin)return;if((u.pathname||"").startsWith("/api/"))return;if(isAssetPath(u.pathname||""))return;
// Don't add signed params to links that already have extra params:
// adding any new key would invalidate the existing hmac.
let hasNonSigned=!1;u.searchParams.forEach(function(_v,k){signedKeys.has(k)||(hasNonSigned=!0)}),hasNonSigned||(signedEntries.forEach(function(pair){u.searchParams.set(pair[0],pair[1])}),a.setAttribute("href",u.pathname+"?"+u.searchParams.toString()+(u.hash||"")))})}catch(_){}}(),
// Sync data-label from header to body cells for mobile card layout
function(){function syncLabels(tableEl){
// Throttle resize-driven table refresh to reduce layout churn.
if(tableEl&&tableEl.querySelector){var headerRow=tableEl.querySelector(".grid-row--header"),headerCells=headerRow?headerRow.querySelectorAll(".grid-cell"):[],labels=Array.from(headerCells).map(function(c){var a=c.getAttribute("aria-label");if(a)return a.trim();var long=c.querySelector(".th-label-long");return long&&long.textContent?long.textContent.trim():(c.textContent||"").trim()});0!==labels.length&&tableEl.querySelectorAll(".grid-body .grid-row").forEach(function(row){row.querySelectorAll(".grid-cell:not(.span-all)").forEach(function(cell,i){labels[i]&&cell.setAttribute("data-label",labels[i])})})}}function run(){document.querySelectorAll(".grid-table .grid-body").forEach(function(body){body._gridLabelsObserved||(body._gridLabelsObserved=!0,syncLabels(body.closest(".grid-table")),new MutationObserver(function(){syncLabels(body.closest(".grid-table"))}).observe(body,{childList:!0,subtree:!0}))})}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",run):run(),setTimeout(run,800),setTimeout(run,2e3)}(),function(){var WRAP_SELECTOR=".table-scroll-wrap, .country-table-wrap, .table-responsive, .tools-table-wrap";function setDragEnabledClass(wrap){if(wrap){var canDrag=(wrap.scrollWidth||0)>(wrap.clientWidth||0)+1;wrap.classList.toggle("is-drag-scroll",!!canDrag)}}function shouldSkipStickyScrollClass(wrap){return!wrap||!wrap.querySelector||!!wrap.querySelector("#latest-sales-table")}function updateStickyScrollClass(wrap){if(wrap&&!shouldSkipStickyScrollClass(wrap)){var scrolled=(wrap.scrollLeft||0)>0;wrap.classList.toggle("kexo-sticky-scrolled",scrolled)}}function run(){document.querySelectorAll(WRAP_SELECTOR).forEach(function(wrap){!function(wrap){if(wrap&&"1"!==wrap.getAttribute("data-drag-scroll-bound")){wrap.setAttribute("data-drag-scroll-bound","1"),setDragEnabledClass(wrap),shouldSkipStickyScrollClass(wrap)||(updateStickyScrollClass(wrap),wrap.addEventListener("scroll",function(){updateStickyScrollClass(wrap)},{passive:!0}));var startX=0,startScrollLeft=0,dragging=!1,moved=!1;if(wrap.addEventListener("pointerdown",function(e){if(e&&("mouse"!==String(e.pointerType||"").toLowerCase()||0===e.button)){var scrollbarHidden="none"===(getComputedStyle(wrap).getPropertyValue("scrollbar-width")||"").trim();if(("touch"!==(e.pointerType||"")||scrollbarHidden)&&wrap.classList.contains("is-drag-scroll")&&!((target=e.target)&&target.closest&&target.closest('a, button, input, select, textarea, label, [role="button"], [data-no-drag-scroll]'))){var target;dragging=!0,moved=!1,startX=e.clientX,startScrollLeft=wrap.scrollLeft,wrap.classList.add("is-dragging");try{wrap.setPointerCapture(e.pointerId)}catch(_){}}// native swipe when scrollbar visible; when hidden (mobile/emulation), run our drag
}}),wrap.addEventListener("pointermove",function(e){if(dragging){var dx=e.clientX-startX;!moved&&Math.abs(dx)>3&&(moved=!0),wrap.scrollLeft=startScrollLeft-dx,moved&&e.preventDefault()}}),wrap.addEventListener("pointerup",endDrag),wrap.addEventListener("pointercancel",endDrag),wrap.addEventListener("pointerleave",function(e){dragging&&(e&&1===e.buttons||endDrag(e))}),"undefined"!=typeof ResizeObserver)try{var ro=new ResizeObserver(function(){setDragEnabledClass(wrap),shouldSkipStickyScrollClass(wrap)||updateStickyScrollClass(wrap)});ro.observe(wrap),wrap._dragScrollObserver=ro}catch(_){}}function endDrag(e){if(dragging){dragging=!1,wrap.classList.remove("is-dragging");try{e&&null!=e.pointerId&&wrap.releasePointerCapture(e.pointerId)}catch(_){}}}}(wrap)})}function refreshAll(){document.querySelectorAll(WRAP_SELECTOR).forEach(function(wrap){"1"===wrap.getAttribute("data-drag-scroll-bound")&&(setDragEnabledClass(wrap),shouldSkipStickyScrollClass(wrap)||updateStickyScrollClass(wrap))})}try{var onResize=kexoDebounce(function(){refreshAll()},120);window.addEventListener("resize",onResize,{passive:!0});try{kexoRegisterCleanup(function(){try{window.removeEventListener("resize",onResize)}catch(_){}try{onResize&&onResize.cancel&&onResize.cancel()}catch(_){}})}catch(_){}}catch(_){}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",run):run(),setTimeout(run,700),setTimeout(run,1800)}(),function(){var TABLE_CONTENT_SELECTOR=".table-scroll-wrap, .country-table-wrap, .table-responsive, .grid-table, table",CHART_CONTENT_SELECTOR='.dash-chart-wrap, [id^="dash-chart-"], #live-online-chart, #sessions-overview-chart, #ads-overview-chart, #attribution-chart, #devices-chart, #products-chart, #countries-map-chart';function getPageScope(){var page="";try{page=document.body&&document.body.getAttribute("data-page")||""}catch(_){page=""}if(page)return String(page).trim().toLowerCase();var path="";try{path=window.location&&window.location.pathname?String(window.location.pathname):""}catch(_){path=""}return(path=path.replace(/^\/+/,"").trim().toLowerCase())||"dashboard"}function isChartOnlyCard(card){return!!card&&((!card.dataset||!card.dataset.tableId)&&(
// Product Insights modal Revenue/Demand cards keep collapse chevrons (not gear)
(!card.dataset||!card.dataset.collapseId||0!==String(card.dataset.collapseId).indexOf("product-insights-"))&&(!!(card.closest?card.closest("[data-kexo-chart-key]"):null)||function(card){return!(!card||!card.querySelector||!card.querySelector(CHART_CONTENT_SELECTOR))}(card)&&!card.querySelector(TABLE_CONTENT_SELECTOR))))}function getCollapseId(card,index){if(!card||!card.dataset)return"table-card-"+String(index||0);if(card.dataset.collapseId)return card.dataset.collapseId;var value,id="";if(card.id&&(id=String(card.id).trim()),!id){var titleEl=card.querySelector(".card-header .card-title")||card.querySelector(".kexo-widget-title"),title=titleEl?String(titleEl.textContent||"").trim():"";title&&(value=title,id=(String(null==value?"":value).trim().toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,"")||"table-card")+"-"+String(index||0))}return id||(id="table-card-"+String(index||0)),card.dataset.collapseId=id,id}function setCollapseChevron(button,collapsed){if(button&&button.querySelector){var icon=button.querySelector(".kexo-card-collapse-chevron");if(icon){var isCollapsed=!!collapsed,glyph=isCollapsed?"fa-chevron-right":"fa-chevron-down",key=isCollapsed?"card-collapse-collapsed":"card-collapse-expanded";icon.setAttribute("data-icon-key",key),icon.className="kexo-card-collapse-chevron fa-light "+glyph,function(){try{window.dispatchEvent(new CustomEvent("kexo:icon-theme-changed")),window.KexoIconTheme&&"function"==typeof window.KexoIconTheme.refresh&&window.KexoIconTheme.refresh()}catch(_){}}()}}}function setCollapsed(card,button,collapsed,persist,storageKey){if(card){var isCollapsed=!!collapsed;if(card.classList.toggle("kexo-card-collapsed",isCollapsed),button&&(button.classList.toggle("is-collapsed",isCollapsed),button.setAttribute("aria-expanded",isCollapsed?"false":"true"),button.setAttribute("aria-label",isCollapsed?"Expand section":"Collapse section"),button.title=isCollapsed?"Expand section":"Collapse section",setCollapseChevron(button,isCollapsed)),persist&&storageKey)try{sessionStorage.setItem(storageKey,isCollapsed?"1":"0")}catch(_){}}}function ensureToggle(card,index){if(card&&"1"!==card.getAttribute("data-no-card-collapse")&&function(card){return!(!card||!card.querySelector||!card.querySelector(TABLE_CONTENT_SELECTOR)&&!card.querySelector(CHART_CONTENT_SELECTOR))}(card)){var header=function(card){if(!card||!card.querySelector)return null;var header=null;try{header=card.querySelector(":scope > .card-header")}catch(_){header=null}return header||((header=card.querySelector(".card-header"))?header:(header=card.querySelector(":scope .kexo-widget-head"))||null)}(card);if(header)if(card.dataset&&card.dataset.tableId){if(header.querySelector(".kexo-builder-icon-link"))return;var tableId=String(card.dataset.tableId||"").trim(),pageKey=getPageScope(),titleEl=card.querySelector(".card-header .card-title")||card.querySelector(".kexo-widget-title"),cardTitle=titleEl&&titleEl.textContent?String(titleEl.textContent).trim():tableId,link=document.createElement("button");link.type="button",link.className="kexo-builder-icon-link",link.title="Table settings",link.setAttribute("aria-label","Table settings"),link.innerHTML='<i class="fa-light fa-gear" data-icon-key="table-builder-icon" aria-hidden="true"></i>',link.addEventListener("click",function(e){e.preventDefault(),e.stopPropagation(),"ads-root"!==tableId?void 0!==window.KexoLayoutShortcuts&&"function"==typeof window.KexoLayoutShortcuts.openTableModal&&window.KexoLayoutShortcuts.openTableModal({pageKey:pageKey,tableId:tableId,cardTitle:cardTitle}):window.location.href="/settings/integrations/googleads"});var headRight=header.querySelector(":scope > .kexo-widget-head-right");headRight?headRight.appendChild(link):((actions=header.querySelector(":scope > .card-actions"))||((actions=document.createElement("div")).className="card-actions d-flex align-items-center gap-2 ms-auto",header.appendChild(actions)),actions.appendChild(link))}else if(isChartOnlyCard(card)){var existingChartLink=header.querySelector(".kexo-builder-icon-link"),existingCollapse=header.querySelector(".kexo-card-collapse-toggle");if(existingCollapse&&existingCollapse.remove(),existingChartLink)return;var chartWrap=card.closest?card.closest("[data-kexo-chart-key]"):null,chartKey=card.dataset&&card.dataset.kexoChartKey?String(card.dataset.kexoChartKey).trim().toLowerCase():chartWrap&&chartWrap.getAttribute("data-kexo-chart-key")?String(chartWrap.getAttribute("data-kexo-chart-key")).trim().toLowerCase():"";if(!chartKey)return;var chartTitleEl=card.querySelector(".card-header .card-title")||card.querySelector(".kexo-widget-title"),chartCardTitle=chartTitleEl&&chartTitleEl.textContent?String(chartTitleEl.textContent).trim():chartKey,chartLink=document.createElement("button");chartLink.type="button",chartLink.className="kexo-builder-icon-link",chartLink.title="Chart settings",chartLink.setAttribute("aria-label","Chart settings"),chartLink.setAttribute("data-kexo-chart-settings-key",chartKey),chartLink.innerHTML='<i class="fa-light fa-gear" data-icon-key="chart-builder-icon" aria-hidden="true"></i>',chartLink.addEventListener("click",function(e){e.preventDefault(),e.stopPropagation(),
// Back-compat: if delegation doesn't run for any reason, open via unified builder directly.
window.KexoChartSettingsBuilder&&"function"==typeof window.KexoChartSettingsBuilder.openModal?window.KexoChartSettingsBuilder.openModal({chartKey:chartKey,cardTitle:chartCardTitle}):void 0!==window.KexoLayoutShortcuts&&"function"==typeof window.KexoLayoutShortcuts.openChartModal&&window.KexoLayoutShortcuts.openChartModal({chartKey:chartKey,cardTitle:chartCardTitle})});var chartHeadRight=header.querySelector(":scope > .kexo-widget-head-right");if(chartHeadRight)chartHeadRight.appendChild(chartLink);else{var chartActions=header.querySelector(":scope > .card-actions");chartActions||((chartActions=document.createElement("div")).className="card-actions d-flex align-items-center gap-2 ms-auto",header.appendChild(chartActions)),chartActions.appendChild(chartLink)}}else{var storageKey=function(card,index){return"kexo:table-collapse:v1:"+getPageScope()+":"+getCollapseId(card,index)}(card,index),btn=header.querySelector(".kexo-card-collapse-toggle");if(!btn){(btn=document.createElement("button")).type="button",btn.className="btn btn-icon btn-ghost-secondary kexo-card-collapse-toggle",btn.innerHTML='<i class="kexo-card-collapse-chevron fa-light fa-chevron-down" data-icon-key="card-collapse-expanded" aria-hidden="true"></i>';var actions=null;try{actions=header.querySelector(":scope > .card-actions")}catch(_){actions=null}actions&&actions.parentElement===header||btn.classList.add("ms-auto"),header.appendChild(btn)}"1"!==btn.getAttribute("data-collapse-bound")&&(btn.setAttribute("data-collapse-bound","1"),btn.addEventListener("click",function(e){e.preventDefault();var next=!card.classList.contains("kexo-card-collapsed");setCollapsed(card,btn,next,!0,storageKey)})),function(card,button,storageKey){var raw=null;try{raw=sessionStorage.getItem(storageKey)}catch(_){raw=null}if(null!=raw)setCollapsed(card,button,"1"===raw,!1,storageKey);else{
// Keep any default collapsed state already present in the DOM (useful for
// dynamically-inserted cards like modals).
var already=!!(card&&card.classList&&card.classList.contains("kexo-card-collapsed"));setCollapsed(card,button,already,!1,storageKey)}}(card,btn,storageKey)}}}function run(root){(root&&root.querySelectorAll?root:document).querySelectorAll(".card").forEach(function(card,idx){ensureToggle(card,idx)})}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",function(){run(document)}):run(document);var gridDocObserver=null;function initGridDocObserver(){if(!gridDocObserver)try{var schedule=kexoDebounce(function(){run(document)},120);gridDocObserver=new MutationObserver(function(muts){try{schedule()}catch(_){}});var root=document.querySelector(".page-body")||document.body||document.documentElement;gridDocObserver.observe(root,{childList:!0,subtree:!0}),registerCleanup(function(){try{gridDocObserver&&"function"==typeof gridDocObserver.disconnect&&gridDocObserver.disconnect()}catch(_){}gridDocObserver=null;try{schedule&&schedule.cancel&&schedule.cancel()}catch(_){}})}catch(_){}}try{window.__kexoInitGridDocObserver=initGridDocObserver}catch(_){}initGridDocObserver();try{window.addEventListener("hashchange",function(){setTimeout(function(){run(document)},0)})}catch(_){}setTimeout(function(){run(document)},800),setTimeout(function(){run(document)},1800)}(),function(){function ensureRowsControl(card){if(card){var tableId=card.dataset&&card.dataset.tableId?String(card.dataset.tableId).trim():function(card){if(!card||!card.querySelector)return"";if(card.dataset&&card.dataset.tableId)return String(card.dataset.tableId).trim();var el=card.querySelector('table[id], .grid-table[id], [id="ads-root"]');return el&&el.id?String(el.id).trim():""}(card);if(tableId){var classKey=normalizeTableClass(card.dataset&&card.dataset.tableClass?card.dataset.tableClass:"live"),cfg=tableRowsConfigForTableId(tableId,classKey),selectedRows=getTableRowsPerPage(tableId,classKey),header=function(card){if(!card||!card.querySelector)return null;try{return card.querySelector(":scope > .card-header")}catch(_){}return card.querySelector(".card-header")}(card);if(header){var actions=function(header){if(!header||!header.querySelector)return null;var actions=null;try{actions=header.querySelector(":scope > .card-actions")}catch(_){actions=null}return actions&&actions.parentElement===header||((actions=document.createElement("div")).className="card-actions d-flex align-items-center gap-2 ms-auto kexo-table-actions",header.appendChild(actions)),actions}(header);if(actions){var collapseBtn=header.querySelector(".kexo-card-collapse-toggle"),builderLink=header.querySelector(".kexo-builder-icon-link");collapseBtn&&collapseBtn.parentElement!==actions&&(collapseBtn.classList.remove("ms-auto"),actions.appendChild(collapseBtn)),builderLink&&builderLink.parentElement!==actions&&(builderLink.classList.remove("ms-auto"),actions.appendChild(builderLink));
// Acquisition → Attribution: quick link to Settings → Attribution → Mapping.
try{if("attribution"===(document.body&&document.body.getAttribute?String(document.body.getAttribute("data-page")||""):"").trim().toLowerCase()&&"attribution-table"===String(tableId||"").trim().toLowerCase())if(!actions.querySelector(".kexo-attribution-settings-link")){var a=document.createElement("a");a.className="kexo-attribution-settings-link",a.href="/settings/attribution/mapping",a.title="Attribution settings",a.setAttribute("aria-label","Attribution settings"),a.innerHTML='<i class="fa-light fa-sliders" aria-hidden="true"></i>',
// Place next to the table settings cog when present.
builderLink&&builderLink.parentElement===actions?actions.insertBefore(a,builderLink.nextSibling):actions.appendChild(a)}}catch(_){}var control=actions.querySelector('.kexo-table-rows-control[data-table-id="'+tableId+'"]');if(!control){(control=document.createElement("label")).className="kexo-table-rows-control",control.setAttribute("data-table-id",tableId),control.innerHTML='<select class="form-select form-select-sm kexo-table-rows-select" aria-label="Rows per table"></select>';var insertBefore=collapseBtn&&collapseBtn.parentElement===actions?collapseBtn:builderLink&&builderLink.parentElement===actions?builderLink:null;insertBefore?actions.insertBefore(control,insertBefore):actions.appendChild(control)}var selectEl=control.querySelector(".kexo-table-rows-select");if(selectEl){var options=Array.isArray(cfg&&cfg.rowOptions)?cfg.rowOptions:[cfg.defaultRows];selectEl.innerHTML=options.map(function(opt){return'<option value="'+String(opt)+'">'+String(opt)+"</option>"}).join(""),selectEl.value=String(clampTableRows(selectedRows,tableId,classKey)),"1"!==selectEl.getAttribute("data-rows-bound")&&(selectEl.setAttribute("data-rows-bound","1"),selectEl.addEventListener("change",function(){var next=function(tableId,rows,fallbackClassKey){var id=String(null==tableId?"":tableId).trim();if(!id)return null;var resolved=resolveVariantsTableId(id,PAGE),classKey=getTableClassByTableId(id,fallbackClassKey),next=clampTableRows(rows,resolved||id,classKey);tableRowsCache[id]=next;try{localStorage.setItem(tableRowsStorageKey(id),String(next))}catch(_){}try{window.dispatchEvent(new CustomEvent("kexo:table-rows-changed",{detail:{tableId:id,rows:next,tableClass:classKey}}))}catch(_){}try{"function"==typeof window.__kexoOnTableRowsPerPageChanged&&window.__kexoOnTableRowsPerPageChanged(id,next,classKey)}catch(_){}return next}(tableId,Number(selectEl.value),classKey);!function(tableId,rows){var id=String(null==tableId?"":tableId).trim(),n=Number(rows);if(!id||!Number.isFinite(n))return;if("sessions-table"===id)return rowsPerPage=n,currentPage=1,void(null!=sessionsTotal?fetchSessions():renderTable());if("best-sellers-table"===id)return bestSellersPage=1,void fetchBestSellers({force:!0});if("best-variants-table"===id)return bestVariantsPage=1,void fetchBestVariants({force:!0});if("country-table"===id)return countryPage=1,void renderCountry(statsCache||{});if("best-geo-products-table"===id)return bestGeoProductsPage=1,void renderBestGeoProducts(statsCache||{});if("attribution-table"===id){attributionPage=1;try{renderAttributionTables(attributionCache||{})}catch(_){}return}if("devices-table"===id){devicesPage=1;try{renderDevicesTables(devicesCache||{})}catch(_){}return}if("browsers-table"===id){browsersPage=1;try{renderBrowsersTables(browsersCache||{})}catch(_){}return}if("dash-top-products"===id)return dashTopProductsPage=1,void rerenderDashboardFromCache();if("dash-top-countries"===id)return dashTopCountriesPage=1,void rerenderDashboardFromCache();if("dash-trending"===id)return dashTrendingPage=1,void rerenderDashboardFromCache();var typeMatch=id.match(/^type-([a-z0-9-]+)-table$/i);if(typeMatch&&typeMatch[1]){var typeId=String(typeMatch[1]).toLowerCase();typeTablePages[typeId]=1;var def=TYPE_TABLE_DEFS.find(function(d){return d&&d.id===typeId});return void(def&&renderTypeTable(leaderboardCache,def))}try{"function"==typeof window.__adsRowsPerPageChanged&&window.__adsRowsPerPageChanged(id,n)}catch(_){}}(tableId,next)}))}}}}}}function run(root){(root&&root.querySelectorAll?root:document).querySelectorAll(".card[data-table-class][data-table-id]").forEach(function(card){ensureRowsControl(card)})}
// Reduce MutationObserver work: debounce and scope to page body.
"loading"===document.readyState?document.addEventListener("DOMContentLoaded",function(){run(document)}):run(document);var schedule=kexoDebounce(function(){run(document)},120),observer=new MutationObserver(function(muts){try{schedule()}catch(_){}}),root=document.querySelector(".page-body")||document.body||document.documentElement;observer.observe(root,{childList:!0,subtree:!0});try{registerCleanup(function(){try{observer.disconnect()}catch(_){}try{schedule&&schedule.cancel&&schedule.cancel()}catch(_){}})}catch(_){}window.addEventListener("kexo:table-rows-changed",function(){run(document)}),window.addEventListener("kexo:tablesUiConfigApplied",function(){run(document)}),window.addEventListener("kexo:variant-cards-rendered",function(){run(document)}),window.addEventListener("kexo:icon-theme-changed",function(){run(document),setTimeout(function(){run(document)},80)}),setTimeout(function(){run(document)},900),setTimeout(function(){run(document)},2e3)}(),function(){var page="";try{page=document.body&&document.body.getAttribute("data-page")||""}catch(_){page=""}if("settings"!==String(page||"").toLowerCase()){var WRAP_SELECTOR=".table-scroll-wrap, .country-table-wrap, .table-responsive, .tools-table-wrap";try{window.__kexoRunStickyColumnResize=run}catch(_){}try{window.addEventListener("kexo:tablesUiConfigApplied",function(){run()})}catch(_){}var docMo=null;try{window.__kexoInitStickyDocObserver=initStickyDocObserver}catch(_){}initStickyDocObserver(),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",run):run(),setTimeout(run,700),setTimeout(run,1800)}function getViewportBucket(){try{return window.matchMedia&&window.matchMedia("(max-width: 991.98px)").matches?"mobile":"desktop"}catch(_){return"desktop"}}function getWrapTableId(wrap){if(!wrap)return"";try{var table=wrap.querySelector?wrap.querySelector("table[id], .grid-table[id]"):null;if(table&&table.id)return String(table.id).trim()}catch(_){}
// Prefer the owning card's declared table id so related wraps (e.g. Ads footer)
// share the same sticky width key.
try{var card=wrap.closest?wrap.closest(".card[data-table-id]"):null;if(card&&card.dataset&&card.dataset.tableId)return String(card.dataset.tableId).trim()}catch(_){}try{if(wrap.id)return String(wrap.id).trim()}catch(_){}return""}function getBounds(wrap){var classKey=function(wrap){try{var card=wrap&&wrap.closest?wrap.closest(".card"):null;if(card&&card.dataset&&card.dataset.tableClass)return normalizeTableClass(card.dataset.tableClass)}catch(_){}return getTableClassByTableId(getWrapTableId(wrap),"live")}(wrap),gridCount=function(wrap){if(!wrap||!wrap.closest||!wrap.querySelectorAll)return 1;var card=wrap.closest(".card");if(!card)return 1;var group=card.closest(".stats-row, .row");if(!group||!group.querySelectorAll)return 1;var cards=group.querySelectorAll(".card[data-table-id]"),count=0;return cards.forEach(function(c){c&&c.closest&&c.closest(".stats-row, .row")===group&&count++}),count>0?count:1}(wrap),min="dashboard"===classKey?90:72,max="dashboard"===classKey?180:"product"===classKey?240:280,def=120;
// Live-class tables (20/30/40/50 rows) can expand wider for sticky labels.
"live"===classKey&&(max=Math.max(max,400)),
// Site-wide sticky sizing rules by table-grid cardinality.
"live"!==classKey&&1===gridCount&&(max=Math.min(max,250)),
// On mobile the cards stack; allow sticky labels to expand more naturally.
"live"!==classKey&&2===gridCount&&"mobile"!==getViewportBucket()&&(max=Math.min(max,150)),gridCount>=3&&(min=Math.max(min,100));
// Optional per-table overrides from Settings ??? Layout ??? Tables.
try{var ui=getTablesUiTableCfg(getWrapTableId(wrap),page);ui&&ui.sticky&&"object"==typeof ui.sticky&&("number"==typeof ui.sticky.minWidth&&Number.isFinite(ui.sticky.minWidth)&&(min=ui.sticky.minWidth),"number"==typeof ui.sticky.maxWidth&&Number.isFinite(ui.sticky.maxWidth)&&(max=ui.sticky.maxWidth))}catch(_){}var wrapW=wrap&&wrap.clientWidth?Number(wrap.clientWidth):0,colCount=0;try{var headerRow=wrap&&wrap.querySelector?wrap.querySelector(".grid-row--header"):null;if(headerRow&&headerRow.querySelectorAll)colCount=headerRow.querySelectorAll(".grid-cell").length;else{var tableHeadRow=wrap&&wrap.querySelector?wrap.querySelector("table thead tr"):null;tableHeadRow&&tableHeadRow.children&&(colCount=tableHeadRow.children.length||0)}}catch(_){colCount=0}if(Number.isFinite(wrapW)&&wrapW>0){var fitRatio="mobile"===getViewportBucket()?.8:.65,softMax=Math.max(min+16,Math.round(wrapW*fitRatio));if(max=Math.min(max,softMax),colCount>1){var byRemainingCols=wrapW-("live"===classKey?72:64)*(colCount-1);!((wrap.scrollWidth||0)>(wrap.clientWidth||0)+1)&&byRemainingCols>=min+16&&(max=Math.min(max,byRemainingCols))}}return{min:min=Math.max(72,Math.min(min,404)),max:max=Math.max(min+16,Math.min(max,420)),def:def=Math.max(min,Math.min(max,def))}}function clampWidth(wrap,n){var bounds=getBounds(wrap),x=Number(n);return Number.isFinite(x)?Math.max(bounds.min,Math.min(bounds.max,Math.round(x))):bounds.def}function getHeaderStickyCell(wrap){return wrap&&wrap.querySelector?wrap.querySelector(".grid-row--header .grid-cell:first-child, table thead th:first-child"):null}function getStorageKey(wrap){var suffix="default";try{var tableId=getWrapTableId(wrap);tableId?suffix=resolveVariantsTableId(tableId,page||PAGE)||tableId:page&&(suffix=String(page).trim().toLowerCase())}catch(_){}return"kexo-sticky-col-width:"+suffix+":"+getViewportBucket()+":"+function(wrap){if(!wrap||!document.querySelectorAll)return 0;var list=[];try{list=Array.prototype.slice.call(document.querySelectorAll(WRAP_SELECTOR))}catch(_){}var i=list.indexOf(wrap);return i>=0?i:0}(wrap)}function wrapWidth(wrap){var style=null;try{style=getComputedStyle(wrap)}catch(_){style=null}var raw=style?style.getPropertyValue("--kexo-sticky-col-width"):"",n=parseFloat(String(raw||"").trim());if(!Number.isFinite(n)){var cell=getHeaderStickyCell(wrap);if(cell)try{n=parseFloat(getComputedStyle(cell).width)}catch(_){n=NaN}}return clampWidth(wrap,Number.isFinite(n)?n:getBounds(wrap).def)}function applyWidthSingle(wrap,width){if(wrap&&wrap.style){var bounds=getBounds(wrap),next=clampWidth(wrap,width);wrap.style.setProperty("--kexo-sticky-col-min-width",bounds.min+"px"),wrap.style.setProperty("--kexo-sticky-col-max-width",bounds.max+"px"),wrap.style.setProperty("--kexo-sticky-col-width",next+"px")}}function markResizeInteraction(wrap){var ts=Date.now();try{wrap&&wrap.setAttribute("data-sticky-resize-at",String(ts))}catch(_){}try{window.__kexoLastStickyResizeAt=ts}catch(_){}}function bindHandle(wrap,handle){if(wrap&&handle&&"1"!==handle.getAttribute("data-sticky-resize-bound")){handle.setAttribute("data-sticky-resize-bound","1");var startX=0,startW=getBounds(wrap).def,resizing=!1,didDrag=!1;handle.addEventListener("pointerdown",function(e){if(e&&("mouse"!==String(e.pointerType||"").toLowerCase()||0===e.button)){e.preventDefault(),e.stopPropagation(),resizing=!0,didDrag=!1,startX=e.clientX,startW=wrapWidth(wrap),wrap.classList.add("is-resizing-first-col"),markResizeInteraction(wrap);try{handle.setPointerCapture(e.pointerId)}catch(_){}}}),handle.addEventListener("pointermove",function(e){if(resizing){if(e.preventDefault(),e.stopPropagation(),!didDrag)try{didDrag=Math.abs((e.clientX||0)-(startX||0))>2}catch(_){didDrag=!0}var next=startW+(e.clientX-startX);!function(wrap,width){if(wrap){applyWidthSingle(wrap,width);var applied=wrapWidth(wrap);if("ads-root"===wrap.id&&Number.isFinite(applied))try{var footer=document.getElementById("ads-footer");footer&&footer!==wrap&&applyWidthSingle(footer,applied)}catch(_){}}}(wrap,next),markResizeInteraction(wrap)}}),handle.addEventListener("pointerup",stopResize),handle.addEventListener("pointercancel",stopResize),handle.addEventListener("lostpointercapture",stopResize),handle.addEventListener("click",function(e){
// Prevent header click/sort when user interacts with the resize handle.
try{e.preventDefault()}catch(_){}try{e.stopPropagation()}catch(_){}},!0)}function suppressNextClick(){!function(){try{var root=document.documentElement;if(!root||"1"===root.getAttribute("data-kexo-sticky-resize-click-guard"))return;root.setAttribute("data-kexo-sticky-resize-click-guard","1")}catch(_){}try{document.addEventListener("click",function(e){var until=Number(window.__kexoStickyResizeSuppressClickUntil||0);if(Number.isFinite(until)&&!(until<=0)&&!(Date.now()>until)){
// A resize drag ends with a "click" on the header; eat it so it doesn't trigger sort/reorder.
try{e.preventDefault()}catch(_){}try{e.stopPropagation()}catch(_){}try{"function"==typeof e.stopImmediatePropagation&&e.stopImmediatePropagation()}catch(_){}try{window.__kexoStickyResizeSuppressClickUntil=0}catch(_){}}},!0)}catch(_){}}();try{window.__kexoStickyResizeSuppressClickUntil=Date.now()+600}catch(_){}}function stopResize(e){if(resizing){e&&"function"==typeof e.preventDefault&&e.preventDefault(),e&&"function"==typeof e.stopPropagation&&e.stopPropagation(),resizing=!1,wrap.classList.remove("is-resizing-first-col");try{e&&null!=e.pointerId&&handle.releasePointerCapture(e.pointerId)}catch(_){}markResizeInteraction(wrap),function(wrap,width){var n=Number(width);if(Number.isFinite(n)){var key=getStorageKey(wrap);try{localStorage.setItem(key,String(Math.round(n)))}catch(_){}}}(wrap,wrapWidth(wrap)),didDrag&&suppressNextClick()}}}function ensureHandle(wrap){var cell=getHeaderStickyCell(wrap);if(cell){var handle=cell.querySelector(".kexo-sticky-resize-handle");if(!handle){(handle=document.createElement("span")).className="kexo-sticky-resize-handle",handle.setAttribute("aria-hidden","true"),handle.setAttribute("data-no-drag-scroll","1");var iconEl=document.createElement("i");iconEl.setAttribute("data-icon-key","table-sticky-resize-handle"),iconEl.setAttribute("aria-hidden","true"),handle.appendChild(iconEl),cell.appendChild(handle)}bindHandle(wrap,handle)}}function debouncedEnsureHandle(wrap){if(wrap)try{null!=wrap._stickyEnsureHandleTimer&&clearTimeout(wrap._stickyEnsureHandleTimer),wrap._stickyEnsureHandleTimer=setTimeout(function(){wrap._stickyEnsureHandleTimer=null,ensureHandle(wrap)},60)}catch(_){}}function bind(wrap){if(wrap){
// Latest Sales (Live View) is intentionally not sticky/resizable.
try{if("latest-sales-table"===String(getWrapTableId(wrap)||"").trim().toLowerCase())return}catch(_){}try{wrap.classList.add("kexo-sticky-wrap")}catch(_){}if(applyWidthSingle(wrap,function(wrap){var raw=null,key=getStorageKey(wrap);try{raw=localStorage.getItem(key)}catch(_){raw=null}var fallback=getBounds(wrap).def;return clampWidth(wrap,null==raw?fallback:Number(raw))}(wrap)),ensureHandle(wrap),"1"!==wrap.getAttribute("data-sticky-resize-wrap-bound")){if(wrap.setAttribute("data-sticky-resize-wrap-bound","1"),"undefined"!=typeof ResizeObserver)try{var ro=new ResizeObserver(function(){applyWidthSingle(wrap,wrapWidth(wrap)),debouncedEnsureHandle(wrap)});ro.observe(wrap),wrap._stickyResizeObserver=ro}catch(_){}if("undefined"!=typeof MutationObserver)try{var mo=new MutationObserver(function(){debouncedEnsureHandle(wrap)});mo.observe(wrap,{childList:!0,subtree:!0}),wrap._stickyResizeMutationObserver=mo}catch(_){}}}}function run(){document.querySelectorAll(WRAP_SELECTOR).forEach(function(wrap){bind(wrap)})}function initStickyDocObserver(){if(!docMo&&"undefined"!=typeof MutationObserver)try{var schedule=kexoDebounce(function(){run()},120);docMo=new MutationObserver(function(muts){muts.forEach(function(m){(m.addedNodes||[]).forEach(function(n){if(n instanceof Element){try{n.matches&&n.matches(WRAP_SELECTOR)&&bind(n)}catch(_){}try{n.querySelectorAll&&n.querySelectorAll(WRAP_SELECTOR).forEach(function(w){bind(w)})}catch(_){}}})});try{schedule()}catch(_){}});var root=document.querySelector(".page-body")||document.body||document.documentElement;docMo.observe(root,{childList:!0,subtree:!0}),registerCleanup(function(){try{docMo&&"function"==typeof docMo.disconnect&&docMo.disconnect()}catch(_){}docMo=null;try{schedule&&schedule.cancel&&schedule.cancel()}catch(_){}})}catch(_){}}}();let activeMainTab="spy",nextLiveAt=0,nextRangeAt=0,lastSessionsFetchedAt=0,lastSessionsMode=null,lastStatsFetchedAt=0,lastKpisFetchedAt=0,lastAttributionFetchedAt=0,lastDevicesFetchedAt=0,lastBrowsersFetchedAt=0,lastProductsFetchedAt=0,kpiCache=null,kpiCacheRange="",kpiCacheSource="",liveRefreshInFlight=null,liveSalesPollTimer=null,liveSalesPollInFlight=null,liveSalesPendingPayload=null,liveSalesPendingAt=0,statsRefreshInFlight=null,attributionRefreshInFlight=null,devicesRefreshInFlight=null,browsersRefreshInFlight=null,productsRefreshInFlight=null,kpisRefreshInFlight=null,kpisRefreshRangeKey="",configStatusRefreshInFlight=null,activeKpiCompareKey="conv",reportBuildTokens={stats:0,breakdown:0,products:0,attribution:0,devices:0,browsers:0,sessions:0,diagnostics:0,kpiCompare:0,dashboard:0};var _intervals=[],_eventSource=null,_fetchAbortControllers={};let lastUpdateTime=null,lastConvertedCountToday=0,hasSeenConvertedCountToday=!1,convertedCountDayYmd=null,lastSaleAt=null,lastOnlineCount=null,onlineCountInFlight=!1,onlineCountLastFetchedAt=0,onlineCountPollTimer=null,onlineCountAuthBlocked=!1;const ONLINE_COUNT_POLL_MS=15e3,ONLINE_COUNT_RETRY_MS=3e4;let liveOnlineChart=null,liveOnlineChartType="",liveOnlineMapChartInstance=null,liveOnlineMapSessions=[],liveOnlineMapSessionsFetchedAt=0,liveOnlineMapSessionsInFlight=null,rangeOverviewChart=null,rangeOverviewChartKey="",rangeOverviewChartInFlight=null,abandonedCartsChart=null,abandonedCartsChartKey="",abandonedCartsChartInFlight=null,abandonedCartsChartInFlightKey="",abandonedCartsChartReqSeq=0,abandonedCartsSeriesCache={},abandonedCartsSeriesCacheOrder=[],abandonedCartsSeriesPrefetchInFlight={};const ABANDONED_CARTS_SERIES_CACHE_MAX=12;let abandonedCartsTopCacheKey="",abandonedCartsTopCountriesCache=null,abandonedCartsTopCountryProductsCache=null,abandonedCartsTopInFlight=null,dashCache=null;let productsLeaderboardView="title",leaderboardCache=null,leaderboardLoading=!1;let productsVariantCardsView="finishes",finishesCache=null,finishesLoading=!1,lengthsCache=null,lengthsLoading=!1,chainStylesCache=null,chainStylesLoading=!1,bestSellersCache=null,bestVariantsCache=null,countryPage=1,lastCountryRowCount=0,bestGeoProductsPage=1,bestSellersPage=1,bestVariantsPage=1,attributionPage=1,devicesPage=1,browsersPage=1,dashTopProductsPage=1,dashTopCountriesPage=1,dashTrendingPage=1,bestSellersSortBy="rev",bestSellersSortDir="desc";const tableSortState={country:{by:"rev",dir:"desc"},bestGeoProducts:{by:"rev",dir:"desc"},aov:{by:"aov",dir:"desc"},bestVariants:{by:"rev",dir:"desc"},attribution:{by:"rev",dir:"desc"},devices:{by:"rev",dir:"desc"},browsers:{by:"rev",dir:"desc"}},TABLE_SORT_DEFAULTS_country={country:"asc",cr:"desc",sales:"desc",clicks:"desc",rev:"desc"},TABLE_SORT_DEFAULTS_bestGeoProducts={country:"asc",cr:"desc",sales:"desc",clicks:"desc",rev:"desc"},TABLE_SORT_DEFAULTS_bestVariants={variant:"asc",sales:"desc",clicks:"desc",rev:"desc",cr:"desc"},TABLE_SORT_DEFAULTS_attribution={attribution:"asc",cr:"desc",orders:"desc",sessions:"desc",rev:"desc"},TABLE_SORT_DEFAULTS_devices={device:"asc",cr:"desc",orders:"desc",sessions:"desc",rev:"desc"},TABLE_SORT_DEFAULTS_browsers={browser:"asc",cr:"desc",orders:"desc",carts:"desc",sessions:"desc",aov:"desc",vpv:"desc",rev:"desc"};function rerenderDashboardFromCache(){try{if("function"==typeof window.refreshDashboard)return window.refreshDashboard({force:!1,silent:!0,rerender:!0}),!0}catch(_){}return!1}let saleAudio=null,saleMuted=!1,saleAudioPrimed=!1,saleSoundDeferredOnce=!1,saleSoundDeferredHandler=null,saleSoundLastOrigin="",saleSoundLastKey="",saleSoundLastAt=0;let saleToastSeenKeys=new Set,saleToastSeenOrder=[],saleToastActive=!1,saleToastToken=0,saleToastSessionId=null,saleToastHideTimer=null,saleToastLastOrderId=null,saleToastLastPayload=null,saleToastPinned=!1,saleToastLastShownAt=0,currentPage=1,sortBy="last_seen",sortDir="desc";const SORT_DEFAULTS={landing:"asc",from:"asc",arrived:"desc",source:"asc",device:"asc",cart:"desc",last_seen:"desc",history:"desc"};!function(){try{const raw=sessionStorage.getItem("products-variant-cards-view"),s=null!=raw?String(raw).trim().toLowerCase():"";productsVariantCardsView="lengths"===s||"length"===s?"lengths":"finishes"}catch(_){productsVariantCardsView="finishes"}}(),function(){try{const raw=sessionStorage.getItem("products-leaderboard-view"),s=null!=raw?String(raw).trim().toLowerCase():"";productsLeaderboardView="type"===s?"type":"title"}catch(_){productsLeaderboardView="title"}}(),
// Auto-configure pixel when opened from Shopify (shop in URL) so merchants don't run mutations manually
function(){const shop=new URLSearchParams(window.location.search).get("shop");shop&&/\.myshopify\.com$/i.test(shop)&&fetch("/api/pixel/ensure?shop="+encodeURIComponent(shop),{credentials:"same-origin"}).then(function(r){return r.json()}).then(function(data){data.ok&&data.action&&console.log("[Live Visitors] Pixel",data.action)}).catch(function(){})}();
// 'active' = Live view (last 5 min + arrived 60 min). Range mode uses ?range= with pagination.
let filter="active",sessionsTotal=null,selectedSessionId=null;const tz="Europe/London",MIN_YMD="2025-02-01";function updateServerTimeDisplay(){const el=document.getElementById("server-time-msg");if(el){var now=new Date;el.textContent=now.toLocaleTimeString("en-GB",{timeZone:tz,hour:"2-digit",minute:"2-digit",hour12:!1})}}function updateNextUpdateUi(){const block=document.querySelector("#tab-panel-spy .next-update-block");if(!block){
// Recent Sales no longer shows the next-update UI; don't let queued payloads get stuck.
try{liveSalesPendingPayload&&liveSalesCanAutoApply()&&applyLiveSalesPending()}catch(_){}return}const labelEl=document.getElementById("next-update-label"),timerWrap=document.getElementById("next-update-timer-wrap"),show="sales"===activeMainTab&&"sales"===PAGE;if(block.classList.toggle("is-hidden",!show),!show)return;
// "Updates available" CTA when polling is paused (sorting/paging).
const hasPending=!!liveSalesPendingPayload;let pendingBtn=document.getElementById("live-sales-updates-btn");if(!pendingBtn)try{pendingBtn=document.createElement("button"),pendingBtn.type="button",pendingBtn.id="live-sales-updates-btn",pendingBtn.className="btn btn-sm btn-primary is-hidden",pendingBtn.textContent="Updates available",block.appendChild(pendingBtn)}catch(_){pendingBtn=null}if(pendingBtn&&"1"!==pendingBtn.getAttribute("data-bound"))try{pendingBtn.setAttribute("data-bound","1"),pendingBtn.addEventListener("click",function(e){e&&"function"==typeof e.preventDefault&&e.preventDefault(),applyLiveSalesPending()})}catch(_){}if(hasPending&&pendingBtn){try{pendingBtn.classList.remove("is-hidden")}catch(_){}return labelEl&&labelEl.classList.add("is-hidden"),void(timerWrap&&timerWrap.classList.add("is-hidden"))}if(pendingBtn)try{pendingBtn.classList.add("is-hidden")}catch(_){}if(labelEl&&labelEl.classList.remove("is-hidden"),timerWrap&&timerWrap.classList.remove("is-hidden"),!timerWrap)return;const target="number"==typeof nextLiveAt&&nextLiveAt>Date.now()?nextLiveAt:"number"==typeof nextRangeAt&&nextRangeAt>Date.now()?nextRangeAt:Date.now()+1e4,remaining=Math.max(0,target-Date.now()),progress=Math.min(1,1-remaining/1e4);timerWrap.style.setProperty("--progress",String(progress))}function toMs(v){if(null==v||""===v)return null;let n="number"==typeof v?v:Number(v);return Number.isNaN(n)?null:(n<1e12&&(n*=1e3),n)}function formatTs(ms){const n=toMs(ms);if(null==n)return"—";const d=new Date(n);return Number.isNaN(d.getTime())?"—":d.toLocaleString("en-GB",{timeZone:tz,dateStyle:"short",timeStyle:"short"})}function sessionExitLabel(s){
// Live view: still active, no meaningful "exit" yet.
if(null==sessionsTotal&&"active"===filter)return"Live";var lastSeen=toMs(s&&s.last_seen),lastAction=toMs(s&&s.last_action_ts),lastEvent=toMs(s&&s.last_event_ts),baseline=null!=lastAction?lastAction:lastEvent;if(null==lastSeen||null==baseline)return"—";var delta=lastSeen-baseline;return!Number.isFinite(delta)||delta<0?"—":function(ms){var n="number"==typeof ms?ms:Number(ms);if(!Number.isFinite(n)||n<0)return"—";var s=Math.round(n/1e3);if(s<60)return String(s)+"s";var m=Math.floor(s/60),rem=s%60;if(m<60)return String(m)+"m "+String(rem)+"s";var h=Math.floor(m/60),remM=m%60;return String(h)+"h "+String(remM)+"m"}(delta)}function ymdNowInTz(){try{
// en-CA yields YYYY-MM-DD.
return new Intl.DateTimeFormat("en-CA",{timeZone:tz,year:"numeric",month:"2-digit",day:"2-digit"}).format(new Date)}catch(_){return(new Date).toISOString().slice(0,10)}}function updateLastSaleAgo(){var els=document.querySelectorAll(".last-sale-ago");if(els.length){var text=null==lastSaleAt?"—":function(ms){const n=toMs(ms);if(null==n)return"";const s=Math.floor((Date.now()-n)/1e3);if(s<0)return"now";if(s<60)return s+"s ago";if(s<3600)return Math.floor(s/60)+"m ago";if(s<86400)return Math.floor(s/3600)+"h ago";var d=Math.floor(s/86400);return d+(1===d?" day":" days")+" ago"}(lastSaleAt);els.forEach(function(el){el.textContent=text})}}function setLastSaleAt(ms){const n=toMs(ms);if(null==n)return;const cur=null==lastSaleAt?null:toMs(lastSaleAt);(null==cur||n>cur)&&(lastSaleAt=n,updateLastSaleAgo())}var countryNames={GB:"UK",US:"USA",CA:"CA",AU:"AU",DE:"DE",FR:"FR",IE:"IE",ES:"ES",IT:"IT",NL:"NL",IN:"IN",JP:"JP",DK:"DK",SE:"SE",NO:"NO",TH:"TH",NZ:"NZ",RO:"RO",BE:"BE",FI:"FI",AE:"UAE",XX:"—"},countryNamesFull={GB:"United Kingdom",US:"United States",CA:"Canada",AU:"Australia",DE:"Germany",FR:"France",IE:"Ireland",ES:"Spain",IT:"Italy",NL:"Netherlands",IN:"India",JP:"Japan",DK:"Denmark",SE:"Sweden",NO:"Norway",TH:"Thailand",NZ:"New Zealand",RO:"Romania",BE:"Belgium",FI:"Finland",AE:"United Arab Emirates",XX:"—"};function countryLabel(code){if(!code)return"Unknown";var c=(code||"XX").toUpperCase().slice(0,2);return countryNames[c]||c}function countryLabelFull(code){if(!code)return"Unknown";var c=(code||"XX").toUpperCase().slice(0,2);return countryNamesFull[c]||countryNames[c]||c}
// Add width=100 to hotlinked images (? or & depending on existing params).
function hotImg(url){if("string"!=typeof url)return url;if(/[?&]width=/i.test(url))return url;if(/^https?:\/\//i.test(url))try{const u=new URL(url);return u.searchParams.set("width","100"),u.toString()}catch(_){return url+(url.indexOf("?")>=0?"&":"?")+"width=100"}return url+(url.indexOf("?")>=0?"&":"?")+"width=100"}
// Product thumbs: request square (width + height) so object-fit: cover gives identical framing.
function hotImgSquare(url){if("string"!=typeof url)return url;if(/^https?:\/\//i.test(url))try{const u=new URL(url);return u.searchParams.set("width","100"),u.searchParams.set("height","100"),u.hostname.includes("shopify.com")&&u.searchParams.set("crop","center"),u.toString()}catch(_){const sep=url.indexOf("?")>=0?"&":"?";return url+sep+"width=100&height=100"}return url+(url.indexOf("?")>=0?"&":"?")+"width=100&height=100"}function flagImg(code,label){const raw=(code||"").toString().trim().toLowerCase(),safeLabel=null!=label?String(label):code?String(code):"?",titleAttr=label?' title="'+escapeHtml(safeLabel)+'"':"";return raw&&"xx"!==raw&&/^[a-z]{2}$/.test(raw)?'<span class="flag flag-xs flag-country-'+raw+'"'+titleAttr+' aria-label="'+escapeHtml(safeLabel)+'"></span>':'<span class="kexo-flag-fallback" style="display:inline-flex;align-items:center;justify-content:center;width:1rem;height:1rem;opacity:.8"'+titleAttr+' aria-label="'+escapeHtml(safeLabel)+'"><i class="fa-light fa-globe"></i></span>'}function flagImgSmall(code){const raw=(code||"").toString().trim().toLowerCase();return raw&&"xx"!==raw&&/^[a-z]{2}$/.test(raw)?'<span class="flag flag-xs flag-country-'+raw+'" aria-hidden="true"></span>':'<span class="kexo-flag-fallback" style="display:inline-flex;align-items:center;justify-content:center;width:1rem;height:1rem;opacity:.8" aria-hidden="true"><i class="fa-light fa-globe"></i></span>'}function arrivedAgo(startedAt){var n=toMs(startedAt);if(null==n)return"—";var s=Math.floor((Date.now()-n)/1e3);return s<0?"now":s<60?s+"s":s<3600?Math.floor(s/60)+"m":s<86400?Math.floor(s/3600)+"h":Math.floor(s/86400)+"d"}var storeBaseUrlFallback="",mainBaseUrlFallback="",assetsBaseUrlFallback="",shopForSalesFallback="";function getShopForSales(){var shop=getShopParam()||shopForSalesFallback||null;return shop&&/\.myshopify\.com$/i.test(shop)?shop:null}function getMainBaseUrl(){return mainBaseUrlFallback||((shop=new URLSearchParams(window.location.search).get("shop"))&&/\.myshopify\.com$/i.test(shop)?"https://"+shop:storeBaseUrlFallback||"");var shop}function getAssetsBase(){return assetsBaseUrlFallback||"/assets"}fetch("/api/store-base-url",{credentials:"same-origin"}).then(function(r){return r.json()}).then(function(d){if(d){if(d.baseUrl&&(storeBaseUrlFallback=d.baseUrl),d.mainBaseUrl&&(mainBaseUrlFallback=d.mainBaseUrl),d.assetsBaseUrl&&(assetsBaseUrlFallback=d.assetsBaseUrl),d.shopForSales&&(shopForSalesFallback=d.shopForSales),sessions.length&&renderTable(),assetsBaseUrlFallback){var link=document.querySelector('link[rel="icon"]');link&&(link.href="/assets/logos/new/kexo.webp"),void 0!==saleAudio&&saleAudio&&setSaleAudioSrc(getCashRegisterMp3Url())}shopForSalesFallback&&("products"===activeMainTab&&refreshProducts({force:!1}),"stats"===activeMainTab&&refreshStats({force:!1}),"attribution"===activeMainTab&&refreshAttribution({force:!1}),"devices"===activeMainTab&&refreshDevices({force:!1}),"browsers"===activeMainTab&&refreshBrowsers({force:!1}),"function"==typeof requestDashboardWidgetsRefresh&&requestDashboardWidgetsRefresh({force:!1}))}renderSales(statsCache)}).catch(function(){renderSales(statsCache)});hotImg("https://cdn.shopify.com/s/files/1/0847/7261/8587/files/hicon.webp?v=1770084894"),hotImg("https://cdn.shopify.com/s/files/1/0847/7261/8587/files/dollar.png?v=1770085223");var DEFAULT_SALE_SOUND="/assets/ui-alert/1.mp3";function getCashRegisterMp3Url(){try{var override="undefined"!=typeof window&&window.__kexoSaleSoundOverrideUrl?String(window.__kexoSaleSoundOverrideUrl).trim():"";if(override&&/^https?:\/\//i.test(override))return override;if(override&&"/"===override.charAt(0))return override}catch(_){}var assetsBase="";try{assetsBase=String(getAssetsBase()||"").trim()}catch(_){assetsBase=""}
// Only use a custom assets host/path when it is explicitly configured.
return assetsBase&&"/assets"!==assetsBase?assetsBase.replace(/\/+$/,"")+"/ui-alert/1.mp3":DEFAULT_SALE_SOUND}function setSaleAudioSrc(nextUrl){if(saleAudio){var url=null!=nextUrl?String(nextUrl):"";if(url){!function(){if(saleAudio)try{var a=saleAudio;if(a.__kexoSaleAudioOnError)try{a.removeEventListener("error",a.__kexoSaleAudioOnError)}catch(_){}a.__kexoSaleAudioOnError=function(){try{if(!a||!DEFAULT_SALE_SOUND)return;var cur=String(a.currentSrc||a.src||"");if(cur&&cur.indexOf(DEFAULT_SALE_SOUND)>=0)return;a.src=DEFAULT_SALE_SOUND;try{a.load()}catch(_){}}catch(_){}},a.addEventListener("error",a.__kexoSaleAudioOnError)}catch(_){}}();try{saleAudio.src=url;try{saleAudio.load()}catch(_){}}catch(_){}}}}function titleCaseFromHandle(handle){if("string"!=typeof handle)return null;let s=handle;try{s=decodeURIComponent(s)}catch(_){}return s=s.replace(/[-_]+/g," ").replace(/\s+/g," ").trim(),s?s.split(" ").filter(Boolean).map(function(w){const lower=w.toLowerCase();return lower.charAt(0).toUpperCase()+lower.slice(1)}).join(" "):null}
/** Sort key for landing column: use server-provided landing_title, else path. */function landingSortKey(s){var title=s&&null!=s.landing_title?String(s.landing_title).trim():"";if(title)return title;function trimStr(v){return null!=v?String(v).trim():""}var path=trimStr(s&&s.first_path),handle=trimStr(s&&s.first_product_handle);!path&&handle&&(path="/products/"+handle.replace(/^\/+/,"")),path&&!path.startsWith("/")&&(path="/"+path);try{/^https?:\/\//i.test(path)&&(path=new URL(path).pathname||"/")}catch(_){}return path=(path||"").split("#")[0].split("?")[0].replace(/\/+$/,"")||"/"}function visitsCount(s){var n=0;try{n=s&&null!=s.returning_count?Number(s.returning_count):0}catch(_){n=0}return Number.isFinite(n)||(n=0),n+1}function landingPageCell(s){function trimStr(v){return null!=v?String(v).trim():""}function handleFromPath(v){var raw=trimStr(v);if(!raw)return"";try{/^https?:\/\//i.test(raw)&&(raw=new URL(raw).pathname||"")}catch(_){}var m=raw.match(/\/products\/([^/?#]+)/i);return m&&m[1]?function(v){var h=trimStr(v);return h&&(h=h.replace(/^\/+/,"").split("#")[0].split("?")[0].trim().toLowerCase())?h.slice(0,128):""}(m[1]):""}var path="";try{path=(s&&null!=s.first_path&&""!==s.first_path?s.first_path:s&&null!=s.last_path?s.last_path:"").trim()}catch(_){path=""}path&&!path.startsWith("/")&&(path="/"+path);try{/^https?:\/\//i.test(path)&&(path=new URL(path).pathname||"/")}catch(_){}path=(path||"").split("#")[0].split("?")[0].replace(/\/+$/,"")||"/";var label=s&&null!=s.landing_title?String(s.landing_title).trim():"",display=label||path||"—",handle=handleFromPath(s&&s.first_path)||handleFromPath(s&&s.last_path);handle||(handle="");var mainBase=getMainBaseUrl(),productUrl=mainBase&&handle?mainBase+"/products/"+encodeURIComponent(handle):"";if(handle&&productUrl){var title=label||handle;return'<div class="last-action-cell"><a class="kexo-product-link js-product-modal-link" href="'+escapeHtml(productUrl)+'" target="_blank" rel="noopener" data-product-handle="'+escapeHtml(handle)+'" data-product-title="'+escapeHtml(title)+'">'+escapeHtml(display)+"</a></div>"}return'<div class="last-action-cell">'+escapeHtml(display)+"</div>"}function sourceUtmString(s){return[s.utm_source,s.utm_campaign,s.utm_medium,s.utm_content].filter(Boolean).join(" ").toLowerCase()}function sourceFriendlyLabel(s){const str=sourceUtmString(s);return str?-1!==str.indexOf("googleads")?null:-1!==str.indexOf("google")?"Google":-1!==str.indexOf("bing")?"Bing":-1!==str.indexOf("omnisend")?"Omnisend":-1!==str.indexOf("chatgpt")||-1!==str.indexOf("chat gpt")?"Chatgpt":null:
/** Derive friendly source name from referrer URL host (when no UTM). Use for tooltip and to collect images. */
function(s){const ref=s.referrer&&String(s.referrer).trim();if(!ref)return null;try{const host=(new URL(ref).hostname||"").toLowerCase().replace(/^www\./,"");return host?"account.heybigday.com"===host?"HeyBigDay Account":"account.hbdjewellery.com"===host?"HBD Account":"hbdjewellery.com"===host||host.endsWith(".myshopify.com")?"Store":-1!==host.indexOf("omnisend")?"Omnisend":-1!==host.indexOf("google")?"Google":-1!==host.indexOf("facebook")||0===host.indexOf("fb.")||"fb.com"===host?"Facebook":-1!==host.indexOf("instagram")?"Instagram":-1!==host.indexOf("pinterest")?"Pinterest":-1!==host.indexOf("tiktok")?"TikTok":-1!==host.indexOf("twitter")||-1!==host.indexOf("x.com")?"X (Twitter)":-1!==host.indexOf("youtube")?"YouTube":-1!==host.indexOf("linkedin")?"LinkedIn":-1!==host.indexOf("bing")?"Bing":-1!==host.indexOf("yahoo")?"Yahoo":-1!==host.indexOf("duckduckgo")?"DuckDuckGo":host:null}catch(_){return null}}(s)}function sourceSortKey(s){try{const variant=s&&null!=(s.attribution_variant??s.attributionVariant)?String(s.attribution_variant??s.attributionVariant).trim():"";if(variant)return variant.toLowerCase();const source=s&&null!=(s.attribution_source??s.attributionSource)?String(s.attribution_source??s.attributionSource).trim():"";if(source)return source.toLowerCase();const channel=s&&null!=(s.attribution_channel??s.attributionChannel)?String(s.attribution_channel??s.attributionChannel).trim():"";if(channel)return channel.toLowerCase()}catch(_){}
// Fallback: derive from UTMs/referrer (best-effort; older rows may not have attribution yet).
if(function(s){return-1!==sourceUtmString(s).indexOf("googleads")}(s))return"google ads";const friendly=sourceFriendlyLabel(s);return friendly?friendly.toLowerCase():sourceUtmString(s)||s&&s.referrer&&String(s.referrer).trim()?"other":"direct"}const SOURCE_GOOGLE_IMG=hotImg("https://cdn.shopify.com/s/files/1/0847/7261/8587/files/google.png?v=1770086632"),SOURCE_DIRECT_IMG=hotImg("https://cdn.shopify.com/s/files/1/0847/7261/8587/files/arrow-right.png?v=1770086632"),SOURCE_UNKNOWN_IMG=hotImg("https://cdn.shopify.com/s/files/1/0847/7261/8587/files/question.png?v=1770135816"),SOURCE_OMNISEND_IMG=hotImg("https://cdn.shopify.com/s/files/1/0847/7261/8587/files/omnisend.png?v=1770141052"),SOURCE_BING_IMG=hotImg("https://cdn.shopify.com/s/files/1/0847/7261/8587/files/bing.png?v=1770141094");hotImg("https://cdn.shopify.com/s/files/1/0847/7261/8587/files/liveview-source-logo.png?v=1770141081");function sourceCell(s){
// Acquisition attribution: use persisted `attribution_*` fields (single source of truth).
const variant=s&&null!=(s.attribution_variant??s.attributionVariant)?String(s.attribution_variant??s.attributionVariant).trim().toLowerCase():"",channel=s&&null!=(s.attribution_channel??s.attributionChannel)?String(s.attribution_channel??s.attributionChannel).trim().toLowerCase():"",source=s&&null!=(s.attribution_source??s.attributionSource)?String(s.attribution_source??s.attributionSource).trim().toLowerCase():"",confidence=s&&null!=(s.attribution_confidence??s.attributionConfidence)?String(s.attribution_confidence??s.attributionConfidence).trim().toLowerCase():"",labelRaw=variant||(channel&&source?channel+" / "+source:channel||source||"unknown"),title=confidence?labelRaw+" ("+confidence+")":labelRaw,head=(variant?variant.split(":")[0]:channel)||"";let spec="",extraClass="";"google_ads"===head||"google_organic"===head||"google"===head?(spec=SOURCE_GOOGLE_IMG,"google_ads"===head&&(extraClass="source-googleads-img")):spec="bing_ads"===head||"bing_organic"===head||"bing"===head?SOURCE_BING_IMG:"omnisend"===head||"klaviyo"===head||"email"===head?SOURCE_OMNISEND_IMG:head.indexOf("meta")>=0||"facebook"===head||"instagram"===head?"fa-brands fa-facebook":head.indexOf("tiktok")>=0?"fa-brands fa-tiktok":head.indexOf("pinterest")>=0?"fa-brands fa-pinterest":head.indexOf("affiliate")>=0||"affiliate"===channel?"fa-light fa-handshake":"direct"===head||"direct"===channel?SOURCE_DIRECT_IMG:SOURCE_UNKNOWN_IMG;const html=function(specRaw,label,extraClass){const spec=null!=specRaw?String(specRaw).trim():"";if(!spec)return"";const t=label?' title="'+escapeHtml(String(label))+'"':"",extra=extraClass?" "+String(extraClass):"";return/^<svg[\s>]/i.test(spec)?'<span class="source-icon-svg'+escapeHtml(extra)+'"'+t+' aria-hidden="true">'+spec+"</span>":/^(https?:\/\/|\/\/|\/)/i.test(spec)?function(src,alt,title,extraClass){const cls=(extraClass?extraClass+" ":"")+"source-icon-img",t=title?' title="'+escapeHtml(String(title))+'"':"";return'<img src="'+escapeHtml(hotImg(src)||src||"")+'" alt="'+escapeHtml(alt||"")+'" class="'+cls+'" width="20" height="20"'+t+">"}(spec,label,label,extraClass):'<i class="'+escapeHtml(spec)+" source-icon-fa"+escapeHtml(extra)+'"'+t+' aria-hidden="true"></i>'}(spec||"fa-light fa-circle-question",title,extraClass);return html?'<span class="source-icons"><span class="visually-hidden">'+escapeHtml(String(title||""))+"</span>"+html+"</span>":""}function buildFullEntryUrlForCopy(s){var entry=s&&null!=s.entry_url?String(s.entry_url).trim():"";if(!entry)return"";try{var u=new URL(entry),map={utm_source:s&&null!=s.utm_source?String(s.utm_source).trim():"",utm_medium:s&&null!=s.utm_medium?String(s.utm_medium).trim():"",utm_campaign:s&&null!=s.utm_campaign?String(s.utm_campaign).trim():"",utm_content:s&&null!=s.utm_content?String(s.utm_content).trim():"",utm_term:s&&null!=s.utm_term?String(s.utm_term).trim():""};return Object.keys(map).forEach(function(k){var v=map[k];if(v)try{u.searchParams.has(k)||u.searchParams.set(k,v)}catch(_){}}),u.toString()}catch(_){return entry}}function sourceDetailForPanel(s){function truncateUrlForPanel(raw,maxChars){var txt=null!=raw?String(raw):"",max=Number.isFinite(Number(maxChars))?Math.max(24,Math.trunc(Number(maxChars))):160;return txt.length<=max?txt:txt.slice(0,Math.max(0,max-5))+"....."}const lines=[],entry=s.entry_url&&String(s.entry_url).trim();if(entry){const full=buildFullEntryUrlForCopy(s),fullDisplay=truncateUrlForPanel(full,180),entryDisplay=truncateUrlForPanel(entry,180);full&&full!==entry?(lines.push("URL: "+fullDisplay),lines.push("Entry URL (raw): "+entryDisplay)):lines.push("URL: "+entryDisplay)}const ref=s.referrer&&String(s.referrer).trim();return ref&&lines.push("Referrer: "+ref),null!=s.utm_source&&""!==String(s.utm_source).trim()&&lines.push("utm_source: "+String(s.utm_source).trim()),null!=s.utm_medium&&""!==String(s.utm_medium).trim()&&lines.push("utm_medium: "+String(s.utm_medium).trim()),null!=s.utm_campaign&&""!==String(s.utm_campaign).trim()&&lines.push("utm_campaign: "+String(s.utm_campaign).trim()),null!=s.utm_content&&""!==String(s.utm_content).trim()&&lines.push("utm_content: "+String(s.utm_content).trim()),0===lines.length?"—":lines.join("\n")}function deviceInfoForSession(s){const uaDeviceTypeRaw=s&&null!=(s.ua_device_type??s.uaDeviceType)?String(s.ua_device_type??s.uaDeviceType):"",uaPlatformRaw=s&&null!=(s.ua_platform??s.uaPlatform)?String(s.ua_platform??s.uaPlatform):"",uaModelRaw=s&&null!=(s.ua_model??s.uaModel)?String(s.ua_model??s.uaModel):"",legacyDeviceRaw=s&&null!=s.device?String(s.device):"";function norm(v){return(v||"").trim().toLowerCase()}function isOneOf(v,list){return list.indexOf(v)>=0}return{deviceType:(()=>{const v=norm(uaDeviceTypeRaw);return isOneOf(v,["desktop","mobile","tablet"])?v:"unknown"})(),platform:(()=>{const v=norm(uaPlatformRaw)||function(){const d=norm(legacyDeviceRaw);return d?"ios"===d?"ios":"android"===d?"android":"windows"===d?"windows":"mac"===d?"mac":"chrome os"===d||"chromeos"===d?"chromeos":"linux"===d?"linux":"windows phone"===d?"windows":"":""}();return isOneOf(v,["ios","android","windows","mac","chromeos","linux"])?v:"other"===v?"other":"unknown"})(),model:(()=>{const v=norm(uaModelRaw);return isOneOf(v,["iphone","ipad"])?v:""})()}}function deviceSortKey(s){const info=deviceInfoForSession(s);return(info.platform+" "+(info.model||"")+" "+info.deviceType).trim().toLowerCase()}var liveComplianceMarkersCache={};function getComplianceCellHtmlFromState(hasSale,hasEval,triggered,score,sessionId){var scoreText="number"==typeof score&&Number.isFinite(score)?String(Math.trunc(score)):"",band=hasEval?function(score,triggered){if(triggered)return"high";if(null==score||!Number.isFinite(score))return"low";var s=Number(score);return s>=85?"high":s>=60?"medium":"low"}(score,triggered):"",title=hasEval?"high"===band?"High risk"+(scoreText?" (score "+scoreText+")":""):"medium"===band?"Medium risk"+(scoreText?" (score "+scoreText+")":""):"Low risk"+(scoreText?" (score "+scoreText+")":""):"Compliance",saleIcon=hasSale?'<i class="fa-solid fa-sterling-sign compliance-sale-icon" data-icon-key="table-icon-converted-sale" aria-hidden="true"></i>':"",statusIcon="";if(hasEval){var iconClass="compliance-status-icon";iconClass+="high"===band?" is-warn":"medium"===band?" is-medium":" is-ok",statusIcon="<span"+(null!=sessionId&&""!==sessionId?' data-fraud-open="1" data-fraud-entity-type="session" data-fraud-entity-id="'+escapeHtml(String(sessionId))+'" role="button" tabindex="0" class="compliance-status-clickable"':"")+'><i class="fa-light '+("high"===band?"fa-triangle-exclamation":"medium"===band?"fa-circle-exclamation":"fa-circle-check")+" "+iconClass+'" data-icon-key="table-icon-compliance-'+band+'" aria-hidden="true"></i></span>'}else statusIcon='<i class="fa-light fa-magnifying-glass compliance-status-icon is-search" data-icon-key="table-icon-compliance-search" aria-hidden="true"></i>';return'<span class="compliance-icons" aria-label="'+escapeHtml(title)+'" title="'+escapeHtml(title)+'">'+saleIcon+statusIcon+"</span>"}function paymentIconHtmlForSession(s){try{var k=function(s){try{if(!s||!s.has_purchased)return null;var candidates=[];null!=s.payment_method_type&&candidates.push(String(s.payment_method_type)),null!=s.payment_gateway&&candidates.push(String(s.payment_gateway)),null!=s.payment_method_name&&candidates.push(String(s.payment_method_name));for(var i=0;i<candidates.length;i++){var raw=(candidates[i]||"").trim();if(raw){var low=raw.toLowerCase();if(low.includes("paypal"))return"paypal";if(low.includes("apple")&&low.includes("pay"))return"applepay";if(low.includes("google")&&low.includes("pay"))return"google-pay";if(low.includes("klarna"))return"klarna";if(low.includes("shop")&&low.includes("pay"))return"shop-pay";if(low.includes("visa"))return"visa";if(low.includes("mastercard"))return"mastercard";if(low.includes("american")&&low.includes("express"))return"americanexpress";var k=normalizePaymentProviderKey(raw);if(k){var meta=paymentProviderMeta(k);if(meta&&meta.iconKey)return k}}}}catch(_){}return null}(s);return k?paymentProviderIconHtml(k,{extraClass:"payment-xxs"}):""}catch(_){return""}}function renderRow(s){const countryCode=s.country_code||"XX",visits=(null!=s.returning_count?s.returning_count:0)+1,visitsLabel=String(visits),actionsLabel=String(function(s){var n=s&&null!=s.actions_count?Number(s.actions_count):null;return"number"!=typeof n||!Number.isFinite(n)||n<0?0:Math.round(n)}(s)),exitLabel=String(sessionExitLabel(s)||"—"),exitCell="live"!==String(PAGE||"").trim().toLowerCase()?`<div class="grid-cell" role="cell">${escapeHtml(exitLabel)}</div>`:"",cartValueNum=null!=s.cart_value?Number(s.cart_value):NaN,cartVal=s.has_purchased||null==s.cart_value||Number.isNaN(cartValueNum)?"":formatMoney(Math.floor(cartValueNum),s.cart_currency),saleVal=s.has_purchased?formatMoney(null!=s.order_total?Number(s.order_total):null,s.order_currency):"",paymentIcon=s.has_purchased?paymentIconHtmlForSession(s):"",cartOrSaleCell=s.has_purchased?'<span class="d-inline-flex align-items-center gap-2"><span class="cart-value-sale">'+escapeHtml(saleVal)+"</span>"+paymentIcon+"</span>":cartVal,cached=liveComplianceMarkersCache[s.session_id],hasEval=!!cached&&!!cached.hasEval,triggered=!!cached&&!!cached.triggered,score=cached&&null!=cached.score?Number(cached.score):null,complianceCellHtml=getComplianceCellHtmlFromState(!!s.has_purchased,hasEval,triggered,score,s.session_id),fromCell=flagImg(countryCode);let consentDebug="";if(s&&s.meta_json)try{const mj=JSON.parse(String(s.meta_json||"{}"));consentDebug=mj&&mj.customer_privacy_debug?"yes":""}catch(_){}return`<div class="grid-row clickable ${s.is_returning?"returning":""} ${s.has_purchased?"converted":""}" role="row" data-session-id="${s.session_id}">\n        <div class="grid-cell landing-cell" role="cell">${landingPageCell(s)}</div>\n        <div class="grid-cell compliance-cell" role="cell">${complianceCellHtml}</div>\n        <div class="grid-cell flag-cell" role="cell">${fromCell}</div>\n        <div class="grid-cell source-cell" role="cell">${sourceCell(s)}</div>\n        <div class="grid-cell device-cell" role="cell">${function(s){const info=deviceInfoForSession(s),platformIconKey=function(platform){const p=(platform||"").trim().toLowerCase();return"ios"===p?"type-platform-ios":"mac"===p?"type-platform-mac":"android"===p?"type-platform-android":"windows"===p?"type-platform-windows":"chromeos"===p?"type-platform-chromeos":"linux"===p?"type-platform-linux":"type-platform-unknown"}(info.platform),deviceIconKey=function(deviceType){const d=(deviceType||"").trim().toLowerCase();return"desktop"===d?"type-device-desktop":"mobile"===d?"type-device-mobile":"tablet"===d?"type-device-tablet":"type-device-unknown"}(info.deviceType);function titleize(v){const s=(v||"").trim().toLowerCase();return s?"ios"===s?"iOS":"mac"===s?"Mac":"android"===s?"Android":"windows"===s?"Windows":"chromeos"===s?"Chrome OS":"linux"===s?"Linux":"desktop"===s?"Desktop":"mobile"===s?"Mobile":"tablet"===s?"Tablet":"iphone"===s?"iPhone":"ipad"===s?"iPad":"other"===s?"Other":"unknown"===s?"Unknown":s:""}const titleParts=[];info.platform&&"unknown"!==info.platform&&titleParts.push(titleize(info.platform)),info.model&&titleParts.push(titleize(info.model)),info.deviceType&&"unknown"!==info.deviceType&&titleParts.push(titleize(info.deviceType));const title=titleParts.length?titleParts.join(" - "):s&&null!=s.device?String(s.device):"Unknown";return'<span class="kexo-device-icons"'+(title?' title="'+escapeHtml(String(title))+'"':"")+'><i class="fa-light fa-circle-question" data-icon-key="'+escapeHtml(platformIconKey)+'" aria-hidden="true"></i><i class="fa-light fa-globe" data-icon-key="'+escapeHtml(deviceIconKey)+'" aria-hidden="true"></i><span class="visually-hidden">'+escapeHtml(String(title||""))+"</span></span>"}(s)}</div>\n        <div class="grid-cell cart-value-cell" role="cell">${cartOrSaleCell}</div>\n        <div class="grid-cell arrived-cell" role="cell"><span data-started="${s.started_at}">${arrivedAgo(s.started_at)}</span></div>\n        <div class="grid-cell last-seen-cell" role="cell"><span data-last-seen="${s.last_seen}">${arrivedAgo(s.last_seen)}</span></div>\n        <div class="grid-cell" role="cell">${escapeHtml(actionsLabel)}</div>\n        ${exitCell}\n        <div class="grid-cell" role="cell">${visitsLabel}</div>\n        <div class="grid-cell consent-debug consent-col is-hidden" role="cell">${escapeHtml(consentDebug)}</div>\n      </div>`}function escapeHtml(str){if(null==str)return"";const div=document.createElement("div");return div.textContent=str,div.innerHTML}function cartSortValue(s){if(s.has_purchased&&null!=s.order_total)return Number(s.order_total);if(null!=s.cart_value){const n=Number(s.cart_value);if(!Number.isNaN(n))return n}return-1/0}var PATCH_CHUNK_SIZE=12,PATCH_CHUNK_YIELD_THRESHOLD=15;function patchSessionsTableBodySync(tbody,list,existing,hadRows,desired){list.forEach(function(s){const sid=s&&null!=s.session_id?String(s.session_id):"";if(!sid)return;const sig=function(s){try{return s?[null!=s.session_id?String(s.session_id):"",null!=s.last_seen?String(s.last_seen):"",null!=s.started_at?String(s.started_at):"",s.has_purchased?"1":"0",null!=s.order_total?String(s.order_total):"",null!=s.order_currency?String(s.order_currency):"",null!=s.cart_value?String(s.cart_value):"",null!=s.cart_currency?String(s.cart_currency):"",null!=s.cart_qty?String(s.cart_qty):"",null!=s.device?String(s.device):"",null!=s.country_code?String(s.country_code):"",s.is_returning?"1":"0",null!=s.returning_count?String(s.returning_count):"",null!=s.last_product_handle?String(s.last_product_handle):"",null!=s.first_product_handle?String(s.first_product_handle):""].join("|"):""}catch(_){return""}}(s),cur=existing.get(sid);if(cur&&cur.getAttribute("data-kexo-sig")===sig)return existing.delete(sid),void desired.push(cur);const next=function(html){const wrap=document.createElement("div");return wrap.innerHTML=String(html||"").trim(),wrap.firstElementChild}(renderRow(s));if(next){try{next.setAttribute("data-kexo-sig",sig)}catch(_){}if(cur&&cur.parentNode===tbody){try{cur.replaceWith(next)}catch(_){}if(hadRows)try{next.classList.add("kexo-row-update")}catch(_){}}else if(hadRows)try{next.classList.add("kexo-row-insert")}catch(_){}existing.delete(sid),desired.push(next)}})}function patchSessionsTableBody(tbody,pageSessions){if(!tbody)return;const list=Array.isArray(pageSessions)?pageSessions:[];if(!list.length)return;const existing=new Map;Array.from(tbody.querySelectorAll(".grid-row[data-session-id]")).forEach(function(row){const sid=row&&row.getAttribute&&row.getAttribute("data-session-id")||"";sid&&existing.set(String(sid),row)});const hadRows=existing.size>0,desired=[];if(!(list.length<=PATCH_CHUNK_YIELD_THRESHOLD)){var chunkStart=0;return void function doChunk(){var chunkEnd=Math.min(chunkStart+PATCH_CHUNK_SIZE,list.length),chunk=list.slice(chunkStart,chunkEnd);patchSessionsTableBodySync(tbody,chunk,existing,hadRows,desired),(chunkStart=chunkEnd)<list.length&&"function"==typeof requestAnimationFrame?requestAnimationFrame(doChunk):function(){var cursor=tbody.firstElementChild;desired.forEach(function(row){if(row)if(row!==cursor)try{tbody.insertBefore(row,cursor)}catch(_){}else cursor=cursor.nextElementSibling}),existing.forEach(function(row){try{row.remove()}catch(_){}});try{Array.from(tbody.querySelectorAll(".grid-row:not([data-session-id])")).forEach(function(row){row.remove()})}catch(_){}desired.forEach(function(row){row&&row.classList&&(row.classList.contains("kexo-row-insert")||row.classList.contains("kexo-row-update"))&&setTimeout(function(){try{row.classList.remove("kexo-row-insert","kexo-row-update")}catch(_){}},900)});try{refreshComplianceMarkersForSessionsTable()}catch(_){}}()}()}patchSessionsTableBodySync(tbody,list,existing,hadRows,desired);var cursor=tbody.firstElementChild;desired.forEach(function(row){if(row)if(row!==cursor)try{tbody.insertBefore(row,cursor)}catch(_){}else cursor=cursor.nextElementSibling}),existing.forEach(function(row){try{row.remove()}catch(_){}});try{Array.from(tbody.querySelectorAll(".grid-row:not([data-session-id])")).forEach(function(row){row.remove()})}catch(_){}try{desired.forEach(function(row){row&&row.classList&&(row.classList.contains("kexo-row-insert")||row.classList.contains("kexo-row-update"))&&setTimeout(function(){try{row.classList.remove("kexo-row-insert","kexo-row-update")}catch(_){}},900)})}catch(_){}}function renderTable(){const renderStart="undefined"!=typeof performance&&performance.now?performance.now():Date.now(),tbody=document.getElementById("table-body");if(!tbody)return;// Sessions table not present (e.g. Settings page)
if("1"!==tbody.getAttribute("data-kexo-click-bound"))try{tbody.setAttribute("data-kexo-click-bound","1"),tbody.addEventListener("click",function(e){const target=e&&e.target?e.target:null;
// Clicking interactive elements inside a row should not open the side panel.
// Product links open the Product Insights modal only.
if(target&&target.closest&&target.closest("a.js-product-modal-link"))return;const row=target&&target.closest?target.closest(".grid-row.clickable[data-session-id]"):null;row&&tbody.contains(row)&&(selectedSessionId=row.getAttribute("data-session-id"),openSidePanel(selectedSessionId))})}catch(_){}const sorted=function(){if(!sortBy)return sessions.slice();const list=sessions.slice(),mult="asc"===sortDir?1:-1;return list.sort(function(a,b){var va,vb;return"landing"===sortBy?(va=(landingSortKey(a)||"").toLowerCase(),vb=(landingSortKey(b)||"").toLowerCase(),mult*(va<vb?-1:va>vb?1:0)):"from"===sortBy?(va=(a.country_code||"ZZ").toUpperCase(),vb=(b.country_code||"ZZ").toUpperCase(),mult*(va<vb?-1:va>vb?1:0)):"arrived"===sortBy?(va=toMs(a.started_at)??0,vb=toMs(b.started_at)??0,mult*(va-vb)):"source"===sortBy?(va=sourceSortKey(a),vb=sourceSortKey(b),mult*(va<vb?-1:va>vb?1:0)):"device"===sortBy?(va=deviceSortKey(a),vb=deviceSortKey(b),mult*(va<vb?-1:va>vb?1:0)):"cart"===sortBy?(va=cartSortValue(a),vb=cartSortValue(b),mult*(va-vb)):"last_seen"===sortBy?(va=toMs(a.last_seen)??0,vb=toMs(b.last_seen)??0,mult*(va-vb)):"history"===sortBy?(va=visitsCount(a),vb=visitsCount(b),mult*(va-vb)):0}),list}(),isRangeMode=null!=sessionsTotal,totalPages=isRangeMode?Math.max(1,Math.ceil(sessionsTotal/rowsPerPage)):Math.max(1,Math.ceil(sorted.length/rowsPerPage));currentPage=Math.min(Math.max(1,currentPage),totalPages);const start=(currentPage-1)*rowsPerPage,pageSessions=isRangeMode?sorted:sorted.slice(start,start+rowsPerPage);if(0===pageSessions.length){var emptyMsg=sessionsLoadError||"No sessions in this view.";tbody.innerHTML='<div class="grid-row" role="row"><div class="grid-cell empty span-all" role="cell">'+escapeHtml(emptyMsg)+"</div></div>"}else
// Avoid janky full rerenders: patch rows in-place so new rows animate cleanly.
patchSessionsTableBody(tbody,pageSessions);var paginWrap=document.getElementById("table-pagination");paginWrap&&(paginWrap.classList.toggle("is-hidden",totalPages<=1),totalPages>1&&(paginWrap.innerHTML=buildPaginationHtml(currentPage,totalPages)));const rowsSelect=document.getElementById("rows-per-page-select");rowsSelect&&(rowsSelect.value=String(rowsPerPage)),document.querySelectorAll(".table-scroll-wrap .grid-cell.sortable").forEach(function(th){var col=th.getAttribute("data-sort");th.classList.remove("th-sort-asc","th-sort-desc"),th.setAttribute("aria-sort",sortBy===col?"asc"===sortDir?"ascending":"descending":"none"),sortBy===col&&th.classList.add("asc"===sortDir?"th-sort-asc":"th-sort-desc")}),function(){const wrap=document.querySelector(".table-scroll-wrap"),table=document.getElementById("sessions-table");if(!wrap||!table)return;
// "Max mode": when all columns fit, remove extra inter-column padding.
const fits=table.scrollWidth<=wrap.clientWidth+1;wrap.classList.toggle("tight-cols",!!fits)}(),tickTimeOnSite();try{if("undefined"!=typeof performance&&performance.now){var ms=Math.round(100*(performance.now()-renderStart))/100;try{window.__kexoPerfMetrics=window.__kexoPerfMetrics||{},window.__kexoPerfMetrics.lastTableRenderMs=ms}catch(_){}}}catch(_){}try{refreshComplianceMarkersForSessionsTable()}catch(_){}}
// Fraud markers + modal (fail-open; markers fetched in batches).
var fraudUiBound=!1,fraudMarkersFetchInFlight=null,fraudMarkersLastKey="",fraudMarkersLastAt=0;function fetchFraudMarkers(entityType,ids){var et=entityType?String(entityType).trim().toLowerCase():"";if("session"!==et&&"order"!==et)return Promise.resolve({});var list=Array.isArray(ids)?ids.map(function(x){return null!=x?String(x).trim():""}).filter(Boolean):[];if(!list.length)return Promise.resolve({});list.length>200&&(list=list.slice(0,200));var key=et+":"+list.join(",");if(fraudMarkersFetchInFlight&&fraudMarkersFetchInFlight.key===key)return fraudMarkersFetchInFlight.p;var url="/api/fraud/markers?entityType="+encodeURIComponent(et)+"&ids="+encodeURIComponent(list.join(","))+"&_="+Date.now(),p=fetch(url,{credentials:"same-origin",cache:"no-store"}).then(function(r){return r.ok?r.json():null}).then(function(json){return json&&"object"==typeof json?json:{}}).catch(function(err){try{"function"==typeof window.kexoCaptureError&&window.kexoCaptureError(err,{context:"fraudMarkersFetch",page:document.body&&document.body.getAttribute("data-page")||""})}catch(_){}return{}}).finally(function(){fraudMarkersFetchInFlight&&fraudMarkersFetchInFlight.key===key&&(fraudMarkersFetchInFlight=null)});return fraudMarkersFetchInFlight={key:key,p:p},p}function refreshComplianceMarkersForSessionsTable(){!function(){var table=document.getElementById("sessions-table");if(table&&table.querySelector){var th=table.querySelector(".grid-row--header .grid-cell.compliance-cell");th&&"1"!==th.getAttribute("data-compliance-header")&&(th.setAttribute("data-compliance-header","1"),th.innerHTML='<i class="compliance-header-icon" data-icon-key="table-icon-compliance-header" aria-hidden="true"></i>')}}();var tbody=document.getElementById("table-body");if(tbody){var rows=Array.from(tbody.querySelectorAll(".grid-row[data-session-id]"));if(rows.length){var ids=rows.map(function(r){return r.getAttribute("data-session-id")||""}).filter(Boolean);if(ids.length){
// Avoid spamming when renderTable is called repeatedly in quick succession.
var key=ids.join(","),now=Date.now();key===fraudMarkersLastKey&&now-fraudMarkersLastAt>=0&&now-fraudMarkersLastAt<600||(fraudMarkersLastKey=key,fraudMarkersLastAt=now,fetchFraudMarkers("session",ids).then(function(markers){rows.forEach(function(row){if(row&&row.querySelector){var sid=row.getAttribute("data-session-id")||"",cell=row.querySelector(".grid-cell.compliance-cell");if(cell){var m=markers&&markers[sid]?markers[sid]:null,hasEval=!(!m||!0!==m.has_eval&&!0!==m.hasEval),triggered=!(!m||!0!==m.triggered),score=m&&null!=m.score?Number(m.score):null;try{liveComplianceMarkersCache[sid]={hasEval:hasEval,triggered:triggered,score:score}}catch(_){}var hasSale=!1;try{hasSale=row.classList&&row.classList.contains("converted")}catch(_){hasSale=!1}var sig=(hasSale?"1":"0")+"|"+(hasEval?"1":"0")+"|"+(triggered?"1":"0")+"|"+(null!=score&&Number.isFinite(score)?String(Math.trunc(score)):"");if(cell.getAttribute("data-compliance-sig")!==sig){try{cell.setAttribute("data-compliance-sig",sig)}catch(_){}cell.innerHTML=function(sessionId,options){var sid=null!=sessionId?String(sessionId):"";if(!sid)return"";var opts=options&&"object"==typeof options?options:{};return getComplianceCellHtmlFromState(!!opts.hasSale,!!opts.hasEval,!!opts.triggered,null!=opts.score?Number(opts.score):null,null!=opts.sessionId?String(opts.sessionId):sid)}(sid,{hasSale:hasSale,hasEval:hasEval,triggered:triggered,score:score,sessionId:sid})}}}})}).catch(function(err){try{"function"==typeof window.kexoCaptureError&&window.kexoCaptureError(err,{context:"complianceMarkersRefresh",page:document.body&&document.body.getAttribute("data-page")||""})}catch(_){}}))}}}}function refreshFraudMarkersForLatestSalesTable(){var table=document.getElementById("latest-sales-table");if(table){var rows=Array.from(table.querySelectorAll("tbody tr[data-session-id]"));if(rows.length){var ids=rows.map(function(tr){return tr.getAttribute("data-session-id")||""}).filter(Boolean);ids.length&&fetchFraudMarkers("session",ids).then(function(markers){rows.forEach(function(tr){if(tr&&tr.querySelector){var sid=tr.getAttribute("data-session-id")||"",slot=tr.querySelector(".latest-sales-fraud-slot");if(slot){var m=markers&&markers[sid]?markers[sid]:null,triggered=!(!m||!0!==m.triggered),score=m&&null!=m.score?Number(m.score):null,highRisk=triggered||Number.isFinite(score)&&score>=85,mediumRisk=!highRisk&&Number.isFinite(score)&&score>=60,showCue=highRisk||mediumRisk;slot.innerHTML=showCue?function(entityType,entityId,marker){var et=entityType?String(entityType):"session",eid=null!=entityId?String(entityId):"";if(!eid)return"";var score=marker&&null!=marker.score?Number(marker.score):null,scoreText="number"==typeof score&&Number.isFinite(score)?String(Math.trunc(score)):"",title=scoreText?"Fraud alert (score "+scoreText+")":"Fraud alert";return'<i class="fa-light fa-triangle-exclamation fraud-alert-icon" data-icon-key="fraud-alert" data-fraud-open="1" data-fraud-entity-type="'+escapeHtml(et)+'" data-fraud-entity-id="'+escapeHtml(eid)+'" aria-label="'+escapeHtml(title)+'" title="'+escapeHtml(title)+'"></i>'}("session",sid,m):""}}})}).catch(function(err){try{"function"==typeof window.kexoCaptureError&&window.kexoCaptureError(err,{context:"latestSalesFraudMarkersRefresh",page:document.body&&document.body.getAttribute("data-page")||""})}catch(_){}})}}}function ensureFraudModal(){var existing=document.getElementById("fraud-detail-modal");if(existing)return existing;var wrap=document.createElement("div");wrap.innerHTML='<div class="modal modal-blur" id="fraud-detail-modal" tabindex="-1" role="dialog" aria-hidden="true"><div class="modal-dialog modal-lg modal-dialog-centered" role="document"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Fraud alert</h5><button type="button" class="btn-close" aria-label="Close" data-fraud-close="1"></button></div><div class="modal-body" id="fraud-detail-body"></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-fraud-open-session="1" style="display:none">Open session</button><a class="btn btn-secondary" data-fraud-shopify-order="1" target="_blank" rel="noopener" style="display:none">Open order (Shopify)</a><button type="button" class="btn btn-primary" data-fraud-close="1">Close</button></div></div></div></div>';var el=wrap.firstChild;return document.body.appendChild(el),el}function hideFraudModal(){var el=document.getElementById("fraud-detail-modal");if(el){try{if(window.bootstrap&&window.bootstrap.Modal)window.bootstrap.Modal.getOrCreateInstance(el).hide()}catch(_){}try{el.classList.remove("show")}catch(_){}try{el.style.display="none"}catch(_){}try{Array.from(document.querySelectorAll('[data-fraud-backdrop="1"]')).forEach(function(n){n.remove()})}catch(_){}}}function renderFraudDetailBody(detail){var d=detail&&detail.evaluation?detail:{evaluation:null},ev=d&&d.evaluation?d.evaluation:null;if(!ev)return'<div class="text-muted">Unavailable.</div>';var score=null!=ev.score?Number(ev.score):null,scoreText="number"==typeof score&&Number.isFinite(score)?String(Math.trunc(score)):"—",risk=d&&d.analysis&&d.analysis.risk_level?String(d.analysis.risk_level):"Unknown",summary=d&&d.analysis&&d.analysis.summary?String(d.analysis.summary):"",rec=d&&d.analysis&&d.analysis.recommended_action?String(d.analysis.recommended_action):"",reasons=d&&d.analysis&&Array.isArray(d.analysis.key_reasons)?d.analysis.key_reasons:[],flags=ev.flags&&Array.isArray(ev.flags)?ev.flags:[],evidence=ev.evidence&&"object"==typeof ev.evidence?ev.evidence:{},badge="High"===risk?"bg-red-lt text-red":"Medium"===risk?"bg-yellow-lt text-yellow":"bg-green-lt text-green";function listKeys(obj){try{return obj&&"object"==typeof obj?Object.keys(obj).filter(function(k){return null!=obj[k]&&""!==String(obj[k]).trim()}).slice(0,8):[]}catch(_){return[]}}var flagsHtml=flags.length?'<ul class="fraud-flag-lines">'+flags.map(function(f){var desc=function(flagKey){var k=String(flagKey||"").trim().toLowerCase(),attr=evidence&&evidence.attribution?evidence.attribution:{},eng=evidence&&evidence.engagement?evidence.engagement:{},sig=evidence&&evidence.signals?evidence.signals:{};if("google_ads_conflict"===k){var paid=attr&&attr.paid_click_ids?attr.paid_click_ids:{},aff=attr&&attr.affiliate_click_ids?attr.affiliate_click_ids:{},pk=listKeys(paid),ak=listKeys(aff);return"Paid click IDs ("+(pk.length?pk.join(", "):"none")+") and affiliate click IDs ("+(ak.length?ak.join(", "):"none")+") both detected."}if("late_injection"===k){var late=attr&&attr.late?attr.late:null,seenAt=(ak=listKeys(late&&late.affiliate_click_ids?late.affiliate_click_ids:{}),late&&null!=late.seen_at?Number(late.seen_at):null),when=seenAt&&Number.isFinite(seenAt)?"seen_at "+new Date(seenAt).toLocaleString():"seen late";return"Affiliate click IDs appeared late ("+(ak.length?ak.join(", "):"unknown")+"), "+when+"."}if("low_engagement"===k){var pv=eng&&null!=eng.page_views?Number(eng.page_views):null,te=eng&&null!=eng.total_events?Number(eng.total_events):null;return"Very few interactions before checkout (page_views: "+(null!=pv&&Number.isFinite(pv)?pv:"—")+", total_events: "+(null!=te&&Number.isFinite(te)?te:"—")+")."}if("suspicious_referrer"===k){var ref=attr&&attr.referrer?String(attr.referrer):"";return ref?"Referrer matches coupon/deal patterns: "+ref:"Referrer matches coupon/deal patterns."}if("duplicate_ip_pattern"===k){var n=sig&&null!=sig.duplicate_ip_triggered_recent?Number(sig.duplicate_ip_triggered_recent):null,h=sig&&null!=sig.duplicate_ip_window_hours?Number(sig.duplicate_ip_window_hours):null;return null!=n&&Number.isFinite(n)&&null!=h&&Number.isFinite(h)?"Triggered evaluations from the same IP hash in last "+h+"h: "+n+".":null!=n&&Number.isFinite(n)?"Multiple triggered evaluations share the same IP hash (count: "+n+").":"Multiple triggered evaluations share the same IP hash in a short window."}if("no_affiliate_evidence"===k){var net=attr&&attr.affiliate_network_hint?String(attr.affiliate_network_hint):"",idh=attr&&attr.affiliate_id_hint?String(attr.affiliate_id_hint):"",um=attr&&attr.utm_medium?String(attr.utm_medium):"",parts=[];return net&&parts.push("network: "+net),idh&&parts.push("affiliate_id: "+idh),um&&parts.push("utm_medium: "+um),"Affiliate attribution hints present but no reliable click ID evidence"+(parts.length?" ("+parts.join(", ")+")":"")+"."}return""}(f);return'<li><span class="badge bg-azure-lt">'+escapeHtml(String(f))+"</span>"+(desc?'<span class="fraud-flag-desc">'+escapeHtml(desc)+"</span>":"")+"</li>"}).join("")+"</ul>":'<div class="text-muted">No flags recorded.</div>',reasonsHtml=reasons.length?'<ul class="fraud-reasons">'+reasons.map(function(r){return"<li>"+escapeHtml(String(r))+"</li>"}).join("")+"</ul>":"",evidenceJson="";try{evidenceJson=JSON.stringify(evidence,null,2)}catch(_){evidenceJson=""}return'<div class="fraud-detail-grid"><div class="fraud-score"><div class="fraud-score-num">'+escapeHtml(scoreText)+'</div><div class="fraud-score-meta"><span class="badge '+escapeHtml(badge)+'" style="font-weight:500">'+escapeHtml(risk)+'</span><div class="text-muted" style="margin-top:.25rem">Fraud score (0–100)</div></div></div><div class="fraud-analysis"><div class="mb-2" style="font-weight:500">Analysis</div><div class="fraud-summary">'+escapeHtml(summary||"—")+"</div>"+(reasonsHtml?'<div class="mt-2">'+reasonsHtml+"</div>":"")+(rec?'<div class="mt-2 text-muted"><span style="font-weight:500">Suggested action:</span> '+escapeHtml(rec)+"</div>":"")+'</div></div><hr class="my-3" /><div class="mb-2" style="font-weight:500">Flags</div>'+flagsHtml+'<hr class="my-3" /><div class="mb-2 d-flex align-items-center justify-content-between"><div style="font-weight:500">Evidence (safe snapshot)</div><button type="button" class="btn btn-sm btn-secondary" data-fraud-copy-evidence="1">Copy</button></div><pre class="fraud-evidence-pre" data-fraud-evidence-pre="1">'+escapeHtml(evidenceJson||"{}")+"</pre>"}function openFraudDetailModal(entityType,entityId){var et=entityType?String(entityType).trim().toLowerCase():"session",eid=null!=entityId?String(entityId).trim():"";if(eid){var modal=ensureFraudModal(),body=modal.querySelector("#fraud-detail-body");body&&(body.innerHTML='<div class="text-muted">Loading…</div>');
// Hide action buttons until we have links.
try{var btnSession=modal.querySelector("[data-fraud-open-session]"),btnOrder=modal.querySelector("[data-fraud-shopify-order]");btnSession&&(btnSession.style.display="none"),btnOrder&&(btnOrder.style.display="none")}catch(_){}!function(){var el=ensureFraudModal();try{if(window.bootstrap&&window.bootstrap.Modal)return void window.bootstrap.Modal.getOrCreateInstance(el,{backdrop:!0,focus:!0,keyboard:!0}).show()}catch(_){}
// Minimal fallback (should rarely be used).
try{el.style.display="block"}catch(_){}try{el.classList.add("show")}catch(_){}try{var bd=document.createElement("div");bd.className="modal-backdrop fade show",bd.setAttribute("data-fraud-backdrop","1"),document.body.appendChild(bd)}catch(_){}}();var url="/api/fraud/detail?entityType="+encodeURIComponent(et)+"&entityId="+encodeURIComponent(eid)+"&_="+Date.now();fetch(url,{credentials:"same-origin",cache:"no-store"}).then(function(r){return r.ok?r.json():null}).then(function(json){if(!json||!json.ok||!json.evaluation)return body&&(body.innerHTML='<div class="text-muted">Unavailable.</div>'),null;body&&(body.innerHTML=renderFraudDetailBody(json));try{var links=json.links||{},sid=links&&links.session_id?String(links.session_id):"",oid=links&&links.order_id?String(links.order_id):"",btnSession=modal.querySelector("[data-fraud-open-session]");btnSession&&sid&&(btnSession.style.display="",btnSession.setAttribute("data-fraud-open-session",sid));var btnOrder=modal.querySelector("[data-fraud-shopify-order]"),orderUrl=function(orderId){var oid=null!=orderId?String(orderId).trim():"";if(!oid||!/^\d+$/.test(oid))return null;var shop=null;try{shop=getShopParam()||shopForSalesFallback||null}catch(_){shop=null}return shop?"https://"+shop+"/admin/orders/"+encodeURIComponent(oid):null}(oid);btnOrder&&orderUrl&&(btnOrder.style.display="",btnOrder.setAttribute("href",orderUrl))}catch(_){}return json}).catch(function(){return body&&(body.innerHTML='<div class="text-muted">Unavailable.</div>'),null})}}function shouldIgnoreStickyResizeSortClick(e){var target=e&&e.target&&e.target.closest?e.target:null;if(target&&target.closest(".kexo-sticky-resize-handle"))return!0;var wrap=target?target.closest(".table-scroll-wrap, .country-table-wrap, .table-responsive"):null,ts=wrap?Number(wrap.getAttribute("data-sticky-resize-at")||"0"):0;return(!Number.isFinite(ts)||ts<=0)&&(ts=Number(window.__kexoLastStickyResizeAt||0)),Number.isFinite(ts)&&ts>0&&Date.now()-ts<400}function tickTimeOnSite(){document.querySelectorAll("#table-body span[data-started]").forEach(span=>{const started=parseInt(span.getAttribute("data-started"),10);span.textContent=arrivedAgo(started)}),document.querySelectorAll("#table-body span[data-last-seen]").forEach(span=>{const lastSeen=parseInt(span.getAttribute("data-last-seen"),10);span.textContent=arrivedAgo(lastSeen)})}function pct(v){return null!=v?v.toFixed(1)+"%":""}function formatRevenue0(num){if(null==num||"number"!=typeof num||!Number.isFinite(num))return"";try{return"£"+Math.round(num).toLocaleString("en-GB")}catch(_){return"£"+String(Math.round(num))}}function isEffectivelyZero(value,epsilon){var n="number"==typeof value?value:Number(value);if(!Number.isFinite(n))return!1;var tol="number"==typeof epsilon&&Number.isFinite(epsilon)&&epsilon>=0?epsilon:1e-9;return Math.abs(n)<=tol}function normalizeZeroNumber(value,epsilon){var n="number"==typeof value?value:Number(value);return Number.isFinite(n)?isEffectivelyZero(n,epsilon)?0:n:null}function formatSignedPercentOneDecimalFromRatio(rawRatio){var ratio=normalizeZeroNumber(rawRatio,5e-4);// <0.05% should render as 0%
if(null==ratio)return"—";var pct=Math.round(1e3*ratio)/10;return isEffectivelyZero(pct,1e-9)&&(pct=0),(pct>0?"+":pct<0?"-":"")+Math.abs(pct).toFixed(1).replace(/\.0$/,"")+"%"}function formatNegativeCurrencyOrZero(value,useWholePounds){var n="number"==typeof value&&Number.isFinite(value)?Math.abs(value):null;if(null==n)return"—";if(n<(useWholePounds?.5:.005))return useWholePounds?"£0":"£0.00";var s=useWholePounds?formatRevenue0(n):formatRevenue(n);return s?"-"+s:"—"}function crPillHtml(v){const n=null!=v?Number(v):NaN;return Number.isFinite(n)?'<span class="aov-card-cr-pill" title="Conversion rate">CR '+escapeHtml(pct(n))+"</span>":""}function formatRevenue(num){if(null==num||"number"!=typeof num||!Number.isFinite(num))return"";
// Keep dashboard currency formatting consistent everywhere (thousands separators + 2dp).
try{return"£"+num.toLocaleString("en-GB",{minimumFractionDigits:2,maximumFractionDigits:2})}catch(_){return"£"+num.toFixed(2)}}function formatRevenueTableHtml(num){if(null==num||"number"!=typeof num||!Number.isFinite(num))return"—";if(function(){try{return!(!window.matchMedia||!window.matchMedia("(max-width: 768px)").matches)}catch(_){return!1}}())return"£"+Math.round(num).toLocaleString("en-GB");if(num%1==0)return"£"+num.toLocaleString("en-GB");let fixed=null;try{fixed=num.toLocaleString("en-GB",{minimumFractionDigits:2,maximumFractionDigits:2})}catch(_){fixed=num.toFixed(2)}const parts=String(fixed).split(".");return"£"+parts[0]+'<span class="rev-decimal">.'+(parts[1]||"00")+"</span>"}function setSaleToastContent(patch){patch=patch&&"object"==typeof patch?patch:{};const data={...saleToastLastPayload||{}},hasOwn=Object.prototype.hasOwnProperty;hasOwn.call(patch,"countryCode")&&(data.countryCode=patch.countryCode),hasOwn.call(patch,"productTitle")&&(data.productTitle=patch.productTitle),hasOwn.call(patch,"amountGbp")&&(data.amountGbp=patch.amountGbp),hasOwn.call(patch,"productHandle")&&(data.productHandle=patch.productHandle),hasOwn.call(patch,"productUrl")&&(data.productUrl=patch.productUrl),hasOwn.call(patch,"productThumbUrl")&&(data.productThumbUrl=patch.productThumbUrl),hasOwn.call(patch,"createdAt")&&(data.createdAt=patch.createdAt);const cc=(data.countryCode||"XX").toString().trim().toUpperCase().slice(0,2)||"XX",product=null!=data.productTitle?String(data.productTitle):"",amountRaw=null!=data.amountGbp?Number(data.amountGbp):null,amountGbp=null!=amountRaw&&Number.isFinite(amountRaw)?amountRaw:null;saleToastLastPayload={...data,countryCode:cc,productTitle:product,amountGbp:amountGbp};const inlineFlagEl=document.getElementById("sale-toast-inline-flag"),productEl=document.getElementById("sale-toast-product"),amountEl=document.getElementById("sale-toast-amount");if(inlineFlagEl&&(inlineFlagEl.innerHTML=flagImgSmall(cc)),productEl&&(productEl.textContent=product&&product.trim()?product:"—"),amountEl&&(amountEl.textContent=null!=amountGbp&&formatRevenue(amountGbp)||"£—"),null!=data.createdAt)try{setLastSaleAt(data.createdAt)}catch(_){}}function updateSaleToastToggle(){var isPinned=!!saleToastPinned;["last-sale-toggle","footer-last-sale-toggle"].forEach(function(id){var btn=document.getElementById(id);if(btn){btn.classList.toggle("is-on",isPinned),btn.setAttribute("aria-pressed",isPinned?"true":"false"),btn.setAttribute("aria-label",isPinned?"Hide last sale toast":"Show last sale toast");var eyeOn=btn.querySelector(".fa-eye"),eyeOff=btn.querySelector(".fa-eye-slash");eyeOn&&(eyeOn.style.display=isPinned?"none":""),eyeOff&&(eyeOff.style.display=isPinned?"":"none")}})}function hideSaleToast(){const banner=document.getElementById("sale-toast-banner");if(saleToastHideTimer&&(clearTimeout(saleToastHideTimer),saleToastHideTimer=null),!banner)return saleToastActive=!1,void(saleToastSessionId=null);banner.classList.remove("active"),banner.setAttribute("aria-hidden","true"),setTimeout(function(){banner.setAttribute("hidden",""),saleToastActive=!1,saleToastSessionId=null;
// Sale banner indicates KPIs are about to change. Reset caches once the banner disappears.
try{!function(){try{localStorage.removeItem("kexo-kpis-cache-v1")}catch(_){}try{localStorage.removeItem("kexo-kpis-expanded-extra-cache-v1")}catch(_){}try{kpiCacheRange=""}catch(_){}try{kpiCacheSource=""}catch(_){}}()}catch(_){}try{lastKpisFetchedAt=0}catch(_){}try{kpiCacheRange=""}catch(_){}try{kpiCacheSource=""}catch(_){}try{kpiExpandedExtrasFetchedAt=0}catch(_){}
// Pull fresh KPI data (fast metrics) immediately after cache reset.
try{refreshKpis({force:!0})}catch(_){}
// Keep the dashboard tables/charts in sync, but do not re-show the global loader.
try{"dashboard"===PAGE&&"function"==typeof window.refreshDashboard&&window.refreshDashboard({force:!0,silent:!0})}catch(_){}
// Refresh condensed KPI extras as well.
try{refreshKpiExtrasSoft()}catch(_){}},320)}!function(){if(!fraudUiBound){fraudUiBound=!0;try{function handleFraudOpenClick(openEl){openEl&&openFraudDetailModal(openEl.getAttribute("data-fraud-entity-type")||"session",openEl.getAttribute("data-fraud-entity-id")||"")}document.addEventListener("click",function(e){var target=e&&e.target?e.target:null,openEl=target&&target.closest?target.closest("[data-fraud-open]"):null;if(openEl){try{e.preventDefault()}catch(_){}try{e.stopPropagation()}catch(_){}handleFraudOpenClick(openEl)}else{if(target&&target.closest?target.closest("[data-fraud-close]"):null){try{e.preventDefault()}catch(_){}hideFraudModal()}else{var openSessionEl=target&&target.closest?target.closest("[data-fraud-open-session]"):null;if(openSessionEl){var sid=openSessionEl.getAttribute("data-fraud-open-session")||"";if(sid){try{e.preventDefault()}catch(_){}hideFraudModal();try{openSidePanel(sid)}catch(_){}}}else{if(target&&target.closest?target.closest("[data-fraud-copy-evidence]"):null){try{e.preventDefault()}catch(_){}try{var pre=document.querySelector('#fraud-detail-modal [data-fraud-evidence-pre="1"]'),txt=pre&&pre.textContent||"";txt&&navigator&&navigator.clipboard&&navigator.clipboard.writeText&&navigator.clipboard.writeText(txt).catch(function(){})}catch(_){}}}}}},!0),document.addEventListener("keydown",function(e){var target=e&&e.target?e.target:null,openEl=target&&target.closest?target.closest("[data-fraud-open]"):null;if(openEl&&("Enter"===e.key||" "===e.key)){try{e.preventDefault()}catch(_){}try{e.stopPropagation()}catch(_){}handleFraudOpenClick(openEl)}},!0)}catch(_){}}}();let latestSaleFetchInFlight=null;function fetchLatestSaleForToast(options={}){if(!!(!options||!options.forceNew)&&latestSaleFetchInFlight)return latestSaleFetchInFlight;const url="/api/latest-sale?_="+Date.now(),p=fetch(url,{credentials:"same-origin",cache:"no-store"}).then(function(r){return r.ok?r.json():null}).then(function(json){return json&&json.ok&&json.sale?json.sale:null}).catch(function(){return null}).finally(function(){latestSaleFetchInFlight===p&&(latestSaleFetchInFlight=null)});return latestSaleFetchInFlight=p,p}
// Latest sales table (/dashboard/live): last 5 converted sessions (desktop only).
let latestSalesFetchInFlight=null,latestSalesCache=null,latestSalesRefetchTimer=null;function normalizeLatestSaleRow(row){const r=row&&"object"==typeof row?row:{},sid=null!=r.session_id?String(r.session_id):"",cc=null!=r.country_code?String(r.country_code).trim().toUpperCase().slice(0,2):"XX",purchasedAt=null!=r.purchased_at?toMs(r.purchased_at):null,totalRaw=null!=r.order_total?"number"==typeof r.order_total?r.order_total:parseFloat(String(r.order_total)):null,out={session_id:sid||null,country_code:cc||"XX",purchased_at:purchasedAt,order_total:"number"==typeof totalRaw&&Number.isFinite(totalRaw)?totalRaw:null,order_currency:(null!=r.order_currency?String(r.order_currency).trim().toUpperCase():"")||null,last_product_handle:(null!=r.last_product_handle?String(r.last_product_handle).trim():"")||null,first_product_handle:(null!=r.first_product_handle?String(r.first_product_handle).trim():"")||null},totalGbpRaw=null!=r.order_total_gbp?"number"==typeof r.order_total_gbp?r.order_total_gbp:parseFloat(String(r.order_total_gbp)):null,totalGbp="number"==typeof totalGbpRaw&&Number.isFinite(totalGbpRaw)?totalGbpRaw:null;null!=totalGbp&&(out.order_total_gbp=totalGbp);const pidRaw=null!=r.product_id?String(r.product_id).replace(/^gid:\/\/shopify\/Product\//i,"").trim():"";pidRaw&&/^\d+$/.test(pidRaw)&&(out.product_id=pidRaw);const titleRaw=null!=r.product_title?String(r.product_title).trim():"";return titleRaw&&(out.product_title=titleRaw),out}function renderLatestSalesTable(rows){const table=document.getElementById("latest-sales-table");if(!table)return;const tbody=table.querySelector("tbody");if(!tbody)return;const list=Array.isArray(rows)?rows:[];if(!list.length)return void(tbody.innerHTML='<tr><td colspan="4" class="dash-empty">No sales</td></tr>');const mainBase=getMainBaseUrl(),pageSize=getTableRowsPerPage("latest-sales-table","dashboard");tbody.innerHTML=list.slice(0,pageSize).map(function(s){const sid=s&&null!=s.session_id?String(s.session_id):"",cc=(s&&s.country_code?String(s.country_code):"XX").toUpperCase().slice(0,2)||"XX",productId=s&&null!=s.product_id?String(s.product_id).replace(/^gid:\/\/shopify\/Product\//i,"").trim():"",pid=productId&&/^\d+$/.test(productId)?productId:"",handle=s&&s.last_product_handle?String(s.last_product_handle).trim():s&&s.first_product_handle?String(s.first_product_handle).trim():"",title=(s&&null!=s.product_title?String(s.product_title).trim():"")||handle&&titleCaseFromHandle(handle)||""||"Unknown product",productUrl=mainBase&&handle?mainBase+"/products/"+encodeURIComponent(handle):"#",titleHtml=!(!handle&&!pid)?'<a class="kexo-product-link js-product-modal-link" href="'+escapeHtml(productUrl||"#")+'" target="_blank" rel="noopener"'+(handle?' data-product-handle="'+escapeHtml(handle)+'"':"")+(pid?' data-product-id="'+escapeHtml(pid)+'"':"")+(title?' data-product-title="'+escapeHtml(title)+'"':"")+">"+escapeHtml(title)+"</a>":escapeHtml(title||"Unknown product"),ago=s&&null!=s.purchased_at?arrivedAgo(s.purchased_at):"—",money=s&&"number"==typeof s.order_total_gbp?formatMoney(s.order_total_gbp,"GBP")||"—":s&&null!=s.order_total&&formatMoney(s.order_total,s.order_currency)||"—";return"<tr"+(sid?' data-session-id="'+escapeHtml(sid)+'"':"")+'><td class="w-1 latest-sales-flag-cell">'+flagImgSmall(cc)+'<span class="latest-sales-fraud-slot" aria-hidden="true"></span></td><td>'+titleHtml+'</td><td class="text-end text-muted">'+escapeHtml(ago)+'</td><td class="text-end fw-semibold">'+escapeHtml(money)+"</td></tr>"}).join("");try{refreshFraudMarkersForLatestSalesTable()}catch(_){}}function fetchLatestSales(options={}){if(!!(!options||!options.force)&&latestSalesFetchInFlight)return latestSalesFetchInFlight;if(!document.getElementById("latest-sales-table"))return Promise.resolve(null);const url="/api/latest-sales?limit=5&_="+Date.now(),p=fetch(url,{credentials:"same-origin",cache:"no-store"}).then(function(r){return r.ok?r.json():null}).then(function(json){const list=json&&Array.isArray(json.sales)?json.sales:[];return latestSalesCache=list.map(normalizeLatestSaleRow).filter(function(r){return r&&r.session_id}).slice(0,5),renderLatestSalesTable(latestSalesCache),latestSalesCache}).catch(function(){return null}).finally(function(){latestSalesFetchInFlight===p&&(latestSalesFetchInFlight=null)});return latestSalesFetchInFlight=p,p}
// Sale sound: prime/unlock on first user interaction, and retry once on click if autoplay is blocked.
function primeSaleAudio(){if(!saleAudio||saleAudioPrimed)return;const a=saleAudio;saleAudioPrimed=!0;const prevMuted=!!a.muted,prevVol="number"==typeof a.volume&&Number.isFinite(a.volume)?a.volume:1;try{a.preload="auto"}catch(_){}try{a.load()}catch(_){}try{a.muted=!0}catch(_){}try{a.volume=0}catch(_){}try{const p=a.play();if(p&&"function"==typeof p.then)return void p.then(function(){try{a.pause()}catch(_){}try{a.currentTime=0}catch(_){}}).catch(function(){saleAudioPrimed=!1}).finally(function(){try{a.pause()}catch(_){}try{a.currentTime=0}catch(_){}try{a.muted=prevMuted}catch(_){}try{a.volume=prevVol}catch(_){}})}catch(_){saleAudioPrimed=!1}try{a.pause()}catch(_){}try{a.currentTime=0}catch(_){}try{a.muted=prevMuted}catch(_){}try{a.volume=prevVol}catch(_){}}function playSaleSound(options={}){const deferOnClick=!1!==options.deferOnClick;if(saleMuted||!saleAudio)return;try{saleAudio.currentTime=0}catch(_){}const p=saleAudio.play();p&&"function"==typeof p.catch&&p.catch(function(){deferOnClick&&(saleSoundDeferredOnce||saleSoundDeferredHandler||(saleSoundDeferredOnce=!0,saleSoundDeferredHandler=function(){if(["pointerdown","touchstart","click","keydown"].forEach(function(evt){try{document.removeEventListener(evt,saleSoundDeferredHandler,!0)}catch(_){}}),saleSoundDeferredHandler=null,saleSoundDeferredOnce=!1,!saleMuted&&saleAudio){try{primeSaleAudio()}catch(_){}try{saleAudio.currentTime=0}catch(_){}saleAudio.play().catch(function(){})}},["pointerdown","touchstart","click","keydown"].forEach(function(evt){try{document.addEventListener(evt,saleSoundDeferredHandler,{once:!0,capture:!0})}catch(_){}})))})}function normalizeSaleToastIdentityPart(v,maxLen=256){if(null==v)return"";const s=String(v).trim();if(!s)return"";const low=s.toLowerCase();return"null"===low||"undefined"===low||"[object object]"===low?"":s.length>maxLen?s.slice(0,maxLen):s}function pushSaleToastIdentityKey(keys,key){const normalized=normalizeSaleToastIdentityPart(key,384).toLowerCase();normalized&&(keys.indexOf(normalized)>=0||keys.push(normalized))}function rememberSaleToastIdentity(keys){if(!Array.isArray(keys)||!keys.length)return;let changed=!1;keys.forEach(function(rawKey){const key=normalizeSaleToastIdentityPart(rawKey,384).toLowerCase();key&&!saleToastSeenKeys.has(key)&&(saleToastSeenKeys.add(key),saleToastSeenOrder.push(key),changed=!0)}),changed&&(saleToastSeenOrder.length>500&&(saleToastSeenOrder=saleToastSeenOrder.slice(-500),saleToastSeenKeys=new Set(saleToastSeenOrder)),function(){try{saleToastSeenOrder.length>500&&(saleToastSeenOrder=saleToastSeenOrder.slice(-500),saleToastSeenKeys=new Set(saleToastSeenOrder)),localStorage.setItem("kexo:sale-toast-seen:v1",JSON.stringify(saleToastSeenOrder))}catch(_){}}())}function buildSaleToastIdentityKeys(opts){const inOpts=opts&&"object"==typeof opts?opts:{},keys=[],explicit=normalizeSaleToastIdentityPart(inOpts.toastDedupeKey,256);explicit&&pushSaleToastIdentityKey(keys,"toast:"+explicit);const soundKey=normalizeSaleToastIdentityPart(inOpts.soundDedupeKey,256);soundKey&&pushSaleToastIdentityKey(keys,"sound:"+soundKey);const session=inOpts.session&&"object"==typeof inOpts.session?inOpts.session:null;if(session){const orderId=normalizeSaleToastIdentityPart(null!=session.order_id?session.order_id:session.orderId,64),checkoutToken=normalizeSaleToastIdentityPart(null!=session.checkout_token?session.checkout_token:session.checkoutToken,128),clickId=normalizeSaleToastIdentityPart(null!=session.session_id?session.session_id:session.sessionId,128),purchasedAt=null!=session.purchased_at?toMs(session.purchased_at):null!=session.purchasedAt?toMs(session.purchasedAt):null;orderId&&pushSaleToastIdentityKey(keys,"order:"+orderId),checkoutToken&&pushSaleToastIdentityKey(keys,"token:"+checkoutToken),clickId&&pushSaleToastIdentityKey(keys,"click:"+clickId),clickId&&null!=purchasedAt&&pushSaleToastIdentityKey(keys,"click-sale:"+clickId+":"+String(purchasedAt)),null!=purchasedAt&&pushSaleToastIdentityKey(keys,"sale-at:"+String(purchasedAt))}const latestSale=inOpts.latestSale&&"object"==typeof inOpts.latestSale?inOpts.latestSale:inOpts.sale&&"object"==typeof inOpts.sale?inOpts.sale:null;if(latestSale){const orderId=normalizeSaleToastIdentityPart(null!=latestSale.orderId?latestSale.orderId:latestSale.order_id,64),checkoutToken=normalizeSaleToastIdentityPart(null!=latestSale.checkoutToken?latestSale.checkoutToken:latestSale.checkout_token,128),clickId=normalizeSaleToastIdentityPart(null!=latestSale.sessionId?latestSale.sessionId:latestSale.session_id,128),createdAt=null!=latestSale.createdAt?toMs(latestSale.createdAt):null!=latestSale.created_at?toMs(latestSale.created_at):null;orderId&&pushSaleToastIdentityKey(keys,"order:"+orderId),checkoutToken&&pushSaleToastIdentityKey(keys,"token:"+checkoutToken),clickId&&pushSaleToastIdentityKey(keys,"click:"+clickId),null!=createdAt&&pushSaleToastIdentityKey(keys,"sale-at:"+String(createdAt))}const payload=inOpts.payload&&"object"==typeof inOpts.payload?inOpts.payload:null;if(payload){const createdAt=null!=payload.createdAt?toMs(payload.createdAt):null!=payload.created_at?toMs(payload.created_at):null;null!=createdAt&&pushSaleToastIdentityKey(keys,"sale-at:"+String(createdAt))}return keys}function buildSaleSoundDedupeKey(opts){const inOpts=opts&&"object"==typeof opts?opts:{},explicit=null!=inOpts.soundDedupeKey?String(inOpts.soundDedupeKey).trim():"";if(explicit)return explicit;const session=inOpts.session&&"object"==typeof inOpts.session?inOpts.session:null;if(session){const orderId=null!=session.order_id?String(session.order_id).trim():null!=session.orderId?String(session.orderId).trim():"";if(orderId)return"order:"+orderId;const sid=null!=session.session_id?String(session.session_id).trim():"",purchasedAt=null!=session.purchased_at?toMs(session.purchased_at):null;if(sid&&null!=purchasedAt)return"session-sale:"+sid+":"+String(purchasedAt);if(sid)return"session:"+sid;if(null!=purchasedAt)return"purchased:"+String(purchasedAt)}const payload=inOpts.payload&&"object"==typeof inOpts.payload?inOpts.payload:null;if(payload&&null!=payload.createdAt){const createdAt=toMs(payload.createdAt);if(null!=createdAt)return"payload:"+String(createdAt)}const latest=null!=lastSaleAt?toMs(lastSaleAt):null;return null!=latest?"last-sale:"+String(latest):""}document.getElementById("latest-sales-table")&&(renderLatestSalesTable([]),fetchLatestSales({force:!1})),function(){saleToastSeenKeys=new Set,saleToastSeenOrder=[];try{const raw=localStorage.getItem("kexo:sale-toast-seen:v1");if(!raw)return;const parsed=JSON.parse(raw);if(!Array.isArray(parsed))return;parsed.slice(-500).forEach(function(entry){const key=normalizeSaleToastIdentityPart(entry,384).toLowerCase();key&&!saleToastSeenKeys.has(key)&&(saleToastSeenKeys.add(key),saleToastSeenOrder.push(key))})}catch(_){}}();var btn,SALE_SOUND_CLAIM_PREFIX="kexo:saleSound:claim:v1:",saleSoundTabId=function(){try{var k="kexo:saleSound:tabId",v=sessionStorage.getItem(k);return v&&v.length||(v="tab_"+Date.now()+"_"+Math.random().toString(36).slice(2,12),sessionStorage.setItem(k,v)),v}catch(_){return"tab_"+Date.now()}}();function triggerSaleToast(opts){const session=(opts=opts&&"object"==typeof opts?opts:{}).session||null,playSound=!1!==opts.playSound,payload=opts.payload||null,skipLatest=!!opts.skipLatest,persist=!!opts.persist,allowReplay=!!opts.allowReplay,latestSale=opts.latestSale&&"object"==typeof opts.latestSale?opts.latestSale:null,identityKeys=buildSaleToastIdentityKeys(opts);if(!allowReplay){
// Guardrail: automatic notifications must carry a stable identity, otherwise we risk duplicates.
if(!identityKeys.length)return;if(function(keys){if(!Array.isArray(keys)||!keys.length)return!1;for(let i=0;i<keys.length;i+=1){const key=normalizeSaleToastIdentityPart(keys[i],384).toLowerCase();if(key&&saleToastSeenKeys.has(key))return!0}return!1}(identityKeys))return;rememberSaleToastIdentity(identityKeys)}const toastToken=++saleToastToken;// newest toast wins
if(saleToastLastPayload=null,saleToastSessionId=session&&null!=session.session_id?String(session.session_id):null,saleToastLastOrderId=null,latestSale&&null!=latestSale.orderId&&(saleToastLastOrderId=String(latestSale.orderId)),persist?(saleToastPinned=!0,updateSaleToastToggle()):saleToastPinned&&(saleToastPinned=!1,updateSaleToastToggle()),function(){const banner=document.getElementById("sale-toast-banner");banner&&(saleToastActive=!0,saleToastLastShownAt=Date.now(),banner.removeAttribute("hidden"),banner.setAttribute("aria-hidden","false"),requestAnimationFrame(function(){banner.classList.add("active")}))}(),payload)setSaleToastContent(payload);else
// Fast, best-effort content from the session update (then refined by truth).
try{const cc=session&&session.country_code?String(session.country_code).toUpperCase().slice(0,2):"XX";let productTitle="",productHandle="";session&&session.last_product_handle&&(productHandle=String(session.last_product_handle).trim()),!productHandle&&session&&session.first_product_handle&&(productHandle=String(session.first_product_handle).trim()),productHandle&&(productTitle=titleCaseFromHandle(String(productHandle)));let amountGbp=null;if(session&&null!=session.order_total){const n="number"==typeof session.order_total?session.order_total:parseFloat(String(session.order_total));Number.isFinite(n)&&(amountGbp=n)}setSaleToastContent({countryCode:cc,productTitle:productTitle||"Processing…",amountGbp:amountGbp,productHandle:productHandle||"",createdAt:session&&null!=session.purchased_at?session.purchased_at:session&&null!=session.last_seen?session.last_seen:session&&null!=session.started_at?session.started_at:Date.now()})}catch(_){}if(playSound&&function(opts){const inOpts=opts&&"object"==typeof opts?opts:{},origin=null!=inOpts.origin?String(inOpts.origin).trim().toLowerCase():"";
// Keep manual test/toggle behavior unchanged (always audible).
if("manual"===origin)return!0;const now=Date.now();if("stats"===origin&&"sse"===saleSoundLastOrigin&&saleSoundLastAt>0&&now-saleSoundLastAt<8e3)return!1;const dedupeKey=buildSaleSoundDedupeKey(inOpts);return!(dedupeKey&&saleSoundLastKey===dedupeKey&&saleSoundLastAt>0&&now-saleSoundLastAt<8e3||(dedupeKey&&(saleSoundLastKey=dedupeKey),saleSoundLastOrigin=origin||"unknown",saleSoundLastAt=now,0))}(opts)){const origin=null!=opts.origin?String(opts.origin).trim().toLowerCase():"",dedupeKey=buildSaleSoundDedupeKey(opts);if("manual"===origin){try{primeSaleAudio()}catch(_){}playSaleSound({deferOnClick:!0})}else{try{var claimKey=SALE_SOUND_CLAIM_PREFIX+(dedupeKey&&dedupeKey.length?String(dedupeKey).slice(0,120):"default");localStorage.setItem(claimKey,JSON.stringify({tabId:saleSoundTabId,at:Date.now()}))}catch(_){}setTimeout(function(){try{!function(dedupeKey){try{var key=SALE_SOUND_CLAIM_PREFIX+(dedupeKey&&dedupeKey.length?String(dedupeKey).slice(0,120):"default"),raw=localStorage.getItem(key),claim=null;try{claim=raw?JSON.parse(raw):null}catch(_){}if(!claim||claim.tabId!==saleSoundTabId)return;if(saleMuted||!saleAudio)return;try{primeSaleAudio()}catch(_){}playSaleSound({deferOnClick:!0})}catch(_){}}(dedupeKey)}catch(_){}},65)}}saleToastHideTimer&&clearTimeout(saleToastHideTimer),persist||(saleToastHideTimer=setTimeout(hideSaleToast,1e4)),skipLatest||fetchLatestSaleForToast({forceNew:!0}).then(function(sale){if(!sale)return;if(toastToken!==saleToastToken)return;// stale fetch (a newer sale toast is showing)
if(!saleToastActive)return;if(!allowReplay)try{rememberSaleToastIdentity(buildSaleToastIdentityKeys({latestSale:sale}))}catch(_){}const orderId=null!=sale.orderId?String(sale.orderId):"";orderId&&(saleToastLastOrderId=orderId);const cc=sale.countryCode?String(sale.countryCode).toUpperCase().slice(0,2):"XX",product=sale.productTitle&&String(sale.productTitle).trim()?String(sale.productTitle).trim():"",amount=null!=sale.amountGbp?Number(sale.amountGbp):null,productHandle=null!=sale.productHandle?String(sale.productHandle).trim():"",productThumbUrl=null!=sale.productThumbUrl?String(sale.productThumbUrl).trim():"",createdAt=null!=sale.createdAt?sale.createdAt:null;setSaleToastContent({countryCode:cc||"XX",productTitle:product||(document.getElementById("sale-toast-product")?document.getElementById("sale-toast-product").textContent:"—"),amountGbp:null!=amount&&Number.isFinite(amount)?amount:null,productHandle:productHandle||"",productThumbUrl:productThumbUrl||"",createdAt:createdAt})})}function buildSaleToastPayloadFromSale(sale){if(!sale)return null;const cc=sale.countryCode?String(sale.countryCode).toUpperCase().slice(0,2):"XX",productTitle=sale.productTitle&&String(sale.productTitle).trim()?String(sale.productTitle).trim():"",amount=null!=sale.amountGbp?Number(sale.amountGbp):null;return{countryCode:cc||"XX",productTitle:productTitle,amountGbp:null!=amount&&Number.isFinite(amount)?amount:null,productHandle:null!=sale.productHandle?String(sale.productHandle).trim():"",productThumbUrl:null!=sale.productThumbUrl?String(sale.productThumbUrl).trim():"",createdAt:null!=sale.createdAt?sale.createdAt:null}}function getShopParam(){var shop=new URLSearchParams(window.location.search).get("shop")||"";return shop&&/\.myshopify\.com$/i.test(shop)?shop:null}function fetchBestSellers(options={}){const force=!!options.force;var shop=getShopParam()||shopForSalesFallback||null;if(!shop)return bestSellersCache=null,renderBestSellers(null),Promise.resolve(null);var pageSize=getTableRowsPerPage("best-sellers-table","product");let url="/api/shopify-best-sellers?shop="+encodeURIComponent(shop)+"&range="+encodeURIComponent(getStatsRange())+"&page="+encodeURIComponent(String(bestSellersPage||1))+"&pageSize="+encodeURIComponent(String(pageSize))+"&sort="+encodeURIComponent(String(bestSellersSortBy||"rev"))+"&dir="+encodeURIComponent(String(bestSellersSortDir||"desc"));force&&(url+="&_="+Date.now());var chartEl=document.getElementById("products-chart");return chartEl&&(chartEl.innerHTML='<div class="kexo-overview-chart-empty is-loading"><span class="kpi-mini-spinner" aria-hidden="true"></span><span>Loading…</span></div>'),fetchWithTimeout(url,{credentials:"same-origin",cache:force?"no-store":"default"},3e4).then(function(r){return r.json().then(function(data){return{ok:r.ok,status:r.status,data:data||{}}}).catch(function(){return{ok:r.ok,status:r.status,data:{}}})}).then(function(result){if(result.ok)return bestSellersCache=result.data,renderProductsChart(result.data),renderBestSellers(result.data),result.data;var msg=result.data&&result.data.error?result.data.error:"Error "+result.status;return result.data&&result.data.hint&&(msg+=". "+result.data.hint),bestSellersCache=null,renderBestSellers(null,msg),null}).catch(function(){return bestSellersCache=null,renderBestSellers(null),null})}function normalizeProductsLeaderboardView(v){return"type"===(null!=v?String(v).trim().toLowerCase():"")?"type":"title"}function updateProductsLeaderboardDropdownUi(){const view=normalizeProductsLeaderboardView(productsLeaderboardView),labelEl=document.getElementById("products-leaderboard-label"),grid=document.getElementById("leaderboard-cards-grid"),wrap=document.getElementById("leaderboard-cards-wrap"),menu=document.getElementById("products-leaderboard-menu");if(labelEl&&(labelEl.textContent=function(view){return"type"===normalizeProductsLeaderboardView(view)?"Product Type":"Product Title"}(view)),grid&&grid.setAttribute("data-leaderboard-view",view),wrap&&wrap.setAttribute("data-leaderboard-view",view),menu){menu.querySelectorAll(".aov-cards-title-option").forEach(function(el){const v=normalizeProductsLeaderboardView(el&&el.getAttribute?el.getAttribute("data-view"):"");el.setAttribute("aria-current",v===view?"true":"false")})}}function closeProductsLeaderboardMenu(){const btn=document.getElementById("products-leaderboard-btn"),menu=document.getElementById("products-leaderboard-menu");btn&&btn.setAttribute("aria-expanded","false"),menu&&(menu.classList.remove("open"),menu.setAttribute("aria-hidden","true"))}function normalizeProductsVariantCardsView(v){const s=null!=v?String(v).trim().toLowerCase():"";return"lengths"===s||"length"===s?"lengths":"finishes"}function updateProductsVariantCardsDropdownUi(){const view=normalizeProductsVariantCardsView(productsVariantCardsView),labelEl=document.getElementById("products-variant-cards-label"),grid=document.getElementById("finishes-cards-grid"),wrap=document.getElementById("finishes-cards-wrap"),menu=document.getElementById("products-variant-cards-menu");if(labelEl&&(labelEl.textContent=function(view){return"lengths"===normalizeProductsVariantCardsView(view)?"Variant Length":"Variant Finish"}(view)),grid&&grid.setAttribute("data-cards-view",view),wrap&&wrap.setAttribute("data-cards-view",view),menu){menu.querySelectorAll(".aov-cards-title-option").forEach(function(el){const v=normalizeProductsVariantCardsView(el&&el.getAttribute?el.getAttribute("data-view"):"");el.setAttribute("aria-current",v===view?"true":"false")})}}function closeProductsVariantCardsMenu(){const btn=document.getElementById("products-variant-cards-btn"),menu=document.getElementById("products-variant-cards-menu");btn&&btn.setAttribute("aria-expanded","false"),menu&&(menu.classList.remove("open"),menu.setAttribute("aria-hidden","true"))}function fetchProductsLeaderboard(options={}){const force=!!options.force;var shop=getShopParam()||shopForSalesFallback||null;if(!shop)return leaderboardLoading=!1,leaderboardCache=null,renderProductsLeaderboard(null),Promise.resolve(null);leaderboardLoading=!0,leaderboardCache||renderProductsLeaderboard(null);let url="/api/shopify-leaderboard?shop="+encodeURIComponent(shop)+"&topProducts="+encodeURIComponent(String(20))+"&topTypes="+encodeURIComponent(String(20))+"&range="+encodeURIComponent(getStatsRange());return force&&(url+="&_="+Date.now()),fetchWithTimeout(url,{credentials:"same-origin",cache:force?"no-store":"default"},3e4).then(function(r){return r.ok?r.json():null}).then(function(data){return leaderboardCache=data,leaderboardLoading=!1,renderProductsLeaderboard(data),renderAllTypeTables(data),data}).catch(function(){return leaderboardCache=null,leaderboardLoading=!1,renderProductsLeaderboard(null),renderAllTypeTables(null),null}).finally(function(){leaderboardLoading=!1})}function productsLeaderboardIsMobile(){return!(!window.matchMedia||!window.matchMedia("(max-width: 768px)").matches)}function productsLeaderboardColumnsForView(view){const v=normalizeProductsLeaderboardView(view),isMobile=productsLeaderboardIsMobile(),isMedium=!isMobile&&!(!window.matchMedia||!window.matchMedia("(max-width: 980px)").matches);return"type"===v?isMobile?1:isMedium?2:4:
// v === 'title'
isMobile?2:isMedium?4:6}function sliceProductsLeaderboardEven(list,view){const arr=Array.isArray(list)?list:[],cols=productsLeaderboardColumnsForView(view),max=productsLeaderboardIsMobile()?4:12,target=Math.min(arr.length,max);if(target<=0)return[];if(cols<=1||target<cols)return arr.slice(0,target);const even=target-target%cols;return arr.slice(0,even||target)}function renderProductsLeaderboard(data){const view=normalizeProductsLeaderboardView(productsLeaderboardView),grid=document.getElementById("leaderboard-cards-grid");if(!grid)return;grid.setAttribute("data-leaderboard-view",view);const hasData=!(!data||!data.ok),listAll=hasData?"type"===view?data.byType||[]:data.byTitle||[]:[],list=sliceProductsLeaderboardEven(listAll,view);if(!hasData||!listAll.length)return void(grid.innerHTML=leaderboardLoading?'<div class="aov-card aov-card-empty aov-card--leaderboard-loading"><span class="inline-spinner" aria-hidden="true"></span><span>Building leaderboards...</span></div>':'<div class="aov-card aov-card-empty">No data</div>');if("type"===view)return void(grid.innerHTML=list.map(function(row){const label=row&&(row.label||row.key)?String(row.label||row.key):"Unknown",rev=row&&null!=row.revenueGbp?Number(row.revenueGbp):0,value=formatMoneyCompact(Number.isFinite(rev)?rev:0,"GBP")||"£0",cr=crPillHtml(row&&row.cr);return'<div class="aov-card aov-card--leaderboard aov-card--leaderboard-type"><div class="aov-card-left"><span class="aov-card-name leaderboard-type-name">'+escapeHtml(label||"Unknown")+'</span></div><div class="aov-card-value"><span class="aov-card-value-main">'+escapeHtml(value)+"</span>"+cr+"</div></div>"}).join(""));
// view === 'title'
const mainBase=getMainBaseUrl();grid.innerHTML=list.map(function(row){const title=row&&null!=row.title?String(row.title):"Product",handle=row&&row.handle?String(row.handle):"",productId=row&&row.product_id?String(row.product_id).replace(/^gid:\/\/shopify\/Product\//i,"").trim():"",thumb=row&&row.thumb_url?String(row.thumb_url):"",rev=row&&null!=row.revenueGbp?Number(row.revenueGbp):0,value=formatMoneyCompact(Number.isFinite(rev)?rev:0,"GBP")||"£0",cr=crPillHtml(row&&row.cr),productUrl=mainBase&&handle?mainBase+"/products/"+encodeURIComponent(handle):"#",canOpen=handle||productId&&/^\d+$/.test(productId),thumbInner='<span class="thumb-wrap">'+(thumb?'<img class="landing-thumb" src="'+escapeHtml(hotImgSquare(thumb)||thumb)+'" alt="" loading="lazy" onerror="this.remove()">':"")+"</span>";return'<div class="aov-card aov-card--leaderboard aov-card--leaderboard-title"><div class="aov-card-left">'+(canOpen?'<a class="leaderboard-thumb-link js-product-modal-link" href="'+escapeHtml(productUrl)+'" target="_blank" rel="noopener" aria-label="Open product: '+escapeHtml(title||"Product")+'"'+(handle?' data-product-handle="'+escapeHtml(handle)+'"':"")+(productId&&/^\d+$/.test(productId)?' data-product-id="'+escapeHtml(productId)+'"':"")+(title?' data-product-title="'+escapeHtml(title)+'"':"")+(thumb?' data-product-thumb="'+escapeHtml(thumb)+'"':"")+">"+thumbInner+"</a>":thumbInner)+'<span class="aov-card-name sr-only">'+escapeHtml(title||"Product")+'</span></div><div class="aov-card-value"><span class="aov-card-value-main">'+escapeHtml(value)+"</span>"+cr+"</div></div>"}).join("")}
// ?????? Product Type Tables (Necklaces, Bracelets, Earrings, Sets, Charms, Extras) ??????
function setHiddenById(id,hidden){var el=document.getElementById(id);el&&el.classList.toggle("is-hidden",!!hidden)}!function(){function handleToggle(e){e&&"function"==typeof e.preventDefault&&e.preventDefault(),saleToastPinned?(saleToastPinned=!1,updateSaleToastToggle(),hideSaleToast()):function(persist){const keep=!!persist,cached=saleToastLastPayload;
// Show banner immediately (no wait for API), then refresh when fetch completes.
triggerSaleToast({origin:"manual",payload:cached&&(cached.productTitle||null!=cached.amountGbp||cached.productHandle||cached.productThumbUrl)?cached:{countryCode:"XX",productTitle:"Loading…",amountGbp:null,productHandle:"",productThumbUrl:"",createdAt:null},playSound:!0,skipLatest:!0,persist:keep,allowReplay:!0}),fetchLatestSaleForToast({forceNew:!0}).then(function(sale){const next=buildSaleToastPayloadFromSale(sale);next&&saleToastActive&&setSaleToastContent(next)})}(!0)}function primeOnPointerDown(){try{primeSaleAudio()}catch(_){}}["last-sale-toggle","footer-last-sale-toggle"].forEach(function(id){var btn=document.getElementById(id);btn&&(btn.addEventListener("click",handleToggle),btn.addEventListener("pointerdown",primeOnPointerDown,{capture:!0}),btn.addEventListener("touchstart",primeOnPointerDown,{capture:!0}))}),updateSaleToastToggle()}(),(btn=document.getElementById("sale-toast-close"))&&btn.addEventListener("click",function(e){e&&e.preventDefault(),saleToastPinned=!1,updateSaleToastToggle(),hideSaleToast()}),function(){updateProductsLeaderboardDropdownUi();const btn=document.getElementById("products-leaderboard-btn"),menu=document.getElementById("products-leaderboard-menu"),root=document.getElementById("products-leaderboard-dropdown");btn&&menu&&root&&(btn.addEventListener("click",function(e){e.preventDefault(),e.stopPropagation(),function(){const btn=document.getElementById("products-leaderboard-btn"),menu=document.getElementById("products-leaderboard-menu");if(!btn||!menu)return;"true"===btn.getAttribute("aria-expanded")?closeProductsLeaderboardMenu():(btn.setAttribute("aria-expanded","true"),menu.classList.add("open"),menu.setAttribute("aria-hidden","false"))}()}),menu.addEventListener("click",function(e){const t=e&&e.target?e.target:null,opt=t&&t.closest?t.closest(".aov-cards-title-option"):null;opt&&(e.preventDefault(),e.stopPropagation(),function(nextView,options={}){const force=!(!options||!options.force),view=normalizeProductsLeaderboardView(nextView);productsLeaderboardView=view;try{sessionStorage.setItem("products-leaderboard-view",view)}catch(_){}updateProductsLeaderboardDropdownUi(),closeProductsLeaderboardMenu(),renderProductsLeaderboard(leaderboardCache),"breakdown"!==activeMainTab&&"products"!==activeMainTab||fetchProductsLeaderboard({force:force}).catch(function(){})}(opt.getAttribute("data-view")||"",{force:!1}))}),document.addEventListener("click",function(e){const target=e&&e.target?e.target:null;target&&root.contains&&root.contains(target)||closeProductsLeaderboardMenu()}),document.addEventListener("keydown",function(e){e&&"Escape"===e.key&&closeProductsLeaderboardMenu()}))}(),function(){updateProductsVariantCardsDropdownUi();const btn=document.getElementById("products-variant-cards-btn"),menu=document.getElementById("products-variant-cards-menu"),root=document.getElementById("products-variant-cards-dropdown");btn&&menu&&root&&(btn.addEventListener("click",function(e){e.preventDefault(),e.stopPropagation(),function(){const btn=document.getElementById("products-variant-cards-btn"),menu=document.getElementById("products-variant-cards-menu");if(!btn||!menu)return;"true"===btn.getAttribute("aria-expanded")?closeProductsVariantCardsMenu():(btn.setAttribute("aria-expanded","true"),menu.classList.add("open"),menu.setAttribute("aria-hidden","false"))}()}),menu.addEventListener("click",function(e){const t=e&&e.target?e.target:null,opt=t&&t.closest?t.closest(".aov-cards-title-option"):null;opt&&(e.preventDefault(),e.stopPropagation(),function(nextView,options={}){const force=!(!options||!options.force),view=normalizeProductsVariantCardsView(nextView);productsVariantCardsView=view;try{sessionStorage.setItem("products-variant-cards-view",view)}catch(_){}updateProductsVariantCardsDropdownUi(),closeProductsVariantCardsMenu(),"breakdown"!==activeMainTab&&"products"!==activeMainTab||("lengths"===view?(lengthsCache&&renderLengths(lengthsCache),fetchLengths({force:force}).catch(function(){})):(finishesCache&&renderFinishes(finishesCache),fetchFinishes({force:force}).catch(function(){})))}(opt.getAttribute("data-view")||"",{force:!1}))}),document.addEventListener("click",function(e){const target=e&&e.target?e.target:null;target&&root.contains&&root.contains(target)||closeProductsVariantCardsMenu()}),document.addEventListener("keydown",function(e){e&&"Escape"===e.key&&closeProductsVariantCardsMenu()}))}();var TYPE_TABLE_DEFS=[{id:"necklaces",keys:["necklaces","necklace"]},{id:"bracelets",keys:["bracelets","bracelet"]},{id:"earrings",keys:["earrings","earring"]},{id:"sets",keys:["jewellery sets","jewellery set","jewelry sets","jewelry set","sets","set"]},{id:"charms",keys:["charms","charm"]},{id:"extras",keys:["extras","extra"]}];var typeTablePages={};function renderTypeTable(data,def){var tbody=document.getElementById("type-"+def.id+"-body");if(!tbody)return;for(var rows=function(data,def){if(!data||!data.productsByType)return[];for(var out=[],i=0;i<def.keys.length;i++){var arr=data.productsByType[def.keys[i]];Array.isArray(arr)&&(out=out.concat(arr))}return out}(data,def),sessionsTotal=0,i=0;i<rows.length;i++)sessionsTotal+=Number(rows[i]&&rows[i].sessions)||0;var hideCard=!leaderboardLoading&&sessionsTotal<=0;if(setHiddenById("stats-type-"+def.id,hideCard),hideCard)return tbody.innerHTML="",void updateCardPagination("type-"+def.id,1,1);if(!rows.length)return tbody.innerHTML='<div class="grid-row" role="row"><div class="grid-cell empty span-all" role="cell">'+(leaderboardLoading?"Loading…":"No data")+"</div></div>",void updateCardPagination("type-"+def.id,1,1);var pageSize=function(def){return getTableRowsPerPage(def&&def.id?"type-"+def.id+"-table":"","product")}(def),totalPages=Math.max(1,Math.ceil(rows.length/pageSize)),page=clampPage(typeTablePages[def.id]||1,totalPages);typeTablePages[def.id]=page,updateCardPagination("type-"+def.id,page,totalPages);var start=(page-1)*pageSize,pageRows=rows.slice(start,start+pageSize);const mainBase=getMainBaseUrl();tbody.innerHTML=pageRows.map(function(r){var title=r&&r.title?String(r.title):"—",orders=r&&null!=r.orders?Number(r.orders):0,sessions=r&&null!=r.sessions?Number(r.sessions):0,revNum=r&&null!=r.revenueGbp?Number(r.revenueGbp):null;Number.isFinite(revNum)||(revNum=null);var rev=null!=revNum?formatRevenueTableHtml(revNum):"—",cr=r&&null!=r.cr?pct(r.cr):"—",vpvNum=null!=revNum&&sessions>0?revNum/sessions:null,vpv=null!=vpvNum&&Number.isFinite(vpvNum)?formatRevenue(vpvNum):"—",handle=r&&r.handle?String(r.handle):"",productId=r&&r.product_id?String(r.product_id).replace(/^gid:\/\/shopify\/Product\//i,"").trim():"",productUrl=mainBase&&handle?mainBase+"/products/"+encodeURIComponent(handle):"#",nameInner=handle||productId&&/^\d+$/.test(productId)?'<a class="kexo-product-link js-product-modal-link" href="'+escapeHtml(productUrl)+'" target="_blank" rel="noopener"'+(handle?' data-product-handle="'+escapeHtml(handle)+'"':"")+(productId&&/^\d+$/.test(productId)?' data-product-id="'+escapeHtml(productId)+'"':"")+(title?' data-product-title="'+escapeHtml(title)+'"':"")+">"+escapeHtml(title)+"</a>":escapeHtml(title);return'<div class="grid-row" role="row"><div class="grid-cell bs-product-col" role="cell"><div class="product-cell">'+('<span class="bs-name" title="'+escapeHtml(title)+'">'+nameInner+"</span>")+'</div></div><div class="grid-cell" role="cell">'+formatSessions(sessions)+'</div><div class="grid-cell" role="cell">'+formatSessions(orders)+'</div><div class="grid-cell" role="cell">'+cr+'</div><div class="grid-cell" role="cell">'+vpv+'</div><div class="grid-cell" role="cell">'+rev+"</div></div>"}).join("")}function renderAllTypeTables(data){TYPE_TABLE_DEFS.forEach(function(def){renderTypeTable(data,def)});
// If every type table is hidden (0 sessions), hide the whole row.
try{var rowWrap=document.getElementById("products-type-tables-row");if(rowWrap){for(var anyVisible=!1,i=0;i<TYPE_TABLE_DEFS.length;i++){if(id=TYPE_TABLE_DEFS[i]&&TYPE_TABLE_DEFS[i].id?String(TYPE_TABLE_DEFS[i].id):"")if((card=document.getElementById("stats-type-"+id))&&!card.classList.contains("is-hidden")){anyVisible=!0;break}}rowWrap.classList.toggle("is-hidden",!anyVisible)}var note=document.getElementById("products-hidden-tables-note");if(note){var hiddenCount=0;for(i=0;i<TYPE_TABLE_DEFS.length;i++){var id,card;if(id=TYPE_TABLE_DEFS[i]&&TYPE_TABLE_DEFS[i].id?String(TYPE_TABLE_DEFS[i].id):"")(card=document.getElementById("stats-type-"+id))&&card.classList.contains("is-hidden")&&hiddenCount++}note.style.display=hiddenCount>0?"":"none"}}catch(_){}}function fetchFinishes(options={}){const force=!!options.force;var shop=getShopParam()||shopForSalesFallback||null;if(!shop)return finishesLoading=!1,finishesCache=null,"finishes"===normalizeProductsVariantCardsView(productsVariantCardsView)&&renderFinishes(null),Promise.resolve(null);finishesLoading=!0,finishesCache||"finishes"!==normalizeProductsVariantCardsView(productsVariantCardsView)||renderFinishes(null);let url="/api/shopify-finishes?shop="+encodeURIComponent(shop)+"&range="+encodeURIComponent(getStatsRange());return force&&(url+="&_="+Date.now()),fetchWithTimeout(url,{credentials:"same-origin",cache:force?"no-store":"default"},3e4).then(function(r){return r.ok?r.json():null}).then(function(data){return finishesCache=data,"finishes"===normalizeProductsVariantCardsView(productsVariantCardsView)&&renderFinishes(data),data}).catch(function(){return finishesCache=null,finishesLoading=!1,"finishes"===normalizeProductsVariantCardsView(productsVariantCardsView)&&renderFinishes(null),null}).finally(function(){finishesLoading=!1})}function fetchLengths(options={}){const force=!!options.force;var shop=getShopParam()||shopForSalesFallback||null;if(!shop)return lengthsLoading=!1,lengthsCache=null,"lengths"===normalizeProductsVariantCardsView(productsVariantCardsView)&&renderLengths(null),Promise.resolve(null);lengthsLoading=!0,lengthsCache||"lengths"!==normalizeProductsVariantCardsView(productsVariantCardsView)||renderLengths(null);let url="/api/shopify-lengths?shop="+encodeURIComponent(shop)+"&range="+encodeURIComponent(getStatsRange());return force&&(url+="&_="+Date.now()),fetchWithTimeout(url,{credentials:"same-origin",cache:force?"no-store":"default"},3e4).then(function(r){return r.ok?r.json():null}).then(function(data){return lengthsCache=data,"lengths"===normalizeProductsVariantCardsView(productsVariantCardsView)&&renderLengths(data),data}).catch(function(){return lengthsCache=null,lengthsLoading=!1,"lengths"===normalizeProductsVariantCardsView(productsVariantCardsView)&&renderLengths(null),null}).finally(function(){lengthsLoading=!1})}function fetchBestVariants(options={}){const force=!!options.force;var shop=getShopParam()||shopForSalesFallback||null;if(!shop)return bestVariantsCache=null,renderBestVariants(null),Promise.resolve(null);var pageSize=getTableRowsPerPage("best-variants-table","product");let url="/api/shopify-best-variants?shop="+encodeURIComponent(shop)+"&range="+encodeURIComponent(getStatsRange())+"&page="+encodeURIComponent(String(bestVariantsPage||1))+"&pageSize="+encodeURIComponent(String(pageSize));return force&&(url+="&_="+Date.now()),fetchWithTimeout(url,{credentials:"same-origin",cache:force?"no-store":"default"},3e4).then(function(r){return r.json().then(function(data){return{ok:r.ok,status:r.status,data:data||{}}}).catch(function(){return{ok:r.ok,status:r.status,data:{}}})}).then(function(result){if(result.ok)return bestVariantsCache=result.data,renderBestVariants(result.data),result.data;var msg=result.data&&result.data.error?result.data.error:"Error "+result.status;return result.data&&result.data.hint&&(msg+=". "+result.data.hint),bestVariantsCache=null,renderBestVariants(null,msg),null}).catch(function(){return bestVariantsCache=null,renderBestVariants(null),null})}function renderBestVariants(data,errorMessage){const tbody=document.getElementById("best-variants-body");if(!tbody)return;if(!data||!Array.isArray(data.bestVariants))return setHiddenById("stats-best-variants",!1),tbody.innerHTML='<div class="grid-row" role="row"><div class="grid-cell empty span-all" role="cell">'+(errorMessage?escapeHtml(errorMessage):"No shop or no data")+"</div></div>",updateSortHeadersInContainer(document.getElementById("best-variants-table"),tableSortState.bestVariants.by,tableSortState.bestVariants.dir),void updateCardPagination("best-variants",1,1);const rows=data.bestVariants.slice();for(var hasSessions=!1,i=0;i<rows.length;i++)if((Number(rows[i]&&rows[i].clicks)||0)>0){hasSessions=!0;break}if(setHiddenById("stats-best-variants",!hasSessions),!hasSessions)return tbody.innerHTML="",void updateCardPagination("best-variants",1,1);const bvBy=(tableSortState.bestVariants.by||"rev").toString().trim().toLowerCase(),bvDir="asc"===(tableSortState.bestVariants.dir||"desc").toString().trim().toLowerCase()?"asc":"desc";function displayVariantName(v){const variantName=v&&v.variant_title&&String(v.variant_title).trim()?String(v.variant_title).trim():"Default",productName=v&&v.title&&String(v.title).trim()?String(v.title).trim():"";return variantName+(productName?" — "+productName:"")}rows.sort(function(a,b){var primary=0;function vpvFromRow(r){if(r&&"number"==typeof r.vpv&&Number.isFinite(r.vpv))return r.vpv;var rev=r&&"number"==typeof r.revenue?r.revenue:null,sess=!r||"number"!=typeof r.clicks&&"number"!=typeof r.sessions?null:null!=r.clicks?r.clicks:r.sessions;return null!=sess&&sess>0&&null!=rev?rev/sess:null}return"variant"===bvBy?primary=cmpNullableText(displayVariantName(a),displayVariantName(b),bvDir):"sales"===bvBy?primary=cmpNullableNumber(a&&a.orders,b&&b.orders,bvDir):"clicks"===bvBy?primary=cmpNullableNumber(a&&a.clicks,b&&b.clicks,bvDir):"rev"===bvBy?primary=cmpNullableNumber(a&&a.revenue,b&&b.revenue,bvDir):"vpv"===bvBy?primary=cmpNullableNumber(vpvFromRow(a),vpvFromRow(b),bvDir):"cr"===bvBy&&(primary=cmpNullableNumber(a&&a.cr,b&&b.cr,bvDir)||cmpNullableNumber(a&&a.orders,b&&b.orders,"desc")),primary||cmpNullableNumber(a&&a.revenue,b&&b.revenue,"desc")||cmpNullableNumber(a&&a.orders,b&&b.orders,"desc")||cmpNullableText(displayVariantName(a),displayVariantName(b),"asc")});const pageSize=data&&"number"==typeof data.pageSize&&data.pageSize>0?data.pageSize:getTableRowsPerPage("best-variants-table","product"),totalCount=data&&"number"==typeof data.totalCount&&data.totalCount>=0?data.totalCount:rows.length,totalPages=Math.max(1,Math.ceil(totalCount/pageSize));if(bestVariantsPage=clampPage(data&&"number"==typeof data.page?data.page:bestVariantsPage,totalPages),updateCardPagination("best-variants",bestVariantsPage,totalPages),0===rows.length)return tbody.innerHTML='<div class="grid-row" role="row"><div class="grid-cell empty span-all" role="cell">No orders in this range</div></div>',void updateSortHeadersInContainer(document.getElementById("best-variants-table"),bvBy,bvDir);tbody.innerHTML=rows.map(function(v){const mainBase=getMainBaseUrl(),handle=v&&v.handle?String(v.handle).trim().toLowerCase():"",productId=v&&v.product_id?String(v.product_id).replace(/^gid:\/\/shopify\/Product\//i,"").trim():"",productUrl=mainBase&&handle?mainBase+"/products/"+encodeURIComponent(String(handle)):"#",title=v&&v.title?String(v.title).trim():"",nameText=displayVariantName(v),nameInner=handle||productId&&/^\d+$/.test(productId)?'<a class="kexo-product-link js-product-modal-link" href="'+escapeHtml(productUrl)+'" target="_blank" rel="noopener"'+(handle?' data-product-handle="'+escapeHtml(handle)+'"':"")+(productId&&/^\d+$/.test(productId)?' data-product-id="'+escapeHtml(productId)+'"':"")+(title?' data-product-title="'+escapeHtml(title)+'"':"")+">"+escapeHtml(nameText)+"</a>":escapeHtml(nameText),name='<span class="bs-name" title="'+escapeHtml(nameText)+'">'+nameInner+"</span>",ordersNum=v&&"number"==typeof v.orders?v.orders:v&&null!=v.orders?Number(v.orders):0,orders=formatSessions(Number(ordersNum)||0),clicks=v&&"number"==typeof v.clicks?formatSessions(v.clicks):"—",revenue=formatRevenueTableHtml(v&&null!=v.revenue?v.revenue:null),crVal=v&&"number"==typeof v.cr?v.cr:null,cr=null!=crVal?pct(crVal):"—",vpvNum=v&&"number"==typeof v.vpv&&Number.isFinite(v.vpv)?v.vpv:v&&v.clicks>0&&null!=v.revenue?v.revenue/v.clicks:null;return'<div class="grid-row" role="row"><div class="grid-cell bs-product-col" role="cell"><div class="product-cell">'+name+'</div></div><div class="grid-cell" role="cell">'+clicks+'</div><div class="grid-cell" role="cell">'+orders+'</div><div class="grid-cell" role="cell">'+cr+'</div><div class="grid-cell" role="cell">'+(null!=vpvNum?formatRevenue(vpvNum):"—")+'</div><div class="grid-cell" role="cell">'+revenue+"</div></div>"}).join(""),updateSortHeadersInContainer(document.getElementById("best-variants-table"),bvBy,bvDir)}function normalizeChartType(value,fallback){const v=String(null==value?"":value).trim().toLowerCase();return"multi-line-labels"===v?"line":"donut"===v?"pie":"radialbar"===v||"radial-bar"===v?"radialbar":"area"===v||"bar"===v||"line"===v||"pie"===v?v:normalizeChartType(fallback,"area")}
// Chart-type switchers were removed theme-wide; keep this helper as a
// compatibility shim so existing render paths can still pick defaults.
TYPE_TABLE_DEFS.forEach(function(d){typeTablePages[d.id]=1}),TYPE_TABLE_DEFS.forEach(function(def){var wrap=document.getElementById("type-"+def.id+"-pagination");wrap&&wrap.addEventListener("click",function(e){var link=e.target.closest("a[data-page]");if(link&&(e.preventDefault(),!link.closest(".page-item.disabled")&&!link.closest(".page-item.active"))){var pg=parseInt(link.dataset.page,10);!pg||pg<1||(typeTablePages[def.id]=pg,renderTypeTable(leaderboardCache,def))}})}),function(){let raf=null;
// Throttle hot resize handlers to reduce repeated layout work.
function schedule(){"products"===activeMainTab&&(leaderboardCache||leaderboardLoading)&&("function"==typeof requestAnimationFrame?(raf&&cancelAnimationFrame(raf),raf=requestAnimationFrame(function(){raf=null,"products"===activeMainTab&&renderProductsLeaderboard(leaderboardCache)})):renderProductsLeaderboard(leaderboardCache))}try{var onResize=kexoThrottle(schedule,120);window.addEventListener("resize",onResize,{passive:!0});try{kexoRegisterCleanup(function(){try{window.removeEventListener("resize",onResize)}catch(_){}try{onResize&&onResize.cancel&&onResize.cancel()}catch(_){}})}catch(_){}}catch(_){}}();let productsChartInstance=null,productsChartData=null;function renderProductsChart(data){const el=document.getElementById("products-chart");if(!el)return;if("undefined"==typeof ApexCharts){
// Avoid an unbounded retry loop if the CDN is blocked (adblock/network).
const tries=(el.__kexoApexWaitTries||0)+1;return el.__kexoApexWaitTries=tries,tries>=25?(el.__kexoApexWaitTries=0,captureChartMessage("Chart library failed to load.","productsChartLibraryLoad",{chartKey:"products-chart",tries:tries},"error"),void(el.innerHTML='<div class="kexo-chart-empty kexo-chart-empty--h280">Chart library failed to load.</div>')):void setTimeout(function(){renderProductsChart(data)},200)}try{el.__kexoApexWaitTries=0}catch(_){}var chartKey="products-chart";if(!isChartEnabledByUiConfig(chartKey,!0)){if(productsChartInstance){try{productsChartInstance.destroy()}catch(_){}productsChartInstance=null}return void(el.innerHTML="")}productsChartInstance&&(productsChartInstance.destroy(),productsChartInstance=null),data&&(productsChartData=data);var d=productsChartData;if(!d||!Array.isArray(d.bestSellers)||0===d.bestSellers.length)return void(el.innerHTML='<div class="kexo-chart-empty kexo-chart-empty--h280">No product data available</div>');const products=d.bestSellers.slice().sort(function(a,b){return(b.revenue||0)-(a.revenue||0)}).slice(0,10);if(!products.length)return void(el.innerHTML='<div class="kexo-chart-empty kexo-chart-empty--h280">No product data available</div>');const mainBase=getMainBaseUrl(),chartRows=products.map(function(p){const handle=p&&null!=p.handle?String(p.handle).trim():"",productUrl=mainBase&&handle?mainBase+"/products/"+encodeURIComponent(handle):"",srcRaw=p&&p.thumb_url?hotImgSquare(String(p.thumb_url))||String(p.thumb_url):"",ogThumb=productUrl?"/api/og-thumb?url="+encodeURIComponent(productUrl)+"&width=100":"",thumb=function(url,width){const raw=null!=url?String(url).trim():"";if(!raw)return"";const targetWidth=Math.max(32,Number(width)||100);if(/^data:/i.test(raw))return raw;if(/[?&]width=\d+/i.test(raw))return raw;try{const u=new URL(raw,window.location.origin);return u.searchParams.has("width")||u.searchParams.set("width",String(targetWidth)),u.toString()}catch(_){const joiner=-1===raw.indexOf("?")?"?":"&";return raw+joiner+"width="+targetWidth}}(srcRaw||ogThumb||"",100),title=(p&&null!=p.title?String(p.title).trim():"")||"Unknown Product";return{title:title,titleShort:title.length>38?title.slice(0,35)+"...":title,revenue:Number(p&&p.revenue||0),thumb:thumb,productUrl:productUrl}}),chartHeight=Math.max(280,30*chartRows.length);var thumbsHtml=chartRows.map(function(row){var thumb=row.thumb?'<img src="'+escapeHtml(row.thumb)+'" alt="" class="products-chart-thumb-img" loading="lazy">':'<span class="products-chart-thumb-placeholder"></span>';return'<div class="products-chart-thumb" title="'+escapeHtml(row.title)+'">'+thumb+"</div>"}).join("");el.innerHTML='<div class="products-chart-plot" id="products-chart-plot"></div><div class="products-chart-thumbs" id="products-chart-thumbs" aria-label="Product thumbnails">'+thumbsHtml+"</div>";const plotEl=document.getElementById("products-chart-plot");if(!plotEl)return;const categories=chartRows.map(function(row){return row.titleShort});var rawMode=chartModeFromUiConfig(chartKey,"line")||"line",showEndLabels="multi-line-labels"===rawMode,mode="multi-line-labels"===rawMode?"line":rawMode,palette=chartColorsFromUiConfig(chartKey,["#3eb3ab"]);if("pie"!==mode){var chartType=normalizeChartType(mode,"line");try{var productsOpts={chart:{type:chartType,height:chartHeight,fontFamily:"Inter, sans-serif",toolbar:{show:!1}},series:[{name:"Revenue",data:chartRows.map(function(row){return row.revenue})}],colors:palette,stroke:{show:!0,width:"bar"===chartType?0:3,curve:"smooth",lineCap:"round"},markers:{size:"line"===chartType?4:0,hover:{size:6}},fill:"bar"===chartType?{type:"solid",opacity:1}:{type:"gradient",gradient:{opacityFrom:.38,opacityTo:.08,stops:[0,100]}},plotOptions:"bar"===chartType?{bar:{columnWidth:"56%",borderRadius:3}}:{},dataLabels:showEndLabels&&"line"===chartType?{enabled:!0,formatter:function(val,ctx){try{var dp=ctx&&null!=ctx.dataPointIndex?Number(ctx.dataPointIndex):-1,w=ctx&&ctx.w?ctx.w:null;if(dp!==(w&&w.globals&&Array.isArray(w.globals.labels)?w.globals.labels.length-1:-1))return""}catch(_){return""}return formatRevenue(Number(val))||"—"},style:{fontSize:"10px"},background:{enabled:!0,borderRadius:4,padding:3,opacity:.85},offsetY:-3}:{enabled:!1},xaxis:{categories:categories,labels:{style:{fontSize:"11px"},rotate:-18,trim:!0,hideOverlappingLabels:!0,formatter:function(){return""}}},yaxis:{min:0,forceNiceScale:!0,labels:{style:{fontSize:"11px"},formatter:function(value){return formatRevenue(Number(value))||"—"}}},tooltip:{custom:function(ctx){var idx=ctx&&null!=ctx.dataPointIndex?Number(ctx.dataPointIndex):-1,row=idx>=0&&idx<chartRows.length?chartRows[idx]:null;return row?'<div class="kexo-apex-tooltip-card"><div class="kexo-apex-tooltip-head">'+(row.thumb?'<img src="'+escapeHtml(row.thumb)+'" alt="" class="kexo-apex-tooltip-thumb">':"")+'<div class="kexo-apex-tooltip-title">'+escapeHtml(row.title)+'</div></div><div class="kexo-apex-tooltip-meta">Revenue: <strong class="kexo-apex-tooltip-strong">'+escapeHtml(formatRevenue(row.revenue)||"—")+"</strong></div></div>":""}},grid:{borderColor:"#eef2f6",strokeDashArray:3,padding:{left:4,right:8,top:8,bottom:8}}};try{var productsOverride=chartAdvancedOverrideFromUiConfig(chartKey,chartType);productsOverride&&isPlainObject(productsOverride)&&(productsOpts=deepMergeOptions(productsOpts,productsOverride))}catch(_){}productsChartInstance=new ApexCharts(plotEl,productsOpts);var productsRender=productsChartInstance.render();productsRender&&"function"==typeof productsRender.then&&productsRender.catch(function(err){captureChartError(err,"productsChartRender",{chartKey:"products-chart",mode:chartType})})}catch(err){captureChartError(err,"productsChartRender",{chartKey:"products-chart",mode:chartType}),el.innerHTML='<div class="kexo-chart-empty kexo-chart-empty--h280 kexo-chart-empty--error">Chart rendering failed</div>'}}else try{var productsPieOpts={chart:{type:"pie",height:Math.max(300,chartHeight),fontFamily:"Inter, sans-serif",toolbar:{show:!1}},series:chartRows.map(function(row){return row.revenue}),labels:categories,colors:palette,dataLabels:{enabled:!0,formatter:function(pct){return"number"==typeof pct&&isFinite(pct)?pct.toFixed(0)+"%":""}},tooltip:{custom:function(ctx){var idx=ctx&&null!=ctx.dataPointIndex?Number(ctx.dataPointIndex):-1,row=idx>=0&&idx<chartRows.length?chartRows[idx]:null;return row?'<div class="kexo-apex-tooltip-card"><div class="kexo-apex-tooltip-head">'+(row.thumb?'<img src="'+escapeHtml(row.thumb)+'" alt="" class="kexo-apex-tooltip-thumb">':"")+'<div class="kexo-apex-tooltip-title">'+escapeHtml(row.title)+'</div></div><div class="kexo-apex-tooltip-meta">Revenue: <strong class="kexo-apex-tooltip-strong">'+escapeHtml(formatRevenue(row.revenue)||"—")+"</strong></div></div>":""}},legend:{position:"bottom",fontSize:"12px"}};try{var productsPieOverride=chartAdvancedOverrideFromUiConfig(chartKey,"pie");productsPieOverride&&isPlainObject(productsPieOverride)&&(productsPieOpts=deepMergeOptions(productsPieOpts,productsPieOverride))}catch(_){}productsChartInstance=new ApexCharts(plotEl,productsPieOpts);var pieRender=productsChartInstance.render();pieRender&&"function"==typeof pieRender.then&&pieRender.catch(function(err){captureChartError(err,"productsChartRender",{chartKey:"products-chart",mode:"pie"})})}catch(err){captureChartError(err,"productsChartRender",{chartKey:"products-chart",mode:"pie"}),el.innerHTML='<div class="kexo-chart-empty kexo-chart-empty--h280 kexo-chart-empty--error">Chart rendering failed</div>'}}function renderBestSellers(data,errorMessage){const tbody=document.getElementById("best-sellers-body");if(!tbody)return;if(!data||!Array.isArray(data.bestSellers))return setHiddenById("stats-best-sellers",!1),tbody.innerHTML='<div class="grid-row" role="row"><div class="grid-cell empty span-all" role="cell">'+(errorMessage?escapeHtml(errorMessage):"No shop or no data")+"</div></div>",updateBestSellersSortHeaders(),void updateCardPagination("best-sellers",1,1);const rows=data.bestSellers.slice();for(var hasSessions=!1,i=0;i<rows.length;i++)if((Number(rows[i]&&rows[i].clicks)||0)>0){hasSessions=!0;break}if(setHiddenById("stats-best-sellers",!hasSessions),!hasSessions)return tbody.innerHTML="",void updateCardPagination("best-sellers",1,1);const sortKey=(bestSellersSortBy||"rev").toString().trim().toLowerCase(),sortDir="asc"===(bestSellersSortDir||"desc").toString().trim().toLowerCase()?"asc":"desc";function vpvFromRow(r){if(r&&"number"==typeof r.vpv&&Number.isFinite(r.vpv))return r.vpv;var rev=r&&"number"==typeof r.revenue?r.revenue:null,sess=!r||"number"!=typeof r.clicks&&"number"!=typeof r.sessions?null:null!=r.clicks?r.clicks:r.sessions;return null!=sess&&sess>0&&null!=rev?rev/sess:null}rows.sort(function(a,b){return"title"===sortKey?cmpNullableText(a&&a.title,b&&b.title,sortDir):"orders"===sortKey?cmpNullableNumber(a&&a.orders,b&&b.orders,sortDir):"clicks"===sortKey?cmpNullableNumber(a&&a.clicks,b&&b.clicks,sortDir):"rev"===sortKey?cmpNullableNumber(a&&a.revenue,b&&b.revenue,sortDir):"vpv"===sortKey?cmpNullableNumber(vpvFromRow(a),vpvFromRow(b),sortDir):"cr"===sortKey?cmpNullableNumber(a&&a.cr,b&&b.cr,sortDir)||cmpNullableNumber(a&&a.orders,b&&b.orders,"desc"):0});const pageSize=data&&"number"==typeof data.pageSize&&data.pageSize>0?data.pageSize:getTableRowsPerPage("best-sellers-table","product"),totalCount=data&&"number"==typeof data.totalCount&&data.totalCount>=0?data.totalCount:rows.length,totalPages=Math.max(1,Math.ceil(totalCount/pageSize));if(bestSellersPage=clampPage(data&&"number"==typeof data.page?data.page:bestSellersPage,totalPages),updateCardPagination("best-sellers",bestSellersPage,totalPages),0===rows.length)return tbody.innerHTML='<div class="grid-row" role="row"><div class="grid-cell empty span-all" role="cell">No orders in this range</div></div>',void updateBestSellersSortHeaders();tbody.innerHTML=rows.map(function(p){const mainBase=getMainBaseUrl(),handle=p&&p.handle?String(p.handle).trim().toLowerCase():"",productId=p&&p.product_id?String(p.product_id).replace(/^gid:\/\/shopify\/Product\//i,"").trim():"",productUrl=mainBase&&handle?mainBase+"/products/"+encodeURIComponent(String(handle)):"#",title=p&&p.title?String(p.title).trim():"",nameInner=handle||productId&&/^\d+$/.test(productId)?'<a class="kexo-product-link js-product-modal-link" href="'+escapeHtml(productUrl)+'" target="_blank" rel="noopener"'+(handle?' data-product-handle="'+escapeHtml(handle)+'"':"")+(productId&&/^\d+$/.test(productId)?' data-product-id="'+escapeHtml(productId)+'"':"")+(title?' data-product-title="'+escapeHtml(title)+'"':"")+">"+escapeHtml(title)+"</a>":escapeHtml(title),name='<span class="bs-name" title="'+escapeHtml(title)+'">'+nameInner+"</span>",orders=String(null!=p.orders?p.orders:0),clicks="number"==typeof p.clicks?formatSessions(p.clicks):"—",revenue=formatRevenueTableHtml(p.revenue),cr=null!=p.cr?pct(p.cr):"—",vpvNum=vpvFromRow(p);return'<div class="grid-row" role="row"><div class="grid-cell bs-product-col" role="cell"><div class="product-cell">'+name+'</div></div><div class="grid-cell" role="cell">'+clicks+'</div><div class="grid-cell" role="cell">'+orders+'</div><div class="grid-cell" role="cell">'+cr+'</div><div class="grid-cell" role="cell">'+(null!=vpvNum?formatRevenue(vpvNum):"—")+'</div><div class="grid-cell" role="cell">'+revenue+"</div></div>"}).join(""),updateBestSellersSortHeaders()}function updateBestSellersSortHeaders(){document.querySelectorAll("#best-sellers-wrap .grid-cell.sortable").forEach(function(th){var col=th.getAttribute("data-sort");th.classList.remove("th-sort-asc","th-sort-desc"),th.setAttribute("aria-sort",bestSellersSortBy===col?"asc"===bestSellersSortDir?"ascending":"descending":"none"),bestSellersSortBy===col&&th.classList.add("asc"===bestSellersSortDir?"th-sort-asc":"th-sort-desc")})}function asSortText(v){return null==v?"":String(v).trim().toLowerCase()}function asFiniteNumber(v){const n="number"==typeof v?v:Number(v);return Number.isFinite(n)?n:null}function cmpNullableText(a,b,dir){const da=asSortText(a),db=asSortText(b);return da||db?da?db?da===db?0:"asc"===("asc"===dir?"asc":"desc")?da<db?-1:1:da<db?1:-1:-1:1:0}function cmpNullableNumber(a,b,dir){const na=asFiniteNumber(a),nb=asFiniteNumber(b);return null==na&&null==nb?0:null==na?1:null==nb?-1:na===nb?0:"asc"===("asc"===dir?"asc":"desc")?na-nb:nb-na}function updateSortHeadersInContainer(container,sortBy,sortDir){const root="string"==typeof container?document.querySelector(container):container;root&&root.querySelectorAll(".grid-cell.sortable").forEach(function(th){var col=(th.getAttribute("data-sort")||"").trim();th.classList.remove("th-sort-asc","th-sort-desc"),th.setAttribute("aria-sort",sortBy===col?"asc"===sortDir?"ascending":"descending":"none"),sortBy===col&&th.classList.add("asc"===sortDir?"th-sort-asc":"th-sort-desc")})}function setupTableSortHeaders(container,state,defaults,onChange){const root="string"==typeof container?document.querySelector(container):container;root&&state&&(root.querySelectorAll(".grid-cell.sortable").forEach(function(th){function activate(){var col=(th.getAttribute("data-sort")||"").trim();if(col){var prevCol=state.by;state.by===col?state.dir="asc"===state.dir?"desc":"asc":(state.by=col,state.dir=defaults&&defaults[col]?defaults[col]:"asc"),state.dir="asc"===state.dir?"asc":"desc",updateSortHeadersInContainer(root,state.by,state.dir),"function"==typeof onChange&&onChange({by:state.by,dir:state.dir,columnChanged:prevCol!==state.by})}}th.addEventListener("click",function(e){e&&"function"==typeof e.preventDefault&&e.preventDefault(),shouldIgnoreStickyResizeSortClick(e)||activate()}),th.addEventListener("keydown",function(e){!e||"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),activate())})}),state.dir="asc"===state.dir?"asc":"desc",updateSortHeadersInContainer(root,state.by,state.dir))}function formatSessions(n){return null==n||"number"!=typeof n?"—":n.toLocaleString()}function clampPage(p,totalPages){const n="number"==typeof p?p:parseInt(String(p),10);return Number.isFinite(n)?Math.min(Math.max(1,n),Math.max(1,totalPages||1)):1}function buildPaginationHtml(page,totalPages){var p=Math.max(1,page),tp=Math.max(1,totalPages),h='<ul class="pagination m-0">';h+='<li class="page-item'+(p<=1?" disabled":"")+'"><a class="page-link" href="#" data-page="'+(p-1)+'" tabindex="-1" aria-label="Previous"><i class="fa-light fa-chevron-left" data-icon-key="pagination-prev"></i></a></li>';
// Build page numbers with ellipsis
var pages=[];if(tp<=7)for(var i=1;i<=tp;i++)pages.push(i);else{pages.push(1),p>3&&pages.push("...");var start=Math.max(2,p-1),end=Math.min(tp-1,p+1);p<=3&&(start=2,end=4),p>=tp-2&&(start=tp-3,end=tp-1);for(i=start;i<=end;i++)pages.push(i);p<tp-2&&pages.push("..."),pages.push(tp)}for(var j=0;j<pages.length;j++){var pg=pages[j];h+="..."===pg?'<li class="page-item disabled"><span class="page-link">...</span></li>':'<li class="page-item'+(pg===p?" active":"")+'"><a class="page-link" href="#" data-page="'+pg+'">'+pg+"</a></li>"}return h+='<li class="page-item'+(p>=tp?" disabled":"")+'"><a class="page-link" href="#" data-page="'+(p+1)+'" aria-label="Next"><i class="fa-light fa-chevron-right" data-icon-key="pagination-next"></i></a></li>',h+="</ul>"}try{window.__kexoBuildPaginationHtml=buildPaginationHtml}catch(_){}function updateCardPagination(prefix,page,totalPages){var wrap=document.getElementById(prefix+"-pagination");if(wrap){var pages=Math.max(1,totalPages||1),show=pages>1;wrap.dataset.paginated=show?"1":"0",wrap.dataset.pages=String(pages),wrap.dataset.page=String(page),wrap.classList.toggle("is-hidden",!show),show&&(wrap.innerHTML=buildPaginationHtml(page,pages))}}function renderSales(data){const sales=data.sales||{},salesTodayEl=document.getElementById("sales-today"),range=getStatsRange(),baseSales=null!=sales[range]?sales[range]:0;salesTodayEl&&(salesTodayEl.textContent=formatRevenue(baseSales));const salesYesterdayEl=document.getElementById("sales-yesterday");salesYesterdayEl&&(salesYesterdayEl.textContent=formatRevenue(sales.yesterday))}var breakdownAovPage=1;function renderAov(data){const rows=(data.country||{})[getStatsRange()]||[],tbody=document.getElementById("breakdown-aov-body");if(!tbody)return;const filtered=rows.filter(r=>r&&(null!=r.revenue||null!=r.aov||null!=r.conversion));if(0===filtered.length)return tbody.innerHTML='<div class="grid-row" role="row"><div class="grid-cell empty span-all" role="cell">No data</div></div>',void updateCardPagination("breakdown-aov",1,1);const list=filtered.slice();list.sort(function(a,b){return cmpNullableNumber(a&&a.revenue,b&&b.revenue,"desc")||cmpNullableNumber(a&&a.aov,b&&b.aov,"desc")||cmpNullableNumber(a&&a.conversion,b&&b.conversion,"desc")});var totalPages=Math.max(1,Math.ceil(list.length/10));updateCardPagination("breakdown-aov",breakdownAovPage=clampPage(breakdownAovPage,totalPages),totalPages);var start=10*(breakdownAovPage-1),pageRows=list.slice(start,start+10);tbody.innerHTML=pageRows.map(r=>{const iso=(r.country_code||"XX").toUpperCase().slice(0,2),label=countryLabelFull(iso),flag=flagImg(iso,label),revenue=r&&null!=r.revenue?formatRevenueTableHtml(r.revenue):"—",aov=r&&null!=r.aov?formatRevenueTableHtml(r.aov):"—",cr=r&&null!=r.conversion?pct(r.conversion):"—";return'<div class="grid-row" role="row"><div class="grid-cell" role="cell"><span class="country-cell">'+flag+'<span class="country-label"><span class="country-name">'+escapeHtml(label)+'</span></span></span></div><div class="grid-cell" role="cell">'+revenue+'</div><div class="grid-cell" role="cell">'+aov+'</div><div class="grid-cell" role="cell">'+cr+"</div></div>"}).join("")}function renderFinishes(data){const grid=document.getElementById("finishes-cards-grid");if(!grid)return;const rows=data&&Array.isArray(data.finishes)?data.finishes:[];if(0===rows.length){const msg=finishesLoading?"Loading finishes…":"No data";return void(grid.innerHTML='<div class="aov-card aov-card-empty">'+escapeHtml(msg)+"</div>")}const ordered=rows.slice(),orderIndex={gold:0,silver:1,vermeil:2,solid_silver:3,"solid-silver":3};ordered.sort(function(a,b){const primary=cmpNullableNumber(a&&a.revenueGbp,b&&b.revenueGbp,"desc");if(primary)return primary;const ak=a&&null!=a.key?String(a.key):"",bk=b&&null!=b.key?String(b.key):"";return(Object.prototype.hasOwnProperty.call(orderIndex,ak)?orderIndex[ak]:99)-(Object.prototype.hasOwnProperty.call(orderIndex,bk)?orderIndex[bk]:99)}),grid.innerHTML=ordered.map(function(r){const label=r&&null!=r.label?String(r.label):"",revenue=r&&null!=r.revenueGbp?Number(r.revenueGbp):null,value=null!=revenue&&Number.isFinite(revenue)?formatRevenueTableHtml(revenue):"—",cr=crPillHtml(r&&r.cr);return'<div class="aov-card"><div class="aov-card-left">'+function(key){const k=(key||"").toString().trim().toLowerCase();return"gold"===k?'<span class="finish-icon finish-icon-gold" aria-hidden="true"></span>':"silver"===k?'<span class="finish-icon finish-icon-silver" aria-hidden="true"></span>':"vermeil"===k?'<span class="finish-icon finish-icon-vermeil" aria-hidden="true"></span>':"solid_silver"===k||"solid-silver"===k?'<span class="finish-icon finish-icon-solid-silver" aria-hidden="true"></span>':'<span class="finish-icon" aria-hidden="true"></span>'}(r&&r.key)+'<span class="aov-card-name">'+escapeHtml(label||"—")+'</span></div><div class="aov-card-value"><span class="aov-card-value-main">'+value+"</span>"+cr+"</div></div>"}).join("")}function renderLengths(data){const grid=document.getElementById("finishes-cards-grid");if(!grid)return;const rows=data&&Array.isArray(data.lengths)?data.lengths:[];if(0===rows.length){const msg=lengthsLoading?"Loading lengths…":"No data";return void(grid.innerHTML='<div class="aov-card aov-card-empty">'+escapeHtml(msg)+"</div>")}const ordered=rows.slice();ordered.sort(function(a,b){return cmpNullableNumber(a&&a.revenueGbp,b&&b.revenueGbp,"desc")||cmpNullableNumber(a&&a.inches,b&&b.inches,"asc")}),grid.innerHTML=ordered.map(function(r){const inches=r&&null!=r.inches?Number(r.inches):null,label=r&&null!=r.label?String(r.label):null!=inches&&Number.isFinite(inches)?String(inches)+'"':"",revenue=r&&null!=r.revenueGbp?Number(r.revenueGbp):null,value=null!=revenue&&Number.isFinite(revenue)?formatRevenueTableHtml(revenue):"—",cr=crPillHtml(r&&r.cr);return'<div class="aov-card aov-card--length"><div class="aov-card-left">'+('<span class="length-icon" aria-hidden="true"><span class="length-icon-text">'+escapeHtml(label||"—")+"</span></span>")+('<span class="aov-card-name sr-only">'+escapeHtml((label||"—")+" Inches")+"</span>")+'</div><div class="aov-card-value"><span class="aov-card-value-main">'+value+"</span>"+cr+"</div></div>"}).join("")}var breakdownTitlePage=1;var breakdownFinishPage=1;var breakdownLengthPage=1;var breakdownChainStylePage=1;function renderCountry(data){const rows=(data.country||{})[getStatsRange()]||[],tbody=document.getElementById("by-country-body");if(!tbody)return;if(0===rows.length)return tbody.innerHTML='<div class="grid-row" role="row"><div class="grid-cell empty span-all" role="cell">No data</div></div>',updateSortHeadersInContainer(document.getElementById("country-table"),tableSortState.country.by,tableSortState.country.dir),void updateCardPagination("country",1,1);const list=rows.slice(),countryBy=(tableSortState.country.by||"rev").toString().trim().toLowerCase(),countryDir="asc"===(tableSortState.country.dir||"desc").toString().trim().toLowerCase()?"asc":"desc";function labelFor(r){return countryLabel((r&&null!=r.country_code?String(r.country_code):"XX").toUpperCase().slice(0,2))}function countryVpv(r){var rev=r&&"number"==typeof r.revenue?r.revenue:null,tot=r&&"number"==typeof r.total?r.total:null;return null!=tot&&tot>0&&null!=rev?rev/tot:null}list.sort(function(a,b){return"country"===countryBy?cmpNullableText(labelFor(a),labelFor(b),countryDir):"vpv"===countryBy?cmpNullableNumber(countryVpv(a),countryVpv(b),countryDir)||cmpNullableText(labelFor(a),labelFor(b),"asc"):"cr"===countryBy?cmpNullableNumber(a&&a.conversion,b&&b.conversion,countryDir)||cmpNullableText(labelFor(a),labelFor(b),"asc"):"sales"===countryBy?cmpNullableNumber(a&&a.converted,b&&b.converted,countryDir)||cmpNullableText(labelFor(a),labelFor(b),"asc"):"clicks"===countryBy?cmpNullableNumber(a&&a.total,b&&b.total,countryDir)||cmpNullableText(labelFor(a),labelFor(b),"asc"):"rev"===countryBy?cmpNullableNumber(a&&a.revenue,b&&b.revenue,countryDir)||cmpNullableText(labelFor(a),labelFor(b),"asc"):0}),lastCountryRowCount=list.length;var countryPageSize=getTableRowsPerPage("country-table","live"),totalPages=Math.max(1,Math.ceil(list.length/countryPageSize));countryPage=clampPage(countryPage,totalPages),updateCardPagination("country",countryPage,totalPages);var start=(countryPage-1)*countryPageSize,pageRows=list.slice(start,start+countryPageSize);tbody.innerHTML=pageRows.map(r=>{const code=(r.country_code||"XX").toUpperCase().slice(0,2),label=countryLabel(code),conversion=pct(r.conversion),salesCount=null!=r.converted?Number(r.converted):0,clicks=null!=r.total?formatSessions(r.total):"—",revenue=formatRevenueTableHtml(r.revenue),vpvNum=countryVpv(r),vpv=null!=vpvNum?formatRevenue(vpvNum):"—";return'<div class="grid-row" role="row"><div class="grid-cell" role="cell"><span class="country-cell">'+flagImg(code,label)+('<span class="country-label">'+escapeHtml(label)+"</span>")+'</span></div><div class="grid-cell" role="cell">'+clicks+'</div><div class="grid-cell" role="cell">'+salesCount+'</div><div class="grid-cell" role="cell">'+conversion+'</div><div class="grid-cell" role="cell">'+vpv+'</div><div class="grid-cell" role="cell">'+revenue+"</div></div>"}).join(""),updateSortHeadersInContainer(document.getElementById("country-table"),countryBy,countryDir)}
// Countries map chart
let countriesMapChartInstance=null;function clearCountriesFlowOverlay(el){if(el)try{el.querySelectorAll(".kexo-map-flow-overlay, .kexo-live-activity-overlay, .kexo-live-activity-legend, .kexo-countries-pins-overlay, .kexo-countries-map-legend").forEach(function(node){try{node&&node.parentNode&&node.parentNode.removeChild(node)}catch(_){}})}catch(_){}}function clearOverlayBySelector(el,selector){if(el&&selector)try{el.querySelectorAll(selector).forEach(function(node){try{node&&node.parentNode&&node.parentNode.removeChild(node)}catch(_){}})}catch(_){}}function getJvmSvgInContainer(container){return container?container.querySelector(".jvm-container svg")||container.querySelector("svg"):null}function getJvmZoomGroup(mapSvg){if(!mapSvg)return null;var zoom=mapSvg.querySelector("#jvm-zoom-group, .jvm-zoom-group");return zoom||null}function getJvmRegionsGroup(mapSvg){return mapSvg&&mapSvg.querySelector("#jvm-regions-group, .jvm-regions-group")||null}function getJvmOverlayGroup(mapSvg){return getJvmRegionsGroup(mapSvg)||getJvmZoomGroup(mapSvg)||mapSvg}var BASE_PIN_FONT=11;function setupPinsCounterScale(containerEl){if(containerEl){var mapSvg=getJvmSvgInContainer(containerEl);if(mapSvg){var zoomGroup=getJvmZoomGroup(mapSvg),regionsGroup=getJvmRegionsGroup(mapSvg),scaleEl=regionsGroup||zoomGroup;if(scaleEl&&(update(),"undefined"!=typeof MutationObserver))try{var obs=new MutationObserver(update);zoomGroup&&obs.observe(zoomGroup,{attributes:!0,attributeFilter:["transform","style"]}),regionsGroup&&regionsGroup!==zoomGroup&&obs.observe(regionsGroup,{attributes:!0,attributeFilter:["transform","style"]}),containerEl.__kexoPinsScaleObserver&&containerEl.__kexoPinsScaleObserver.disconnect(),containerEl.__kexoPinsScaleObserver=obs}catch(_){}}}function update(){!function(containerEl,scale){if(containerEl&&Number.isFinite(scale)&&!(scale<=0)){var s=scale;try{containerEl.querySelectorAll("[data-base-r]").forEach(function(node){var base=parseFloat(node.getAttribute("data-base-r"),10);Number.isFinite(base)&&node.setAttribute("r",String(base/s))}),containerEl.querySelectorAll("[data-base-font]").forEach(function(node){var base=parseFloat(node.getAttribute("data-base-font"),10);Number.isFinite(base)&&(node.style.fontSize=String(base/s)+"px")})}catch(_){}}}(containerEl,function(){try{var ctm=scaleEl.getCTM&&scaleEl.getCTM();if(ctm)return ctm.a}catch(_){}return 1}())}}function mapRegionCenter(mapSvg,zoomGroup,iso2){if(!mapSvg)return null;var iso=String(iso2||"").trim().toUpperCase();if(!iso)return null;var lowerIso=iso.toLowerCase(),regionsGroup=getJvmRegionsGroup(mapSvg),searchRoot=regionsGroup||mapSvg,selector='[data-code="'+iso+'"], [data-code="'+lowerIso+'"], .jvm-region-'+lowerIso+", .jvm-region-"+iso,node=null;
// Prefer searching in the regions group so we don't accidentally target region labels.
try{node=searchRoot.querySelector(selector)}catch(_){node=null}if(!node&&searchRoot!==mapSvg)try{node=mapSvg.querySelector(selector)}catch(_){node=null}if(!node)return null;function safeBBox(el){try{if(el&&"function"==typeof el.getBBox){var b=el.getBBox();if(b&&Number.isFinite(Number(b.width))&&Number.isFinite(Number(b.height))&&b.width>0&&b.height>0)return b}}catch(_){}return null}
// Use bbox center for most regions, but fall back to a robust path-sampled center when the
// region spans (nearly) the entire map width (e.g., US/RU due to dateline wrap/islands).
var nodeBox=safeBBox(node),mapBox=regionsGroup?safeBBox(regionsGroup):null,mapWidth=mapBox&&Number.isFinite(Number(mapBox.width))?Number(mapBox.width):0,local=null;if(!!(nodeBox&&mapWidth>0&&nodeBox.width>.75*mapWidth)&&(local=function(pathEl){try{if(!pathEl||"function"!=typeof pathEl.getTotalLength||"function"!=typeof pathEl.getPointAtLength)return null;var len=pathEl.getTotalLength();if(!Number.isFinite(len)||len<=0)return null;for(var xs=[],ys=[],i=0;i<64;i++){var t=i/63,p=pathEl.getPointAtLength(len*t);if(p){var x=Number(p.x),y=Number(p.y);Number.isFinite(x)&&Number.isFinite(y)&&(xs.push(x),ys.push(y))}}if(xs.length<8)return null;xs.sort(function(a,b){return a-b}),ys.sort(function(a,b){return a-b});var trim=Math.floor(.18*xs.length),start=trim,end=xs.length-trim;end-start<6&&(start=0,end=xs.length);for(var sumX=0,sumY=0,count=0,j=start;j<end;j++)sumX+=xs[j],sumY+=ys[j],count++;return count?{x:sumX/count,y:sumY/count}:null}catch(_){return null}}(node)),!local&&nodeBox&&(local={x:nodeBox.x+nodeBox.width/2,y:nodeBox.y+nodeBox.height/2}),!local)
// Fallback: screen-space bbox center.
try{var rect=node.getBoundingClientRect();if(!(rect&&rect.width>0&&rect.height>0))return null;var sx=rect.left+rect.width/2,sy=rect.top+rect.height/2,pt0=mapSvg&&"function"==typeof mapSvg.createSVGPoint?mapSvg.createSVGPoint():null;if(!pt0)return null;pt0.x=sx,pt0.y=sy;var sctm0=mapSvg.getScreenCTM&&mapSvg.getScreenCTM();if(!sctm0||"function"!=typeof sctm0.inverse)return null;var svgPt0=pt0.matrixTransform(sctm0.inverse());if(!zoomGroup||!zoomGroup.getCTM)return{x:svgPt0.x,y:svgPt0.y};var zctm0=zoomGroup.getCTM();if(!zctm0||"function"!=typeof zctm0.inverse)return{x:svgPt0.x,y:svgPt0.y};var localPt0=svgPt0.matrixTransform(zctm0.inverse());return{x:localPt0.x,y:localPt0.y}}catch(_){return null}
// Convert the local point into the overlay group's local coordinate system.
try{var pt=mapSvg&&"function"==typeof mapSvg.createSVGPoint?mapSvg.createSVGPoint():null;if(!pt)return local;pt.x=local.x,pt.y=local.y;var nctm=node.getCTM&&node.getCTM(),svgPt=nctm?pt.matrixTransform(nctm):pt;if(!zoomGroup||!zoomGroup.getCTM)return{x:svgPt.x,y:svgPt.y};var zctm=zoomGroup.getCTM();if(!zctm||"function"!=typeof zctm.inverse)return{x:svgPt.x,y:svgPt.y};var localPt=svgPt.matrixTransform(zctm.inverse());return{x:localPt.x,y:localPt.y}}catch(_){return local}}function renderLiveActivityOverlay(el,stageCountsByIso2,totalsByIso2,opts){if(el){!function(el){clearOverlayBySelector(el,".kexo-live-activity-overlay, .kexo-live-activity-legend")}(el),opts=opts||{};try{var sc=opts.stageColors&&"object"==typeof opts.stageColors?opts.stageColors:null;if(sc&&el&&el.style)[["--kexo-map-stage-browse",sc.browse],["--kexo-map-stage-cart",sc.cart],["--kexo-map-stage-checkout",sc.checkout],["--kexo-map-stage-purchase",sc.purchase]].forEach(function(p){var key=p[0],val=null!=p[1]?String(p[1]):"";val?el.style.setProperty(key,val):el.style.removeProperty(key)})}catch(_){}var mapSvg=getJvmSvgInContainer(el);if(mapSvg){var overlayGroup=getJvmOverlayGroup(mapSvg),totals=totalsByIso2&&"object"==typeof totalsByIso2?totalsByIso2:{},stages=stageCountsByIso2&&"object"==typeof stageCountsByIso2?stageCountsByIso2:{},keys=Object.keys(totals).map(function(k){return String(k||"").trim().toUpperCase().slice(0,2)}).filter(Boolean);if(keys.length){var animated=!!opts.animated,topN=Math.max(3,Math.min(12,Number(opts.topN||9)||9)),primaryRgb=String(opts.primaryRgb||"22,163,74").trim()||"22,163,74",ranked=keys.map(function(iso){var n=Number(totals[iso]||0);return{iso:iso,total:Number.isFinite(n)?n:0,stage:dominantStageForIso(iso)}}).filter(function(r){return r.iso&&"XX"!==r.iso&&r.total>0}).sort(function(a,b){return b.total-a.total});if(ranked.length){var originIso=String(opts.originIso2||"").trim().toUpperCase().slice(0,2);"UK"===originIso&&(originIso="GB"),originIso||(originIso=ranked[0].iso||"GB");var origin=mapRegionCenter(mapSvg,overlayGroup,originIso);origin||(origin={x:520,y:240});var NS="http://www.w3.org/2000/svg",overlay=document.createElementNS(NS,"g");overlay.setAttribute("class","kexo-live-activity-overlay");var top=ranked.slice(0,topN),maxTotal=top.reduce(function(m,r){return Math.max(m,r.total||0)},1);top.forEach(function(item,idx){var target=mapRegionCenter(mapSvg,overlayGroup,item.iso);if(target){var stage=function(stage){switch(String(stage||"").toLowerCase()){case"purchase":case"purchased":return"purchase";case"checkout":return"checkout";case"cart":return"cart";default:return"browse"}}(item.stage);if(animated){var midX=(origin.x+target.x)/2,bend=Math.max(18,Math.min(78,.16*Math.abs(target.x-origin.x)+3*idx)),midY=(origin.y+target.y)/2-bend,path=document.createElementNS(NS,"path");path.setAttribute("class","kexo-map-flow-line"),path.setAttribute("d","M "+origin.x+" "+origin.y+" Q "+midX+" "+midY+" "+target.x+" "+target.y),path.setAttribute("stroke","rgba("+primaryRgb+",0.58)"),path.style.animationDelay=String(.18*idx)+"s",overlay.appendChild(path)}var radius=2.5+1.2*Math.min(1,(item.total||0)/maxTotal),marker=document.createElementNS(NS,"circle");marker.setAttribute("class","kexo-live-activity-marker kexo-stage-"+stage),marker.setAttribute("cx",String(target.x)),marker.setAttribute("cy",String(target.y)),marker.setAttribute("r",String(radius.toFixed(2))),marker.setAttribute("data-base-r",String(radius.toFixed(2))),marker.setAttribute("stroke","rgba(255,255,255,0.98)"),marker.setAttribute("stroke-width","2"),marker.setAttribute("vector-effect","non-scaling-stroke"),overlay.appendChild(marker);var label=document.createElementNS(NS,"text");label.setAttribute("class","kexo-live-activity-label"),label.setAttribute("x",String(target.x+7)),label.setAttribute("y",String(target.y-6)),label.setAttribute("data-base-font",String(BASE_PIN_FONT)),label.textContent=countryLabel(item.iso)||item.iso,overlay.appendChild(label)}});
// Origin marker (smaller, solid)
try{var originDot=document.createElementNS(NS,"circle");originDot.setAttribute("class","kexo-map-flow-origin"),originDot.setAttribute("cx",String(origin.x)),originDot.setAttribute("cy",String(origin.y)),originDot.setAttribute("r","3"),originDot.setAttribute("data-base-r","3"),originDot.setAttribute("fill","rgba("+primaryRgb+",0.9)"),overlay.appendChild(originDot)}catch(_){}try{overlayGroup.appendChild(overlay)}catch(_){}setupPinsCounterScale(el);
// Legend (HTML overlay)
try{var stageTotals={browse:0,cart:0,checkout:0,purchase:0};keys.forEach(function(iso){var x=safeStageCounts(iso);stageTotals.browse+=x.browse,stageTotals.cart+=x.cart,stageTotals.checkout+=x.checkout,stageTotals.purchase+=x.purchase});var totalAll=stageTotals.browse+stageTotals.cart+stageTotals.checkout+stageTotals.purchase,legend=document.createElement("div");legend.setAttribute("class","kexo-live-activity-legend"),legend.innerHTML='<div class="kexo-live-activity-legend-title">Live activity (last 5m)</div><div class="kexo-live-activity-legend-row"><span class="kexo-live-activity-swatch swatch-browse"></span><span>Browsing</span><span class="kexo-live-activity-count">'+String(stageTotals.browse||0)+'</span></div><div class="kexo-live-activity-legend-row"><span class="kexo-live-activity-swatch swatch-cart"></span><span>In cart</span><span class="kexo-live-activity-count">'+String(stageTotals.cart||0)+'</span></div><div class="kexo-live-activity-legend-row"><span class="kexo-live-activity-swatch swatch-checkout"></span><span>Checkout</span><span class="kexo-live-activity-count">'+String(stageTotals.checkout||0)+'</span></div><div class="kexo-live-activity-legend-row"><span class="kexo-live-activity-swatch swatch-purchase"></span><span>Purchased</span><span class="kexo-live-activity-count">'+String(stageTotals.purchase||0)+'</span></div><div class="kexo-live-activity-legend-foot">Total: '+String(totalAll||0)+"</div>";try{el.appendChild(legend)}catch(_){}}catch(_){}}}}}function safeStageCounts(iso){var x=stages[iso];return{browse:x&&Number.isFinite(Number(x.browse))?Number(x.browse):0,cart:x&&Number.isFinite(Number(x.cart))?Number(x.cart):0,checkout:x&&Number.isFinite(Number(x.checkout))?Number(x.checkout):0,purchase:x&&Number.isFinite(Number(x.purchase))?Number(x.purchase):0}}function dominantStageForIso(iso){var x=safeStageCounts(iso);return x.purchase>0?"purchase":x.checkout>0?"checkout":x.cart>0?"cart":"browse"}}function setCountriesMapState(el,text,opts){if(el){var message=String(null==text?"":text).trim()||"Unavailable",isError=!(!opts||!opts.error),isLoading=!(!opts||!opts.loading)||!isError&&/loading/i.test(message),h=opts&&Number.isFinite(opts.height)?Math.max(80,opts.height):320;if(isError&&captureChartMessage(message,"countriesMapState",{chartKey:"countries-map-chart"},"error"),isLoading)el.innerHTML='<div class="kexo-overview-chart-empty is-loading" data-kexo-chart-empty="1" style="height:'+String(h)+'px"><span class="kpi-mini-spinner" aria-hidden="true"></span><span>'+escapeHtml(message)+"</span></div>";else{var cls="kexo-chart-empty"+(isError?" kexo-chart-empty--error":"");el.innerHTML='<div class="'+cls+'" data-kexo-chart-empty="1">'+escapeHtml(message)+"</div>";try{var child=el.querySelector('[data-kexo-chart-empty="1"]');child&&child.style&&(child.style.height=String(h)+"px")}catch(_){}}}}var WORLD_MAP_ISO2=["AE","AF","AG","AL","AM","AO","AR","AT","AU","AZ","BA","BB","BD","BE","BF","BG","BI","BJ","BN","BO","BR","BS","BT","BW","BY","BZ","CA","CD","CF","CG","CH","CI","CL","CM","CN","CO","CR","CU","CV","CY","CZ","DE","DJ","DK","DM","DO","DZ","EC","EE","EG","ER","ES","ET","FI","FJ","FK","FR","GA","GB","GD","GE","GF","GH","GL","GM","GN","GQ","GR","GT","GW","GY","HN","HR","HT","HU","ID","IE","IL","IN","IQ","IR","IS","IT","JM","JO","JP","KE","KG","KH","KM","KN","KP","KR","KW","KZ","LA","LB","LC","LK","LR","LS","LT","LV","LY","MA","MD","MG","MK","ML","MM","MN","MR","MT","MU","MV","MW","MX","MY","MZ","NA","NC","NE","NG","NI","NL","NO","NP","NZ","OM","PA","PE","PF","PG","PH","PK","PL","PT","PY","QA","RE","RO","RS","RU","SA","SB","SC","SD","SE","SI","SK","SL","SN","SO","SR","ST","SV","SY","SZ","TD","TG","TH","TJ","TL","TM","TN","TR","TT","TW","TZ","UA","UG","US","UY","UZ","VE","VN","VU","YE","ZA","ZM","ZW"];function buildMapFillScaleByIso(valuesByIso2,primaryRgb,baseAlpha,minAlpha,maxAlpha,defaultRgb,defaultAlpha){for(var src=valuesByIso2&&"object"==typeof valuesByIso2?valuesByIso2:{},entries=[],keys=Object.keys(src),i=0;i<keys.length;i++){var iso=String(keys[i]||"").trim().toUpperCase();if(iso){var n=Number(src[iso]);!Number.isFinite(n)||n<=0||entries.push({iso:iso,value:n})}}var idx,base="number"==typeof baseAlpha&&Number.isFinite(baseAlpha)?Math.max(0,Math.min(1,baseAlpha)):.18,defaultFill="rgba("+(null!=defaultRgb&&String(defaultRgb).trim()?String(defaultRgb).trim():primaryRgb||"62,179,171")+","+("number"==typeof defaultAlpha&&Number.isFinite(defaultAlpha)?Math.max(0,Math.min(1,defaultAlpha)):base)+")",out={};for(idx=0;idx<WORLD_MAP_ISO2.length;idx++)out[WORLD_MAP_ISO2[idx]]=defaultFill;if(entries.length){for(var min=1/0,max=-1/0,j=0;j<entries.length;j++){var v=entries[j].value;v<min&&(min=v),v>max&&(max=v)}var lo="number"==typeof minAlpha&&Number.isFinite(minAlpha)?minAlpha:.24,hi="number"==typeof maxAlpha&&Number.isFinite(maxAlpha)?maxAlpha:.92;if(lo=Math.max(0,Math.min(1,lo)),(hi=Math.max(0,Math.min(1,hi)))<lo){var tmp=hi;hi=lo,lo=tmp}for(var k=0;k<entries.length;k++){var row=entries[k],alpha=hi;if(max>min){var t=(row.value-min)/(max-min);Number.isFinite(t)||(t=0),alpha=lo+(t=Math.max(0,Math.min(1,t)))*(hi-lo)}out[row.iso]="rgba("+(primaryRgb||"62,179,171")+","+alpha+")"}}return out}function hideMapTooltipOnLeave(container){container&&!container.__kexoMapTooltipCleanup&&(container.__kexoMapTooltipCleanup=!0,container.addEventListener("mouseleave",function(){document.querySelectorAll(".jvm-tooltip").forEach(function(t){t.style.display="none"})},{passive:!0}))}function setVectorMapTooltipContent(tooltip,html,text){if(tooltip){var htmlContent=null==html?"":String(html),textContent=null==text?"":String(text);try{if("function"==typeof tooltip.text)return tooltip.text(htmlContent,!0),void unhide(tooltip)}catch(_){}try{if("function"==typeof tooltip.html)return tooltip.html(htmlContent),void unhide(tooltip)}catch(_){}try{if(tooltip.element&&1===tooltip.element.nodeType)return tooltip.element.innerHTML=htmlContent,void unhide(tooltip)}catch(_){}try{if(1===tooltip.nodeType)return tooltip.innerHTML=htmlContent,void unhide(tooltip)}catch(_){}try{"function"==typeof tooltip.setContent&&(tooltip.setContent(htmlContent||textContent),unhide(tooltip))}catch(_){}}function unhide(t){try{var node=t&&t.element&&1===t.element.nodeType?t.element:t&&1===t.nodeType?t:null;node&&node.style&&(node.style.display="",node.style.visibility="visible",node.style.opacity="1")}catch(_){}}}
/**
     * Shared Online map renderer used by #live-online-chart (live/overview) and #countries-map-chart (countries).
     * Renders the same world map into the given container; callers supply tooltip and overlay via opts.
     * @param {string} containerId - Element id (e.g. 'live-online-chart', 'countries-map-chart')
     * @param {string} chartKey - Chart key for UI config (same as containerId for these maps)
     * @param {object} opts - setState(el,text,{height?,error?}), mapHeight, regionFillByIso2, primaryRgb, border, muted, showTooltip, draggable, zoomButtons, focusOn?, onRegionTooltipShow?, afterMapCreated(instance, el)?
     * @returns {object|null} jsVectorMap instance or null
     */function renderOnlineMapInto(containerId,chartKey,opts){opts=opts||{};var el=document.getElementById(containerId);if(!el)return null;var setState="function"==typeof opts.setState?opts.setState:setCountriesMapState,mapHeight=Math.max(80,Number(opts.mapHeight)||220);if("undefined"==typeof jsVectorMap){el.__kexoJvmWaitTries||setState(el,"Loading map library...",{height:mapHeight});var tries=(el.__kexoJvmWaitTries||0)+1;return el.__kexoJvmWaitTries=tries,tries>=25?(el.__kexoJvmWaitTries=0,setState(el,"Map library failed to load.",{error:!0,height:mapHeight}),null):(setTimeout(function(){"function"==typeof opts.retry&&opts.retry()},200),null)}try{el.__kexoJvmWaitTries=0}catch(_){}var rect=el&&el.getBoundingClientRect?el.getBoundingClientRect():null;if(!(rect&&rect.width>20&&rect.height>20)){var sizeTries=(el.__kexoJvmSizeWaitTries||0)+1;return el.__kexoJvmSizeWaitTries=sizeTries,sizeTries<=60?setTimeout(function(){"function"==typeof opts.retry&&opts.retry()},220):el.__kexoJvmSizeWaitTries=0,null}try{el.__kexoJvmSizeWaitTries=0}catch(_){}var primaryRgb=opts.primaryRgb||"62,179,171",border=opts.border||"#d4dee5",zoomMin=Number.isFinite(Number(opts.zoomMin))?Number(opts.zoomMin):1,zoomMax=Number.isFinite(Number(opts.zoomMax))?Number(opts.zoomMax):12,initialZoomMax=Number.isFinite(Number(opts.initialZoomMax))?Number(opts.initialZoomMax):rect&&rect.width&&rect.width<420?1.9:2.8,mapFit="contain",fillOpacity=.18,inactiveOpacity=.09,inactiveRgb=primaryRgb;try{var st=chartStyleFromUiConfig(chartKey)||{};mapFit="cover"===String(st.mapFit||"").trim().toLowerCase()?"cover":"contain",Number.isFinite(Number(st.fillOpacity))&&(fillOpacity=Math.max(0,Math.min(1,Number(st.fillOpacity)))),Number.isFinite(Number(st.mapInactiveOpacity))&&(inactiveOpacity=Math.max(0,Math.min(1,Number(st.mapInactiveOpacity))));var inactiveHex=null!=st.mapInactiveColor?String(st.mapInactiveColor).trim():"",hm=/^#([0-9a-f]{6})$/i.exec(inactiveHex);if(hm){var hh=hm[1];inactiveRgb=parseInt(hh.slice(0,2),16)+","+parseInt(hh.slice(2,4),16)+","+parseInt(hh.slice(4,6),16)}}catch(_){}var alphaMult=fillOpacity>0?fillOpacity/.18:0;function a(x){return Math.max(0,Math.min(1,x*alphaMult))}Number.isFinite(alphaMult)||(alphaMult=1),alphaMult=Math.max(0,Math.min(3,alphaMult));var jvmOpts={selector:"#"+containerId,map:"world",backgroundColor:"transparent",showTooltip:!1!==opts.showTooltip,draggable:!1!==opts.draggable,zoomButtons:!1!==opts.zoomButtons,zoomOnScroll:!1,zoomAnimate:!1,zoomMin:zoomMin,zoomMax:zoomMax,regionStyle:{initial:{fill:"rgba("+inactiveRgb+","+String(inactiveOpacity.toFixed(3))+")",stroke:border,strokeWidth:.7},hover:{fill:"rgba("+primaryRgb+","+String(a(.46).toFixed(3))+")"},selected:{fill:"rgba("+primaryRgb+","+String(a(.78).toFixed(3))+")"}}};opts.onRegionTooltipShow&&(jvmOpts.onRegionTooltipShow=opts.onRegionTooltipShow);var instance=new jsVectorMap(jvmOpts);try{instance&&instance.params&&(instance.params.zoomMin=zoomMin)}catch(_){}
// Fit mode: cover should fill both dimensions (crop edges), even in tall containers.
if(instance&&"cover"===mapFit)try{var w=Number(instance._width),h=Number(instance._height),dw=Number(instance._defaultWidth),dh=Number(instance._defaultHeight);if(Number.isFinite(w)&&Number.isFinite(h)&&Number.isFinite(dw)&&Number.isFinite(dh)&&w>0&&h>0&&dw>0&&dh>0){var coverScale=Math.max(w/dw,h/dh);instance._baseScale=coverScale,instance._baseTransX=Math.abs(w-dw*coverScale)/(2*coverScale),instance._baseTransY=Math.abs(h-dh*coverScale)/(2*coverScale),"function"==typeof instance.reset&&instance.reset()}}catch(_){}
// Apply initial focus after fit, with a temporary zoom clamp.
try{var focusCfg=null;if(opts.focusOn&&"object"==typeof opts.focusOn)focusCfg=opts.focusOn;else if(opts.topRegionIso2){var topIso=String(opts.topRegionIso2).trim().toUpperCase().slice(0,2);topIso&&(focusCfg={region:topIso,animate:!1})}if(focusCfg&&"function"==typeof instance.setFocus&&instance.params){var prevMax=instance.params.zoomMax;instance.params.zoomMax=initialZoomMax,instance.setFocus(focusCfg),instance.params.zoomMax=prevMax}}catch(_){}if(instance&&instance.regions&&opts.regionFillByIso2){var regions=instance.regions;for(var code in opts.regionFillByIso2)if(regions[code]&&regions[code].element&&"function"==typeof regions[code].element.setStyle)try{regions[code].element.setStyle("fill",opts.regionFillByIso2[code])}catch(_){}}return hideMapTooltipOnLeave(el),"function"==typeof opts.afterMapCreated&&opts.afterMapCreated(instance,el),instance}function renderCountriesMapChart(data){const el=document.getElementById("countries-map-chart");if(el){var chartKey="countries-map-chart",meta="function"==typeof window.kexoChartMeta?window.kexoChartMeta(chartKey):null,baseHeight=meta&&Number.isFinite(Number(meta.height))?Number(meta.height):320,pct=chartSizePercentFromUiConfig(chartKey,100),mapHeight=Math.round(baseHeight*(pct/100));if(mapHeight<80&&(mapHeight=80),el.style.height=mapHeight+"px",el.style.minHeight=mapHeight+"px",!isChartEnabledByUiConfig(chartKey,!0)){try{countriesMapChartInstance&&countriesMapChartInstance.destroy()}catch(_){}return countriesMapChartInstance=null,clearCountriesFlowOverlay(el),void setCountriesMapState(el,"Map disabled in Settings > Charts.",{height:mapHeight})}try{countriesMapChartInstance&&countriesMapChartInstance.destroy()}catch(_){}return countriesMapChartInstance=null,clearCountriesFlowOverlay(el),el.innerHTML="",void fetchLiveOnlineMapSessions({force:!1}).then(function(list){try{renderLiveOnlineMapChartFromSessions(Array.isArray(list)?list:[])}catch(_){}}).catch(function(){setCountriesMapState(el,"Could not load live sessions.",{error:!0,height:mapHeight})})}}function renderBestGeoProducts(data){const rows=(data&&data.bestGeoProducts?data.bestGeoProducts:{})[getStatsRange()]||[],tbody=document.getElementById("best-geo-products-body");if(!tbody)return;if(!Array.isArray(rows)||0===rows.length)return tbody.innerHTML='<div class="grid-row" role="row"><div class="grid-cell empty span-all" role="cell">No data</div></div>',updateSortHeadersInContainer(document.getElementById("best-geo-products-table"),tableSortState.bestGeoProducts.by,tableSortState.bestGeoProducts.dir),void updateCardPagination("best-geo-products",1,1);const list=rows.slice(),geoBy=(tableSortState.bestGeoProducts.by||"rev").toString().trim().toLowerCase(),geoDir="asc"===(tableSortState.bestGeoProducts.dir||"desc").toString().trim().toLowerCase()?"asc":"desc";function geoCountryLabel(r){return countryLabel((r&&null!=r.country_code?String(r.country_code):"XX").toUpperCase().slice(0,2))}function geoProductTitle(r){return r&&null!=r.product_title?String(r.product_title).trim():""}function geoVpv(r){var rev=r&&"number"==typeof r.revenue?r.revenue:null,tot=r&&"number"==typeof r.total?r.total:null;return null!=tot&&tot>0&&null!=rev?rev/tot:null}list.sort(function(a,b){return"country"===geoBy?cmpNullableText(geoCountryLabel(a),geoCountryLabel(b),geoDir)||cmpNullableText(geoProductTitle(a),geoProductTitle(b),"asc"):"vpv"===geoBy?cmpNullableNumber(geoVpv(a),geoVpv(b),geoDir)||cmpNullableNumber(a&&a.revenue,b&&b.revenue,"desc"):"cr"===geoBy?cmpNullableNumber(a&&a.conversion,b&&b.conversion,geoDir)||cmpNullableNumber(a&&a.total,b&&b.total,"desc"):"sales"===geoBy?cmpNullableNumber(a&&a.converted,b&&b.converted,geoDir)||cmpNullableNumber(a&&a.revenue,b&&b.revenue,"desc"):"clicks"===geoBy?cmpNullableNumber(a&&a.total,b&&b.total,geoDir)||cmpNullableNumber(a&&a.converted,b&&b.converted,"desc"):"rev"===geoBy?cmpNullableNumber(a&&a.revenue,b&&b.revenue,geoDir)||cmpNullableNumber(a&&a.converted,b&&b.converted,"desc"):0});const geoPageSize=getTableRowsPerPage("best-geo-products-table","live"),totalPages=Math.max(1,Math.ceil(list.length/geoPageSize));bestGeoProductsPage=clampPage(bestGeoProductsPage,totalPages),updateCardPagination("best-geo-products",bestGeoProductsPage,totalPages);const start=(bestGeoProductsPage-1)*geoPageSize,pageRows=list.slice(start,start+geoPageSize);tbody.innerHTML=pageRows.map(r=>{const iso=(r.country_code||"XX").toUpperCase().slice(0,2),label=countryLabel(iso),productTitle=r.product_title&&String(r.product_title).trim()?String(r.product_title).trim():"—",productHandle=r&&null!=r.product_handle?String(r.product_handle).trim():"",productId=r&&r.product_id?String(r.product_id).replace(/^gid:\/\/shopify\/Product\//i,"").trim():"",mainBase=getMainBaseUrl(),productUrl=mainBase&&productHandle?mainBase+"/products/"+encodeURIComponent(productHandle):"#",conversion=pct(r.conversion),salesCount=null!=r.converted?Number(r.converted):0,clicks=null!=r.total?formatSessions(r.total):"—",revenue=formatRevenueTableHtml(r.revenue),vpvNum=r&&r.total>0&&null!=r.revenue?r.revenue/r.total:null,vpv=null!=vpvNum?formatRevenue(vpvNum):"—",flag=flagImg(iso,label),normalizedHandle=productHandle?String(productHandle).trim().toLowerCase():"";return'<div class="grid-row" role="row"><div class="grid-cell" role="cell"><span class="country-cell">'+flag+('<span class="country-product-stack"><span class="country-product-label">'+(normalizedHandle||productId&&/^\d+$/.test(productId)?'<a class="kexo-product-link js-product-modal-link" href="'+escapeHtml(productUrl)+'" target="_blank" rel="noopener"'+(normalizedHandle?' data-product-handle="'+escapeHtml(normalizedHandle)+'"':"")+(productId&&/^\d+$/.test(productId)?' data-product-id="'+escapeHtml(productId)+'"':"")+(productTitle?' data-product-title="'+escapeHtml(productTitle)+'"':"")+">"+escapeHtml(productTitle)+"</a>":escapeHtml(productTitle))+"</span></span>")+'</span></div><div class="grid-cell" role="cell">'+clicks+'</div><div class="grid-cell" role="cell">'+salesCount+'</div><div class="grid-cell" role="cell">'+conversion+'</div><div class="grid-cell" role="cell">'+vpv+'</div><div class="grid-cell" role="cell">'+revenue+"</div></div>"}).join(""),updateSortHeadersInContainer(document.getElementById("best-geo-products-table"),geoBy,geoDir)}function isCustomDayRangeKey(v){return"string"==typeof v&&/^d:\d{4}-\d{2}-\d{2}$/.test(v)}function isCustomRangeKey(v){return"string"==typeof v&&/^r:\d{4}-\d{2}-\d{2}:\d{4}-\d{2}-\d{2}$/.test(v)}function ymdFromDayKey(dayKey){return isCustomDayRangeKey(dayKey)?dayKey.slice(2):null}function ymdRangeFromRangeKey(rangeKey){if(!isCustomRangeKey(rangeKey))return null;const parts=String(rangeKey).split(":");if(3!==parts.length)return null;const a=String(parts[1]||"").trim(),b=String(parts[2]||"").trim();if(!/^\d{4}-\d{2}-\d{2}$/.test(a)||!/^\d{4}-\d{2}-\d{2}$/.test(b))return null;return{startYmd:a<=b?a:b,endYmd:a<=b?b:a}}function appliedYmdRangeFromDateRange(){if(isCustomRangeKey(dateRange))return ymdRangeFromRangeKey(dateRange);if(isCustomDayRangeKey(dateRange)){const ymd=ymdFromDayKey(dateRange);return ymd?{startYmd:ymd,endYmd:ymd}:null}return null}function formatYmdLabel(ymd){if(!ymd||!/^\d{4}-\d{2}-\d{2}$/.test(String(ymd)))return String(ymd||"");const y=parseInt(String(ymd).slice(0,4),10),m=parseInt(String(ymd).slice(5,7),10),d=parseInt(String(ymd).slice(8,10),10);if(!Number.isFinite(y)||!Number.isFinite(m)||!Number.isFinite(d))return String(ymd||"");const dt=new Date(Date.UTC(y,m-1,d,12,0,0));try{return new Intl.DateTimeFormat("en-GB",{weekday:"short",day:"numeric",month:"short"}).format(dt)}catch(_){return String(ymd||"")}}function formatYmdRangeLabel(startYmd,endYmd){if(!startYmd||!endYmd)return"";if(startYmd===endYmd)return formatYmdShort(startYmd);
// Same month? Compact as "5–7 Feb"
if(startYmd.slice(0,7)===endYmd.slice(0,7)){var d1=parseInt(startYmd.slice(8,10),10);parseInt(endYmd.slice(8,10),10);return d1+"–"+formatYmdShort(endYmd)}return formatYmdShort(startYmd)+" – "+formatYmdShort(endYmd)}function formatYmdShort(ymd){if(!ymd||!/^\d{4}-\d{2}-\d{2}$/.test(String(ymd)))return String(ymd||"");var y=parseInt(String(ymd).slice(0,4),10),m=parseInt(String(ymd).slice(5,7),10),d=parseInt(String(ymd).slice(8,10),10);if(!Number.isFinite(y)||!Number.isFinite(m)||!Number.isFinite(d))return String(ymd||"");var dt=new Date(Date.UTC(y,m-1,d,12,0,0));try{return new Intl.DateTimeFormat("en-GB",{day:"numeric",month:"short"}).format(dt)}catch(_){return String(ymd||"")}}function makeRangeKeyFromYmds(startYmd,endYmd){const a=String(startYmd||"").trim(),b=String(endYmd||"").trim();if(!/^\d{4}-\d{2}-\d{2}$/.test(a)||!/^\d{4}-\d{2}-\d{2}$/.test(b))return null;return"r:"+(a<=b?a:b)+":"+(a<=b?b:a)}function updateLiveViewTitle(){const sel=document.getElementById("global-date-select");
// Date page: sync the table card title with the selected range
if("date"===PAGE){const titleEl=document.getElementById("table-title-text");if(titleEl){let label=null;const applied=appliedYmdRangeFromDateRange();if(applied&&applied.startYmd&&applied.endYmd)label=formatYmdRangeLabel(applied.startYmd,applied.endYmd);else if(sel){const opt=sel.querySelector('option[value="'+dateRange+'"]')||sel.options[sel.selectedIndex];label=opt&&opt.textContent?String(opt.textContent).trim():null}const fallback={today:"Today",yesterday:"Yesterday","3d":"Last 3 Days","7d":"Last 7 Days","1h":"Last Hour",custom:"Custom"};titleEl.textContent=label||fallback[dateRange]||"Today"}}}function updateRowsPerPageVisibility(){const wrap=document.getElementById("rows-per-page-wrap");wrap&&wrap.classList.toggle("is-hidden","live"===dateRange)}function syncHeaderDateDisplay(){const sel=document.getElementById("global-date-select"),displayBtn=document.getElementById("kexo-date-display");if(!sel||!displayBtn)return;let label=null;try{const opt=sel.options[sel.selectedIndex];label=opt&&opt.textContent?String(opt.textContent).trim():null}catch(_){}if(!label){label={today:"Today",yesterday:"Yesterday","7days":"Last 7 days","14days":"Last 14 days","30days":"Last 30 days",custom:"Custom"}[String(dateRange||"today")]||"Today"}var lbl=displayBtn.querySelector(".kexo-date-btn-label");lbl?lbl.textContent=label:displayBtn.textContent=label}function syncHeaderDateMenuAvailability(){const sel=document.getElementById("global-date-select"),menu=document.getElementById("kexo-date-menu");if(!sel||!menu)return;
// Mirror visibility/disabled + labels from the <select> options.
try{menu.querySelectorAll("[data-range]").forEach(function(item){const key=String(item.getAttribute("data-range")||"").trim();if(!key)return;const opt=sel.querySelector('option[value="'+key+'"]');if(!opt)return;const hidden=!!opt.hidden,disabled=!!opt.disabled;item.style.display=hidden?"none":"",disabled?item.setAttribute("disabled","disabled"):item.removeAttribute("disabled"),item.classList.toggle("disabled",disabled),item.setAttribute("aria-disabled",disabled?"true":"false"),opt.textContent&&(item.textContent=String(opt.textContent).trim())})}catch(_){}
// Active item highlight: custom ranges map to the "Custom???" item.
let active="";try{active=String(sel.value||"").trim()}catch(_){active=""}const isCustom=isCustomRangeKey(active)||isCustomDayRangeKey(active);menu.querySelectorAll("[data-range]").forEach(function(btn){const v=String(btn.getAttribute("data-range")||"").trim();btn.classList.toggle("active",isCustom?"custom"===v:v===active)})}function mountDesktopDatePickerIntoPageHeader(){try{const sourceLi=document.querySelector(".kexo-desktop-nav .kexo-nav-date-slot");if(document.body){const page=String(document.body.getAttribute("data-page")||""),dateBtn=document.getElementById("kexo-date-display"),dateWrap=dateBtn&&dateBtn.closest?dateBtn.closest(".kexo-topbar-date"):null;if("settings"===page||"snapshot"===page)return;try{sourceLi&&(sourceLi.style.display="")}catch(_){}try{dateWrap&&(dateWrap.style.display="")}catch(_){}}const dateBtn=document.getElementById("kexo-date-display"),dateWrap=dateBtn&&dateBtn.closest?dateBtn.closest(".kexo-topbar-date"):null;if(!dateWrap)return;const headerRow=document.querySelector(".page-header .row.align-items-center")||document.querySelector(".page-header .row");if(!!!headerRow)return sourceLi&&dateWrap.parentElement!==sourceLi&&sourceLi.appendChild(dateWrap),void(sourceLi&&(sourceLi.classList.add("is-date-inline-fallback"),sourceLi.classList.remove("is-date-relocated")));let dateCol=headerRow.querySelector(".kexo-page-header-date-col");dateCol||(dateCol=document.createElement("div"),dateCol.className="col-auto kexo-page-header-date-col",headerRow.appendChild(dateCol)),dateWrap.parentElement!==dateCol&&dateCol.appendChild(dateWrap),sourceLi&&(sourceLi.classList.add("is-date-relocated"),sourceLi.classList.remove("is-date-inline-fallback")),function(headerRow){try{const row=headerRow||document.querySelector(".page-header .row.align-items-center")||document.querySelector(".page-header .row");if(!row)return;const dateCol=row.querySelector(".kexo-page-header-date-col");if(!dateCol)return void row.classList.remove("kexo-page-header-layout-triple");
// Skip headers that have other right-side actions (buttons, etc).
// Only inspect direct children so nested controls inside the date dropdown
// do not accidentally disable the triple layout. Exclude our own leftCol.
let hasOtherAuto=!1;try{hasOtherAuto=!!row.querySelector(":scope > .col-auto:not(.kexo-page-header-date-col):not(.kexo-page-header-left-col)")}catch(_){hasOtherAuto=Array.prototype.slice.call(row.children||[]).some(function(ch){return!(!ch||!ch.classList||!ch.classList.contains("col-auto")||ch.classList.contains("kexo-page-header-date-col")||ch.classList.contains("kexo-page-header-left-col"))})}if(hasOtherAuto)return void row.classList.remove("kexo-page-header-layout-triple");const pretitle=row.querySelector(".page-pretitle"),title=row.querySelector(".page-title");if(!pretitle||!title)return;const legacyPretitleParent=pretitle.parentElement,legacyTitleParent=title.parentElement;let leftCol=row.querySelector(".kexo-page-header-left-col");leftCol||(leftCol=document.createElement("div"),leftCol.className="col-auto kexo-page-header-left-col");let titleCol=row.querySelector(".kexo-page-header-title-col");titleCol||(titleCol=document.createElement("div"),titleCol.className="col kexo-page-header-title-col"),
// Ensure order: left, title, date.
leftCol.parentElement!==row&&row.insertBefore(leftCol,row.firstChild||null),titleCol.parentElement!==row&&row.insertBefore(titleCol,dateCol),dateCol.parentElement===row&&dateCol.nextElementSibling&&row.appendChild(dateCol),pretitle.parentElement!==leftCol&&leftCol.appendChild(pretitle),title.parentElement!==titleCol&&titleCol.appendChild(title);
// Clean up legacy wrapper(s) if we emptied them.
try{[legacyPretitleParent,legacyTitleParent].forEach(function(p){p&&p!==leftCol&&p!==titleCol&&p!==row&&p.children&&0===p.children.length&&p.remove()})}catch(_){}row.classList.add("kexo-page-header-layout-triple")}catch(_){}}(headerRow)}catch(_){}}function syncDateSelectOptions(){const sel=document.getElementById("global-date-select");if(!sel)return;const hasLive=sel.querySelector('option[value="live"]');hasLive&&hasLive.remove();
// Keep the "Custom" option stable, and create a dynamic option for the currently applied custom range.
const customOpt=document.getElementById("date-opt-custom")||sel.querySelector('option[value="custom"]');
// Normalize legacy single-day custom keys into the new range key.
if(customOpt&&(customOpt.textContent="Custom"),
// Remove previous dynamic custom-range option(s).
sel.querySelectorAll('option[data-custom-range="1"]').forEach(function(o){try{o.remove()}catch(_){}}),isCustomDayRangeKey(dateRange)){const ymd=ymdFromDayKey(dateRange),rk=ymd?makeRangeKeyFromYmds(ymd,ymd):null;rk&&(dateRange=rk)}const applied=appliedYmdRangeFromDateRange();if(applied&&applied.startYmd&&applied.endYmd){customRangeStartYmd=applied.startYmd,customRangeEndYmd=applied.endYmd;const label=formatYmdRangeLabel(applied.startYmd,applied.endYmd)||"Selected dates",opt=document.createElement("option");opt.value=String(dateRange),opt.textContent=label,opt.setAttribute("data-custom-range","1"),customOpt&&customOpt.parentNode===sel?sel.insertBefore(opt,customOpt):sel.appendChild(opt),sel.value=String(dateRange)}else"spy"===activeMainTab||"sales"===activeMainTab||"date"===activeMainTab||
// Other tabs only use day/range ranges; if somehow on live, treat as Today.
"live"===dateRange&&(dateRange="today",sessionsTotal=null),
// Table pages: dropdown stays on Today/Yesterday/Custom.
sel.value="live"===dateRange||"sales"===dateRange||"1h"===dateRange?"today":String(dateRange||"today");
// Apply user-configured labels/visibility for the standard date ranges.
try{!function(sel){if(!sel)return;var cfg=kpiUiConfigV1;if(!cfg||1!==cfg.v||!Array.isArray(cfg.dateRanges))return;var byKey={};function labelOf(key,fallback){var it=byKey[key]||null;return(it&&null!=it.label?String(it.label).trim():"")||fallback||""}function enabledOf(key,defaultEnabled){var it=byKey[key]||null;return(!it||!1!==it.enabled)&&!1!==defaultEnabled}function applyOne(key,fallbackLabel,defaultEnabled,preserveExistingDisabledHidden){var opt=sel.querySelector('option[value="'+key+'"]');if(opt){opt.textContent=labelOf(key,fallbackLabel);var enabled=enabledOf(key,defaultEnabled);
// Guardrails: never allow disabling Today/Custom via UI config.
if("today"!==key&&"custom"!==key||(enabled=!0),enabled){if(!preserveExistingDisabledHidden){opt.disabled=!1;try{opt.hidden=!1}catch(_){}}}else{opt.disabled=!0;try{opt.hidden=!0}catch(_){}}}}cfg.dateRanges.forEach(function(it){if(it&&"object"==typeof it){var k=null!=it.key?String(it.key).trim().toLowerCase():"";k&&(byKey[k]=it)}}),applyOne("today","Today",!0,!1),
// For yesterday, keep availability rules from applyRangeAvailable (floor + rangeAvailable)
applyOne("yesterday","Yesterday",!0,!0),applyOne("7days","Last 7 days",!0,!1),applyOne("14days","Last 14 days",!0,!1),applyOne("30days","Last 30 days",!0,!1),applyOne("custom","Custom…",!0,!1)}(sel)}catch(_){}updateLiveViewTitle(),updateRowsPerPageVisibility(),syncHeaderDateDisplay(),syncHeaderDateMenuAvailability()}function applyRangeAvailable(available){const sel=document.getElementById("global-date-select");if(!sel)return;const allowYesterday=function(){try{return ymdNowInTz()>MIN_YMD}catch(_){return!0}}();"yesterday"!==dateRange||allowYesterday||(dateRange="today",customRangeStartYmd=null,customRangeEndYmd=null,syncDateSelectOptions()),["today","yesterday"].forEach(key=>{const o=sel.querySelector('option[value="'+key+'"]');if(!o)return;const ok="yesterday"===key?allowYesterday&&!(!available||!available[key]):!(!available||!available[key]);o.disabled=!ok;try{o.hidden="yesterday"===key&&!allowYesterday}catch(_){}}),"live"===dateRange||isCustomDayRangeKey(dateRange)||isCustomRangeKey(dateRange)||!available||!1!==available[dateRange]||(dateRange="today",customRangeStartYmd=null,customRangeEndYmd=null,syncDateSelectOptions()),updateLiveViewTitle(),updateRowsPerPageVisibility(),syncHeaderDateDisplay(),syncHeaderDateMenuAvailability()}
// Custom date calendar (last 30 days, disabled if no data)
let availableDaysMemo=null,availableDaysMemoAt=0,availableDaysInflight=null;function pad2(n){return String(n).padStart(2,"0")}
// Flatpickr instance for custom date picker
let flatpickrInstance=null,availableDatesSet=new Set,customDateApplyOverride=null,customDatePrefillRangeKey=null;function initFlatpickrDatePicker(payload){const input=document.getElementById("date-range-picker");if(!input)return;
// Destroy existing instance
flatpickrInstance&&(flatpickrInstance.destroy(),flatpickrInstance=null);
// Parse available days from API
const data=payload&&payload.ok?payload:null;data&&Array.isArray(data.days)&&(availableDatesSet=new Set(data.days.filter(function(d){return d&&d.date&&d.hasSessions}).map(function(d){return String(d.date)}))),
// Wait for flatpickr to be available
"undefined"!=typeof flatpickr?(
// Initialize flatpickr
flatpickrInstance=flatpickr(input,{mode:"range",dateFormat:"Y-m-d",maxDate:"today",minDate:"2025-02-01",disable:[function(date){const y=date.getFullYear(),m=date.getMonth()+1,d=date.getDate(),ymd=y+"-"+pad2(m)+"-"+pad2(d);return!availableDatesSet.has(ymd)}],onChange:function(selectedDates){if(0===selectedDates.length)return pendingCustomRangeStartYmd=null,pendingCustomRangeEndYmd=null,void updateCustomDateFooter();if(1===selectedDates.length){const d=selectedDates[0],ymd=d.getFullYear()+"-"+pad2(d.getMonth()+1)+"-"+pad2(d.getDate());return pendingCustomRangeStartYmd=ymd,pendingCustomRangeEndYmd=null,void updateCustomDateFooter()}if(2===selectedDates.length){const d1=selectedDates[0],d2=selectedDates[1],ymd1=d1.getFullYear()+"-"+pad2(d1.getMonth()+1)+"-"+pad2(d1.getDate()),ymd2=d2.getFullYear()+"-"+pad2(d2.getMonth()+1)+"-"+pad2(d2.getDate()),diffMs=Math.abs(d2-d1);if(Math.floor(diffMs/864e5)>30){
// Exceeded limit - reset
flatpickrInstance.clear(),pendingCustomRangeStartYmd=null,pendingCustomRangeEndYmd=null,updateCustomDateFooter();const summaryEl=document.getElementById("date-custom-summary");return void(summaryEl&&(summaryEl.textContent="Range exceeds 30 days. Please select a shorter period."))}pendingCustomRangeStartYmd=ymd1<=ymd2?ymd1:ymd2,pendingCustomRangeEndYmd=ymd1<=ymd2?ymd2:ymd1,updateCustomDateFooter()}}}),
// Set initial dates if already selected
pendingCustomRangeStartYmd&&pendingCustomRangeEndYmd?flatpickrInstance.setDate([pendingCustomRangeStartYmd,pendingCustomRangeEndYmd]):pendingCustomRangeStartYmd&&flatpickrInstance.setDate(pendingCustomRangeStartYmd)):setTimeout(function(){initFlatpickrDatePicker(payload)},200)}function closeCustomDateModal(){const modal=document.getElementById("date-custom-modal");modal&&(modal.style.display="",modal.classList.remove("show"),document.body.classList.remove("modal-open"),pendingCustomRangeStartYmd=null,pendingCustomRangeEndYmd=null,customDateApplyOverride=null,customDatePrefillRangeKey=null,flatpickrInstance&&(flatpickrInstance.destroy(),flatpickrInstance=null),syncDateSelectOptions())}var timeframeOverlayToken=0;function applyDateRangeChange(opts){var showTimeframeOverlay=!0===(opts=opts&&"object"==typeof opts?opts:{}).showTimeframeOverlay;if("settings"===PAGE&&(showTimeframeOverlay=!1),"live"!==dateRange&&(lastOnlineCount=null),countryPage=1,bestGeoProductsPage=1,aovPage=1,bestSellersPage=1,bestVariantsPage=1,attributionPage=1,devicesPage=1,currentPage=1,syncDateSelectOptions(),
// Reset caches when range changes.
leaderboardCache=null,finishesCache=null,lengthsCache=null,chainStylesCache=null,bestSellersCache=null,bestVariantsCache=null,abandonedCartsChartKey="",abandonedCartsTopCacheKey="",attributionCache=null,devicesCache=null,lastStatsFetchedAt=0,lastProductsFetchedAt=0,lastAttributionFetchedAt=0,lastDevicesFetchedAt=0,updateNextUpdateUi(),showTimeframeOverlay){var token=timeframeOverlayToken+=1,dateLabel="date range";try{var applied=appliedYmdRangeFromDateRange();if(applied&&applied.startYmd&&applied.endYmd)dateLabel=formatYmdRangeLabel(applied.startYmd,applied.endYmd)||dateLabel;else{dateLabel={today:"Today",yesterday:"Yesterday","7days":"Last 7 days","14days":"Last 14 days","30days":"Last 30 days"}[String(dateRange||"today")]||"Today"}}catch(_){}var overlay=document.getElementById("page-body-loader"),titleEl=overlay&&overlay.querySelector?overlay.querySelector(".report-build-title"):null,stepEl=document.getElementById("page-body-build-step"),indeterminateWrap=overlay&&overlay.querySelector?overlay.querySelector(".page-loader-progress:not(.page-loader-progress--determinate)"):null,determinateWrap=document.getElementById("page-body-loader-determinate"),determinateBar=document.getElementById("page-body-loader-determinate-bar");titleEl&&(titleEl.textContent="Preparing "+dateLabel+" reports"),stepEl&&(stepEl.textContent="Loading…"),indeterminateWrap&&(indeterminateWrap.style.display="none"),determinateWrap&&(determinateWrap.style.display=""),determinateBar&&(determinateBar.style.width="0%",determinateBar.setAttribute("aria-valuenow",0)),overlay&&(overlay.classList.remove("is-hidden"),overlay.classList.add("timeframe-overlay"));var scope=document.querySelector(".page-body");if(scope)try{scope.classList.add("report-building")}catch(_){}try{document.body.classList.add("kexo-report-loading")}catch(_){}var promises=[];try{promises.push(refreshKpis({force:!0}))}catch(_){}try{var kexoP="function"==typeof window.refreshKexoScore?window.refreshKexoScore():null;kexoP&&"function"==typeof kexoP.then&&promises.push(kexoP)}catch(_){}var tabPromise=null;if("stats"===activeMainTab)try{tabPromise=refreshStats({force:!1})}catch(_){}else if("products"===activeMainTab)try{tabPromise=refreshProducts({force:!1})}catch(_){}else if("attribution"===activeMainTab)try{tabPromise=refreshAttribution({force:!1})}catch(_){}else if("devices"===activeMainTab)try{tabPromise=refreshDevices({force:!1})}catch(_){}else if("browsers"===activeMainTab)try{tabPromise=refreshBrowsers({force:!1})}catch(_){}else if("variants"===activeMainTab)try{tabPromise="function"==typeof window.__refreshVariantsInsights?window.__refreshVariantsInsights({force:!0}):null}catch(_){}else if("abandoned-carts"===activeMainTab)try{tabPromise=refreshAbandonedCarts({force:!0})}catch(_){}else if("checkout-funnel"===activeMainTab)try{tabPromise=refreshCheckoutFunnel({force:!0})}catch(_){}if(tabPromise&&"function"==typeof tabPromise.then&&promises.push(tabPromise),"dashboard"===activeMainTab)try{"function"==typeof refreshDashboard&&refreshDashboard({force:!1})}catch(_){}if("ads"===activeMainTab||"ads"===PAGE)try{window.__adsRefresh&&window.__adsRefresh({force:!1})}catch(_){}if("dashboard"!==activeMainTab&&"stats"!==activeMainTab&&"products"!==activeMainTab&&"attribution"!==activeMainTab&&"devices"!==activeMainTab&&"variants"!==activeMainTab&&"abandoned-carts"!==activeMainTab&&"checkout-funnel"!==activeMainTab){updateKpis();try{fetchSessions()}catch(_){}}var total=Math.max(1,promises.length),completed=0;function updateProgress(pct){if(timeframeOverlayToken===token){var bar=document.getElementById("page-body-loader-determinate-bar");bar&&(bar.style.width=pct+"%",bar.setAttribute("aria-valuenow",Math.round(pct)))}}function hideTimeframeOverlay(){if(timeframeOverlayToken===token){var ov=document.getElementById("page-body-loader");ov&&(ov.classList.add("is-hidden"),ov.classList.remove("timeframe-overlay"));var ind=ov&&ov.querySelector?ov.querySelector(".page-loader-progress:not(.page-loader-progress--determinate)"):null;ind&&(ind.style.display="");var det=document.getElementById("page-body-loader-determinate");det&&(det.style.display="none");var detBar=document.getElementById("page-body-loader-determinate-bar");if(detBar&&(detBar.style.width="0%",detBar.setAttribute("aria-valuenow",0)),scope)try{scope.classList.remove("report-building")}catch(_){}try{document.body.classList.remove("kexo-report-loading")}catch(_){}}}return promises.forEach(function(p){p&&"function"==typeof p.finally?p.finally(function(){updateProgress((completed+=1)/total*100),completed>=total&&hideTimeframeOverlay()}):(updateProgress((completed+=1)/total*100),completed>=total&&hideTimeframeOverlay())}),0===promises.length&&(updateProgress(100),hideTimeframeOverlay()),void updateKpis()}
// Top KPI grid refreshes independently (every minute). On range change, force a refresh immediately.
refreshKpis({force:!1});try{refreshKpiExtrasSoft()}catch(_){}try{"function"==typeof window.refreshKexoScore&&window.refreshKexoScore()}catch(_){}
// Keep the desktop navbar "visitors" status eager on every range change.
if(updateKpis(),"dashboard"===activeMainTab)try{"function"==typeof refreshDashboard&&refreshDashboard({force:!1})}catch(_){}else if("stats"===activeMainTab)refreshStats({force:!1});else if("attribution"===activeMainTab)try{refreshAttribution({force:!1})}catch(_){}else if("devices"===activeMainTab)try{refreshDevices({force:!1})}catch(_){}else if("browsers"===activeMainTab)try{refreshBrowsers({force:!1})}catch(_){}else if("products"===activeMainTab)refreshProducts({force:!1});else if("variants"===activeMainTab)try{"function"==typeof window.__refreshVariantsInsights&&window.__refreshVariantsInsights({force:!0})}catch(_){}else if("abandoned-carts"===activeMainTab)try{refreshAbandonedCarts({force:!0})}catch(_){fetchSessions()}else if("checkout-funnel"===activeMainTab)try{refreshCheckoutFunnel({force:!0})}catch(_){}else if("ads"===activeMainTab||"ads"===PAGE)try{window.__adsRefresh&&window.__adsRefresh({force:!1})}catch(_){}else updateKpis(),fetchSessions()}function openCustomDateModalFor(opts){const o=opts&&"object"==typeof opts?opts:{};customDateApplyOverride="function"==typeof o.onApply?o.onApply:null,customDatePrefillRangeKey=null!=o.prefillRangeKey?String(o.prefillRangeKey).trim().toLowerCase():null;const modal=document.getElementById("date-custom-modal"),input=document.getElementById("date-range-picker");if(!modal||!input)return;modal.style.display="block",modal.classList.add("show"),document.body.classList.add("modal-open");let applied=null;try{if(customDatePrefillRangeKey)if(isCustomRangeKey(customDatePrefillRangeKey))applied=ymdRangeFromRangeKey(customDatePrefillRangeKey);else if(isCustomDayRangeKey(customDatePrefillRangeKey)){const ymd=ymdFromDayKey(customDatePrefillRangeKey);applied=ymd?{startYmd:ymd,endYmd:ymd}:null}}catch(_){applied=null}applied||(applied=appliedYmdRangeFromDateRange()),pendingCustomRangeStartYmd=applied&&applied.startYmd&&applied.startYmd>=MIN_YMD?applied.startYmd:null,pendingCustomRangeEndYmd=applied&&applied.endYmd&&applied.endYmd>=MIN_YMD?applied.endYmd:null,customCalendarLastPayload=null,updateCustomDateFooter(),input.placeholder="Loading...",input.disabled=!0,function(days,opts={}){const force=!!opts.force,now=Date.now();if(!force&&availableDaysMemo&&now-availableDaysMemoAt<6e4)return Promise.resolve(availableDaysMemo);if(!force&&availableDaysInflight)return availableDaysInflight;const p=fetchWithTimeout("/api/available-days?days="+encodeURIComponent(String(days||30))+(force?"&_="+now:""),{credentials:"same-origin",cache:force?"no-store":"default"},2e4).then(r=>r&&r.ok?r.json():null).then(data=>(data&&data.ok&&(availableDaysMemo=data,availableDaysMemoAt=Date.now()),data)).catch(()=>null).finally(()=>{availableDaysInflight===p&&(availableDaysInflight=null)});return availableDaysInflight=p,p}(30).then(payload=>{customCalendarLastPayload=payload,initFlatpickrDatePicker(payload),input.placeholder="Select dates...",input.disabled=!1,updateCustomDateFooter()})}function updateCustomDateFooter(){const summaryEl=document.getElementById("date-custom-summary"),clearBtn=document.getElementById("date-custom-clear"),applyBtn=document.getElementById("date-custom-apply");if(!summaryEl)return;const a=pendingCustomRangeStartYmd,b=pendingCustomRangeEndYmd;if(!a)return summaryEl.textContent="Select a start date.",clearBtn&&(clearBtn.disabled=!0),void(applyBtn&&(applyBtn.disabled=!0));if(!b)return summaryEl.textContent="Start: "+formatYmdLabel(a)+". Select an end date.",clearBtn&&(clearBtn.disabled=!1),void(applyBtn&&(applyBtn.disabled=!0));const startYmd=a<=b?a:b,endYmd=a<=b?b:a;summaryEl.textContent="Selected: "+(formatYmdRangeLabel(startYmd,endYmd)||startYmd+" – "+endYmd),clearBtn&&(clearBtn.disabled=!1),applyBtn&&(applyBtn.disabled=!1)}let customDateModalInited=!1;try{window.__kexoOpenCustomDateModalFor=openCustomDateModalFor}catch(_){}function maybeTriggerSaleToastFromStatsLikeData(data){const conv=data&&data.convertedCount?data.convertedCount:{};if(!("number"==typeof conv.today&&Number.isFinite(conv.today)))return;
// Reset the converted-count baseline daily (admin TZ).
try{const day=ymdNowInTz();null==convertedCountDayYmd&&(convertedCountDayYmd=day),day&&convertedCountDayYmd!==day&&(convertedCountDayYmd=day,hasSeenConvertedCountToday=!1,lastConvertedCountToday=0)}catch(_){}
// Guard against stale/cache drift where counts briefly move backwards (would cause double "sale" sounds).
if(hasSeenConvertedCountToday&&conv.today<lastConvertedCountToday)return;if(hasSeenConvertedCountToday&&conv.today>lastConvertedCountToday){const statsTodayKey="stats:today:"+String(conv.today);
// Keep Home tables in sync when a toast fires outside SSE (Today/Sales/Live).
if(fetchLatestSaleForToast({forceNew:!0}).then(function(sale){sale&&triggerSaleToast({origin:"stats",playSound:!0,soundDedupeKey:statsTodayKey,toastDedupeKey:statsTodayKey,latestSale:sale,payload:buildSaleToastPayloadFromSale(sale),skipLatest:!0})}).catch(function(){}),"spy"===activeMainTab&&("today"===dateRange||"sales"===dateRange||"live"===dateRange||"1h"===dateRange))try{fetchSessions()}catch(_){}
// Pull the authoritative timestamp (truth/evidence) so the footer is accurate.
try{refreshConfigStatus()}catch(_){}}lastConvertedCountToday=conv.today,hasSeenConvertedCountToday=!0}function renderStats(data){statsCache=data||{},
// IMPORTANT: keep the condensed KPI strip sourced from /api/kpis so compare windows
// and truth semantics remain consistent across all pages. Stats payload is optimized
// for reports/tables and may not include compare (or may differ from truth sources).
maybeTriggerSaleToastFromStatsLikeData(statsCache),statsCache.rangeAvailable&&applyRangeAvailable(statsCache.rangeAvailable),renderCountriesMapChart(),renderCountry(statsCache),renderBestGeoProducts(statsCache),renderAov(statsCache),renderLiveKpis(getKpiData())}function kpiDelta(current,baseline){const cur="number"==typeof current?current:NaN,base="number"==typeof baseline?baseline:NaN;if(!Number.isFinite(cur)||!Number.isFinite(base))return null;const diff=cur-base;return 0===diff?0:base<=0?diff>0?1:-1:diff/base}
// Treat small changes as "stable" (blue/flat) instead of flipping colors.
// KPI deltas often jitter in short windows (Today/1h), so we use a deadband.
const KPI_STABLE_RATIO=.05,KPI_STABLE_PCT=5,DASHBOARD_NEUTRAL_DELTA_KEYS=new Set(["cogs","fulfilled","returns","items"]),DASHBOARD_NEUTRAL_TONE_HEX="#999";// ??5% relative change
let runtimeProfitKpiAllowed=!1;function setRuntimeProfitKpiAllowed(nextAllowed){var allowed=!!nextAllowed;if(runtimeProfitKpiAllowed!==allowed){runtimeProfitKpiAllowed=allowed;try{kpiUiConfigV1&&1===kpiUiConfigV1.v&&(applyCondensedKpiUiConfig(kpiUiConfigV1),applyDashboardKpiUiConfig(kpiUiConfigV1))}catch(_){}}}function cssVarColor(name,fallback){try{return getComputedStyle(document.documentElement).getPropertyValue(name).trim()||fallback}catch(_){return fallback}}function applyCondensedKpiDelta(key,current,baseline,invert){const deltaEl=document.getElementById("cond-kpi-"+key+"-delta"),barEl=document.getElementById("cond-kpi-"+key+"-bar");if(!deltaEl&&!barEl)return;const cur="number"==typeof current&&Number.isFinite(current)?current:null,base="number"==typeof baseline&&Number.isFinite(baseline)?baseline:null,rawDelta=null!=cur&&null!=base?kpiDelta(cur,base):null;let toneDelta=null;if(null!=cur&&null!=base){const diff=cur-base,denom=Math.abs(base);toneDelta=denom>1e-9?diff/denom:0===diff?0:diff>0?1:-1,invert&&(toneDelta=-toneDelta)}const isNew=null!=cur&&0===base&&0!==cur,isUp=isNew||null!=toneDelta&&toneDelta>KPI_STABLE_RATIO,isDown=!isNew&&null!=toneDelta&&toneDelta<-KPI_STABLE_RATIO,isFlat=!isNew&&null!=toneDelta&&!isUp&&!isDown;if(deltaEl){const textEl=deltaEl.querySelector(".kexo-kpi-chip-delta-text");let text="—",dir="none";null!=rawDelta&&(text=isNew?"new":formatSignedPercentOneDecimalFromRatio(rawDelta),dir=isUp?"up":isDown?"down":"flat"),deltaEl.classList.remove("is-up","is-down","is-flat"),"up"===dir?deltaEl.classList.add("is-up"):"down"===dir?deltaEl.classList.add("is-down"):"flat"===dir&&deltaEl.classList.add("is-flat"),deltaEl.setAttribute("data-dir",dir);try{var styleCfg=getChartsKpiBundle("headerStrip").deltaStyle,toneColor=chartsKpiToneColor("headerStrip","none"===dir?"same":dir);deltaEl.style.fontSize=String(styleCfg.fontSize)+"px",deltaEl.style.fontWeight=String(styleCfg.fontWeight),deltaEl.style.color=styleCfg.fontColor||toneColor;var iconEl=deltaEl.querySelector("i");iconEl&&(iconEl.style.fontSize=String(styleCfg.iconSize)+"px",iconEl.style.color=styleCfg.iconColor||toneColor)}catch(_){}textEl?textEl.textContent=text:deltaEl.textContent=text}if(barEl){barEl.classList.remove("bg-success","bg-danger","bg-secondary");const progressEl=barEl.closest&&barEl.closest(".progress")?barEl.closest(".progress"):null,srText=barEl.querySelector?barEl.querySelector(".visually-hidden"):null;
// When compare is missing, avoid misleading "0% complete" semantics.
if(null==rawDelta)return progressEl&&progressEl.classList.add("is-hidden"),barEl.style.width="0%",barEl.classList.add("bg-secondary"),barEl.setAttribute("aria-valuenow","0"),barEl.setAttribute("aria-label","No comparison available"),void(srText&&(srText.textContent="No comparison available"));progressEl&&progressEl.classList.remove("is-hidden");let widthPct=0,barClass="bg-secondary";const deltaPctAbs=Number.isFinite(rawDelta)?Math.round(1e3*Math.abs(rawDelta))/10:null;isFlat||(widthPct=isNew?100:Math.max(6,Math.min(100,Math.round(100*Math.abs(rawDelta)))),barClass=isUp?"bg-success":"bg-danger"),barEl.style.width=String(widthPct)+"%",barEl.classList.add(barClass),barEl.setAttribute("aria-valuenow",String(widthPct)),isNew?(barEl.setAttribute("aria-label","New metric (baseline was 0)"),srText&&(srText.textContent="New metric (baseline was 0)")):null!=deltaPctAbs?(barEl.setAttribute("aria-label",String(deltaPctAbs)+"% change"),srText&&(srText.textContent=String(deltaPctAbs)+"% change")):(barEl.setAttribute("aria-label",String(widthPct)+"% change"),srText&&(srText.textContent=String(widthPct)+"% change"))}}var condensedSeriesCache=null,condensedSeriesRange=null,condensedSeriesFetchedAt=0,condensedSparklineOverrides={},sparklineHistorySeriesCache=null,sparklineHistorySeriesRange=null,sparklineHistorySeriesFetchedAt=0,sparklineHistorySeriesInFlight=null;function getSparklineSeries(series){return Array.isArray(series)&&series.length>=2?series:Array.isArray(sparklineHistorySeriesCache)&&sparklineHistorySeriesCache.length>=2?sparklineHistorySeriesCache:Array.isArray(series)?series:[]}function ensureSparklineHistorySeries(){var rk,fallbackRange=!(rk=normalizeRangeKeyForApi(getStatsRange()))||"today"===rk||"yesterday"===rk||"1h"===rk||/^d:\d{4}-\d{2}-\d{2}$/.test(rk)?"7d":rk;return!(!sparklineHistorySeriesFetchedAt||Date.now()-sparklineHistorySeriesFetchedAt>12e4)&&sparklineHistorySeriesRange===fallbackRange&&sparklineHistorySeriesCache&&sparklineHistorySeriesCache.length>=2?Promise.resolve(sparklineHistorySeriesCache):sparklineHistorySeriesInFlight||(sparklineHistorySeriesInFlight=fetchWithTimeout("/api/dashboard-series?range="+encodeURIComponent(fallbackRange)+("function"==typeof window.kexoGetTrafficQuerySuffix?window.kexoGetTrafficQuerySuffix():""),{credentials:"same-origin",cache:"default"},15e3).then(function(r){return r&&r.ok?r.json():null}).then(function(data){var s=data&&Array.isArray(data.series)?data.series:[];return s.length>=2&&(sparklineHistorySeriesCache=s,sparklineHistorySeriesRange=fallbackRange,sparklineHistorySeriesFetchedAt=Date.now()),sparklineHistorySeriesCache}).catch(function(){return sparklineHistorySeriesCache}).finally(function(){sparklineHistorySeriesInFlight=null}))}function renderCondensedSparklines(series){if("undefined"!=typeof ApexCharts){var sourceSeries=getSparklineSeries(series);if(sourceSeries&&sourceSeries.length){var sparkCfg=getChartsKpiBundle("headerStrip").sparkline||defaultChartsKpiSparklineConfig("headerStrip"),GREEN=chartsKpiToneColor("headerStrip","up"),RED=chartsKpiToneColor("headerStrip","down"),NEUTRAL=chartsKpiToneColor("headerStrip","same"),map={"cond-kpi-orders-sparkline":function(d){return d.orders},"cond-kpi-revenue-sparkline":function(d){return d.revenue},"cond-kpi-profit-sparkline":function(){return null},"cond-kpi-conv-sparkline":function(d){return d.convRate},"cond-kpi-vpv-sparkline":function(d){var rev=d&&"number"==typeof d.revenue?d.revenue:0,sess=d&&"number"==typeof d.sessions?d.sessions:0;return sess>0?rev/sess:null},"cond-kpi-roas-sparkline":function(d){var spend=d&&"number"==typeof d.adSpend?d.adSpend:0,rev=d&&"number"==typeof d.revenue?d.revenue:0;return spend>0?rev/spend:0},"cond-kpi-sessions-sparkline":function(d){return d.sessions},"cond-kpi-returning-sparkline":function(d){return d.returningCustomerOrders||0},"cond-kpi-aov-sparkline":function(d){return d.aov},"cond-kpi-cogs-sparkline":function(){return null},"cond-kpi-bounce-sparkline":function(d){return d.bounceRate},"cond-kpi-orders-fulfilled-sparkline":function(){return null},"cond-kpi-returns-sparkline":function(){return null},"cond-kpi-items-sold-sparkline":function(d){return d.units||0}};Object.keys(map).forEach(function(id){var el=document.getElementById(id);if(el){var overrideData=condensedSparklineOverrides&&Array.isArray(condensedSparklineOverrides[id])?condensedSparklineOverrides[id]:null,dataArr=overrideData&&overrideData.length?overrideData.slice():sourceSeries.map(map[id]);dataArr.length<2&&(dataArr=1===dataArr.length?[dataArr[0],dataArr[0]]:[0,0]);var tone=String(el.getAttribute("data-tone")||"").toLowerCase();"up"!==tone&&"down"!==tone&&(tone="neutral");var sparkColor="down"===tone?RED:"up"===tone?GREEN:NEUTRAL;if(el.innerHTML="","function"==typeof window.kexoRenderSparkline)try{return void window.kexoRenderSparkline({containerEl:el,data:dataArr,color:sparkColor,height:Number(sparkCfg.height)||30,mode:sparkCfg.mode||"line",curve:sparkCfg.curve||"smooth",strokeWidth:sparkCfg.strokeWidth,showCompare:!1,advancedApexOverride:sparkCfg.advancedApexOverride||{}})}catch(_){}try{new ApexCharts(el,{chart:{type:sparkCfg.mode||"line",height:Number(sparkCfg.height)||30,sparkline:{enabled:!0},animations:{enabled:!1}},series:[{data:dataArr}],stroke:{show:!0,width:Number(sparkCfg.strokeWidth)||2.15,curve:sparkCfg.curve||"smooth",lineCap:"round"},
// NOTE: ApexCharts 4.x can incorrectly apply fill opacity to line stroke color.
// Keep fill opacity at 1 for visible strokes; line charts still render line-only.
fill:{type:"solid",opacity:1},colors:[sparkColor],markers:{size:0},grid:{padding:{top:0,right:0,bottom:-2,left:0}},tooltip:{enabled:!0}}).render()}catch(_){}}})}}}function fetchCondensedSeries(){var rangeKey=getStatsRange();rangeKey&&(!condensedSeriesFetchedAt||Date.now()-condensedSeriesFetchedAt>12e4||!condensedSeriesCache||condensedSeriesRange!==rangeKey?fetchWithTimeout("/api/dashboard-series?range="+encodeURIComponent(rangeKey)+("function"==typeof window.kexoGetTrafficQuerySuffix?window.kexoGetTrafficQuerySuffix():""),{credentials:"same-origin",cache:"default"},15e3).then(function(r){return r&&r.ok?r.json():null}).then(function(data){var s=data&&data.series?data.series:null;s&&s.length&&(condensedSeriesCache=s,condensedSeriesRange=rangeKey,condensedSeriesFetchedAt=Date.now(),renderCondensedSparklines(s),s.length<2&&ensureSparklineHistorySeries().then(function(historySeries){historySeries&&historySeries.length>=2&&renderCondensedSparklines(s)}).catch(function(){}))}).catch(function(){}):renderCondensedSparklines(condensedSeriesCache))}function renderLiveKpis(data){const sales=data&&data.sales?data.sales:{},convertedCountMap=data&&data.convertedCount?data.convertedCount:{},returningCustomerCountMap=data&&data.returningCustomerCount?data.returningCustomerCount:{},breakdown=data&&data.trafficBreakdown?data.trafficBreakdown:{},conv=data&&data.conversion?data.conversion:{},vpvMap=data&&data.vpv?data.vpv:{},aovMap=data&&data.aov?data.aov:{},bounceMap=data&&data.bounce?data.bounce:{},costMap=data&&data.cost?data.cost:{},profitMap=data&&data.profit?data.profit:{},condOrdersEl=document.getElementById("cond-kpi-orders"),condRevenueEl=document.getElementById("cond-kpi-revenue"),condProfitEl=document.getElementById("cond-kpi-profit"),condConvEl=document.getElementById("cond-kpi-conv"),condVpvEl=document.getElementById("cond-kpi-vpv"),condSessionsEl=document.getElementById("cond-kpi-sessions"),condReturningEl=document.getElementById("cond-kpi-returning"),condAovEl=document.getElementById("cond-kpi-aov"),condRoasEl=document.getElementById("cond-kpi-roas"),condBounceEl=document.getElementById("cond-kpi-bounce"),topbarOrdersEl=document.getElementById("topbar-kpi-orders"),topbarClicksEl=document.getElementById("topbar-kpi-clicks"),topbarConvEl=document.getElementById("topbar-kpi-conv"),topbarOrdersDeltaEl=document.getElementById("topbar-kpi-orders-delta"),topbarOrdersDeltaTextEl=document.getElementById("topbar-kpi-orders-delta-text"),topbarClicksDeltaEl=document.getElementById("topbar-kpi-clicks-delta"),topbarClicksDeltaTextEl=document.getElementById("topbar-kpi-clicks-delta-text"),topbarConvDeltaEl=document.getElementById("topbar-kpi-conv-delta"),topbarConvDeltaTextEl=document.getElementById("topbar-kpi-conv-delta-text"),kpiRange=getStatsRange(),profitKpiAllowed=!(!data||!0!==data.profitKpiAllowed);setRuntimeProfitKpiAllowed(profitKpiAllowed);const forRange=breakdown[kpiRange],sessionsVal=null!=forRange&&"number"==typeof forRange.human_sessions?forRange.human_sessions:null,orderCountVal="number"==typeof convertedCountMap[kpiRange]?convertedCountMap[kpiRange]:null,revenueVal="number"==typeof sales[kpiRange]?sales[kpiRange]:null,costVal="number"==typeof costMap[kpiRange]?costMap[kpiRange]:null;let profitVal="number"==typeof profitMap[kpiRange]?profitMap[kpiRange]:null;null==profitVal&&null!=revenueVal&&null!=costVal&&(profitVal=Math.round(100*(revenueVal-costVal))/100),profitKpiAllowed||(profitVal=null);const returningVal="number"==typeof returningCustomerCountMap[kpiRange]?returningCustomerCountMap[kpiRange]:null,convVal="number"==typeof conv[kpiRange]?conv[kpiRange]:null,vpvVal="number"==typeof vpvMap[kpiRange]?vpvMap[kpiRange]:null,aovVal="number"==typeof aovMap[kpiRange]?aovMap[kpiRange]:null,roasVal=data&&data.roas&&"number"==typeof data.roas[kpiRange]?data.roas[kpiRange]:null,bounceVal="number"==typeof bounceMap[kpiRange]?bounceMap[kpiRange]:null,compare=data&&data.compare?data.compare:null,compareBreakdown=compare&&compare.trafficBreakdown?compare.trafficBreakdown:null,compareSessionsVal=compareBreakdown&&"number"==typeof compareBreakdown.human_sessions?compareBreakdown.human_sessions:null,compareOrdersVal=compare&&"number"==typeof compare.convertedCount?compare.convertedCount:null,compareRevenueVal=compare&&"number"==typeof compare.sales?compare.sales:null,compareCostVal=compare&&"number"==typeof compare.cost?compare.cost:null;let compareProfitVal=compare&&"number"==typeof compare.profit?compare.profit:null;null==compareProfitVal&&null!=compareRevenueVal&&null!=compareCostVal&&(compareProfitVal=Math.round(100*(compareRevenueVal-compareCostVal))/100),profitKpiAllowed||(compareProfitVal=null);const compareReturningVal=compare&&"number"==typeof compare.returningCustomerCount?compare.returningCustomerCount:null,compareConvVal=compare&&"number"==typeof compare.conversion?compare.conversion:null,compareVpvVal=compare&&"number"==typeof compare.vpv?compare.vpv:null,compareAovVal=compare&&"number"==typeof compare.aov?compare.aov:null,compareRoasVal=compare&&"number"==typeof compare.roas?compare.roas:null,compareBounceVal=compare&&"number"==typeof compare.bounce?compare.bounce:null;function setCondensedSparklineTone(id,current,baseline,invert){const sparkEl=document.getElementById(id);if(!sparkEl)return;const cur="number"==typeof current&&Number.isFinite(current)?current:null,base="number"==typeof baseline&&Number.isFinite(baseline)?baseline:null;if(null==cur||null==base)return void sparkEl.removeAttribute("data-tone");const delta=invert?base-cur:cur-base;if(Math.abs(delta)<1e-9)return void sparkEl.removeAttribute("data-tone");const denom=Math.abs(base);if(denom>1e-9){const ratio=delta/denom;if(Math.abs(ratio)<=KPI_STABLE_RATIO)return void sparkEl.removeAttribute("data-tone")}sparkEl.setAttribute("data-tone",delta<0?"down":"up")}condOrdersEl&&(condOrdersEl.textContent=null!=orderCountVal?formatSessions(orderCountVal):"—"),condRevenueEl&&(condRevenueEl.textContent=null!=revenueVal?formatRevenue(revenueVal):"—"),condProfitEl&&(condProfitEl.textContent=null!=profitVal?formatRevenue(profitVal):"—"),condSessionsEl&&(condSessionsEl.textContent=null!=sessionsVal?formatSessions(sessionsVal):"—"),condConvEl&&(condConvEl.textContent=null!=convVal?pct(convVal):"—"),condVpvEl&&(condVpvEl.textContent=null!=vpvVal?formatRevenue(vpvVal):"—"),condReturningEl&&(condReturningEl.textContent=null!=returningVal?formatSessions(returningVal):"—"),condAovEl&&(condAovEl.textContent=null!=aovVal?formatRevenue(aovVal):"—"),condRoasEl&&(condRoasEl.textContent=null!=roasVal?Number(roasVal).toFixed(2)+"x":"—"),condBounceEl&&(condBounceEl.textContent=null!=bounceVal?pct(bounceVal):"—"),applyCondensedKpiDelta("orders",orderCountVal,compareOrdersVal,!1),applyCondensedKpiDelta("revenue",revenueVal,compareRevenueVal,!1),applyCondensedKpiDelta("profit",profitVal,compareProfitVal,!1),applyCondensedKpiDelta("sessions",sessionsVal,compareSessionsVal,!1),applyCondensedKpiDelta("conv",convVal,compareConvVal,!1),applyCondensedKpiDelta("vpv",vpvVal,compareVpvVal,!1),applyCondensedKpiDelta("returning",returningVal,compareReturningVal,!1),applyCondensedKpiDelta("aov",aovVal,compareAovVal,!1),applyCondensedKpiDelta("roas",roasVal,compareRoasVal,!1),applyCondensedKpiDelta("bounce",bounceVal,compareBounceVal,!0),setCondensedSparklineTone("cond-kpi-orders-sparkline",orderCountVal,compareOrdersVal),setCondensedSparklineTone("cond-kpi-revenue-sparkline",revenueVal,compareRevenueVal),setCondensedSparklineTone("cond-kpi-profit-sparkline",profitVal,compareProfitVal),setCondensedSparklineTone("cond-kpi-conv-sparkline",convVal,compareConvVal),setCondensedSparklineTone("cond-kpi-vpv-sparkline",vpvVal,compareVpvVal),setCondensedSparklineTone("cond-kpi-roas-sparkline",roasVal,compareRoasVal),setCondensedSparklineTone("cond-kpi-sessions-sparkline",sessionsVal,compareSessionsVal),setCondensedSparklineTone("cond-kpi-returning-sparkline",returningVal,compareReturningVal),setCondensedSparklineTone("cond-kpi-aov-sparkline",aovVal,compareAovVal),setCondensedSparklineTone("cond-kpi-bounce-sparkline",bounceVal,compareBounceVal,!0),condensedSparklineOverrides&&"object"==typeof condensedSparklineOverrides||(condensedSparklineOverrides={});var profitSparkline=data&&Array.isArray(data.profitSparkline)?data.profitSparkline:null;profitKpiAllowed?profitSparkline&&profitSparkline.length>=2?condensedSparklineOverrides["cond-kpi-profit-sparkline"]=profitSparkline.slice():condensedSparklineOverrides["cond-kpi-profit-sparkline"]=null!=profitVal&&null!=compareProfitVal?[compareProfitVal,profitVal]:null:condensedSparklineOverrides["cond-kpi-profit-sparkline"]=null;try{condensedSeriesCache&&renderCondensedSparklines(condensedSeriesCache)}catch(_){}try{updateCondensedKpiOverflow()}catch(_){}
// Header quick KPIs (compact)
function deltaPct(curr,prev){const c="number"==typeof curr&&Number.isFinite(curr)?curr:null,p="number"==typeof prev&&Number.isFinite(prev)?prev:null;return null==c||null==p?null:
// Avoid divide-by-zero: show "new" when baseline is 0 and current is non-zero.
0===p?0===c?0:1/0:(c-p)/p*100}function applyTopbarDelta(deltaWrap,deltaTextEl,pctVal){if(!deltaWrap||!deltaTextEl)return;var headerDeltaStyle=getChartsKpiBundle("headerStrip").deltaStyle;function applyHeaderTone(dir){var tone=chartsKpiToneColor("headerStrip",dir);deltaWrap.style.fontSize=String(headerDeltaStyle.fontSize)+"px",deltaWrap.style.fontWeight=String(headerDeltaStyle.fontWeight),deltaWrap.style.color=headerDeltaStyle.fontColor||tone;var iconEl=deltaWrap.querySelector("i");iconEl&&(iconEl.style.fontSize=String(headerDeltaStyle.iconSize)+"px",iconEl.style.color=headerDeltaStyle.iconColor||tone)}if(null==pctVal||!Number.isFinite(pctVal))return pctVal===1/0?(deltaWrap.classList.remove("is-hidden"),deltaWrap.classList.add("is-up"),deltaWrap.classList.remove("is-down","is-flat"),deltaTextEl.textContent="new",void applyHeaderTone("up")):(deltaWrap.classList.add("is-hidden"),void deltaWrap.classList.remove("is-up","is-down","is-flat"));const p=Math.round(10*pctVal)/10,up=p>KPI_STABLE_PCT,down=p<-KPI_STABLE_PCT;deltaWrap.classList.remove("is-hidden"),deltaWrap.classList.toggle("is-up",up),deltaWrap.classList.toggle("is-down",down),deltaWrap.classList.toggle("is-flat",!up&&!down),applyHeaderTone(up?"up":down?"down":"same"),deltaTextEl.textContent=Math.abs(p).toFixed(1).replace(/\.0$/,"")+"%"}topbarOrdersEl&&(topbarOrdersEl.textContent=null!=orderCountVal?formatSessions(orderCountVal):"—"),topbarClicksEl&&(topbarClicksEl.textContent=null!=sessionsVal?formatSessions(sessionsVal):"—"),topbarConvEl&&(topbarConvEl.textContent=null!=convVal?pct(convVal):"—"),applyTopbarDelta(topbarOrdersDeltaEl,topbarOrdersDeltaTextEl,deltaPct(orderCountVal,compareOrdersVal)),applyTopbarDelta(topbarClicksDeltaEl,topbarClicksDeltaTextEl,deltaPct(sessionsVal,compareSessionsVal)),applyTopbarDelta(topbarConvDeltaEl,topbarConvDeltaTextEl,deltaPct(convVal,compareConvVal))}
// Dashboard KPI cards:
// - Left compare slot always uses true previous-period values from /api/kpis compare payload.
// - Right compare slot is optional context (Previous 7 days) shown only on today/yesterday.
let _dashKpiSecondaryFetchedAt=0,_dashKpiSecondaryInFlight=null,_dashKpisSecondary=null,_dashKpiExtrasSecondaryFetchedAt=0,_dashKpiExtrasSecondaryInFlight=null,_dashKpiExtrasSecondary=null;function ensureDashboardSecondaryKpis(){return _dashKpiSecondaryFetchedAt&&Date.now()-_dashKpiSecondaryFetchedAt<12e4&&_dashKpisSecondary?Promise.resolve(_dashKpisSecondary):_dashKpiSecondaryInFlight||(_dashKpiSecondaryInFlight=(rangeKey="7d",(rangeKey=(null==rangeKey?"":String(rangeKey)).trim().toLowerCase())||(rangeKey="today"),fetchWithTimeout("/api/kpis?range="+encodeURIComponent(rangeKey)+("function"==typeof window.kexoGetTrafficQuerySuffix?window.kexoGetTrafficQuerySuffix():""),{credentials:"same-origin",cache:"no-store"},25e3).then(function(r){if(!r||!r.ok)throw new Error("KPIs HTTP "+(r?r.status:"0"));return r.json()})).catch(function(){return null}).then(function(part){return _dashKpisSecondary=part||null,_dashKpiSecondaryFetchedAt=Date.now(),_dashKpisSecondary}).finally(function(){_dashKpiSecondaryInFlight=null}),_dashKpiSecondaryInFlight);// /api/kpis-expanded-extra?range=7d
var rangeKey}function ensureDashboardSecondaryExtras(){return _dashKpiExtrasSecondaryFetchedAt&&Date.now()-_dashKpiExtrasSecondaryFetchedAt<12e4&&_dashKpiExtrasSecondary?Promise.resolve(_dashKpiExtrasSecondary):_dashKpiExtrasSecondaryInFlight||(_dashKpiExtrasSecondaryInFlight=function(rangeKey){(rangeKey=(null==rangeKey?"":String(rangeKey)).trim().toLowerCase())||(rangeKey="today");let url="/api/kpis-expanded-extra?range="+encodeURIComponent(rangeKey);try{const shop=getShopForSales();shop&&(url+="&shop="+encodeURIComponent(shop))}catch(_){}return fetchWithTimeout(url,{credentials:"same-origin",cache:"no-store"},25e3).then(function(r){if(!r||!r.ok)throw new Error("KPI extras HTTP "+(r?r.status:"0"));return r.json()})}("7d").catch(function(){return null}).then(function(part){return _dashKpiExtrasSecondary=part||null,_dashKpiExtrasSecondaryFetchedAt=Date.now(),_dashKpiExtrasSecondary}).finally(function(){_dashKpiExtrasSecondaryInFlight=null}),_dashKpiExtrasSecondaryInFlight)}function formatYmdMonthDay(ymd,includeYear){if(!ymd||!/^\d{4}-\d{2}-\d{2}$/.test(String(ymd)))return String(ymd||"");var y=parseInt(String(ymd).slice(0,4),10),m=parseInt(String(ymd).slice(5,7),10),d=parseInt(String(ymd).slice(8,10),10);if(!Number.isFinite(y)||!Number.isFinite(m)||!Number.isFinite(d)||m<1||m>12||d<1||d>31)return String(ymd||"");var base="mdy"===
// Dashboard compare labels: use explicit date/date-range strings (avoid "Day before", "Previous 7 days").
function(){try{var cfg=void 0!==kpiUiConfigV1&&kpiUiConfigV1&&1===kpiUiConfigV1.v?kpiUiConfigV1:null,general=cfg&&cfg.options&&cfg.options.general&&"object"==typeof cfg.options.general?cfg.options.general:null;return"mdy"===String(general&&general.dateLabelFormat?general.dateLabelFormat:"").trim().toLowerCase()?"mdy":"dmy"}catch(_){return"dmy"}}()?String(m)+"/"+String(d):String(d)+"/"+String(m);return includeYear?base+"/"+String(y):base}function formatYmdRangeMonthDay(startYmd,endYmd){if(!startYmd||!endYmd)return"";if(startYmd===endYmd)return formatYmdMonthDay(startYmd,!1);var includeYear=String(startYmd).slice(0,4)!==String(endYmd).slice(0,4);return formatYmdMonthDay(startYmd,includeYear)+" – "+formatYmdMonthDay(endYmd,includeYear)}function ymdAddDays(ymd,deltaDays){if(!ymd||!/^\d{4}-\d{2}-\d{2}$/.test(String(ymd)))return null;var y=parseInt(String(ymd).slice(0,4),10),m=parseInt(String(ymd).slice(5,7),10),d=parseInt(String(ymd).slice(8,10),10);if(!Number.isFinite(y)||!Number.isFinite(m)||!Number.isFinite(d))return null;var dt=new Date(Date.UTC(y,m-1,d,12,0,0));return dt.setUTCDate(dt.getUTCDate()+(Number(deltaDays)||0)),dt.toISOString().slice(0,10)}function renderDashboardKpisFromApi(primaryData){if(primaryData&&"dashboard"===PAGE){var el=function(id){return document.getElementById(id)},kpiRange=getStatsRange(),showSecondary=function(rangeKey){const rk=normalizeRangeKeyForApi(rangeKey);return"today"===rk||"yesterday"===rk}(kpiRange),main=primaryData,profitKpiAllowed=!(!main||!0!==main.profitKpiAllowed);setRuntimeProfitKpiAllowed(profitKpiAllowed);var salesVal=numFromMap(main,"sales",kpiRange),costVal=numFromMap(main,"cost",kpiRange),profitVal=numFromMap(main,"profit",kpiRange);null==profitVal&&null!=salesVal&&null!=costVal&&(profitVal=round2Local(salesVal-costVal)),profitKpiAllowed||(profitVal=null);var ordersVal=numFromMap(main,"convertedCount",kpiRange),sessionsVal=sessionsFromBreakdownMap(main,kpiRange),convVal=numFromMap(main,"conversion",kpiRange),vpvVal=numFromMap(main,"vpv",kpiRange),aovVal=numFromMap(main,"aov",kpiRange),bounceVal=numFromMap(main,"bounce",kpiRange),returningVal=numFromMap(main,"returningCustomerCount",kpiRange),roasVal=numFromMap(main,"roas",kpiRange),extrasMain=kpiExpandedExtrasRange===kpiRange&&kpiExpandedExtrasCache||null,itemsVal=extrasMain&&"number"==typeof extrasMain.itemsSold?extrasMain.itemsSold:null,fulfilledVal=extrasMain&&"number"==typeof extrasMain.ordersFulfilled?extrasMain.ordersFulfilled:null,returnsVal=extrasMain&&"number"==typeof extrasMain.returns?extrasMain.returns:null,cogsVal=extrasMain&&"number"==typeof extrasMain.cogs?extrasMain.cogs:null;setDashValueText("dash-kpi-revenue",null!=salesVal?formatRevenue0(salesVal):"—"),setDashValueText("dash-kpi-profit",null!=profitVal?formatRevenue0(profitVal):"—"),
// Overview card Profit is set only by the chart (setOverviewSalesRunningTotals) so it stays in sync with the graph; do not overwrite from KPI.
setDashValueText("dash-kpi-orders",null!=ordersVal?Math.round(ordersVal).toLocaleString():"—"),setDashValueText("dash-kpi-sessions",null!=sessionsVal?formatSessions(sessionsVal):"—"),setDashValueText("dash-kpi-conv",null!=convVal?pct(convVal):"—"),setDashValueText("dash-kpi-vpv",null!=vpvVal?formatRevenue(vpvVal):"—"),setDashValueText("dash-kpi-aov",null!=aovVal?formatRevenue0(aovVal):"—"),setDashValueText("dash-kpi-bounce",null!=bounceVal?pct(bounceVal):"—"),setDashValueText("dash-kpi-returning",null!=returningVal?Math.round(returningVal).toLocaleString():"—"),setDashValueText("dash-kpi-roas",null!=roasVal?roasVal.toFixed(2)+"x":"—"),setDashValueText("dash-kpi-items",null!=itemsVal?Math.round(itemsVal).toLocaleString():"—"),setDashValueText("dash-kpi-fulfilled",null!=fulfilledVal?Math.round(fulfilledVal).toLocaleString():"—"),setDashValueText("dash-kpi-returns",null!=returnsVal?formatNegativeCurrencyOrZero(returnsVal,!0):"—"),setDashValueText("dash-kpi-cogs",null!=cogsVal?formatRevenue0(cogsVal):"—");var primaryCompare=main&&main.compare?main.compare:null,primaryExtrasCompare=extrasMain&&extrasMain.compare?extrasMain.compare:null,salesBase=numFromCompare(primaryCompare,"sales"),costBase=numFromCompare(primaryCompare,"cost"),profitBase=numFromCompare(primaryCompare,"profit");null==profitBase&&null!=salesBase&&null!=costBase&&(profitBase=round2Local(salesBase-costBase)),profitKpiAllowed||(profitBase=null);var compareObj,br,v,ordersBase=numFromCompare(primaryCompare,"convertedCount"),sessionsBase=(br=(compareObj=primaryCompare)&&compareObj.trafficBreakdown?compareObj.trafficBreakdown:null,"number"==typeof(v=br&&"number"==typeof br.human_sessions?br.human_sessions:null)&&Number.isFinite(v)?v:null),convBase=numFromCompare(primaryCompare,"conversion"),vpvBase=numFromCompare(primaryCompare,"vpv"),aovBase=numFromCompare(primaryCompare,"aov"),bounceBase=numFromCompare(primaryCompare,"bounce"),returningBase=numFromCompare(primaryCompare,"returningCustomerCount"),roasBase=numFromCompare(primaryCompare,"roas"),itemsBase=primaryExtrasCompare&&"number"==typeof primaryExtrasCompare.itemsSold?primaryExtrasCompare.itemsSold:null,fulfilledBase=primaryExtrasCompare&&"number"==typeof primaryExtrasCompare.ordersFulfilled?primaryExtrasCompare.ordersFulfilled:null,returnsBase=primaryExtrasCompare&&"number"==typeof primaryExtrasCompare.returns?primaryExtrasCompare.returns:null,cogsBase=primaryExtrasCompare&&"number"==typeof primaryExtrasCompare.cogs?primaryExtrasCompare.cogs:null;applyDashDelta("revenue",salesVal,salesBase,!1),applyDashDelta("profit",profitVal,profitBase,!1),applyDashDelta("orders",ordersVal,ordersBase,!1),applyDashDelta("sessions",sessionsVal,sessionsBase,!1),applyDashDelta("conv",convVal,convBase,!1),applyDashDelta("vpv",vpvVal,vpvBase,!1),applyDashDelta("aov",aovVal,aovBase,!1),applyDashDelta("bounce",bounceVal,bounceBase,!0),applyDashDelta("returning",returningVal,returningBase,!1),applyDashDelta("roas",roasVal,roasBase,!1),applyDashDelta("items",itemsVal,itemsBase,!1),applyDashDelta("fulfilled",fulfilledVal,fulfilledBase,!1),applyDashDelta("returns",returnsVal,returnsBase,!0),applyDashDelta("cogs",cogsVal,cogsBase,!0),renderCompareSlot("yesterday",{sales:salesBase,profit:profitBase,orders:ordersBase,sessions:sessionsBase,conv:convBase,vpv:vpvBase,aov:aovBase,bounce:bounceBase,returning:returningBase,roas:roasBase,items:itemsBase,fulfilled:fulfilledBase,returns:returnsBase,cogs:cogsBase});var primaryCompareLabel="";try{normalizeRangeKeyForApi(kpiRange);primaryCompareLabel=function(rangeObj){var startMs=rangeObj&&null!=rangeObj.start?Number(rangeObj.start):NaN,endMs=rangeObj&&null!=rangeObj.end?Number(rangeObj.end):NaN;if(!(Number.isFinite(startMs)&&Number.isFinite(endMs)&&endMs>startMs))return"";var startYmd=ymdInAdminTzFromMs(startMs),endYmd=ymdInAdminTzFromMs(Math.max(startMs,endMs-1));return startYmd&&endYmd?formatYmdRangeMonthDay(startYmd,endYmd):""}(primaryCompare&&primaryCompare.range?primaryCompare.range:null)}catch(_){primaryCompareLabel=""}if(!primaryCompareLabel)try{primaryCompareLabel=function(rangeKey){const rk=normalizeRangeKeyForApi(rangeKey);if("today"===rk)return"Yesterday";if("yesterday"===rk)return"Day before";if("3d"===rk)return"Previous 3 days";if("7d"===rk)return"Previous 7 days";if("14d"===rk)return"Previous 14 days";if("30d"===rk)return"Previous 30 days";if("month"===rk)return"Previous month";if(/^d:\d{4}-\d{2}-\d{2}$/.test(rk))return"Previous day";if(/^r:\d{4}-\d{2}-\d{2}:\d{4}-\d{2}-\d{2}$/.test(rk)){var m=rk.match(/^r:(\d{4}-\d{2}-\d{2}):(\d{4}-\d{2}-\d{2})$/);if(m&&m[1]&&m[2])try{var a=Date.parse(m[1]+"T00:00:00Z"),b=Date.parse(m[2]+"T00:00:00Z");if(Number.isFinite(a)&&Number.isFinite(b)){var spanDays=Math.abs(Math.round((b-a)/864e5))+1;return spanDays<=1?"Previous day":"Previous "+String(spanDays)+" days"}}catch(_){}return"Previous period"}return"Previous period"}(kpiRange)}catch(_){primaryCompareLabel="Previous period"}var secondaryCompareLabel="";try{var sec=function(rangeKey){var rk=(null==rangeKey?"":String(rangeKey)).trim().toLowerCase();if(!rk)return null;var endYmd=null;try{endYmd=ymdNowInTz()}catch(_){endYmd=null}return endYmd&&/^\d{4}-\d{2}-\d{2}$/.test(String(endYmd))?"3d"===rk?{startYmd:ymdAddDays(endYmd,-2),endYmd:endYmd}:"7d"===rk?{startYmd:ymdAddDays(endYmd,-6),endYmd:endYmd}:"14d"===rk?{startYmd:ymdAddDays(endYmd,-13),endYmd:endYmd}:"30d"===rk?{startYmd:ymdAddDays(endYmd,-29),endYmd:endYmd}:"month"===rk?{startYmd:String(endYmd).slice(0,7)+"-01",endYmd:endYmd}:null:null}("7d");sec&&sec.startYmd&&sec.endYmd&&(secondaryCompareLabel=formatYmdRangeMonthDay(sec.startYmd,sec.endYmd))}catch(_){secondaryCompareLabel=""}if(secondaryCompareLabel||(secondaryCompareLabel="Previous 7 days"),function(primaryLabel,secondaryLabel,showSecondary){var p=String(primaryLabel||"Previous period").trim()||"Previous period",s=String(secondaryLabel||"Previous 7 days").trim()||"Previous 7 days";document.querySelectorAll(".dash-kpi-compare-row").forEach(function(row){if(row){var items=row.querySelectorAll(".dash-kpi-compare-item"),left=items&&items[0]?items[0]:null,right=items&&items[1]?items[1]:null;if(left){var leftLabel=left.querySelector(".text-muted.small");leftLabel&&(leftLabel.textContent=p+":")}if(right){right.classList.toggle("is-hidden",!showSecondary);var rightLabel=right.querySelector(".text-muted.small");rightLabel&&(rightLabel.textContent=s+":")}}})}(primaryCompareLabel,secondaryCompareLabel,showSecondary),showSecondary){var secondary=_dashKpisSecondary,secondaryExtras=_dashKpiExtrasSecondary,secondarySales=numFromMap(secondary,"sales","7d"),secondaryCost=numFromMap(secondary,"cost","7d"),secondaryProfit=numFromMap(secondary,"profit","7d");null==secondaryProfit&&null!=secondarySales&&null!=secondaryCost&&(secondaryProfit=round2Local(secondarySales-secondaryCost)),profitKpiAllowed||(secondaryProfit=null),renderCompareSlot("7d",{sales:secondarySales,profit:secondaryProfit,orders:numFromMap(secondary,"convertedCount","7d"),sessions:sessionsFromBreakdownMap(secondary,"7d"),conv:numFromMap(secondary,"conversion","7d"),vpv:numFromMap(secondary,"vpv","7d"),aov:numFromMap(secondary,"aov","7d"),bounce:numFromMap(secondary,"bounce","7d"),returning:numFromMap(secondary,"returningCustomerCount","7d"),roas:numFromMap(secondary,"roas","7d"),items:secondaryExtras&&"number"==typeof secondaryExtras.itemsSold?secondaryExtras.itemsSold:null,fulfilled:secondaryExtras&&"number"==typeof secondaryExtras.ordersFulfilled?secondaryExtras.ordersFulfilled:null,returns:secondaryExtras&&"number"==typeof secondaryExtras.returns?secondaryExtras.returns:null,cogs:secondaryExtras&&"number"==typeof secondaryExtras.cogs?secondaryExtras.cogs:null})}else renderCompareSlot("7d",{});
// Fetch optional secondary compare in background only when slot is visible.
showSecondary&&!_dashKpisSecondary&&ensureDashboardSecondaryKpis().then(function(){try{"dashboard"===PAGE&&renderDashboardKpisFromApi(primaryData)}catch(_){}}).catch(function(){}),showSecondary&&!_dashKpiExtrasSecondary&&ensureDashboardSecondaryExtras().then(function(){try{"dashboard"===PAGE&&renderDashboardKpisFromApi(primaryData)}catch(_){}}).catch(function(){}),
// Main extras are fetched on-demand from the selected range.
extrasMain||fetchExpandedKpiExtras({force:!1}).then(function(){try{"dashboard"===PAGE&&renderDashboardKpisFromApi(primaryData)}catch(_){}}).catch(function(){})}function numFromMap(dataObj,keyName,rangeKey){var map=dataObj&&dataObj[keyName]?dataObj[keyName]:null,v=map&&"number"==typeof map[rangeKey]?map[rangeKey]:null;return"number"==typeof v&&Number.isFinite(v)?v:null}function sessionsFromBreakdownMap(dataObj,rangeKey){var br=dataObj&&dataObj.trafficBreakdown?dataObj.trafficBreakdown:null,r=br&&br[rangeKey]?br[rangeKey]:null,v=r&&"number"==typeof r.human_sessions?r.human_sessions:null;return"number"==typeof v&&Number.isFinite(v)?v:null}function numFromCompare(compareObj,keyName){var v=compareObj&&"number"==typeof compareObj[keyName]?compareObj[keyName]:null;return"number"==typeof v&&Number.isFinite(v)?v:null}function round2Local(v){return"number"==typeof v&&Number.isFinite(v)?Math.round(100*v)/100:null}function setDashValueText(id,textValue){var node=el(id);node&&(null!=textValue&&""!==textValue?node.textContent=String(textValue):node.innerHTML='<span class="kpi-mini-spinner" aria-hidden="true"></span>')}function renderCompareSlot(slotSuffix,values){var sales=(values=values||{}).sales,profit=values.profit,orders=values.orders,sessions=values.sessions,conv=values.conv,vpv=values.vpv,aov=values.aov,bounce=values.bounce,returning=values.returning,roas=values.roas,items=values.items,fulfilled=values.fulfilled,returns=values.returns,cogs=values.cogs;setDashValueText("dash-revenue-"+slotSuffix,null!=sales?formatRevenue0(sales):"—"),setDashValueText("dash-profit-"+slotSuffix,null!=profit?formatRevenue0(profit):"—"),setDashValueText("dash-orders-"+slotSuffix,null!=orders?Math.round(orders).toLocaleString():"—"),setDashValueText("dash-sessions-"+slotSuffix,null!=sessions?formatSessions(sessions):"—"),setDashValueText("dash-conv-"+slotSuffix,null!=conv?pct(conv):"—"),setDashValueText("dash-vpv-"+slotSuffix,null!=vpv?formatRevenue(vpv):"—"),setDashValueText("dash-aov-"+slotSuffix,null!=aov?formatRevenue0(aov):"—"),setDashValueText("dash-bounce-"+slotSuffix,null!=bounce?pct(bounce):"—"),setDashValueText("dash-returning-"+slotSuffix,null!=returning?Math.round(returning).toLocaleString():"—"),setDashValueText("dash-roas-"+slotSuffix,null!=roas?roas.toFixed(2)+"x":"—"),setDashValueText("dash-items-"+slotSuffix,null!=items?Math.round(items).toLocaleString():"—"),setDashValueText("dash-fulfilled-"+slotSuffix,null!=fulfilled?Math.round(fulfilled).toLocaleString():"—"),setDashValueText("dash-returns-"+slotSuffix,null!=returns?formatNegativeCurrencyOrZero(returns,!0):"—"),setDashValueText("dash-cogs-"+slotSuffix,null!=cogs?formatRevenue0(cogs):"—")}function applyDashDelta(key,current,baseline,invert){var wrap=el("dash-kpi-"+key+"-delta"),textEl=el("dash-kpi-"+key+"-delta-text");if(wrap&&textEl){var cur="number"==typeof current&&Number.isFinite(current)?current:null,base="number"==typeof baseline&&Number.isFinite(baseline)?baseline:null,rawDelta=null!=cur&&null!=base?kpiDelta(cur,base):null,toneDelta=null;if(null!=cur&&null!=base){var diff=cur-base,denom=Math.abs(base);toneDelta=denom>1e-9?diff/denom:0===diff?0:diff>0?1:-1,invert&&(toneDelta=-toneDelta)}var isNew=0===base&&null!=cur&&0!==cur,isUp=isNew||null!=toneDelta&&toneDelta>KPI_STABLE_RATIO,isDown=!isNew&&null!=toneDelta&&toneDelta<-KPI_STABLE_RATIO,dir="none",text="—";null!=rawDelta&&(text=isNew?"new":formatSignedPercentOneDecimalFromRatio(rawDelta),dir=isUp?"up":isDown?"down":"flat");var forceNeutralTone=DASHBOARD_NEUTRAL_DELTA_KEYS.has(String(key||"").toLowerCase()),visualDir=forceNeutralTone&&"none"!==dir?"flat":dir;if(wrap.classList.remove("is-up","is-down","is-flat"),null==rawDelta)return wrap.classList.add("is-hidden"),wrap.setAttribute("data-dir","none"),void(textEl.textContent="—");wrap.classList.remove("is-hidden"),"up"===visualDir?wrap.classList.add("is-up"):"down"===visualDir?wrap.classList.add("is-down"):"flat"===visualDir&&wrap.classList.add("is-flat"),wrap.setAttribute("data-dir",visualDir),textEl.textContent=text;try{var dashDeltaStyle=getChartsKpiBundle("dashboardCards").deltaStyle,dashTone=forceNeutralTone?DASHBOARD_NEUTRAL_TONE_HEX:chartsKpiToneColor("dashboardCards","none"===visualDir?"same":visualDir);wrap.style.fontSize=String(dashDeltaStyle.fontSize)+"px",wrap.style.fontWeight=String(dashDeltaStyle.fontWeight),wrap.style.color=forceNeutralTone?DASHBOARD_NEUTRAL_TONE_HEX:dashDeltaStyle.fontColor||dashTone}catch(_){}var icon=wrap.querySelector?wrap.querySelector("i"):null;if(icon){var iconKey="dash-kpi-delta-up";"down"===visualDir?iconKey="dash-kpi-delta-down":"flat"===visualDir&&(iconKey="dash-kpi-delta-flat"),icon.setAttribute("data-icon-key",iconKey),icon.classList.remove("fa-arrow-trend-up","fa-arrow-trend-down","fa-minus"),"down"===visualDir?icon.classList.add("fa-arrow-trend-down"):"flat"===visualDir?icon.classList.add("fa-minus"):icon.classList.add("fa-arrow-trend-up");try{var dashDeltaStyleIcon=getChartsKpiBundle("dashboardCards").deltaStyle,dashToneIcon=forceNeutralTone?DASHBOARD_NEUTRAL_TONE_HEX:chartsKpiToneColor("dashboardCards","none"===visualDir?"same":visualDir);icon.style.fontSize=String(dashDeltaStyleIcon.iconSize)+"px",icon.style.color=forceNeutralTone?DASHBOARD_NEUTRAL_TONE_HEX:dashDeltaStyleIcon.iconColor||dashToneIcon}catch(_){}try{!forceNeutralTone&&window.KexoIconTheme&&"function"==typeof window.KexoIconTheme.applyElement&&window.KexoIconTheme.applyElement(icon)}catch(_){}}}}}
// Condensed KPI strip only (expanded overlay removed).
let _condensedOverflowRaf=0,_condensedStripResizeObserver=null;function updateCondensedKpiOverflow(){const strip=document.getElementById("kexo-condensed-kpis");if(!strip)return;const chips=Array.prototype.slice.call(strip.querySelectorAll(".kexo-kpi-chip")).filter(function(ch){return!ch||!ch.classList||!ch.classList.contains("is-user-disabled")});if(!chips.length)return;if(!(!window.matchMedia||!window.matchMedia("(max-width: 991.98px)").matches)){strip.style.removeProperty("--kexo-kpi-width"),strip.style.removeProperty("--kexo-kpi-min-width"),strip.style.setProperty("--kexo-kpi-spark-width","36px"),strip.style.setProperty("--kexo-kpi-spark-right","4px");for(let i=0;i<chips.length;i++)chips[i].classList.remove("is-hidden"),chips[i].setAttribute("aria-hidden","false");return}
// Auto-fit chips to available width; hide overflow chips from the end.
const avail=strip.clientWidth||0;if(!Number.isFinite(avail)||avail<=0)return;const stripStyle=window.getComputedStyle(strip),gapPx=parseFloat(stripStyle.columnGap||stripStyle.gap)||0,rootStyle=window.getComputedStyle(document.documentElement),configuredMin=parseFloat(rootStyle.getPropertyValue("--kexo-kpi-min-width"))||120,minWidth=Math.max(100,configuredMin);// never below 100; hide chips when below min
function widthFor(count){const n=Math.max(1,Number(count)||1),totalGap=gapPx*Math.max(0,n-1);return(avail-totalGap)/n}let visibleCount=chips.length,chipWidth=widthFor(visibleCount);for(;visibleCount>1&&chipWidth<minWidth;)visibleCount-=1,chipWidth=widthFor(visibleCount);
// If we can???t satisfy the floor (extremely narrow), show 1 chip at whatever width we have.
if(!Number.isFinite(chipWidth)||chipWidth<=0)return;const w=Math.max(0,Math.round(100*chipWidth)/100),wStr=String(w).replace(/\.0+$/,"");strip.style.setProperty("--kexo-kpi-width",wStr+"px"),strip.style.setProperty("--kexo-kpi-min-width",wStr+"px");
// Condensed sparkline sizing: shrink more aggressively on tight chips so the chart
// doesn't sit behind the label/value text when chips are auto-fit small.
const tight=w<=136,sparkRatio=tight?.24:.3,sparkW=Math.max(28,Math.min(45,Math.round(w*sparkRatio)));strip.style.setProperty("--kexo-kpi-spark-width",String(sparkW)+"px"),strip.style.setProperty("--kexo-kpi-spark-right",tight?"0px":"6px");for(let i=0;i<chips.length;i++){const show=i<visibleCount;chips[i].classList.toggle("is-hidden",!show),chips[i].setAttribute("aria-hidden",show?"false":"true")}}function scheduleCondensedKpiOverflowUpdate(){if(_condensedOverflowRaf)return;const raf="function"==typeof requestAnimationFrame?requestAnimationFrame:function(cb){return setTimeout(cb,16)};_condensedOverflowRaf=raf(function(){_condensedOverflowRaf=0,updateCondensedKpiOverflow()})}
// ?????? KPI + date range UI config (stored in /api/settings) ?????????????????????????????????????????????
var uiSettingsCache=null,uiSettingsFetchedAt=0,uiSettingsInFlight=null,kpiUiConfigV1=null,chartsUiConfigV1=null,_dashboardKpiResizeWired=!1,CHARTS_KPI_BUNDLE_KEYS=["dashboardCards","headerStrip","yearlySnapshot"];function readLocalStorageJsonMaybe(key){try{return safeReadLocalStorageJson(key)}catch(_){}try{var raw=localStorage.getItem(String(key||""));return raw?JSON.parse(raw):null}catch(_){return null}}var OVERVIEW_WIDGET_KEYS=["finishes","devices","browsers","abandoned","attribution","payment_methods"];function normalizeCssVarOverrideValue(raw){var v=null==raw?"":String(raw).trim();return v?v.length>80||/[;\r\n{}]/.test(v)?"":/^var\(--[a-zA-Z0-9._-]+\)$/.test(v)||/^#([0-9a-f]{3}|[0-9a-f]{6}|[0-9a-f]{8})$/i.test(v)||/^(rgb|hsl)a?\(/i.test(v)?v:"currentcolor"===v.toLowerCase()?"currentColor":"transparent"===v.toLowerCase()?"transparent":/^[a-z-]+$/i.test(v)?v:"":""}function normalizeOverviewWidgetsUiConfigV1(raw){var parsed=null;try{raw&&"object"==typeof raw?parsed=raw:"string"==typeof raw&&raw&&(parsed=JSON.parse(raw))}catch(_){parsed=null}var widgets,out=(widgets={},OVERVIEW_WIDGET_KEYS.forEach(function(key){widgets[key]={sortBy:"revenue",color:""}}),widgets.finishes=Object.assign({},widgets.finishes,{groupBy:"finishes"}),{v:1,order:OVERVIEW_WIDGET_KEYS.slice(),widgets:widgets});if(!parsed||"object"!=typeof parsed)return out;if(1!==Number(parsed.v))return out;try{if(Array.isArray(parsed.order)){var seen={},next=[];parsed.order.forEach(function(k){var key=(null==k?"":String(k)).trim().toLowerCase();key&&(OVERVIEW_WIDGET_KEYS.indexOf(key)<0||seen[key]||(seen[key]=!0,next.push(key)))}),next.length===OVERVIEW_WIDGET_KEYS.length&&(out.order=next)}}catch(_){}try{var w=parsed.widgets&&"object"==typeof parsed.widgets?parsed.widgets:null;w&&OVERVIEW_WIDGET_KEYS.forEach(function(key){var row=w[key]&&"object"==typeof w[key]?w[key]:null;if(row){if(null!=row.sortBy){var sb=String(row.sortBy||"").trim().toLowerCase();"revenue"!==sb&&"clicks"!==sb&&"ctr"!==sb||(out.widgets[key].sortBy=sb)}if(Object.prototype.hasOwnProperty.call(row,"color")&&(out.widgets[key].color=normalizeCssVarOverrideValue(row.color)||""),"finishes"===key&&null!=row.groupBy){var gb=String(row.groupBy||"").trim().toLowerCase();gb&&(out.widgets.finishes.groupBy=gb)}}})}catch(_){}return out}var _overviewWidgetsUiCfgSig="";function applyOverviewWidgetsUiConfigV1(cfg,opts){opts=opts&&"object"==typeof opts?opts:{};var next=normalizeOverviewWidgetsUiConfigV1(cfg),sig="";try{sig=JSON.stringify(next||null)||""}catch(_){sig=String(Date.now())}var changed=sig!==_overviewWidgetsUiCfgSig;if(_overviewWidgetsUiCfgSig=sig,changed)try{localStorage.setItem("kexo:overview_widgets_ui_config:v1",JSON.stringify(next))}catch(_){}if(changed&&!1!==opts.dispatch)try{document.dispatchEvent(new CustomEvent("kexo:overviewWidgetsUiConfigUpdated",{detail:{cfg:next}}))}catch(_){}return next}var _cssVarsApplied={},_cssVarOverridesSig="";function applyCssVarOverridesV1(cfg,opts){opts=opts&&"object"==typeof opts?opts:{};var next=function(raw){var parsed=null;try{raw&&"object"==typeof raw?parsed=raw:"string"==typeof raw&&raw&&(parsed=JSON.parse(raw))}catch(_){parsed=null}var out={v:1,vars:{}};if(!parsed||"object"!=typeof parsed)return out;if(1!==Number(parsed.v))return out;var vars=parsed.vars&&"object"==typeof parsed.vars?parsed.vars:null;if(!vars)return out;for(var next={},keys=Object.keys(vars),i=0;i<keys.length&&i<50;i++){var name=String(keys[i]||"").trim();if(/^--[a-zA-Z0-9._-]+$/.test(name)){var val=normalizeCssVarOverrideValue(vars[name]);val&&(next[name]=val)}}return out.vars=next,out}(cfg),sig="";try{sig=JSON.stringify(next||null)||""}catch(_){sig=String(Date.now())}var changed=sig!==_cssVarOverridesSig;if(_cssVarOverridesSig=sig,changed)try{localStorage.setItem("kexo:css_var_overrides:v1",JSON.stringify(next))}catch(_){}try{var root=document.documentElement,vars=next&&next.vars&&"object"==typeof next.vars?next.vars:{};Object.keys(_cssVarsApplied||{}).forEach(function(k){if(!Object.prototype.hasOwnProperty.call(vars,k))try{root.style.removeProperty(k)}catch(_){}}),Object.keys(vars).forEach(function(k){try{root.style.setProperty(k,String(vars[k]))}catch(_){}}),_cssVarsApplied=Object.assign({},vars)}catch(_){}if(changed&&!1!==opts.dispatch)try{document.dispatchEvent(new CustomEvent("kexo:cssVarOverridesUpdated",{detail:{cfg:next}}))}catch(_){}return next}function defaultChartsKpiBundlePalette(bundleKey){var same="#66bdb7";return"dashboardcards"===String(bundleKey||"").trim().toLowerCase()&&(same=cssVarColor("--kexo-accent-1","#4b94e4")),{up:"#2fb344",down:"#d63939",same:same,compareLine:"#cccccc"}}function defaultChartsKpiSparklineConfig(bundleKey){return"headerStrip"===bundleKey?{mode:"line",curve:"smooth",strokeWidth:2.15,height:30,showCompare:!1,advancedApexOverride:{}}:"yearlySnapshot"===bundleKey?{mode:"line",curve:"smooth",strokeWidth:2.55,height:56,showCompare:!1,advancedApexOverride:{}}:{mode:"line",curve:"straight",strokeWidth:2.55,height:50,showCompare:!0,compareUsePrimaryColor:!1,compareOpacity:50,advancedApexOverride:{}}}function defaultChartsKpiDeltaStyle(bundleKey){return"headerStrip"===bundleKey?{fontSize:11,fontWeight:500,iconSize:10,fontColor:"",iconColor:""}:"yearlySnapshot"===bundleKey?{fontSize:12,fontWeight:500,iconSize:12,fontColor:"",iconColor:""}:{fontSize:14,fontWeight:500,iconSize:12,fontColor:"",iconColor:""}}function isPlainObject(value){return!!value&&"[object Object]"===Object.prototype.toString.call(value)}function deepMergeOptions(base,override){return isPlainObject(base)&&isPlainObject(override)?(Object.keys(override).forEach(function(key){var next=override[key];if(Array.isArray(next))base[key]=next.slice();else if(isPlainObject(next)){var cur=isPlainObject(base[key])?base[key]:{};base[key]=deepMergeOptions(cur,next)}else base[key]=next}),base):base}function normalizeHexColorStrict(v,fallback){var raw=null==v?"":String(v).trim().toLowerCase();return/^#[0-9a-f]{6}$/.test(raw)?raw:fallback}function normalizeOptionalHexColorStrict(v){var raw=null==v?"":String(v).trim().toLowerCase();return raw&&/^#[0-9a-f]{6}$/.test(raw)?raw:""}function normalizeChartsKpiBundle(bundleKey,rawBundle){var src=rawBundle&&"object"==typeof rawBundle?rawBundle:{},def=function(bundleKey){return{sparkline:defaultChartsKpiSparklineConfig(bundleKey),deltaStyle:defaultChartsKpiDeltaStyle(bundleKey),palette:defaultChartsKpiBundlePalette(bundleKey)}}(bundleKey),spark=src.sparkline&&"object"==typeof src.sparkline?src.sparkline:{},delta=src.deltaStyle&&"object"==typeof src.deltaStyle?src.deltaStyle:{},palette=src.palette&&"object"==typeof src.palette?src.palette:{},mode=String(spark.mode||def.sparkline.mode).trim().toLowerCase();["line","area","bar"].indexOf(mode)<0&&(mode=def.sparkline.mode);var curve=String(spark.curve||def.sparkline.curve).trim().toLowerCase();["smooth","straight","stepline"].indexOf(curve)<0&&(curve=def.sparkline.curve);var strokeWidth=Number(spark.strokeWidth);Number.isFinite(strokeWidth)||(strokeWidth=Number(def.sparkline.strokeWidth)),strokeWidth=Math.max(.5,Math.min(6,strokeWidth));var height=Number(spark.height);Number.isFinite(height)||(height=Number(def.sparkline.height)),height=Math.max(18,Math.min(120,Math.round(height)));var fontSize=Number(delta.fontSize);Number.isFinite(fontSize)||(fontSize=Number(def.deltaStyle.fontSize)),fontSize=Math.max(9,Math.min(24,Math.round(fontSize)));var iconSize=Number(delta.iconSize);Number.isFinite(iconSize)||(iconSize=Number(def.deltaStyle.iconSize)),iconSize=Math.max(8,Math.min(24,Math.round(iconSize)));var fontWeight=parseInt(String(null!=delta.fontWeight?delta.fontWeight:def.deltaStyle.fontWeight),10);400!==fontWeight&&500!==fontWeight&&(fontWeight=def.deltaStyle.fontWeight);var supportsCompare="dashboardCards"===bundleKey,compareUsePrimaryColor=!!supportsCompare&&!1!==spark.compareUsePrimaryColor,compareOpacity=Number(spark.compareOpacity);Number.isFinite(compareOpacity)||(compareOpacity=50),compareOpacity=Math.max(0,Math.min(100,Math.round(compareOpacity)));var out={sparkline:{mode:mode,curve:curve,strokeWidth:strokeWidth,height:height,showCompare:!!supportsCompare&&!(!1===spark.showCompare),compareUsePrimaryColor:compareUsePrimaryColor,compareOpacity:compareOpacity,advancedApexOverride:isPlainObject(spark.advancedApexOverride)?spark.advancedApexOverride:{}},deltaStyle:{fontSize:fontSize,fontWeight:fontWeight,iconSize:iconSize,fontColor:normalizeOptionalHexColorStrict(delta.fontColor||""),iconColor:normalizeOptionalHexColorStrict(delta.iconColor||"")},palette:{up:normalizeHexColorStrict(palette.up,def.palette.up),down:normalizeHexColorStrict(palette.down,def.palette.down),same:normalizeHexColorStrict(palette.same,def.palette.same),compareLine:normalizeHexColorStrict(palette.compareLine,def.palette.compareLine)}};"dashboardCards"===bundleKey&&("#66bdb7"===String(out.palette.same||"").trim().toLowerCase()&&(out.palette.same=cssVarColor("--kexo-accent-1","#4b94e4")));return out}function getChartsKpiBundle(bundleKey){var key=String(bundleKey||"").trim();CHARTS_KPI_BUNDLE_KEYS.indexOf(key)<0&&(key="dashboardCards");var cfg=chartsUiConfigV1;
// Guardrail: KPI sparkline/palette/delta style is user-managed in Settings ??? Layout ??? Charts.
// Keep runtime reading from charts_ui_config_v1; do not hardcode replacement colors/sizes here.
return normalizeChartsKpiBundle(key,cfg&&1===cfg.v&&cfg.kpiBundles&&"object"==typeof cfg.kpiBundles?cfg.kpiBundles[key]:null)}function chartsKpiToneColor(bundleKey,dir){var key=String(bundleKey||"").trim(),prefix="dashboard";"headerStrip"===key?prefix="header":"yearlySnapshot"===key&&(prefix="snapshot");var d=String(dir||"").toLowerCase(),tone="down"===d?"down":"up"===d?"up":"same",sectionVar=cssVarColor("--kexo-"+prefix+"-kpi-"+tone,"");return sectionVar||function(dir){const d=String(dir||"").toLowerCase();return"up"===d?cssVarColor("--kexo-kpi-delta-up",cssVarColor("--kexo-accent-2","#3eb3ab")):"down"===d?cssVarColor("--kexo-kpi-delta-down",cssVarColor("--kexo-accent-4","#e4644b")):cssVarColor("--kexo-kpi-delta-same",cssVarColor("--kexo-accent-1","#4b94e4"))}(tone)}
// Hydrate KPI prefs from localStorage so disabled KPIs are hidden on first paint.
try{var cachedKpis=safeReadLocalStorageJson("kexo:kpi-ui-config:v1");if(cachedKpis&&1===cachedKpis.v&&cachedKpis.kpis){kpiUiConfigV1=cachedKpis;try{window.__kexoKpiUiConfigV1=cachedKpis}catch(_){}}}catch(_){}
// Hydrate chart prefs from localStorage so first paint uses the last saved config.
try{var cachedCharts=safeReadLocalStorageJson("kexo:charts-ui-config:v1");if(cachedCharts&&1===cachedCharts.v&&Array.isArray(cachedCharts.charts)){chartsUiConfigV1=cachedCharts;try{window.__kexoChartsUiConfigV1=cachedCharts}catch(_){}}}catch(_){}
// Hydrate Overview widget prefs + CSS var overrides from localStorage for first paint.
try{var cachedOvw=readLocalStorageJsonMaybe("kexo:overview_widgets_ui_config:v1");cachedOvw&&1===cachedOvw.v&&applyOverviewWidgetsUiConfigV1(normalizeOverviewWidgetsUiConfigV1(cachedOvw),{dispatch:!1})}catch(_){}try{var cachedCssVars=readLocalStorageJsonMaybe("kexo:css_var_overrides:v1");cachedCssVars&&1===cachedCssVars.v&&applyCssVarOverridesV1(cachedCssVars,{dispatch:!1})}catch(_){}function isChartsMobileViewport(){try{return!(!window.matchMedia||!window.matchMedia("(max-width: 991.98px)").matches)}catch(_){return!1}}function shouldHideChartsOnMobile(){var cfg=chartsUiConfigV1;
// Default ON when config is missing/outdated (requested project policy).
return!cfg||"object"!=typeof cfg||1!==cfg.v||!1!==cfg.hideOnMobile}function applyHideChartsOnMobileClass(){var root=null;try{root=document.documentElement}catch(_){root=null}if(root&&root.classList){var on=shouldHideChartsOnMobile(),mobile=isChartsMobileViewport();root.classList.toggle("kexo-hide-charts-mobile",!(!on||!mobile))}}try{applyHideChartsOnMobileClass();var onResize=kexoThrottle(function(){try{applyHideChartsOnMobileClass()}catch(_){}},120);window.addEventListener("resize",onResize,{passive:!0});try{kexoRegisterCleanup(function(){try{window.removeEventListener("resize",onResize)}catch(_){}try{onResize&&onResize.cancel&&onResize.cancel()}catch(_){}})}catch(_){}}catch(_){}function getChartsUiItem(key){var cfg=chartsUiConfigV1;if(!cfg||1!==cfg.v||!Array.isArray(cfg.charts))return null;var k=String(null==key?"":key).trim().toLowerCase();if(!k)return null;for(var i=0;i<cfg.charts.length;i++){var it=cfg.charts[i];if(it&&"object"==typeof it){var ik=null!=it.key?String(it.key).trim().toLowerCase():"";if(ik&&ik===k)return it}}return null}function isChartEnabledByUiConfig(key,fallbackEnabled){if(shouldHideChartsOnMobile()&&isChartsMobileViewport())return!1;var it=getChartsUiItem(key);return(!it||!1!==it.enabled)&&!1!==fallbackEnabled}function chartModeFromUiConfig(key,fallbackMode){var k=String(null==key?"":key).trim().toLowerCase(),it=getChartsUiItem(k),m=it&&null!=it.mode?String(it.mode).trim().toLowerCase():"";return"live-online-chart"===k||"countries-map-chart"===k?"map-animated":function(key,mode,fallbackMode){var fb=String(fallbackMode||"").trim().toLowerCase()||"area",m=String(mode||"").trim().toLowerCase();m||(m=fb);try{if("function"==typeof window.kexoChartMeta){var meta=window.kexoChartMeta(key),allowed=meta&&Array.isArray(meta.modes)?meta.modes.map(function(v){return String(v).trim().toLowerCase()}):[];if(allowed.length&&allowed.indexOf(m)<0)return allowed.indexOf(fb)>=0?fb:meta&&meta.defaultMode?String(meta.defaultMode).trim().toLowerCase():allowed[0]}}catch(_){}return m||fb}(k,m||fallbackMode,fallbackMode)}function chartColorsFromUiConfig(key,fallbackColors){var it=getChartsUiItem(key),arr=it&&Array.isArray(it.colors)?it.colors.filter(Boolean).map(function(c){return String(c).trim()}).filter(Boolean):[];return arr.length?arr:Array.isArray(fallbackColors)?fallbackColors:[]}function chartSizePercentFromUiConfig(key,fallbackPercent){var k=String(key||"").trim().toLowerCase();if("live-online-chart"===k||"countries-map-chart"===k)return 100;var it=getChartsUiItem(key),n=it&&null!=it.sizePercent?Number(it.sizePercent):Number(fallbackPercent);return Number.isFinite(n)||(n=100),(n=5*Math.round(n/5))<25&&(n=25),n>100&&(n=100),n}function chartPieMetricFromUiConfig(key,fallbackMetric){var it=getChartsUiItem(key),raw=it&&null!=it.pieMetric?String(it.pieMetric).trim().toLowerCase():"";if("sessions"===raw||"orders"===raw||"revenue"===raw)return raw;var fb=String(fallbackMetric||"sessions").trim().toLowerCase();return"sessions"===fb||"orders"===fb||"revenue"===fb?fb:"sessions"}function chartStyleFromUiConfig(key){var it=getChartsUiItem(key);return function(raw){var src=isPlainObject(raw)?raw:{},def={curve:"smooth",strokeWidth:2.6,dashArray:0,markerSize:3,fillOpacity:.18,gridDash:3,dataLabels:"auto",toolbar:!1,animations:!1,icons:!1,radialCenterLabel:!0,pieDonut:!1,pieDonutSize:66,pieLabelPosition:"auto",pieLabelContent:"percent",pieLabelOffset:16,pieCountryFlags:!1,mapShowTooltip:!0,mapDraggable:!0,mapZoomButtons:!0,mapShowEmptyCaption:!0,mapFit:"cover",mapInactiveOpacity:.09,mapInactiveColor:"",mapStageBrowseColor:"",mapStageCartColor:"",mapStageCheckoutColor:"",mapStagePurchaseColor:"",mapMetric:"auto"},curve=String(null!=src.curve?src.curve:def.curve).trim().toLowerCase();"smooth"!==curve&&"straight"!==curve&&"stepline"!==curve&&(curve=def.curve);var dataLabels=String(null!=src.dataLabels?src.dataLabels:def.dataLabels).trim().toLowerCase();"auto"!==dataLabels&&"on"!==dataLabels&&"off"!==dataLabels&&(dataLabels=def.dataLabels);var pieLabelPosition=String(null!=src.pieLabelPosition?src.pieLabelPosition:def.pieLabelPosition).trim().toLowerCase();"auto"!==pieLabelPosition&&"inside"!==pieLabelPosition&&"outside"!==pieLabelPosition&&(pieLabelPosition=def.pieLabelPosition);var pieLabelContent=String(null!=src.pieLabelContent?src.pieLabelContent:def.pieLabelContent).trim().toLowerCase();"percent"!==pieLabelContent&&"label"!==pieLabelContent&&"label_percent"!==pieLabelContent&&(pieLabelContent=def.pieLabelContent);var x,v,icons=!0===src.icons||!1!==src.icons&&!0===def.icons;function n(v,fb,min,max){var x=Number(v);return Number.isFinite(x)||(x=Number(fb)),Number.isFinite(x)||(x=min),x<min&&(x=min),x>max&&(x=max),x}return{curve:curve,strokeWidth:n(src.strokeWidth,def.strokeWidth,0,8),dashArray:n(src.dashArray,def.dashArray,0,20),markerSize:n(src.markerSize,def.markerSize,0,12),fillOpacity:n(src.fillOpacity,def.fillOpacity,0,1),gridDash:n(src.gridDash,def.gridDash,0,16),dataLabels:dataLabels,toolbar:!!src.toolbar,animations:!0===src.animations,icons:icons,radialCenterLabel:!1!==src.radialCenterLabel,pieDonut:!!src.pieDonut,pieDonutSize:Math.round(n(src.pieDonutSize,def.pieDonutSize,30,90)),pieLabelPosition:pieLabelPosition,pieLabelContent:pieLabelContent,pieLabelOffset:Math.round(n(src.pieLabelOffset,def.pieLabelOffset,-40,40)),pieCountryFlags:!!src.pieCountryFlags,mapShowTooltip:!1!==src.mapShowTooltip,mapDraggable:!1!==src.mapDraggable,mapZoomButtons:!1!==src.mapZoomButtons,mapShowEmptyCaption:!1!==src.mapShowEmptyCaption,mapFit:(v=String(null!=src.mapFit?src.mapFit:def.mapFit).trim().toLowerCase(),"cover"===v||"contain"===v?v:def.mapFit),mapInactiveOpacity:(x=Number(src.mapInactiveOpacity),Number.isFinite(x)||(x=Number(def.mapInactiveOpacity)),Number.isFinite(x)||(x=.09),Math.max(0,Math.min(1,x))),mapInactiveColor:normalizeOptionalHexColorStrict(src.mapInactiveColor),mapStageBrowseColor:normalizeOptionalHexColorStrict(src.mapStageBrowseColor),mapStageCartColor:normalizeOptionalHexColorStrict(src.mapStageCartColor),mapStageCheckoutColor:normalizeOptionalHexColorStrict(src.mapStageCheckoutColor),mapStagePurchaseColor:normalizeOptionalHexColorStrict(src.mapStagePurchaseColor),mapMetric:["auto","revenue","orders"].indexOf(String(null!=src.mapMetric?src.mapMetric:def.mapMetric).trim().toLowerCase())>=0?String(null!=src.mapMetric?src.mapMetric:def.mapMetric).trim().toLowerCase():"auto"}}((it&&isPlainObject(it.style)?it.style:null)||{})}function chartAdvancedOverrideFromUiConfig(key,modeHint){var it=getChartsUiItem(key),raw=it&&it.advancedApexOverride&&"object"==typeof it.advancedApexOverride?it.advancedApexOverride:null,merged={},styleOverride=function(key,modeHint){var mode=normalizeChartType(String(modeHint||"").trim().toLowerCase()||"line","line");if("map-animated"===mode)return null;var style=chartStyleFromUiConfig(key),out={chart:{toolbar:{show:!!style.toolbar},animations:{enabled:!!style.animations}},grid:{strokeDashArray:style.gridDash}};if("on"===style.dataLabels&&(out.dataLabels={enabled:!0}),"off"===style.dataLabels&&(out.dataLabels={enabled:!1}),"pie"===mode){var labelOffset="outside"===style.pieLabelPosition?Math.max(4,style.pieLabelOffset):"inside"===style.pieLabelPosition?Math.min(0,style.pieLabelOffset):style.pieLabelOffset;out.plotOptions={pie:{dataLabels:{offset:labelOffset}}},style.pieDonut&&(out.plotOptions.pie.donut={size:String(Math.max(30,Math.min(90,Number(style.pieDonutSize)||66)))+"%"})}else"radialbar"===mode?("on"!==style.dataLabels&&"off"!==style.dataLabels||(out.plotOptions=out.plotOptions||{},out.plotOptions.radialBar=out.plotOptions.radialBar||{},out.plotOptions.radialBar.dataLabels=out.plotOptions.radialBar.dataLabels||{},out.plotOptions.radialBar.dataLabels.value=out.plotOptions.radialBar.dataLabels.value||{},out.plotOptions.radialBar.dataLabels.value.show="on"===style.dataLabels),out.fill={opacity:style.fillOpacity>0?style.fillOpacity:1}):(out.stroke={show:!0,curve:style.curve,width:"bar"===mode?0:style.strokeWidth,lineCap:"round",dashArray:"bar"===mode?0:style.dashArray},out.markers={size:"line"===mode?style.markerSize:0,hover:{size:Math.max(4,style.markerSize+2)}},"area"===mode?out.fill={type:"gradient",gradient:{shadeIntensity:1,opacityFrom:style.fillOpacity,opacityTo:Math.max(0,.35*style.fillOpacity),stops:[0,100]}}:"bar"===mode&&(out.fill={type:"solid",opacity:style.fillOpacity>0?style.fillOpacity:1}));return out}(key,modeHint);return styleOverride&&isPlainObject(styleOverride)&&deepMergeOptions(merged,styleOverride),isPlainObject(raw)&&deepMergeOptions(merged,raw),Object.keys(merged).length?merged:null}function chartUiConfigSignature(cfg){try{return JSON.stringify(cfg||null)}catch(_){return""}}function applyChartsUiConfigV1(cfg){if(!cfg||"object"!=typeof cfg||1!==cfg.v||!Array.isArray(cfg.charts))return!1;var prevSig=chartUiConfigSignature(chartsUiConfigV1),nextSig=chartUiConfigSignature(cfg);chartsUiConfigV1=cfg;try{window.__kexoChartsUiConfigV1=cfg}catch(_){}try{safeWriteLocalStorageJson("kexo:charts-ui-config:v1",cfg)}catch(_){}try{applyHideChartsOnMobileClass()}catch(_){}return prevSig!==nextSig}var chartsUiReRenderTimer=null;function scheduleChartsUiReRender(){if(chartsUiReRenderTimer)try{clearTimeout(chartsUiReRenderTimer)}catch(_){}chartsUiReRenderTimer=setTimeout(function(){chartsUiReRenderTimer=null;try{if("dashboard"===activeMainTab)return void("function"==typeof refreshDashboard&&refreshDashboard({force:!0}));if("stats"===activeMainTab)return void refreshStats({force:!0});if("products"===activeMainTab)return void refreshProducts({force:!0});if("attribution"===activeMainTab){try{refreshAttribution({force:!0})}catch(_){}return}if("devices"===activeMainTab){try{refreshDevices({force:!0})}catch(_){}return}if("browsers"===activeMainTab){try{refreshBrowsers({force:!0})}catch(_){}return}if("ads"===activeMainTab)return void(window.__adsRefresh&&window.__adsRefresh({force:!0}));if("spy"===activeMainTab||"sales"===activeMainTab||"date"===activeMainTab)return void fetchSessions()}catch(_){}},80)}var tablesUiApplyTimer=null;function scheduleTablesUiApply(){if(tablesUiApplyTimer)try{clearTimeout(tablesUiApplyTimer)}catch(_){}tablesUiApplyTimer=setTimeout(function(){tablesUiApplyTimer=null;try{applyTablesUiLayoutForPage()}catch(_){}try{window.dispatchEvent(new CustomEvent("kexo:tablesUiConfigApplied",{detail:{v:1}}))}catch(_){}},80)}function applyCondensedKpiUiConfig(cfg){var strip=document.getElementById("kexo-condensed-kpis");if(strip&&cfg&&1===cfg.v){var list=cfg&&cfg.kpis&&Array.isArray(cfg.kpis.header)?cfg.kpis.header:null;if(list){var idByKey={orders:"cond-kpi-orders",revenue:"cond-kpi-revenue",profit:"cond-kpi-profit",conv:"cond-kpi-conv",vpv:"cond-kpi-vpv",roas:"cond-kpi-roas",sessions:"cond-kpi-sessions",returning:"cond-kpi-returning",aov:"cond-kpi-aov",cogs:"cond-kpi-cogs",bounce:"cond-kpi-bounce",fulfilled:"cond-kpi-orders-fulfilled",returns:"cond-kpi-returns",items:"cond-kpi-items-sold"},chipByKey={};Object.keys(idByKey).forEach(function(key){var valueEl=document.getElementById(idByKey[key]),chip=valueEl&&valueEl.closest?valueEl.closest(".kexo-kpi-chip"):null;chip&&(chipByKey[key]=chip)});var allChips=Array.prototype.slice.call(strip.querySelectorAll(".kexo-kpi-chip")),seen=new Set,frag=document.createDocumentFragment();list.forEach(function(item){if(item&&"object"==typeof item){var key=null!=item.key?String(item.key).trim().toLowerCase():"";if(key){var chip=chipByKey[key]||null;if(chip){var labelEl=chip.querySelector?chip.querySelector(".kexo-kpi-chip-label"):null;if(labelEl&&null!=item.label){var lbl=String(item.label).trim();lbl&&(labelEl.textContent=lbl)}var enabled=!1!==item.enabled;"profit"!==key||runtimeProfitKpiAllowed||(enabled=!1),chip.classList.toggle("is-user-disabled",!enabled),frag.appendChild(chip),seen.add(chip)}}}}),allChips.forEach(function(chip){if(chip&&!seen.has(chip)){try{!(!chip.querySelector||!chip.querySelector("#cond-kpi-profit"))&&chip.classList.toggle("is-user-disabled",!runtimeProfitKpiAllowed)}catch(_){}frag.appendChild(chip)}}),strip.appendChild(frag),scheduleCondensedKpiOverflowUpdate();
// Options: hide/show common elements via inline style so other logic doesn't flip them back.
var opt=cfg.options&&cfg.options.condensed?cfg.options.condensed:{},showDelta=!1!==opt.showDelta,showProgress=!1!==opt.showProgress,showSparkline=!1!==opt.showSparkline;strip.querySelectorAll(".kexo-kpi-chip").forEach(function(chip){if(chip){var deltaEl=chip.querySelector?chip.querySelector(".kexo-kpi-chip-delta"):null,progEl=chip.querySelector?chip.querySelector(".kexo-kpi-chip-progress"):null,sparkEl=chip.querySelector?chip.querySelector(".kexo-kpi-chip-sparkline"):null;deltaEl&&(deltaEl.style.display=showDelta?"":"none"),progEl&&(progEl.style.display=showProgress?"":"none"),sparkEl&&(sparkEl.style.display=showSparkline?"":"none")}})}}}function applyDashboardKpiUiConfig(cfg){var grid=document.getElementById("dash-kpi-grid"),midGrid=document.getElementById("dash-kpi-grid-mid"),lowerGrid=document.getElementById("dash-kpi-grid-lower");if(grid&&midGrid&&lowerGrid){var list=cfg&&1===cfg.v&&cfg.kpis&&Array.isArray(cfg.kpis.dashboard)?cfg.kpis.dashboard:null,topCap=4,desktop=!1;try{(desktop=!!(window&&window.matchMedia&&window.matchMedia("(min-width: 1200px)").matches))&&(topCap=4)}catch(_){}var topVisibleCount=0,midVisibleCount=0,idByKey={revenue:"dash-kpi-revenue",profit:"dash-kpi-profit",orders:"dash-kpi-orders",conv:"dash-kpi-conv",vpv:"dash-kpi-vpv",aov:"dash-kpi-aov",sessions:"dash-kpi-sessions",bounce:"dash-kpi-bounce",returning:"dash-kpi-returning",roas:"dash-kpi-roas",cogs:"dash-kpi-cogs",fulfilled:"dash-kpi-fulfilled",returns:"dash-kpi-returns",items:"dash-kpi-items",kexo_score:"dash-kpi-kexo-score"},colByKey={},keyByCol=new Map;Object.keys(idByKey).forEach(function(key){var valueEl=document.getElementById(idByKey[key]),col=valueEl&&valueEl.closest?valueEl.closest(".col-sm-6"):null;col&&(colByKey[key]=col,keyByCol.set(col,key))});var allColsPrimary=Array.prototype.slice.call(grid.children||[]).filter(function(el){return el&&el.classList&&el.classList.contains("col-sm-6")}),allColsMid=Array.prototype.slice.call(midGrid.children||[]).filter(function(el){return el&&el.classList&&el.classList.contains("col-sm-6")}),allColsLower=lowerGrid?Array.prototype.slice.call(lowerGrid.children||[]).filter(function(el){return el&&el.classList&&el.classList.contains("col-sm-6")}):[],allCols=allColsPrimary.concat(allColsMid).concat(allColsLower),seen=new Set,fragPrimary=document.createDocumentFragment(),fragMid=document.createDocumentFragment(),fragLower=document.createDocumentFragment();list&&list.length>0?(list.forEach(function(item){if(item&&"object"==typeof item){var key=null!=item.key?String(item.key).trim().toLowerCase():"";if(key){var col=colByKey[key]||null;if(col){var labelEl=col.querySelector?col.querySelector(".subheader"):null;if(labelEl&&null!=item.label){var lbl=String(item.label).trim();lbl&&(labelEl.textContent=lbl)}var enabled=!1!==item.enabled;"profit"!==key||runtimeProfitKpiAllowed||(enabled=!1),col.classList.toggle("is-user-disabled",!enabled);var bucket=chooseBucket(key,enabled);"top"===bucket?fragPrimary.appendChild(col):"mid"===bucket?fragMid.appendChild(col):fragLower.appendChild(col),seen.add(col)}}}}),allCols.forEach(function(col){if(col&&!seen.has(col)){var key=keyByCol&&keyByCol.get&&keyByCol.get(col)||"",enabled=!("profit"===key&&!runtimeProfitKpiAllowed);col.classList.toggle("is-user-disabled",!enabled);var bucket=chooseBucket(key,enabled);"top"===bucket?fragPrimary.appendChild(col):"mid"===bucket?fragMid.appendChild(col):fragLower.appendChild(col)}})):(["revenue","profit","orders","conv","vpv","aov","sessions","bounce","returning","roas","kexo_score","cogs","fulfilled","returns","items"].forEach(function(key){var col=colByKey[key];if(col&&!seen.has(col)){var enabled=!("profit"===key&&!runtimeProfitKpiAllowed);col.classList.toggle("is-user-disabled",!enabled);var bucket=chooseBucket(key,enabled);"top"===bucket?fragPrimary.appendChild(col):"mid"===bucket?fragMid.appendChild(col):fragLower.appendChild(col),seen.add(col)}}),allCols.forEach(function(col){if(col&&!seen.has(col)){var key=keyByCol&&keyByCol.get&&keyByCol.get(col)||"",enabled=!("profit"===key&&!runtimeProfitKpiAllowed);col.classList.toggle("is-user-disabled",!enabled);var bucket=chooseBucket(key,enabled);"top"===bucket?fragPrimary.appendChild(col):"mid"===bucket?fragMid.appendChild(col):fragLower.appendChild(col)}})),grid.appendChild(fragPrimary),midGrid.appendChild(fragMid),lowerGrid.appendChild(fragLower);var showDelta=!(cfg&&cfg.options&&cfg.options.dashboard&&!1===cfg.options.dashboard.showDelta),deltaEls=Array.prototype.slice.call(grid.querySelectorAll(".dash-kpi-delta"));deltaEls=deltaEls.concat(Array.prototype.slice.call(midGrid.querySelectorAll(".dash-kpi-delta"))),lowerGrid&&(deltaEls=deltaEls.concat(Array.prototype.slice.call(lowerGrid.querySelectorAll(".dash-kpi-delta")))),deltaEls.forEach(function(el){el&&(el.style.display=showDelta?"":"none")})}function chooseBucket(key,enabled){return enabled?function(key){
// Keep special/tall KPI cards out of the top+mid layout so the left KPI stacks
// align exactly with the 4 overview charts on the right (4 top, 4 mid).
var k=null!=key?String(key).trim().toLowerCase():"";return!!desktop&&"kexo_score"===k}(key)?"lower":topVisibleCount<topCap?(topVisibleCount+=1,"top"):midVisibleCount<4?(midVisibleCount+=1,"mid"):"lower":"lower"}}function ensureDateRangeAllowedByUiConfig(){var cfg=kpiUiConfigV1;if(cfg&&1===cfg.v&&Array.isArray(cfg.dateRanges)&&function(key){var k=null!=key?String(key).trim().toLowerCase():"";return"today"===k||"yesterday"===k||"7days"===k||"14days"===k||"30days"===k||"custom"===k}(dateRange)&&"today"!==dateRange&&"custom"!==dateRange){var key=String(dateRange||"").trim().toLowerCase(),item=cfg.dateRanges.find(function(it){return it&&"object"==typeof it&&String(it.key||"").trim().toLowerCase()===key})||null;if(item&&!1===item.enabled){dateRange="today";try{syncDateSelectOptions()}catch(_){}try{applyDateRangeChange()}catch(_){}}}}function applyKpiUiConfigV1(cfg){if(cfg&&"object"==typeof cfg&&1===cfg.v){cfg.headerStrip&&"object"==typeof cfg.headerStrip.pages?cfg.headerStrip.pages.dashboard=!0:cfg.headerStrip?(cfg.headerStrip.pages=cfg.headerStrip.pages||{},cfg.headerStrip.pages.dashboard=!0):cfg.headerStrip={pages:{dashboard:!0}},kpiUiConfigV1=cfg;try{window.__kexoKpiUiConfigV1=cfg}catch(_){}try{safeWriteLocalStorageJson("kexo:kpi-ui-config:v1",cfg)}catch(_){}try{!function(cfg){try{var bar=document.getElementById("kexo-kpis");if(!bar||!cfg||1!==cfg.v)return;var page="";try{page=String(document.body&&document.body.getAttribute?document.body.getAttribute("data-page"):"").trim().toLowerCase()}catch(_){page=""}if(!page)return;var pages=cfg&&cfg.headerStrip&&cfg.headerStrip.pages&&"object"==typeof cfg.headerStrip.pages?cfg.headerStrip.pages:null;if(!pages)return;!1===pages[page]?bar.style.display="none":bar.style.display=""}catch(_){}}(cfg)}catch(_){}try{applyCondensedKpiUiConfig(cfg)}catch(_){}try{applyDashboardKpiUiConfig(cfg)}catch(_){}if(!_dashboardKpiResizeWired){_dashboardKpiResizeWired=!0;try{var onResize=kexoDebounce(function(){try{kpiUiConfigV1&&1===kpiUiConfigV1.v&&applyDashboardKpiUiConfig(kpiUiConfigV1)}catch(_){}},120);window.addEventListener("resize",onResize,{passive:!0});try{kexoRegisterCleanup(function(){try{window.removeEventListener("resize",onResize)}catch(_){}try{onResize&&onResize.cancel&&onResize.cancel()}catch(_){}})}catch(_){}}catch(_){}}try{syncDateSelectOptions()}catch(_){}try{ensureDateRangeAllowedByUiConfig()}catch(_){}}}
// Apply cached KPI settings immediately (before async /api/settings returns).
try{kpiUiConfigV1&&applyKpiUiConfigV1(kpiUiConfigV1)}catch(_){}try{window.__applyDashboardKpiUiConfig=function(){applyDashboardKpiUiConfig(kpiUiConfigV1||null)}}catch(_){}try{window.addEventListener("kexo:kpiUiConfigUpdated",function(e){var cfg=e&&e.detail?e.detail:null;try{applyKpiUiConfigV1(cfg)}catch(_){}})}catch(_){}try{window.addEventListener("kexo:chartsUiConfigUpdated",function(e){var cfg=e&&e.detail?e.detail:null;try{applyChartsUiConfigV1(cfg)&&scheduleChartsUiReRender()}catch(_){}})}catch(_){}try{window.addEventListener("kexo:tablesUiConfigUpdated",function(e){var cfg=e&&e.detail?e.detail:null;try{applyTablesUiConfigV1(cfg),scheduleTablesUiApply()}catch(_){}})}catch(_){}let kpiExpandedExtrasCache=null,kpiExpandedExtrasRange=null,kpiExpandedExtrasFetchedAt=0,kpiExpandedExtrasInFlight=null;function fetchExpandedKpiExtras(options={}){const force=!!options.force,rangeKey=getStatsRange();if(!rangeKey)return Promise.resolve(null);
// Paint from localStorage first to avoid empty KPI boxes on fast navigation.
if(!force)try{(!kpiExpandedExtrasCache||kpiExpandedExtrasRange!==rangeKey||!kpiExpandedExtrasFetchedAt||Date.now()-kpiExpandedExtrasFetchedAt>18e5)&&function(rangeKey,allowStale){const entry=getRangeCacheEntry("kexo-kpis-expanded-extra-cache-v1",rangeKey);if(!entry)return!1;const age=Date.now()-entry.at;if(!Number.isFinite(age)||age<0)return!1;!(age>(allowStale?36e5:18e5))&&(kpiExpandedExtrasCache=entry.data||null,kpiExpandedExtrasRange=rangeKey,kpiExpandedExtrasFetchedAt=entry.at)}(rangeKey,!0)}catch(_){}const stale=!kpiExpandedExtrasFetchedAt||Date.now()-kpiExpandedExtrasFetchedAt>18e5;if(!force&&!stale&&kpiExpandedExtrasCache&&kpiExpandedExtrasRange===rangeKey)return Promise.resolve(kpiExpandedExtrasCache);if(kpiExpandedExtrasInFlight&&!force&&kpiExpandedExtrasRange===rangeKey)return kpiExpandedExtrasInFlight;let url="/api/kpis-expanded-extra?range="+encodeURIComponent(rangeKey);try{const shop=getShopForSales();shop&&(url+="&shop="+encodeURIComponent(shop))}catch(_){}force&&(url+=(url.indexOf("?")>=0?"&":"?")+"_="+Date.now());return kpiExpandedExtrasRange=rangeKey,
// Extras KPIs can be expensive (Shopify updated-orders scan); allow longer to avoid aborting on cold cache.
kpiExpandedExtrasInFlight=fetchWithTimeout(url,{credentials:"same-origin",cache:force?"no-store":"default"},6e4).then(function(r){return r&&r.ok?r.json():null}).then(function(extras){kpiExpandedExtrasCache=extras||null,kpiExpandedExtrasFetchedAt=Date.now();try{setRangeCacheEntry("kexo-kpis-expanded-extra-cache-v1",rangeKey,kpiExpandedExtrasCache,12)}catch(_){}
// Dashboard KPI cards use extras spark series for COGS/Fulfilled/Returns.
// Once extras arrive, silently re-render the cached dashboard so sparklines appear without a refetch.
try{"dashboard"===PAGE&&dashCache&&"function"==typeof window.refreshDashboard&&window.refreshDashboard({force:!1,silent:!0})}catch(_){}return kpiExpandedExtrasCache}).catch(function(){return null}).finally(function(){kpiExpandedExtrasInFlight=null}),kpiExpandedExtrasInFlight}function delay(ms){const n=Number(ms)||0;return n<=0?Promise.resolve():new Promise(function(resolve){setTimeout(resolve,n)})}function fetchWithTimeout(url,options,timeoutMs){const ms=Number(timeoutMs)||0,timeout=ms>0?ms:25e3;if("undefined"==typeof AbortController)return Promise.race([fetch(url,options),new Promise(function(_,reject){setTimeout(function(){reject(new Error("Request timed out"))},timeout)})]);const controller=new AbortController,timer=setTimeout(function(){try{controller.abort()}catch(_){}},timeout),opts=Object.assign({},options||{},{signal:controller.signal});return fetch(url,opts).finally(function(){clearTimeout(timer)})}!function(){try{var onResize=kexoDebounce(function(){scheduleCondensedKpiOverflowUpdate()},120);window.addEventListener("resize",onResize,{passive:!0});try{kexoRegisterCleanup(function(){try{window.removeEventListener("resize",onResize)}catch(_){}try{onResize&&onResize.cancel&&onResize.cancel()}catch(_){}})}catch(_){}}catch(_){}var _condensedStripResizeObservedEl=null,_condensedKpiOverflowOrientationHandler=null;function ensureCondensedKpiOverflowResizeObserver(){try{var strip=document.getElementById("kexo-condensed-kpis");if(!strip)return;if("undefined"==typeof ResizeObserver)return;try{if(_condensedStripResizeObserver&&_condensedStripResizeObservedEl===strip)return}catch(_){}try{_condensedStripResizeObserver&&"function"==typeof _condensedStripResizeObserver.disconnect&&_condensedStripResizeObserver.disconnect()}catch(_){}_condensedStripResizeObserver=new ResizeObserver(function(){scheduleCondensedKpiOverflowUpdate()}),_condensedStripResizeObserver.observe(strip),_condensedStripResizeObservedEl=strip}catch(_){}}try{_condensedKpiOverflowOrientationHandler=function(){try{scheduleCondensedKpiOverflowUpdate()}catch(_){}},window.addEventListener("orientationchange",_condensedKpiOverflowOrientationHandler)}catch(_){}try{ensureCondensedKpiOverflowResizeObserver()}catch(_){}try{scheduleCondensedKpiOverflowUpdate()}catch(_){}try{setTimeout(function(){!function(){const row=document.getElementById("kexo-kpis-condensed-row");if(!row)return;let wrap=document.getElementById("kexo-traffic-safe-toggle-wrap");if(wrap){const cb=wrap.querySelector('input[type="checkbox"]');return void(cb&&(cb.checked=getTrafficSafe()))}wrap=document.createElement("div"),wrap.id="kexo-traffic-safe-toggle-wrap",wrap.className="kexo-traffic-safe-toggle d-flex align-items-center ms-2";const label=document.createElement("label");label.className="form-check form-check-inline mb-0 small text-secondary";const cb=document.createElement("input");cb.type="checkbox",cb.className="form-check-input",cb.checked=getTrafficSafe(),cb.setAttribute("aria-label","Exclude high-risk traffic from KPIs and charts"),label.appendChild(cb),label.appendChild(document.createTextNode(" Exclude high-risk")),wrap.appendChild(label),row.appendChild(wrap),cb.addEventListener("change",function(){setTrafficSafe(cb.checked),refreshKpis({force:!0}).catch(function(){}),fetchStatsData({force:!0}).catch(function(){}),refreshSessionsOverviewChart({force:!0}).catch(function(){});try{"function"==typeof window.refreshDashboard&&window.refreshDashboard({force:!0,silent:!0})}catch(_){}})}()},100)}catch(_){}try{registerCleanup(function(){try{_condensedStripResizeObserver&&"function"==typeof _condensedStripResizeObserver.disconnect&&_condensedStripResizeObserver.disconnect()}catch(_){}_condensedStripResizeObserver=null,_condensedStripResizeObservedEl=null})}catch(_){}
// bfcache restore: observers are disconnected on pagehide cleanup; re-wire on restore.
try{window.addEventListener("pageshow",function(ev){if(ev&&ev.persisted){try{ensureCondensedKpiOverflowResizeObserver()}catch(_){}try{scheduleCondensedKpiOverflowUpdate()}catch(_){}}})}catch(_){}}();const reportBuildScopeState="undefined"!=typeof WeakMap?new WeakMap:null;let reportBuildGlobalActive=0;function beginGlobalReportLoading(){if(reportBuildGlobalActive=Math.max(0,reportBuildGlobalActive)+1,1===reportBuildGlobalActive)try{document.body.classList.add("kexo-report-loading")}catch(_){}}function endGlobalReportLoading(){if(reportBuildGlobalActive=Math.max(0,reportBuildGlobalActive-1),reportBuildGlobalActive<=0){reportBuildGlobalActive=0;try{document.body.classList.remove("kexo-report-loading")}catch(_){}}}try{window.__kexoBeginGlobalReportLoading=beginGlobalReportLoading,window.__kexoEndGlobalReportLoading=endGlobalReportLoading}catch(_){}function startReportBuild(opts){const key=(opts=opts&&"object"==typeof opts?opts:{}).key?String(opts.key):"";if(!key)return{step:function(){},title:function(){},finish:function(){}};
// Be permissive: allow any key so pages don't silently lose the top loader
// when a new report key is introduced but not added to the token map.
reportBuildTokens&&"object"==typeof reportBuildTokens||(reportBuildTokens={}),"number"!=typeof reportBuildTokens[key]&&(reportBuildTokens[key]=0);
// Default: keep the page visible (top progress bar + header spinner only).
// Only show the full overlay when explicitly requested.
// Also respect per-page loader enable (Admin ??? Controls). Admin is always disabled.
var allowOverlay=!0;try{allowOverlay=isPageLoaderEnabled(PAGE)}catch(_){allowOverlay=!0}try{kexoSilentOverlayActive&&kexoSilentOverlayActive()&&(allowOverlay=!1)}catch(_){}if(!(!0===opts.showOverlay&&allowOverlay)){reportBuildTokens[key]=(reportBuildTokens[key]||0)+1;const token=reportBuildTokens[key];beginGlobalReportLoading(),showPageProgress();var finished=!1;return{step:function(){},title:function(){},finish:function(){if(reportBuildTokens[key]===token&&!finished){finished=!0,endGlobalReportLoading();try{window.dispatchEvent(new CustomEvent("kexo:table-rows-changed"))}catch(_){}hidePageProgress()}}}}reportBuildTokens[key]=(reportBuildTokens[key]||0)+1;const token=reportBuildTokens[key],resolved=function(opts,key){const sharedOverlay=document.getElementById("page-body-loader");if(sharedOverlay)return{overlayId:"page-body-loader",overlayEl:sharedOverlay};const explicitId=opts.overlayId?String(opts.overlayId):"";if(explicitId){const explicitEl=document.getElementById(explicitId);if(explicitEl)return{overlayId:explicitId,overlayEl:explicitEl}}const keyed=document.querySelector('[data-loader-key="'+key+'"]');return keyed&&keyed.id?{overlayId:keyed.id,overlayEl:keyed}:{overlayId:explicitId||"",overlayEl:explicitId?document.getElementById(explicitId):null}}(opts,key),overlay=resolved&&resolved.overlayEl?resolved.overlayEl:null,scope=function(opts,overlay){const pageBody=document.querySelector(".page-body");if(pageBody)return pageBody;if(opts&&opts.scopeEl&&opts.scopeEl instanceof Element)return opts.scopeEl;const scopeId=opts&&opts.scopeId?String(opts.scopeId):"";if(scopeId){const byId=document.getElementById(scopeId);if(byId)return byId}if(overlay&&overlay.closest){const panel=overlay.closest(".main-tab-panel");if(panel)return panel}return overlay&&overlay.parentElement||null}(opts,overlay);let overlayOrigin=null;if(overlay&&scope&&overlay.parentElement&&overlay.parentElement!==scope&&scope.contains(overlay)){overlayOrigin={parent:overlay.parentElement,next:overlay.nextSibling};try{scope.insertBefore(overlay,scope.firstChild)}catch(_){}}const stepId=overlay&&overlay.getAttribute("data-step-id")?String(overlay.getAttribute("data-step-id")):"",titleText=null!=opts.title?String(opts.title):function(key){const k=null!=key?String(key).trim().toLowerCase():"";return"stats"===k?"Preparing country report":"products"===k?"Preparing product report":"dashboard"===k?"Preparing dashboard overview":"attribution"===k?"Preparing attribution report":"devices"===k?"Preparing devices report":"sessions"===k?"Preparing sessions table":"diagnostics"===k?"Preparing diagnostics":"kpicompare"===k?"Preparing KPI comparison":"Preparing data"}(key),ensured=function(overlay,titleText,stepId){if(!overlay)return{titleEl:null,stepEl:null};let wrap=overlay.querySelector(".report-build-wrap");wrap||(overlay.innerHTML='<div class="container container-slim py-4 report-build-wrap"><div class="text-center"><div class="text-secondary mb-2 report-build-title">Preparing application</div><div class="text-secondary mb-3 report-build-step">Preparing application</div><div class="progress progress-sm page-loader-progress"><div class="progress-bar progress-bar-indeterminate"></div></div></div></div>',wrap=overlay.querySelector(".report-build-wrap"));try{wrap.querySelectorAll(".spinner-border, .report-build-spinner, .ads-loader-spinner").forEach(function(node){node&&node.parentNode&&node.parentNode.removeChild(node)})}catch(_){}let titleEl=wrap.querySelector(".report-build-title");titleEl||(titleEl=document.createElement("div"),titleEl.className="text-secondary mb-2 report-build-title",wrap.appendChild(titleEl)),null!=titleText&&(titleEl.textContent=String(titleText));let stepEl=null;const sid=stepId?String(stepId):"";sid?(stepEl=document.getElementById(sid),stepEl||(stepEl=document.createElement("div"),stepEl.id=sid,stepEl.className="report-build-step",wrap.appendChild(stepEl))):(stepEl=wrap.querySelector(".report-build-step"),stepEl||(stepEl=document.createElement("div"),stepEl.className="text-secondary small mb-3 report-build-step",wrap.appendChild(stepEl)));let progressEl=wrap.querySelector(".page-loader-progress");progressEl||(progressEl=document.createElement("div"),progressEl.className="progress progress-sm page-loader-progress",progressEl.innerHTML='<div class="progress-bar progress-bar-indeterminate"></div>',wrap.appendChild(progressEl));try{overlay.setAttribute("aria-live","polite")}catch(_){}return{titleEl:titleEl,stepEl:stepEl}}(overlay,titleText,stepId),titleEl=ensured.titleEl,stepEl=ensured.stepEl;if(function(scope){if(!scope)return;if(!reportBuildScopeState)return void scope.classList.add("report-building");let state=reportBuildScopeState.get(scope);if(state||(state={count:0,prevMinHeight:""}),state.count<=0){if(state.prevMinHeight=scope.style.minHeight||"",scope.classList&&scope.classList.contains("page-body")){syncPageBodyLoaderOffset(scope);var topPx=scope.style.getPropertyValue("--kexo-loader-page-top")||"0px";scope.style.minHeight="calc(100vh - "+topPx+")"}else{const h=Number(scope.offsetHeight||0);h>0&&(scope.style.minHeight=String(Math.ceil(h))+"px")}scope.classList.add("report-building")}state.count+=1,reportBuildScopeState.set(scope,state),beginGlobalReportLoading()}(scope),"sessions"===key&&scope)try{scope.classList.add("report-building-sessions")}catch(_){}function title(text){reportBuildTokens[key]===token&&titleEl&&(titleEl.textContent=null!=text?String(text):"")}return overlay&&overlay.classList.remove("is-hidden"),stepEl&&(null!=opts.initialStep?stepEl.textContent=String(opts.initialStep):String(stepEl.textContent||"").trim()||(stepEl.textContent="Preparing application")),showPageProgress(),{step:function(text,nextTitle){reportBuildTokens[key]===token&&("string"==typeof nextTitle&&title(nextTitle),stepEl&&(stepEl.textContent=null!=text?String(text):""))},title:title,finish:function(){if(reportBuildTokens[key]===token){if("sessions"===key&&scope)try{scope.classList.remove("report-building-sessions")}catch(_){}if(overlay&&overlay.classList.add("is-hidden"),overlay&&overlayOrigin&&overlayOrigin.parent)try{overlayOrigin.next&&overlayOrigin.next.parentNode===overlayOrigin.parent?overlayOrigin.parent.insertBefore(overlay,overlayOrigin.next):overlayOrigin.parent.appendChild(overlay)}catch(_){}!function(scope){if(!scope)return;if(!reportBuildScopeState)return void scope.classList.remove("report-building");let state=reportBuildScopeState.get(scope);if(state){if(state.count=Math.max(0,Number(state.count||0)-1),state.count<=0)return scope.classList.remove("report-building"),scope.style.minHeight=state.prevMinHeight||"",reportBuildScopeState.delete(scope),void endGlobalReportLoading();reportBuildScopeState.set(scope,state),endGlobalReportLoading()}}(scope);try{window.dispatchEvent(new CustomEvent("kexo:table-rows-changed"))}catch(_){}hidePageProgress()}}}}const KPI_TRAFFIC_SAFE_LS_KEY="kexo_traffic_safe";function getTrafficSafe(){try{const v=localStorage.getItem(KPI_TRAFFIC_SAFE_LS_KEY);return"1"===v||"true"===v}catch(_){return!1}}function setTrafficSafe(on){try{localStorage.setItem(KPI_TRAFFIC_SAFE_LS_KEY,on?"1":"0")}catch(_){}try{window.dispatchEvent(new CustomEvent("kexo:traffic-safe-changed",{detail:{trafficSafe:!!on}}))}catch(_){}}function getTrafficQuerySuffix(){return getTrafficSafe()?"&traffic=safe":""}try{window.kexoGetTrafficQuerySuffix=getTrafficQuerySuffix,window.kexoGetTrafficSafe=getTrafficSafe,window.kexoSetTrafficSafe=setTrafficSafe}catch(_){}function fetchStatsData(options={}){const force=!!options.force;let url="/api/stats?range="+encodeURIComponent(getStatsRange())+getTrafficQuerySuffix();force&&(url+=(url.indexOf("?")>=0?"&":"?")+"_="+Date.now());return fetchWithTimeout(url,{credentials:"same-origin",cache:force?"no-store":"default"},3e4).then(function(r){if(!r.ok)throw new Error("Stats HTTP "+r.status);return r.json()}).then(function(data){return lastStatsFetchedAt=Date.now(),lastUpdateTime=new Date,updateServerTimeDisplay(),renderStats(data&&"object"==typeof data.country?data:{}),data}).catch(function(err){try{"function"==typeof window.kexoCaptureError&&window.kexoCaptureError(err,{context:"reportBuildStats",page:PAGE})}catch(_){}return console.error(err),renderStats(statsCache||{}),null})}
// ?????? KPI local cache (prevents empty KPI boxes during fast navigation) ??????
function safeReadLocalStorageJson(key){try{const raw=localStorage.getItem(key);return raw?JSON.parse(raw):null}catch(_){return null}}function safeWriteLocalStorageJson(key,value){try{localStorage.setItem(key,JSON.stringify(value))}catch(_){}}function getRangeCacheEntry(lsKey,rangeKey){if(!lsKey||!rangeKey)return null;const root=safeReadLocalStorageJson(lsKey),byRange=root&&"object"==typeof root&&root.byRange&&"object"==typeof root.byRange?root.byRange:null;if(!byRange)return null;const entry=byRange[rangeKey];if(!entry||"object"!=typeof entry)return null;const at=null!=entry.at?Number(entry.at):NaN;return!Number.isFinite(at)||at<=0?null:{at:at,data:entry.data}}function setRangeCacheEntry(lsKey,rangeKey,data,maxEntries){if(!lsKey||!rangeKey)return;let root=safeReadLocalStorageJson(lsKey);root&&"object"==typeof root||(root={v:1,byRange:{}}),root.byRange&&"object"==typeof root.byRange||(root.byRange={}),root.byRange[rangeKey]={at:Date.now(),data:null==data?null:data};const cap="number"==typeof maxEntries&&Number.isFinite(maxEntries)&&maxEntries>0?Math.trunc(maxEntries):12;try{const keys=Object.keys(root.byRange);if(keys.length>cap)for(keys.sort(function(a,b){return(root.byRange[a]&&null!=root.byRange[a].at?Number(root.byRange[a].at):0)-(root.byRange[b]&&null!=root.byRange[b].at?Number(root.byRange[b].at):0)});keys.length>cap;){const k=keys.shift();k&&delete root.byRange[k]}}catch(_){}safeWriteLocalStorageJson(lsKey,root)}function refreshKpiExtrasSoft(){!!document.getElementById("cond-kpi-items-sold")&&fetchExpandedKpiExtras({force:!1}).then(function(extras){try{!function(extras){const condItemsEl=document.getElementById("cond-kpi-items-sold"),condFulfilledEl=document.getElementById("cond-kpi-orders-fulfilled"),condReturnsEl=document.getElementById("cond-kpi-returns"),condCogsEl=document.getElementById("cond-kpi-cogs");if(!(condItemsEl||condFulfilledEl||condReturnsEl||condCogsEl))return;const itemsSold=extras&&"number"==typeof extras.itemsSold?extras.itemsSold:null,ordersFulfilled=extras&&"number"==typeof extras.ordersFulfilled?extras.ordersFulfilled:null,returnsAmount=extras&&"number"==typeof extras.returns?extras.returns:null,cogsAmount=extras&&"number"==typeof extras.cogs?extras.cogs:null,compare=extras&&extras.compare?extras.compare:null,itemsSoldCompare=compare&&"number"==typeof compare.itemsSold?compare.itemsSold:null,ordersFulfilledCompare=compare&&"number"==typeof compare.ordersFulfilled?compare.ordersFulfilled:null,returnsCompare=compare&&"number"==typeof compare.returns?compare.returns:null,cogsCompare=compare&&"number"==typeof compare.cogs?compare.cogs:null;function setTone(id,current,baseline,invert){const sparkEl=document.getElementById(id);if(!sparkEl)return;const cur="number"==typeof current&&Number.isFinite(current)?current:null,base="number"==typeof baseline&&Number.isFinite(baseline)?baseline:null;if(null==cur||null==base)return void sparkEl.removeAttribute("data-tone");const delta=invert?base-cur:cur-base;if(Math.abs(delta)<1e-9)return void sparkEl.removeAttribute("data-tone");const denom=Math.abs(base);if(denom>1e-9){const ratio=delta/denom;if(Math.abs(ratio)<=KPI_STABLE_RATIO)return void sparkEl.removeAttribute("data-tone")}sparkEl.setAttribute("data-tone",delta<0?"down":"up")}condItemsEl&&(condItemsEl.textContent=null!=itemsSold?formatSessions(itemsSold):"—"),condFulfilledEl&&(condFulfilledEl.textContent=null!=ordersFulfilled?formatSessions(ordersFulfilled):"—"),condReturnsEl&&(condReturnsEl.textContent=null!=returnsAmount?formatNegativeCurrencyOrZero(returnsAmount,!1):"—"),condCogsEl&&(condCogsEl.textContent=null!=cogsAmount?formatRevenue(cogsAmount):"—"),applyCondensedKpiDelta("items-sold",itemsSold,itemsSoldCompare,!1),applyCondensedKpiDelta("orders-fulfilled",ordersFulfilled,ordersFulfilledCompare,!1),applyCondensedKpiDelta("returns",returnsAmount,returnsCompare,!0),applyCondensedKpiDelta("cogs",cogsAmount,cogsCompare,!0),setTone("cond-kpi-items-sold-sparkline",itemsSold,itemsSoldCompare,!1),setTone("cond-kpi-orders-fulfilled-sparkline",ordersFulfilled,ordersFulfilledCompare,!1),setTone("cond-kpi-returns-sparkline",returnsAmount,returnsCompare,!0),setTone("cond-kpi-cogs-sparkline",cogsAmount,cogsCompare,!0),condensedSparklineOverrides&&"object"==typeof condensedSparklineOverrides||(condensedSparklineOverrides={}),condensedSparklineOverrides["cond-kpi-orders-fulfilled-sparkline"]=null!=ordersFulfilled&&null!=ordersFulfilledCompare?[ordersFulfilledCompare,ordersFulfilled]:null,condensedSparklineOverrides["cond-kpi-returns-sparkline"]=null!=returnsAmount&&null!=returnsCompare?[returnsCompare,returnsAmount]:null,condensedSparklineOverrides["cond-kpi-cogs-sparkline"]=null!=cogsAmount&&null!=cogsCompare?[cogsCompare,cogsAmount]:null;try{renderCondensedSparklines(condensedSeriesCache||sparklineHistorySeriesCache||[])}catch(_){}try{updateCondensedKpiOverflow()}catch(_){}}(extras)}catch(_){}}).catch(function(){})}function refreshKpis(options={}){const force=!!options.force,rangeKey=getStatsRange();if(!rangeKey)return Promise.resolve(null);
// Hydrate from localStorage so KPI boxes render instantly on fast nav.
if(!force)try{!function(rangeKey,allowStale){const entry=getRangeCacheEntry("kexo-kpis-cache-v1",rangeKey);if(!entry)return!1;const age=Date.now()-entry.at;!(!Number.isFinite(age)||age<0)&&(age>(allowStale?18e5:12e4)||!entry.data||"object"!=typeof entry.data||lastKpisFetchedAt&&entry.at<=lastKpisFetchedAt||(kpiCache=entry.data,kpiCacheRange=rangeKey,kpiCacheSource="kpis",lastKpisFetchedAt=entry.at,
// If we can paint real numbers immediately, don't flash KPI spinners.
kpisSpinnerShownOnce=!0))}(rangeKey,!0)}catch(_){}const cacheMatchesRange=!(!kpiCache||kpiCacheRange!==rangeKey),stale=!cacheMatchesRange||!lastKpisFetchedAt||Date.now()-lastKpisFetchedAt>12e4;
// If cache is still fresh, avoid refetching.
if(!force&&!stale&&(cacheMatchesRange&&"stats"!==kpiCacheSource)){try{renderLiveKpis(getKpiData())}catch(_){}try{renderDashboardKpisFromApi(getKpiData())}catch(_){}try{"dashboard"===PAGE&&"function"==typeof window.refreshDashboard&&window.refreshDashboard({force:!1})}catch(_){}try{refreshKpiExtrasSoft()}catch(_){}try{fetchCondensedSeries()}catch(_){}return Promise.resolve(kpiCache)}if(kpisRefreshInFlight&&kpisRefreshRangeKey===rangeKey)return kpisRefreshInFlight;
// Stale-while-revalidate: keep showing last known values while we refresh.
try{if(cacheMatchesRange){renderLiveKpis(getKpiData()),renderDashboardKpisFromApi(getKpiData());try{"dashboard"===PAGE&&"function"==typeof window.refreshDashboard&&window.refreshDashboard({force:!1})}catch(_){}fetchCondensedSeries()}}catch(_){}
// Only show the KPI mini spinners on the very first load (avoid visual noise on refreshes).
const showSpinner=!kpisSpinnerShownOnce&&!cacheMatchesRange;showSpinner&&(kpisSpinnerShownOnce=!0,["cond-kpi-orders","cond-kpi-revenue","cond-kpi-profit","cond-kpi-sessions","cond-kpi-conv","cond-kpi-vpv","cond-kpi-roas","cond-kpi-returning","cond-kpi-aov","cond-kpi-cogs","cond-kpi-bounce","cond-kpi-items-sold","cond-kpi-orders-fulfilled","cond-kpi-returns"].forEach(function(id){const el=document.getElementById(id);el&&(el.removeAttribute("data-odometer"),el.innerHTML='<span class="kpi-mini-spinner" aria-hidden="true"></span>')}));const fetchP=function(options={}){const force=!!options.force;let url="/api/kpis?range="+encodeURIComponent(getStatsRange())+getTrafficQuerySuffix();return force&&(url+=(url.indexOf("?")>=0?"&":"?")+"force=1"),fetchWithTimeout(url,{credentials:"same-origin",cache:force?"no-store":"default"},25e3).then(function(r){if(!r.ok)throw new Error("KPIs HTTP "+r.status);return r.json()})}({force:force});kpisRefreshRangeKey=rangeKey,kpisRefreshInFlight=(showSpinner?Promise.all([fetchP,delay(800)]):fetchP).then(function(partsOrData){const data=showSpinner?partsOrData&&partsOrData[0]&&"object"==typeof partsOrData[0]?partsOrData[0]:null:partsOrData&&"object"==typeof partsOrData?partsOrData:null;if(data){lastKpisFetchedAt=Date.now(),kpiCache=data,kpiCacheRange=rangeKey,kpiCacheSource="kpis",maybeTriggerSaleToastFromStatsLikeData(kpiCache);try{setRangeCacheEntry("kexo-kpis-cache-v1",rangeKey,kpiCache,12)}catch(_){}}renderLiveKpis(getKpiData());try{renderDashboardKpisFromApi(getKpiData())}catch(_){}try{"dashboard"===PAGE&&"function"==typeof window.refreshDashboard&&window.refreshDashboard({force:!1})}catch(_){}try{refreshKpiExtrasSoft()}catch(_){}try{fetchCondensedSeries()}catch(_){}return data}).catch(function(err){try{"function"==typeof window.kexoCaptureError&&window.kexoCaptureError(err,{context:"reportBuildKpis",page:PAGE})}catch(_){}console.error(err),renderLiveKpis(getKpiData());try{renderDashboardKpisFromApi(getKpiData())}catch(_){}try{"dashboard"===PAGE&&"function"==typeof window.refreshDashboard&&window.refreshDashboard({force:!1})}catch(_){}try{refreshKpiExtrasSoft()}catch(_){}return null});var wrappedRequest=kpisRefreshInFlight.finally(function(){kpisRefreshInFlight===wrappedRequest&&(kpisRefreshInFlight=null,kpisRefreshRangeKey===rangeKey&&(kpisRefreshRangeKey=""))});return kpisRefreshInFlight=wrappedRequest,wrappedRequest}function refreshStats(options={}){const force=!!options.force;if(statsRefreshInFlight)return statsRefreshInFlight;const build=startReportBuild({key:"stats",overlayId:"stats-loading-overlay",stepId:"stats-build-step",title:"Preparing country report"});return build.step("Loading country performance data"),statsRefreshInFlight=fetchStatsData({force:force}).then(function(data){return build.step("Analyzing average order value"),delay(180).then(function(){return build.step("Building country table"),delay(120).then(function(){return delay(180).then(function(){return data})})})}).finally(function(){statsRefreshInFlight=null,build.finish()}),statsRefreshInFlight}function refreshProducts(options={}){const force=!!options.force;if(productsRefreshInFlight)return productsRefreshInFlight;if(!(getShopParam()||shopForSalesFallback||null))return Promise.resolve(null);const build=startReportBuild({key:"products",overlayId:"products-loading-overlay",stepId:"products-build-step",title:"Preparing product report"});let bestP=null,variantsP=null,leaderboardP=null,variantCardsP=null;try{bestP=fetchBestSellers({force:force})}catch(err){console.error(err),bestP=Promise.resolve(null)}try{variantsP=fetchBestVariants({force:force})}catch(err){console.error(err),variantsP=Promise.resolve(null)}try{leaderboardP=fetchProductsLeaderboard({force:force})}catch(err){console.error(err),leaderboardP=Promise.resolve(null)}try{variantCardsP="lengths"===normalizeProductsVariantCardsView(productsVariantCardsView)?fetchLengths({force:force}):fetchFinishes({force:force})}catch(err){console.error(err),variantCardsP=Promise.resolve(null)}function settled(p){return Promise.resolve(p).then(function(v){return{ok:!0,value:v}}).catch(function(err){return console.error(err),{ok:!1,error:err}})}const bestS=settled(bestP),variantsS=settled(variantsP),leaderboardS=settled(leaderboardP),variantCardsS=settled(variantCardsP);return productsRefreshInFlight=Promise.resolve().then(function(){return build.step("Loading best-selling products"),bestS}).then(function(){return delay(180)}).then(function(){return build.step("Loading top variants"),variantsS}).then(function(){return delay(180)}).then(function(){return build.step("Analyzing product leaderboard"),leaderboardS}).then(function(){return delay(140)}).then(function(){return build.step("Building product tables"),variantCardsS}).then(function(){return delay(140)}).then(function(){lastProductsFetchedAt=Date.now()}).catch(function(err){try{"function"==typeof window.kexoCaptureError&&window.kexoCaptureError(err,{context:"trafficSourceMapsFetch",page:PAGE})}catch(_){}return console.error(err),null}).finally(function(){productsRefreshInFlight=null,build.finish()}),productsRefreshInFlight}function renderAttributionTables(data){const body=document.getElementById("attribution-body");if(!body)return;const by=(tableSortState.attribution.by||"rev").toString().trim().toLowerCase(),dir="asc"===(tableSortState.attribution.dir||"desc").toString().trim().toLowerCase()?"asc":"desc",filtered=(data&&data.attribution&&Array.isArray(data.attribution.rows)?data.attribution.rows.slice():[]).filter(function(r){const s=r&&"number"==typeof r.sessions?r.sessions:0,o=r&&"number"==typeof r.orders?r.orders:0;return s>=1||o>=1});function iconSpecHtml(iconSpecRaw,labelRaw){const spec=null!=iconSpecRaw?String(iconSpecRaw).trim():"",label=null!=labelRaw?String(labelRaw).trim():"",t=label?' title="'+escapeHtml(label)+'"':"";if(!spec)return"";if(/^<svg[\s>]/i.test(spec)){return'<span class="source-icons"'+t+' aria-hidden="true">'+function(svgMarkup){var raw=null!=svgMarkup?String(svgMarkup):"";if(!raw)return"";if(!/^<svg[\s>]/i.test(raw.trim()))return raw;
// If the SVG has no viewBox, removing/overriding width/height can clip the artwork.
// In that case, leave the original sizing attributes intact and rely on CSS max-size.
try{var m=raw.trim().match(/^<svg\b([^>]*)>/i),attrs=m&&m[1]?String(m[1]):"";if(!/\sviewBox\s*=/i.test(attrs))return raw}catch(_){}
// Remove width/height attributes from the root <svg ...> tag so CSS can enforce sizing.
return raw.replace(/^<svg\b([^>]*)>/i,function(_m,attrs){var a=String(attrs||"");return"<svg"+(
// Best-effort: remove width/height declarations from inline style (keep other styles).
a=(a=a.replace(/\s(width|height)\s*=\s*(?:"[^"]*"|'[^']*'|[^\s>]+)/gi,"")).replace(/\sstyle\s*=\s*(["'])([\s\S]*?)\1/i,function(_m2,q,style){var cleaned=String(style||"").replace(/(^|;)\s*width\s*:\s*[^;]+/gi,"$1").replace(/(^|;)\s*height\s*:\s*[^;]+/gi,"$1").replace(/;;+/g,";").replace(/^\s*;\s*|\s*;\s*$/g,"").trim();return cleaned?" style="+q+cleaned+q:""}))+">"})}(spec)+"</span>"}if(/^(https?:\/\/|\/\/|\/)/i.test(spec)){return'<span class="source-icons"><img src="'+escapeHtml(hotImg(spec)||spec)+'" alt="'+escapeHtml(label)+'" class="source-icon-img" width="20" height="20"'+t+"></span>"}return'<span class="source-icons"><i class="'+escapeHtml(spec)+'"'+t+' aria-hidden="true"></i></span>'}function channelLabel(r){return r?null!=r.label&&""!==String(r.label).trim()?String(r.label):null!=r.channel_key&&""!==String(r.channel_key).trim()?String(r.channel_key):"unknown":"unknown"}function sourceLabel(r){return r?null!=r.label&&""!==String(r.label).trim()?String(r.label):null!=r.source_key&&""!==String(r.source_key).trim()?String(r.source_key):"unknown":"unknown"}function variantLabel(r){return r?null!=r.label&&""!==String(r.label).trim()?String(r.label):null!=r.variant_key&&""!==String(r.variant_key).trim()?String(r.variant_key):"unknown":"unknown"}function metric(r,key){if(!r)return null;if("cr"===key)return"number"==typeof r.conversion_pct?r.conversion_pct:null;if("orders"===key)return"number"==typeof r.orders?r.orders:null;if("sessions"===key)return"number"==typeof r.sessions?r.sessions:null;if("rev"===key)return"number"==typeof r.revenue_gbp?r.revenue_gbp:null;if("vpv"===key){const rev="number"==typeof r.revenue_gbp?r.revenue_gbp:null,sess="number"==typeof r.sessions?r.sessions:null;return null!=sess&&sess>0&&null!=rev?rev/sess:null}return null}if(filtered.sort(function(a,b){let primary=0;return primary="attribution"===by?cmpNullableText(channelLabel(a),channelLabel(b),dir):cmpNullableNumber(metric(a,by),metric(b,by),dir),primary||cmpNullableNumber(metric(a,"rev"),metric(b,"rev"),"desc")||cmpNullableNumber(metric(a,"orders"),metric(b,"orders"),"desc")||cmpNullableNumber(metric(a,"sessions"),metric(b,"sessions"),"desc")||cmpNullableText(channelLabel(a),channelLabel(b),"asc")}),!filtered.length)return body.innerHTML='<div class="grid-row" role="row"><div class="grid-cell empty span-all" role="cell">No attribution data yet.</div></div>',updateCardPagination("attribution",1,1),void updateSortHeadersInContainer(document.getElementById("attribution-table"),by,dir);const pageSize=getTableRowsPerPage("attribution-table","live"),totalPages=Math.max(1,Math.ceil(filtered.length/pageSize));attributionPage=clampPage(attributionPage,totalPages),updateCardPagination("attribution",attributionPage,totalPages);const pageStart=(attributionPage-1)*pageSize,pageChannels=filtered.slice(pageStart,pageStart+pageSize);let html="";pageChannels.forEach(function(ch){const chKey=((r=ch)&&null!=r.channel_key?String(r.channel_key).trim().toLowerCase():"")||"other";var r;const chOpen=(key=chKey,null===attributionExpandedChannels||!attributionExpandedChannels||"object"!=typeof attributionExpandedChannels||!Object.prototype.hasOwnProperty.call(attributionExpandedChannels,key)||!!attributionExpandedChannels[key]);var key;const chLabel=channelLabel(ch),chCr=ch&&"number"==typeof ch.conversion_pct?pct(ch.conversion_pct):"-",chOrders=ch&&"number"==typeof ch.orders?formatSessions(ch.orders):"-",chSessions=ch&&"number"==typeof ch.sessions?formatSessions(ch.sessions):"-",chRev=ch&&"number"==typeof ch.revenue_gbp?formatRevenueTableHtml(ch.revenue_gbp):"-",chVpv=null!=metric(ch,"vpv")?formatRevenue(metric(ch,"vpv")):"—",sources=ch&&Array.isArray(ch.sources)?ch.sources.slice():[],channelHead=sources.length>0?'<button type="button" class="traffic-type-toggle attribution-channel-toggle" data-channel="'+escapeHtml(chKey)+'" aria-expanded="'+(chOpen?"true":"false")+'"><span>'+escapeHtml(chLabel)+"</span></button>":'<span class="traffic-type-toggle attribution-channel-toggle is-static"><span>'+escapeHtml(chLabel)+"</span></span>";html+='<div class="grid-row traffic-type-parent attribution-channel-parent" role="row" data-channel="'+escapeHtml(chKey)+'"><div class="grid-cell" role="cell">'+channelHead+'</div><div class="grid-cell" role="cell">'+escapeHtml(chSessions||"-")+'</div><div class="grid-cell" role="cell">'+escapeHtml(chOrders||"-")+'</div><div class="grid-cell" role="cell">'+escapeHtml(chCr||"-")+'</div><div class="grid-cell" role="cell">'+chVpv+'</div><div class="grid-cell" role="cell">'+(chRev||"-")+"</div></div>",sources.sort(function(a,b){let primary=0;return primary="attribution"===by?cmpNullableText(sourceLabel(a),sourceLabel(b),dir):cmpNullableNumber(metric(a,by),metric(b,by),dir),primary||cmpNullableNumber(metric(a,"rev"),metric(b,"rev"),"desc")||cmpNullableNumber(metric(a,"orders"),metric(b,"orders"),"desc")||cmpNullableNumber(metric(a,"sessions"),metric(b,"sessions"),"desc")||cmpNullableText(sourceLabel(a),sourceLabel(b),"asc")}),sources.forEach(function(src){const sKey=function(r){return(r&&null!=r.source_key?String(r.source_key).trim().toLowerCase():"")||"other"}(src),variants=src&&Array.isArray(src.variants)?src.variants.slice():[],hasVariants=variants.length>0,srcOpen=!!hasVariants&&(chOpen&&function(chKey,srcKey){if(null===attributionExpandedSources)return!0;if(!attributionExpandedSources||"object"!=typeof attributionExpandedSources)return!0;const k=chKey+"|"+srcKey;return!Object.prototype.hasOwnProperty.call(attributionExpandedSources,k)||!!attributionExpandedSources[k]}(chKey,sKey)),sLabel=sourceLabel(src),sIcon=iconSpecHtml(src&&null!=src.icon_spec?src.icon_spec:null,sLabel),sCr=src&&"number"==typeof src.conversion_pct?pct(src.conversion_pct):"-",sOrders=src&&"number"==typeof src.orders?formatSessions(src.orders):"-",sSessions=src&&"number"==typeof src.sessions?formatSessions(src.sessions):"-",sRev=src&&"number"==typeof src.revenue_gbp?formatRevenueTableHtml(src.revenue_gbp):"-",sVpv=null!=metric(src,"vpv")?formatRevenue(metric(src,"vpv")):"—",sourceHead=hasVariants?'<button type="button" class="traffic-type-toggle attribution-source-toggle" data-channel="'+escapeHtml(chKey)+'" data-source="'+escapeHtml(sKey)+'" aria-expanded="'+(srcOpen?"true":"false")+'">'+(sIcon||"")+"<span>"+escapeHtml(sLabel)+"</span></button>":'<span class="traffic-type-toggle attribution-source-toggle is-static">'+(sIcon||"")+"<span>"+escapeHtml(sLabel)+"</span></span>";html+='<div class="grid-row traffic-type-child attribution-source-row'+(chOpen?"":" is-hidden")+'" role="row" data-parent="'+escapeHtml(chKey)+'" data-channel="'+escapeHtml(chKey)+'" data-source="'+escapeHtml(sKey)+'"><div class="grid-cell" role="cell">'+sourceHead+'</div><div class="grid-cell" role="cell">'+escapeHtml(sSessions||"-")+'</div><div class="grid-cell" role="cell">'+escapeHtml(sOrders||"-")+'</div><div class="grid-cell" role="cell">'+escapeHtml(sCr||"-")+'</div><div class="grid-cell" role="cell">'+sVpv+'</div><div class="grid-cell" role="cell">'+(sRev||"-")+"</div></div>",variants.sort(function(a,b){let primary=0;return primary="attribution"===by?cmpNullableText(variantLabel(a),variantLabel(b),dir):cmpNullableNumber(metric(a,by),metric(b,by),dir),primary||cmpNullableNumber(metric(a,"rev"),metric(b,"rev"),"desc")||cmpNullableNumber(metric(a,"orders"),metric(b,"orders"),"desc")||cmpNullableNumber(metric(a,"sessions"),metric(b,"sessions"),"desc")||cmpNullableText(variantLabel(a),variantLabel(b),"asc")});const parentKey=chKey+"|"+sKey;variants.forEach(function(v){!function(r){r&&null!=r.variant_key&&String(r.variant_key).trim().toLowerCase()}(v);const vLabel=variantLabel(v),vIcon=iconSpecHtml(v&&null!=v.icon_spec?v.icon_spec:null,vLabel),vCr=v&&"number"==typeof v.conversion_pct?pct(v.conversion_pct):"-",vOrders=v&&"number"==typeof v.orders?formatSessions(v.orders):"-",vSessions=v&&"number"==typeof v.sessions?formatSessions(v.sessions):"-",vRev=v&&"number"==typeof v.revenue_gbp?formatRevenueTableHtml(v.revenue_gbp):"-",vVpv=null!=metric(v,"vpv")?formatRevenue(metric(v,"vpv")):"—";html+='<div class="grid-row traffic-type-child attribution-variant-row'+(srcOpen?"":" is-hidden")+'" role="row" data-parent="'+escapeHtml(parentKey)+'" data-channel="'+escapeHtml(chKey)+'" data-source="'+escapeHtml(sKey)+'"><div class="grid-cell" role="cell"><span class="d-inline-flex align-items-center gap-2 ps-3">'+(vIcon||"")+"<span>"+escapeHtml(vLabel)+'</span></span></div><div class="grid-cell" role="cell">'+escapeHtml(vSessions||"-")+'</div><div class="grid-cell" role="cell">'+escapeHtml(vOrders||"-")+'</div><div class="grid-cell" role="cell">'+escapeHtml(vCr||"-")+'</div><div class="grid-cell" role="cell">'+vVpv+'</div><div class="grid-cell" role="cell">'+(vRev||"-")+"</div></div>"})})}),body.innerHTML=html,updateSortHeadersInContainer(document.getElementById("attribution-table"),by,dir)}function renderAttribution(data){attributionCache=data||attributionCache||null;try{renderAttributionTables(attributionCache||{})}catch(_){}try{!function(data){const el=document.getElementById("attribution-chart");if(!el)return;const chartKey="attribution-chart";if(!isChartEnabledByUiConfig(chartKey,!0)){try{if(el.__kexoChartInstance){try{el.__kexoChartInstance.destroy()}catch(_){}el.__kexoChartInstance=null}}catch(_){}return void(el.innerHTML="")}const rows=data&&data.attribution&&Array.isArray(data.attribution.rows)?data.attribution.rows.slice():[];if(!rows.length)return void(el.innerHTML='<div class="kexo-chart-empty kexo-chart-empty--h320">No attribution data</div>');function channelLabel(r){return r?null!=r.label&&""!==String(r.label).trim()?String(r.label):null!=r.channel_key&&""!==String(r.channel_key).trim()?String(r.channel_key):"Unknown":"Unknown"}function metricValue(r,metricKey){return r?"orders"===metricKey?Math.max(0,Number(r.orders)||0):"revenue"===metricKey?Math.max(0,Number(r.revenue_gbp)||0):Math.max(0,Number(r.sessions)||0):0}const rawMode=chartModeFromUiConfig(chartKey,"line")||"line",showEndLabels="multi-line-labels"===rawMode,mode="multi-line-labels"===rawMode?"line":rawMode,metricKey=chartPieMetricFromUiConfig(chartKey,"sessions"),palette=chartColorsFromUiConfig(chartKey,["#4b94e4","#f59e34","#3eb3ab","#8b5cf6","#ef4444","#22c55e"]),isCurrency="revenue"===metricKey,seriesName="orders"===metricKey?"Orders":"revenue"===metricKey?"Revenue":"Sessions",items=rows.map(function(r){return{label:channelLabel(r),value:metricValue(r,metricKey)}}).filter(function(it){return it&&it.value>0}).sort(function(a,b){return b.value-a.value||String(a.label).localeCompare(String(b.label))}).slice(0,10);if(!items.length)return void(el.innerHTML='<div class="kexo-chart-empty kexo-chart-empty--h320">No attribution data</div>');const categories=items.map(function(it){return it.label}),values=items.map(function(it){return it.value}),series="pie"===String(mode).toLowerCase()?categories.map(function(name,idx){return{name:name,data:[values[idx]]}}):[{name:seriesName,data:values}];try{window.kexoRenderApexChart({chartKey:chartKey,containerEl:el,categories:categories,series:series,mode:mode,colors:palette,height:320,currency:isCurrency,showEndLabels:showEndLabels,chartStyle:chartStyleFromUiConfig(chartKey),advancedApexOverride:chartAdvancedOverrideFromUiConfig(chartKey,mode)})}catch(_){el.innerHTML='<div class="kexo-chart-empty kexo-chart-empty--h320 kexo-chart-empty--error">Chart rendering failed</div>'}}(attributionCache||{})}catch(_){}}function refreshAttribution(options={}){const force=!!options.force;if(attributionRefreshInFlight)return attributionRefreshInFlight;const build=startReportBuild({key:"attribution",title:"Preparing attribution report"});return build.step("Loading attribution performance"),attributionRefreshInFlight=function(options={}){const force=!!options.force,attrEl=document.getElementById("attribution-chart");attrEl&&(attrEl.innerHTML='<div class="kexo-overview-chart-empty is-loading"><span class="kpi-mini-spinner" aria-hidden="true"></span><span>Loading…</span></div>');let url="/api/attribution/report?range="+encodeURIComponent(getStatsRange());return force&&(url+=(url.indexOf("?")>=0?"&":"?")+"_="+Date.now()),fetchWithTimeout(url,{credentials:"same-origin",cache:force?"no-store":"default"},25e3).then(function(r){if(!r.ok)throw new Error("Attribution HTTP "+r.status);return r.json()}).then(function(data){return lastAttributionFetchedAt=Date.now(),renderAttribution(data&&"object"==typeof data?data:null),data}).catch(function(err){try{"function"==typeof window.kexoCaptureError&&window.kexoCaptureError(err,{context:"attributionFetch",page:PAGE})}catch(_){}return renderAttribution(attributionCache||null),null})}({force:force}).finally(function(){attributionRefreshInFlight=null,build.finish()}),attributionRefreshInFlight}function renderDevicesTables(data){const body=document.getElementById("devices-body");if(!body)return;const by=(tableSortState.devices.by||"rev").toString().trim().toLowerCase(),dir="asc"===(tableSortState.devices.dir||"desc").toString().trim().toLowerCase()?"asc":"desc",filtered=(data&&data.devices&&Array.isArray(data.devices.rows)?data.devices.rows.slice():[]).filter(function(r){const s=r&&"number"==typeof r.sessions?r.sessions:0,o=r&&"number"==typeof r.orders?r.orders:0;return s>=1||o>=1});function deviceLabel(r){if(!r)return"unknown";return(null!=r.device_type?String(r.device_type).trim().toLowerCase():"")||"unknown"}function metric(r,key){if(!r)return null;if("cr"===key)return"number"==typeof r.conversion_pct?r.conversion_pct:null;if("orders"===key)return"number"==typeof r.orders?r.orders:null;if("sessions"===key)return"number"==typeof r.sessions?r.sessions:null;if("rev"===key)return"number"==typeof r.revenue_gbp?r.revenue_gbp:null;if("vpv"===key){const rev="number"==typeof r.revenue_gbp?r.revenue_gbp:null,sess="number"==typeof r.sessions?r.sessions:null;return null!=sess&&sess>0&&null!=rev?rev/sess:null}return null}if(filtered.sort(function(a,b){let primary=0;return primary="device"===by?cmpNullableText(deviceLabel(a),deviceLabel(b),dir):cmpNullableNumber(metric(a,by),metric(b,by),dir),primary||cmpNullableNumber(metric(a,"rev"),metric(b,"rev"),"desc")||cmpNullableNumber(metric(a,"orders"),metric(b,"orders"),"desc")||cmpNullableNumber(metric(a,"sessions"),metric(b,"sessions"),"desc")||cmpNullableText(deviceLabel(a),deviceLabel(b),"asc")}),!filtered.length)return body.innerHTML='<div class="grid-row" role="row"><div class="grid-cell empty span-all" role="cell">No device data yet.</div></div>',updateCardPagination("devices",1,1),void updateSortHeadersInContainer(document.getElementById("devices-table"),by,dir);const pageSize=getTableRowsPerPage("devices-table","live"),totalPages=Math.max(1,Math.ceil(filtered.length/pageSize));devicesPage=clampPage(devicesPage,totalPages),updateCardPagination("devices",devicesPage,totalPages);const pageStart=(devicesPage-1)*pageSize,pageGroups=filtered.slice(pageStart,pageStart+pageSize);let html="";pageGroups.forEach(function(g){const dKey=deviceLabel(g),open=(key=dKey,null===devicesExpanded||!devicesExpanded||"object"!=typeof devicesExpanded||!Object.prototype.hasOwnProperty.call(devicesExpanded,key)||!!devicesExpanded[key]);var key;const label=dKey,cr=g&&"number"==typeof g.conversion_pct?pct(g.conversion_pct):"-",orders=g&&"number"==typeof g.orders?formatSessions(g.orders):"-",sessions=g&&"number"==typeof g.sessions?formatSessions(g.sessions):"-",rev=g&&"number"==typeof g.revenue_gbp?formatRevenueTableHtml(g.revenue_gbp):"-",vpv=null!=metric(g,"vpv")?formatRevenue(metric(g,"vpv")):"—";var d,s;html+='<div class="grid-row traffic-type-parent devices-parent" role="row" data-device-type="'+escapeHtml(dKey)+'"><div class="grid-cell" role="cell"><button type="button" class="traffic-type-toggle devices-toggle" data-device-type="'+escapeHtml(dKey)+'" aria-expanded="'+(open?"true":"false")+'"><span class="tt-device-icon" aria-hidden="true">'+(d=(dKey||"").trim().toLowerCase(),s='width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"',("desktop"===d?'<i class="'+s+' fa-light fa-desktop" data-icon-key="type-device-desktop"></i>':"mobile"===d?'<i class="'+s+' fa-light fa-mobile-screen" data-icon-key="type-device-mobile"></i>':"tablet"===d?'<i class="'+s+' fa-light fa-tablet-screen-button" data-icon-key="type-device-tablet"></i>':'<i class="'+s+' fa-light fa-globe" data-icon-key="type-device-unknown"></i>')+"</span><span>")+escapeHtml(label)+'</span></button></div><div class="grid-cell" role="cell">'+escapeHtml(sessions||"-")+'</div><div class="grid-cell" role="cell">'+escapeHtml(orders||"-")+'</div><div class="grid-cell" role="cell">'+escapeHtml(cr||"-")+'</div><div class="grid-cell" role="cell">'+vpv+'</div><div class="grid-cell" role="cell">'+(rev||"-")+"</div></div>";const kids=g&&Array.isArray(g.platforms)?g.platforms.slice():[];kids.sort(function(a,b){let primary=0;return primary="device"===by?cmpNullableText(a&&a.platform?String(a.platform):"",b&&b.platform?String(b.platform):"",dir):cmpNullableNumber(metric(a,by),metric(b,by),dir),primary||cmpNullableNumber(metric(a,"rev"),metric(b,"rev"),"desc")||cmpNullableNumber(metric(a,"orders"),metric(b,"orders"),"desc")||cmpNullableNumber(metric(a,"sessions"),metric(b,"sessions"),"desc")||cmpNullableText(a&&a.platform?String(a.platform):"",b&&b.platform?String(b.platform):"","asc")}),kids.forEach(function(c){const platform=c&&null!=c.platform?String(c.platform).trim().toLowerCase():"other",clabel=platform||"other",ccr=c&&"number"==typeof c.conversion_pct?pct(c.conversion_pct):"-",corders=c&&"number"==typeof c.orders?formatSessions(c.orders):"-",csessions=c&&"number"==typeof c.sessions?formatSessions(c.sessions):"-",crev=c&&"number"==typeof c.revenue_gbp?formatRevenueTableHtml(c.revenue_gbp):"-",cvpv=null!=metric(c,"vpv")?formatRevenue(metric(c,"vpv")):"—";html+='<div class="grid-row traffic-type-child devices-child'+(open?"":" is-hidden")+'" role="row" data-parent="'+escapeHtml(dKey)+'"><div class="grid-cell" role="cell"><span class="d-inline-flex align-items-center gap-2">'+function(platform){var p=(platform||"").trim().toLowerCase();return"ios"===p?'<i class="fa-light fa-apple" data-icon-key="type-platform-ios"></i>':"mac"===p?'<i class="fa-light fa-apple" data-icon-key="type-platform-mac"></i>':"android"===p?'<i class="fa-light fa-android" data-icon-key="type-platform-android"></i>':"windows"===p?'<i class="fa-light fa-windows" data-icon-key="type-platform-windows"></i>':"chromeos"===p?'<i class="fa-brands fa-chrome" data-icon-key="type-platform-chromeos"></i>':"linux"===p?'<i class="fa-light fa-linux" data-icon-key="type-platform-linux"></i>':'<i class="fa-light fa-circle-question" data-icon-key="type-platform-unknown"></i>'}(platform)+"<span>"+escapeHtml(clabel)+'</span></span></div><div class="grid-cell" role="cell">'+escapeHtml(csessions||"-")+'</div><div class="grid-cell" role="cell">'+escapeHtml(corders||"-")+'</div><div class="grid-cell" role="cell">'+escapeHtml(ccr||"-")+'</div><div class="grid-cell" role="cell">'+cvpv+'</div><div class="grid-cell" role="cell">'+(crev||"-")+"</div></div>"})}),body.innerHTML=html,updateSortHeadersInContainer(document.getElementById("devices-table"),by,dir)}function renderDevices(data){devicesCache=data||devicesCache||null;try{renderDevicesTables(devicesCache||{})}catch(_){}try{!function(data){const el=document.getElementById("devices-chart");if(!el)return;const chartKey="devices-chart";if(!isChartEnabledByUiConfig(chartKey,!0)){try{if(el.__kexoChartInstance){try{el.__kexoChartInstance.destroy()}catch(_){}el.__kexoChartInstance=null}}catch(_){}return void(el.innerHTML="")}const rows=data&&data.devices&&Array.isArray(data.devices.rows)?data.devices.rows.slice():[];if(!rows.length)return void(el.innerHTML='<div class="kexo-chart-empty kexo-chart-empty--h320">No device data</div>');function deviceLabel(r){return(r&&null!=r.device_type?String(r.device_type).trim().toLowerCase():"")||"unknown"}function titleCase(s){const raw=String(s||"").trim();return raw?raw.slice(0,1).toUpperCase()+raw.slice(1):"Unknown"}function metricValue(r,metricKey){return r?"orders"===metricKey?Math.max(0,Number(r.orders)||0):"revenue"===metricKey?Math.max(0,Number(r.revenue_gbp)||0):Math.max(0,Number(r.sessions)||0):0}const rawMode=chartModeFromUiConfig(chartKey,"line")||"line",showEndLabels="multi-line-labels"===rawMode,mode="multi-line-labels"===rawMode?"line":rawMode,metricKey=chartPieMetricFromUiConfig(chartKey,"sessions"),palette=chartColorsFromUiConfig(chartKey,["#4b94e4","#f59e34","#3eb3ab","#8b5cf6","#ef4444","#22c55e"]),isCurrency="revenue"===metricKey,seriesName="orders"===metricKey?"Orders":"revenue"===metricKey?"Revenue":"Sessions",items=rows.map(function(r){return{label:titleCase(deviceLabel(r)),value:metricValue(r,metricKey)}}).filter(function(it){return it&&it.value>0}).sort(function(a,b){return b.value-a.value||String(a.label).localeCompare(String(b.label))}).slice(0,10);if(!items.length)return void(el.innerHTML='<div class="kexo-chart-empty kexo-chart-empty--h320">No device data</div>');const categories=items.map(function(it){return it.label}),values=items.map(function(it){return it.value}),series="pie"===String(mode).toLowerCase()?categories.map(function(name,idx){return{name:name,data:[values[idx]]}}):[{name:seriesName,data:values}];try{window.kexoRenderApexChart({chartKey:chartKey,containerEl:el,categories:categories,series:series,mode:mode,colors:palette,height:320,currency:isCurrency,showEndLabels:showEndLabels,chartStyle:chartStyleFromUiConfig(chartKey),advancedApexOverride:chartAdvancedOverrideFromUiConfig(chartKey,mode)})}catch(_){el.innerHTML='<div class="kexo-chart-empty kexo-chart-empty--h320 kexo-chart-empty--error">Chart rendering failed</div>'}}(devicesCache||{})}catch(_){}}function refreshDevices(options={}){const force=!!options.force;if(devicesRefreshInFlight)return devicesRefreshInFlight;const build=startReportBuild({key:"devices",title:"Preparing devices report"});return build.step("Loading device performance"),devicesRefreshInFlight=function(options={}){const force=!!options.force,devEl=document.getElementById("devices-chart");devEl&&(devEl.innerHTML='<div class="kexo-overview-chart-empty is-loading"><span class="kpi-mini-spinner" aria-hidden="true"></span><span>Loading…</span></div>');let url="/api/devices/report?range="+encodeURIComponent(getStatsRange());return force&&(url+=(url.indexOf("?")>=0?"&":"?")+"_="+Date.now()),fetchWithTimeout(url,{credentials:"same-origin",cache:force?"no-store":"default"},25e3).then(function(r){if(!r.ok)throw new Error("Devices HTTP "+r.status);return r.json()}).then(function(data){return lastDevicesFetchedAt=Date.now(),renderDevices(data&&"object"==typeof data?data:null),data}).catch(function(err){try{"function"==typeof window.kexoCaptureError&&window.kexoCaptureError(err,{context:"devicesFetch",page:PAGE})}catch(_){}return renderDevices(devicesCache||null),null})}({force:force}).finally(function(){devicesRefreshInFlight=null,build.finish()}),devicesRefreshInFlight}function browserLabel(key){var k=null==key?"":String(key).trim().toLowerCase();if(!k)return"Unknown";var names={chrome:"Chrome",safari:"Safari",edge:"Edge",firefox:"Firefox",opera:"Opera",ie:"Internet Explorer",samsung:"Samsung Internet",other:"Other",unknown:"Unknown"};return names[k]?names[k]:k.slice(0,1).toUpperCase()+k.slice(1)}function browserIconHtml(browserKeyRaw){var iconKey=function(browserKeyRaw){var k=null==browserKeyRaw?"":String(browserKeyRaw).trim().toLowerCase();return k?"chrome"===k?"type-browser-chrome":"safari"===k?"type-browser-safari":"edge"===k?"type-browser-edge":"firefox"===k?"type-browser-firefox":"opera"===k?"type-browser-opera":"ie"===k||"internet explorer"===k?"type-browser-ie":"samsung"===k||"samsung internet"===k?"type-browser-samsung":"other"===k?"type-browser-other":"unknown"===k?"type-browser-unknown":"type-browser-other":"type-browser-unknown"}(browserKeyRaw),fallback="fa-light fa-globe";
// Default glyphs come from the icon registry via data-icon-key; we provide a sensible fallback class.
return"type-browser-chrome"===iconKey?fallback="fa-brands fa-chrome":"type-browser-safari"===iconKey?fallback="fa-brands fa-safari":"type-browser-edge"===iconKey?fallback="fa-brands fa-edge":"type-browser-firefox"===iconKey?fallback="fa-brands fa-firefox-browser":"type-browser-opera"===iconKey?fallback="fa-brands fa-opera":"type-browser-ie"===iconKey?fallback="fa-brands fa-internet-explorer":"type-browser-unknown"===iconKey&&(fallback="fa-light fa-circle-question"),'<i class="'+fallback+'" data-icon-key="'+escapeHtml(iconKey)+'" aria-hidden="true"></i>'}function renderBrowsersTables(data){const body=document.getElementById("browsers-body");if(!body)return;const by=(tableSortState.browsers.by||"rev").toString().trim().toLowerCase(),dir="asc"===(tableSortState.browsers.dir||"desc").toString().trim().toLowerCase()?"asc":"desc",filtered=(data&&data.browsers&&Array.isArray(data.browsers.rows)?data.browsers.rows.slice():[]).filter(function(r){const s=r&&"number"==typeof r.sessions?r.sessions:0,o=r&&"number"==typeof r.orders?r.orders:0;return s>=1||o>=1});function rowBrowserKey(r){if(!r)return"unknown";return(null!=r.ua_browser?String(r.ua_browser).trim().toLowerCase():"")||"unknown"}function metric(r,key){return r?"browser"===key?browserLabel(rowBrowserKey(r)):"sessions"===key?"number"==typeof r.sessions?r.sessions:null:"carts"===key?"number"==typeof r.carts?r.carts:null:"orders"===key?"number"==typeof r.orders?r.orders:null:"cr"===key?"number"==typeof r.cr?r.cr:null:"vpv"===key?"number"==typeof r.vpv?r.vpv:null:"rev"===key?"number"==typeof r.revenue?r.revenue:null:"aov"===key&&"number"==typeof r.aov?r.aov:null:null}if(filtered.sort(function(a,b){let primary=0;return primary="browser"===by?cmpNullableText(metric(a,"browser"),metric(b,"browser"),dir):cmpNullableNumber(metric(a,by),metric(b,by),dir),primary||cmpNullableNumber(metric(a,"rev"),metric(b,"rev"),"desc")||cmpNullableNumber(metric(a,"orders"),metric(b,"orders"),"desc")||cmpNullableNumber(metric(a,"sessions"),metric(b,"sessions"),"desc")||cmpNullableText(metric(a,"browser"),metric(b,"browser"),"asc")}),!filtered.length)return body.innerHTML='<div class="grid-row" role="row"><div class="grid-cell empty span-all" role="cell">No browser data yet.</div></div>',updateCardPagination("browsers",1,1),void updateSortHeadersInContainer(document.getElementById("browsers-table"),by,dir);const pageSize=getTableRowsPerPage("browsers-table","live"),totalPages=Math.max(1,Math.ceil(filtered.length/pageSize));browsersPage=clampPage(browsersPage,totalPages),updateCardPagination("browsers",browsersPage,totalPages);const pageStart=(browsersPage-1)*pageSize,pageRows=filtered.slice(pageStart,pageStart+pageSize);let html="";pageRows.forEach(function(r){const k=rowBrowserKey(r),label=browserLabel(k),sessions=r&&"number"==typeof r.sessions?formatSessions(r.sessions):"—",carts=r&&"number"==typeof r.carts?formatSessions(r.carts):"—",orders=r&&"number"==typeof r.orders?formatSessions(r.orders):"—",cr=r&&"number"==typeof r.cr?pct(r.cr):"—",vpv=r&&"number"==typeof r.vpv?formatRevenue(r.vpv):"—",rev=r&&"number"==typeof r.revenue?formatRevenueTableHtml(r.revenue):"—",aov=r&&"number"==typeof r.aov?formatRevenue(r.aov):"—";html+='<div class="grid-row" role="row"><div class="grid-cell" role="cell"><span class="d-inline-flex align-items-center gap-2"><span class="tt-browser-icon" aria-hidden="true">'+browserIconHtml(k)+"</span><span>"+escapeHtml(label)+'</span></span></div><div class="grid-cell" role="cell">'+escapeHtml(sessions)+'</div><div class="grid-cell" role="cell">'+escapeHtml(carts)+'</div><div class="grid-cell" role="cell">'+escapeHtml(orders)+'</div><div class="grid-cell" role="cell">'+escapeHtml(cr)+'</div><div class="grid-cell" role="cell">'+escapeHtml(vpv)+'</div><div class="grid-cell" role="cell">'+(rev||"—")+'</div><div class="grid-cell" role="cell">'+escapeHtml(aov)+"</div></div>"}),body.innerHTML=html,updateSortHeadersInContainer(document.getElementById("browsers-table"),by,dir);try{window.KexoIconTheme&&"function"==typeof window.KexoIconTheme.refresh&&window.KexoIconTheme.refresh()}catch(_){}}function renderBrowsers(data){browsersCache=data||browsersCache||null;try{renderBrowsersTables(browsersCache||{})}catch(_){}try{!function(data){const el=document.getElementById("browsers-chart");if(!el)return;const chartKey="browsers-chart";if(!isChartEnabledByUiConfig(chartKey,!0)){try{if(el.__kexoChartInstance){try{el.__kexoChartInstance.destroy()}catch(_){}el.__kexoChartInstance=null}}catch(_){}return void(el.innerHTML="")}const rows=data&&data.browsers&&Array.isArray(data.browsers.rows)?data.browsers.rows.slice():[];if(!rows.length)return void(el.innerHTML='<div class="kexo-chart-empty kexo-chart-empty--h320">No browser data</div>');function metricValue(r,metricKey){return r?"orders"===metricKey?Math.max(0,Number(r.orders)||0):"revenue"===metricKey?Math.max(0,Number(r.revenue)||0):Math.max(0,Number(r.sessions)||0):0}const rawMode=chartModeFromUiConfig(chartKey,"line")||"line",showEndLabels="multi-line-labels"===rawMode,mode="multi-line-labels"===rawMode?"line":rawMode,metricKey=chartPieMetricFromUiConfig(chartKey,"sessions"),palette=chartColorsFromUiConfig(chartKey,["#4b94e4","#f59e34","#3eb3ab","#8b5cf6","#ef4444","#22c55e"]),isCurrency="revenue"===metricKey,seriesName="orders"===metricKey?"Orders":"revenue"===metricKey?"Revenue":"Sessions",items=rows.map(function(r){return{label:browserLabel(r&&null!=r.ua_browser?String(r.ua_browser).trim().toLowerCase():"unknown"),value:metricValue(r,metricKey)}}).filter(function(it){return it&&it.value>0}).sort(function(a,b){return b.value-a.value||String(a.label).localeCompare(String(b.label))}).slice(0,10);if(!items.length)return void(el.innerHTML='<div class="kexo-chart-empty kexo-chart-empty--h320">No browser data</div>');const categories=items.map(function(it){return it.label}),values=items.map(function(it){return it.value}),series="pie"===String(mode).toLowerCase()?categories.map(function(name,idx){return{name:name,data:[values[idx]]}}):[{name:seriesName,data:values}];try{window.kexoRenderApexChart({chartKey:chartKey,containerEl:el,categories:categories,series:series,mode:mode,colors:palette,height:320,currency:isCurrency,showEndLabels:showEndLabels,chartStyle:chartStyleFromUiConfig(chartKey),advancedApexOverride:chartAdvancedOverrideFromUiConfig(chartKey,mode)})}catch(_){el.innerHTML='<div class="kexo-chart-empty kexo-chart-empty--h320 kexo-chart-empty--error">Chart rendering failed</div>'}}(browsersCache||{})}catch(_){}}function setBrowsersUpdated(label){const el=document.getElementById("browsers-updated");el&&(el.textContent=label||"Updated —")}function refreshBrowsers(options={}){const force=!!options.force;if(browsersRefreshInFlight)return browsersRefreshInFlight;const build=startReportBuild({key:"browsers",title:"Preparing browsers report"});return build.step("Loading browser performance"),browsersRefreshInFlight=function(options={}){const force=!!options.force;let url="/api/browsers/table?range="+encodeURIComponent(getStatsRange());return force&&(url+=(url.indexOf("?")>=0?"&":"?")+"_="+Date.now()),fetchWithTimeout(url,{credentials:"same-origin",cache:force?"no-store":"default"},25e3).then(function(r){if(!r.ok)throw new Error("Browsers HTTP "+r.status);return r.json()}).then(function(payload){lastBrowsersFetchedAt=Date.now();try{setBrowsersUpdated("Updated "+new Date(lastBrowsersFetchedAt).toLocaleString("en-GB"))}catch(_){setBrowsersUpdated("Updated")}return renderBrowsers(payload&&"object"==typeof payload?{browsers:{rows:Array.isArray(payload.rows)?payload.rows:[]},meta:payload}:null),payload}).catch(function(err){try{"function"==typeof window.kexoCaptureError&&window.kexoCaptureError(err,{context:"browsersFetch",page:PAGE})}catch(_){}return setBrowsersUpdated("Failed to load"),renderBrowsers(browsersCache||null),null})}({force:force}).finally(function(){browsersRefreshInFlight=null,build.finish()}),browsersRefreshInFlight}function shortTimeLabel(tsMs){var ts=Number(tsMs);if(!Number.isFinite(ts))return"";try{return new Intl.DateTimeFormat("en-GB",{hour:"2-digit",minute:"2-digit",hour12:!1}).format(new Date(ts))}catch(_){return""}}function shortDateTimeLabel(tsMs){var ts=Number(tsMs);if(!Number.isFinite(ts))return"";try{return new Intl.DateTimeFormat("en-GB",{day:"numeric",month:"short",hour:"2-digit",minute:"2-digit",hour12:!1}).format(new Date(ts))}catch(_){return""}}function setLiveOnlineMapState(el,text,opts){if(el){var message=String(null==text?"":text).trim()||"Unavailable",isError=!(!opts||!opts.error),isLoading=!(!opts||!opts.loading)||!isError&&/loading/i.test(message),h=opts&&Number.isFinite(opts.height)?Math.max(80,opts.height):220,chartKey=opts&&null!=opts.chartKey?String(opts.chartKey).trim():"live-online-chart";if(isError&&captureChartMessage(message,"liveOnlineMapState",{chartKey:chartKey},"error"),isLoading)el.innerHTML='<div class="kexo-overview-chart-empty is-loading" data-kexo-chart-empty="1" style="height:'+String(h)+'px"><span class="kpi-mini-spinner" aria-hidden="true"></span><span>'+escapeHtml(message)+"</span></div>";else{var cls="kexo-chart-empty"+(isError?" kexo-chart-empty--error":"");el.innerHTML='<div class="'+cls+'" data-kexo-chart-empty="1">'+escapeHtml(message)+"</div>";try{var child=el.querySelector('[data-kexo-chart-empty="1"]');child&&child.style&&(child.style.height=String(h)+"px")}catch(_){}}}}function renderLiveOnlineMapChartFromSessions(sessionList){var el=document.getElementById("live-online-chart"),chartKey="live-online-chart";if(el||(el=document.getElementById("countries-map-chart"),chartKey="countries-map-chart"),el){var setState="countries-map-chart"===chartKey?setCountriesMapState:setLiveOnlineMapState,meta="function"==typeof window.kexoChartMeta?window.kexoChartMeta(chartKey):null,baseHeight=meta&&Number.isFinite(Number(meta.height))?Number(meta.height):220,pct=chartSizePercentFromUiConfig(chartKey,100),mapHeight=Math.round(baseHeight*(pct/100));mapHeight<80&&(mapHeight=80);
// On /dashboard/overview the widget cards stretch to match row height; size the map to fill the
// available space to avoid unused whitespace below the SVG.
try{var parent=el&&el.parentElement?el.parentElement:null,pr=parent&&parent.getBoundingClientRect?parent.getBoundingClientRect():null,ph=pr&&Number.isFinite(Number(pr.height))?Number(pr.height):0;ph>mapHeight+20&&(mapHeight=Math.max(mapHeight,Math.round(ph)))}catch(_){}if(isChartEnabledByUiConfig(chartKey,!0)){if("undefined"==typeof jsVectorMap){el.__kexoJvmWaitTries||setState(el,"Loading map library...",{height:mapHeight,chartKey:chartKey});
// Avoid an unbounded retry loop if the CDN/map script is blocked (adblock/network).
var tries=(el.__kexoJvmWaitTries||0)+1;return el.__kexoJvmWaitTries=tries,tries>=25?(el.__kexoJvmWaitTries=0,void setState(el,"Map library failed to load.",{error:!0,height:mapHeight,chartKey:chartKey})):void setTimeout(function(){renderLiveOnlineMapChartFromSessions(sessionList)},200)}try{el.__kexoJvmWaitTries=0}catch(_){}
// jsVectorMap snapshots container size at init; wait until the container is measurable.
try{var rect=el&&el.getBoundingClientRect?el.getBoundingClientRect():null;if(!(rect&&rect.width>20&&rect.height>20)){var sizeTries=(el.__kexoJvmSizeWaitTries||0)+1;return el.__kexoJvmSizeWaitTries=sizeTries,void(sizeTries<=60?setTimeout(function(){renderLiveOnlineMapChartFromSessions(sessionList)},220):el.__kexoJvmSizeWaitTries=0)}el.__kexoJvmSizeWaitTries=0}catch(_){}var rawMode=chartModeFromUiConfig(chartKey,"map-animated")||"map-animated";"map-animated"!==(rawMode=String(rawMode||"").trim().toLowerCase())&&(rawMode="map-animated");for(var list=Array.isArray(sessionList)?sessionList:Array.isArray(sessions)?sessions:[],countsByIso2={},stageCountsByIso2={},i=0;i<list.length;i++){var s=list[i],isoSrc=!s||null==s.country_code&&null==s.cf_country?null:s.country_code||s.cf_country,iso=null!=isoSrc?String(isoSrc).trim().toUpperCase().slice(0,2):"XX";if(iso&&"XX"!==iso){"UK"===iso&&(iso="GB"),countsByIso2[iso]=(countsByIso2[iso]||0)+1;var st=liveStageFromSession(s),bucket=stageCountsByIso2[iso];bucket||(bucket=stageCountsByIso2[iso]={browse:0,cart:0,checkout:0,purchase:0}),"purchase"===st?bucket.purchase++:"checkout"===st?bucket.checkout++:"cart"===st?bucket.cart++:bucket.browse++}}var keys=Object.keys(countsByIso2),hasNoLiveActivity=!keys.length,palette=chartColorsFromUiConfig("countries-map-chart"===chartKey?"live-online-chart":chartKey,["#16a34a"]),accent=palette&&palette[0]?String(palette[0]).trim():"#16a34a",mapStyleEarly=chartStyleFromUiConfig(chartKey),showEmptyCaption=!1!==mapStyleEarly.mapShowEmptyCaption,stageColors={browse:mapStyleEarly.mapStageBrowseColor||"",cart:mapStyleEarly.mapStageCartColor||"",checkout:mapStyleEarly.mapStageCheckoutColor||"",purchase:mapStyleEarly.mapStagePurchaseColor||""};try{var root=document&&document.documentElement?document.documentElement:null;if(root&&root.style)[["--kexo-map-stage-browse",stageColors.browse],["--kexo-map-stage-cart",stageColors.cart],["--kexo-map-stage-checkout",stageColors.checkout],["--kexo-map-stage-purchase",stageColors.purchase]].forEach(function(p){var key=p[0],val=p[1];val?root.style.setProperty(key,val):root.style.removeProperty(key)})}catch(_){}for(var sigParts=[],k=0;k<keys.length;k++){var code=keys[k],sc=stageCountsByIso2[code]||{};sigParts.push(code+":"+String(countsByIso2[code]||0)+":"+String(sc.browse||0)+","+String(sc.cart||0)+","+String(sc.checkout||0)+","+String(sc.purchase||0))}sigParts.sort();var sig=rawMode+"|"+accent+"|fo:"+String(mapStyleEarly&&null!=mapStyleEarly.fillOpacity?mapStyleEarly.fillOpacity:"")+"|inact:"+String(mapStyleEarly&&null!=mapStyleEarly.mapInactiveOpacity?mapStyleEarly.mapInactiveOpacity:"")+"|inactc:"+String(mapStyleEarly&&null!=mapStyleEarly.mapInactiveColor?mapStyleEarly.mapInactiveColor:"")+"|fit:"+String(mapStyleEarly&&null!=mapStyleEarly.mapFit?mapStyleEarly.mapFit:"")+"|"+sigParts.join("|");if(liveOnlineMapChartInstance&&el.__kexoLiveOnlineMapSig===sig){var lastBurstAt=0;try{lastBurstAt=Number(el.__kexoLiveOnlineFlowBurstAt)||0}catch(_){lastBurstAt=0}if(!lastBurstAt||Date.now()-lastBurstAt>3e4){try{el.__kexoLiveOnlineFlowBurstAt=Date.now()}catch(_){}setTimeout(function(){try{var pseudo=keys.map(function(iso2){return{country_code:iso2,converted:countsByIso2[iso2]||0}});pseudo.sort(function(a,b){return Number(b&&b.converted)-Number(a&&a.converted)});var originIso=pseudo&&pseudo[0]&&pseudo[0].country_code?String(pseudo[0].country_code):"GB",rgb2=null;try{rgb2=String(el.__kexoLiveOnlineMapPrimaryRgb||"").trim()}catch(_){rgb2=""}rgb2||(rgb2="22,163,74"),renderLiveActivityOverlay(el,stageCountsByIso2,countsByIso2,{animated:!0,primaryRgb:rgb2,originIso2:originIso,topN:9,stageColors:stageColors})}catch(_){}},120)}}else{try{el.__kexoLiveOnlineMapSig=sig}catch(_){}
// Switching chart types: clear Apex instance.
if(liveOnlineChart){try{liveOnlineChart.destroy()}catch(_){}liveOnlineChart=null}liveOnlineChartType="";try{var rootCss=getComputedStyle(document.documentElement),border=(rootCss.getPropertyValue("--tblr-border-color")||"#d4dee5").trim(),muted=(rootCss.getPropertyValue("--tblr-secondary")||"#626976").trim();function rgbFromColor(c){var s=String(c||"").trim(),m=/^#([0-9a-f]{6})$/i.exec(s);if(m){var hex=m[1],r=parseInt(hex.slice(0,2),16),g=parseInt(hex.slice(2,4),16),b=parseInt(hex.slice(4,6),16);return{r:r,g:g,b:b,rgb:r+","+g+","+b}}if(m=/^rgba?\(\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})/i.exec(s)){var rr=Math.max(0,Math.min(255,parseInt(m[1],10)||0)),gg=Math.max(0,Math.min(255,parseInt(m[2],10)||0)),bb=Math.max(0,Math.min(255,parseInt(m[3],10)||0));return{r:rr,g:gg,b:bb,rgb:rr+","+gg+","+bb}}return{r:22,g:163,b:74,rgb:"22,163,74"}}var primaryRgb=rgbFromColor(accent).rgb;try{el.__kexoLiveOnlineMapPrimaryRgb=primaryRgb}catch(_){}var fo=mapStyleEarly&&Number.isFinite(Number(mapStyleEarly.fillOpacity))?Math.max(0,Math.min(1,Number(mapStyleEarly.fillOpacity))):.18,alphaMult=fo>0?fo/.18:0;function a(x){return Math.max(0,Math.min(1,x*alphaMult))}Number.isFinite(alphaMult)||(alphaMult=1),alphaMult=Math.max(0,Math.min(3,alphaMult));var inactiveOpacity=.09,inactiveRgb=primaryRgb;try{mapStyleEarly&&Number.isFinite(Number(mapStyleEarly.mapInactiveOpacity))&&(inactiveOpacity=Math.max(0,Math.min(1,Number(mapStyleEarly.mapInactiveOpacity))));var inactiveColor=mapStyleEarly&&null!=mapStyleEarly.mapInactiveColor?String(mapStyleEarly.mapInactiveColor).trim():"";inactiveColor&&(inactiveRgb=rgbFromColor(inactiveColor).rgb)}catch(_){}var regionFillByIso2=buildMapFillScaleByIso(countsByIso2,primaryRgb,a(.18),a(.24),a(.92),inactiveRgb,inactiveOpacity);
// If the map instance already exists and the chart mode/palette is unchanged,
// update fills/overlay in-place (avoid destroy/recreate churn on every refresh).
if(liveOnlineMapChartInstance&&el.__kexoLiveOnlineMapMode===rawMode&&el.__kexoLiveOnlineMapAccent===accent&&liveOnlineMapChartInstance.regions){try{var regionsExisting=liveOnlineMapChartInstance.regions;for(var codeExisting in regionFillByIso2)if(regionsExisting[codeExisting]&&regionsExisting[codeExisting].element&&"function"==typeof regionsExisting[codeExisting].element.setStyle)try{regionsExisting[codeExisting].element.setStyle("fill",regionFillByIso2[codeExisting])}catch(_){}}catch(_){}try{var prevCaption=el.querySelector(".kexo-live-map-empty-caption");prevCaption&&prevCaption.parentNode&&prevCaption.parentNode.removeChild(prevCaption)}catch(_){}if(hasNoLiveActivity&&showEmptyCaption){var noActivity2=document.createElement("div");noActivity2.setAttribute("class","kexo-live-map-empty-caption"),noActivity2.style.cssText="position:absolute;left:0;right:0;bottom:12px;text-align:center;font-size:.8125rem;color:"+(muted||"var(--tblr-secondary)")+";pointer-events:none;",noActivity2.textContent="No live activity yet",el&&el.style&&(el.style.position="relative");try{el.appendChild(noActivity2)}catch(_){}}hideMapTooltipOnLeave(el),setTimeout(function(){try{var pseudo2=keys.map(function(iso2){return{country_code:iso2,converted:countsByIso2[iso2]||0}});pseudo2.sort(function(a,b){return Number(b&&b.converted)-Number(a&&a.converted)});var originIso2=pseudo2&&pseudo2[0]&&pseudo2[0].country_code?String(pseudo2[0].country_code):"GB";renderLiveActivityOverlay(el,stageCountsByIso2,countsByIso2,{animated:true,primaryRgb:primaryRgb,originIso2:originIso2,topN:9,stageColors:stageColors})}catch(_){}},90);try{"function"==typeof liveOnlineMapChartInstance.updateSize&&liveOnlineMapChartInstance.updateSize()}catch(_){}return}if(liveOnlineMapChartInstance){try{liveOnlineMapChartInstance.destroy()}catch(_){}liveOnlineMapChartInstance=null}clearCountriesFlowOverlay(el),el.style.height=mapHeight+"px",el.style.minHeight=mapHeight+"px",el.innerHTML="";var mapStyle=chartStyleFromUiConfig(chartKey),showTooltip=!1!==mapStyle.mapShowTooltip,draggable=!1!==mapStyle.mapDraggable,zoomButtons=!1!==mapStyle.mapZoomButtons,focusOnLive=(showEmptyCaption=!1!==mapStyle.mapShowEmptyCaption,function(){try{var sorted=keys.slice().sort(function(a,b){return(countsByIso2[b]||0)-(countsByIso2[a]||0)}),top=sorted&&sorted[0]?String(sorted[0]||"").trim().toUpperCase().slice(0,2):"";if(top)return{region:top,animate:!1}}catch(_){}return{}}());liveOnlineMapChartInstance=renderOnlineMapInto(chartKey,chartKey,{setState:setState,mapHeight:mapHeight,regionFillByIso2:regionFillByIso2,primaryRgb:primaryRgb,border:border,muted:muted,showTooltip:showTooltip,draggable:draggable,zoomButtons:zoomButtons,initialZoomMax:2.1,focusOn:focusOnLive,retry:function(){renderLiveOnlineMapChartFromSessions(sessionList)},onRegionTooltipShow:function(event,tooltip,code2){var iso2=(code2||"").toString().trim().toUpperCase(),name=liveOnlineMapChartInstance&&"function"==typeof liveOnlineMapChartInstance.getRegionName&&liveOnlineMapChartInstance.getRegionName(iso2)||iso2,n=countsByIso2[iso2]||0;if(n){var sessionsText=formatSessions(n);setVectorMapTooltipContent(tooltip,'<div class="kexo-map-tooltip-card"><div class="kexo-map-tooltip-name">'+escapeHtml(name)+'</div><div class="kexo-map-tooltip-meta text-secondary">Sessions (last 5m): <span class="kexo-map-tooltip-value">'+escapeHtml(sessionsText)+"</span></div>"+function(){var sc=stageCountsByIso2[iso2]||{},b=Number(sc.browse||0)||0,c=Number(sc.cart||0)||0,co=Number(sc.checkout||0)||0,p=Number(sc.purchase||0)||0;return'<div class="kexo-map-tooltip-grid"><span class="kexo-map-stage-dot kexo-map-stage-dot--browse" aria-hidden="true"></span><span class="kexo-map-stage-label text-secondary">Browsing</span><span>'+escapeHtml(String(b))+'</span><span class="kexo-map-stage-dot kexo-map-stage-dot--cart" aria-hidden="true"></span><span class="kexo-map-stage-label text-secondary">In cart</span><span>'+escapeHtml(String(c))+'</span><span class="kexo-map-stage-dot kexo-map-stage-dot--checkout" aria-hidden="true"></span><span class="kexo-map-stage-label text-secondary">Checkout</span><span>'+escapeHtml(String(co))+'</span><span class="kexo-map-stage-dot kexo-map-stage-dot--purchase" aria-hidden="true"></span><span class="kexo-map-stage-label text-secondary">Purchased</span><span>'+escapeHtml(String(p))+"</span></div>"}()+"</div>",name+" | Sessions (last 5m): "+sessionsText)}else setVectorMapTooltipContent(tooltip,'<div class="kexo-map-tooltip-title kexo-map-tooltip-title--min140">'+escapeHtml(name)+"</div>",name)},afterMapCreated:function(instance,containerEl){try{containerEl.__kexoLiveOnlineMapMode=rawMode}catch(_){}try{containerEl.__kexoLiveOnlineMapAccent=accent}catch(_){}try{containerEl.__kexoLiveOnlineMapPrimaryRgb=primaryRgb}catch(_){}if(hasNoLiveActivity&&showEmptyCaption){var noActivity=document.createElement("div");noActivity.setAttribute("class","kexo-live-map-empty-caption"),noActivity.textContent="No live activity yet";try{containerEl&&containerEl.classList&&containerEl.classList.add("kexo-live-map-container")}catch(_){}try{containerEl.appendChild(noActivity)}catch(_){}}setTimeout(function(){try{var pseudo=keys.map(function(iso2){return{country_code:iso2,converted:countsByIso2[iso2]||0}});pseudo.sort(function(a,b){return Number(b&&b.converted)-Number(a&&a.converted)});var originIso=pseudo&&pseudo[0]&&pseudo[0].country_code?String(pseudo[0].country_code):"GB";renderLiveActivityOverlay(containerEl,stageCountsByIso2,countsByIso2,{animated:true,primaryRgb:primaryRgb,originIso2:originIso,topN:9,stageColors:stageColors})}catch(_){}},120)}})}catch(err){captureChartError(err,"liveOnlineMapRender",{chartKey:chartKey}),console.error("[live-online-map] render error:",err),setState(el,"Map rendering failed.",{error:!0,height:mapHeight,chartKey:chartKey})}}}else{if(liveOnlineChart){try{liveOnlineChart.destroy()}catch(_){}liveOnlineChart=null}if(liveOnlineChartType="",liveOnlineMapChartInstance){try{liveOnlineMapChartInstance.destroy()}catch(_){}liveOnlineMapChartInstance=null}clearCountriesFlowOverlay(el);try{el.__kexoLiveOnlineMapSig=""}catch(_){}try{el.__kexoLiveOnlineMapMode=""}catch(_){}try{el.__kexoLiveOnlineMapAccent=""}catch(_){}el.innerHTML=""}}function liveStageFromSession(s){try{if(s&&(1===s.has_purchased||!0===s.has_purchased||null!=s.purchased_at&&Number(s.purchased_at)>0))return"purchase";if(s&&(1===s.is_checking_out||!0===s.is_checking_out||null!=s.checkout_started_at&&Number(s.checkout_started_at)>0))return"checkout";var cartQty=s&&null!=s.cart_qty?Number(s.cart_qty):0;if(Number.isFinite(cartQty)&&cartQty>0)return"cart"}catch(_){}return"browse"}}function normalizeLiveOnlineSessionList(list){var next=Array.isArray(list)?list.slice():[];if(!next.length)return[];var cutoff=Date.now()-3e5,arrivedCutoff=Date.now()-36e5;return(next=next.filter(function(s){return s&&null!=s.last_seen&&s.last_seen>=cutoff&&null!=s.started_at&&s.started_at>=arrivedCutoff})).sort(function(a,b){return(b.last_seen||0)-(a.last_seen||0)}),next}function fetchLiveOnlineMapSessions(options){var force=!!(options=options||{}).force,now=Date.now(),ttlMs="number"==typeof ONLINE_COUNT_POLL_MS?ONLINE_COUNT_POLL_MS:15e3;if(!force){if("live"===lastSessionsMode&&Array.isArray(sessions)&&sessions.length&&lastSessionsFetchedAt&&now-lastSessionsFetchedAt<ttlMs)return liveOnlineMapSessions=normalizeLiveOnlineSessionList(sessions),liveOnlineMapSessionsFetchedAt=lastSessionsFetchedAt||now,Promise.resolve(liveOnlineMapSessions);if(Array.isArray(liveOnlineMapSessions)&&liveOnlineMapSessions.length&&liveOnlineMapSessionsFetchedAt&&now-liveOnlineMapSessionsFetchedAt<ttlMs)return Promise.resolve(liveOnlineMapSessions)}if(liveOnlineMapSessionsInFlight)return liveOnlineMapSessionsInFlight;var url="/api/sessions?filter=active&_="+Date.now();return liveOnlineMapSessionsInFlight=fetchWithTimeout(url,{credentials:"same-origin",cache:"no-store"},15e3).then(function(r){return r&&r.ok?r.json():null}).then(function(data){var list=data&&Array.isArray(data.sessions)?data.sessions:[];return liveOnlineMapSessions=normalizeLiveOnlineSessionList(list),liveOnlineMapSessionsFetchedAt=Date.now(),liveOnlineMapSessions}).catch(function(err){try{"function"==typeof window.kexoCaptureError&&window.kexoCaptureError(err,{context:"liveOnlineMapSessions",page:PAGE})}catch(_){}return Array.isArray(liveOnlineMapSessions)?liveOnlineMapSessions:[]}).finally(function(){liveOnlineMapSessionsInFlight=null}),liveOnlineMapSessionsInFlight}function refreshLiveOnlineChart(options){
// Live online container always uses jsVectorMap (map-animated). No Apex trend chart in this container.
return fetchLiveOnlineMapSessions(options||{}).then(function(list){try{renderLiveOnlineMapChartFromSessions(Array.isArray(list)?list:[])}catch(_){}return list||null})}function renderSessionsOverviewChart(payload,rangeKey){var el=document.getElementById("sessions-overview-chart");if(el){if("undefined"==typeof ApexCharts){
// Avoid an unbounded retry loop if the CDN is blocked (adblock/network).
const tries=(el.__kexoApexWaitTries||0)+1;return el.__kexoApexWaitTries=tries,tries>=25?(el.__kexoApexWaitTries=0,captureChartMessage("Chart library failed to load.","sessionsOverviewLibraryLoad",{chartKey:"sales"===PAGE?"sales-overview-chart":"date-overview-chart",tries:tries},"error"),void(el.innerHTML='<div class="kexo-chart-empty kexo-chart-empty--h220">Chart library failed to load.</div>')):void setTimeout(function(){renderSessionsOverviewChart(payload,rangeKey)},180)}try{el.__kexoApexWaitTries=0}catch(_){}var chartKey="sales"===PAGE?"sales-overview-chart":"date-overview-chart";if(isChartEnabledByUiConfig(chartKey,!0)){var rows=payload&&Array.isArray(payload.series)?payload.series.slice():[];if(rangeOverviewChart){try{rangeOverviewChart.destroy()}catch(_){}rangeOverviewChart=null}if(rows.length){var chartCfg,bucket=payload&&payload.bucket?String(payload.bucket):"day",labels=rows.map(function(row){var ts=row&&null!=row.ts?Number(row.ts):NaN;return Number.isFinite(ts)?"hour"===bucket?shortTimeLabel(ts):shortDateTimeLabel(ts):""});chartCfg="sales"===PAGE?{series:[{name:"Revenue",data:rows.map(function(r){return Number(r&&r.revenue)||0})}],colors:["#0d9488"],yFormatter:function(v){return formatRevenue(Number(v))||"—"},tooltipFormatter:function(v){return formatRevenue(Number(v))||"—"}}:{series:[{name:"Sessions",data:rows.map(function(r){return Number(r&&r.sessions)||0})},{name:"Orders",data:rows.map(function(r){return Number(r&&r.orders)||0})}],colors:["#4b94e4","#f59e34"],yFormatter:function(v){return Number(v||0).toLocaleString()},tooltipFormatter:function(v){return Number(v||0).toLocaleString()}};
// Apply chart mode + palette overrides from global Charts settings.
var rawMode=chartModeFromUiConfig(chartKey,"area")||"area",showEndLabels="multi-line-labels"===rawMode,overviewType="multi-line-labels"===rawMode?"line":rawMode;overviewType=normalizeChartType(overviewType,"area"),chartCfg.colors=chartColorsFromUiConfig(chartKey,chartCfg.colors),el.innerHTML="";var overviewOpts={chart:{type:overviewType,height:220,fontFamily:"Inter, sans-serif",toolbar:{show:!1},zoom:{enabled:!1}},series:chartCfg.series,colors:chartCfg.colors,stroke:{show:!0,curve:"smooth",width:"bar"===overviewType?0:2,lineCap:"round"},fill:"area"===overviewType?{type:"gradient",gradient:{shadeIntensity:1,opacityFrom:.28,opacityTo:.08,stops:[0,100]}}:{type:"solid",opacity:1},plotOptions:"bar"===overviewType?{bar:{columnWidth:"56%",borderRadius:3}}:{},markers:{size:"line"===overviewType?3:0,hover:{size:5}},dataLabels:showEndLabels&&"line"===overviewType?{enabled:!0,formatter:function(val,ctx){try{var dp=ctx&&null!=ctx.dataPointIndex?Number(ctx.dataPointIndex):-1,w=ctx&&ctx.w?ctx.w:null;if(dp!==(w&&w.globals&&Array.isArray(w.globals.labels)?w.globals.labels.length-1:-1))return""}catch(_){return""}try{return chartCfg.tooltipFormatter(val)}catch(_){return String(val)}},style:{fontSize:"10px"},background:{enabled:!0,borderRadius:4,padding:3,opacity:.85},offsetY:-3}:{enabled:!1},xaxis:{categories:labels,labels:{style:{fontSize:"11px"}}},yaxis:{min:0,labels:{style:{fontSize:"11px"},formatter:chartCfg.yFormatter}},tooltip:{y:{formatter:chartCfg.tooltipFormatter}},grid:{borderColor:"#f0f0f0",strokeDashArray:3}};try{var overviewOverride=chartAdvancedOverrideFromUiConfig(chartKey,overviewType);overviewOverride&&isPlainObject(overviewOverride)&&(overviewOpts=deepMergeOptions(overviewOpts,overviewOverride))}catch(_){}rangeOverviewChart=new ApexCharts(el,overviewOpts);var curOverviewChart=rangeOverviewChart,overviewRenderPromise=null;try{overviewRenderPromise=curOverviewChart.render()}catch(_){overviewRenderPromise=null}if(rangeOverviewChartKey=String(rangeKey||""),overviewRenderPromise&&"function"==typeof overviewRenderPromise.then)overviewRenderPromise.then(function(){try{setTimeout(applyChangePinsOverlay,0)}catch(_){}}).catch(function(){});else try{setTimeout(applyChangePinsOverlay,0)}catch(_){}var labelEl=document.getElementById("sessions-overview-bucket-label");if(labelEl&&"sales"===PAGE){var bucketLabel="hour"===bucket?"By hour":"month"===bucket?"By month":"By day";labelEl.textContent=bucketLabel,labelEl.removeAttribute("aria-hidden")}else labelEl&&(labelEl.textContent="",labelEl.setAttribute("aria-hidden","true"))}else{el.innerHTML='<div class="kexo-chart-empty kexo-chart-empty--h220">No data for this range</div>';var lbl2=document.getElementById("sessions-overview-bucket-label");lbl2&&(lbl2.textContent="",lbl2.setAttribute("aria-hidden","true"))}}else{if(rangeOverviewChart){try{rangeOverviewChart.destroy()}catch(_){}rangeOverviewChart=null}el.innerHTML="";var lbl=document.getElementById("sessions-overview-bucket-label");lbl&&(lbl.textContent="",lbl.setAttribute("aria-hidden","true"))}}function applyChangePinsOverlay(){try{if(rangeOverviewChart!==curOverviewChart)return;if("undefined"==typeof window||"function"!=typeof window.__kexoGetChangePinsRecent)return;window.__kexoGetChangePinsRecent(120,!1).then(function(pins){try{if(rangeOverviewChart!==curOverviewChart)return;if(!pins||!Array.isArray(pins)||!pins.length)return;if(!labels||!labels.length)return;for(var idx=new Map,i=0;i<labels.length;i++){var key=null!=labels[i]?String(labels[i]):"";key&&(idx.has(key)||idx.set(key,i))}for(var ann=[],j=0;j<pins.length;j++){var p=pins[j]||{},ts=null!=p.event_ts?Number(p.event_ts):NaN;if(Number.isFinite(ts)){var cand="hour"===bucket?shortTimeLabel(ts):shortDateTimeLabel(ts);if(cand&&idx.has(cand)){var text=null!=p.title?String(p.title).trim():"";text.length>22&&(text=text.slice(0,21)+"…"),text||(text="Pin"),ann.push({x:cand,borderColor:"rgba(15,23,42,0.35)",label:{text:text,borderColor:"rgba(15,23,42,0.55)",style:{background:"rgba(15,23,42,0.75)",color:"#fff",fontSize:"10px",fontWeight:500},offsetY:-6}})}}}if(!ann.length)return;try{curOverviewChart.updateOptions({annotations:{xaxis:ann}},!1,!0)}catch(_){}}catch(_){}})}catch(_){}}}function refreshSessionsOverviewChart(options){var el=document.getElementById("sessions-overview-chart");if(!el)return Promise.resolve(null);var force=!!(options=options||{}).force,rangeKey=getStatsRange(),cacheKey=(PAGE||"page")+"|"+rangeKey;if(!force&&rangeOverviewChart&&rangeOverviewChartKey===cacheKey)return Promise.resolve(null);if(rangeOverviewChartInFlight)return rangeOverviewChartInFlight;el.innerHTML='<div class="kexo-overview-chart-empty is-loading"><span class="kpi-mini-spinner" aria-hidden="true"></span><span>Loading chart…</span></div>';var url="/api/dashboard-series?range="+encodeURIComponent(rangeKey)+getTrafficQuerySuffix()+(force?"&force=1&_="+Date.now():"");return rangeOverviewChartInFlight=fetchWithTimeout(url,{credentials:"same-origin",cache:force?"no-store":"default"},2e4).then(function(r){return r&&r.ok?r.json():null}).then(function(data){return renderSessionsOverviewChart(data||null,cacheKey),data}).catch(function(){return null}).finally(function(){rangeOverviewChartInFlight=null}),rangeOverviewChartInFlight}function refreshSessionPageCharts(options){return document.getElementById("live-online-chart")?refreshLiveOnlineChart(options||{}):document.getElementById("sessions-overview-chart")?refreshSessionsOverviewChart(options||{}):Promise.resolve(null)}try{window.refreshLiveOnlineChart=refreshLiveOnlineChart}catch(_){}function setAbandonedCartsChartTitle(totalGbp){var titleEl=document.getElementById("abandoned-carts-chart-title");if(titleEl){var n=null!=totalGbp?Number(totalGbp):NaN;Number.isFinite(n)?titleEl.textContent=formatRevenue(n)||"£—":titleEl.textContent="£—"}}function renderAbandonedCartsChart(data,cacheKey){var el=document.getElementById("abandoned-carts-chart");if(el){var chartKey="abandoned-carts-chart";if(!isChartEnabledByUiConfig(chartKey,!0)){try{if(el.__kexoChartInstance){try{el.__kexoChartInstance.destroy()}catch(_){}el.__kexoChartInstance=null}}catch(_){}return el.innerHTML="",abandonedCartsChart=null,abandonedCartsChartKey=String(cacheKey||""),void setAbandonedCartsChartTitle(null)}var series=data&&Array.isArray(data.series)?data.series:[],bucket=data&&"day"===data.bucket?"day":"hour",categories=series.map(function(p){return"day"===bucket?function(tsMs){var ts=Number(tsMs);if(!Number.isFinite(ts))return"";try{return new Intl.DateTimeFormat("en-GB",{day:"2-digit",month:"short"}).format(new Date(ts))}catch(_){return""}}(p&&p.ts):shortTimeLabel(p&&p.ts)}),nums=series.map(function(p){var n=p&&null!=p.abandoned?Number(p.abandoned):0;return Number.isFinite(n)?Math.max(0,Math.trunc(n)):0}),rawMode=chartModeFromUiConfig(chartKey,"line")||"line",showEndLabels="multi-line-labels"===rawMode,mode="multi-line-labels"===rawMode?"line":rawMode,palette=chartColorsFromUiConfig(chartKey,["#ef4444","#f59e34"]),cartColor=palette[0]||"#ef4444",checkoutColor=palette[1]||"#f59e34",colors=["checkout"===normalizeAbandonedMode(abandonedMode)?checkoutColor:cartColor];try{abandonedCartsChart=window.kexoRenderApexChart({chartKey:chartKey,containerEl:el,categories:categories,series:[{name:abandonedModeDisplayLabel(abandonedMode),data:nums}],mode:mode,colors:colors,height:280,showEndLabels:showEndLabels,chartStyle:chartStyleFromUiConfig(chartKey),advancedApexOverride:chartAdvancedOverrideFromUiConfig(chartKey,mode)})}catch(_){}abandonedCartsChartKey=String(cacheKey||""),setAbandonedCartsChartTitle(data&&null!=data.totalAbandonedGbp?Number(data.totalAbandonedGbp):null)}}function abandonedCartsSeriesCachePut(cacheKey,data){var k=String(cacheKey||"");if(k&&null!=data){abandonedCartsSeriesCache[k]=data;var idx=abandonedCartsSeriesCacheOrder.indexOf(k);for(idx>=0&&abandonedCartsSeriesCacheOrder.splice(idx,1),abandonedCartsSeriesCacheOrder.push(k);abandonedCartsSeriesCacheOrder.length>ABANDONED_CARTS_SERIES_CACHE_MAX;){var drop=abandonedCartsSeriesCacheOrder.shift();if(drop)try{delete abandonedCartsSeriesCache[drop]}catch(_){abandonedCartsSeriesCache[drop]=null}}}}function prefetchAbandonedCartsSeries(rangeKey,mode){try{if("abandoned-carts"!==PAGE)return null;var rk=String(rangeKey||"").trim().toLowerCase();if(!rk)return null;var m=normalizeAbandonedMode(mode),cacheKey=rk+"|"+m;if(abandonedCartsSeriesCache&&abandonedCartsSeriesCache[cacheKey])return null;if(abandonedCartsSeriesPrefetchInFlight&&abandonedCartsSeriesPrefetchInFlight[cacheKey])return abandonedCartsSeriesPrefetchInFlight[cacheKey];var url="/api/abandoned-carts/series?range="+encodeURIComponent(rk)+"&timezone="+encodeURIComponent(tz)+"&mode="+encodeURIComponent(m)+"&_="+Date.now();return abandonedCartsSeriesPrefetchInFlight[cacheKey]=fetchWithTimeout(url,{credentials:"same-origin",cache:"no-store"},2e4).then(function(r){return r&&r.ok?r.json():null}).then(function(data){return null!=data&&abandonedCartsSeriesCachePut(cacheKey,data),data}).catch(function(){return null}).finally(function(){try{delete abandonedCartsSeriesPrefetchInFlight[cacheKey]}catch(_){abandonedCartsSeriesPrefetchInFlight[cacheKey]=null}}),abandonedCartsSeriesPrefetchInFlight[cacheKey]}catch(_){return null}}function refreshAbandonedCartsChart(options){if(!document.getElementById("abandoned-carts-chart"))return Promise.resolve(null);var force=!!(options=options||{}).force,rangeKey=normalizeRangeKeyForApi(dateRange),modeKey=String(normalizeAbandonedMode(abandonedMode)),cacheKey=rangeKey+"|"+modeKey;if(!force&&abandonedCartsChartKey===cacheKey&&abandonedCartsChart)return Promise.resolve(null);if(!force&&abandonedCartsSeriesCache&&abandonedCartsSeriesCache[cacheKey]){try{renderAbandonedCartsChart(abandonedCartsSeriesCache[cacheKey],cacheKey)}catch(_){}try{prefetchAbandonedCartsSeries(rangeKey,"checkout"===modeKey?"cart":"checkout")}catch(_){}return Promise.resolve(abandonedCartsSeriesCache[cacheKey])}if(abandonedCartsChartInFlight&&abandonedCartsChartInFlightKey===cacheKey)return abandonedCartsChartInFlight;var url="/api/abandoned-carts/series?range="+encodeURIComponent(rangeKey)+"&timezone="+encodeURIComponent(tz)+"&mode="+encodeURIComponent(modeKey)+"&_="+Date.now(),reqSeq=++abandonedCartsChartReqSeq;abandonedCartsChartInFlightKey=cacheKey;var p=fetchWithTimeout(url,{credentials:"same-origin",cache:"no-store"},2e4).then(function(r){return r&&r.ok?r.json():null}).then(function(data){if(reqSeq!==abandonedCartsChartReqSeq)return null;renderAbandonedCartsChart(data||null,cacheKey),null!=data&&abandonedCartsSeriesCachePut(cacheKey,data);try{prefetchAbandonedCartsSeries(rangeKey,"checkout"===modeKey?"cart":"checkout")}catch(_){}return data}).catch(function(){return null}).finally(function(){abandonedCartsChartInFlight===p&&(abandonedCartsChartInFlightKey="",abandonedCartsChartInFlight=null)});return abandonedCartsChartInFlight=p,p}function clearGridTableBodyMessageState(tbody){if(tbody&&tbody.closest){var table=tbody.closest(".grid-table");if(table){table.classList.remove("kexo-grid-empty-state-active");try{var block=table.querySelector(".kexo-grid-empty-state");block&&block.parentNode&&block.parentNode.removeChild(block)}catch(_){}}}}function setGridTableBodyMessage(tbody,message,options){if(tbody){var msg=String(null==message?"":message).trim()||"—",useBlock=!!(options&&"object"==typeof options?options:{}).useBlock;if(clearGridTableBodyMessageState(tbody),useBlock&&tbody.closest){var table=tbody.closest(".grid-table");if(table){tbody.innerHTML="",table.classList.add("kexo-grid-empty-state-active");var emptyBlock=document.createElement("div");return emptyBlock.className="kexo-grid-empty-state",emptyBlock.textContent=msg,void table.appendChild(emptyBlock)}}tbody.innerHTML='<div class="grid-row" role="row"><div class="grid-cell empty span-all" role="cell">'+escapeHtml(msg)+"</div></div>"}}function renderAbandonedCartsTopCountries(payload){var tbody=document.getElementById("abandoned-carts-countries-body");if(tbody){var rows=payload&&Array.isArray(payload.rows)?payload.rows:[];rows.length?(clearGridTableBodyMessageState(tbody),tbody.innerHTML=rows.slice(0,5).map(function(r){var code=(r&&null!=r.country?String(r.country):"XX").toUpperCase().slice(0,2),label=countryLabel(code),abandoned=r&&null!=r.abandoned?Math.max(0,Math.trunc(Number(r.abandoned)||0)):0,checkout=r&&null!=r.checkout_sessions?Math.max(0,Math.trunc(Number(r.checkout_sessions)||0)):0,pctVal=r&&null!=r.abandoned_pct?pct(Number(r.abandoned_pct)):"—",valueGbp=r&&null!=r.abandoned_value_gbp?Number(r.abandoned_value_gbp):null,value=null!=valueGbp&&Number.isFinite(valueGbp)?formatRevenueTableHtml(valueGbp):"—";return'<div class="grid-row" role="row"><div class="grid-cell" role="cell"><span class="country-cell">'+flagImg(code,label)+('<span class="country-label">'+escapeHtml(label)+"</span>")+'</span></div><div class="grid-cell" role="cell">'+escapeHtml(formatSessions(abandoned))+'</div><div class="grid-cell" role="cell">'+escapeHtml(formatSessions(checkout))+'</div><div class="grid-cell" role="cell">'+escapeHtml(pctVal)+'</div><div class="grid-cell" role="cell">'+value+"</div></div>"}).join("")):setGridTableBodyMessage(tbody,"No data",{useBlock:!0})}}function renderAbandonedCartsTopCountryProducts(payload){var tbody=document.getElementById("abandoned-carts-country-products-body");if(tbody){var rows=payload&&Array.isArray(payload.rows)?payload.rows:[];rows.length?(clearGridTableBodyMessageState(tbody),tbody.innerHTML=rows.slice(0,5).map(function(r){var iso=(r&&null!=r.country?String(r.country):"XX").toUpperCase().slice(0,2),label=countryLabel(iso),productTitle=r&&null!=r.product_title?String(r.product_title).trim():"—",productHandle=r&&null!=r.product_handle?String(r.product_handle).trim().toLowerCase():"",mainBase=getMainBaseUrl(),productUrl=mainBase&&productHandle?mainBase+"/products/"+encodeURIComponent(productHandle):"#",abandoned=r&&null!=r.abandoned?Math.max(0,Math.trunc(Number(r.abandoned)||0)):0,checkout=r&&null!=r.checkout_sessions?Math.max(0,Math.trunc(Number(r.checkout_sessions)||0)):0,pctVal=r&&null!=r.abandoned_pct?pct(Number(r.abandoned_pct)):"—",valueGbp=r&&null!=r.abandoned_value_gbp?Number(r.abandoned_value_gbp):null,value=null!=valueGbp&&Number.isFinite(valueGbp)?formatRevenueTableHtml(valueGbp):"—",flag=flagImg(iso,label),titleLink=!!productHandle?'<a class="kexo-product-link js-product-modal-link" href="'+escapeHtml(productUrl)+'" target="_blank" rel="noopener"'+(productHandle?' data-product-handle="'+escapeHtml(productHandle)+'"':"")+(productTitle?' data-product-title="'+escapeHtml(productTitle)+'"':"")+">"+escapeHtml(productTitle)+"</a>":escapeHtml(productTitle);return'<div class="grid-row" role="row"><div class="grid-cell" role="cell"><span class="country-cell">'+flag+('<span class="country-product-stack"><span class="country-label">'+escapeHtml(label)+'</span><span class="country-product-label">'+titleLink+"</span></span>")+'</span></div><div class="grid-cell" role="cell">'+escapeHtml(formatSessions(abandoned))+'</div><div class="grid-cell" role="cell">'+escapeHtml(formatSessions(checkout))+'</div><div class="grid-cell" role="cell">'+escapeHtml(pctVal)+'</div><div class="grid-cell" role="cell">'+value+"</div></div>"}).join("")):setGridTableBodyMessage(tbody,"No data",{useBlock:!0})}}function refreshAbandonedCartsTopTables(options){if("abandoned-carts"!==PAGE)return Promise.resolve(null);var force=!!(options=options||{}).force,rangeKey=normalizeRangeKeyForApi(dateRange),cacheKey=rangeKey+"|"+String(normalizeAbandonedMode(abandonedMode));if(!force&&abandonedCartsTopCacheKey===cacheKey&&abandonedCartsTopCountriesCache&&abandonedCartsTopCountryProductsCache)return renderAbandonedCartsTopCountries(abandonedCartsTopCountriesCache),renderAbandonedCartsTopCountryProducts(abandonedCartsTopCountryProductsCache),Promise.resolve(null);if(abandonedCartsTopInFlight)return abandonedCartsTopInFlight;var countriesBody=document.getElementById("abandoned-carts-countries-body"),productsBody=document.getElementById("abandoned-carts-country-products-body");setGridTableBodyMessage(countriesBody,"Loading…"),setGridTableBodyMessage(productsBody,"Loading…");var qs="range="+encodeURIComponent(rangeKey)+"&timezone="+encodeURIComponent(tz)+"&mode="+encodeURIComponent(normalizeAbandonedMode(abandonedMode))+"&limit=5&_="+Date.now(),urlCountries="/api/abandoned-carts/top-countries?"+qs,urlCountryProducts="/api/abandoned-carts/top-country-products?"+qs;return abandonedCartsTopInFlight=Promise.all([fetchWithTimeout(urlCountries,{credentials:"same-origin",cache:"no-store"},2e4).then(function(r){return r&&r.ok?r.json():null}).catch(function(){return null}),fetchWithTimeout(urlCountryProducts,{credentials:"same-origin",cache:"no-store"},2e4).then(function(r){return r&&r.ok?r.json():null}).catch(function(){return null})]).then(function(arr){var a=arr&&arr[0]?arr[0]:{rows:[]},b=arr&&arr[1]?arr[1]:{rows:[]};return abandonedCartsTopCacheKey=cacheKey,abandonedCartsTopCountriesCache=a,abandonedCartsTopCountryProductsCache=b,renderAbandonedCartsTopCountries(a),renderAbandonedCartsTopCountryProducts(b),{countries:a,countryProducts:b}}).finally(function(){abandonedCartsTopInFlight=null}),abandonedCartsTopInFlight}function refreshAbandonedCarts(options){return"abandoned-carts"!==PAGE?Promise.resolve(null):(options=options||{},syncAbandonedModeUi(),Promise.all([refreshAbandonedCartsChart(options),refreshAbandonedCartsTopTables(options),fetchSessions()]))}function refreshCheckoutFunnel(options){if("checkout-funnel"!==PAGE)return Promise.resolve(null);options=options||{};var rk=void 0!==dateRange?dateRange:"today",rangeKey=normalizeRangeKeyForApi(rk),tzStr=void 0!==tz?tz:"",url="/api/insights/checkout-funnel?range="+encodeURIComponent(rangeKey)+"&timezone="+encodeURIComponent(tzStr)+(options.force?"&_="+Date.now():"");return fetch(url,{credentials:"same-origin",cache:"no-store"}).then(function(r){return r.ok?r.json():null}).then(function(data){if(null!=data){data.steps;var setCount=function(idSuffix,value){var el=document.getElementById("funnel-step-"+idSuffix+"-count");el&&(el.textContent="number"==typeof value?String(value):"—")},setPct=function(idSuffix,value){var el=document.getElementById("funnel-step-"+idSuffix+"-pct");el&&(el.textContent=null!=value&&"number"==typeof value?value+"% from previous":"")};setCount("sessions",data.sessions),setPct("sessions",null),setCount("cart",data.cart),setPct("cart",data.conversionToCart),setCount("checkout",data.checkoutStarted),setPct("checkout",data.conversionToCheckout),setCount("purchased",data.purchased),setPct("purchased",data.conversionToPurchase)}}).catch(function(){var setCount=function(idSuffix){var el=document.getElementById("funnel-step-"+idSuffix+"-count");el&&(el.textContent="—")};setCount("sessions"),setCount("cart"),setCount("checkout"),setCount("purchased")})}function fetchSessions(){if(liveRefreshInFlight)return liveRefreshInFlight;var url,isLive="live"===dateRange,build=startReportBuild({key:"sessions",overlayId:"sessions-loading-overlay",title:isLive?"Preparing live sessions":"Preparing sessions table"});if(build.step(isLive?"Loading active visitors":"Loading selected date range"),isLive)url="/api/sessions?filter=active&_="+Date.now();else{var limit=rowsPerPage,offset=(currentPage-1)*rowsPerPage;url="abandoned-carts"===PAGE?"/api/abandoned-carts/sessions?range="+encodeURIComponent(normalizeRangeKeyForApi(dateRange))+"&limit="+limit+"&offset="+offset+"&timezone="+encodeURIComponent(tz)+"&mode="+encodeURIComponent(normalizeAbandonedMode(abandonedMode))+"&_="+Date.now():"/api/sessions?range="+encodeURIComponent(normalizeRangeKeyForApi(dateRange))+"&limit="+limit+"&offset="+offset+"&timezone="+encodeURIComponent(tz)+"&_="+Date.now()}if(_fetchAbortControllers.sessions)try{_fetchAbortControllers.sessions.abort()}catch(_){}var ac="undefined"!=typeof AbortController?new AbortController:null;_fetchAbortControllers.sessions=ac;var sessionsTimeoutId=null;ac&&(sessionsTimeoutId=setTimeout(function(){try{ac.abort()}catch(_){}},15e3));var sessionsFetchStart="undefined"!=typeof performance&&performance.now?performance.now():Date.now();return liveRefreshInFlight=fetch(url,{credentials:"same-origin",cache:"no-store",signal:ac?ac.signal:void 0}).then(function(r){return r.ok?r.json():(build.step("Could not load sessions"),sessionsLoadError=502===r.status?"Server error (502). Try again or refresh.":"Server error ("+r.status+").",sessions=[],sessionsTotal=null,renderTable(),null)}).then(function(data){if(null==data)return null;if(sessionsLoadError=null,build.step("Analyzing session activity"),isLive){sessionsTotal=null;var next=data.sessions||[],cutoff=Date.now()-3e5,arrivedCutoff=Date.now()-36e5;(next=next.filter(function(s){return null!=s.last_seen&&s.last_seen>=cutoff&&null!=s.started_at&&s.started_at>=arrivedCutoff})).sort(function(a,b){return(b.last_seen||0)-(a.last_seen||0)});var listChanged=!function(a,b){if(!a&&!b)return!0;if(!a||!b||a.length!==b.length)return!1;for(var i=0;i<a.length;i++)if(a[i].session_id!==b[i].session_id)return!1;return!0}(sessions,next);sessions=next,listChanged&&(currentPage=1)}else sessions=data.sessions||[],sessionsTotal="number"==typeof data.total?data.total:sessions.length;lastSessionsMode=isLive?"live":"range",lastSessionsFetchedAt=Date.now(),isLive?nextLiveAt=Date.now()+6e4:"today"!==dateRange&&"sales"!==dateRange&&"1h"!==dateRange||(nextRangeAt=Date.now()+3e5),lastUpdateTime=new Date,updateServerTimeDisplay(),build.step("Building sessions table"),renderTable(),updateKpis();try{refreshSessionPageCharts({force:isLive})}catch(_){}return sessions}).catch(function(err){try{window.__kexoPerfMetrics=window.__kexoPerfMetrics||{},err&&"AbortError"===err.name&&(window.__kexoPerfMetrics.sessionsFetchTimeoutCount=(window.__kexoPerfMetrics.sessionsFetchTimeoutCount||0)+1)}catch(_){}if(err&&"AbortError"===err.name)return null;try{"function"==typeof window.kexoCaptureError&&window.kexoCaptureError(err,{context:"sessionsFetch",page:PAGE})}catch(_){}return build.step("Could not load sessions"),sessionsLoadError="Could not load sessions. Check connection or refresh.",sessions=[],sessionsTotal=null,currentPage=1,renderTable(),null}).finally(function(){try{"undefined"!=typeof performance&&performance.now&&null!=sessionsFetchStart&&(window.__kexoPerfMetrics=window.__kexoPerfMetrics||{},window.__kexoPerfMetrics.lastSessionsFetchMs=Math.round(100*(performance.now()-sessionsFetchStart))/100)}catch(_){}null!=sessionsTimeoutId&&(clearTimeout(sessionsTimeoutId),sessionsTimeoutId=null),liveRefreshInFlight=null,_fetchAbortControllers.sessions===ac&&(_fetchAbortControllers.sessions=null),build.finish()}),liveRefreshInFlight}function scheduleOnlineCountPoll(ms){if(
// Don't poll while hidden; resume on visibility.
bindOnlineCountVisibilityGate(),onlineCountPollTimer){try{clearTimeout(onlineCountPollTimer)}catch(_){}onlineCountPollTimer=null}if(!onlineCountAuthBlocked){var delay="number"==typeof ms&&isFinite(ms)&&ms>=0?ms:ONLINE_COUNT_POLL_MS;isDocVisible()?onlineCountPollTimer=setTimeout(function(){if(onlineCountPollTimer=null,isDocVisible())try{updateKpis()}catch(_){}else onlineCountPollPendingMs=ONLINE_COUNT_POLL_MS},delay):onlineCountPollPendingMs=delay}}function fetchOnlineCount(){if(bindOnlineCountVisibilityGate(),isDocVisible()){if(!onlineCountInFlight&&!onlineCountAuthBlocked){if(onlineCountInFlight=!0,_fetchAbortControllers.onlineCount)try{_fetchAbortControllers.onlineCount.abort()}catch(_){}var ac="undefined"!=typeof AbortController?new AbortController:null;_fetchAbortControllers.onlineCount=ac,fetch("/api/sessions?filter=active&countOnly=1&_="+Date.now(),{credentials:"same-origin",cache:"no-store",signal:ac?ac.signal:void 0}).then(function(r){return r&&r.ok?r.json():(r&&401===r.status&&(onlineCountAuthBlocked=!0),null)}).then(function(data){null!=data&&"number"==typeof data.count&&(lastOnlineCount=data.count,onlineCountLastFetchedAt=Date.now())}).catch(function(err){try{"function"==typeof window.kexoCaptureError&&window.kexoCaptureError(err,{context:"onlineCountFetch",page:PAGE})}catch(_){}}).then(function(){if(onlineCountInFlight=!1,_fetchAbortControllers.onlineCount===ac&&(_fetchAbortControllers.onlineCount=null),onlineCountAuthBlocked){if(onlineCountPollTimer){try{clearTimeout(onlineCountPollTimer)}catch(_){}onlineCountPollTimer=null}}else scheduleOnlineCountPoll(onlineCountLastFetchedAt?ONLINE_COUNT_POLL_MS:ONLINE_COUNT_RETRY_MS);updateKpis()})}}else onlineCountPollPendingMs=0}function updateKpis(){if(bindOnlineCountVisibilityGate(),!isDocVisible())return;const el=document.getElementById("online-count"),spinner=document.getElementById("online-count-spinner"),iconEl=document.getElementById("kexo-online-icon"),liveNowCountEl=document.getElementById("live-online-now-count");if(el||liveNowCountEl){if("spy"===activeMainTab&&"live"===dateRange){if("live"!==lastSessionsMode)return showSpinner(),void fetchSessions();return void showCount(sessions.filter(s=>s.last_seen>=Date.now()-3e5).length)}
// Online is real people online right now; show count regardless of date range (Today, Yesterday, etc.)
if(onlineCountAuthBlocked)
// Session/auth is no longer valid (401). Stop auto-polling to avoid API spam.
showCount(null!=lastOnlineCount?lastOnlineCount:0);else{var onlineCountIsFresh=onlineCountLastFetchedAt>0&&Date.now()-onlineCountLastFetchedAt<ONLINE_COUNT_POLL_MS;null!=lastOnlineCount?(showCount(lastOnlineCount),onlineCountIsFresh||fetchOnlineCount()):(showSpinner(),fetchOnlineCount())}}function showSpinner(){spinner&&spinner.classList.remove("is-hidden"),el&&el.classList.add("is-hidden"),iconEl&&(iconEl.classList.add("kexo-online-icon--offline"),iconEl.classList.remove("kexo-online-icon--online"))}function showCount(n){spinner&&spinner.classList.add("is-hidden"),el&&(el.classList.remove("is-hidden"),el.textContent=String(n)),iconEl&&(iconEl.classList.remove("kexo-online-icon--offline","kexo-online-icon--online"),iconEl.classList.add(n>0?"kexo-online-icon--online":"kexo-online-icon--offline")),function(n){if(liveNowCountEl){var safe=Number.isFinite(Number(n))?Math.max(0,Math.trunc(Number(n))):0;liveNowCountEl.textContent=String(safe)}}(n)}}
// Visibility gate for online count polling (avoids timer bursts on tab resume).
var onlineCountPollPendingMs=null,onlineCountVisibilityBound=!1;function isDocVisible(){try{return!document||!document.visibilityState||"visible"===document.visibilityState}catch(_){return!0}}function bindOnlineCountVisibilityGate(){if(!onlineCountVisibilityBound){onlineCountVisibilityBound=!0;try{document.addEventListener("visibilitychange",function(){if(!isDocVisible())return onlineCountPollPendingMs=ONLINE_COUNT_POLL_MS,void function(){if(onlineCountPollTimer){try{clearTimeout(onlineCountPollTimer)}catch(_){}onlineCountPollTimer=null}try{_fetchAbortControllers&&_fetchAbortControllers.onlineCount&&_fetchAbortControllers.onlineCount.abort()}catch(_){}}();var pending=onlineCountPollPendingMs;onlineCountPollPendingMs=null,onlineCountAuthBlocked||scheduleOnlineCountPoll("number"==typeof pending?pending:0)})}catch(_){}try{window.addEventListener("pageshow",function(ev){if(ev&&ev.persisted){if(onlineCountAuthBlocked)return;scheduleOnlineCountPoll(0)}})}catch(_){}}}function cfSection(title,value){const v=null!=value&&""!==String(value).trim()?String(value).trim():null;return'<div class="cf-row"><strong>'+escapeHtml(title)+":</strong> "+(v?escapeHtml(v):"—")+"</div>"}function formatBrowserLabel(session){const s=session||{},key=null!=s.ua_browser?String(s.ua_browser).trim().toLowerCase():"",vRaw=null!=s.ua_browser_version?String(s.ua_browser_version).trim():"",version=vRaw&&vRaw.length>16?vRaw.slice(0,16):vRaw;if(!key)return null;const name={chrome:"Chrome",safari:"Safari",edge:"Edge",firefox:"Firefox",opera:"Opera",ie:"Internet Explorer",samsung:"Samsung Internet",other:"Other"}[key]||(key?key.charAt(0).toUpperCase()+key.slice(1):"");return name?version?name+" "+version:name:null}function closeSidePanel(){var panel=document.getElementById("side-panel");panel&&panel.classList.add("is-hidden");var backdrop=document.getElementById("side-panel-backdrop");backdrop&&backdrop.classList.add("is-hidden"),document.body.classList.remove("side-panel-open")}function sideLookupHref(q){var qq=null!=q?String(q).trim():"";if(!qq)return"/tools/click-order-lookup";try{var shop=getShopParam()||shopForSalesFallback||"",p=new URLSearchParams;return shop&&p.set("shop",shop),p.set("q",qq),"/tools/click-order-lookup?"+p.toString()}catch(_){return"/tools/click-order-lookup?q="+encodeURIComponent(qq)}}
// Shared Click & Order Lookup renderer (Tools page + side drawer).
var clickOrderLookupUiReady=!1;try{!function(){if(!clickOrderLookupUiReady){clickOrderLookupUiReady=!0;try{window.KexoClickOrderLookupUI={renderInto:function(el,payload,options){if(el){ensureCopyLinksBound(),el.innerHTML=renderLookupHtml(payload,options||{})||"";try{el.querySelectorAll("[data-kexo-width]").forEach(function(bar){if(bar&&bar.style&&bar.getAttribute){var w=String(bar.getAttribute("data-kexo-width")||"").trim();w&&(bar.style.width=w)}})}catch(_){}try{animateFraudGauges(el)}catch(_){}}},buildHtml:renderLookupHtml,animateGauges:animateFraudGauges}}catch(_){}ensureCopyLinksBound()}function esc(v){return escapeHtml(null==v?"":String(v))}function safeJsonPre(obj){try{return JSON.stringify(obj,null,2)}catch(_){return String(obj)}}function copyLinkHtml(value){var v=null!=value?String(value).trim():"";return v?' <a href="#" class="kexo-copy-link" data-kexo-copy="'+esc(v)+'">Copy</a>':""}function ensureCopyLinksBound(){try{var root=document&&document.documentElement?document.documentElement:null;if(root&&"1"===root.getAttribute("data-kexo-copy-links"))return;root&&root.setAttribute("data-kexo-copy-links","1"),document.addEventListener("click",function(e){var target=e&&e.target?e.target:null,a=target&&target.closest?target.closest("a.kexo-copy-link[data-kexo-copy]"):null;if(a){try{e.preventDefault()}catch(_){}var txt=a.getAttribute("data-kexo-copy")||"";txt&&function(text){var value=String(null==text?"":text);if(!value)return Promise.resolve(!1);try{if(navigator&&navigator.clipboard&&"function"==typeof navigator.clipboard.writeText)return navigator.clipboard.writeText(value).then(function(){return!0}).catch(function(){return!1})}catch(_){}try{var ta=document.createElement("textarea");ta.value=value,ta.setAttribute("readonly","readonly"),ta.style.position="fixed",ta.style.top="-9999px",ta.style.left="-9999px",document.body.appendChild(ta),ta.select(),ta.setSelectionRange(0,ta.value.length);var ok=document.execCommand("copy");return document.body.removeChild(ta),Promise.resolve(!!ok)}catch(_){return Promise.resolve(!1)}}(txt).then(function(ok){var prev=a.getAttribute("data-kexo-copy-prev")||a.textContent||"Copy";try{a.setAttribute("data-kexo-copy-prev",prev)}catch(_){}try{a.textContent=ok?"Copied":"Copy"}catch(_){}setTimeout(function(){try{a.textContent=prev}catch(_){}},900)})}},!0)}catch(_){}}function animateFraudGauges(root){var scope=root&&root.querySelectorAll?root:document;Array.from(scope.querySelectorAll('[data-kexo-gauge="1"]')).forEach(function(wrap){try{if(!wrap||"1"===wrap.getAttribute("data-kexo-gauge-animated"))return;wrap.setAttribute("data-kexo-gauge-animated","1");var score=Number(wrap.getAttribute("data-score")||"0");Number.isFinite(score)||(score=0),score=Math.max(0,Math.min(100,Math.trunc(score)));var path=wrap.querySelector(".kexo-fraud-gauge-progress");if(!path||!path.getTotalLength)return;var len=path.getTotalLength();path.style.strokeDasharray=String(len),path.style.strokeDashoffset=String(len),path.getBoundingClientRect();// force layout
var target=len*(1-score/100);path.style.transition="stroke-dashoffset 900ms ease-out",requestAnimationFrame(function(){path.style.strokeDashoffset=String(target)})}catch(_){}})}function renderIdsHtml(resolved,mode){var r=resolved&&"object"==typeof resolved?resolved:{},rows=[{k:"Kexo Click ID (session)",v:r.session_id,copy:!0},{k:"Shopify order ID",v:r.order_id,copy:!0},{k:"Checkout token",v:r.checkout_token,copy:!0},{k:"Kexo order key",v:r.purchase_key,copy:!0},{k:"Visitor ID",v:r.visitor_id,copy:!1}].filter(function(x){return x&&null!=x.v&&""!==String(x.v).trim()});return rows.length?"drawer"===mode?rows.map(function(row){var v=String(row.v);return'<div class="side-panel-detail-row"><span class="side-panel-label">'+esc(row.k)+'</span><span class="side-panel-value"><code>'+esc(v)+"</code>"+(row.copy?copyLinkHtml(v):"")+"</span></div>"}).join(""):'<div class="table-responsive"><table class="table table-sm table-vcenter mb-0"><tbody>'+rows.map(function(row){var v=String(row.v);return'<tr><th class="kexo-kv-th">'+esc(row.k)+"</th><td><code>"+esc(v)+"</code>"+(row.copy?copyLinkHtml(v):"")+"</td></tr>"}).join("")+"</tbody></table></div>":'<div class="text-muted">—</div>'}function renderFraudHtml(fraudBundle,mode){var b=fraudBundle&&"object"==typeof fraudBundle?fraudBundle:null;if(!b)return'<div class="text-muted">Fraud scoring unavailable.</div>';if(!0!==b.ok||!0!==b.available)return!1===b.available?'<div class="text-muted">Fraud system unavailable.</div>':'<div class="text-muted">Fraud data unavailable.</div>';var picked=function(bundle){var b=bundle&&"object"==typeof bundle?bundle:null;if(!b||!0!==b.ok||!0!==b.available)return null;var pref=b.session&&b.session.evaluation?b.session:b.purchase&&b.purchase.evaluation?b.purchase:b.order&&b.order.evaluation?b.order:null;if(!pref||!pref.evaluation)return null;var ev=pref.evaluation||{},an=pref.analysis||{},score=null!=ev.score?Number(ev.score):0;Number.isFinite(score)||(score=0),score=Math.max(0,Math.min(100,Math.trunc(score)));var risk=an&&an.risk_level?String(an.risk_level).trim():"";return risk||(risk=score>=(null!=b.threshold?Number(b.threshold):70)?"Medium":"Low"),{score:score,risk_level:risk||"Unknown",triggered:!!ev.triggered,threshold:null!=b.threshold&&Number.isFinite(Number(b.threshold))?Number(b.threshold):null,summary:an&&an.summary?String(an.summary):"",key_reasons:an&&Array.isArray(an.key_reasons)?an.key_reasons:[],flags:Array.isArray(ev.flags)?ev.flags:[],evidence:ev.evidence&&"object"==typeof ev.evidence?ev.evidence:{}}}(b);if(!picked)return'<div class="text-muted">No fraud evaluation yet.</div>';var gauge=function(info,options){var i=info&&"object"==typeof info?info:null,score=i&&null!=i.score?Math.max(0,Math.min(100,Math.trunc(Number(i.score)||0))):0,triggered=!(!i||!0!==i.triggered),label=options&&options.label?String(options.label):"Fraud Meter",pct=String(score)+"%",safety=Math.max(0,Math.min(100,100-score)),riskLabel=safety<=49?"High":safety<=75?"Medium":"Low",barClass=safety<=49?"bg-danger":safety<=75?"bg-warning":"bg-success",statusIcon="Low"!==riskLabel||triggered?'<i class="fa-light fa-triangle-exclamation kexo-fraud-meter-status-icon is-warn tone-'+esc(safety<=49?"high":safety<=75?"medium":"low")+'" data-icon-key="table-icon-compliance-warning" aria-hidden="true"></i>':'<i class="fa-light fa-circle-check kexo-fraud-meter-status-icon is-ok" data-icon-key="table-icon-compliance-check" aria-hidden="true"></i>';return'<div class="kexo-kpi-chip kexo-fraud-meter-chip" data-kexo-fraud-meter="1" aria-label="'+esc(riskLabel+" ("+pct+" fraud score, "+String(safety)+"% safe)")+'"><div class="subheader kexo-kpi-chip-label">'+esc(label)+'</div><div class="d-flex align-items-baseline"><div class="h3 mb-0 me-2 kexo-kpi-chip-value">'+statusIcon+'<span class="kexo-fraud-meter-status-label">'+esc(riskLabel)+'</span></div><div class="me-auto"><span class="kexo-kpi-chip-delta d-inline-flex align-items-center lh-1 is-flat">'+esc(pct)+'</span></div></div><div class="progress progress-sm kexo-kpi-chip-progress" role="progressbar" aria-valuenow="'+esc(String(safety))+'" aria-valuemin="0" aria-valuemax="100"><div class="progress-bar '+esc(barClass)+'" data-kexo-width="'+esc(String(safety))+'%"></div></div></div>'}(picked,{label:"Fraud Meter"}),reasons=Array.isArray(picked.key_reasons)?picked.key_reasons:[],flags=Array.isArray(picked.flags)?picked.flags:[],reasonsHtml=reasons.length?'<ul class="kexo-fraud-reasons">'+reasons.slice(0,6).map(function(r){return"<li>"+esc(String(r))+"</li>"}).join("")+"</ul>":"",flagsHtml=flags.length?'<div class="kexo-fraud-flags">'+flags.slice(0,10).map(function(f){return'<span class="badge bg-azure-lt me-1 mb-1">'+esc(String(f))+"</span>"}).join("")+"</div>":'<div class="text-muted">No flags recorded.</div>',evidenceDetails='<details class="kexo-fraud-evidence-details"><summary class="text-muted">Show evidence snapshot</summary><pre class="mt-2 mb-0 kexo-fraud-evidence-pre kexo-pre-wrap">'+esc(safeJsonPre(picked.evidence||{})||"{}")+"</pre></details>";return"drawer"===mode?gauge+'<div class="side-panel-detail-row"><span class="side-panel-label">Summary</span><span class="side-panel-value">'+esc(picked.summary||"—")+"</span></div>"+(reasonsHtml?'<div class="kexo-fraud-reasons-wrap">'+reasonsHtml+"</div>":"")+'<div class="mt-2">'+flagsHtml+'</div><div class="mt-2">'+evidenceDetails+"</div>":gauge+'<div class="mt-2"><div class="text-muted small">Summary</div><div>'+esc(picked.summary||"—")+"</div>"+(reasonsHtml?'<div class="mt-2">'+reasonsHtml+"</div>":"")+'<div class="mt-2">'+flagsHtml+'</div><div class="mt-2">'+evidenceDetails+"</div></div>"}function renderLookupHtml(payload,options){var mode=options&&options.mode?String(options.mode):"page";if(!payload||!payload.ok){var err=payload&&payload.error?String(payload.error):"Lookup failed.";return"drawer"===mode?'<div class="side-panel-detail-row"><span class="side-panel-value muted">'+esc(err)+"</span></div>":'<div class="alert alert-danger mb-0">'+esc(err)+"</div>"}var resolved=payload.resolved&&"object"==typeof payload.resolved?payload.resolved:{},events=Array.isArray(payload.events)?payload.events:[],session=payload.session&&"object"==typeof payload.session?payload.session:null,purchases=Array.isArray(payload.purchases)?payload.purchases:[],attribution=payload.attribution&&"object"==typeof payload.attribution?payload.attribution:null,fraud=payload.fraud&&"object"==typeof payload.fraud?payload.fraud:null;function section(title,inner){return'<div class="card mt-3"><div class="card-header"><h3 class="card-title">'+esc(title)+'</h3></div><div class="card-body">'+(inner||"")+"</div></div>"}if("drawer"===mode){
// Provide a direct link to the full tool page.
var openLink='<div class="side-panel-detail-row"><span class="side-panel-label">Lookup</span><span class="side-panel-value"><a href="'+esc(sideLookupHref(resolved&&resolved.session_id?String(resolved.session_id):payload&&payload.q?String(payload.q):""))+'" target="_blank" rel="noopener">Open in Lookup</a></span></div>',idsHtml=renderIdsHtml(resolved,"drawer"),sessionMini="";try{if(session&&"object"==typeof session){var started=formatTs(session.started_at)||"—",seen=formatTs(session.last_seen)||"—",cartQty=null!=session.cart_qty?String(session.cart_qty):"0";sessionMini='<div class="side-panel-detail-row"><span class="side-panel-label">Started</span><span class="side-panel-value">'+esc(started)+'</span></div><div class="side-panel-detail-row"><span class="side-panel-label">Seen</span><span class="side-panel-value">'+esc(seen)+'</span></div><div class="side-panel-detail-row"><span class="side-panel-label">Cart qty</span><span class="side-panel-value">'+esc(cartQty)+"</span></div>",session.has_purchased&&(sessionMini+='<div class="side-panel-detail-row"><span class="side-panel-label">Sale</span><span class="side-panel-value">'+esc(formatMoney(session.order_total,session.order_currency)||"—")+(session.purchased_at?' <span class="text-muted">('+esc(formatTs(session.purchased_at)||"")+")</span>":"")+"</span></div>")}}catch(_){sessionMini=""}return'<div class="kexo-lookup-drawer-root"><div class="kexo-lookup-drawer-block">'+openLink+idsHtml+sessionMini+'</div><div class="kexo-lookup-drawer-block">'+renderFraudHtml(fraud,"drawer")+'</div><div class="kexo-lookup-drawer-block">'+(attribution?'<details class="kexo-lookup-attribution-details"><summary class="text-muted">Show attribution</summary><pre class="mt-2 mb-0 kexo-pre-wrap">'+esc(safeJsonPre(attribution))+"</pre></details>":'<div class="text-muted">No attribution row.</div>')+"</div></div>"}var html="";if(html+=section("Resolved IDs",renderIdsHtml(resolved,"page")),html+=section("Activity",function(events){var list=Array.isArray(events)?events:[];return list.length?'<ul class="side-panel-events kexo-lookup-events">'+list.filter(function(e){return e&&"heartbeat"!==e.type}).slice().reverse().slice(0,30).map(function(e){var path=(e.path||"").trim();!path&&e.product_handle&&(path="/products/"+(e.product_handle||"")),path&&!path.startsWith("/")&&(path="/"+path);var pathLabel=path||e.product_handle||"";return"<li><span>"+(formatTs(e.ts)||"—")+" "+esc(e.type)+" "+esc(pathLabel)+(null!=e.qty_delta?" — "+esc(e.qty_delta):"")+"</span></li>"}).join("")+"</ul>":'<div class="text-muted">No activity.</div>'}(events)),session){var utm=[session.utm_source,session.utm_medium,session.utm_campaign,session.utm_content].filter(Boolean).join(" / "),attrib=[session.attribution_channel,session.attribution_source,session.attribution_variant].filter(Boolean).join(" / ");session.attribution_confidence&&(attrib=attrib?attrib+" ("+session.attribution_confidence+")":String(session.attribution_confidence)),html+=section("Session",'<div class="table-responsive"><table class="table table-sm table-vcenter mb-0"><tbody>'+[{k:"Started",v:formatTs(session.started_at)||"—"},{k:"Last seen",v:formatTs(session.last_seen)||"—"},{k:"Country",v:session.country_code||"—"},{k:"Device",v:session.device||"—"},{k:"UA device/platform",v:((session.ua_device_type||"")+" / "+(session.ua_platform||"")+(session.ua_model?" / "+session.ua_model:"")).trim()||"—"},{k:"Attribution",v:attrib||"—"},{k:"Entry URL",v:session.entry_url||"—"},{k:"Referrer",v:session.referrer||"—"},{k:"UTM",v:utm||"—"}].map(function(r){return'<tr><th class="kexo-kv-th">'+esc(r.k)+"</th><td><code>"+esc(r.v)+"</code></td></tr>"}).join("")+"</tbody></table></div>")}return purchases&&purchases.length&&(html+=section("Purchases",purchases.slice(0,5).map(function(p){return p&&"object"==typeof p?'<div class="mb-3"><div class="table-responsive"><table class="table table-sm table-vcenter mb-0"><tbody>'+[{k:"Purchase key",v:p.purchase_key||"—"},{k:"Purchased at",v:formatTs(p.purchased_at)||"—"},{k:"Order ID",v:p.order_id||"—"},{k:"Checkout token",v:p.checkout_token||"—"},{k:"Total",v:(null!=p.order_total?String(p.order_total):"—")+(p.order_currency?" "+p.order_currency:"")}].map(function(r){return'<tr><th class="kexo-kv-th">'+esc(r.k)+"</th><td><code>"+esc(r.v)+"</code></td></tr>"}).join("")+"</tbody></table></div></div>":""}).join(""))),html+=section("Fraud",renderFraudHtml(fraud,"page")),attribution&&(html+=section("Attribution",'<details><summary class="text-muted">Show attribution payload</summary><pre class="mt-2 mb-0 kexo-pre-wrap">'+esc(safeJsonPre(attribution))+"</pre></details>")),html}}()}catch(_){}function openSidePanel(sessionId){const panel=document.getElementById("side-panel");if(!panel)return;try{selectedSessionId=sessionId}catch(_){}const backdrop=function(){if(!document.getElementById("side-panel"))return null;var backdrop=document.getElementById("side-panel-backdrop");return backdrop||((backdrop=document.createElement("div")).id="side-panel-backdrop",backdrop.className="side-panel-backdrop is-hidden",document.body.appendChild(backdrop)),backdrop.dataset.bound||(backdrop.addEventListener("click",function(){closeSidePanel()}),backdrop.dataset.bound="1"),backdrop}();panel.classList.remove("is-hidden"),backdrop&&backdrop.classList.remove("is-hidden"),document.body.classList.add("side-panel-open"),document.getElementById("side-events").innerHTML='<li class="muted">Loading…</li>',document.getElementById("side-meta").innerHTML='<div class="side-panel-detail-row"><span class="side-panel-value muted">Loading…</span></div>';const sideSourceEl=document.getElementById("side-source");sideSourceEl&&(sideSourceEl.innerHTML="");const rowIconsEl=document.getElementById("side-row-icons");rowIconsEl&&(rowIconsEl.innerHTML=""),document.getElementById("side-cf").innerHTML="",
// Side panel section toggles: bind to the current panel (re-bind if panel DOM is replaced).
function(panelEl){try{if(!panelEl||!panelEl.addEventListener)return;if("1"===panelEl.getAttribute("data-side-toggles-wired"))return;panelEl.setAttribute("data-side-toggles-wired","1");var handler=function(e){var t=e&&e.target?e.target:null,title=t&&t.closest?t.closest(".side-panel-section-title"):null;if(title){var sec=title&&title.closest?title.closest(".side-panel-section"):null;sec&&sec.classList&&!sec.classList.contains("side-panel-summary")&&(e.preventDefault(),sec.classList.toggle("is-minimized"),title.setAttribute("aria-expanded",sec.classList.contains("is-minimized")?"false":"true"))}};panelEl.addEventListener("click",handler);try{panelEl._kexoSidePanelTogglesHandler=handler}catch(_){}try{kexoRegisterCleanup(function(){try{panelEl.removeEventListener("click",handler)}catch(_){}})}catch(_){}}catch(_){}}(panel),function(){try{panel.querySelectorAll(".side-panel-section:not(.side-panel-summary)").forEach(function(sec){sec.classList.add("is-minimized");var title=sec.querySelector(".side-panel-section-title");title&&title.setAttribute("aria-expanded","false")})}catch(_){}}();var summaryEl=function(){try{var existing=document.getElementById("side-summary");if(existing)return existing;var header=panel.querySelector(".side-panel-header");if(!header||!header.parentNode)return null;var wrap=document.createElement("section");return wrap.className="side-panel-section side-panel-summary",wrap.innerHTML='<div class="side-panel-summary-grid" id="side-summary"></div>',header.parentNode.insertBefore(wrap,header.nextSibling),wrap.querySelector("#side-summary")}catch(_){return null}}();summaryEl&&(summaryEl.innerHTML='<div class="side-panel-detail-row"><span class="side-panel-value muted">Loading…</span></div>'),function(){var shop="";try{shop=getShopParam()||shopForSalesFallback||""}catch(_){shop=""}var url="/api/tools/click-order-lookup?q="+encodeURIComponent(String(sessionId||""));shop&&(url+="&shop="+encodeURIComponent(shop)),url+="&_="+Date.now(),fetch(url,{credentials:"same-origin",cache:"no-store"}).then(function(r){return r&&r.ok?r.json():null}).then(function(payload){if(selectedSessionId===sessionId){if(!payload||!0!==payload.ok)return document.getElementById("side-events").innerHTML='<li class="muted">Unavailable.</li>',void(document.getElementById("side-meta").innerHTML='<div class="side-panel-detail-row"><span class="side-panel-value muted">Unavailable.</span></div>');var session=payload.session&&"object"==typeof payload.session?payload.session:{},events=Array.isArray(payload.events)?payload.events:[];try{if(rowIconsEl){flagImg(ccUp=(cc=session&&(session.country_code||session.cf_country)?String(session.country_code||session.cf_country):"XX")?cc.trim().toUpperCase():"XX",ccUp);var channelLabel="";try{var variantKey=session&&(session.attribution_variant??session.attributionVariant),channelKey=session&&(session.attribution_channel??session.attributionChannel),sourceKey=session&&(session.attribution_source??session.attributionSource);function titleizeAttrib(v){var s=(v||"").trim().toLowerCase();return s?"google_ads"===s?"Google Ads":"google_organic"===s?"Google":"bing_ads"===s?"Bing Ads":"bing_organic"===s?"Bing":"meta_ads"===s?"Meta Ads":"meta_organic"===s?"Meta":"paid_search"===s?"Paid search":"organic_search"===s?"Organic search":"paid_social"===s?"Paid social":"organic_social"===s?"Organic social":"email"===s?"Email":"sms"===s?"SMS":"direct"===s?"Direct":"affiliate"===s?"Affiliate":"other"===s?"Other":s.replace(/_/g," ").replace(/\b\w/g,function(m){return m.toUpperCase()}):""}if(variantKey)channelLabel=titleizeAttrib(String(variantKey).trim().toLowerCase().split(":")[0]||"");!channelLabel&&channelKey&&(channelLabel=titleizeAttrib(String(channelKey))),!channelLabel&&sourceKey&&(channelLabel=titleizeAttrib(String(sourceKey)))}catch(_){channelLabel=""}try{var info=deviceInfoForSession(session);function titleize(v){var s=(v||"").trim().toLowerCase();return s?"ios"===s?"iOS":"mac"===s?"Mac":"android"===s?"Android":"windows"===s?"Windows":"chromeos"===s?"Chrome OS":"linux"===s?"Linux":"desktop"===s?"Desktop":"mobile"===s?"Mobile":"tablet"===s?"Tablet":"iphone"===s?"iPhone":"ipad"===s?"iPad":"other"===s?"Other":"unknown"===s?"Unknown":s:""}var parts2=[];info.platform&&"unknown"!==info.platform&&parts2.push(titleize(info.platform)),info.model&&parts2.push(titleize(info.model)),info.deviceType&&"unknown"!==info.deviceType&&parts2.push(titleize(info.deviceType)),parts2.length?parts2.join(" - "):""}catch(_){0}
// Previously we showed "Other - iOS - iPhone - Mobile" under the header.
// That summary now lives in the dedicated Session block.
rowIconsEl.innerHTML=""}}catch(_){}
// Summary block (always open)
try{var sumEl=document.getElementById("side-summary");if(sumEl){var cc,ccUp,countryFlag=flagImg(ccUp=(cc=session&&(session.country_code||session.cf_country)?String(session.country_code||session.cf_country):"XX")?cc.trim().toUpperCase():"XX",ccUp),srcText="";try{srcText=sourceDetailForPanel(session)||""}catch(_){srcText=""}info=null;try{info=deviceInfoForSession(session)}catch(_){info=null}var firstSeen="",lastSeen="";try{firstSeen=arrivedAgo(session&&session.started_at)}catch(_){firstSeen=""}try{lastSeen=arrivedAgo(session&&session.last_seen)}catch(_){lastSeen=""}var visits=1;try{var rc=session&&null!=session.returning_count?Number(session.returning_count):0;visits=(Number.isFinite(rc)?rc:0)+1}catch(_){visits=1}var deviceLine="";try{function tcase(v){var s=(v||"").trim().toLowerCase();return s?"ios"===s?"iOS":"mac"===s?"Mac":"android"===s?"Android":"windows"===s?"Windows":"chromeos"===s?"Chrome OS":"linux"===s?"Linux":"desktop"===s?"Desktop":"mobile"===s?"Mobile":"tablet"===s?"Tablet":"iphone"===s?"iPhone":"ipad"===s?"iPad":"other"===s?"Other":"unknown"===s?"Unknown":s:""}var parts=[];info&&info.platform&&"unknown"!==info.platform&&parts.push(tcase(info.platform)),info&&info.model&&parts.push(tcase(info.model)),info&&info.deviceType&&"unknown"!==info.deviceType&&parts.push(tcase(info.deviceType)),deviceLine=parts.length?parts.join(" - "):"—"}catch(_){deviceLine="—"}var srcIcon="";try{srcIcon=sourceCell(session)||""}catch(_){srcIcon=""}sumEl.innerHTML='<div class="side-panel-detail-row"><span class="side-panel-label">Country</span><span class="side-panel-value">'+countryFlag+'</span></div><div class="side-panel-detail-row"><span class="side-panel-label">Source</span><span class="side-panel-value">'+(srcIcon||'<span class="muted">—</span>')+'</span></div><div class="side-panel-detail-row"><span class="side-panel-label">Device</span><span class="side-panel-value">'+escapeHtml(deviceLine||"—")+'</span></div><div class="side-panel-detail-row"><span class="side-panel-label">First seen</span><span class="side-panel-value">'+escapeHtml(firstSeen||"—")+'</span></div><div class="side-panel-detail-row"><span class="side-panel-label">Last seen</span><span class="side-panel-value">'+escapeHtml(lastSeen||"—")+'</span></div><div class="side-panel-detail-row"><span class="side-panel-label">Total visits</span><span class="side-panel-value">'+escapeHtml(String(visits))+"</span></div>"}}catch(_){}
// Activity (newest-first), with og thumbs (same UX as legacy drawer).
try{var mainBase=getMainBaseUrl(),eventsHtml=events.filter(function(e){return e&&"heartbeat"!==e.type}).slice().reverse().map(function(e){var path=(e.path||"").trim();!path&&e.product_handle&&(path="/products/"+(e.product_handle||"")),path&&!path.startsWith("/")&&(path="/"+path);var pathLabel=path||e.product_handle||"",fullUrl=mainBase&&path?mainBase+path:"";return"<li>"+(fullUrl?'<img class="landing-thumb" src="/api/og-thumb?url='+encodeURIComponent(fullUrl)+'&width=100" alt="" onerror="this.classList.add(\'is-hidden\')">':"")+"<span>"+(formatTs(e.ts)+" "+escapeHtml(e.type)+" "+escapeHtml(pathLabel)+(null!=e.qty_delta?" Δ"+e.qty_delta:""))+"</span></li>"}).join("");document.getElementById("side-events").innerHTML=eventsHtml||'<li class="muted">No events</li>'}catch(_){document.getElementById("side-events").innerHTML='<li class="muted">No events</li>'}
// Details (single source of truth): render lookup bundle in drawer mode.
try{var metaEl=document.getElementById("side-meta");metaEl&&window.KexoClickOrderLookupUI&&"function"==typeof window.KexoClickOrderLookupUI.renderInto?window.KexoClickOrderLookupUI.renderInto(metaEl,payload,{mode:"drawer"}):metaEl&&(metaEl.innerHTML='<div class="side-panel-detail-row"><span class="side-panel-value muted">Lookup UI unavailable.</span></div>')}catch(_){}try{if(sideSourceEl){srcText=sourceDetailForPanel(session);var entryUrl=session&&null!=session.entry_url?String(session.entry_url).trim():"",fullUrl="";try{fullUrl=buildFullEntryUrlForCopy(session)||""}catch(_){fullUrl=""}var copyUrl=fullUrl||entryUrl,html='<div class="side-panel-source-text">'+escapeHtml(String(srcText||"—")).replace(/\n/g,"<br>")+"</div>";copyUrl&&(html+='<div class="side-panel-source-actions"><a href="#" class="kexo-copy-link" data-kexo-copy="'+escapeHtml(copyUrl)+'">Copy URL</a></div>'),sideSourceEl.innerHTML=html}}catch(_){}try{document.getElementById("side-cf").innerHTML=function(session){const s=session||{};return[["Country & Device",cfSection("Country",s.cf_country||s.country_code)+cfSection("Device",s.device)+cfSection("Browser",formatBrowserLabel(s))],["Referrer / Entry",cfSection("Referrer",s.referrer)+cfSection("Entry URL",s.entry_url)],["City",cfSection("City",s.cf_city||s.city||null)]].map(function(b){return'<div class="side-panel-cf-block"><div class="side-panel-cf-subtitle">'+escapeHtml(b[0])+"</div>"+b[1]+"</div>"}).join("")}(session)}catch(_){}}}).catch(function(){document.getElementById("side-events").innerHTML='<li class="muted">Failed to load.</li>',document.getElementById("side-meta").innerHTML='<div class="side-panel-detail-row"><span class="side-panel-value muted">Failed to load.</span></div>'})}()}const sideCloseBtn=document.getElementById("side-close");
// Session table pagination (live/sales/date) ??? delegated
var wrap;function setDiagnosticsActionMsg(text,ok){var el=document.getElementById("config-action-msg");el&&(el.textContent=text||"",el.className="form-hint "+(ok?"text-success":"text-danger"))}function edgeBlocksButtonHtml(count,rangeKey){var label="—";try{null!=count&&"function"==typeof fmtSessions?label=fmtSessions(count):null!=count&&(label=String(count))}catch(_){label=null!=count?String(count):"—"}return'<button type="button" class="btn btn-link p-0 kexo-edge-blocks-open-btn" data-edge-blocks-range="'+escapeHtml(rangeKey&&"7d"===String(rangeKey).trim().toLowerCase()?"7d":"24h")+'" disabled aria-disabled="true" title="Admin only">'+escapeHtml(label)+"</button>"}function reconcileSalesTruth(options={}){const btn=document.getElementById("config-reconcile-btn");btn&&(btn.classList.add("spinning"),btn.disabled=!0),setDiagnosticsActionMsg("Reconciling Shopify truth (7d)…",!0);const p=fetch(function(options={}){var url="/api/reconcile-sales?range=7d";try{var shop=getShopParam();!shop&&"string"==typeof shopForSalesFallback&&shopForSalesFallback&&(shop=shopForSalesFallback),shop&&(url+=(url.indexOf("?")>=0?"&":"?")+"shop="+encodeURIComponent(shop))}catch(_){}return options&&options.force&&(url+=(url.indexOf("?")>=0?"&":"?")+"_="+Date.now()),url}({force:!0}),{method:"POST",credentials:"same-origin",cache:"no-store"}).then(function(r){return r.json()}).then(function(payload){try{refreshConfigStatus({force:!0,preserveView:!0})}catch(_){}try{refreshAttribution({force:!0})}catch(_){}try{refreshDevices({force:!0})}catch(_){}try{refreshBrowsers({force:!0})}catch(_){}var details=payload&&payload.result?payload.result:null,fetched=details&&"number"==typeof details.fetched?details.fetched:null,inserted=details&&"number"==typeof details.inserted?details.inserted:null,updated=details&&"number"==typeof details.updated?details.updated:null,linked=details&&"number"==typeof details.evidenceLinked?details.evidenceLinked:null,bits=[];null!=fetched&&bits.push("fetched "+String(fetched)),null!=inserted&&bits.push("inserted "+String(inserted)),null!=updated&&bits.push("updated "+String(updated)),null!=linked&&bits.push("linked "+String(linked)),setDiagnosticsActionMsg(bits.length?"Reconcile done: "+bits.join(", "):"Reconcile done.",!0)}).catch(function(err){setDiagnosticsActionMsg("Reconcile failed: "+(err&&err.message?String(err.message).slice(0,120):"request_failed"),!1)}).finally(()=>{btn&&(btn.classList.remove("spinning"),btn.disabled=!1)});return p}sideCloseBtn&&sideCloseBtn.addEventListener("click",closeSidePanel),document.addEventListener("keydown",function(e){if(e&&"Escape"===e.key){var panel=document.getElementById("side-panel");panel&&!panel.classList.contains("is-hidden")&&closeSidePanel()}}),
// Guard delegated clicks + dedupe stable diagnostics reads to avoid jank.
(wrap=document.getElementById("table-pagination"))&&wrap.addEventListener("click",function(e){var link=e&&e.target&&e.target.closest?e.target.closest("a[data-page]"):null;if(link&&(e.preventDefault(),!link.closest(".page-item.disabled")&&!link.closest(".page-item.active"))){var pg=parseInt(link.dataset.page,10);!pg||pg<1||(currentPage=pg,null!=sessionsTotal?fetchSessions():renderTable())}}),document.querySelectorAll(".table-scroll-wrap .grid-cell.sortable").forEach(function(th){function activate(){var col=(th.getAttribute("data-sort")||"").trim();col&&(sortBy===col?sortDir="asc"===sortDir?"desc":"asc":(sortBy=col,sortDir=SORT_DEFAULTS[col]||"asc"),renderTable())}th.addEventListener("click",function(e){e&&"function"==typeof e.preventDefault&&e.preventDefault(),shouldIgnoreStickyResizeSortClick(e)||activate()}),th.addEventListener("keydown",function(e){!e||"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),activate())})}),document.querySelectorAll("#best-sellers-wrap .grid-cell.sortable").forEach(function(th){function activate(){var col=(th.getAttribute("data-sort")||"").trim();col&&(bestSellersSortBy===col?bestSellersSortDir="asc"===bestSellersSortDir?"desc":"asc":(bestSellersSortBy=col,bestSellersSortDir="title"===col?"asc":"desc"),bestSellersPage=1,updateBestSellersSortHeaders(),fetchBestSellers())}th.addEventListener("click",function(e){e&&"function"==typeof e.preventDefault&&e.preventDefault(),shouldIgnoreStickyResizeSortClick(e)||activate()}),th.addEventListener("keydown",function(e){!e||"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),activate())})}),setupTableSortHeaders(document.getElementById("country-table"),tableSortState.country,TABLE_SORT_DEFAULTS_country,function(info){info&&info.columnChanged&&(countryPage=1),renderCountry(statsCache)}),setupTableSortHeaders(document.getElementById("best-geo-products-table"),tableSortState.bestGeoProducts,TABLE_SORT_DEFAULTS_bestGeoProducts,function(info){info&&info.columnChanged&&(bestGeoProductsPage=1),renderBestGeoProducts(statsCache)}),setupTableSortHeaders(document.getElementById("best-variants-table"),tableSortState.bestVariants,TABLE_SORT_DEFAULTS_bestVariants,function(info){if(info&&info.columnChanged)return bestVariantsPage=1,void fetchBestVariants();bestVariantsCache?renderBestVariants(bestVariantsCache):fetchBestVariants()}),setupTableSortHeaders(document.getElementById("attribution-table"),tableSortState.attribution,TABLE_SORT_DEFAULTS_attribution,function(info){info&&info.columnChanged&&(attributionPage=1),renderAttributionTables(attributionCache||{})}),setupTableSortHeaders(document.getElementById("devices-table"),tableSortState.devices,TABLE_SORT_DEFAULTS_devices,function(info){info&&info.columnChanged&&(devicesPage=1),renderDevicesTables(devicesCache||{})}),setupTableSortHeaders(document.getElementById("browsers-table"),tableSortState.browsers,TABLE_SORT_DEFAULTS_browsers,function(info){info&&info.columnChanged&&(browsersPage=1),renderBrowsersTables(browsersCache||{})}),
// Card-table pagination ??? event delegation on containers
function(){function bindDelegate(prefix,goToPage){var wrap=document.getElementById(prefix+"-pagination");wrap&&wrap.addEventListener("click",function(e){var link=e&&e.target&&e.target.closest?e.target.closest("a[data-page]"):null;if(link&&(e.preventDefault(),!link.closest(".page-item.disabled")&&!link.closest(".page-item.active"))){var pg=parseInt(link.dataset.page,10);!pg||pg<1||goToPage(pg)}})}bindDelegate("country",function(pg){countryPage=pg,renderCountry(statsCache)}),bindDelegate("best-geo-products",function(pg){bestGeoProductsPage=pg,renderBestGeoProducts(statsCache)}),bindDelegate("best-sellers",function(pg){bestSellersPage=pg,fetchBestSellers()}),bindDelegate("best-variants",function(pg){bestVariantsPage=pg,fetchBestVariants()}),bindDelegate("attribution",function(pg){attributionPage=pg,renderAttributionTables(attributionCache||{})}),bindDelegate("devices",function(pg){devicesPage=pg,renderDevicesTables(devicesCache||{})}),bindDelegate("browsers",function(pg){browsersPage=pg,renderBrowsersTables(browsersCache||{})}),bindDelegate("dash-top-products",function(pg){dashTopProductsPage=pg,rerenderDashboardFromCache()}),bindDelegate("dash-top-countries",function(pg){dashTopCountriesPage=pg,rerenderDashboardFromCache()}),bindDelegate("dash-trending",function(pg){dashTrendingPage=pg,rerenderDashboardFromCache()}),bindDelegate("breakdown-aov",function(pg){breakdownAovPage=pg,renderAov(statsCache)}),bindDelegate("breakdown-title",function(pg){breakdownTitlePage=pg,function(data){const tbody=document.getElementById("breakdown-title-body");if(!tbody)return;const list=!(!data||!data.ok)&&data.byTitle||[];if(!list.length)return tbody.innerHTML='<div class="grid-row" role="row"><div class="grid-cell empty span-all" role="cell">'+(leaderboardLoading?"Loading…":"No data")+"</div></div>",void updateCardPagination("breakdown-title",1,1);var totalPages=Math.max(1,Math.ceil(list.length/10));updateCardPagination("breakdown-title",breakdownTitlePage=clampPage(breakdownTitlePage,totalPages),totalPages);var start=10*(breakdownTitlePage-1),pageRows=list.slice(start,start+10);const mainBase=getMainBaseUrl();tbody.innerHTML=pageRows.map(function(row){const title=row&&null!=row.title?String(row.title):"Product",handle=row&&row.handle?String(row.handle):"",productId=row&&row.product_id?String(row.product_id).replace(/^gid:\/\/shopify\/Product\//i,"").trim():"",rev=row&&null!=row.revenueGbp?Number(row.revenueGbp):0,value=formatMoneyCompact(Number.isFinite(rev)?rev:0,"GBP")||"£0",cr=row&&null!=row.cr?pct(row.cr):"—",productUrl=mainBase&&handle?mainBase+"/products/"+encodeURIComponent(handle):"#",normalizedHandle=handle?String(handle).trim().toLowerCase():"";return'<div class="grid-row" role="row"><div class="grid-cell" role="cell"><span class="breakdown-cell"><span class="breakdown-thumb-wrap" aria-hidden="true"><i class="fa-light fa-image" data-icon-key="breakdown-placeholder-image" aria-hidden="true"></i></span><span class="breakdown-label"><span class="breakdown-product-name">'+(normalizedHandle||productId&&/^\d+$/.test(productId)?'<a class="kexo-product-link js-product-modal-link" href="'+escapeHtml(productUrl)+'" target="_blank" rel="noopener"'+(normalizedHandle?' data-product-handle="'+escapeHtml(normalizedHandle)+'"':"")+(productId&&/^\d+$/.test(productId)?' data-product-id="'+escapeHtml(productId)+'"':"")+(title?' data-product-title="'+escapeHtml(title)+'"':"")+">"+escapeHtml(title)+"</a>":escapeHtml(title))+'</span><span class="sr-only">'+escapeHtml(title)+'</span></span></span></div><div class="grid-cell" role="cell">'+escapeHtml(value)+'</div><div class="grid-cell" role="cell">'+cr+"</div></div>"}).join("")}(leaderboardCache)}),bindDelegate("breakdown-finish",function(pg){breakdownFinishPage=pg,function(data){const tbody=document.getElementById("breakdown-finish-body");if(!tbody)return;const rows=data&&Array.isArray(data.finishes)?data.finishes:[];if(!rows.length)return tbody.innerHTML='<div class="grid-row" role="row"><div class="grid-cell empty span-all" role="cell">'+(finishesLoading?"Loading…":"No data")+"</div></div>",void updateCardPagination("breakdown-finish",1,1);var ordered=rows.slice();ordered.sort(function(a,b){return cmpNullableNumber(a&&a.revenueGbp,b&&b.revenueGbp,"desc")});var totalPages=Math.max(1,Math.ceil(ordered.length/25));updateCardPagination("breakdown-finish",breakdownFinishPage=clampPage(breakdownFinishPage,totalPages),totalPages);var start=25*(breakdownFinishPage-1),pageRows=ordered.slice(start,start+25);tbody.innerHTML=pageRows.map(function(r){const label=r&&null!=r.label?String(r.label):"—",revenue=r&&null!=r.revenueGbp?Number(r.revenueGbp):null,value=null!=revenue&&Number.isFinite(revenue)?formatRevenueTableHtml(revenue):"—",cr=r&&null!=r.cr?pct(r.cr):"—";return'<div class="grid-row" role="row"><div class="grid-cell" role="cell"><span class="breakdown-cell">'+function(key){const k=(key||"").toString().trim().toLowerCase();return"gold"===k?'<span class="finish-icon finish-icon-gold" aria-hidden="true"></span>':"silver"===k?'<span class="finish-icon finish-icon-silver" aria-hidden="true"></span>':"vermeil"===k?'<span class="finish-icon finish-icon-vermeil" aria-hidden="true"></span>':"solid_silver"===k||"solid-silver"===k?'<span class="finish-icon finish-icon-solid-silver" aria-hidden="true"></span>':'<span class="breakdown-icon" aria-hidden="true"><i class="fa-light fa-star" data-icon-key="breakdown-icon-star"></i></span>'}(r&&r.key)+'<span class="breakdown-label">'+escapeHtml(label)+'</span></span></div><div class="grid-cell" role="cell">'+value+'</div><div class="grid-cell" role="cell">'+cr+"</div></div>"}).join("")}(finishesCache)}),bindDelegate("breakdown-length",function(pg){breakdownLengthPage=pg,function(data){const tbody=document.getElementById("breakdown-length-body");if(!tbody)return;const rows=data&&Array.isArray(data.lengths)?data.lengths:[];if(!rows.length)return tbody.innerHTML='<div class="grid-row" role="row"><div class="grid-cell empty span-all" role="cell">'+(lengthsLoading?"Loading…":"No data")+"</div></div>",void updateCardPagination("breakdown-length",1,1);var ordered=rows.slice();ordered.sort(function(a,b){return cmpNullableNumber(a&&a.revenueGbp,b&&b.revenueGbp,"desc")||cmpNullableNumber(a&&a.inches,b&&b.inches,"asc")});var totalPages=Math.max(1,Math.ceil(ordered.length/25));updateCardPagination("breakdown-length",breakdownLengthPage=clampPage(breakdownLengthPage,totalPages),totalPages);var start=25*(breakdownLengthPage-1),pageRows=ordered.slice(start,start+25);tbody.innerHTML=pageRows.map(function(r){const inches=r&&null!=r.inches?Number(r.inches):null,label=r&&null!=r.label?String(r.label):null!=inches&&Number.isFinite(inches)?String(inches)+'"':"—",revenue=r&&null!=r.revenueGbp?Number(r.revenueGbp):null,value=null!=revenue&&Number.isFinite(revenue)?formatRevenueTableHtml(revenue):"—",cr=r&&null!=r.cr?pct(r.cr):"—";return'<div class="grid-row" role="row"><div class="grid-cell" role="cell"><span class="breakdown-cell"><span class="breakdown-icon" aria-hidden="true"><i class="fa-light fa-chart-column" data-icon-key="breakdown-icon-chart-column"></i></span><span class="breakdown-label">'+escapeHtml(label)+'</span></span></div><div class="grid-cell" role="cell">'+value+'</div><div class="grid-cell" role="cell">'+cr+"</div></div>"}).join("")}(lengthsCache)}),bindDelegate("breakdown-chainstyle",function(pg){breakdownChainStylePage=pg,function(data){const tbody=document.getElementById("breakdown-chainstyle-body");if(!tbody)return;const rows=data&&Array.isArray(data.chainStyles)?data.chainStyles:[];if(!rows.length)return tbody.innerHTML='<div class="grid-row" role="row"><div class="grid-cell empty span-all" role="cell">'+(chainStylesLoading?"Loading…":"No data")+"</div></div>",void updateCardPagination("breakdown-chainstyle",1,1);var ordered=rows.slice();ordered.sort(function(a,b){return cmpNullableNumber(a&&a.revenueGbp,b&&b.revenueGbp,"desc")});var totalPages=Math.max(1,Math.ceil(ordered.length/25));updateCardPagination("breakdown-chainstyle",breakdownChainStylePage=clampPage(breakdownChainStylePage,totalPages),totalPages);var start=25*(breakdownChainStylePage-1),pageRows=ordered.slice(start,start+25);tbody.innerHTML=pageRows.map(function(r){const label=r&&null!=r.label?String(r.label):"—",revenue=r&&null!=r.revenueGbp?Number(r.revenueGbp):null,value=null!=revenue&&Number.isFinite(revenue)?formatRevenueTableHtml(revenue):"—",cr=r&&null!=r.cr?pct(r.cr):"—";return'<div class="grid-row" role="row"><div class="grid-cell" role="cell"><span class="breakdown-cell"><span class="breakdown-icon" aria-hidden="true"><i class="fa-light fa-link" data-icon-key="breakdown-icon-link"></i></span><span class="breakdown-label">'+escapeHtml(label)+'</span></span></div><div class="grid-cell" role="cell">'+value+'</div><div class="grid-cell" role="cell">'+cr+"</div></div>"}).join("")}(chainStylesCache)})}(),function(){
// Rows-per-page UI is intentionally hidden; keep page size fixed at default.
const sel=document.getElementById("rows-per-page-select");sel&&(sel.value=String(rowsPerPage))}();function refreshConfigStatus(options={}){if(configStatusRefreshInFlight&&!options.force)return configStatusRefreshInFlight;const refreshBtn=document.getElementById("config-refresh-btn"),configStatusEl=document.getElementById("diagnostics-content"),compareModalEl=document.getElementById("kpi-compare-modal"),compareRefreshBtn=document.getElementById("kpi-compare-refresh-btn"),compareStatusEl=document.getElementById("kpi-compare-status"),compareUpdatedEl=document.getElementById("kpi-compare-updated"),compareKickerEl=document.getElementById("kpi-compare-kicker"),compareOpen=!(!compareModalEl||!compareModalEl.classList.contains("open"));let diagnosticsStepEl=null,compareStepEl=null;const preserveView=!(!options||!options.preserveView);configStatusEl&&!preserveView&&(configStatusEl.innerHTML='<div class="d-flex align-items-center gap-2 text-secondary"><div class="spinner-border spinner-border-sm text-primary" role="status" aria-hidden="true"></div><div>Loading diagnostics…</div></div><div id="settings-diagnostics-loading-step" class="text-secondary small mt-2">—</div>',diagnosticsStepEl=configStatusEl.querySelector("#settings-diagnostics-loading-step"),diagnosticsStepEl&&(diagnosticsStepEl.textContent="Connecting to diagnostics services")),compareOpen&&compareStatusEl&&(compareStatusEl.innerHTML='<div class="kpi-compare-loading"><div class="report-build-wrap"><div class="spinner-border text-primary" role="status"></div><div class="report-build-title">building KPI comparison</div><div class="report-build-step">…</div></div></div>',compareStepEl=compareStatusEl.querySelector(".report-build-step"),compareStepEl&&(compareStepEl.textContent="Loading KPI sources")),refreshBtn&&refreshBtn.classList.add("spinning"),compareOpen&&compareRefreshBtn&&compareRefreshBtn.classList.add("spinning");var url=function(options={}){var url="/api/config-status";try{var shop=getShopParam();!shop&&"string"==typeof shopForSalesFallback&&shopForSalesFallback&&(shop=shopForSalesFallback),shop&&(url+=(url.indexOf("?")>=0?"&":"?")+"shop="+encodeURIComponent(shop))}catch(_){}try{var rangeSel=document.getElementById("diagnostics-overview-range");if(rangeSel&&rangeSel.value){var rk=normalizeRangeKeyForApi(String(rangeSel.value||"").trim().toLowerCase());rk&&(url+=(url.indexOf("?")>=0?"&":"?")+"range="+encodeURIComponent(rk))}}catch(_){}return options&&options.force&&(url+=(url.indexOf("?")>=0?"&":"?")+"_="+Date.now()),url}({force:!!options.force});const p=(options.force?fetch(url,{credentials:"same-origin",cache:"no-store"}).then(function(r){if(!r.ok)throw new Error("Config status "+r.status);return r.json()}):kexoFetchOkJsonStable(url,{credentials:"same-origin"},15e3).then(function(json){if(!json)throw new Error("Config status empty");return json})).then(c=>{function code(value){return"<code>"+escapeHtml(null==value?"":String(value))+"</code>"}function fmtSessions(n){return"number"==typeof n&&isFinite(n)?escapeHtml(formatSessions(n)):"—"}function fmtRevenue(n){return"number"==typeof n&&isFinite(n)?escapeHtml(formatRevenue(n)):"—"}function fmtPct(p){if("number"!=typeof p||!isFinite(p))return"—";return escapeHtml((Math.round(100*p)/100).toFixed(2).replace(/\.?0+$/,"")+"%")}diagnosticsStepEl&&(diagnosticsStepEl.textContent="Analyzing diagnostics payload"),compareStepEl&&(compareStepEl.textContent="Comparing KPI values");const app=c&&c.app?c.app:{},shopify=c&&c.shopify?c.shopify:{},db=c&&c.db?c.db:{},ingest=c&&c.ingest?c.ingest:{},reporting=c&&c.reporting?c.reporting:{},traffic=c&&c.traffic?c.traffic:{},sales=c&&c.sales?c.sales:{},truth=sales&&sales.truth?sales.truth:{},truthToday=truth&&truth.today?truth.today:{},health=truth&&truth.health?truth.health:{},evidenceToday=sales&&sales.evidence&&sales.evidence.today?sales.evidence.today:{},pixelDerivedToday=(sales&&sales.drift&&"number"==typeof sales.drift.orders&&sales.drift.orders,sales&&sales.pixel&&sales.pixel.today?sales.pixel.today:{}),pixelDerivedOrders="number"==typeof pixelDerivedToday.orderCount?pixelDerivedToday.orderCount:null,pixelDerivedRevenue="number"==typeof pixelDerivedToday.revenueGbp?pixelDerivedToday.revenueGbp:null,driftPixelOrders=sales&&sales.drift&&"number"==typeof sales.drift.pixelVsTruthOrders?sales.drift.pixelVsTruthOrders:null,driftPixelRevenue=sales&&sales.drift&&"number"==typeof sales.drift.pixelVsTruthRevenueGbp?sales.drift.pixelVsTruthRevenueGbp:null,missingEvidenceToday=sales&&sales.missingEvidence&&sales.missingEvidence.today?sales.missingEvidence.today:{},missingEvidenceCount=missingEvidenceToday&&"number"==typeof missingEvidenceToday.missingOrderCount?missingEvidenceToday.missingOrderCount:null,missingEvidenceSample=missingEvidenceToday&&Array.isArray(missingEvidenceToday.missingOrdersSample)?missingEvidenceToday.missingOrdersSample:[],missingEvidenceNote=missingEvidenceToday&&"string"==typeof missingEvidenceToday.note?missingEvidenceToday.note:"",pixel=c&&c.pixel?c.pixel:{},appSettings=c&&c.settings?c.settings:{},trackerDefinitions=c&&c.trackerDefinitions?c.trackerDefinitions:null,pixelSessionMode=appSettings&&null!=appSettings.pixelSessionMode?String(appSettings.pixelSessionMode).trim().toLowerCase():"legacy",sharedSessionFixEnabled="shared_ttl"===pixelSessionMode,truthOrders="number"==typeof truthToday.orderCount?truthToday.orderCount:null,truthRevenue="number"==typeof truthToday.revenueGbp?truthToday.revenueGbp:null,truthCheckoutOrders="number"==typeof truthToday.checkoutOrderCount?truthToday.checkoutOrderCount:null,truthCheckoutRevenue="number"==typeof truthToday.checkoutRevenueGbp?truthToday.checkoutRevenueGbp:null,truthReturningCustomers="number"==typeof truthToday.returningCustomerCount?truthToday.returningCustomerCount:null,truthReturningRevenue="number"==typeof truthToday.returningRevenueGbp?truthToday.returningRevenueGbp:null,evTotal="number"==typeof evidenceToday.checkoutCompleted?evidenceToday.checkoutCompleted:null,evSessions="number"==typeof evidenceToday.checkoutCompletedSessions?evidenceToday.checkoutCompletedSessions:null,evLinked="number"==typeof evidenceToday.linked?evidenceToday.linked:null,evUnlinked="number"==typeof evidenceToday.unlinked?evidenceToday.unlinked:null,staleSec=health&&"number"==typeof health.staleMs?Math.round(health.staleMs/1e3):null,SHOPIFY_LOGO_URL="https://cdn.shopify.com/s/files/1/0847/7261/8587/files/shopify.png?v=1770259752",KEXO_LOGO_URL="/assets/logos/new/kexo.webp",shopifySessionsToday=traffic&&"number"==typeof traffic.shopifySessionsToday?traffic.shopifySessionsToday:null,shopifyConversionRateToday=traffic&&"number"==typeof traffic.shopifyConversionRateToday?traffic.shopifyConversionRateToday:null,shopifyConversionRateNote=traffic&&"string"==typeof traffic.shopifyConversionRateTodayNote?traffic.shopifyConversionRateTodayNote:"",kexoSessionsToday=traffic&&traffic.today&&"number"==typeof traffic.today.humanSessions?traffic.today.humanSessions:traffic&&traffic.today&&"number"==typeof traffic.today.sessionsReachedApp?traffic.today.sessionsReachedApp:null,botsBlockedToday=traffic&&traffic.today&&"number"==typeof traffic.today.botsBlockedAtEdge?traffic.today.botsBlockedAtEdge:null,overview=(traffic&&traffic.today&&"number"==typeof traffic.today.botsBlockedAtEdgeUpdatedAt&&traffic.today.botsBlockedAtEdgeUpdatedAt,c&&c.overview&&"object"==typeof c.overview?c.overview:null);const overviewLabel=function(key){const k=key?String(key).trim().toLowerCase():"";return"yesterday"===k?"yesterday":"7d"===k?"last 7 days":"14d"===k?"last 14 days":"30d"===k?"last 30 days":"today"}(overview&&"string"==typeof overview.rangeKey?String(overview.rangeKey).trim().toLowerCase():"today"),overviewTruthOrders=overview&&"number"==typeof overview.truthOrders?overview.truthOrders:truthOrders,overviewTruthRevenue=overview&&"number"==typeof overview.truthRevenueGbp?overview.truthRevenueGbp:truthRevenue,overviewShopifySessions=overview&&"number"==typeof overview.shopifySessions?overview.shopifySessions:shopifySessionsToday,overviewKexoSessions=overview&&"number"==typeof overview.kexoSessionsHuman?overview.kexoSessionsHuman:kexoSessionsToday,overviewBotsBlocked=overview&&"number"==typeof overview.botsBlockedAtEdge?overview.botsBlockedAtEdge:botsBlockedToday,convertedOrdersForCr=null!=truthCheckoutOrders?truthCheckoutOrders:truthOrders,shopifyCr=null!=shopifyConversionRateToday?shopifyConversionRateToday:null!=convertedOrdersForCr&&null!=shopifySessionsToday&&shopifySessionsToday>0?convertedOrdersForCr/shopifySessionsToday*100:null,kexoCr=null!=convertedOrdersForCr&&null!=kexoSessionsToday&&kexoSessionsToday>0?convertedOrdersForCr/kexoSessionsToday*100:null,shopifyCrSource=null!=shopifyConversionRateToday?"traffic.shopifyConversionRateToday (ShopifyQL conversion_rate)":"computed: truth orders / Shopify sessions (fallback)",overviewShopifyCr=overview&&"number"==typeof overview.shopifyCr?overview.shopifyCr:shopifyCr,overviewKexoCr=overview&&"number"==typeof overview.kexoCr?overview.kexoCr:kexoCr,overviewShopifyCrSource=overview&&"string"==typeof overview.shopifyCrSource?String(overview.shopifyCrSource):shopifyCrSource,overviewShopifySessionsNote=overview&&"string"==typeof overview.shopifySessionsNote?String(overview.shopifySessionsNote):"",driftPixelCheckoutOrders=null!=truthCheckoutOrders&&null!=pixelDerivedOrders?pixelDerivedOrders-truthCheckoutOrders:null,driftPixelCheckoutRevenue=null!=truthCheckoutRevenue&&null!=pixelDerivedRevenue?Math.round(100*(pixelDerivedRevenue-truthCheckoutRevenue))/100:null,driftEvidenceCheckoutOrders=null!=truthCheckoutOrders&&null!=evTotal?evTotal-truthCheckoutOrders:null,sessionsDiff=null!=shopifySessionsToday&&null!=kexoSessionsToday?shopifySessionsToday-kexoSessionsToday:null,crDiff=null!=shopifyCr&&null!=kexoCr?shopifyCr-kexoCr:null,storedScopesStr=shopify&&shopify.storedScopes?String(shopify.storedScopes):"",serverScopesStr=shopify&&shopify.serverScopes?String(shopify.serverScopes):"",storedScopes=storedScopesStr?storedScopesStr.split(",").map(s=>s.trim()).filter(Boolean):[],serverScopes=serverScopesStr?serverScopesStr.split(",").map(s=>s.trim()).filter(Boolean):[],missingScopes=storedScopes.length&&serverScopes.length?serverScopes.filter(s=>-1===storedScopes.indexOf(s)):[],pixelIngestUrl=pixel&&null!=pixel.ingestUrl?String(pixel.ingestUrl):"",expectedIngestUrl=ingest&&null!=ingest.effectiveIngestUrl?String(ingest.effectiveIngestUrl):"",ingestUrlMatch=pixelIngestUrl&&expectedIngestUrl?pixelIngestUrl===expectedIngestUrl:null;
// --- New flattened, top-tab Diagnostics UI (inline-styled) ---
const shopifyOrderRate=shopifyCr,kexoOrderRate=kexoCr,orderRateDiff=null!=shopifyOrderRate&&null!=kexoOrderRate?shopifyOrderRate-kexoOrderRate:null;function codeInline(value){return'<code class="dm-code">'+escapeHtml(null==value?"":String(value))+"</code>"}const headerMetaBits=[];shopify&&shopify.shop&&headerMetaBits.push("Shop "+codeInline(shopify.shop)),c&&c.timeZone&&headerMetaBits.push("TZ "+codeInline(String(c.timeZone))),headerMetaBits.push("Updated "+codeInline(formatTs(c&&c.now?c.now:Date.now())));const aiCopyGeneratedAt=(new Date).toISOString();let aiCopyText="",aiPayloadData=null;try{const convertedSessionsSource=null!=evSessions?"sales.evidence.today.checkoutCompletedSessions":null!=truthCheckoutOrders?"sales.truth.today.checkoutOrderCount (fallback)":null!=truthOrders?"sales.truth.today.orderCount (fallback)":"unknown",aiPayload={kind:"kexo_diagnostics_v2",generatedAt:aiCopyGeneratedAt,diagnosticsSchemaVersion:c&&c.diagnostics&&null!=c.diagnostics.schemaVersion?c.diagnostics.schemaVersion:null,page:{href:"undefined"!=typeof window&&window.location?window.location.href:""},browser:{userAgent:"undefined"!=typeof navigator&&navigator.userAgent?navigator.userAgent:"",language:"undefined"!=typeof navigator&&navigator.language?navigator.language:""},aiNotes:["Truth = Shopify Orders API cache (orders_shopify). This is authoritative.","Evidence = Web Pixel checkout_completed events (purchase_events). Evidence < Truth usually means missing pixel events (consent/adblock/checkout surface) or non-storefront orders.","Kexo derived = purchases built from evidence; if derived matches evidence, drift is upstream of purchases.","Inspect rawConfigStatus.sales.missingEvidence.today.missingOrdersSample for a sample of truth orders missing evidence."],computed:{sessions:{shopifyToday:shopifySessionsToday,kexoHumanToday:kexoSessionsToday,diff:sessionsDiff},conversions:{definition:"Shopify CR% uses ShopifyQL conversion_rate; Kexo CR% uses truth orders / sessions * 100",shopifyCrSource:shopifyCrSource,convertedSessionsSource:convertedSessionsSource,shopifyCrPct:shopifyCr,kexoCrPct:kexoCr,crDiffPctPoints:crDiff,ordersPerSessionPct:{shopify:shopifyOrderRate,kexo:kexoOrderRate,diffPctPoints:orderRateDiff}},truth:{ordersPaidToday:truthOrders,revenueGbpToday:truthRevenue,checkoutTokenOrdersPaidToday:truthCheckoutOrders,checkoutTokenRevenueGbpToday:truthCheckoutRevenue},pixelDerived:{ordersToday:pixelDerivedOrders,revenueGbpToday:pixelDerivedRevenue},evidence:{checkoutCompletedEventsToday:evTotal,checkoutCompletedSessionsToday:evSessions,linkedEventsToday:evLinked,unlinkedEventsToday:evUnlinked},drift:{pixelVsTruthOrders:driftPixelOrders,pixelVsTruthRevenueGbp:driftPixelRevenue,evidenceVsCheckoutTokenOrders:driftEvidenceCheckoutOrders},salesEvidence:{evidenceCoveragePct:null!=truthCheckoutOrders&&truthCheckoutOrders>0&&null!=evTotal?evTotal/truthCheckoutOrders*100:null,missingEvidenceOrderCount:missingEvidenceCount,missingEvidenceSample:missingEvidenceSample&&missingEvidenceSample.length?missingEvidenceSample.slice(0,25):[]},pixel:{shopifyWebPixelOk:pixel&&"boolean"==typeof pixel.ok?pixel.ok:null,shopifyWebPixelInstalled:pixel&&"boolean"==typeof pixel.installed?pixel.installed:null,pixelIngestUrl:pixelIngestUrl,expectedIngestUrl:expectedIngestUrl,ingestUrlMatch:ingestUrlMatch},settings:{pixelSessionMode:pixelSessionMode,sharedSessionFixEnabled:sharedSessionFixEnabled,chartsUiSummary:c&&c.settings&&c.settings.chartsUiSummary?c.settings.chartsUiSummary:null,kpiUiSummary:c&&c.settings&&c.settings.kpiUiSummary?c.settings.kpiUiSummary:null}},rawConfigStatus:c};aiPayloadData=aiPayload,aiCopyText="Kexo diagnostics (paste this for AI)\nGenerated: "+aiCopyGeneratedAt+"\n"+(shopify&&shopify.shop?"Shop: "+shopify.shop+"\n":"")+"\n```json\n"+JSON.stringify(aiPayload,null,2)+"\n```\n"}catch(err){aiCopyText="Kexo diagnostics (AI)\nGenerated: "+aiCopyGeneratedAt+"\nError building payload: "+(err&&err.message?String(err.message):String(err))+"\n"}const copyIcon='<i class="fa-light fa-copy" data-icon-key="diag-copy" aria-hidden="true"></i>';
// Settings ??? Diagnostics (Tabler accordion, no tabs/custom dm-* classes)
function badgeLt(text,tone){var cls="bg-secondary-lt";return"ok"===tone?cls="bg-success-lt":"warn"===tone?cls="bg-warning-lt":"bad"===tone&&(cls="bg-danger-lt"),'<span class="badge '+cls+'">'+escapeHtml(String(text||""))+"</span>"}function cardSm(titleHtml,bodyHtml){return'<div class="card card-sm"><div class="card-header"><h4 class="card-title mb-0">'+titleHtml+'</h4></div><div class="card-body">'+(bodyHtml||"")+"</div></div>"}function kvTable(rows){if("function"!=typeof buildKexoSettingsTable)return'<div class="table-responsive"><table class="table table-sm table-vcenter mb-0"><tbody>'+(rows||[]).map(function(r){return'<tr><td class="text-secondary">'+escapeHtml(r[0]||"")+'</td><td class="text-end">'+(null!=r[1]?String(r[1]):"—")+"</td></tr>"}).join("")+"</tbody></table></div>";var def=window.KEXO_APP_MODAL_TABLE_DEFS&&window.KEXO_APP_MODAL_TABLE_DEFS["diagnostics-kv-table"]||{};return buildKexoSettingsTable({tableClass:"table table-sm table-vcenter mb-0",columns:(def.columns||[]).length?def.columns:[{header:"Metric",headerClass:"text-secondary"},{header:"Value",headerClass:"text-end"}],bodyHtml:(rows||[]).map(function(r){return'<tr><td class="text-secondary">'+escapeHtml(r[0]||"")+'</td><td class="text-end">'+(null!=r[1]?String(r[1]):"—")+"</td></tr>"}).join("")})}function accordionItem(key,title,bodyHtml){var safeKey=String(key||"").replace(/[^a-z0-9_-]+/gi,""),headingId="settings-diagnostics-heading-"+safeKey,collapseId="settings-diagnostics-collapse-"+safeKey;return'<div class="accordion-item"><h2 class="accordion-header" id="'+escapeHtml(headingId)+'"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#'+escapeHtml(collapseId)+'" aria-expanded="false" aria-controls="'+escapeHtml(collapseId)+'"><span class="kexo-settings-accordion-chevron"><i class="fa-regular fa-chevron-down" aria-hidden="true"></i></span><span class="fw-semibold">'+escapeHtml(title||"")+'</span></button></h2><div id="'+escapeHtml(collapseId)+'" class="accordion-collapse collapse" aria-labelledby="'+escapeHtml(headingId)+'" data-bs-parent="#settings-diagnostics-accordion"><div class="accordion-body">'+(bodyHtml||"")+"</div></div></div>"}var overviewBody="";overviewBody+='<div class="row g-3">',overviewBody+='<div class="col-12 col-xl-6">'+cardSm('<span class="d-flex align-items-center gap-2"><img src="'+escapeHtml(SHOPIFY_LOGO_URL)+'" width="20" height="20" alt="" aria-hidden="true" decoding="async" /><span>Shopify</span></span>',kvTable([["Sessions ("+overviewLabel+")",fmtSessions(overviewShopifySessions)],["CR% ("+overviewLabel+")",fmtPct(overviewShopifyCr)],["Orders (paid, "+overviewLabel+")",null!=overviewTruthOrders?escapeHtml(String(overviewTruthOrders)):"—"],["Revenue (paid, "+overviewLabel+")",fmtRevenue(overviewTruthRevenue)]]))+"</div>",overviewBody+='<div class="col-12 col-xl-6">'+cardSm('<span class="d-flex align-items-center gap-2"><img src="'+escapeHtml(KEXO_LOGO_URL)+'" width="20" height="20" alt="" aria-hidden="true" decoding="async" /><span>Kexo</span></span>',kvTable([["Sessions (human, "+overviewLabel+")",fmtSessions(overviewKexoSessions)],["CR% (truth, "+overviewLabel+")",fmtPct(overviewKexoCr)],["Bots blocked ("+overviewLabel+")",null!=overviewBotsBlocked?edgeBlocksButtonHtml(overviewBotsBlocked,"24h"):"—"],["Orders (paid, "+overviewLabel+")",null!=overviewTruthOrders?escapeHtml(String(overviewTruthOrders)):"—"],["Revenue (paid, "+overviewLabel+")",fmtRevenue(overviewTruthRevenue)]]))+"</div>",overviewBody+="</div>",overviewShopifyCrSource&&(overviewBody+='<div class="text-secondary small mt-3">Shopify CR source: '+escapeHtml(overviewShopifyCrSource)+"</div>"),overviewShopifySessionsNote?overviewBody+='<div class="text-secondary small mt-2">'+escapeHtml(overviewShopifySessionsNote)+"</div>":shopifyConversionRateNote&&(overviewBody+='<div class="text-secondary small mt-2">'+escapeHtml(shopifyConversionRateNote)+"</div>");var salesBody="",lastReconcile=truth&&truth.lastReconcile?truth.lastReconcile:null,reconcileBits=[];lastReconcile&&"number"==typeof lastReconcile.fetched&&reconcileBits.push("fetched "+String(lastReconcile.fetched)),lastReconcile&&"number"==typeof lastReconcile.inserted&&reconcileBits.push("inserted "+String(lastReconcile.inserted)),lastReconcile&&"number"==typeof lastReconcile.updated&&reconcileBits.push("updated "+String(lastReconcile.updated)),lastReconcile&&"number"==typeof lastReconcile.evidenceLinked&&reconcileBits.push("linked "+String(lastReconcile.evidenceLinked));var denomForCoverage=null!=truthCheckoutOrders?truthCheckoutOrders:truthOrders,missingOrders="number"==typeof missingEvidenceCount?missingEvidenceCount:null!=denomForCoverage&&null!=evTotal?Math.max(0,denomForCoverage-evTotal):null;if(salesBody+='<div class="row g-3">',salesBody+='<div class="col-12 col-xl-6">'+cardSm("Truth (paid)",kvTable([["Orders",null!=truthOrders?escapeHtml(String(truthOrders)):"—"],["Revenue",fmtRevenue(truthRevenue)],["Checkout-token orders",null!=truthCheckoutOrders?escapeHtml(String(truthCheckoutOrders)):"—"],["Checkout-token revenue",null!=truthCheckoutRevenue?fmtRevenue(truthCheckoutRevenue):"—"],["Returning customers",null!=truthReturningCustomers?escapeHtml(String(truthReturningCustomers)):"—"],["Returning revenue",null!=truthReturningRevenue?fmtRevenue(truthReturningRevenue):"—"]]))+"</div>",salesBody+='<div class="col-12 col-xl-6">'+cardSm("Evidence + Pixel",kvTable([["Evidence events (today)",null!=evTotal?escapeHtml(String(evTotal)):"—"],["Converted sessions (today)",null!=evSessions?escapeHtml(String(evSessions)):"—"],["Linked / unlinked",null!=evLinked&&null!=evUnlinked?escapeHtml(String(evLinked))+" / "+escapeHtml(String(evUnlinked)):"—"],["Pixel derived orders",null!=pixelDerivedOrders?escapeHtml(String(pixelDerivedOrders)):"—"],["Pixel derived revenue",null!=pixelDerivedRevenue?fmtRevenue(pixelDerivedRevenue):"—"]]))+"</div>",salesBody+='<div class="col-12">'+cardSm("Drift + reconcile",kvTable([["Pixel vs checkout-token (orders)",null==driftPixelCheckoutOrders?"—":escapeHtml(String(driftPixelCheckoutOrders>=0?"+":"")+String(driftPixelCheckoutOrders))],["Pixel vs checkout-token (revenue)",null==driftPixelCheckoutRevenue?"—":escapeHtml("£"+String(driftPixelCheckoutRevenue>=0?"+":"")+String(driftPixelCheckoutRevenue))],["Evidence vs checkout-token (orders)",null==driftEvidenceCheckoutOrders?"—":escapeHtml(String(driftEvidenceCheckoutOrders>=0?"+":"")+String(driftEvidenceCheckoutOrders))],["Missing evidence (count)",null==missingOrders?"—":badgeLt(String(missingOrders),0===missingOrders?"ok":missingOrders<=3?"warn":"bad")],["Last reconcile",lastReconcile&&"number"==typeof lastReconcile.ts?escapeHtml(formatTs(lastReconcile.ts))+(reconcileBits.length?" · "+escapeHtml(reconcileBits.join(", ")):""):"—"]]))+"</div>",salesBody+="</div>",missingEvidenceNote&&(salesBody+='<div class="text-secondary small mt-3">'+escapeHtml(missingEvidenceNote)+"</div>"),missingEvidenceSample&&missingEvidenceSample.length){var lines=missingEvidenceSample.slice(0,20).map(function(o){if(!o||"object"!=typeof o)return"";var bits=[],on=null!=o.order_name?String(o.order_name).trim():"",oid=null!=o.order_id?String(o.order_id).trim():"",ca=null!=o.created_at&&isFinite(Number(o.created_at))?Number(o.created_at):null,src=null!=o.source_name?String(o.source_name).trim():"";return on&&bits.push(on),oid&&bits.push("id "+oid),null!=ca&&bits.push(formatTs(ca)),src&&bits.push("source="+src),bits.length?bits.join(" · "):""}).filter(Boolean);lines.length&&(salesBody+='<details class="mt-3">',salesBody+='<summary class="text-secondary">Missing evidence orders (sample '+escapeHtml(String(missingEvidenceSample.length))+")</summary>",salesBody+='<div class="mt-2">',salesBody+=lines.map(function(t){return'<div class="text-secondary small">'+escapeHtml(t)+"</div>"}).join(""),salesBody+="</div>",salesBody+="</details>")}var acquisitionBody="";acquisitionBody+='<div class="row g-3">',acquisitionBody+='<div class="col-12 col-xl-6">'+cardSm("Sessions (today)",kvTable([["Reached app",traffic&&traffic.today&&"number"==typeof traffic.today.sessionsReachedApp?escapeHtml(formatSessions(traffic.today.sessionsReachedApp)):"—"],["Human sessions",traffic&&traffic.today&&"number"==typeof traffic.today.humanSessions?escapeHtml(formatSessions(traffic.today.humanSessions)):"—"],["Bot sessions tagged",traffic&&traffic.today&&"number"==typeof traffic.today.botSessionsTagged?escapeHtml(formatSessions(traffic.today.botSessionsTagged)):"—"],["Total sessions est.",traffic&&traffic.today&&"number"==typeof traffic.today.totalTrafficEst?escapeHtml(formatSessions(traffic.today.totalTrafficEst)):"—"]]))+"</div>",acquisitionBody+='<div class="col-12 col-xl-6">'+cardSm("Shopify vs ours",kvTable([["Shopify sessions (today)",null!=shopifySessionsToday?escapeHtml(formatSessions(shopifySessionsToday)):"—"],["Shopify CR% (today)",fmtPct(shopifyCr)],["Ours CR% (truth, today)",fmtPct(kexoCr)]]))+"</div>",acquisitionBody+="</div>";var pixelBody="";pixelBody+='<div class="row g-3">',pixelBody+='<div class="col-12 col-xl-6">'+cardSm("Pixel (Shopify)",kvTable([["Installed",pixel&&!0===pixel.installed?badgeLt("Installed","ok"):pixel&&!1===pixel.installed?badgeLt("Not installed","bad"):badgeLt("—","warn")],["Pixel ingestUrl",pixelIngestUrl?code(pixelIngestUrl):"—"],["Expected ingestUrl",expectedIngestUrl?code(expectedIngestUrl):"—"],["IngestUrl match",null==ingestUrlMatch?"—":ingestUrlMatch?badgeLt("Match","ok"):badgeLt("Mismatch","bad")]]))+"</div>",pixelBody+='<div class="col-12 col-xl-6">'+cardSm("Session mode",'<div class="form-check form-switch mb-2"><input class="form-check-input" type="checkbox" id="pixel-session-mode-toggle"'+(sharedSessionFixEnabled?" checked":"")+' /><label class="form-check-label" for="pixel-session-mode-toggle">Share session across tabs (30m inactivity)</label></div><div class="text-secondary small">Auto-saves. ON shares one session across tabs (30m inactivity) to reduce inflated session counts. OFF uses legacy per-tab sessions.</div><div id="pixel-session-mode-msg" class="form-hint mt-2"></div>')+"</div>",pixelBody+="</div>";var shopifyBody="";shopifyBody+='<div class="row g-3">',shopifyBody+='<div class="col-12 col-xl-6">'+cardSm("Auth + scopes",kvTable([["Shop",shopify&&shopify.shop?code(shopify.shop):badgeLt("Missing","bad")],["Token stored",shopify&&shopify.hasToken?badgeLt("Yes","ok"):badgeLt("No","bad")],["Stored scopes",storedScopesStr?code(storedScopesStr):"—"],["Required scopes",serverScopesStr?code(serverScopesStr):"—"],["Missing scopes",missingScopes.length?code(missingScopes.join(", ")):badgeLt("None","ok")]]))+"</div>",shopifyBody+='<div class="col-12 col-xl-6">'+cardSm("Truth sync health",kvTable([["Sync age",null!=staleSec?code(String(staleSec)+"s"):"—"],["Last sync",health&&health.lastSuccessAt?code(formatTs(health.lastSuccessAt)):"—"],["Last error",health&&health.lastError?code(String(health.lastError).slice(0,220)):"—"],["Last order","number"==typeof truthToday.lastOrderCreatedAt?code(formatTs(truthToday.lastOrderCreatedAt)):"—"]]))+"</div>",shopifyBody+="</div>";var googleAdsBody="";try{var ads=c&&c.ads?c.ads:{},adsStatus=ads&&ads.status?ads.status:null,g=(adsStatus&&Array.isArray(adsStatus.providers)?adsStatus.providers:[]).find(function(p){return p&&"google_ads"===String(p.key||"").toLowerCase()})||null,connected=g&&!0===g.connected,configured=g&&!0===g.configured,customerId=g&&g.customerId?String(g.customerId):"",loginCustomerId=g&&g.loginCustomerId?String(g.loginCustomerId):"",hasRefreshToken=g&&!0===g.hasRefreshToken,hasDeveloperToken=g&&!0===g.hasDeveloperToken,hasAdsDb=g&&!0===g.adsDb,apiVer=ads&&"string"==typeof ads.googleAdsApiVersion?ads.googleAdsApiVersion:"",oauthEnabled=ads&&!0===ads.googleAdsOAuthEnabled,connectUrl="/api/ads/google/connect?redirect="+encodeURIComponent("/settings/integrations/googleads");googleAdsBody+='<div class="row g-3">',googleAdsBody+='<div class="col-12 col-xl-6">'+cardSm("Connection",kvTable([["Configured",configured?badgeLt("Yes","ok"):badgeLt("No","bad")],["Connected (refresh_token)",connected?badgeLt("Yes","ok"):badgeLt("No","bad")],["ADS DB",hasAdsDb?badgeLt("OK","ok"):badgeLt("Missing","bad")],["Customer ID",customerId?code(customerId):"—"],["Login Customer ID",loginCustomerId?code(loginCustomerId):"—"],["Developer token",hasDeveloperToken?badgeLt("Set","ok"):badgeLt("Missing","bad")],["Refresh token",hasRefreshToken?badgeLt("Present","ok"):badgeLt("Missing","bad")],["API version hint",apiVer?code(apiVer):badgeLt("Auto","ok")]]))+"</div>",googleAdsBody+='<div class="col-12 col-xl-6">'+cardSm("Actions",'<div class="d-flex align-items-center gap-2 flex-wrap">'+(oauthEnabled?'<a class="btn btn-primary btn-sm" href="'+escapeHtml(connectUrl)+'">'+copyIcon+" Connect</a>":"")+'<button type="button" id="ga-status-btn" class="btn btn-secondary btn-sm">'+copyIcon+' Status</button><button type="button" id="ga-summary-btn" class="btn btn-secondary btn-sm">'+copyIcon+' Summary</button><button type="button" id="ga-refresh-7d-btn" class="btn btn-secondary btn-sm">'+copyIcon+' Refresh 7d</button><button type="button" id="ga-refresh-month-btn" class="btn btn-secondary btn-sm">'+copyIcon+' Refresh month</button><span id="ga-msg" class="form-hint ms-2"></span></div><div class="text-secondary small mt-2">Refresh returns spend sync diagnostics including per-version attempts when Google Ads REST errors occur.</div>')+"</div>",googleAdsBody+='<div class="col-12">'+cardSm("Output",'<pre id="ga-output" class="mb-0 small">'+escapeHtml(JSON.stringify({ads:adsStatus},null,2))+"</pre>")+"</div>",googleAdsBody+="</div>"}catch(err){googleAdsBody='<div class="alert alert-danger mb-0">Google Ads diagnostics failed to render.</div>'}var systemBody="",tablesLine="";if(db&&db.tables){var t=db.tables,bits=[];function add(name,ok){bits.push(name+(ok?" ✓":" ✗"))}add("settings",!!t.settings),add("shop_sessions",!!t.shop_sessions),add("visitors",!!t.visitors),add("sessions",!!t.sessions),add("events",!!t.events),add("purchases",!!t.purchases),add("orders_shopify",!!t.orders_shopify),add("orders_shopify_line_items",!!t.orders_shopify_line_items),add("customer_order_facts",!!t.customer_order_facts),add("purchase_events",!!t.purchase_events),add("reconcile_state",!!t.reconcile_state),add("reconcile_snapshots",!!t.reconcile_snapshots),add("shopify_sessions_snapshots",!!t.shopify_sessions_snapshots),add("audit_log",!!t.audit_log),add("bot_block_counts",!!t.bot_block_counts),tablesLine=bits.join(" · ")}systemBody+='<div class="row g-3">',systemBody+='<div class="col-12 col-xl-6">'+cardSm("Reporting",kvTable([["Orders source",reporting&&reporting.ordersSource?code(reporting.ordersSource):"—"],["Sessions source",reporting&&reporting.sessionsSource?code(reporting.sessionsSource):"—"]]))+"</div>",systemBody+='<div class="col-12 col-xl-6">'+cardSm("Runtime",kvTable([["App version",app&&app.version?code(app.version):"—"],["DB",db&&db.engine?code(db.engine+(db.configured?"":" (DB_URL not set)")):"—"],["Tables",tablesLine?code(tablesLine):"—"],["Sentry",app&&"boolean"==typeof app.sentryConfigured?app.sentryConfigured?badgeLt("ON","ok"):badgeLt("OFF","bad"):"—"]]))+"</div>",systemBody+="</div>";var defsBody="";try{defsBody=trackerDefinitions&&"object"==typeof trackerDefinitions?cardSm("Tracker definitions (raw)",'<pre class="mb-0 small">'+escapeHtml(JSON.stringify(trackerDefinitions,null,2))+"</pre>"):'<div class="text-secondary">No tracker definitions available from server.</div>'}catch(_){defsBody='<div class="text-secondary">No tracker definitions available from server.</div>'}var advancedBody="";advancedBody+='<div class="d-flex align-items-center gap-2 flex-wrap">',advancedBody+='<button type="button" id="be-copy-ai-btn" class="btn btn-secondary btn-sm" title="Copy a detailed diagnostics payload for AI">'+copyIcon+" Copy AI debug</button>",advancedBody+='<button type="button" id="be-download-ai-json-btn" class="btn btn-secondary btn-sm" title="Download diagnostics JSON for AI"><i class="fa-light fa-download" aria-hidden="true"></i> Download JSON</button>',advancedBody+='<span id="be-copy-ai-msg" class="form-hint ms-2"></span>',advancedBody+="</div>",advancedBody+='<div class="text-secondary small mt-2">Generated at '+escapeHtml(aiCopyGeneratedAt)+".</div>";var html="";html+='<div class="accordion settings-layout-accordion" id="settings-diagnostics-accordion">',html+=accordionItem("overview","Overview",overviewBody),html+=accordionItem("sales","Sales",salesBody),html+=accordionItem("acquisition","Acquisition",acquisitionBody),html+=accordionItem("pixel","Pixel",pixelBody),html+=accordionItem("shopify","Shopify",shopifyBody),html+=accordionItem("googleads","Google Ads",googleAdsBody),html+=accordionItem("system","System",systemBody),html+=accordionItem("definitions","Definitions",defsBody),html+=accordionItem("advanced","Advanced",advancedBody),html+="</div>";var v,targetEl=document.getElementById("diagnostics-content");diagnosticsStepEl&&(diagnosticsStepEl.textContent="Building diagnostics panel"),targetEl&&(targetEl.innerHTML=html);
// Preserve scroll position when refreshing while the modal is already open.
try{0}catch(_){}try{if(!(!compareModalEl||!compareModalEl.classList.contains("open"))&&compareStatusEl){const updatedAtMs=c&&"number"==typeof c.now&&isFinite(c.now)?c.now:Date.now();const compareKey=activeKpiCompareKey?String(activeKpiCompareKey).trim().toLowerCase():"conv";function compareMetric(label,valueHtml){return'<div class="kpi-compare-metric"><div class="kpi-compare-metric-label">'+escapeHtml(label)+'</div><div class="kpi-compare-metric-value">'+(valueHtml||"—")+"</div></div>"}function compareBrand(name,logoUrl,sub,rightHtml){const right=rightHtml?String(rightHtml):"";return'<div class="kpi-compare-brand"><div class="kpi-compare-brand-left"><img class="kpi-compare-brand-icon" src="'+escapeHtml(String(logoUrl||""))+'" width="28" height="28" alt="" aria-hidden="true" decoding="async" /><div class="kpi-compare-brand-text"><div class="kpi-compare-brand-name">'+escapeHtml(name||"")+'</div><div class="kpi-compare-brand-sub">'+escapeHtml(sub||"")+"</div></div></div>"+(right?'<div class="kpi-compare-brand-right">'+right+"</div>":"")+"</div>"}function inlineMetric(label,valueHtml){return'<span class="kpi-compare-inline-metric"><span class="kpi-compare-inline-label">'+escapeHtml(label||"")+'</span><span class="kpi-compare-inline-value">'+(valueHtml||"—")+"</span></span>"}function safeAov(revenue,orders){return"number"==typeof revenue&&isFinite(revenue)?"number"!=typeof orders||!isFinite(orders)||orders<=0?null:revenue/orders:null}compareKickerEl&&(compareKickerEl.textContent=function(key){const k=key?String(key).trim().toLowerCase():"";return"sessions"===k?"Sessions":"aov"===k?"AOV":"Conversion rate"}(compareKey));const botsTaggedToday=traffic&&traffic.today&&"number"==typeof traffic.today.botSessionsTagged?traffic.today.botSessionsTagged:null,truthAov=(traffic&&traffic.today&&"number"==typeof traffic.today.totalTrafficEst&&traffic.today.totalTrafficEst,traffic&&traffic.today&&"number"==typeof traffic.today.sessionsReachedApp&&traffic.today.sessionsReachedApp,safeAov(truthRevenue,truthOrders)),pixelAov=safeAov(pixelDerivedRevenue,pixelDerivedOrders);let diffText="";if("sessions"===compareKey){const d=null!=kexoSessionsToday&&null!=shopifySessionsToday?kexoSessionsToday-shopifySessionsToday:null;diffText=null!=d?"?? Sessions "+("number"==typeof(v=d)&&isFinite(v)?(v>0?"+":v<0?"-":"")+formatSessions(Math.abs(v)):""):""}else if("aov"===compareKey){const d=null!=pixelAov&&null!=truthAov?pixelAov-truthAov:null;diffText=null!=d?"?? AOV "+function(v){return"number"==typeof v&&isFinite(v)?(v>0?"+":v<0?"-":"")+formatRevenue(Math.abs(v)):""}(d):""}else{const d=null!=kexoCr&&null!=shopifyCr?kexoCr-shopifyCr:null;diffText=null!=d?"?? CR "+function(v){if("number"!=typeof v||!isFinite(v))return"";const sign=v>0?"+":v<0?"-":"",abs=Math.abs(v);return sign+(Math.round(100*abs)/100).toFixed(2).replace(/\.?0+$/,"")+"pp"}(d):""}compareUpdatedEl&&(compareUpdatedEl.textContent="Updated "+formatTs(updatedAtMs)+(diffText?" ?? "+diffText:""));const ordersHtml=null!=truthOrders?escapeHtml(String(truthOrders)):"—";null!=pixelDerivedOrders&&escapeHtml(String(pixelDerivedOrders)),"number"==typeof missingEvidenceCount&&isFinite(missingEvidenceCount)&&escapeHtml(String(missingEvidenceCount)),"number"==typeof evTotal&&isFinite(evTotal)&&escapeHtml(String(evTotal));let cmpHtml="";cmpHtml+='<div class="kpi-compare-grid">',"sessions"===compareKey?(cmpHtml+='<div class="kpi-compare-card kpi-compare-card--simple">',cmpHtml+=compareBrand("Shopify",SHOPIFY_LOGO_URL,"ShopifyQL sessions",inlineMetric("Sessions",fmtSessions(shopifySessionsToday))),cmpHtml+="</div>",cmpHtml+='<div class="kpi-compare-card kpi-compare-card--simple">',cmpHtml+=compareBrand("Kexo",KEXO_LOGO_URL,"Human sessions",inlineMetric("Sessions",fmtSessions(kexoSessionsToday))),cmpHtml+="</div>"):"aov"===compareKey?(cmpHtml+='<div class="kpi-compare-card kpi-compare-card--simple">',cmpHtml+=compareBrand("Shopify",SHOPIFY_LOGO_URL,"Paid truth orders",inlineMetric("AOV",fmtRevenue(truthAov))),cmpHtml+="</div>",cmpHtml+='<div class="kpi-compare-card kpi-compare-card--simple">',cmpHtml+=compareBrand("Kexo",KEXO_LOGO_URL,"Pixel purchases (deduped)",inlineMetric("AOV",fmtRevenue(pixelAov))),cmpHtml+="</div>"):(cmpHtml+='<div class="kpi-compare-card">',cmpHtml+=compareBrand("Shopify",SHOPIFY_LOGO_URL,"ShopifyQL sessions ?? conversion_rate"),cmpHtml+='<div class="kpi-compare-metrics">'+compareMetric("CR% (Shopify)",fmtPct(shopifyCr))+compareMetric("Sessions (today)",fmtSessions(shopifySessionsToday))+compareMetric("Orders (paid)",ordersHtml)+compareMetric("Revenue (paid)",fmtRevenue(truthRevenue))+"</div>",cmpHtml+="</div>",cmpHtml+='<div class="kpi-compare-card">',cmpHtml+=compareBrand("Kexo",KEXO_LOGO_URL,"Human sessions ?? bot signals"),cmpHtml+='<div class="kpi-compare-metrics">'+compareMetric("CR% (truth)",fmtPct(kexoCr))+compareMetric("Sessions (human, today)",fmtSessions(kexoSessionsToday))+compareMetric("Bots blocked (today)",null!=botsBlockedToday?edgeBlocksButtonHtml(botsBlockedToday,"24h"):"—")+compareMetric("Bot-tagged (today)",null!=botsTaggedToday?fmtSessions(botsTaggedToday):"—")+"</div>",cmpHtml+="</div>"),cmpHtml+="</div>",compareStepEl&&(compareStepEl.textContent="Building comparison view"),compareStatusEl.innerHTML=cmpHtml}}catch(_){}try{const btn=document.getElementById("be-copy-ai-btn"),downloadBtn=document.getElementById("be-download-ai-json-btn"),msg=document.getElementById("be-copy-ai-msg");function setMsg(t,ok){msg&&(msg.textContent=t||"",msg.classList.remove("text-success","text-danger"),msg.classList.add(ok?"text-success":"text-danger"))}function fallbackCopy(t){const ta=document.createElement("textarea");ta.value=t,ta.setAttribute("readonly","readonly"),ta.style.position="fixed",ta.style.top="-9999px",ta.style.left="-9999px",document.body.appendChild(ta),ta.select(),ta.setSelectionRange(0,ta.value.length);const ok=document.execCommand("copy");return document.body.removeChild(ta),ok}btn&&(btn.onclick=function(){const text=aiCopyText||"";try{if(!text)return void setMsg("Nothing to copy",!1);if(setMsg("Copying…",!0),navigator&&navigator.clipboard&&"function"==typeof navigator.clipboard.writeText)navigator.clipboard.writeText(text).then(function(){setMsg("Copied ("+text.length+" chars)",!0)}).catch(function(err){fallbackCopy(text)?setMsg("Copied ("+text.length+" chars)",!0):setMsg("Copy failed: "+(err&&err.message?String(err.message):"error"),!1)});else{fallbackCopy(text)?setMsg("Copied ("+text.length+" chars)",!0):setMsg("Copy failed",!1)}}catch(err){setMsg("Copy failed: "+(err&&err.message?String(err.message):"error"),!1)}}),downloadBtn&&(downloadBtn.onclick=function(){try{if(!aiPayloadData||"object"!=typeof aiPayloadData)return void setMsg("No JSON payload to download",!1);var filename="kexo-diagnostics-"+(shopify&&shopify.shop?String(shopify.shop).replace(/[^a-z0-9.-]+/gi,"_"):"shop")+"-"+aiCopyGeneratedAt.replace(/[:.]/g,"-")+".json",json=JSON.stringify(aiPayloadData,null,2),blob=new Blob([json],{type:"application/json;charset=utf-8"}),url=URL.createObjectURL(blob),a=document.createElement("a");a.href=url,a.download=filename,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(url),setMsg("Downloaded "+filename,!0)}catch(err){setMsg("Download failed: "+(err&&err.message?String(err.message):"error"),!1)}})}catch(_){}try{function setGaMsg(t,ok){const msgEl=document.getElementById("ga-msg");msgEl&&(msgEl.textContent=t||"",msgEl.classList.remove("text-success","text-danger"),msgEl.classList.add(ok?"text-success":"text-danger"))}function setGaOutput(obj){const outEl=document.getElementById("ga-output");if(outEl)try{outEl.textContent=JSON.stringify(obj,null,2)}catch(_){outEl.textContent=String(obj||"")}}function fetchJson(url,options){return fetch(url,options||{credentials:"same-origin",cache:"no-store"}).then(function(r){return r.text().then(function(t){let j=null;try{j=t?JSON.parse(t):null}catch(_){}return{ok:r.ok,status:r.status,json:j,text:t}})})}const statusBtn=document.getElementById("ga-status-btn"),summaryBtn=document.getElementById("ga-summary-btn"),refresh7dBtn=document.getElementById("ga-refresh-7d-btn"),refreshMonthBtn=document.getElementById("ga-refresh-month-btn");function doRefresh(rangeKey){setGaMsg("Refreshing "+rangeKey+"…",!0),fetchJson("/api/ads/refresh?range="+encodeURIComponent(rangeKey),{method:"POST",credentials:"same-origin",cache:"no-store",headers:{"Content-Type":"application/json"},body:JSON.stringify({source:"googleads"})}).then(function(r){setGaOutput({endpoint:"POST /api/ads/refresh?range="+rangeKey,status:r.status,ok:r.ok,body:r.json||r.text}),setGaMsg(r.ok?"Refresh "+rangeKey+" OK":"Refresh error "+r.status,r.ok)}).catch(function(err){setGaOutput({endpoint:"POST /api/ads/refresh?range="+rangeKey,error:err&&err.message?String(err.message):"request_failed"}),setGaMsg("Refresh request failed",!1)})}statusBtn&&(statusBtn.onclick=function(){setGaMsg("Fetching status…",!0),fetchJson("/api/ads/status",{credentials:"same-origin",cache:"no-store"}).then(function(r){setGaOutput({endpoint:"GET /api/ads/status",status:r.status,ok:r.ok,body:r.json||r.text}),setGaMsg(r.ok?"Status OK":"Status error "+r.status,r.ok)}).catch(function(err){setGaOutput({endpoint:"GET /api/ads/status",error:err&&err.message?String(err.message):"request_failed"}),setGaMsg("Status request failed",!1)})}),summaryBtn&&(summaryBtn.onclick=function(){setGaMsg("Fetching summary…",!0),fetchJson("/api/ads/summary?range=7d",{credentials:"same-origin",cache:"no-store"}).then(function(r){setGaOutput({endpoint:"GET /api/ads/summary?range=7d",status:r.status,ok:r.ok,body:r.json||r.text}),setGaMsg(r.ok?"Summary OK":"Summary error "+r.status,r.ok)}).catch(function(err){setGaOutput({endpoint:"GET /api/ads/summary?range=7d",error:err&&err.message?String(err.message):"request_failed"}),setGaMsg("Summary request failed",!1)})}),refresh7dBtn&&(refresh7dBtn.onclick=function(){doRefresh("7d")}),refreshMonthBtn&&(refreshMonthBtn.onclick=function(){doRefresh("month")})}catch(_){}try{const toggle=document.getElementById("pixel-session-mode-toggle"),msgEl=document.getElementById("pixel-session-mode-msg");toggle&&(toggle.onchange=function(){const nextMode=!!toggle.checked?"shared_ttl":"legacy";toggle.disabled=!0,msgEl&&(msgEl.textContent="Saving…"),fetch("/api/settings",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"same-origin",cache:"no-store",body:JSON.stringify({pixelSessionMode:nextMode})}).then(function(r){return r.ok?r.json():r.json().catch(function(){return null}).then(function(j){const msg=j&&j.error?String(j.error):"HTTP "+r.status;throw new Error(msg)})}).then(function(){const shop=getShopParam();return shop&&/\.myshopify\.com$/i.test(shop)?(msgEl&&(msgEl.textContent="Saved. Syncing pixel settings…"),fetch("/api/pixel/ensure?shop="+encodeURIComponent(shop),{credentials:"same-origin",cache:"no-store"}).then(function(r){return r.ok?r.json():null}).catch(function(){return null})):null}).then(function(){msgEl&&(msgEl.textContent="Saved. Applies on next page view.")}).catch(function(err){msgEl&&(msgEl.textContent="Save failed: "+(err&&err.message?String(err.message).slice(0,140):"error"))}).finally(function(){toggle.disabled=!1;
// Refresh diagnostics so the UI reflects the saved setting.
try{refreshConfigStatus({force:!0,preserveView:!0})}catch(_){}})})}catch(_){}return void 0!==evidenceToday&&"number"==typeof evidenceToday.lastOccurredAt&&setLastSaleAt(evidenceToday.lastOccurredAt),options&&options.force&&setDiagnosticsActionMsg("Diagnostics refreshed at "+formatTs(Date.now()),!0),c}).catch(()=>{const errEl=document.getElementById("diagnostics-content");errEl&&(errEl.innerHTML='<div class="alert alert-danger mb-0">Could not load diagnostics.</div>');try{!(!compareModalEl||!compareModalEl.classList.contains("open"))&&compareStatusEl&&(compareStatusEl.innerHTML='<div class="kpi-compare-error"><div class="kpi-compare-error-title">Error</div><div class="kpi-compare-error-body">Could not load comparison.</div></div>',compareUpdatedEl&&(compareUpdatedEl.textContent="Update failed"))}catch(_){}options&&options.force&&setDiagnosticsActionMsg("Diagnostics refresh failed.",!1)}).finally(function(){refreshBtn&&refreshBtn.classList.remove("spinning"),compareRefreshBtn&&compareRefreshBtn.classList.remove("spinning"),configStatusRefreshInFlight===p&&(configStatusRefreshInFlight=null)});return configStatusRefreshInFlight=p,p}try{window.refreshConfigStatus=refreshConfigStatus}catch(_){}try{window.initTrafficSourceMapping=function(opts){initTrafficSourceMappingPanel(opts||{})}}catch(_){}function liveSalesAutoPollEnabled(){return"live"===PAGE||"sales"===PAGE}function liveSalesCanAutoApply(){if(!liveSalesAutoPollEnabled())return!1;if("visible"!==document.visibilityState)return!1;
// Pause while interacting (sorting/paging). New data will be queued and applied on demand.
try{if("number"==typeof currentPage&&1!==currentPage)return!1}catch(_){}try{const sb=null!=sortBy?String(sortBy):"",sd=null!=sortDir?String(sortDir):"";if(sb&&!("last_seen"===sb&&"desc"===sd))return!1}catch(_){}return!0}function scheduleLiveSalesPoll(ms){if(liveSalesAutoPollEnabled()){if(liveSalesPollTimer){try{clearTimeout(liveSalesPollTimer)}catch(_){}liveSalesPollTimer=null}var ts,n,delay="number"==typeof ms&&isFinite(ms)&&ms>=0?ms:1e4;ts=Date.now()+delay,n="number"==typeof ts&&isFinite(ts)?ts:Date.now()+1e4,"live"===PAGE?nextLiveAt=n:nextRangeAt=n,updateNextUpdateUi(),liveSalesPollTimer=setTimeout(function(){try{!function(){if(!liveSalesAutoPollEnabled())return;
// Always reschedule first so we don't stop polling if something throws.
if(scheduleLiveSalesPoll(1e4),"visible"!==document.visibilityState)return;if(liveSalesPollInFlight)return;var url=function(){if("live"===PAGE)return"/api/sessions?filter=active&_="+Date.now();
// Sales page: always poll the "top page" so new rows are detected even if user is paging.
var limit=rowsPerPage;return"/api/sessions?range="+encodeURIComponent(normalizeRangeKeyForApi("sales"))+"&limit="+limit+"&offset=0&timezone="+encodeURIComponent(tz)+"&_="+Date.now()}();liveSalesPollInFlight=fetch(url,{credentials:"same-origin",cache:"no-store"}).then(function(r){return r&&r.ok?r.json():null}).then(function(data){if(data)if(!liveSalesPendingPayload&&liveSalesCanAutoApply())liveSalesPendingPayload=null,liveSalesPendingAt=0,applyLiveSalesPayload(data);else{liveSalesPendingPayload=data,liveSalesPendingAt=Date.now();try{updateNextUpdateUi()}catch(_){}}}).catch(function(){}).finally(function(){liveSalesPollInFlight=null})}()}catch(_){}},delay)}}function applyLiveSalesPayload(data){if(data)if("live"!==PAGE){
// Sales (range mode)
sessions=data.sessions||[],sessionsTotal="number"==typeof data.total?data.total:sessions.length,lastSessionsMode="range",lastSessionsFetchedAt=Date.now(),lastUpdateTime=new Date,updateServerTimeDisplay(),renderTable(),updateKpis();try{refreshSessionPageCharts({force:!1})}catch(_){}}else{sessionsTotal=null;var next=data.sessions||[],cutoff=Date.now()-3e5,arrivedCutoff=Date.now()-36e5;(next=next.filter(function(s){return null!=s.last_seen&&s.last_seen>=cutoff&&null!=s.started_at&&s.started_at>=arrivedCutoff})).sort(function(a,b){return(b.last_seen||0)-(a.last_seen||0)}),sessions=next,lastSessionsMode="live",lastSessionsFetchedAt=Date.now(),lastUpdateTime=new Date,updateServerTimeDisplay(),renderTable(),updateKpis();try{refreshSessionPageCharts({force:!1})}catch(_){}}}function applyLiveSalesPending(){if(!liveSalesPendingPayload)return!1;const payload=liveSalesPendingPayload;liveSalesPendingPayload=null,liveSalesPendingAt=0;
// Newest rows are at the top; jump to page 1 so the update is visible.
try{currentPage=1}catch(_){}try{applyLiveSalesPayload(payload)}catch(_){}try{updateNextUpdateUi()}catch(_){}return!0}updateLastSaleAgo(),function(options={}){fetchLatestSaleForToast({forceNew:!(!options||!options.forceNew)}).then(function(sale){return sale&&null!=sale.createdAt?(setLastSaleAt(sale.createdAt),sale):null}).catch(function(){return null})}({forceNew:!1}),_intervals.push(setInterval(function(){if("visible"===document.visibilityState)try{updateLastSaleAgo()}catch(_){}},1e4)),function(){const openBtn=document.getElementById("config-open-btn"),refreshBtn=document.getElementById("config-refresh-btn"),reconcileBtn=document.getElementById("config-reconcile-btn"),rangeSel=document.getElementById("diagnostics-overview-range");if(rangeSel&&rangeSel.addEventListener("change",function(){setDiagnosticsActionMsg("Loading overview…",!0);try{refreshConfigStatus({force:!0,preserveView:!0})}catch(_){}}),refreshBtn&&refreshBtn.addEventListener("click",function(){setDiagnosticsActionMsg("Refreshing diagnostics…",!0);try{refreshConfigStatus({force:!0,preserveView:!0})}catch(_){}}),reconcileBtn&&reconcileBtn.addEventListener("click",function(){try{reconcileSalesTruth({})}catch(_){}}),openBtn&&"A"===openBtn.tagName)try{openBtn.setAttribute("href","/settings")}catch(_){}}(),function(){const modal=document.getElementById("kpi-compare-modal"),refreshBtn=document.getElementById("kpi-compare-refresh-btn"),closeBtn=document.getElementById("kpi-compare-close-btn"),kickerEl=document.getElementById("kpi-compare-kicker");function open(key){activeKpiCompareKey=key?String(key).trim().toLowerCase():"conv",kickerEl&&(kickerEl.textContent=function(key){const k=key?String(key).trim().toLowerCase():"";return"sessions"===k?"Sessions":"aov"===k?"AOV":"Conversion rate"}(activeKpiCompareKey)),modal.classList.add("open"),modal.setAttribute("aria-hidden","false");try{refreshConfigStatus({force:!0,preserveView:!0})}catch(_){}}function close(){modal.classList.remove("open"),modal.setAttribute("aria-hidden","true")}modal&&(document.addEventListener("click",function(e){const target=e&&e.target?e.target:null,btn=target&&target.closest?target.closest(".kpi-compare-open-btn[data-kpi-compare]"):null;if(!btn)return;e.preventDefault(),e.stopPropagation();open((btn.getAttribute("data-kpi-compare")||"").trim().toLowerCase()||"conv")}),refreshBtn&&refreshBtn.addEventListener("click",function(){try{refreshConfigStatus({force:!0,preserveView:!0})}catch(_){}}),closeBtn&&closeBtn.addEventListener("click",close),modal.addEventListener("click",function(e){e.target===modal&&close()}),document.addEventListener("keydown",function(e){"Escape"===e.key&&modal.classList.contains("open")&&close()}))}(),function(){const BTN_SEL=".kexo-edge-blocks-open-btn",RANGE_ID="edge-blocks-range-select";let modalEl=null,modalApi=null,abort=null,activeRange="24h",activeReason="",activeCountry="",activeAsn="",activeQ="";function isAdmin(){try{if("function"==typeof window.__kexoGetEffectiveViewer){const v=window.__kexoGetEffectiveViewer();return!(!v||!v.isAdmin)}}catch(_){}try{return!!window.__kexoEffectiveIsAdmin||!!window.__kexoIsMasterUser}catch(_){return!1}}function enableButtons(){try{const ok=isAdmin();((document.querySelectorAll?document.querySelectorAll(BTN_SEL):[])||[]).forEach(function(btn){if(btn){try{btn.disabled=!ok}catch(_){}try{btn.setAttribute("aria-disabled",ok?"false":"true")}catch(_){}try{btn.title=ok?"Open edge blocks":"Admin only"}catch(_){}}})}catch(_){}}function safeJson(url,signal){return fetch(url,{credentials:"same-origin",cache:"no-store",signal:signal}).then(function(r){return r.json()})}function esc(v){try{return escapeHtml(String(null==v?"":v))}catch(_){return""}}function formatWhen(ts){const n=null!=ts?Number(ts):NaN;if(!Number.isFinite(n))return"—";try{return formatTs(n)}catch(_){}try{return new Date(n).toLocaleString("en-GB")}catch(_){return String(n)}}function normaliseRange(v){return"7d"===(v?String(v).trim().toLowerCase():"")?"7d":"24h"}function cleanupInflight(){try{abort&&abort.abort()}catch(_){}abort=null}function setText(id,text){const el=document.getElementById(id);el&&(el.textContent=text)}function renderCounts(tbodyId,rows,keyName){const body=document.getElementById(tbodyId);if(!body)return;const list=Array.isArray(rows)?rows:[];list.length?body.innerHTML=list.slice(0,50).map(function(r){const k=r&&null!=r[keyName]?String(r[keyName]):"",n=r&&null!=r.count?Number(r.count):0;return"<tr><td>"+esc(k)+'</td><td class="text-end">'+esc(Number.isFinite(n)?n:0)+"</td></tr>"}).join(""):body.innerHTML='<tr><td class="text-secondary" colspan="2">—</td></tr>'}function renderEvents(rows){const body=document.getElementById("edge-blocks-events-body");if(!body)return;const list=Array.isArray(rows)?rows:[];list.length?body.innerHTML=list.slice(0,200).map(function(r){const ua=r&&null!=r.ua?String(r.ua):"",origin=r&&null!=r.origin?String(r.origin):"";return'<tr><td class="text-secondary">'+esc(formatWhen(r.created_at))+"</td><td>"+esc(r.blocked_reason||"")+'</td><td class="text-secondary">'+esc(r.edge_result||"")+"</td><td>"+esc(r.country||"")+'</td><td class="text-secondary">'+esc(r.asn||"")+'</td><td class="text-secondary" title="'+esc(ua)+'">'+esc(ua.length>38?ua.slice(0,38)+"…":ua)+'</td><td class="text-secondary" title="'+esc(origin)+'">'+esc(origin.length>28?origin.slice(0,28)+"…":origin)+'</td><td class="text-secondary">'+esc(r.ray_id||"")+"</td></tr>"}).join(""):body.innerHTML='<tr><td class="text-secondary" colspan="8">—</td></tr>'}function refresh(){if(!modalEl)return;cleanupInflight(),abort=new AbortController;const signal=abort.signal,rk=normaliseRange(activeRange),since=function(rangeKey){const now=Date.now();return"7d"===rangeKey?now-6048e5:now-864e5}(rk),summaryUrl="/api/edge-blocked/summary?range="+encodeURIComponent(rk);let eventsUrl="/api/edge-blocked/events?limit=200&since="+encodeURIComponent(String(since));activeReason&&(eventsUrl+="&blocked_reason="+encodeURIComponent(activeReason)),activeCountry&&(eventsUrl+="&country="+encodeURIComponent(activeCountry)),activeAsn&&(eventsUrl+="&asn="+encodeURIComponent(activeAsn)),activeQ&&(eventsUrl+="&q="+encodeURIComponent(activeQ)),setText("edge-blocks-updated","Loading…"),setText("edge-blocks-total","—"),setText("edge-blocks-bots","—"),setText("edge-blocks-junk","—"),renderCounts("edge-blocks-by-reason",[],"blocked_reason"),renderCounts("edge-blocks-by-country",[],"country"),renderCounts("edge-blocks-by-asn",[],"asn"),renderCounts("edge-blocks-by-botcat",[],"verified_bot_category"),renderEvents([]),setText("edge-blocks-events-meta","—"),Promise.all([safeJson(summaryUrl,signal),safeJson(eventsUrl,signal)]).then(function(parts){const summary=parts&&parts[0]?parts[0]:null,events=parts&&parts[1]?parts[1]:null;if(!summary||!0!==summary.ok)throw new Error("Failed to load summary");if(!events||!0!==events.ok)throw new Error("Failed to load events");const t=summary.totals||{};setText("edge-blocks-total",null!=t.blocked?String(t.blocked):"—"),setText("edge-blocks-bots",null!=t.bots?String(t.bots):"—"),setText("edge-blocks-junk",null!=t.junk?String(t.junk):"—"),setText("edge-blocks-updated","Updated "+formatWhen(Date.now())+" · Range "+rk),renderCounts("edge-blocks-by-reason",summary.by_reason,"blocked_reason"),renderCounts("edge-blocks-by-country",summary.by_country,"country"),renderCounts("edge-blocks-by-asn",summary.by_asn,"asn"),renderCounts("edge-blocks-by-botcat",summary.by_verified_bot_category,"verified_bot_category"),renderEvents(events.events||[]),setText("edge-blocks-events-meta","Showing "+String((events.events||[]).length)+" events since "+formatWhen(events.since))}).catch(function(err){signal&&signal.aborted||setText("edge-blocks-updated","Failed to load edge blocks: "+(err&&err.message?String(err.message):"error"))})}function open(rangeKey){if(function(){if(modalEl)return;modalEl=document.getElementById("edge-blocks-modal"),modalEl||(modalEl=document.createElement("div"),modalEl.id="edge-blocks-modal",modalEl.className="modal modal-blur fade",modalEl.tabIndex=-1,modalEl.setAttribute("aria-hidden","true"),modalEl.innerHTML='<div class="modal-dialog modal-xl modal-dialog-centered" role="dialog"><div class="modal-content"><div class="modal-header"><div class="d-flex align-items-center gap-3"><h5 class="modal-title mb-0">Edge blocks</h5><select class="form-select form-select-sm" id="'+esc(RANGE_ID)+'" aria-label="Range"><option value="24h">24h</option><option value="7d">7d</option></select></div><div class="d-flex align-items-center gap-2"><button type="button" class="btn btn-icon btn-ghost-secondary" id="'+esc("edge-blocks-refresh-btn")+'" aria-label="Refresh edge blocks" title="Refresh"><i class="fa-light fa-rotate-right" aria-hidden="true"></i><span>Refresh</span></button><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div></div><div class="modal-body"><div class="text-secondary small mb-2" id="edge-blocks-updated">—</div><div class="row g-3 mb-3" id="edge-blocks-cards"><div class="col-12 col-md-4"><div class="card card-sm"><div class="card-body"><div class="text-secondary">Total blocked</div><div class="h1 mb-0" id="edge-blocks-total">—</div></div></div></div><div class="col-12 col-md-4"><div class="card card-sm"><div class="card-body"><div class="text-secondary">Bots dropped</div><div class="h1 mb-0" id="edge-blocks-bots">—</div></div></div></div><div class="col-12 col-md-4"><div class="card card-sm"><div class="card-body"><div class="text-secondary">Junk dropped</div><div class="h1 mb-0" id="edge-blocks-junk">—</div></div></div></div></div><ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#edge-blocks-summary-tab" type="button" role="tab">Summary</button></li><li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#edge-blocks-events-tab" type="button" role="tab">Recent events</button></li></ul><div class="tab-content pt-3"><div class="tab-pane fade show active" id="edge-blocks-summary-tab" role="tabpanel"><div class="row g-3"><div class="col-12 col-lg-6"><div class="card"><div class="card-header"><h3 class="card-title">By reason</h3></div><div class="table-responsive"><table class="table table-sm table-vcenter card-table"><thead><tr><th>Reason</th><th class="text-end">Count</th></tr></thead><tbody id="edge-blocks-by-reason"></tbody></table></div></div></div><div class="col-12 col-lg-6"><div class="card"><div class="card-header"><h3 class="card-title">By country</h3></div><div class="table-responsive"><table class="table table-sm table-vcenter card-table"><thead><tr><th>Country</th><th class="text-end">Count</th></tr></thead><tbody id="edge-blocks-by-country"></tbody></table></div></div></div><div class="col-12 col-lg-6"><div class="card"><div class="card-header"><h3 class="card-title">By ASN</h3></div><div class="table-responsive"><table class="table table-sm table-vcenter card-table"><thead><tr><th>ASN</th><th class="text-end">Count</th></tr></thead><tbody id="edge-blocks-by-asn"></tbody></table></div></div></div><div class="col-12 col-lg-6"><div class="card"><div class="card-header"><h3 class="card-title">By verified bot category</h3></div><div class="table-responsive"><table class="table table-sm table-vcenter card-table"><thead><tr><th>Category</th><th class="text-end">Count</th></tr></thead><tbody id="edge-blocks-by-botcat"></tbody></table></div></div></div></div></div><div class="tab-pane fade" id="edge-blocks-events-tab" role="tabpanel"><div class="row g-2 align-items-end mb-2"><div class="col-12 col-md-3"><label class="form-label">Reason</label><input class="form-control" id="edge-blocks-filter-reason" placeholder="e.g. bot" /></div><div class="col-12 col-md-2"><label class="form-label">Country</label><input class="form-control" id="edge-blocks-filter-country" placeholder="GB" /></div><div class="col-12 col-md-2"><label class="form-label">ASN</label><input class="form-control" id="edge-blocks-filter-asn" placeholder="e.g. 12345" /></div><div class="col-12 col-md-5"><label class="form-label">Search</label><input class="form-control" id="edge-blocks-filter-q" placeholder="UA, origin, referer, path…" /></div></div><div class="table-responsive"><table class="table table-sm table-vcenter"><thead><tr><th>Time</th><th>Reason</th><th>Result</th><th>Country</th><th>ASN</th><th>UA</th><th>Origin</th><th>Ray</th></tr></thead><tbody id="edge-blocks-events-body"></tbody></table></div><div class="text-secondary small mt-2" id="edge-blocks-events-meta">—</div></div></div></div><div class="modal-footer"><button type="button" class="btn btn-primary" data-bs-dismiss="modal">Close</button></div></div></div>',document.body.appendChild(modalEl));try{window.bootstrap&&window.bootstrap.Modal&&(modalApi=window.bootstrap.Modal.getOrCreateInstance(modalEl,{backdrop:!0,keyboard:!0,focus:!0}),modalEl.addEventListener("hidden.bs.modal",function(){cleanupInflight()}))}catch(_){}const rangeSel=document.getElementById(RANGE_ID);rangeSel&&rangeSel.addEventListener("change",function(){activeRange=normaliseRange(rangeSel.value),refresh()});const refreshBtn=document.getElementById("edge-blocks-refresh-btn");function bindInput(id,apply){const el=document.getElementById(id);el&&el.addEventListener("input",function(){apply(el.value)})}refreshBtn&&refreshBtn.addEventListener("click",function(){refresh()}),bindInput("edge-blocks-filter-reason",function(v){activeReason=(v||"").trim()}),bindInput("edge-blocks-filter-country",function(v){activeCountry=(v||"").trim()}),bindInput("edge-blocks-filter-asn",function(v){activeAsn=(v||"").trim()}),bindInput("edge-blocks-filter-q",function(v){activeQ=(v||"").trim()}),["edge-blocks-filter-reason","edge-blocks-filter-country","edge-blocks-filter-asn","edge-blocks-filter-q"].forEach(function(id){const el=document.getElementById(id);el&&el.addEventListener("keydown",function(e){e&&"Enter"===e.key&&refresh()})})}(),enableButtons(),!isAdmin())return;activeRange=normaliseRange(rangeKey);const rangeSel=document.getElementById(RANGE_ID);rangeSel&&(rangeSel.value=activeRange);try{modalApi&&"function"==typeof modalApi.show&&modalApi.show()}catch(_){}refresh()}document.addEventListener("click",function(e){const target=e&&e.target?e.target:null,btn=target&&target.closest?target.closest(BTN_SEL):null;if(!btn)return;if(e.preventDefault(),e.stopPropagation(),btn.disabled)return;open(btn.getAttribute("data-edge-blocks-range")||"24h")});try{window.addEventListener("kexo:viewer-changed",function(){enableButtons()})}catch(_){}enableButtons()}(),function(){const body=document.getElementById("traffic-types-body");body&&body.addEventListener("click",function(e){const target=e&&e.target?e.target:null,btn=target&&target.closest?target.closest(".traffic-type-toggle"):null;if(!btn)return;e.preventDefault(),e.stopPropagation();const device=(btn.getAttribute("data-device")||"").trim().toLowerCase();if(!device)return;trafficTypeExpanded&&"object"==typeof trafficTypeExpanded||(
// First click: snapshot current groups as all-open, then toggle the clicked one
trafficTypeExpanded={},document.querySelectorAll(".traffic-type-parent[data-device]").forEach(function(row){var d=(row.getAttribute("data-device")||"").trim().toLowerCase();d&&(trafficTypeExpanded[d]=!0)}));const nextOpen=!trafficTypeExpanded[device];trafficTypeExpanded[device]=nextOpen,btn.setAttribute("aria-expanded",nextOpen?"true":"false"),body.querySelectorAll('.grid-row.traffic-type-child[data-parent="'+device+'"]').forEach(function(tr){tr.classList.toggle("is-hidden",!nextOpen)})})}(),function(){const body=document.getElementById("devices-body");body&&body.addEventListener("click",function(e){const target=e&&e.target?e.target:null,btn=target&&target.closest?target.closest(".devices-toggle[data-device-type]"):null;if(!btn)return;e.preventDefault(),e.stopPropagation();const deviceType=(btn.getAttribute("data-device-type")||"").trim().toLowerCase();if(!deviceType)return;devicesExpanded&&"object"==typeof devicesExpanded||(devicesExpanded={},body.querySelectorAll(".devices-parent[data-device-type]").forEach(function(row){var d=(row.getAttribute("data-device-type")||"").trim().toLowerCase();d&&(devicesExpanded[d]=!0)}));const nextOpen=!devicesExpanded[deviceType];devicesExpanded[deviceType]=nextOpen,btn.setAttribute("aria-expanded",nextOpen?"true":"false"),body.querySelectorAll('.grid-row.devices-child[data-parent="'+deviceType+'"]').forEach(function(tr){tr.classList.toggle("is-hidden",!nextOpen)})})}(),function(){const body=document.getElementById("attribution-body");body&&body.addEventListener("click",function(e){const target=e&&e.target?e.target:null,channelBtn=target&&target.closest?target.closest(".attribution-channel-toggle[data-channel]"):null;if(channelBtn){e.preventDefault(),e.stopPropagation();const chKey=(channelBtn.getAttribute("data-channel")||"").trim().toLowerCase();if(!chKey)return;attributionExpandedChannels&&"object"==typeof attributionExpandedChannels||(attributionExpandedChannels={},body.querySelectorAll(".attribution-channel-parent[data-channel]").forEach(function(row){var k=(row.getAttribute("data-channel")||"").trim().toLowerCase();k&&(attributionExpandedChannels[k]=!0)}));const nextOpen=!attributionExpandedChannels[chKey];return attributionExpandedChannels[chKey]=nextOpen,channelBtn.setAttribute("aria-expanded",nextOpen?"true":"false"),body.querySelectorAll('.grid-row.attribution-source-row[data-parent="'+chKey+'"]').forEach(function(tr){tr.classList.toggle("is-hidden",!nextOpen)}),void body.querySelectorAll('.grid-row.attribution-variant-row[data-channel="'+chKey+'"]').forEach(function(tr){if(!nextOpen)return void tr.classList.add("is-hidden");const src=(tr.getAttribute("data-source")||"").trim().toLowerCase(),k=chKey+"|"+(src||"other");let srcOpen=!0;attributionExpandedSources&&"object"==typeof attributionExpandedSources&&Object.prototype.hasOwnProperty.call(attributionExpandedSources,k)&&(srcOpen=!!attributionExpandedSources[k]),tr.classList.toggle("is-hidden",!srcOpen)})}const sourceBtn=target&&target.closest?target.closest(".attribution-source-toggle[data-channel][data-source]"):null;if(!sourceBtn)return;e.preventDefault(),e.stopPropagation();const ch=(sourceBtn.getAttribute("data-channel")||"").trim().toLowerCase(),src=(sourceBtn.getAttribute("data-source")||"").trim().toLowerCase();if(!ch||!src)return;attributionExpandedSources&&"object"==typeof attributionExpandedSources||(attributionExpandedSources={},body.querySelectorAll(".attribution-source-row[data-channel][data-source]").forEach(function(row){var c=(row.getAttribute("data-channel")||"").trim().toLowerCase(),s=(row.getAttribute("data-source")||"").trim().toLowerCase();c&&s&&(attributionExpandedSources[c+"|"+s]=!0)}));const key=ch+"|"+src,nextOpen=!attributionExpandedSources[key];attributionExpandedSources[key]=nextOpen,sourceBtn.setAttribute("aria-expanded",nextOpen?"true":"false");const channelOpen=!(attributionExpandedChannels&&"object"==typeof attributionExpandedChannels&&Object.prototype.hasOwnProperty.call(attributionExpandedChannels,ch)&&!attributionExpandedChannels[ch]);body.querySelectorAll('.grid-row.attribution-variant-row[data-parent="'+key+'"]').forEach(function(tr){tr.classList.toggle("is-hidden",!(channelOpen&&nextOpen))})})}(),function(){try{saleMuted="true"===sessionStorage.getItem("livevisitors-sale-muted")}catch(_){saleMuted=!1}try{saleAudio=new Audio}catch(_){saleAudio=null}if(saleAudio){try{saleAudio.preload="auto"}catch(_){}try{window.__kexoApplySaleSoundOverride=function(url){try{window.__kexoSaleSoundOverrideUrl=url&&String(url).trim()||""}catch(_){}setSaleAudioSrc(getCashRegisterMp3Url())},window.__kexoPreviewSaleSound=function(url){if(!saleAudio)return Promise.reject(new Error("Sale audio unavailable"));var nextUrl=null!=url?String(url).trim():"";nextUrl||(nextUrl=getCashRegisterMp3Url());var prevSrc="";try{prevSrc=String(saleAudio.currentSrc||saleAudio.src||"").trim()}catch(_){prevSrc=""}if(nextUrl)try{setSaleAudioSrc(nextUrl)}catch(_){}try{primeSaleAudio()}catch(_){}try{saleAudio.muted=!1}catch(_){}try{saleAudio.currentTime=0}catch(_){}var played=null;try{played=saleAudio.play()}catch(err){if(prevSrc&&nextUrl&&prevSrc!==nextUrl)try{setSaleAudioSrc(prevSrc)}catch(_){}return Promise.reject(err)}function restoreSrc(){if(prevSrc&&nextUrl&&prevSrc!==nextUrl)try{setSaleAudioSrc(prevSrc)}catch(_){}}return played&&"function"==typeof played.finally?played.finally(restoreSrc):(restoreSrc(),Promise.resolve())}}catch(_){}try{setSaleAudioSrc(getCashRegisterMp3Url())}catch(_){}
// Prime/unlock audio on the first user interaction so sale sounds can play later.
!function(){function prime(){try{primeSaleAudio()}catch(_){}}document.addEventListener("pointerdown",prime,{once:!0,capture:!0}),document.addEventListener("touchstart",prime,{once:!0,capture:!0}),document.addEventListener("keydown",prime,{once:!0,capture:!0}),document.addEventListener("click",prime,{once:!0,capture:!0})}()}function syncFooterAudioMute(muted){document.querySelectorAll(".footer-audio-btn, .footer-settings-audio").forEach(function(btn){btn.classList.toggle("muted",muted);var iconOn=btn.querySelector(".sound-icon-on"),iconOff=btn.querySelector(".sound-icon-off");iconOn&&iconOn.classList.toggle("is-hidden",muted),iconOff&&iconOff.classList.toggle("is-hidden",!muted)})}const muteBtn=document.getElementById("audio-mute-btn"),iconOn=muteBtn&&muteBtn.querySelector(".sound-icon-on"),iconOff=muteBtn&&muteBtn.querySelector(".sound-icon-off");muteBtn&&(iconOn&&iconOn.classList.toggle("is-hidden",saleMuted),iconOff&&iconOff.classList.toggle("is-hidden",!saleMuted),muteBtn.classList.toggle("muted",saleMuted),syncFooterAudioMute(saleMuted),muteBtn.addEventListener("click",function(){saleMuted=!saleMuted;try{sessionStorage.setItem("livevisitors-sale-muted",String(saleMuted))}catch(_){}if(iconOn&&iconOn.classList.toggle("is-hidden",saleMuted),iconOff&&iconOff.classList.toggle("is-hidden",!saleMuted),muteBtn.classList.toggle("muted",saleMuted),syncFooterAudioMute(saleMuted),!saleMuted)
// User gesture: unlock audio so future sale sounds work.
try{primeSaleAudio()}catch(_){}}));try{window.addEventListener("kexo:sale-sound-updated",function(e){var url=e&&e.detail&&e.detail.url?String(e.detail.url).trim():"";"function"==typeof window.__kexoApplySaleSoundOverride&&window.__kexoApplySaleSoundOverride(url||null)})}catch(_){}
// Test sale sound: add ?cha=ching to the URL. Plays once when sound is on; if autoplay blocked, plays on first click.
!function(){function playTest(){saleMuted||(saleAudio.currentTime=0,saleAudio.play().catch(function(){}))}"ching"===new URLSearchParams(window.location.search).get("cha")&&saleAudio&&(playTest(),document.body.addEventListener("click",function once(){document.body.removeEventListener("click",once),playTest()},{once:!0}))}();const dateSelect=document.getElementById("global-date-select");if(dateSelect){mountDesktopDatePickerIntoPageHeader();try{const syncHeaderDatePlacement=function(){mountDesktopDatePickerIntoPageHeader()};window.addEventListener("resize",syncHeaderDatePlacement,{passive:!0}),window.addEventListener("orientationchange",syncHeaderDatePlacement),window.addEventListener("pageshow",syncHeaderDatePlacement)}catch(_){}syncDateSelectOptions(),applyRangeAvailable({today:!0,yesterday:!0}),updateLiveViewTitle(),updateRowsPerPageVisibility(),dateSelect.addEventListener("change",function(){const next=String(this.value||"").trim().toLowerCase();try{const opt=this.querySelector('option[value="'+next+'"]');if(opt&&opt.disabled)return void(this.value="today")}catch(_){}return"custom"===next?(openCustomDateModalFor({}),void
// Revert the select so "Custom" can be selected again.
syncDateSelectOptions()):
// Handle standard date ranges
"today"===next||"yesterday"===next||"7days"===next||"14days"===next||"30days"===next?(dateRange=next,void applyDateRangeChange({showTimeframeOverlay:!0,source:"header"})):
// Defensive: allow selecting an applied range key if present.
void(isCustomRangeKey(next)&&(dateRange=next,applyDateRangeChange({showTimeframeOverlay:!0,source:"header"})))}),function(){if(customDateModalInited)return;customDateModalInited=!0;const modal=document.getElementById("date-custom-modal");if(!modal)return;const closeBtn=document.getElementById("date-custom-close-btn");closeBtn&&closeBtn.addEventListener("click",function(e){e.preventDefault(),closeCustomDateModal()}),modal.addEventListener("click",function(e){e&&e.target===modal&&closeCustomDateModal()}),document.addEventListener("keydown",function(e){modal.classList.contains("show")&&"Escape"===(e&&(e.key||e.code)?String(e.key||e.code):"")&&closeCustomDateModal()});const clearBtn=document.getElementById("date-custom-clear"),applyBtn=document.getElementById("date-custom-apply");clearBtn&&clearBtn.addEventListener("click",function(e){e.preventDefault(),pendingCustomRangeStartYmd=null,pendingCustomRangeEndYmd=null,flatpickrInstance&&flatpickrInstance.clear(),updateCustomDateFooter()}),applyBtn&&applyBtn.addEventListener("click",function(e){if(e.preventDefault(),!pendingCustomRangeStartYmd||!pendingCustomRangeEndYmd)return;const startYmd=pendingCustomRangeStartYmd<=pendingCustomRangeEndYmd?pendingCustomRangeStartYmd:pendingCustomRangeEndYmd,endYmd=pendingCustomRangeStartYmd<=pendingCustomRangeEndYmd?pendingCustomRangeEndYmd:pendingCustomRangeStartYmd;if(startYmd<MIN_YMD||endYmd<MIN_YMD)return;const rk=makeRangeKeyFromYmds(startYmd,endYmd);if(!rk)return;const override=customDateApplyOverride;if("function"!=typeof override)customRangeStartYmd=startYmd,customRangeEndYmd=endYmd,dateRange=rk,closeCustomDateModal(),applyDateRangeChange({showTimeframeOverlay:!0});else{closeCustomDateModal();try{override({rangeKey:rk,startYmd:startYmd,endYmd:endYmd})}catch(_){}}})}(),function(){const sel=document.getElementById("global-date-select"),menu=document.getElementById("kexo-date-menu");sel&&menu&&"1"!==menu.getAttribute("data-kexo-bound")&&(menu.setAttribute("data-kexo-bound","1"),menu.addEventListener("click",function(e){const target=e&&e.target?e.target:null,btn=target&&target.closest?target.closest("[data-range]"):null;if(!btn)return;const v=String(btn.getAttribute("data-range")||"").trim();if(v&&!btn.disabled&&!btn.classList.contains("disabled")&&"true"!==btn.getAttribute("aria-disabled")){sel.value=v;try{sel.dispatchEvent(new Event("change",{bubbles:!0}))}catch(_){}syncHeaderDateDisplay(),syncHeaderDateMenuAvailability()}}),syncHeaderDateDisplay(),syncHeaderDateMenuAvailability())}();try{!function(options){var force=!!(options=options&&"object"==typeof options?options:{}).force;if(!force&&uiSettingsCache&&uiSettingsFetchedAt&&Date.now()-uiSettingsFetchedAt<3e5){if(options.apply&&uiSettingsCache.kpiUiConfig&&applyKpiUiConfigV1(uiSettingsCache.kpiUiConfig),options.apply&&uiSettingsCache.chartsUiConfig&&applyChartsUiConfigV1(uiSettingsCache.chartsUiConfig)&&scheduleChartsUiReRender(),options.apply&&uiSettingsCache.overviewWidgetsUiConfig)try{applyOverviewWidgetsUiConfigV1(uiSettingsCache.overviewWidgetsUiConfig)}catch(_){}if(options.apply&&uiSettingsCache.cssVarOverridesV1){var cachedVars=uiSettingsCache.cssVarOverridesV1.vars;if(cachedVars&&"object"==typeof cachedVars&&Object.keys(cachedVars).length>0)try{applyCssVarOverridesV1(uiSettingsCache.cssVarOverridesV1)}catch(_){}}if(options.apply&&uiSettingsCache.tablesUiConfig){try{applyTablesUiConfigV1(uiSettingsCache.tablesUiConfig)}catch(_){}try{scheduleTablesUiApply()}catch(_){}}if(options.apply&&uiSettingsCache.pageLoaderEnabled)try{applyPageLoaderEnabledV1(uiSettingsCache.pageLoaderEnabled)}catch(_){}if(options.apply&&uiSettingsCache.assetOverrides){var cachedUrl=(uiSettingsCache.assetOverrides.saleSound||uiSettingsCache.assetOverrides.sale_sound||"").trim();try{window.__kexoSaleSoundOverrideUrl=cachedUrl||""}catch(_){}if("function"==typeof window.__kexoApplySaleSoundOverride)try{window.__kexoApplySaleSoundOverride(cachedUrl||null)}catch(_){}}return Promise.resolve(uiSettingsCache)}if(uiSettingsInFlight)return uiSettingsInFlight;var url="/api/settings"+(force?"?_="+Date.now():"");uiSettingsInFlight=fetchWithTimeout(url,{credentials:"same-origin",cache:"no-store"},15e3).then(function(r){return r&&r.ok?r.json():null}).then(function(data){if(uiSettingsCache=data&&data.ok?data:null,uiSettingsFetchedAt=Date.now(),options.apply&&uiSettingsCache&&uiSettingsCache.kpiUiConfig&&applyKpiUiConfigV1(uiSettingsCache.kpiUiConfig),options.apply&&uiSettingsCache&&uiSettingsCache.chartsUiConfig&&applyChartsUiConfigV1(uiSettingsCache.chartsUiConfig)&&scheduleChartsUiReRender(),options.apply&&uiSettingsCache&&uiSettingsCache.overviewWidgetsUiConfig)try{applyOverviewWidgetsUiConfigV1(uiSettingsCache.overviewWidgetsUiConfig)}catch(_){}if(options.apply&&uiSettingsCache&&uiSettingsCache.cssVarOverridesV1){var serverVars=uiSettingsCache.cssVarOverridesV1.vars;if(serverVars&&"object"==typeof serverVars&&Object.keys(serverVars).length>0)try{applyCssVarOverridesV1(uiSettingsCache.cssVarOverridesV1)}catch(_){}}if(options.apply&&uiSettingsCache&&uiSettingsCache.tablesUiConfig){try{applyTablesUiConfigV1(uiSettingsCache.tablesUiConfig)}catch(_){}try{scheduleTablesUiApply()}catch(_){}}if(options.apply&&uiSettingsCache&&uiSettingsCache.pageLoaderEnabled)try{applyPageLoaderEnabledV1(uiSettingsCache.pageLoaderEnabled)}catch(_){}if(options.apply&&uiSettingsCache&&uiSettingsCache.assetOverrides){var url=(uiSettingsCache.assetOverrides.saleSound||uiSettingsCache.assetOverrides.sale_sound||"").trim();try{window.__kexoSaleSoundOverrideUrl=url||""}catch(_){}if("function"==typeof window.__kexoApplySaleSoundOverride)try{window.__kexoApplySaleSoundOverride(url||null)}catch(_){}}return uiSettingsCache}).catch(function(){return null}).finally(function(){uiSettingsInFlight=null})}({apply:!0})}catch(_){}}document.getElementById("table-title-tabs")&&document.querySelectorAll("#table-title-tabs button[data-range]").forEach(function(btn){btn.addEventListener("click",function(){!function(range){if(dateRange=range,"sales"===dateRange||"1h"===dateRange){const sel=document.getElementById("global-date-select");sel&&(sel.value="today")}lastOnlineCount=null,countryPage=1,updateLiveViewTitle(),updateRowsPerPageVisibility(),refreshKpis({force:!0}),updateKpis(),fetchSessions(),updateNextUpdateUi()}(btn.getAttribute("data-range"))})}),function(){const VALID_TABS=["dashboard","spy","sales","date","snapshot","stats","products","attribution","devices","ads","tools"],TAB_LABELS={dashboard:"Overview",spy:"Live View",sales:"Recent Sales",date:"Table View",snapshot:"Snapshot",stats:"Countries",products:"Products",variants:"Variants",attribution:"Attribution",devices:"Devices",ads:"Google Ads",tools:"Tools"},HASH_TO_TAB={dashboard:"dashboard","live-view":"spy",sales:"sales",date:"date",countries:"stats",products:"products",channels:"attribution",type:"devices",attribution:"attribution",devices:"devices",ads:"ads","compare-conversion-rate":"tools","change-pins":"tools"},TAB_TO_HASH={dashboard:"dashboard",spy:"live-view",sales:"sales",date:"date",stats:"countries",products:"products",attribution:"attribution",devices:"devices",ads:"ads",tools:"compare-conversion-rate"},tabDashboard=document.getElementById("nav-tab-dashboard"),tabSpy=document.getElementById("nav-tab-spy"),tabStats=document.getElementById("nav-tab-stats"),tabSnapshot=document.getElementById("nav-tab-snapshot"),tabProducts=document.getElementById("nav-tab-products"),tabVariants=document.getElementById("nav-tab-variants"),tabAds=document.getElementById("nav-tab-ads"),tabSales=document.getElementById("nav-tab-sales"),tabDate=document.getElementById("nav-tab-date"),tabTools=document.getElementById("nav-tab-tools"),panelDashboard=document.getElementById("tab-panel-dashboard"),panelSpy=document.getElementById("tab-panel-spy"),panelStats=document.getElementById("tab-panel-stats"),panelSnapshot=document.getElementById("tab-panel-snapshot"),panelProducts=document.getElementById("tab-panel-products"),panelAds=document.getElementById("tab-panel-ads"),pageTitleEl=document.getElementById("page-title"),navLinks=document.querySelectorAll("[data-nav]");
// Mobile tabs/nav: throttle global resize/scroll handlers + cleanup to reduce jank.
// Ads tab: lazy-load /ads.js only when Ads is opened.
let adsLoading=null,adsLoaded=!1;function tabFromHash(){var h=location.hash?location.hash.replace(/^#/,"").toLowerCase():"";return HASH_TO_TAB[h]||null}var hashUpdateInProgress=!1;var TAB_TO_NAV={spy:"live",snapshot:"snapshot",stats:"countries"};function updateNavSelection(tab){var navKey=TAB_TO_NAV[tab]||tab;navLinks.forEach(function(link){var isActive=link.getAttribute("data-nav")===navKey;link.setAttribute("aria-current",isActive?"page":"false");var parentItem=link.closest(".nav-item");if(parentItem)if(isActive)parentItem.classList.add("active");else{var menu=parentItem.querySelector(".dropdown-menu");menu&&menu.querySelector('.dropdown-item[aria-current="page"]')||parentItem.classList.remove("active")}link.classList.remove("active")}),tabDashboard&&tabDashboard.setAttribute("aria-selected","dashboard"===tab?"true":"false"),tabSpy&&tabSpy.setAttribute("aria-selected","spy"===tab?"true":"false"),tabSnapshot&&tabSnapshot.setAttribute("aria-selected","snapshot"===tab?"true":"false"),tabStats&&tabStats.setAttribute("aria-selected","stats"===tab?"true":"false"),tabProducts&&tabProducts.setAttribute("aria-selected","products"===tab?"true":"false"),tabVariants&&tabVariants.setAttribute("aria-selected","variants"===tab?"true":"false"),tabAds&&tabAds.setAttribute("aria-selected","ads"===tab?"true":"false"),tabSales&&tabSales.setAttribute("aria-selected","sales"===tab?"true":"false"),tabDate&&tabDate.setAttribute("aria-selected","date"===tab?"true":"false"),tabTools&&tabTools.setAttribute("aria-selected","tools"===tab?"true":"false");
// Dashboard dropdown ??? highlight parent li.nav-item when a child page is active
var isDashboardChild="dashboard"===tab||"spy"===tab||"sales"===tab||"date"===tab,dashboardToggle=document.querySelector('.nav-item.dropdown .dropdown-toggle[href="#navbar-dashboard-menu"]'),dashboardDropdownItem=dashboardToggle?dashboardToggle.closest(".nav-item"):null;dashboardToggle&&dashboardToggle.setAttribute("aria-current",isDashboardChild?"page":"false"),dashboardDropdownItem&&(isDashboardChild?dashboardDropdownItem.classList.add("active"):dashboardDropdownItem.classList.remove("active"));
// Insights dropdown (Snapshot + Countries + Products + Variants)
var isInsightsChild="snapshot"===tab||"stats"===tab||"products"===tab||"variants"===tab||"abandoned-carts"===tab||"checkout-funnel"===tab,insightsToggle=document.querySelector('.nav-item.dropdown .dropdown-toggle[href="#navbar-insights-menu"]'),insightsDropdownItem=insightsToggle?insightsToggle.closest(".nav-item"):null;insightsToggle&&insightsToggle.setAttribute("aria-current",isInsightsChild?"page":"false"),insightsDropdownItem&&(isInsightsChild?insightsDropdownItem.classList.add("active"):insightsDropdownItem.classList.remove("active"));
// Acquisition dropdown
var isAcquisitionChild="attribution"===tab||"devices"===tab,acquisitionToggle=document.querySelector('.nav-item.dropdown .dropdown-toggle[href="#navbar-acquisition-menu"]'),acquisitionDropdownItem=acquisitionToggle?acquisitionToggle.closest(".nav-item"):null;acquisitionToggle&&acquisitionToggle.setAttribute("aria-current",isAcquisitionChild?"page":"false"),acquisitionDropdownItem&&(isAcquisitionChild?acquisitionDropdownItem.classList.add("active"):acquisitionDropdownItem.classList.remove("active"));
// Integrations dropdown
var isIntegrationsChild="ads"===tab,integrationsToggle=document.querySelector('.nav-item.dropdown .dropdown-toggle[href="#navbar-integrations-menu"]'),integrationsDropdownItem=integrationsToggle?integrationsToggle.closest(".nav-item"):null;integrationsToggle&&integrationsToggle.setAttribute("aria-current",isIntegrationsChild?"page":"false"),integrationsDropdownItem&&(isIntegrationsChild?integrationsDropdownItem.classList.add("active"):integrationsDropdownItem.classList.remove("active"));
// Tools dropdown (include tool sub-pages so Tools is highlighted on /tools/* pages)
var isToolsChild="tools"===tab||"compare-conversion-rate"===tab||"shipping-cr"===tab||"click-order-lookup"===tab||"change-pins"===tab,toolsToggle=document.querySelector('.nav-item.dropdown .dropdown-toggle[href="#navbar-tools-menu"]'),toolsDropdownItem=toolsToggle?toolsToggle.closest(".nav-item"):null;toolsToggle&&toolsToggle.setAttribute("aria-current",isToolsChild?"page":"false"),toolsDropdownItem&&(isToolsChild?toolsDropdownItem.classList.add("active"):toolsDropdownItem.classList.remove("active")),
// Keep the page header icon in sync with the active top-level dropdown.
function(){
// Inject the active top-menu category icon into the page header (next to pretitle/title),
// using the same icon + accent as the active dropdown toggle.
try{var pretitle=document.querySelector(".page-header .page-pretitle");if(!pretitle)return;
// Remove previous injected icon(s) (legacy placed as sibling; current placed inside pretitle).
try{pretitle.querySelectorAll(".kexo-page-header-category-icon").forEach(function(el){try{el.remove()}catch(_){}})}catch(_){}try{var parent=pretitle.parentElement;parent&&parent.querySelectorAll(":scope > .kexo-page-header-category-icon").forEach(function(el){try{el.remove()}catch(_){}})}catch(_){}var navList=document.querySelector(".kexo-desktop-nav-list");if(!navList)return;
// Top-level active category (Dashboard/Insights/Traffic/Integrations/Tools)
var activeCat=navList.querySelector(":scope > .nav-item.dropdown.active");if(!activeCat)return;var toggle=activeCat.querySelector(":scope > .nav-link.dropdown-toggle");if(!toggle)return;var iconSrc=toggle.querySelector(".kexo-nav-svg");if(!iconSrc)return;var icon=iconSrc.cloneNode(!0);
// Avoid nav spacing helpers (they use !important and fight our header layout).
try{icon.classList.remove("me-1","me-2")}catch(_){}icon.classList.add("kexo-page-header-category-icon"),icon.setAttribute("aria-hidden","true");
// Apply the same accent index as the active top-level nav item.
var idx=0;try{idx=Array.prototype.slice.call(navList.children||[]).indexOf(activeCat)+1}catch(_){idx=0}idx>=1&&idx<=5&&icon.classList.add("kexo-accent-"+String(idx));
// Ensure the header icon matches the EXACT computed color from the menu icon,
// even if accents are altered by theme/scripts (no drift).
var computedColor="";try{computedColor=window.getComputedStyle&&iconSrc?window.getComputedStyle(iconSrc).color:"",(computedColor=String(computedColor||"").trim())&&(icon.style.color=computedColor)}catch(_){}pretitle.insertBefore(icon,pretitle.firstChild||null);
// Mobile-only: inject a small arrow icon before the page title text.
// (Shown/hidden purely by CSS media queries so it applies to every page consistently.)
try{var title=document.querySelector(".page-header .kexo-page-header-title-col .page-title");if(title){title.querySelectorAll(".kexo-page-header-title-icon").forEach(function(el){try{el.remove()}catch(_){}}),title.querySelectorAll(".kexo-page-title-mobile-sep").forEach(function(el){try{el.remove()}catch(_){}}),title.querySelectorAll(".kexo-page-title-mobile-arrow").forEach(function(el){try{el.remove()}catch(_){}});var arrow=document.createElement("i");arrow.className="fa-thin fa-arrow-turn-down-right kexo-page-title-mobile-arrow",arrow.setAttribute("aria-hidden","true"),title.insertBefore(arrow,title.firstChild||null)}}catch(_){}
// Expose accent for connector lines (very light tint of same shade).
try{var row=pretitle.closest(".row.align-items-center");row&&computedColor&&row.style.setProperty("--kexo-page-header-accent",computedColor)}catch(_){}
// Top-of-page section strip: same color as active category underline.
try{computedColor&&document.documentElement.style.setProperty("--kexo-section-accent",computedColor)}catch(_){}}catch(_){}}()}function runTabWork(tab){
// Keep condensed KPI strip fitted to available width.
try{scheduleCondensedKpiOverflowUpdate()}catch(_){}
// Keep the global date selector visible on ALL pages (including Tools) for consistent header UX.
var globalDateSel=document.getElementById("global-date-select");function ensureKpis(){var rangeKey="";try{rangeKey=getStatsRange()}catch(_){rangeKey=""}if(!(!(!rangeKey||!kpiCache||kpiCacheRange!==rangeKey)&&"kpis"===kpiCacheSource)||!lastKpisFetchedAt||Date.now()-lastKpisFetchedAt>12e4)refreshKpis({force:!1});else{renderLiveKpis(getKpiData());try{refreshKpiExtrasSoft()}catch(_){}try{fetchCondensedSeries()}catch(_){}}}if(globalDateSel&&(globalDateSel.style.display=""),syncDateSelectOptions(),updateNextUpdateUi(),"tools"!==tab)if("snapshot"!==tab)if("dashboard"===tab){try{"function"==typeof window.refreshDashboard&&window.refreshDashboard({force:!1})}catch(_){}refreshKpis({force:!1}).then(function(data){data&&renderDashboardKpisFromApi(data)})}else if("stats"===tab)refreshStats({force:!1}),ensureKpis();else if("products"===tab)refreshProducts({force:!1}),ensureKpis();else if("variants"===tab){try{"function"==typeof window.__refreshVariantsInsights&&window.__refreshVariantsInsights({force:!1})}catch(_){}ensureKpis()}else if("abandoned-carts"===tab){try{refreshAbandonedCarts({force:!1})}catch(_){fetchSessions()}ensureKpis()}else if("checkout-funnel"===tab){try{refreshCheckoutFunnel({force:!1})}catch(_){}ensureKpis()}else if("attribution"===tab)refreshAttribution({force:!1}),ensureKpis();else if("devices"===tab)refreshDevices({force:!1}),ensureKpis();else if("browsers"===tab)refreshBrowsers({force:!1}),ensureKpis();else if("ads"===tab)ensureKpis(),(adsLoaded?Promise.resolve(!0):adsLoading||(adsLoading=new Promise(function(resolve){const existing=document.querySelector('script[data-ads-js="1"]');if(existing){
// If the script tag exists but hasn't executed yet (defer + slow network),
// wait for it so Ads can initialize immediately instead of staying blank.
try{if(window.__adsInit||window.__adsRefresh)return adsLoaded=!0,void resolve(!0)}catch(_){}const onLoad=function(){adsLoaded=!0,resolve(!0)},onError=function(){resolve(!1)};try{existing.addEventListener("load",onLoad,{once:!0}),existing.addEventListener("error",onError,{once:!0})}catch(_){}
// Edge: if it already loaded before listeners attached, resolve on next tick.
return void setTimeout(function(){try{(window.__adsInit||window.__adsRefresh)&&(adsLoaded=!0,resolve(!0))}catch(_){}},0)}const s=document.createElement("script");s.src="/ads.js",s.async=!0,s.defer=!0,s.setAttribute("data-ads-js","1"),s.onload=function(){adsLoaded=!0,resolve(!0)},s.onerror=function(){resolve(!1)},document.head.appendChild(s)}).finally(function(){adsLoading=null}),adsLoading)).then(function(ok){ok&&
// IMPORTANT: if `/ads.js` is already present as a deferred script tag (e.g. on `/integrations/google-ads` page),
// the promise can resolve before the script executes (microtask checkpoint after this script),
// leaving Ads blank until another event triggers a refresh. Defer one macrotask so Ads JS has run.
setTimeout(function(){try{window.__adsInit?window.__adsInit():window.__adsRefresh&&window.__adsRefresh({force:!1})}catch(_){}},0)});else{var sessionStaleMs="live"===dateRange?6e4:"today"===dateRange||"sales"===dateRange||"1h"===dateRange?3e5:6e4;(!lastSessionsFetchedAt||Date.now()-lastSessionsFetchedAt>sessionStaleMs)&&fetchSessions(),ensureKpis()}else ensureKpis();else ensureKpis()}function setTab(tab){var isDashboard="dashboard"===tab,isSpy="spy"===tab,isStats="stats"===tab,isProducts="products"===tab,isAds="ads"===tab;activeMainTab=tab,function(tab){if(!PAGE){var h=TAB_TO_HASH[tab]||"dashboard";if(location.hash!=="#"+h){hashUpdateInProgress=!0;try{history.replaceState(null,"","#"+h)}catch(_){}hashUpdateInProgress=!1}}}(tab),pageTitleEl&&!PAGE&&(pageTitleEl.textContent=TAB_LABELS[tab]||"Overview"),updateNavSelection(tab),panelDashboard&&panelDashboard.classList.toggle("active",isDashboard);var isSales="sales"===tab,isDate="date"===tab,isSnapshot="snapshot"===tab;panelSpy&&panelSpy.classList.toggle("active",isSpy||isSales||isDate),panelSnapshot&&panelSnapshot.classList.toggle("active",isSnapshot),panelStats&&panelStats.classList.toggle("active",isStats),panelProducts&&panelProducts.classList.toggle("active",isProducts),panelAds&&panelAds.classList.toggle("active",isAds);try{sessionStorage.setItem("kexo-main-tab",tab)}catch(_){}try{window.dispatchEvent(new CustomEvent("kexo:main-tab-changed",{detail:{tab:tab}}))}catch(_){}runTabWork(tab);
// Ensure navbar live visitors status updates immediately on navigation.
try{updateKpis()}catch(_){}}try{window.setTab=setTab}catch(_){}if(PAGE){setTab("live"===PAGE?"spy":"snapshot"===PAGE?"snapshot":"countries"===PAGE?"stats":"sales"===PAGE?"sales":"date"===PAGE?"date":"channels"===PAGE?"attribution":"type"===PAGE?"devices":"attribution"===PAGE?"attribution":"devices"===PAGE?"devices":"browsers"===PAGE?"browsers":"compare-conversion-rate"===PAGE||"shipping-cr"===PAGE||"click-order-lookup"===PAGE||"change-pins"===PAGE?PAGE:"checkout-funnel"===PAGE?"checkout-funnel":PAGE)}
// Hash-based routing: hash overrides sessionStorage
else{var initialTab="dashboard",hashTab=tabFromHash();if(hashTab&&-1!==VALID_TABS.indexOf(hashTab))initialTab=hashTab;else try{var saved=sessionStorage.getItem("kexo-main-tab");saved&&-1!==VALID_TABS.indexOf(saved)&&(initialTab=saved)}catch(_){}setTab(initialTab),window.addEventListener("hashchange",function(){if(!hashUpdateInProgress){var t=tabFromHash();t&&-1!==VALID_TABS.indexOf(t)&&t!==activeMainTab&&setTab(t)}}),tabDashboard&&tabDashboard.addEventListener("click",function(){setTab("dashboard")}),tabSpy&&tabSpy.addEventListener("click",function(){setTab("spy")}),tabStats&&tabStats.addEventListener("click",function(){setTab("stats")}),tabProducts&&tabProducts.addEventListener("click",function(){setTab("products")}),tabAds&&tabAds.addEventListener("click",function(){setTab("ads")}),tabTools&&tabTools.addEventListener("click",function(){setTab("tools")})}}(),function(){const navLeft=document.querySelector(".kexo-desktop-nav-left");if(navLeft){navLeft.querySelectorAll(".dropdown").forEach(function(dropdownEl){dropdownEl.addEventListener("shown.bs.dropdown",function(){isMobileViewport()&&updateMobileNavDropdownTop()})}),navLeft.addEventListener("show.bs.dropdown",function(){isMobileViewport()&&navLeft.classList.add("is-dropdown-open")}),navLeft.addEventListener("hide.bs.dropdown",function(){isMobileViewport()&&setTimeout(syncDropdownOverflowState,0)});var onResize=kexoDebounce(function(){syncDropdownOverflowState(),updateMobileNavDropdownTop()},120);window.addEventListener("resize",onResize,{passive:!0});var onScroll=kexoThrottle(function(){closeOpenNavDropdowns()},120);window.addEventListener("scroll",onScroll,{passive:!0});try{kexoRegisterCleanup(function(){try{window.removeEventListener("resize",onResize)}catch(_){}try{window.removeEventListener("scroll",onScroll)}catch(_){}try{onResize&&onResize.cancel&&onResize.cancel()}catch(_){}try{onScroll&&onScroll.cancel&&onScroll.cancel()}catch(_){}})}catch(_){}window.addEventListener("orientationchange",function(){resetNavStartPosition(),syncDropdownOverflowState(),updateMobileNavDropdownTop()}),window.addEventListener("pageshow",function(){resetNavStartPosition(),syncDropdownOverflowState()}),resetNavStartPosition(),syncDropdownOverflowState(),updateMobileNavDropdownTop()}function isMobileViewport(){try{if("function"==typeof window.matchMedia)return window.matchMedia("(max-width: 991.98px)").matches}catch(_){}return(window.innerWidth||0)<992}function syncDropdownOverflowState(){if(!isMobileViewport())return void navLeft.classList.remove("is-dropdown-open");const hasOpenMenu=!!navLeft.querySelector(".dropdown-menu.show");navLeft.classList.toggle("is-dropdown-open",hasOpenMenu)}function resetNavStartPosition(){if(isMobileViewport())try{navLeft.scrollLeft=0}catch(_){}}function updateMobileNavDropdownTop(){if(!isMobileViewport())return;const nav=document.querySelector(".kexo-desktop-nav");if(!nav)return;const rect=nav.getBoundingClientRect();document.documentElement.style.setProperty("--kexo-mobile-nav-dropdown-top",rect.bottom-4+"px")}function closeOpenNavDropdowns(){isMobileViewport()&&navLeft.querySelectorAll(".dropdown-menu.show").forEach(function(menu){const toggle=menu.closest(".dropdown")&&menu.closest(".dropdown").querySelector('[data-bs-toggle="dropdown"]');if(toggle&&"undefined"!=typeof bootstrap&&bootstrap.Dropdown)try{const instance=bootstrap.Dropdown.getOrCreateInstance(toggle);instance&&instance.hide()}catch(_){}})}}(),function(){var navList=document.querySelector(".kexo-desktop-nav-list");if(navList){var styleEl=document.getElementById("kexo-nav-dropdown-accent");styleEl||((styleEl=document.createElement("style")).id="kexo-nav-dropdown-accent",styleEl.textContent=[".kexo-desktop-nav-list .nav-item.dropdown.kexo-dropdown-open .nav-link {","  --tblr-dropdown-bg: var(--kexo-accent, var(--tblr-primary, #3eb3ab)) !important;","  background: var(--kexo-accent, var(--tblr-primary, #3eb3ab)) !important;","  background-color: var(--kexo-accent, var(--tblr-primary, #3eb3ab)) !important;","  color: #fff !important;","  border-radius: 4px 4px 0 0;","}",".kexo-desktop-nav-list .nav-item.dropdown.kexo-dropdown-open .dropdown-menu {","  --tblr-dropdown-bg: var(--kexo-accent, var(--tblr-primary, #3eb3ab)) !important;","  background: var(--kexo-accent, var(--tblr-primary, #3eb3ab)) !important;","  background-color: var(--kexo-accent, var(--tblr-primary, #3eb3ab)) !important;","  color: #fff !important;","  border-radius: 0 0 4px 4px;","}",".kexo-desktop-nav-list .nav-item.dropdown.kexo-dropdown-open .nav-link > .kexo-nav-svg,",'.kexo-desktop-nav-list .nav-item.dropdown.kexo-dropdown-open .nav-link > i[class*="fa-"] {',"  opacity: 1 !important;","  color: #fff !important;","}","/* Override active accent icon when dropdown open (focused) ??? icon back to white */",".kexo-desktop-nav-list .nav-item.dropdown.kexo-dropdown-open.active .nav-link > .kexo-nav-svg,",'.kexo-desktop-nav-list .nav-item.dropdown.kexo-dropdown-open.active .nav-link > i[class*="fa-"] {',"  color: #fff !important;","}",".kexo-desktop-nav-list .nav-item.dropdown.kexo-dropdown-open .dropdown-item,",".kexo-desktop-nav-list .nav-item.dropdown.kexo-dropdown-open .dropdown-item .kexo-nav-svg,",".kexo-desktop-nav-list .nav-item.dropdown.kexo-dropdown-open .dropdown-item .kexo-nav-dropdown-item-icon {","  color: #fff !important;","}"].join("\n"),document.head.appendChild(styleEl)),navList.addEventListener("show.bs.dropdown",function(e){var navItem=e.target&&e.target.closest?e.target.closest(".nav-item.dropdown"):null;navItem&&navItem.classList.add("kexo-dropdown-open")}),navList.addEventListener("hide.bs.dropdown",function(e){var navItem=e.target&&e.target.closest?e.target.closest(".nav-item.dropdown"):null;navItem&&navItem.classList.remove("kexo-dropdown-open")})}}(),function(){function positionStripDropdown(menu){if(!menu||!menu.classList.contains("kexo-strip-dropdown-align"))return;const nav=document.querySelector(".kexo-desktop-nav-container"),strip=document.querySelector(".kexo-desktop-top-strip");if(!nav||!strip)return;const navRect=nav.getBoundingClientRect(),stripRect=strip.getBoundingClientRect();menu.style.setProperty("position","fixed"),menu.style.setProperty("left",navRect.left+"px"),menu.style.setProperty("top",stripRect.bottom+5+"px"),menu.style.setProperty("right","auto")}function onStripDropdownShown(e){const menu=e.target.querySelector(".dropdown-menu.kexo-strip-dropdown-align");menu&&(positionStripDropdown(menu),requestAnimationFrame(function(){positionStripDropdown(menu)}))}document.querySelectorAll(".kexo-desktop-top-strip .dropdown").forEach(function(dd){dd.addEventListener("shown.bs.dropdown",onStripDropdownShown)});var onResize=kexoDebounce(function(){document.querySelectorAll(".dropdown-menu.kexo-strip-dropdown-align.show").forEach(positionStripDropdown)},120);window.addEventListener("resize",onResize,{passive:!0});try{kexoRegisterCleanup(function(){try{window.removeEventListener("resize",onResize)}catch(_){}try{onResize&&onResize.cancel&&onResize.cancel()}catch(_){}})}catch(_){}}(),function(){const btn=document.getElementById("refresh-btn");btn&&btn.addEventListener("click",function(){if(updateAvailable)try{window.location.reload()}catch(_){try{window.location.href=window.location.href}catch(_){}}else btn.classList.add("refresh-spinning"),setTimeout(function(){btn.classList.remove("refresh-spinning")},600),
// Silent refresh: never cover the page with the overlay loader while refreshing.
// (Use the subtle date-range spinner + the refresh button spin only.)
kexoWithSilentOverlay(function(){if("dashboard"===activeMainTab)try{"function"==typeof window.refreshDashboard&&window.refreshDashboard({force:!0,silent:!0})}catch(_){}else if("stats"===activeMainTab)try{refreshStats({force:!0})}catch(_){}else if("products"===activeMainTab)try{refreshProducts({force:!0})}catch(_){}else if("variants"===activeMainTab)try{"function"==typeof window.__refreshVariantsInsights&&window.__refreshVariantsInsights({force:!0})}catch(_){}else if("abandoned-carts"===activeMainTab)try{refreshAbandonedCarts({force:!0})}catch(_){try{fetchSessions()}catch(_){}}else if("checkout-funnel"===activeMainTab)try{refreshCheckoutFunnel({force:!0})}catch(_){}else if("attribution"===activeMainTab)try{refreshAttribution({force:!0})}catch(_){}else if("devices"===activeMainTab)try{refreshDevices({force:!0})}catch(_){}else if("ads"===activeMainTab)try{window.__adsRefresh&&window.__adsRefresh({force:!0})}catch(_){}else try{fetchSessions()}catch(_){}try{refreshKpis({force:!0})}catch(_){}})})}(),updateServerTimeDisplay(),updateNextUpdateUi(),_intervals.push(setInterval(function(){"visible"===document.visibilityState&&(updateServerTimeDisplay(),updateNextUpdateUi())},1e3))}(),function(){function onScroll(wrapId,cardId){const wrap=document.getElementById(wrapId),card=document.getElementById(cardId);function update(){card.classList.toggle("scrolled",wrap.scrollTop>0)}wrap&&card&&(wrap.addEventListener("scroll",update),update())}onScroll("country-table-wrap","stats-country"),onScroll("best-sellers-wrap","stats-best-sellers"),onScroll("best-variants-wrap","stats-best-variants")}(),liveSalesAutoPollEnabled()&&
// Stable GETs: cache small TTL to reduce duplicate version/config reads.
// Defer the first poll slightly so initial page load fetch/render completes first.
scheduleLiveSalesPoll(1e4);var _tickTimeIntervalId=null;function ensureTickTimeInterval(){return _tickTimeIntervalId||(_tickTimeIntervalId=setInterval(function(){if("visible"===document.visibilityState)try{tickTimeOnSite()}catch(_){}},3e4),_intervals.push(_tickTimeIntervalId),_tickTimeIntervalId)}
// Background polling is intentionally disabled across the site (manual refresh only),
// except for /dashboard/live and /dashboard/sales (which use a dedicated 10s poller).
ensureTickTimeInterval();
// ?????? Tab resume + deploy drift guard ???????????????????????????????????????????????????????????????????????????????????????????????????????????????
// In Safari/iOS (and some embed contexts) long-idle tabs can resume with a "white page"
// or broken JS/CSS if a deploy happened while the tab was backgrounded. We expose an
// assetVersion signal via /api/version; if it changes while hidden, hard-reload on resume.
var _bootVersionSig=null,_lastHiddenAt=0,_versionCheckInFlight=null;function fetchVersionSig(){if(_versionCheckInFlight)return _versionCheckInFlight;var url="/api/version";return _versionCheckInFlight=kexoFetchOkJsonStable(url,{credentials:"same-origin"},6e4).then(function(data){if(_versionCheckInFlight=null,!data)return null;var av=null!=data.assetVersion?String(data.assetVersion):"",pv=null!=data.version?String(data.version):"",sig=av||pv?av+"|"+pv:"";return sig&&sig.trim()?sig:null}).catch(function(err){try{"function"==typeof window.kexoCaptureError&&window.kexoCaptureError(err,{context:"version.fetchSig"})}catch(_){}return _versionCheckInFlight=null,null})}try{fetchVersionSig().then(function(sig){sig&&(_bootVersionSig=sig)})}catch(_){}function onBecameVisible(){updateServerTimeDisplay(),updateNextUpdateUi()}
// On mobile, post-login redirect can restore the dashboard from bfcache; DOMContentLoaded
// does not fire again, so data fetches never run. Refresh when page is shown from bfcache.
// Also restart SSE and pollers (runCleanup on pagehide closes them).
window.addEventListener("pageshow",function(ev){ev.persisted&&(!function(){try{initEventSource()}catch(_){}ensureTickTimeInterval();try{scheduleLiveSalesPoll(1e4)}catch(_){}try{"function"==typeof window.__kexoInitStickyDocObserver&&window.__kexoInitStickyDocObserver()}catch(_){}try{"function"==typeof window.__kexoInitGridDocObserver&&window.__kexoInitGridDocObserver()}catch(_){}}(),kexoWithSilentOverlay(function(){if("dashboard"===PAGE)try{window.dashboardController&&"function"==typeof window.dashboardController.onVisibleResume?window.dashboardController.onVisibleResume("pageshow"):"function"==typeof window.refreshDashboard&&window.refreshDashboard({force:!0,silent:!0})}catch(_){}try{refreshKpis({force:!0})}catch(_){}}))});// Skip full refresh if tab was hidden < 30s (avoids lag on brief tab switch)
document.addEventListener("visibilitychange",function(){if("visible"===document.visibilityState){var idleMs=_lastHiddenAt?Date.now()-_lastHiddenAt:0;
// Skip refresh for brief hides (< 30s) to avoid CPU/memory spike when returning to tab.
if(idleMs<3e4)return onBecameVisible();
// Dashboard has its own visibility listener (dashboardController); delegate to avoid duplicate refresh.
// When on dashboard, dashboardController handles refresh + KPIs. When on other pages, refresh KPIs only.
if(idleMs<12e4&&"dashboard"===PAGE?kexoWithSilentOverlay(function(){try{if(window.dashboardController&&"function"==typeof window.dashboardController.onVisibleResume)window.dashboardController.onVisibleResume("visibility");else{"function"==typeof window.refreshDashboard&&window.refreshDashboard({force:!0,silent:!0});try{refreshKpis({force:!0})}catch(_){}}}catch(_){}}):idleMs<12e4&&"dashboard"!==PAGE&&kexoWithSilentOverlay(function(){try{refreshKpis({force:!0})}catch(_){}}),idleMs<6e5)return onBecameVisible();fetchVersionSig().then(function(sig){if(_bootVersionSig&&sig&&sig!==_bootVersionSig){try{!function(next,opts){updateAvailable=!!next;const reason=opts&&opts.reason?String(opts.reason):"";try{document.body.classList.toggle("kexo-update-available",updateAvailable)}catch(_){}try{document.documentElement.toggleAttribute("data-kexo-update-available",updateAvailable)}catch(_){}try{const btn=document.getElementById("refresh-btn");btn&&btn.setAttribute("title",updateAvailable?"Update available. Click to reload."+(reason?" "+reason:""):"Refresh")}catch(_){}try{document.querySelectorAll(".footer-refresh-btn").forEach(function(btn){btn&&btn.setAttribute("title",updateAvailable?"Update available. Click to reload."+(reason?" "+reason:""):"Refresh")})}catch(_){}}(!0,{reason:"New deploy detected."})}catch(_){}try{_bootVersionSig=sig}catch(_){}return onBecameVisible()}!_bootVersionSig&&sig&&(_bootVersionSig=sig),onBecameVisible()}).catch(function(){onBecameVisible()})}else{_lastHiddenAt=Date.now();try{window.__kexoLastHiddenAt=_lastHiddenAt}catch(_){}}});var _newSaleRefreshTimer=null;function scheduleNewSaleDashboardRefresh(){_newSaleRefreshTimer||(_newSaleRefreshTimer=setTimeout(function(){_newSaleRefreshTimer=null;try{refreshKpis({force:!0})}catch(_){}try{"dashboard"!==PAGE&&"dashboard"!==activeMainTab||"function"==typeof window.refreshDashboard&&window.refreshDashboard({force:!0,silent:!0,reason:"new-sale"})}catch(_){}},280))}function initEventSource(){if(_eventSource)try{_eventSource.close()}catch(_){}var es=new EventSource("/api/stream");_eventSource=es,es.onerror=function(){
// Browser auto-reconnects on transient errors; if the connection is
// permanently closed (readyState === CLOSED), retry after a delay.
if(es.readyState===EventSource.CLOSED){try{es.close()}catch(_){}setTimeout(function(){_eventSource===es&&initEventSource()},5e3)}},es.onmessage=function(e){try{var msg=JSON.parse(e.data);if("session_update"===msg.type&&msg.session){const session=msg.session;
// Keep footer "Last sale" correct and show the banner globally.
if(session&&session.has_purchased&&null!=session.purchased_at){!function(session){try{if(!session||!session.has_purchased)return;const purchasedAt=null!=session.purchased_at?toMs(session.purchased_at):null;if(null==purchasedAt)return;const cur=null==lastSaleAt?null:toMs(lastSaleAt);
// If we don't have a baseline yet: only skip if the sale is old (likely stale catch-up).
// If the sale is recent (within 2 min), treat it as new and fire toast + sound.
if(null==cur){if(setLastSaleAt(purchasedAt),Date.now()-purchasedAt>12e4)return;// older than 2 min: skip (stale)
return triggerSaleToast({origin:"sse",session:session,playSound:!0}),void scheduleNewSaleDashboardRefresh()}if(purchasedAt<=cur)return void setLastSaleAt(purchasedAt);setLastSaleAt(purchasedAt),triggerSaleToast({origin:"sse",session:session,playSound:!0}),scheduleNewSaleDashboardRefresh()}catch(_){}}(session),function(session){
// If the toast is currently showing for this session, patch the amount when order_total arrives.
try{const sid=session&&null!=session.session_id?String(session.session_id):"";if(!sid||!saleToastActive||!saleToastSessionId||String(saleToastSessionId)!==sid)return;const cc=session&&session.country_code?String(session.country_code).toUpperCase().slice(0,2):"XX",productTitle=session&&session.last_product_handle?titleCaseFromHandle(String(session.last_product_handle)):"",curTitle=document.getElementById("sale-toast-product")?String(document.getElementById("sale-toast-product").textContent||""):"";let amountGbp=null;if(session&&null!=session.order_total){const n="number"==typeof session.order_total?session.order_total:parseFloat(String(session.order_total));Number.isFinite(n)&&(amountGbp=n)}null!=amountGbp&&Number.isFinite(amountGbp)&&setSaleToastContent({countryCode:cc||"XX",productTitle:productTitle||curTitle||"—",amountGbp:amountGbp})}catch(_){}}(session);try{!function(nextRaw){if(!document.getElementById("latest-sales-table"))return;const next=normalizeLatestSaleRow(nextRaw);if(!next||!next.session_id||null==next.purchased_at)return;const cur=Array.isArray(latestSalesCache)?latestSalesCache.slice():[],idx=cur.findIndex(function(r){return r&&r.session_id&&String(r.session_id)===String(next.session_id)});
// SSE gives us the raw session row (may lack product title / GBP conversion).
// Refresh the server-enriched latest-sales payload shortly after a new sale is detected.
if(idx>=0?cur[idx]={...cur[idx]||{},...next}:cur.unshift(next),cur.sort(function(a,b){return(toMs(b&&b.purchased_at)||0)-(toMs(a&&a.purchased_at)||0)}),latestSalesCache=cur.slice(0,5),renderLatestSalesTable(latestSalesCache),idx<0)try{latestSalesRefetchTimer&&clearTimeout(latestSalesRefetchTimer),latestSalesRefetchTimer=setTimeout(function(){latestSalesRefetchTimer=null;try{fetchLatestSales({force:!0})}catch(_){}},400)}catch(_){}}(session)}catch(_){}}}}catch(_){}}}initEventSource(),
// ?????? Cleanup on page unload (centralized via registerCleanup in core) ??????
registerCleanup(function(){if(_intervals.forEach(function(id){clearInterval(id)}),_intervals.length=0,_tickTimeIntervalId=null,liveSalesPollTimer){try{clearTimeout(liveSalesPollTimer)}catch(_){}liveSalesPollTimer=null}if(_newSaleRefreshTimer){try{clearTimeout(_newSaleRefreshTimer)}catch(_){}_newSaleRefreshTimer=null}if(_eventSource){try{_eventSource.close()}catch(_){}_eventSource=null}if(_condensedStripResizeObserver){try{_condensedStripResizeObserver.disconnect()}catch(_){}_condensedStripResizeObserver=null}try{document.querySelectorAll(".table-scroll-wrap, .country-table-wrap, .grid-table, .table-responsive").forEach(function(wrap){try{wrap&&wrap._dragScrollObserver&&"function"==typeof wrap._dragScrollObserver.disconnect&&wrap._dragScrollObserver.disconnect()}catch(_){}try{wrap&&wrap._stickyResizeObserver&&"function"==typeof wrap._stickyResizeObserver.disconnect&&wrap._stickyResizeObserver.disconnect()}catch(_){}try{wrap&&wrap._stickyResizeMutationObserver&&"function"==typeof wrap._stickyResizeMutationObserver.disconnect&&wrap._stickyResizeMutationObserver.disconnect()}catch(_){}})}catch(_){}Object.keys(_fetchAbortControllers).forEach(function(k){try{_fetchAbortControllers[k].abort()}catch(_){}})}),
// ?????? Dashboard tab logic ??????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
function(){var dashLoading=!1,dashLastRangeKey=null,dashLastTrendingPreset=null,dashFetchRequestId=0,dashLastDayYmd=null,dashCompareSeriesCache=null,dashCompareRangeKey=null,dashCompareFetchedAt=0,dashCompareSeriesInFlight=null,dashPayloadSignature="",dashCharts={},dashSparkCharts={},dashController=null,dashProfitRulesUpdatedBound=!1,dashProfitRulesUpdatedHandler=null,overviewMiniResizeObserver=null,overviewMiniFetchedAt=0,overviewMiniResizeTimer=null,overviewHeightSyncObserver=null,overviewHeightSyncTimer=null,overviewHeightSyncResizeBound=!1,overviewHeightSyncObservedElements=[],overviewMiniResizeObservedElements=[],overviewCardCache={},overviewCardInFlight={},overviewCardPayloadSignature={},overviewLazyObserver=null,overviewLazyPending={},overviewLazyVisible={},overviewCardUiBound=!1,dashDocClickBound=!1,dashDocClickHandler=null;function bindDashDocumentClickOnce(){if(!dashDocClickBound){dashDocClickBound=!0,dashDocClickHandler=function(e){var t=e&&e.target?e.target:null;if(t&&t.closest)if(t.closest(".kexo-score-popover-close"))try{if(void 0!==window.bootstrap&&window.bootstrap.Popover){var Popover=window.bootstrap.Popover;document.querySelectorAll('[data-kexo-score-popover="1"]').forEach(function(n){try{var inst=Popover.getInstance(n);inst&&inst.hide()}catch(_){}})}}catch(_){}else{
// Overview card range controls.
var rangeBtn=t.closest("[data-overview-range][data-overview-chart]");if(rangeBtn){e.preventDefault();var chartId=String(rangeBtn.getAttribute("data-overview-chart")||"").trim(),rangeKey=String(rangeBtn.getAttribute("data-overview-range")||"").trim().toLowerCase();if(!chartId||!rangeKey)return;if("custom"===rangeKey)return void function(chartId){var id=(null==chartId?"":String(chartId)).trim();if(!id)return;if("function"!=typeof window.__kexoOpenCustomDateModalFor)return;var currentRk=getOverviewCardRange(id,"7d"),prefill=/^(r:|d:)/.test(currentRk)?currentRk:null;try{window.__kexoOpenCustomDateModalFor({prefillRangeKey:prefill,onApply:function(res){var next=res&&null!=res.rangeKey?String(res.rangeKey):"";next=normalizeOverviewCardRangeKey(next,"7d"),setOverviewCardRange(id,next),syncOverviewCardRangeUi(id),fetchOverviewCardData(id,{force:!0,rangeKey:next,renderIfFresh:!0})}})}catch(_){}}(chartId);var next=normalizeOverviewCardRangeKey(rangeKey,"7d");return setOverviewCardRange(chartId,next),syncOverviewCardRangeUi(chartId),void fetchOverviewCardData(chartId,{force:!0,rangeKey:next,renderIfFresh:!0})}
// Overview card chart settings buttons.
var settingsBtn=t.closest(".kexo-overview-chart-settings-btn[data-kexo-chart-settings-key]");if(settingsBtn){e.preventDefault(),e.stopPropagation();var chartKey=String(settingsBtn.getAttribute("data-kexo-chart-settings-key")||"").trim();if(!chartKey)return;var cardTitle="";try{var wrap=overviewCardWrap(chartKey),titleEl=wrap?wrap.querySelector(".subheader"):null;cardTitle=titleEl&&titleEl.textContent?String(titleEl.textContent).trim():""}catch(_){}try{if(window.KexoChartSettingsBuilder&&"function"==typeof window.KexoChartSettingsBuilder.openModal)return void window.KexoChartSettingsBuilder.openModal({chartKey:chartKey,cardTitle:cardTitle||chartKey});window.KexoLayoutShortcuts&&"function"==typeof window.KexoLayoutShortcuts.openChartModal&&window.KexoLayoutShortcuts.openChartModal({chartKey:chartKey,cardTitle:cardTitle||chartKey})}catch(_){}}
// Overview widgets settings buttons.
else{var widgetBtn=t.closest("[data-kexo-overview-widget-settings]");if(widgetBtn){e.preventDefault(),e.stopPropagation();try{openOvwSettings(widgetBtn)}catch(_){}}}}
// Kexo Score popover close buttons (modal + overview).
};try{document.addEventListener("click",dashDocClickHandler)}catch(_){}registerCleanup(function(){try{document.removeEventListener("click",dashDocClickHandler)}catch(_){}dashDocClickHandler=null,dashDocClickBound=!1})}}var OVERVIEW_LAZY_CHART_IDS={"dash-chart-attribution-30d":!0,"dash-chart-overview-30d":!0};var _rootStylesDash=getComputedStyle(document.documentElement),_primaryRgbDash=_rootStylesDash.getPropertyValue("--tblr-primary-rgb").trim()||"32,107,196",DASH_ACCENT=(function(value,fallback){var raw=null==value?"":String(value).trim();if(!raw)return fallback;var hex=raw.replace(/^#/,"");if(/^[0-9a-f]{6}$/i.test(hex))return parseInt(hex.slice(0,2),16)+","+parseInt(hex.slice(2,4),16)+","+parseInt(hex.slice(4,6),16);var m=raw.replace(/\s+/g,"").match(/^rgba?\((\d+),(\d+),(\d+)(?:,([0-9.]+))?\)$/i);m&&(Math.max(0,Math.min(255,parseInt(m[1],10)||0)),Math.max(0,Math.min(255,parseInt(m[2],10)||0)),Math.max(0,Math.min(255,parseInt(m[3],10)||0)))}(_rootStylesDash.getPropertyValue("--kexo-accent-1").trim(),_primaryRgbDash),"rgb("+_primaryRgbDash+")"),DASH_ACCENT_LIGHT="rgba("+_primaryRgbDash+",0.12)",DASH_ORANGE="#f59e0b",DASH_BLUE="#3b82f6",DASH_BLUE_LIGHT="rgba(59,130,246,0.10)",DASH_PURPLE="#8b5cf6",OVERVIEW_WIDGETS_UI_CFG_LS_KEY="kexo:overview_widgets_ui_config:v1",OVERVIEW_WIDGET_KEYS=["finishes","devices","browsers","abandoned","attribution","payment_methods"],OVERVIEW_WIDGET_TITLES={finishes:"Finishes",devices:"Devices",browsers:"Browsers",abandoned:"Abandoned Carts",attribution:"Attribution",payment_methods:"Payment Methods"},OVERVIEW_WIDGET_SUPPORTS={finishes:{revenue:!0,clicks:!0,ctr:!0},devices:{revenue:!0,clicks:!0,ctr:!0},browsers:{revenue:!0,clicks:!0,ctr:!0},abandoned:{revenue:!0,clicks:!0,ctr:!1},attribution:{revenue:!0,clicks:!0,ctr:!0},payment_methods:{revenue:!0,clicks:!0,ctr:!0}},dashWidgetsBound=!1,dashWidgetCache={},dashWidgetInFlight={},dashWidgetLastRenderSig={},DASH_WIDGET_CACHE_TTL_MS=12e4,dashWidgetsRefreshTimer=null,dashWidgetsPendingOpts=null,ovwUiCfgLocal=null,ovwSaveTimer=null,ovwSaveInFlight=null,ovwSaveQueuedCfg=null,ovwModalBackdrop=null;function fmtGbp(n){var v="number"==typeof n?n:Number(n);return isFinite(v)&&formatRevenue0(v)||"—"}function fmtNum(n){return null!=n?n.toLocaleString():"—"}function shortDate(ymd){var parts=ymd.split("-");return parseInt(parts[2],10)+" "+(["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][parseInt(parts[1],10)-1]||"")}function shortHourLabel(key){if(!key)return"";var s=String(key),idx=s.indexOf(" ");return idx>=0?s.slice(idx+1):s}function fastPayloadHash(input){for(var str=null==input?"":String(input),hash=5381,i=0;i<str.length;i++)hash=(hash<<5)+hash^str.charCodeAt(i);return String(hash>>>0)}function sanitizeChartConfig(labels,datasets){var srcLabels=Array.isArray(labels)?labels:[],normalized=(Array.isArray(datasets)?datasets:[]).map(function(ds){var next=Object.assign({},ds||{});return next.data=Array.isArray(next.data)?next.data.slice():[],next}),maxLen=srcLabels.length;normalized.forEach(function(ds){Array.isArray(ds.data)&&ds.data.length>maxLen&&(maxLen=ds.data.length)});for(var outLabels=srcLabels.slice(0,maxLen).map(function(lbl,idx){return(null==lbl?"":String(lbl).trim())||String(idx+1)});outLabels.length<maxLen;)outLabels.push(String(outLabels.length+1));var seen=Object.create(null);return outLabels=outLabels.map(function(lbl){var base=String(lbl||"").trim()||"—",key=base.toLowerCase();return seen[key]=(seen[key]||0)+1,seen[key]>1?base+" ("+String(seen[key])+")":base}),normalized.forEach(function(ds){for(Array.isArray(ds.data)||(ds.data=[]),ds.data.length>maxLen&&(ds.data=ds.data.slice(0,maxLen));ds.data.length<maxLen;)ds.data.push(0)}),{labels:outLabels,datasets:normalized}}function validateChartType(chartId,requestedMode,fallbackMode){var fallback=String(fallbackMode||"area").trim().toLowerCase()||"area",req=String(requestedMode||"").trim().toLowerCase();req||(req=fallback);try{if("function"==typeof window.kexoChartMeta){var meta=window.kexoChartMeta(chartId),allowed=meta&&Array.isArray(meta.modes)?meta.modes.map(function(m){return String(m).trim().toLowerCase()}):[];if(allowed.length&&allowed.indexOf(req)<0)return allowed.indexOf(fallback)>=0?fallback:meta&&meta.defaultMode?String(meta.defaultMode).trim().toLowerCase():allowed[0]}}catch(_){}return req}function formatOverviewBucketLabel(rawLabel,granularity){var key=null==rawLabel?"":String(rawLabel).trim(),g=String(granularity||"").trim().toLowerCase();return key?"hour"===g?key.indexOf(" ")>=0?shortHourLabel(key):key:"week"===g?/^\d{4}-\d{2}-\d{2}$/.test(key)?"Wk "+shortDate(key):key:/^\d{4}-\d{2}-\d{2}$/.test(key)?shortDate(key):key:""}function normalizeOverviewCardRangeKey(raw,fallback){var fb=(null==fallback?"":String(fallback)).trim().toLowerCase()||"7d",s=(null==raw?"":String(raw)).trim().toLowerCase();return s?("7days"===s&&(s="7d"),"14days"===s&&(s="14d"),"30days"===s&&(s="30d"),"today"===s||"yesterday"===s||"3d"===s||"7d"===s||"14d"===s||"30d"===s||"month"===s||/^r:\d{4}-\d{2}-\d{2}:\d{4}-\d{2}-\d{2}$/.test(s)||/^d:\d{4}-\d{2}-\d{2}$/.test(s)?s:fb):fb}function overviewCardRangeStorageKey(chartId){return"kexo:overview-card-range:v1:"+(null==chartId?"":String(chartId)).trim().toLowerCase()}function getOverviewCardRange(chartId,fallback){var fb=normalizeOverviewCardRangeKey(fallback,"7d"),raw="";try{raw=localStorage.getItem(overviewCardRangeStorageKey(chartId))||""}catch(_){raw=""}return normalizeOverviewCardRangeKey(raw,fb)}function setOverviewCardRange(chartId,rangeKey){var id=(null==chartId?"":String(chartId)).trim().toLowerCase();if(id){var rk=normalizeOverviewCardRangeKey(rangeKey,"7d");try{localStorage.setItem(overviewCardRangeStorageKey(id),String(rk))}catch(_){}}}function formatYmdDayMonth(ymd){var s=(null==ymd?"":String(ymd)).trim();if(!/^\d{4}-\d{2}-\d{2}$/.test(s))return s;var m=parseInt(s.slice(5,7),10),d=parseInt(s.slice(8,10),10);return Number.isFinite(m)&&Number.isFinite(d)?String(d)+"/"+String(m):s}function formatRangeKeyDayMonth(rangeKey){var rk=normalizeOverviewCardRangeKey(rangeKey,"");if(!rk)return"";if("today"===rk)return"Today";if("yesterday"===rk)return"Yesterday";if("3d"===rk)return"3 Days";if("7d"===rk)return"7 Days";if("14d"===rk)return"14 Days";if("30d"===rk)return"30 Days";if("month"===rk)return"This month";if(/^d:\d{4}-\d{2}-\d{2}$/.test(rk))return formatYmdDayMonth(rk.slice(2));var m=rk.match(/^r:(\d{4}-\d{2}-\d{2}):(\d{4}-\d{2}-\d{2})$/);if(m&&m[1]&&m[2]){var a=formatYmdDayMonth(m[1]),b=formatYmdDayMonth(m[2]);if(a&&b)return a+" – "+b}return"7 Days"}function overviewCardWrap(chartId){try{return document.querySelector('[data-kexo-chart-key="'+String(chartId||"")+'"]')}catch(_){return null}}function syncOverviewCardRangeUi(chartId){var rk=getOverviewCardRange(chartId,"7d"),wrap=overviewCardWrap(chartId);if(wrap){var btn=wrap.querySelector(".kexo-overview-range-input");btn&&(btn.textContent=formatRangeKeyDayMonth(rk))}try{var sub=document.querySelector('[data-overview-subtitle][data-chart-id="'+String(chartId||"")+'"]');sub&&(sub.textContent=function(rangeKey){var rk=normalizeOverviewCardRangeKey(rangeKey,"7d");if("7d"===rk)return"7 Day Revenue";if("14d"===rk)return"14 Day Revenue";if("30d"===rk)return"30 Day Revenue";if("month"===rk)return"This month Revenue";var label=formatRangeKeyDayMonth(rk);return label?label+" Revenue":"Revenue"}(rk))}catch(_){}}function syncAllOverviewCardRangeUi(){try{["dash-chart-finishes-30d","dash-chart-devices-30d","dash-chart-attribution-30d","dash-chart-overview-30d"].forEach(function(id){syncOverviewCardRangeUi(id)})}catch(_){}}function ymdInAdminTzFromMs(ms){var n=Number(ms);if(!Number.isFinite(n))return null;try{return new Intl.DateTimeFormat("en-CA",{timeZone:tz,year:"numeric",month:"2-digit",day:"2-digit"}).format(new Date(n))}catch(_){try{return new Intl.DateTimeFormat("en-CA",{year:"numeric",month:"2-digit",day:"2-digit"}).format(new Date(n))}catch(_){return null}}}function ensureDashboardCompareSeries(kpiObj){var compareRangeKey=function(kpiObj){var cmp=kpiObj&&kpiObj.compare&&kpiObj.compare.range?kpiObj.compare.range:null,startMs=cmp&&null!=cmp.start?Number(cmp.start):NaN,endMs=cmp&&null!=cmp.end?Number(cmp.end):NaN;if(!(Number.isFinite(startMs)&&Number.isFinite(endMs)&&endMs>startMs))return null;var startYmd=ymdInAdminTzFromMs(startMs),endYmd=ymdInAdminTzFromMs(Math.max(startMs,endMs-1));return startYmd&&endYmd?startYmd===endYmd?"d:"+startYmd:"r:"+startYmd+":"+endYmd:null}(kpiObj);if(!compareRangeKey)return Promise.resolve(null);var cmp=kpiObj&&kpiObj.compare&&kpiObj.compare.range?kpiObj.compare.range:null,endMs=cmp&&null!=cmp.end?Number(cmp.end):NaN,endMsRounded=Number.isFinite(endMs)?6e4*Math.floor(endMs/6e4):null,cacheKey=null!=endMsRounded?compareRangeKey+"|endMs:"+String(endMsRounded):compareRangeKey;if(dashCompareRangeKey===cacheKey&&Array.isArray(dashCompareSeriesCache)&&dashCompareSeriesCache.length>=2&&dashCompareFetchedAt&&Date.now()-dashCompareFetchedAt<12e4)return Promise.resolve(dashCompareSeriesCache);if(dashCompareSeriesInFlight&&dashCompareRangeKey===cacheKey)return dashCompareSeriesInFlight;dashCompareRangeKey=cacheKey;var url="/api/dashboard-series?range="+encodeURIComponent(compareRangeKey)+("function"==typeof window.kexoGetTrafficQuerySuffix?window.kexoGetTrafficQuerySuffix():"");return null!=endMsRounded&&(url+="&endMs="+encodeURIComponent(String(endMsRounded))),dashCompareSeriesInFlight=fetchWithTimeout(url,{credentials:"same-origin",cache:"default"},2e4).then(function(r){return r&&r.ok?r.json():null}).then(function(data){var s=data&&Array.isArray(data.series)?data.series:null;return s&&s.length>=2?(dashCompareSeriesCache=s,dashCompareFetchedAt=Date.now(),s):null}).catch(function(){return null}).finally(function(){dashCompareSeriesInFlight=null})}function waitForApexCharts(cb,retries){if("undefined"==typeof ApexCharts)if(retries||(retries=0),retries>=15){
// This bundle is loaded on non-dashboard pages too (e.g. Settings). Only capture this
// when the dashboard is actually present to avoid noise.
var shouldCapture=!1;try{shouldCapture=!!(void 0!==PAGE&&"dashboard"===PAGE||"undefined"!=typeof document&&document&&(document.getElementById("tab-panel-dashboard")||document.getElementById("dash-chart-overview-30d")))}catch(_){shouldCapture=!1}shouldCapture&&captureChartMessage("ApexCharts failed to load after retries","dashboardApexLoad",{retries:retries},"error")}else setTimeout(function(){waitForApexCharts(cb,retries+1)},200);else cb()}var dashChartConfigs={};function buildPinAnnotationsForCategories(categoryLabels,pins){var labels=Array.isArray(categoryLabels)?categoryLabels:[],list=Array.isArray(pins)?pins:[];if(!labels.length||!list.length)return{annotations:[],tooltips:[]};for(var idx=new Map,i=0;i<labels.length;i++){var key=null!=labels[i]?String(labels[i]):"";key&&(idx.has(key)||idx.set(key,i))}for(var byLabel=new Map,j=0;j<list.length;j++){var p=list[j]||{},ymd=p.event_ymd?String(p.event_ymd):"";if(ymd){var cands=[ymd];try{cands.push(shortDate(ymd))}catch(_){}for(var matchedLabel=null,k=0;k<cands.length;k++){var c=cands[k];if(c&&idx.has(c)){matchedLabel=c;break}}matchedLabel&&(byLabel.has(matchedLabel)||byLabel.set(matchedLabel,[]),byLabel.get(matchedLabel).push(p))}}var out=[],tooltips=[];return byLabel.forEach(function(pinsInBucket,matchedLabel){var label,titles=pinsInBucket.map(function(p){return p.title&&String(p.title).trim()||"Pin"}),tooltipText=titles.map(function(t){return"Pin added: "+t}).join("\n"),slug=(label=matchedLabel,String(null==label?"":label).trim().toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-|-$/g,"")||"p");out.push({x:matchedLabel,borderColor:"transparent",strokeDashArray:0,label:{text:"📌",borderColor:"transparent",style:{background:"transparent",color:"var(--tblr-body-color, #0f172a)",fontSize:"12px",fontWeight:400,cssClass:"kexo-pin-annotation kexo-pin-annotation--"+slug},offsetY:-4}}),tooltips.push(tooltipText)}),{annotations:out,tooltips:tooltips}}function setPinAnnotationTooltips(chart,tooltips){if(chart&&chart.el&&Array.isArray(tooltips)&&tooltips.length)try{for(var nodes=chart.el.querySelectorAll?chart.el.querySelectorAll(".kexo-pin-annotation"):[],i=0;i<nodes.length&&i<tooltips.length;i++)nodes[i]&&tooltips[i]&&nodes[i].setAttribute("title",tooltips[i])}catch(_){}}function upsertDashboardApexChart(chartId,chartEl,apexOpts,afterRender){if(!chartEl||!apexOpts||"undefined"==typeof ApexCharts)return null;var existing=dashCharts&&dashCharts[chartId]?dashCharts[chartId]:null,series=Array.isArray(apexOpts.series)?apexOpts.series:[];if(existing&&"function"==typeof existing.updateOptions&&"function"==typeof existing.updateSeries)try{var optsNoSeries=Object.assign({},apexOpts);return delete optsNoSeries.series,existing.updateOptions(optsNoSeries,!1,!0,!1),existing.updateSeries(series,!1),"function"==typeof afterRender&&setTimeout(function(){try{afterRender(existing)}catch(_){}},0),existing}catch(updateErr){try{existing.destroy()}catch(_){}try{delete dashCharts[chartId]}catch(_){}captureChartError(updateErr,"dashboardChartUpdate",{chartId:chartId})}chartEl.innerHTML="";var chart=new ApexCharts(chartEl,apexOpts);dashCharts[chartId]=chart;var rendered=null;try{rendered=chart.render()}catch(_){rendered=null}return rendered&&"function"==typeof rendered.then?rendered.then(function(){"function"==typeof afterRender&&afterRender(chart)}).catch(function(){}):"function"==typeof afterRender&&setTimeout(function(){afterRender(chart)},0),chart}function makeChart(chartId,labels,datasets,opts){if("undefined"==typeof ApexCharts)return waitForApexCharts(function(){makeChart(chartId,labels,datasets,opts)}),null;if(!chartId)return null;var el=document.getElementById(chartId);if(!el)return console.warn("[dashboard] chart element not found:",chartId),null;var chartScope=opts&&opts.chartScope?String(opts.chartScope):"dashboard-"+chartId,defaultType=opts&&opts.chartType||"area",requestedMode=chartModeFromUiConfig(chartId,defaultType)||defaultType,showEndLabels="multi-line-labels"===(requestedMode=validateChartType(chartId,requestedMode,defaultType)),stacked="stacked-area"===requestedMode||"stacked-bar"===requestedMode,chartType="multi-line-labels"===requestedMode?"line":"stacked-area"===requestedMode?"area":"stacked-bar"===requestedMode?"bar":"combo"===requestedMode?"area":requestedMode;if(chartType=normalizeChartType(chartType,normalizeChartType(defaultType,"area")),!isChartEnabledByUiConfig(chartId,!0)){try{dashCharts[chartId]&&dashCharts[chartId].destroy()}catch(_){}return dashCharts[chartId]=null,el.innerHTML="",null}var normalized=sanitizeChartConfig(labels,datasets);labels=normalized.labels,datasets=normalized.datasets;try{var uiColors=chartColorsFromUiConfig(chartId,[]);
// Overview chart supports separate "Profit (negative)" color (uiColors[3]).
if(uiColors&&uiColors.length&&Array.isArray(datasets)&&(datasets=datasets.map(function(ds,idx){if(!ds||"object"!=typeof ds)return ds;var next=Object.assign({},ds),c=uiColors[idx];return c&&(
// Keep profit series sign-aware when the UI config doesn't include a dedicated negative colour.
"dash-chart-overview-30d"===String(chartId||"")&&2===idx&&uiColors.length<4||(next.borderColor=c)),next})),"dash-chart-overview-30d"===String(chartId||"")&&uiColors&&uiColors.length>=4&&Array.isArray(datasets)&&datasets.length>=3){for(var profitDs=datasets[2],profitData=profitDs&&Array.isArray(profitDs.data)?profitDs.data:[],hasPos=!1,hasNeg=!1,latest=null,i=0;i<profitData.length;i++){var n=Number(profitData[i]);Number.isFinite(n)&&(latest=n,n>0&&(hasPos=!0),n<0&&(hasNeg=!0))}var profitColor=!!Number.isFinite(latest)&&(latest<0||!hasPos&&hasNeg)?uiColors[3]:uiColors[2];datasets=datasets.map(function(ds,idx){if(!ds||"object"!=typeof ds)return ds;if(2!==idx)return ds;var next=Object.assign({},ds);profitColor&&(next.borderColor=profitColor);var bg=profitColor?function(hex,a){var h=(null==hex?"":String(hex)).trim().replace(/^#/,"");if(6!==h.length)return null;var r=parseInt(h.slice(0,2),16),g=parseInt(h.slice(2,4),16),b=parseInt(h.slice(4,6),16),alpha="number"==typeof a&&isFinite(a)?Math.max(0,Math.min(1,a)):.14;return isFinite(r)&&isFinite(g)&&isFinite(b)?"rgba("+r+","+g+","+b+","+alpha+")":null}(profitColor,.14):null;return bg&&(next.backgroundColor=bg),next})}}catch(_){}dashChartConfigs[chartId]={labels:labels,datasets:datasets,opts:Object.assign({},opts||{},{chartType:chartType,chartScope:chartScope})};var uiStyle=chartStyleFromUiConfig(chartId),fillOpacityVal=(opts&&opts.horizontal,uiStyle&&Number.isFinite(Number(uiStyle.fillOpacity))?Math.max(0,Math.min(1,Number(uiStyle.fillOpacity))):null),areaOpacityFrom=opts&&"number"==typeof opts.areaOpacityFrom&&isFinite(opts.areaOpacityFrom)?opts.areaOpacityFrom:.15,areaOpacityTo=opts&&"number"==typeof opts.areaOpacityTo&&isFinite(opts.areaOpacityTo)?opts.areaOpacityTo:.02,chartHeight=opts&&Number.isFinite(Number(opts.height))?Number(opts.height):200;(!Number.isFinite(chartHeight)||chartHeight<80)&&(chartHeight=200);try{var pct=chartSizePercentFromUiConfig(chartId,100);Number.isFinite(pct)&&pct>0&&100!==pct&&(chartHeight=Math.round(chartHeight*(pct/100)))<80&&(chartHeight=80)}catch(_){}try{Array.isArray(labels)&&1===labels.length&&(labels=[labels[0],labels[0]]),Array.isArray(datasets)&&datasets.forEach(function(ds){ds&&Array.isArray(ds.data)&&1===ds.data.length&&(ds.data=[ds.data[0],ds.data[0]])})}catch(_){}try{var apexSeries=datasets.map(function(ds){var safeData=Array.isArray(ds&&ds.data)?ds.data.map(function(v){var n="number"==typeof v?v:Number(v);return isFinite(n)?n:0}):[];return{name:ds.label,data:safeData}}),colors=datasets.map(function(ds){return ds.borderColor||DASH_ACCENT}),yMaxOverride=null,yMinOverride=0;try{var maxV=null,minV=null;apexSeries.forEach(function(s){(s.data||[]).forEach(function(v){var n="number"==typeof v?v:Number(v);isFinite(n)&&((null==maxV||n>maxV)&&(maxV=n),(null==minV||n<minV)&&(minV=n))})}),null==maxV&&(maxV=0),yMaxOverride=maxV<=0?1:maxV+Math.max(1e-6,.12*Math.abs(maxV)),null!=minV&&minV<0&&(yMinOverride=minV-Math.max(1e-6,.12*Math.abs(minV)))}catch(_){}var yFmt=opts&&opts.pct?function(v){return null!=v?Number(v).toFixed(1)+"%":"—"}:opts&&opts.currency?function(v){if(null==v)return"—";var n=Number(v);return isFinite(n)&&formatRevenue0(n)||"—"}:function(v){return null!=v?Number(v).toLocaleString():"—"},legendPos=opts&&null!=opts.legendPosition?String(opts.legendPosition).trim().toLowerCase():"top";"top"!==legendPos&&"bottom"!==legendPos&&"left"!==legendPos&&"right"!==legendPos&&(legendPos="top");var showLegend=opts&&"boolean"==typeof opts.showLegend?!!opts.showLegend:apexSeries.length>1,customTooltip=opts&&"function"==typeof opts.tooltipCustom?opts.tooltipCustom:null,tooltipShared=opts&&"boolean"==typeof opts.tooltipShared?!!opts.tooltipShared:apexSeries.length>1,tooltipConfig={enabled:!0,
// For dense charts (especially the Overview Revenue/Cost/Profit), avoid requiring a direct point intersect.
intersect:!(!opts||"boolean"!=typeof opts.tooltipIntersect)&&!!opts.tooltipIntersect,shared:tooltipShared,followCursor:!(!opts||"boolean"!=typeof opts.tooltipFollowCursor)&&!!opts.tooltipFollowCursor,y:{formatter:yFmt}};customTooltip&&(tooltipConfig.custom=customTooltip);var baseOpacity=null!=fillOpacityVal?fillOpacityVal:1,fillConfig="line"===chartType||"bar"===chartType?{type:"solid",opacity:baseOpacity}:{type:"gradient",gradient:{shadeIntensity:1,opacityFrom:null!=fillOpacityVal?fillOpacityVal*areaOpacityFrom:areaOpacityFrom,opacityTo:null!=fillOpacityVal?fillOpacityVal*areaOpacityTo:areaOpacityTo,stops:[0,100]}},animationsEnabled=!(!uiStyle||!0!==uiStyle.animations),markerSize=opts&&Number.isFinite(Number(opts.markerSize))?Math.max(0,Number(opts.markerSize)):"line"===chartType?3:0,dataLabelsMode=uiStyle&&null!=uiStyle.dataLabels?String(uiStyle.dataLabels).trim().toLowerCase():"",uiStrokeWidth=uiStyle&&Number.isFinite(Number(uiStyle.strokeWidth))?Number(uiStyle.strokeWidth):null,uiBarColumnWidth=uiStyle&&Number.isFinite(Number(uiStyle.barColumnWidth))?Number(uiStyle.barColumnWidth):null,uiGridDash=uiStyle&&Number.isFinite(Number(uiStyle.gridDash))?Number(uiStyle.gridDash):null;null!=uiStrokeWidth&&(uiStrokeWidth=Math.max(.5,Math.min(6,uiStrokeWidth))),null!=uiBarColumnWidth&&(uiBarColumnWidth=Math.max(20,Math.min(95,uiBarColumnWidth))),null!=uiGridDash&&(uiGridDash=Math.max(0,Math.min(8,Math.round(uiGridDash))));var strokeWidth="bar"===chartType?0:null!=uiStrokeWidth?uiStrokeWidth:2,barColWidth=null!=uiBarColumnWidth?String(uiBarColumnWidth)+"%":stacked?"80%":"60%",gridDashVal=null!=uiGridDash?uiGridDash:3,gridShow=gridDashVal>0,apexOpts={chart:{type:chartType,height:chartHeight,fontFamily:"Inter, sans-serif",toolbar:{show:!1},animations:{enabled:animationsEnabled,easing:"easeinout",speed:300},zoom:{enabled:!1}},series:apexSeries,colors:colors,stroke:{show:!0,width:strokeWidth,curve:"smooth",lineCap:"round"},fill:fillConfig,plotOptions:"bar"===chartType?{bar:{columnWidth:barColWidth,borderRadius:3,stacked:stacked}}:"area"===chartType&&stacked?{area:{stacked:!0}}:{},xaxis:function(){var xaxisConfig={categories:labels||[],labels:{style:{fontSize:"10px",cssClass:"apexcharts-xaxis-label"},rotate:0,hideOverlappingLabels:!0},axisBorder:{show:!1},axisTicks:{show:!1}};if("dash-chart-overview-30d"===String(chartId||"")&&"undefined"!=typeof window&&window.matchMedia&&window.matchMedia("(max-width: 767px)").matches){var labelCount=Array.isArray(labels)?labels.length:0;if(labelCount>10){var step=Math.ceil(labelCount/8);xaxisConfig.labels.formatter=function(value,timestamp,opts){try{var idx=opts&&null!=opts.dataPointIndex?Number(opts.dataPointIndex):-1;return idx<0||idx>=labelCount||(idx===labelCount-1||idx%step===0)?value:""}catch(_){return value}}}}return xaxisConfig}(),yaxis:{labels:{style:{fontSize:"11px",cssClass:"apexcharts-yaxis-label"},formatter:yFmt},min:yMinOverride,max:yMaxOverride,forceNiceScale:!0},grid:{show:gridShow,borderColor:"#f0f0f0",strokeDashArray:gridShow?gridDashVal:0},tooltip:tooltipConfig,legend:{show:!!showLegend&&apexSeries.length>1,position:legendPos,fontSize:"11px"},dataLabels:showEndLabels&&"line"===chartType?{enabled:!0,formatter:function(val,ctx){try{var dp=ctx&&null!=ctx.dataPointIndex?Number(ctx.dataPointIndex):-1,w=ctx&&ctx.w?ctx.w:null;if(dp!==(w&&w.globals&&Array.isArray(w.globals.labels)?w.globals.labels.length-1:-1))return""}catch(_){return""}try{return yFmt(val)}catch(_){return String(val)}},style:{fontSize:"10px"},background:{enabled:!0,borderRadius:4,padding:3,opacity:.85},offsetY:-3}:"on"===dataLabelsMode?{enabled:!0,formatter:function(val){try{return yFmt(val)}catch(_){return String(val)}},style:{fontSize:"10px"},background:{enabled:!0,borderRadius:4,padding:3,opacity:.78}}:{enabled:!1},markers:{size:markerSize,hover:{size:5}},noData:{text:"No data available",style:{fontSize:"13px",color:"#626976"}}};try{el&&el.setAttribute&&el.setAttribute("data-kexo-grid",gridShow?"show":"hide")}catch(_){}stacked&&(apexOpts.chart.stacked=!0,apexOpts.chart.stackType="normal");try{var chartOverride=chartAdvancedOverrideFromUiConfig(chartId,chartType);chartOverride&&isPlainObject(chartOverride)&&Object.keys(chartOverride).length&&(apexOpts=deepMergeOptions(apexOpts,chartOverride))}catch(_){}return opts&&!0===opts.forceTooltip&&(apexOpts.tooltip=Object.assign({},apexOpts.tooltip||{},{enabled:!0,shared:!0,intersect:!1,followCursor:!0})),upsertDashboardApexChart(chartId,el,apexOpts,function(chart){try{!function(chartId,chart,categoryLabels){if(chart&&categoryLabels&&categoryLabels.length&&"undefined"!=typeof window){var cached=null;try{cached="function"==typeof window.__kexoReadChangePinsRecentCache?window.__kexoReadChangePinsRecentCache():null}catch(_){}var result=buildPinAnnotationsForCategories(categoryLabels,cached),ann=result&&result.annotations,tooltips=result&&result.tooltips?result.tooltips:[];if(ann&&ann.length)try{if(dashCharts&&dashCharts[chartId]!==chart)return;chart.updateOptions({annotations:{xaxis:ann,yaxis:[],points:[],texts:[],images:[]}},!1,!0),setTimeout(function(){setPinAnnotationTooltips(chart,tooltips)},80)}catch(_){}else try{if("function"!=typeof window.__kexoGetChangePinsRecent)return;window.__kexoGetChangePinsRecent(120,!1).then(function(pins){if(pins){var nextResult=buildPinAnnotationsForCategories(categoryLabels,pins),nextAnn=nextResult&&nextResult.annotations,nextTooltips=nextResult&&nextResult.tooltips?nextResult.tooltips:[];if(nextAnn&&nextAnn.length)try{if(dashCharts&&dashCharts[chartId]!==chart)return;chart.updateOptions({annotations:{xaxis:nextAnn,yaxis:[],points:[],texts:[],images:[]}},!1,!0),setTimeout(function(){setPinAnnotationTooltips(chart,nextTooltips)},80)}catch(_){}}})}catch(_){}}}(chartId,chart,labels||[])}catch(_){}})}catch(err){return captureChartError(err,"dashboardChartRender",{chartId:chartId}),null}}function destroyDashChart(chartId){try{dashCharts&&dashCharts[chartId]&&"function"==typeof dashCharts[chartId].destroy&&dashCharts[chartId].destroy()}catch(_){}try{delete dashCharts[chartId]}catch(_){}}function normalizeOverviewMetric(v){var n="number"==typeof v?v:Number(v);return Number.isFinite(n)?n:0}var OVERVIEW_HEADER_GAP_PX=8,OVERVIEW_HEADER_FALLBACK_PX=52,OVERVIEW_MINI_FOOTER_FALLBACK_PX=32,OVERVIEW_MINI_EXTRA_BUFFER_PX=10;function resolveOverviewChartHeight(chartEl,fallback,min,max){var fb=Number(fallback);(!Number.isFinite(fb)||fb<=0)&&(fb=220);var lo=Number(min);(!Number.isFinite(lo)||lo<=0)&&(lo=120);var hi=Number(max);(!Number.isFinite(hi)||hi<=0)&&(hi=720);var h=0;try{if(chartEl){var ch=chartEl.clientHeight;Number.isFinite(ch)&&ch>0&&(h=ch);var rect=chartEl.getBoundingClientRect?chartEl.getBoundingClientRect():null;if(rect&&Number.isFinite(rect.height)&&rect.height>0&&(h=rect.height),chartEl.parentElement){var parent=chartEl.parentElement,ph=parent.clientHeight;Number.isFinite(ph)&&ph>0&&(h=ph);var pRect=parent.getBoundingClientRect?parent.getBoundingClientRect():null;pRect&&Number.isFinite(pRect.height)&&pRect.height>0&&(h=pRect.height);var card=parent.closest?parent.closest(".kexo-overview-mini-card, .kexo-overview-main-card"):null;if(card&&card.getBoundingClientRect){var cardH=card.getBoundingClientRect().height,isMini=!1;try{isMini=!(!card.classList||!card.classList.contains("kexo-overview-mini-card"))}catch(_){isMini=!1}var headEl=card.querySelector?card.querySelector(".kexo-overview-card-head"):null,headerPx=OVERVIEW_HEADER_FALLBACK_PX;if(headEl&&headEl.getBoundingClientRect){var headRect=headEl.getBoundingClientRect();Number.isFinite(headRect.height)&&headRect.height>0&&(headerPx=headRect.height+OVERVIEW_HEADER_GAP_PX)}var totalsEl=card.querySelector?card.querySelector(".kexo-overview-running-totals"):null;if(totalsEl&&totalsEl.getBoundingClientRect&&!(headEl&&headEl.contains&&headEl.contains(totalsEl))){var totalsRect=totalsEl.getBoundingClientRect();Number.isFinite(totalsRect.height)&&totalsRect.height>0&&(headerPx+=totalsRect.height+OVERVIEW_HEADER_GAP_PX)}if(isMini){try{var lid=chartEl&&chartEl.id?String(chartEl.id):"",footerPx=0,legendEl=lid&&card.querySelector?card.querySelector('[data-overview-legend="'+lid+'"]'):null;if(legendEl&&legendEl.getBoundingClientRect){var legendRect=legendEl.getBoundingClientRect();legendRect&&Number.isFinite(legendRect.height)&&legendRect.height>0?footerPx+=legendRect.height+OVERVIEW_HEADER_GAP_PX:footerPx+=OVERVIEW_MINI_FOOTER_FALLBACK_PX}else legendEl&&(footerPx+=OVERVIEW_MINI_FOOTER_FALLBACK_PX);var iconRowEl=card.querySelector?card.querySelector(".dash-attribution-icon-row"):null;if(iconRowEl&&iconRowEl.getBoundingClientRect){var iconRect=iconRowEl.getBoundingClientRect();iconRect&&Number.isFinite(iconRect.height)&&iconRect.height>0&&(footerPx+=iconRect.height+OVERVIEW_HEADER_GAP_PX)}footerPx>0&&(headerPx+=footerPx)}catch(_){}headerPx+=OVERVIEW_MINI_EXTRA_BUFFER_PX}var minBuffer=Math.max(OVERVIEW_HEADER_FALLBACK_PX,headerPx);if(Number.isFinite(cardH)&&cardH>minBuffer){var avail=cardH-headerPx;avail>lo&&(h=avail)}}}}}catch(_){}return(!Number.isFinite(h)||h<=0)&&(h=fb),h=Math.max(lo,Math.min(hi,h)),Math.round(h)}function scaleHeightForChartSizePercent(chartId,height,min,max){var h=Number(height);if(!Number.isFinite(h)||h<=0)return height;try{var pct=chartSizePercentFromUiConfig(chartId,100);Number.isFinite(pct)&&pct>0&&100!==pct&&(h=Math.round(h*(pct/100)))}catch(_){}return Number.isFinite(min)&&h<min&&(h=min),Number.isFinite(max)&&h>max&&(h=max),Math.round(h)}function clearOverviewHeightSyncStyles(){try{document.querySelectorAll(".kexo-overview-mini-row .kexo-overview-mini-card").forEach(function(card){card&&card.style&&(card.style.height="",card.style.minHeight="",card.style.maxHeight="")})}catch(_){}try{var mainCard=document.querySelector('[data-kexo-chart-key="dash-chart-overview-30d"] .kexo-overview-main-card');mainCard&&mainCard.style&&(mainCard.style.height="",mainCard.style.minHeight="")}catch(_){}}function syncOverviewHeightGrid(){var topGrid=document.getElementById("dash-kpi-grid"),midGrid=document.getElementById("dash-kpi-grid-mid");if(topGrid){var desktop=!1;try{desktop=!!(window&&window.matchMedia&&window.matchMedia("(min-width: 1200px)").matches)}catch(_){desktop=!1}if(desktop){var topHeight=0;try{var topRect=topGrid.getBoundingClientRect?topGrid.getBoundingClientRect():null;topRect&&Number.isFinite(topRect.height)&&topRect.height>0&&(topHeight=Math.max(0,Math.round(topRect.height)-16))}catch(_){}var midHeight=0;try{if(midGrid&&midGrid.getBoundingClientRect){var midRect=midGrid.getBoundingClientRect();midRect&&Number.isFinite(midRect.height)&&midRect.height>0&&(midHeight=Math.max(0,Math.round(midRect.height)-16))}}catch(_){}var miniHeight=midHeight>0?midHeight:topHeight;if(miniHeight>0)try{document.querySelectorAll(".kexo-overview-mini-row .kexo-overview-mini-card").forEach(function(card){card&&card.style&&(card.style.height=String(miniHeight)+"px",card.style.minHeight=String(miniHeight)+"px",card.style.maxHeight=String(miniHeight)+"px")})}catch(_){}var mainHeight=topHeight>0?topHeight:midHeight;if(mainHeight>0)try{var mainCard=document.querySelector('[data-kexo-chart-key="dash-chart-overview-30d"] .kexo-overview-main-card');mainCard&&mainCard.style&&(mainCard.style.height=String(mainHeight)+"px",mainCard.style.minHeight=String(mainHeight)+"px")}catch(_){}if(mainHeight>0||miniHeight>0)try{["dash-chart-finishes-30d","dash-chart-devices-30d","dash-chart-attribution-30d","dash-chart-overview-30d"].forEach(function(chartId){var chart=dashCharts&&dashCharts[chartId];if(chart&&"function"==typeof chart.updateOptions){var chartEl=document.getElementById(chartId);if(chartEl){var h=resolveOverviewChartHeight(chartEl,180,120,440);(h=scaleHeightForChartSizePercent(chartId,h,120,440))>0&&chart.updateOptions({chart:{height:h}},!1,!1,!1)}}})}catch(_){}}else clearOverviewHeightSyncStyles()}}function scheduleOverviewHeightSync(){if(overviewHeightSyncTimer)try{clearTimeout(overviewHeightSyncTimer)}catch(_){}overviewHeightSyncTimer=setTimeout(function(){overviewHeightSyncTimer=null,("function"==typeof requestAnimationFrame?requestAnimationFrame:function(f){f()})(function(){syncOverviewHeightGrid()})},80)}function ensureOverviewHeightSyncObserver(){if(!overviewHeightSyncObserver&&"undefined"!=typeof ResizeObserver){overviewHeightSyncObserver=new ResizeObserver(function(){"hidden"!==document.visibilityState&&scheduleOverviewHeightSync()});try{var topGrid=document.getElementById("dash-kpi-grid"),midGrid=document.getElementById("dash-kpi-grid-mid");overviewHeightSyncObservedElements=[],topGrid&&(overviewHeightSyncObserver.observe(topGrid),overviewHeightSyncObservedElements.push(topGrid)),midGrid&&(overviewHeightSyncObserver.observe(midGrid),overviewHeightSyncObservedElements.push(midGrid))}catch(_){}try{overviewHeightSyncResizeBound||(overviewHeightSyncResizeBound=!0,window.addEventListener("resize",scheduleOverviewHeightSync,{passive:!0}))}catch(_){}}}function pauseOverviewResizeObservers(){try{overviewHeightSyncObserver&&"function"==typeof overviewHeightSyncObserver.disconnect&&overviewHeightSyncObserver.disconnect(),overviewMiniResizeObserver&&"function"==typeof overviewMiniResizeObserver.disconnect&&overviewMiniResizeObserver.disconnect()}catch(_){}try{overviewHeightSyncResizeBound&&(overviewHeightSyncResizeBound=!1,window.removeEventListener("resize",scheduleOverviewHeightSync))}catch(_){}}function resumeOverviewResizeObservers(){try{overviewHeightSyncObserver&&overviewHeightSyncObservedElements.length&&overviewHeightSyncObservedElements.forEach(function(el){el&&el.isConnected&&overviewHeightSyncObserver.observe(el)}),overviewMiniResizeObserver&&overviewMiniResizeObservedElements.length&&overviewMiniResizeObservedElements.forEach(function(el){el&&el.isConnected&&overviewMiniResizeObserver.observe(el)})}catch(_){}try{overviewHeightSyncObserver&&!overviewHeightSyncResizeBound&&(overviewHeightSyncResizeBound=!0,window.addEventListener("resize",scheduleOverviewHeightSync,{passive:!0}))}catch(_){}}function renderOverviewChartEmpty(chartId,text){var chartEl=document.getElementById(chartId);if(chartEl){if(!isChartEnabledByUiConfig(chartId))return destroyDashChart(chartId),chartEl.innerHTML="",void("dash-chart-overview-30d"===String(chartId||"")&&(setOverviewSalesRunningTotals(null,null,null),setOverviewCostBreakdownTooltip(null)));destroyDashChart(chartId),chartEl.innerHTML='<div class="kexo-overview-chart-empty">'+escapeHtml(text||"No data available")+"</div>","dash-chart-overview-30d"===String(chartId||"")&&(setOverviewSalesRunningTotals(null,null,null),setOverviewCostBreakdownTooltip(null))}}function renderOverviewChartLoading(chartId,text){var chartEl=document.getElementById(chartId);if(chartEl){if(!isChartEnabledByUiConfig(chartId))return destroyDashChart(chartId),chartEl.innerHTML="",void("dash-chart-overview-30d"===String(chartId||"")&&(setOverviewSalesRunningTotals(null,null,null),setOverviewCostBreakdownTooltip(null)));destroyDashChart(chartId),chartEl.innerHTML='<div class="kexo-overview-chart-empty is-loading"><span class="kpi-mini-spinner" aria-hidden="true"></span><span>'+escapeHtml(text||"Loading...")+"</span></div>","dash-chart-overview-30d"===String(chartId||"")&&(setOverviewSalesRunningTotals(null,null,null),setOverviewCostBreakdownTooltip(null))}}function countryCodeToFlagEmoji(rawCode){var code=null==rawCode?"":String(rawCode).trim().toUpperCase();if("UK"===code&&(code="GB"),!/^[A-Z]{2}$/.test(code))return"";var A=127462;return String.fromCodePoint(A+(code.charCodeAt(0)-65),A+(code.charCodeAt(1)-65))}function countryCodeToFlagHtml(rawCode){var code=null==rawCode?"":String(rawCode).trim().toUpperCase().slice(0,2);return"UK"===code&&(code="GB"),/^[A-Z]{2}$/.test(code)?'<span class="flag flag-xs kexo-flag-inline flag-country-'+escapeHtml(code.toLowerCase())+'" aria-hidden="true"></span>':'<span class="kexo-flag-fallback" aria-hidden="true"><i class="fa-light fa-globe"></i></span>'}function renderOverviewPieChart(chartId,labels,values,opts){var chartEl=document.getElementById(chartId);if(chartEl&&"undefined"!=typeof ApexCharts){if(!isChartEnabledByUiConfig(chartId))return destroyDashChart(chartId),void(chartEl.innerHTML="");for(var safeLabels=[],safeValues=[],srcLabels=Array.isArray(labels)?labels:[],srcValues=Array.isArray(values)?values:[],i=0;i<srcLabels.length;i++){var label=null!=srcLabels[i]?String(srcLabels[i]).trim():"",n=normalizeOverviewMetric(srcValues[i]);!label||n<=0||(safeLabels.push(label),safeValues.push(n))}if(safeLabels=sanitizeChartConfig(safeLabels,[{label:"Value",data:safeValues}]).labels,safeValues.length){var uiStyle=chartStyleFromUiConfig(chartId);uiStyle&&"object"==typeof uiStyle||(uiStyle={});var colors=chartColorsFromUiConfig(chartId,opts&&Array.isArray(opts.colors)&&opts.colors.length?opts.colors:[DASH_ACCENT,DASH_BLUE,DASH_ORANGE,DASH_PURPLE,"#ef4444"]),valueFormatter=opts&&"function"==typeof opts.valueFormatter?opts.valueFormatter:function(v){return fmtGbp(normalizeOverviewMetric(v))||"—"},chartType=(opts&&"boolean"==typeof opts.donut?!!opts.donut:!!uiStyle.pieDonut)?"donut":"pie",pieLabelPosition=opts&&null!=opts.pieLabelPosition?String(opts.pieLabelPosition).trim().toLowerCase():String(uiStyle.pieLabelPosition||"auto").trim().toLowerCase();"outside"!==pieLabelPosition&&"inside"!==pieLabelPosition&&"auto"!==pieLabelPosition&&(pieLabelPosition="auto");var pieLabelContent=opts&&null!=opts.pieLabelContent?String(opts.pieLabelContent).trim().toLowerCase():String(uiStyle.pieLabelContent||"percent").trim().toLowerCase();"label"!==pieLabelContent&&"label_percent"!==pieLabelContent&&"percent"!==pieLabelContent&&(pieLabelContent="percent");var pieLabelOffset=Number(opts&&null!=opts.pieLabelOffset?opts.pieLabelOffset:uiStyle.pieLabelOffset);Number.isFinite(pieLabelOffset)||(pieLabelOffset=16),pieLabelOffset=Math.round(Math.max(-40,Math.min(40,pieLabelOffset))),"outside"===pieLabelPosition&&(pieLabelOffset=Math.max(6,pieLabelOffset)),"inside"===pieLabelPosition&&(pieLabelOffset=Math.min(0,pieLabelOffset));var pieStartAngle=Number(opts&&null!=opts.pieStartAngle?opts.pieStartAngle:NaN),pieEndAngle=Number(opts&&null!=opts.pieEndAngle?opts.pieEndAngle:NaN),showLegend=opts&&"boolean"==typeof opts.showLegend?!!opts.showLegend:"outside"!==pieLabelPosition,labelFormatter=opts&&"function"==typeof opts.labelFormatter?opts.labelFormatter:null,countryCodesForPie=opts&&Array.isArray(opts.countryCodes)&&opts.countryCodes.length===safeLabels.length?opts.countryCodes:null,dataLabelsEnabled=(!opts||!1!==opts.dataLabels)&&"off"!==uiStyle.dataLabels,chartHeight=resolveOverviewChartHeight(chartEl,opts&&Number.isFinite(Number(opts.height))?Number(opts.height):180,120,440);try{var pct=chartSizePercentFromUiConfig(chartId,100);Number.isFinite(pct)&&pct>0&&100!==pct&&((chartHeight=Math.round(chartHeight*(pct/100)))<120&&(chartHeight=120),chartHeight>440&&(chartHeight=440))}catch(_){}var apexOpts={chart:{type:chartType,height:chartHeight,fontFamily:"Inter, sans-serif",toolbar:{show:!(!uiStyle||!0!==uiStyle.toolbar)},animations:{enabled:!0===uiStyle.animations,easing:"easeinout",speed:280},zoom:{enabled:!1}},series:safeValues,labels:safeLabels,colors:colors,legend:{show:showLegend,position:"bottom",fontSize:"11px"},fill:{opacity:uiStyle&&Number.isFinite(Number(uiStyle.fillOpacity))?Math.max(0,Math.min(1,Number(uiStyle.fillOpacity))):1},stroke:{show:!0,width:1,colors:["#fff"]},dataLabels:{enabled:dataLabelsEnabled,formatter:function(val,ctx){var pct=normalizeOverviewMetric(val),idx=ctx&&Number.isFinite(ctx.seriesIndex)?ctx.seriesIndex:-1,seriesLabel=idx>=0&&idx<safeLabels.length?safeLabels[idx]:"";if(countryCodesForPie&&idx>=0&&idx<countryCodesForPie.length){var flag=countryCodeToFlagEmoji(countryCodesForPie[idx]),pctText=pct?pct.toFixed(0)+"%":"";return"label"===pieLabelContent?flag||seriesLabel||pctText:"label_percent"===pieLabelContent?(flag?flag+" ":"")+(pctText||seriesLabel):(flag?flag+" ":"")+pctText}if(labelFormatter){var custom=labelFormatter(pct,seriesLabel,idx,safeValues[idx]);if(null!=custom)return String(custom)}pctText=pct?pct.toFixed(0)+"%":"";return"label"===pieLabelContent?seriesLabel||pctText:"label_percent"===pieLabelContent?seriesLabel&&pctText?seriesLabel+" "+pctText:seriesLabel||pctText:pctText},style:{fontSize:"11px",fontWeight:500,colors:"inside"!==pieLabelPosition?["#000"]:void 0},dropShadow:{enabled:!1}},plotOptions:{pie:{dataLabels:{offset:pieLabelOffset,minAngleToShowLabel:8},expandOnClick:!1}},tooltip:{enabled:!0,y:{formatter:valueFormatter}},noData:{text:"No data available",style:{fontSize:"13px",color:"#626976"}}};if(Number.isFinite(pieStartAngle)&&(apexOpts.plotOptions.pie.startAngle=pieStartAngle),Number.isFinite(pieEndAngle)&&(apexOpts.plotOptions.pie.endAngle=pieEndAngle),"donut"===chartType){var donutSize=Number(uiStyle.pieDonutSize);Number.isFinite(donutSize)||(donutSize=66),donutSize=Math.round(Math.max(30,Math.min(90,donutSize))),apexOpts.plotOptions.pie.donut={size:donutSize+"%"}}try{var chartOverride=chartAdvancedOverrideFromUiConfig(chartId,"pie");chartOverride&&isPlainObject(chartOverride)&&Object.keys(chartOverride).length&&(apexOpts=deepMergeOptions(apexOpts,chartOverride))}catch(_){}try{var afterRender=opts&&"function"==typeof opts.afterRender?opts.afterRender:null;upsertDashboardApexChart(chartId,chartEl,apexOpts,afterRender?function(chart){try{afterRender(chart,{chartEl:chartEl,labels:safeLabels,values:safeValues,chartType:chartType})}catch(_){}}:null)}catch(err){captureChartError(err,"dashboardPieChartRender",{chartId:chartId}),console.error("[dashboard] pie chart render error:",chartId,err)}}else renderOverviewChartLoading(chartId,"Loading chart...")}}function renderOverviewFinishesRadialBar(chartId,labels,values,opts){var chartEl=document.getElementById(chartId);if(chartEl&&"undefined"!=typeof ApexCharts){if(!isChartEnabledByUiConfig(chartId))return destroyDashChart(chartId),void(chartEl.innerHTML="");for(var total=0,i=0;i<values.length;i++)total+=normalizeOverviewMetric(values[i]);for(var series=[],j=0;j<values.length;j++){var v=normalizeOverviewMetric(values[j]);series.push(total>0?v/total*100:0)}labels=sanitizeChartConfig(labels,[{label:"Share",data:series}]).labels;var fallbackColors=opts&&Array.isArray(opts.colors)&&opts.colors.length?opts.colors:["#f59e34","#94a3b8","#8b5cf6","#4b94e4","#3eb3ab"],colors=chartColorsFromUiConfig(chartId,fallbackColors),chartHeight=resolveOverviewChartHeight(chartEl,opts&&Number.isFinite(Number(opts.height))?Number(opts.height):180,120,440);chartHeight=scaleHeightForChartSizePercent(chartId,chartHeight,120,440);var uiStyle=chartStyleFromUiConfig(chartId),labelsRef=labels,valuesRef=values,defaultIdx=0;try{for(var bestRev=-1/0,k=0;k<valuesRef.length;k++){var rv=normalizeOverviewMetric(valuesRef[k]);rv>bestRev&&(bestRev=rv,defaultIdx=k)}}catch(_){defaultIdx=0}try{chartEl.__kexoFinishesRadialCenter={enabled:!(uiStyle&&!1===uiStyle.radialCenterLabel),defaultIdx:defaultIdx,labels:labelsRef,values:valuesRef}}catch(_){}var apexOpts={chart:{type:"radialBar",height:chartHeight,fontFamily:"Inter, sans-serif",toolbar:{show:!(!uiStyle||!0!==uiStyle.toolbar)},animations:{enabled:!(!uiStyle||!0!==uiStyle.animations),easing:"easeinout",speed:280},events:{mounted:function(){try{syncFinishesRadialCenterLabel(defaultIdx)}catch(_){}},updated:function(){try{syncFinishesRadialCenterLabel(defaultIdx)}catch(_){}},dataPointMouseEnter:function(event,chartCtx,config){try{var idx=config&&Number.isFinite(Number(config.seriesIndex))?Number(config.seriesIndex):-1;idx>=0&&syncFinishesRadialCenterLabel(idx)}catch(_){}},dataPointMouseLeave:function(){try{syncFinishesRadialCenterLabel(defaultIdx)}catch(_){}}}},plotOptions:{radialBar:{startAngle:-135,endAngle:135,hollow:{size:"58%"},track:{background:"rgba(0,0,0,0.06)"},dataLabels:{name:{show:!1},value:{show:!1},total:{show:!1}}}},series:series,labels:labels,colors:colors,legend:{show:!(!opts||!opts.showLegend),position:"bottom",fontSize:"11px",labels:{colors:void 0}},fill:{opacity:uiStyle&&Number.isFinite(Number(uiStyle.fillOpacity))?Math.max(0,Math.min(1,Number(uiStyle.fillOpacity))):1},tooltip:{enabled:!0,custom:function(ctx){var idx=ctx&&Number.isFinite(ctx.seriesIndex)?ctx.seriesIndex:-1,name=idx>=0&&idx<labelsRef.length?labelsRef[idx]:"",rev=idx>=0&&idx<valuesRef.length?valuesRef[idx]:0,pct=ctx&&Array.isArray(ctx.series)&&idx>=0&&idx<ctx.series.length?Number(ctx.series[idx]):null,pctStr=null!=pct&&Number.isFinite(pct)?pct.toFixed(1)+"%":"—";try{idx>=0&&syncFinishesRadialCenterLabel(idx)}catch(_){}return'<div class="kexo-tooltip-card p-2"><div class="fw-semibold">'+escapeHtml(name||"")+"</div><div>Revenue: "+escapeHtml(fmtGbp(normalizeOverviewMetric(rev))||"—")+"</div><div>Share: "+escapeHtml(pctStr)+"</div></div>"}},states:{normal:{filter:{type:"none",value:0}},hover:{filter:{type:"none",value:0}},active:{filter:{type:"none",value:0}}},noData:{text:"No data available",style:{fontSize:"13px",color:"#626976"}}};try{var chartOverride=chartAdvancedOverrideFromUiConfig(chartId,"radialbar");chartOverride&&isPlainObject(chartOverride)&&Object.keys(chartOverride).length&&(apexOpts=deepMergeOptions(apexOpts,chartOverride))}catch(_){}try{upsertDashboardApexChart(chartId,chartEl,apexOpts,function(){try{syncFinishesRadialCenterLabel(defaultIdx)}catch(_){}});try{chartEl&&!chartEl.__kexoRadialCenterLeaveBound&&(chartEl.__kexoRadialCenterLeaveBound=!0,chartEl.addEventListener("mouseleave",function(){try{var st=chartEl&&chartEl.__kexoFinishesRadialCenter?chartEl.__kexoFinishesRadialCenter:null;syncFinishesRadialCenterLabel(st&&Number.isFinite(Number(st.defaultIdx))?Number(st.defaultIdx):0)}catch(_){}}))}catch(_){}}catch(err){captureChartError(err,"dashboardRadialBarRender",{chartId:chartId}),console.error("[dashboard] radialBar chart render error:",chartId,err)}}function syncFinishesRadialCenterLabel(selectedIdx){var st=null;try{st=chartEl&&chartEl.__kexoFinishesRadialCenter?chartEl.__kexoFinishesRadialCenter:null}catch(_){st=null}if(chartEl&&st&&!0===st.enabled){var idx=Number.isFinite(Number(selectedIdx))?Number(selectedIdx):st.defaultIdx;(idx<0||idx>=st.labels.length)&&(idx=st.defaultIdx);var name=idx>=0&&idx<st.labels.length?st.labels[idx]:"",revStr=fmtGbp(normalizeOverviewMetric(idx>=0&&idx<st.values.length?st.values[idx]:0))||"—";try{chartEl&&chartEl.style&&(chartEl.style.position="relative")}catch(_){}var el=null;try{el=chartEl.querySelector(".kexo-radial-center-label-wrap")}catch(_){el=null}el||((el=document.createElement("div")).className="kexo-radial-center-label-wrap",el.setAttribute("aria-hidden","true"),chartEl.appendChild(el)),el.innerHTML='<div class="kexo-radial-center-label">'+escapeHtml(name||"")+'</div><div class="kexo-radial-center-value">'+escapeHtml(revStr)+"</div>"}else try{var existing=chartEl?chartEl.querySelector(".kexo-radial-center-label-wrap"):null;existing&&existing.remove()}catch(_){}}}function renderOverviewFinishesBarChart(chartId,labels,values,opts){var chartEl=document.getElementById(chartId);if(chartEl&&"undefined"!=typeof ApexCharts){if(!isChartEnabledByUiConfig(chartId))return destroyDashChart(chartId),void(chartEl.innerHTML="");var fallbackColors=opts&&Array.isArray(opts.colors)&&opts.colors.length?opts.colors:["#f59e34","#94a3b8","#8b5cf6","#4b94e4","#3eb3ab"],colors=chartColorsFromUiConfig(chartId,fallbackColors),chartHeight=resolveOverviewChartHeight(chartEl,opts&&Number.isFinite(Number(opts.height))?Number(opts.height):180,120,440);chartHeight=scaleHeightForChartSizePercent(chartId,chartHeight,120,440);var uiStyle=chartStyleFromUiConfig(chartId),horizontal=opts&&!1!==opts.horizontal,apexOpts={chart:{type:"bar",height:chartHeight,fontFamily:"Inter, sans-serif",toolbar:{show:!1},animations:{enabled:!(!uiStyle||!0!==uiStyle.animations)}},plotOptions:{bar:{horizontal:horizontal,borderRadius:0,distributed:!0,barHeight:horizontal?"60%":"70%"}},series:[{name:"Revenue",data:values.map(function(v){return normalizeOverviewMetric(v)})}],xaxis:{categories:labels,labels:{show:!horizontal}},yaxis:horizontal?{labels:{show:!0,style:{fontSize:"12px",fontWeight:500,colors:"#090f17"}}}:{labels:{show:!1}},grid:{padding:{bottom:12,left:12,right:8,top:4}},colors:colors,legend:{show:!1},dataLabels:{enabled:!1},fill:{opacity:uiStyle&&Number.isFinite(Number(uiStyle.fillOpacity))?Math.max(0,Math.min(1,Number(uiStyle.fillOpacity))):1},tooltip:{enabled:!0,y:{formatter:function(v){return fmtGbp(normalizeOverviewMetric(v))||"—"}}},noData:{text:"No data available",style:{fontSize:"13px",color:"#626976"}}};try{var chartOverride=chartAdvancedOverrideFromUiConfig(chartId,"bar");chartOverride&&isPlainObject(chartOverride)&&Object.keys(chartOverride).length&&(apexOpts=deepMergeOptions(apexOpts,chartOverride))}catch(_){}horizontal&&(apexOpts.xaxis=apexOpts.xaxis||{},apexOpts.xaxis.labels=apexOpts.xaxis.labels||{},apexOpts.xaxis.labels.show=!1);try{upsertDashboardApexChart(chartId,chartEl,apexOpts)}catch(err){captureChartError(err,"dashboardFinishesBarRender",{chartId:chartId})}}}function platformLabelForKey(platformKey){var p=(platformKey||"").trim().toLowerCase();return"ios"===p?"iOS":"android"===p?"Android":"windows"===p?"Windows":"mac"===p?"Mac":"linux"===p?"Linux":p||"Other"}function platformIconHtmlForKey(platformKey,label){var p=(platformKey||"").trim().toLowerCase(),key="type-platform-unknown",cls="fa-light fa-circle-question";return"ios"===p?(key="type-platform-ios",cls="fa-light fa-apple"):"mac"===p?(key="type-platform-mac",cls="fa-light fa-apple"):"android"===p?(key="type-platform-android",cls="fa-light fa-android"):"windows"===p?(key="type-platform-windows",cls="fa-light fa-windows"):"linux"===p&&(key="type-platform-linux",cls="fa-light fa-linux"),'<i class="'+escapeHtml(cls)+'" data-icon-key="'+escapeHtml(key)+'" aria-hidden="true"'+(label?' title="'+escapeHtml(label)+'"':"")+"></i>"}function clearOverviewDevicesYIcons(chartId){var chartEl=document.getElementById(chartId);if(chartEl&&chartEl.parentElement&&chartEl.parentElement.querySelector){var col=null;try{col=chartEl.parentElement.querySelector('[data-overview-yicons="'+chartId+'"]')}catch(_){col=null}col&&(col.innerHTML="")}}function renderOverviewDevicesHorizontalBar(chartId,platforms,opts){var chartEl=document.getElementById(chartId);if(chartEl&&"undefined"!=typeof ApexCharts){if(!isChartEnabledByUiConfig(chartId))return destroyDashChart(chartId),chartEl.innerHTML="",void clearOverviewDevicesYIcons(chartId);var rows=Array.isArray(platforms)?platforms:[],labels=[],values=[],orders=[],revenues=[],platformKeys=[],renderedRows=[];if(rows.forEach(function(r){if(r&&"object"==typeof r){var p=null!=r.platform?String(r.platform).trim().toLowerCase():"",label=null!=r.label?String(r.label).trim():platformLabelForKey(p),sessions=normalizeOverviewMetric(r.sessions);if(label&&!(sessions<=0)){var s=Math.max(0,Math.round(sessions)),o=Math.max(0,Math.round(normalizeOverviewMetric(r.orders))),rev=normalizeOverviewMetric(r.revenue_gbp);labels.push(label),values.push(s),orders.push(o),revenues.push(rev),platformKeys.push(p),renderedRows.push({platform:p,label:label,sessions:s,orders:o,revenue_gbp:rev})}}}),!labels.length||!values.length)return renderOverviewChartEmpty(chartId,"No device data"),void clearOverviewDevicesYIcons(chartId);var fallbackColors=opts&&Array.isArray(opts.colors)&&opts.colors.length?opts.colors:["#4b94e4","#3eb3ab","#f59e34","#8b5cf6","#ef4444"],colors=chartColorsFromUiConfig(chartId,fallbackColors),chartHeight=resolveOverviewChartHeight(chartEl,opts&&Number.isFinite(Number(opts.height))?Number(opts.height):180,120,440);try{var pct=chartSizePercentFromUiConfig(chartId,100);Number.isFinite(pct)&&pct>0&&100!==pct&&((chartHeight=Math.round(chartHeight*(pct/100)))<120&&(chartHeight=120),chartHeight>440&&(chartHeight=440))}catch(_){}var uiStyle=chartStyleFromUiConfig(chartId),labelsRef=labels,valuesRef=values,ordersRef=orders,revenuesRef=revenues,platformRef=platformKeys,horizontal=!(!opts||!opts.horizontal),plotOptions={bar:{horizontal:horizontal,borderRadius:0,distributed:!0,dataLabels:{hideOverflowingLabels:!1}}};horizontal?plotOptions.bar.barHeight="54%":plotOptions.bar.columnWidth="55%";var apexOpts={chart:{type:"bar",height:chartHeight,offsetY:-4,fontFamily:"Inter, sans-serif",toolbar:{show:!1},animations:{enabled:!(!uiStyle||!0!==uiStyle.animations)}},plotOptions:plotOptions,series:[{name:"Sessions",data:values}],xaxis:{categories:labels,labels:{show:!horizontal}},yaxis:{labels:{show:!1}},grid:{show:!1,padding:{bottom:10,left:6,right:8,top:0}},colors:colors,legend:{show:!1},dataLabels:{enabled:!1},fill:{opacity:uiStyle&&Number.isFinite(Number(uiStyle.fillOpacity))?Math.max(0,Math.min(1,Number(uiStyle.fillOpacity))):1,type:"solid"},stroke:{show:!1,width:0},states:{normal:{filter:{type:"none",value:0}},hover:{filter:{type:"none",value:0}},active:{filter:{type:"none",value:0}}},tooltip:{enabled:!0,custom:function(tip){var idx=tip&&null!=tip.dataPointIndex?tip.dataPointIndex:-1,name=idx>=0&&idx<labelsRef.length?labelsRef[idx]:"",sess=idx>=0&&idx<valuesRef.length?valuesRef[idx]:0,ord=idx>=0&&idx<ordersRef.length?ordersRef[idx]:0,rev=idx>=0&&idx<revenuesRef.length?revenuesRef[idx]:0,pKey=idx>=0&&idx<platformRef.length?platformRef[idx]:"",crStr=sess>0?(ord/sess*100).toFixed(1)+"%":"—";return'<div class="kexo-tooltip-card p-2"><div class="fw-semibold d-flex align-items-center gap-2">'+platformIconHtmlForKey(pKey,name)+escapeHtml(name||"")+"</div><div>Sessions: "+escapeHtml(fmtNum(sess))+"</div><div>Orders: "+escapeHtml(fmtNum(ord))+"</div><div>Conversion: "+escapeHtml(crStr)+"</div><div>Revenue: "+escapeHtml(fmtGbp(normalizeOverviewMetric(rev))||"—")+"</div></div>"}},noData:{text:"No data available",style:{fontSize:"13px",color:"#626976"}}};try{var chartOverride=chartAdvancedOverrideFromUiConfig(chartId,"bar-horizontal");chartOverride&&isPlainObject(chartOverride)&&Object.keys(chartOverride).length&&(apexOpts=deepMergeOptions(apexOpts,chartOverride))}catch(_){}try{upsertDashboardApexChart(chartId,chartEl,apexOpts),horizontal?function(chartId,platforms){var chartEl=document.getElementById(chartId);if(chartEl&&chartEl.parentElement&&chartEl.parentElement.querySelector){var col=null;try{col=chartEl.parentElement.querySelector('[data-overview-yicons="'+chartId+'"]')}catch(_){col=null}if(col){var list=Array.isArray(platforms)?platforms:[];if(list.length){try{col.style.setProperty("--dash-devices-row-count",String(list.length))}catch(_){}col.innerHTML=list.map(function(r){var platform=r&&null!=r.platform?String(r.platform).trim().toLowerCase():"",label=r&&null!=r.label?String(r.label).trim():platformLabelForKey(platform);return'<div class="dash-devices-icon-cell" title="'+escapeHtml(label)+'" aria-label="'+escapeHtml(label)+'">'+platformIconHtmlForKey(platform,label)+'<span class="dash-devices-icon-label">'+escapeHtml(label)+"</span></div>"}).join("")}else col.innerHTML=""}}}(chartId,renderedRows):clearOverviewDevicesYIcons(chartId);try{var legendEl=chartEl.parentElement&&chartEl.parentElement.parentElement&&chartEl.parentElement.parentElement.querySelector?chartEl.parentElement.parentElement.querySelector('[data-overview-legend="'+chartId+'"]'):null;legendEl&&(legendEl.innerHTML="")}catch(_){}}catch(err){captureChartError(err,"dashboardDevicesBarRender",{chartId:chartId}),clearOverviewDevicesYIcons(chartId)}}}function attributionIconSpecToHtml(specRaw,labelRaw){var spec=null!=specRaw?String(specRaw).trim():"",label=null!=labelRaw?String(labelRaw).trim():"";return spec?/^<svg[\s>]/i.test(spec)?'<span class="source-icons" title="'+escapeHtml(label)+'" aria-hidden="true">'+spec+"</span>":/^(https?:\/\/|\/\/|\/)/i.test(spec)?'<span class="source-icons"><img src="'+escapeHtml(spec)+'" alt="'+escapeHtml(label)+'" class="source-icon-img" width="20" height="20" title="'+escapeHtml(label)+'"></span>':'<span class="source-icons"><i class="'+escapeHtml(spec)+'" title="'+escapeHtml(label)+'" aria-hidden="true"></i></span>':""}function renderOverviewAttributionDistributedBar(chartId,sources,opts){var chartEl=document.getElementById(chartId);if(chartEl&&"undefined"!=typeof ApexCharts){if(!isChartEnabledByUiConfig(chartId))return destroyDashChart(chartId),chartEl.innerHTML="",void removeAttributionIconRow(chartEl);var labels=[],values=[],crPcts=[],iconSpecs=[];if(sources.forEach(function(s){var label=s&&null!=s.label?String(s.label).trim():"",rev=normalizeOverviewMetric(s&&null!=s.revenue_gbp?s.revenue_gbp:s.revenue);labels.push(label||"—"),values.push(rev),crPcts.push(s&&null!=s.conversion_pct?Number(s.conversion_pct):null),iconSpecs.push(s&&null!=s.icon_spec?String(s.icon_spec).trim():"")}),!labels.length||!values.length)return renderOverviewChartEmpty(chartId,"No attribution data"),void removeAttributionIconRow(chartEl);removeAttributionIconRow(chartEl);var fallbackColors=opts&&Array.isArray(opts.colors)&&opts.colors.length?opts.colors:["#4b94e4","#3eb3ab","#f59e34","#8b5cf6","#ef4444"],colors=chartColorsFromUiConfig(chartId,fallbackColors),chartHeight=resolveOverviewChartHeight(chartEl,opts&&Number.isFinite(Number(opts.height))?Number(opts.height):180,120,440);try{var pct=chartSizePercentFromUiConfig(chartId,100);Number.isFinite(pct)&&pct>0&&100!==pct&&((chartHeight=Math.round(chartHeight*(pct/100)))<120&&(chartHeight=120),chartHeight>440&&(chartHeight=440))}catch(_){}var uiStyle=chartStyleFromUiConfig(chartId),labelsRef=labels,valuesRef=values,crPctsRef=crPcts,horizontal=!(!opts||!opts.horizontal),apexOpts={chart:{type:"bar",height:chartHeight,fontFamily:"Inter, sans-serif",toolbar:{show:!1},animations:{enabled:!(!uiStyle||!0!==uiStyle.animations)}},plotOptions:{bar:{borderRadius:0,distributed:!0,barHeight:horizontal?"60%":"70%",horizontal:horizontal}},series:[{name:"Revenue",data:values}],xaxis:{categories:labels,labels:{show:!1}},yaxis:horizontal?{labels:{show:!0,style:{fontSize:"12px",fontWeight:500,colors:"#090f17"}}}:{labels:{show:!1}},grid:{padding:{bottom:12,left:12,right:8,top:4}},colors:colors,legend:{show:!1},dataLabels:{enabled:!1},fill:{opacity:uiStyle&&Number.isFinite(Number(uiStyle.fillOpacity))?Math.max(0,Math.min(1,Number(uiStyle.fillOpacity))):1,type:"solid"},stroke:{show:!1,width:0},states:{normal:{filter:{type:"none",value:0}},hover:{filter:{type:"none",value:0}},active:{filter:{type:"none",value:0}}},tooltip:{enabled:!0,custom:function(opts){var idx=opts&&null!=opts.dataPointIndex?opts.dataPointIndex:-1,name=idx>=0&&idx<labelsRef.length?labelsRef[idx]:"",rev=idx>=0&&idx<valuesRef.length?valuesRef[idx]:0,cr=idx>=0&&idx<crPctsRef.length?crPctsRef[idx]:null,crStr=null!=cr&&Number.isFinite(cr)?cr.toFixed(1)+"%":"—";return'<div class="kexo-tooltip-card p-2"><div class="fw-semibold">'+escapeHtml(name)+"</div><div>Revenue: "+escapeHtml(fmtGbp(rev)||"—")+"</div><div>Conversion: "+escapeHtml(crStr)+"</div></div>"}},noData:{text:"No data available",style:{fontSize:"13px",color:"#626976"}}};try{var chartOverride=chartAdvancedOverrideFromUiConfig(chartId,"bar");chartOverride&&isPlainObject(chartOverride)&&Object.keys(chartOverride).length&&(apexOpts=deepMergeOptions(apexOpts,chartOverride))}catch(_){}horizontal&&(apexOpts.xaxis=apexOpts.xaxis||{},apexOpts.xaxis.labels=apexOpts.xaxis.labels||{},apexOpts.xaxis.labels.show=!1);try{upsertDashboardApexChart(chartId,chartEl,apexOpts),function(chartEl,sources,iconSpecToHtml){if(!(chartEl&&chartEl.parentNode&&Array.isArray(sources)&&sources.length))return;var row=document.createElement("div");row.className="dash-attribution-icon-row",sources.forEach(function(s){var cell=document.createElement("div");cell.className="dash-attribution-icon-cell";var label=s&&null!=s.label?String(s.label).trim():"",spec=s&&null!=s.icon_spec?String(s.icon_spec).trim():"";cell.innerHTML=spec?iconSpecToHtml(spec,label):'<span class="dash-attribution-icon-fallback">'+escapeHtml(label||"—")+"</span>",row.appendChild(cell)}),chartEl.parentNode.insertBefore(row,chartEl.nextSibling);try{scheduleOverviewHeightSync()}catch(_){}}(chartEl,sources,attributionIconSpecToHtml)}catch(err){captureChartError(err,"dashboardAttributionBarRender",{chartId:chartId})}}}function removeAttributionIconRow(chartEl){if(chartEl&&chartEl.parentNode){var sibling=chartEl.nextElementSibling;sibling&&sibling.classList&&sibling.classList.contains("dash-attribution-icon-row")&&sibling.remove()}}function removeAttributionDonutIcons(chartEl){if(chartEl)try{var existing=chartEl.querySelector(".dash-attribution-donut-icons");existing&&existing.remove()}catch(_){}}function renderOverviewAttributionChart(attributionPayload){var chartId="dash-chart-attribution-30d",rows=attributionPayload&&attributionPayload.attribution&&Array.isArray(attributionPayload.attribution.rows)?attributionPayload.attribution.rows:[],mode=String(chartModeFromUiConfig(chartId,"donut")||"donut").trim().toLowerCase();mode=validateChartType(chartId,mode,"donut");var chartEl=document.getElementById(chartId);removeAttributionIconRow(chartEl),removeAttributionDonutIcons(chartEl);var uiStyle=chartStyleFromUiConfig(chartId),showIcons=!(!uiStyle||!0!==uiStyle.icons);function normText(v){return(null==v?"":String(v)).replace(/\s+/g," ").trim()}function isOtherLabel(v){var s=normText(v).toLowerCase();return"other"===s||"unknown"===s||"(other)"===s||"(unknown)"===s||"n/a"===s||"na"===s}function labelFromKey(keyRaw,fallbackLabel){var v,s,key=normText(keyRaw).toLowerCase(),fb=normText(fallbackLabel);return key?key.indexOf("google")>=0&&key.indexOf("ads")>=0?"Google Ads":key.indexOf("organic")>=0?"Organic":key.indexOf("direct")>=0?"Direct":key.indexOf("email")>=0||key.indexOf("klaviyo")>=0?"Email":key.indexOf("affiliate")>=0?"Affiliates":key.indexOf("referral")>=0?"Referral":key.indexOf("sms")>=0?"SMS":key.indexOf("tiktok")>=0?"TikTok":key.indexOf("facebook")>=0||key.indexOf("meta")>=0?"Meta":key.indexOf("instagram")>=0?"Instagram":key.indexOf("pinterest")>=0?"Pinterest":key.indexOf("snap")>=0?"Snapchat":key.indexOf("bing")>=0?"Bing":key.indexOf("other")>=0||key.indexOf("unknown")>=0?"Other":(v=key.replace(/[_-]+/g," "),(s=normText(v))?/^(sms|seo|ppc|roas)$/i.test(s)?s.toUpperCase():s.split(" ").map(function(w){return w?w.charAt(0).toUpperCase()+w.slice(1).toLowerCase():""}).join(" "):"")||fb||"Other":fb||"Other"}function fallbackIconSpecForLabel(labelRaw){var s=normText(labelRaw).toLowerCase();return s&&"other"!==s?s.indexOf("google")>=0?"fa-brands fa-google":s.indexOf("meta")>=0||s.indexOf("facebook")>=0?"fa-brands fa-facebook":s.indexOf("instagram")>=0?"fa-brands fa-instagram":s.indexOf("tiktok")>=0?"fa-brands fa-tiktok":s.indexOf("email")>=0?"fa-light fa-envelope":s.indexOf("direct")>=0?"fa-light fa-arrow-right-to-bracket":s.indexOf("organic")>=0?"fa-light fa-seedling":s.indexOf("affiliate")>=0?"fa-light fa-handshake":s.indexOf("referral")>=0?"fa-light fa-link":s.indexOf("sms")>=0?"fa-light fa-message-sms":"fa-light fa-globe":"fa-light fa-ellipsis"}var byKey={};rows.forEach(function(ch){ch&&Array.isArray(ch.sources)&&(ch.sources||[]).forEach(function(src){if(src){var rev=normalizeOverviewMetric(null!=src.revenue_gbp?src.revenue_gbp:src.revenue);if(rev>0){var rawLabel=normText(null!=src.label?src.label:""),rawKey=normText(null!=src.source_key?src.source_key:""),label=rawLabel&&!isOtherLabel(rawLabel)?rawLabel:labelFromKey(rawKey,rawLabel);isOtherLabel(label)&&(label="Other"),label||(label="Other");var k=label.toLowerCase();("other"===k||isOtherLabel(k))&&(k="other");var iconSpec=normText(null!=src.icon_spec?src.icon_spec:"");iconSpec||(iconSpec=""),byKey[k]||(byKey[k]={key:k,label:label,icon_spec:iconSpec,revenue_gbp:0}),byKey[k].revenue_gbp+=rev,!byKey[k].icon_spec&&iconSpec&&(byKey[k].icon_spec=iconSpec)}}})});var groups=Object.keys(byKey).map(function(k){return byKey[k]}).filter(Boolean);groups.forEach(function(g){g&&("other"===g.key&&(g.label="Other"),!g.icon_spec&&showIcons&&(g.icon_spec=fallbackIconSpecForLabel(g.label)))}),groups.sort(function(a,b){return(b.revenue_gbp||0)-(a.revenue_gbp||0)});for(var other=null,oi=0;oi<groups.length;oi++)if(groups[oi]&&"other"===groups[oi].key){other=groups[oi];break}var main=groups.filter(function(g){return g&&"other"!==g.key}),keep=main.slice(0,4),remainder=main.slice(4);remainder.length&&(other||(other={key:"other",label:"Other",icon_spec:showIcons?fallbackIconSpecForLabel("Other"):"",revenue_gbp:0}),remainder.forEach(function(g){other.revenue_gbp+=g&&g.revenue_gbp?g.revenue_gbp:0})),other&&(other.revenue_gbp||0)>0&&keep.push(other);var finalSources=keep.filter(function(g){return g&&(g.revenue_gbp||0)>0}).slice(0,5);if(finalSources.length){var labels=finalSources.map(function(s){return s&&s.label?String(s.label):""}),values=finalSources.map(function(s){return s&&s.revenue_gbp?s.revenue_gbp:0}),crPcts=finalSources.map(function(s){return s&&Number.isFinite(Number(s.conversion_pct))?Number(s.conversion_pct):null}),fallbackColors=["#4b94e4","#3eb3ab","#f59e34","#8b5cf6","#ef4444"],colors=chartColorsFromUiConfig(chartId,fallbackColors);try{var legendHost2=document.querySelector('[data-overview-legend="'+chartId+'"]');legendHost2&&(legendHost2.innerHTML=finalSources.map(function(s){var lbl=s&&s.label?String(s.label):"",spec=s&&s.icon_spec?String(s.icon_spec):"";return'<span class="kexo-overview-mini-legend-item">'+(showIcons&&spec?attributionIconSpecToHtml(spec,lbl):"")+'<span class="kexo-overview-legend-label">'+escapeHtml(lbl||"Other")+"</span></span>"}).join(""))}catch(_){}if("bar-horizontal"===mode||"bar"===mode||"bar-distributed"===mode)renderOverviewAttributionDistributedBar(chartId,finalSources,{colors:colors,height:180,horizontal:"bar-horizontal"===mode});else if("line"===mode||"area"===mode||"multi-line-labels"===mode){var labelsRef=labels,valuesRef=values,crPctsRef=crPcts;makeChart(chartId,labels,[{label:"Revenue",data:values,borderColor:colors&&colors[0]||DASH_ACCENT,backgroundColor:colors&&colors[0]?colors[0]+"33":DASH_ACCENT_LIGHT,fill:"area"===mode,borderWidth:2}],{currency:!0,chartType:mode,height:180,tooltipCustom:function(tip){var idx=tip&&null!=tip.dataPointIndex?tip.dataPointIndex:-1,name=idx>=0&&idx<labelsRef.length?labelsRef[idx]:"",rev=idx>=0&&idx<valuesRef.length?valuesRef[idx]:0,cr=idx>=0&&idx<crPctsRef.length?crPctsRef[idx]:null,crStr=null!=cr&&Number.isFinite(cr)?cr.toFixed(1)+"%":"—";return'<div class="kexo-tooltip-card p-2"><div class="fw-semibold">'+escapeHtml(name||"")+"</div><div>Revenue: "+escapeHtml(fmtGbp(rev)||"—")+"</div><div>Conversion: "+escapeHtml(crStr)+"</div></div>"}})}else"radialbar"===mode?renderOverviewFinishesRadialBar(chartId,labels,values,{colors:colors,height:180,showLegend:!1}):renderOverviewPieChart(chartId,labels,values,{colors:colors,valueFormatter:function(v){return fmtGbp(normalizeOverviewMetric(v))||"—"},height:180,dataLabels:!1,showLegend:!1,donut:"donut"===mode,pieStartAngle:-90,pieEndAngle:270,pieCustomScale:.7,afterRender:null});try{scheduleOverviewHeightSync()}catch(_){}}else{renderOverviewChartEmpty(chartId,"No attribution data");try{var legendHost=document.querySelector('[data-overview-legend="'+chartId+'"]');legendHost&&(legendHost.innerHTML="")}catch(_){}}}function setOverviewSalesRunningTotals(revenueTotal,costTotal,profitTotal){
// Keep the header totals text colours in sync with the overview chart series colours (from Chart Settings).
try{lastOverviewTotals={revenue:revenueTotal,cost:costTotal,profit:profitTotal},syncOverviewSalesTotalsColors(revenueTotal,costTotal,profitTotal)}catch(_){}function setValue(id,value){var el=document.getElementById(id);if(el){var n=Number(value);Number.isFinite(n)?el.textContent=fmtGbp(Math.round(100*n)/100):el.textContent="—"}}setValue("dash-overview-total-revenue",revenueTotal),setValue("dash-overview-total-cost",costTotal),setValue("dash-overview-total-profit",profitTotal);try{var profitEl=document.getElementById("dash-overview-total-profit"),profitWrap=profitEl&&profitEl.closest?profitEl.closest(".kexo-overview-running-total.is-profit"):null,p=Number(profitTotal);
// If snapshot totals aren't available yet, fall back to the KPI text so the header isn't misleading.
if(profitWrap&&profitWrap.classList&&profitWrap.classList.toggle("is-negative",Number.isFinite(p)&&p<0),!Number.isFinite(p)&&profitEl){var kpiProfit=document.getElementById("dash-kpi-profit"),txt=kpiProfit?String(kpiProfit.textContent||"").trim():"";txt&&"—"!==txt&&(profitEl.textContent=txt)}}catch(_){}}registerCleanup(function(){try{overviewMiniResizeObserver&&"function"==typeof overviewMiniResizeObserver.disconnect&&overviewMiniResizeObserver.disconnect()}catch(_){}try{overviewMiniResizeTimer&&clearTimeout(overviewMiniResizeTimer)}catch(_){}try{overviewHeightSyncObserver&&"function"==typeof overviewHeightSyncObserver.disconnect&&overviewHeightSyncObserver.disconnect()}catch(_){}try{overviewLazyObserver&&"function"==typeof overviewLazyObserver.disconnect&&overviewLazyObserver.disconnect()}catch(_){}try{overviewHeightSyncTimer&&clearTimeout(overviewHeightSyncTimer)}catch(_){}try{overviewHeightSyncResizeBound&&(overviewHeightSyncResizeBound=!1,window.removeEventListener("resize",scheduleOverviewHeightSync))}catch(_){}overviewMiniResizeTimer=null,overviewMiniResizeObserver=null,overviewHeightSyncObserver=null,overviewHeightSyncTimer=null,dashPayloadSignature="",overviewMiniFetchedAt=0,overviewCardCache={},overviewCardInFlight={},overviewCardPayloadSignature={},overviewLazyObserver=null,overviewLazyPending={},overviewLazyVisible={},clearOverviewHeightSyncStyles();try{Object.keys(dashSparkCharts||{}).forEach(function(id){var chart=dashSparkCharts[id];chart&&"function"==typeof chart.destroy&&chart.destroy()})}catch(_){}dashSparkCharts={};try{["dash-chart-finishes-30d","dash-chart-devices-30d","dash-chart-attribution-30d","dash-chart-overview-30d"].forEach(function(chartId){destroyDashChart(chartId)})}catch(_){}});var OVERVIEW_TOTALS_FALLBACK_COLORS=["#3eb3ab","#ef4444","#2fb344","#d63939"],lastOverviewTotals={revenue:null,cost:null,profit:null},overviewTotalsColorsBound=!1;function syncOverviewSalesTotalsColors(revenueTotal,costTotal,profitTotal){function clearInlineColor(id){var el=document.getElementById(id);if(el&&el.style)try{el.style.color=""}catch(_){}}function setCssVar(name,value){var host=function(){try{return document.getElementById("dash-overview-running-totals")}catch(_){return null}}();if(host&&host.style)try{value?host.style.setProperty(name,String(value)):host.style.removeProperty(name)}catch(_){}}var colors=OVERVIEW_TOTALS_FALLBACK_COLORS;try{colors=chartColorsFromUiConfig("dash-chart-overview-30d",OVERVIEW_TOTALS_FALLBACK_COLORS)||OVERVIEW_TOTALS_FALLBACK_COLORS}catch(_){colors=OVERVIEW_TOTALS_FALLBACK_COLORS}var revCss=colors&&colors[0]?colors[0]:OVERVIEW_TOTALS_FALLBACK_COLORS[0],costCss=colors&&colors[1]?colors[1]:OVERVIEW_TOTALS_FALLBACK_COLORS[1],profitPosCss=colors&&colors[2]?colors[2]:OVERVIEW_TOTALS_FALLBACK_COLORS[2],profitNegCss=colors&&colors[3]?colors[3]:OVERVIEW_TOTALS_FALLBACK_COLORS[3],p=Number(profitTotal),profitCss=Number.isFinite(p)&&p<0?profitNegCss:profitPosCss;
// Ensure future colour-syncs happen immediately after saving Chart Settings.
if(
// Header: keep text neutral, show series colours via dots (CSS vars).
clearInlineColor("dash-overview-total-revenue"),clearInlineColor("dash-overview-total-cost"),clearInlineColor("dash-overview-total-profit"),setCssVar("--kexo-overview-series-revenue",revCss),setCssVar("--kexo-overview-series-cost",costCss),setCssVar("--kexo-overview-series-profit",profitCss),!overviewTotalsColorsBound){overviewTotalsColorsBound=!0;try{window.addEventListener("kexo:chartsUiConfigUpdated",function(){try{syncOverviewSalesTotalsColors(lastOverviewTotals.revenue,lastOverviewTotals.cost,lastOverviewTotals.profit)}catch(_){}})}catch(_){}}}function setOverviewCostBreakdownTooltip(snapshotPayload){var iconEl=document.getElementById("dash-overview-cost-breakdown-icon"),costEl=document.getElementById("dash-overview-total-cost"),Popover=window.bootstrap&&window.bootstrap.Popover;function disposePopover(el){if(el&&Popover)try{var existing=Popover.getInstance(el);existing&&(existing.hide(),existing.dispose())}catch(_){}}function upsertPopover(el,contentHtml){if(el&&Popover)try{if(disposePopover(el),!contentHtml)return;var pop=new Popover(el,{trigger:"hover focus",placement:"bottom",html:!0,container:document.body,customClass:"kexo-cost-breakdown-popover",content:contentHtml});
// Ensure screen-readers have an accessible name even if markup uses aria-hidden elsewhere.
try{el.getAttribute("aria-label")||el.setAttribute("aria-label","Cost breakdown")}catch(_){}return pop}catch(_){return null}}iconEl&&iconEl.style&&(iconEl.style.display="none"),disposePopover(iconEl),disposePopover(costEl);try{iconEl&&iconEl.removeAttribute("title")}catch(_){}try{costEl&&costEl.removeAttribute("title")}catch(_){}if(snapshotPayload){var fin=snapshotPayload&&snapshotPayload.financial&&"object"==typeof snapshotPayload.financial?snapshotPayload.financial:null,breakdown=fin&&Array.isArray(fin.costBreakdownNow)?fin.costBreakdownNow:null;if(breakdown&&breakdown.length){var lines=[],sum=0;if(breakdown.forEach(function(row){if(row&&"object"==typeof row){var label=null!=row.label?String(row.label).trim():"",amt=null!=row.amountGbp?Number(row.amountGbp):Number(row.amount);label&&(Number.isFinite(amt)||(amt=0),sum+=amt,lines.push({label:label,amount:Math.round(100*amt)/100}))}}),lines.length){var total=Math.round(100*sum)/100,html="<strong>Cost breakdown</strong><br>"+lines.map(function(r){return escapeHtml(r.label)+": "+escapeHtml(fmtGbp(r.amount))}).join("<br>")+"<br><strong>Total: "+escapeHtml(fmtGbp(total))+"</strong>";upsertPopover(iconEl,html),upsertPopover(costEl,html),iconEl&&iconEl.style&&(iconEl.style.display="")}}}}function renderOverviewRevenueCostChart(snapshotPayload){var chartId="dash-chart-overview-30d";if(!isChartEnabledByUiConfig(chartId)){destroyDashChart(chartId);var hiddenEl=document.getElementById(chartId);return hiddenEl&&(hiddenEl.innerHTML=""),setOverviewSalesRunningTotals(null,null,null),void setOverviewCostBreakdownTooltip(null)}if(!snapshotPayload)return setOverviewSalesRunningTotals(null,null,null),setOverviewCostBreakdownTooltip(null),void renderOverviewChartLoading(chartId,"Loading sales overview…");var current=snapshotPayload&&snapshotPayload.seriesComparison&&snapshotPayload.seriesComparison.current?snapshotPayload.seriesComparison.current:null,granularity=snapshotPayload&&snapshotPayload.seriesComparison&&snapshotPayload.seriesComparison.granularity?String(snapshotPayload.seriesComparison.granularity).trim().toLowerCase():"day",labelsYmd=current&&Array.isArray(current.labelsYmd)?current.labelsYmd:[],revenueGbp=current&&Array.isArray(current.revenueGbp)?current.revenueGbp:[],costGbp=current&&Array.isArray(current.costGbp)?current.costGbp:[],len=Math.max(labelsYmd.length,revenueGbp.length,costGbp.length);if(!len)return setOverviewSalesRunningTotals(null,null,null),setOverviewCostBreakdownTooltip(snapshotPayload),void renderOverviewChartEmpty(chartId,"No sales overview data");for(var labels=[],revenue=[],cost=[],profit=[],revenueTotal=0,costTotal=0,profitTotal=0,i=0;i<len;i++){var ymd=null!=labelsYmd[i]?String(labelsYmd[i]):"";labels.push(ymd?formatOverviewBucketLabel(ymd,granularity):String(i+1));var revRaw=normalizeOverviewMetric(revenueGbp[i]),cstRaw=normalizeOverviewMetric(costGbp[i]);Number.isFinite(revRaw)||(revRaw=0),Number.isFinite(cstRaw)||(cstRaw=0);var rev=Math.round(100*revRaw)/100,cst=Math.round(100*cstRaw)/100,pft=Math.round(100*(rev-cst))/100;revenue.push(rev),cost.push(cst),profit.push(pft),revenueTotal+=rev,costTotal+=cst,profitTotal+=pft}revenueTotal=Math.round(100*revenueTotal)/100,costTotal=Math.round(100*costTotal)/100,profitTotal=Math.round(100*(revenueTotal-costTotal))/100;
// Bucket mode: all buckets vs latest bucket only.
try{var uiStyle=chartStyleFromUiConfig(chartId);// backward compat
if("latest"===(uiStyle&&null!=uiStyle.timeseriesScope?String(uiStyle.timeseriesScope).trim().toLowerCase():uiStyle&&null!=uiStyle.bucketMode?String(uiStyle.bucketMode).trim().toLowerCase():"full")){var last=labels.length?labels.length-1:-1;last>=0&&(revenueTotal=Number.isFinite(Number(revenue[last]))?Number(revenue[last]):0,costTotal=Number.isFinite(Number(cost[last]))?Number(cost[last]):0,profitTotal=Number.isFinite(Number(profit[last]))?Number(profit[last]):Math.round(100*(revenueTotal-costTotal))/100,labels=[labels[last]],revenue=[revenueTotal],cost=[costTotal],profit=[profitTotal])}}catch(_){}setOverviewSalesRunningTotals(revenueTotal,costTotal,profitTotal),setOverviewCostBreakdownTooltip(snapshotPayload);var chartHeight=resolveOverviewChartHeight(document.getElementById(chartId),260,140,760),overviewMode=chartModeFromUiConfig(chartId,"area"),overviewChartType="multi-line-labels"===(overviewMode=validateChartType(chartId,overviewMode,"area"))?"line":"stacked-area"===overviewMode||"stacked-bar"===overviewMode||"combo"===overviewMode?overviewMode:overviewMode||"area",profitColor="#22c55e",profitBg="rgba(34,197,94,0.14)";try{var hasPositive=profit&&profit.some(function(v){var n=Number(v);return Number.isFinite(n)&&n>0}),hasNegative=profit&&profit.some(function(v){var n=Number(v);return Number.isFinite(n)&&n<0}),latestProfit=profit&&profit.length?Number(profit[profit.length-1]):null;Number.isFinite(latestProfit)&&(latestProfit<0||!hasPositive&&hasNegative)&&(profitColor="#d63939",profitBg="rgba(214,57,57,0.14)")}catch(_){}makeChart(chartId,labels,[{label:"Revenue",data:revenue,borderColor:DASH_ACCENT,backgroundColor:DASH_ACCENT_LIGHT,fill:!0,borderWidth:2},{label:"Cost",data:cost,borderColor:"#ef4444",backgroundColor:"rgba(239,68,68,0.14)",fill:!0,borderWidth:2},{label:"Profit",data:profit,borderColor:profitColor,backgroundColor:profitBg,fill:!0,borderWidth:2}],{currency:!0,chartType:overviewChartType,height:chartHeight,legendPosition:"bottom",showLegend:!1,forceTooltip:!0,tooltipShared:!0,tooltipIntersect:!1,tooltipFollowCursor:!0,markerSize:3})}function overviewCardLocalStorageKey(chartId){var id=(null==chartId?"":String(chartId)).trim();return id?"kexo:overview-card-cache:"+id:""}function renderOverviewMiniLegend(chartId,labels,colors){var id=(null==chartId?"":String(chartId)).trim();if(id){var host=null;try{host=document.querySelector('[data-overview-legend="'+id+'"]')}catch(_){host=null}if(host){var list=Array.isArray(labels)?labels:[];if(list.length){for(var cols=Array.isArray(colors)?colors:[],html="",i=0;i<list.length;i++){var lbl=null!=list[i]?String(list[i]).trim():"";if(lbl)html+='<span class="kexo-overview-mini-legend-item"><span class="kexo-overview-mini-legend-swatch" data-kexo-swatch-bg="'+escapeHtml((null!=cols[i]?String(cols[i]):"")||"#94a3b8")+'"></span>'+escapeHtml(lbl)+"</span>"}host.innerHTML=html;try{host.querySelectorAll("[data-kexo-swatch-bg]").forEach(function(sw){if(sw&&sw.style&&sw.getAttribute){var bg=String(sw.getAttribute("data-kexo-swatch-bg")||"").trim();bg&&(sw.style.background=bg)}})}catch(_){}try{scheduleOverviewHeightSync()}catch(_){}}else{host.innerHTML="";try{scheduleOverviewHeightSync()}catch(_){}}}}}function shouldLazyRenderOverviewChart(chartId){return!(!OVERVIEW_LAZY_CHART_IDS||!OVERVIEW_LAZY_CHART_IDS[chartId])}function observeOverviewChartIfLazy(chartId){if(shouldLazyRenderOverviewChart(chartId)&&(overviewLazyObserver||"undefined"==typeof IntersectionObserver||(overviewLazyObserver=new IntersectionObserver(function(entries){entries.forEach(function(entry){if(entry&&entry.target&&entry.target.id){var chartId=String(entry.target.id);if(overviewLazyVisible[chartId]=!!entry.isIntersecting,entry.isIntersecting){var pending=overviewLazyPending&&overviewLazyPending[chartId]?overviewLazyPending[chartId]:null;if(pending){try{delete overviewLazyPending[chartId]}catch(_){}var run=function(){try{renderOverviewCardById(chartId,pending.payload,Object.assign({},pending.options||{},{forceRender:!0,reason:"lazy-visible"}))}catch(_){}};"function"==typeof requestIdleCallback?requestIdleCallback(run,{timeout:1200}):setTimeout(run,0)}}}})},{root:null,rootMargin:"120px 0px",threshold:.1})),overviewLazyObserver))try{var el=document.getElementById(chartId);el&&overviewLazyObserver.observe(el)}catch(_){}}function renderOverviewCardById(chartId,payload,options){var opts=options&&"object"==typeof options?options:{},reason=null!=opts.reason?String(opts.reason):"",rk=null!=opts.rangeKey?normalizeOverviewCardRangeKey(opts.rangeKey,"7d"):getOverviewCardRange(chartId,"7d");if(observeOverviewChartIfLazy(chartId),opts.forceRender||!shouldLazyRenderOverviewChart(chartId)||function(chartId){if(!shouldLazyRenderOverviewChart(chartId))return!0;if(null!=overviewLazyVisible[chartId])return!!overviewLazyVisible[chartId];try{var el=document.getElementById(chartId);if(!el||!el.getBoundingClientRect)return!1;var rect=el.getBoundingClientRect(),h=window&&window.innerHeight?window.innerHeight:0;return rect.bottom>0&&rect.top<h}catch(_){return!1}}(chartId)){
// NOTE: Avoid JSON stringifying the full /api/dashboard-series payload. Build a small sig from rendered data.
var styleSig=function(chartId){try{var key=String(chartId||"");return JSON.stringify({enabled:isChartEnabledByUiConfig(key,!0),mode:chartModeFromUiConfig(key,""),colors:chartColorsFromUiConfig(key,[]),style:chartStyleFromUiConfig(key)||{}})||""}catch(_){return""}}(chartId),payloadSig="",doRender=null;if("dash-chart-finishes-30d"===chartId){var finishesRows=payload&&Array.isArray(payload.finishes)?payload.finishes:payload&&payload.finishes&&Array.isArray(payload.finishes.finishes)?payload.finishes.finishes:[],finishPairs=[];(finishesRows||[]).forEach(function(row){if(row&&"object"==typeof row){var label="";null!=row.label&&String(row.label).trim()?label=String(row.label).trim():null!=row.finish&&String(row.finish).trim()?label=String(row.finish).trim():null!=row.key&&String(row.key).trim()&&(label=String(row.key).trim().replace(/_/g," "));var val=normalizeOverviewMetric(null!=row.revenueGbp?row.revenueGbp:row.revenue);!label||val<=0||finishPairs.push({label:label,value:val})}}),finishPairs.sort(function(a,b){return(b.value||0)-(a.value||0)});var topFinishes=finishPairs.slice(0,5),finishLabels=topFinishes.map(function(p){return p.label}),finishValues=topFinishes.map(function(p){return p.value}),fallbackColors=["#f59e34","#94a3b8","#8b5cf6","#4b94e4","#3eb3ab"],colors=chartColorsFromUiConfig(chartId,fallbackColors);payloadSig=JSON.stringify({labels:finishLabels,values:finishValues,rk:rk})||"",doRender=function(){var finishesOpts={colors:colors,valueFormatter:function(v){return fmtGbp(normalizeOverviewMetric(v))||"—"},height:180},finishesMode=String(chartModeFromUiConfig(chartId,"radialbar")||"radialbar").trim().toLowerCase();finishesMode=validateChartType(chartId,finishesMode,"radialbar"),finishLabels.length&&finishValues.length?"radialbar"===finishesMode?(renderOverviewFinishesRadialBar(chartId,finishLabels,finishValues,finishesOpts),renderOverviewMiniLegend(chartId,finishLabels,colors)):"bar"===finishesMode||"bar-horizontal"===finishesMode||"bar-distributed"===finishesMode?(renderOverviewFinishesBarChart(chartId,finishLabels,finishValues,Object.assign({},finishesOpts,{horizontal:"bar-horizontal"===finishesMode})),renderOverviewMiniLegend(chartId,[],[])):"area"===finishesMode||"line"===finishesMode||"multi-line-labels"===finishesMode?(makeChart(chartId,finishLabels,[{label:"Revenue",data:finishValues,borderColor:colors&&colors[0]||DASH_ACCENT,backgroundColor:colors&&colors[0]?colors[0]+"33":DASH_ACCENT_LIGHT,fill:"area"===finishesMode,borderWidth:2}],{currency:!0,chartType:finishesMode,height:180}),renderOverviewMiniLegend(chartId,finishLabels,colors)):(renderOverviewPieChart(chartId,finishLabels,finishValues,{colors:colors,valueFormatter:finishesOpts.valueFormatter,height:finishesOpts.height,donut:"donut"===finishesMode}),renderOverviewMiniLegend(chartId,finishLabels,colors)):(renderOverviewChartEmpty(chartId,"No finishes data"),renderOverviewMiniLegend(chartId,[],[]))}}else if("dash-chart-devices-30d"===chartId){var deviceRows=payload&&payload.devices&&Array.isArray(payload.devices.rows)?payload.devices.rows:[],agg={ios:{sessions:0,orders:0,revenue:0},android:{sessions:0,orders:0,revenue:0},windows:{sessions:0,orders:0,revenue:0},mac:{sessions:0,orders:0,revenue:0},linux:{sessions:0,orders:0,revenue:0}};(deviceRows||[]).forEach(function(d){d&&Array.isArray(d.platforms)&&(d.platforms||[]).forEach(function(p){var key=p&&null!=p.platform?String(p.platform).trim().toLowerCase():"";key&&agg[key]&&(agg[key].sessions+=normalizeOverviewMetric(p.sessions),agg[key].orders+=normalizeOverviewMetric(p.orders),agg[key].revenue+=normalizeOverviewMetric(p.revenue_gbp))})});var platforms=[];["ios","android","windows","mac","linux"].forEach(function(k){var a=agg[k];if(a){var s=Math.max(0,Math.round(normalizeOverviewMetric(a.sessions))),o=Math.max(0,Math.round(normalizeOverviewMetric(a.orders))),r=Math.round(100*normalizeOverviewMetric(a.revenue))/100;(s>0||o>0||r>0)&&platforms.push({platform:k,label:platformLabelForKey(k),sessions:s,orders:o,revenue_gbp:r})}}),payloadSig=JSON.stringify(platforms.map(function(r){return[String(r.platform||""),normalizeOverviewMetric(r.sessions),normalizeOverviewMetric(r.orders),normalizeOverviewMetric(r.revenue_gbp)]}).concat([rk]))||"",doRender=function(){var fallbackColors2=["#4b94e4","#3eb3ab","#f59e34","#8b5cf6","#ef4444"],devicesColors=chartColorsFromUiConfig(chartId,fallbackColors2),devicesOpts={colors:devicesColors,height:180};try{var legendEl=document.getElementById(chartId)&&document.getElementById(chartId).parentElement?document.getElementById(chartId).parentElement.parentElement.querySelector('[data-overview-legend="'+chartId+'"]'):null;legendEl&&(legendEl.innerHTML="")}catch(_){}if(!platforms.length)return renderOverviewChartEmpty(chartId,"No device data"),void clearOverviewDevicesYIcons(chartId);var devicesMode=String(chartModeFromUiConfig(chartId,"bar-horizontal")||"bar-horizontal").trim().toLowerCase();if("bar-horizontal"===(devicesMode=validateChartType(chartId,devicesMode,"bar-horizontal"))||"bar"===devicesMode||"bar-distributed"===devicesMode)renderOverviewDevicesHorizontalBar(chartId,platforms,Object.assign({},devicesOpts,{horizontal:"bar-horizontal"===devicesMode}));else if("line"===devicesMode||"area"===devicesMode||"multi-line-labels"===devicesMode){var labels=platforms.map(function(p){return p&&p.label?String(p.label):""}),values=platforms.map(function(p){return p&&Number.isFinite(Number(p.sessions))?Number(p.sessions):0}),orders=platforms.map(function(p){return p&&Number.isFinite(Number(p.orders))?Number(p.orders):0}),revenues=platforms.map(function(p){return p&&Number.isFinite(Number(p.revenue_gbp))?Number(p.revenue_gbp):0}),keys=platforms.map(function(p){return p&&null!=p.platform?String(p.platform):""});makeChart(chartId,labels,[{label:"Sessions",data:values,borderColor:devicesColors&&devicesColors[0]||DASH_BLUE,backgroundColor:devicesColors&&devicesColors[0]?devicesColors[0]+"33":DASH_BLUE_LIGHT,fill:"area"===devicesMode,borderWidth:2}],{chartType:devicesMode,height:180,tooltipCustom:function(tip){var idx=tip&&null!=tip.dataPointIndex?tip.dataPointIndex:-1,name=idx>=0&&idx<labels.length?labels[idx]:"",sess=idx>=0&&idx<values.length?values[idx]:0,ord=idx>=0&&idx<orders.length?orders[idx]:0,rev=idx>=0&&idx<revenues.length?revenues[idx]:0,pKey=idx>=0&&idx<keys.length?keys[idx]:"",crStr=sess>0?(ord/sess*100).toFixed(1)+"%":"—";return'<div class="kexo-tooltip-card p-2"><div class="fw-semibold d-flex align-items-center gap-2">'+platformIconHtmlForKey(pKey,name)+escapeHtml(name||"")+"</div><div>Sessions: "+escapeHtml(fmtNum(sess))+"</div><div>Orders: "+escapeHtml(fmtNum(ord))+"</div><div>Conversion: "+escapeHtml(crStr)+"</div><div>Revenue: "+escapeHtml(fmtGbp(normalizeOverviewMetric(rev))||"—")+"</div></div>"}}),clearOverviewDevicesYIcons(chartId)}else renderOverviewDevicesHorizontalBar(chartId,platforms,Object.assign({},devicesOpts,{horizontal:!0}))}}else if("dash-chart-attribution-30d"===chartId){try{var rows=payload&&payload.attribution&&Array.isArray(payload.attribution.rows)?payload.attribution.rows:payload&&payload.attribution&&payload.attribution.attribution&&Array.isArray(payload.attribution.attribution.rows)?payload.attribution.attribution.rows:[];payloadSig=JSON.stringify({rk:rk,n:rows&&rows.length?rows.length:0})||""}catch(_){payloadSig=String(rk)}doRender=function(){renderOverviewAttributionChart(payload)}}else{if("dash-chart-overview-30d"!==chartId)return;try{var cur=payload&&payload.seriesComparison&&payload.seriesComparison.current?payload.seriesComparison.current:null,labelsYmd=cur&&Array.isArray(cur.labelsYmd)?cur.labelsYmd:[];payloadSig=JSON.stringify({rk:rk,labels:labelsYmd})||""}catch(_){payloadSig=String(rk)}doRender=function(){renderOverviewRevenueCostChart(payload)}}var sig=payloadSig+"|style:"+styleSig;"resize"!==reason&&!opts.forceRender&&sig&&overviewCardPayloadSignature[chartId]&&sig===overviewCardPayloadSignature[chartId]||(overviewCardPayloadSignature[chartId]=sig,"function"==typeof doRender&&doRender(),scheduleOverviewHeightSync())}else overviewLazyPending[chartId]={payload:payload,options:{rangeKey:rk}}}function safeYmdAddDays(ymd,deltaDays){var d="number"==typeof deltaDays&&Number.isFinite(deltaDays)?deltaDays:Number(deltaDays);if(!Number.isFinite(d)||!ymd)return null;try{return ymdAddDays(ymd,d)}catch(_){}var m=String(ymd).match(/^(\d{4})-(\d{2})-(\d{2})$/);if(!m)return null;try{var dt=new Date(Date.UTC(parseInt(m[1],10),parseInt(m[2],10)-1,parseInt(m[3],10)));return dt.setUTCDate(dt.getUTCDate()+d),dt.toISOString().slice(0,10)}catch(_){return null}}function buildOverviewCardFetchUrl(chartId,rangeKey,force,stamp,shop){var id=(null==chartId?"":String(chartId)).trim(),rk=normalizeOverviewCardRangeKey(rangeKey,"7d");if("dash-chart-overview-30d"===id)return function(rangeKey,force,stamp){var rk=normalizeOverviewCardRangeKey(rangeKey,"7d"),url="/api/business-snapshot?mode=range",isSingleDay="today"===rk||"yesterday"===rk||/^d:\d{4}-\d{2}-\d{2}$/.test(rk),todayYmd=ymdNowInTz();if("7d"===rk)url+="&preset=last_7_days";else if("30d"===rk)url+="&preset=last_30_days";else if("month"===rk)url+="&preset=this_month";else if("3d"===rk&&todayYmd){var since3=safeYmdAddDays(todayYmd,-2);url+=since3?"&preset=custom&since="+encodeURIComponent(since3)+"&until="+encodeURIComponent(todayYmd):"&preset=last_7_days"}else if("14d"===rk&&todayYmd){var since14=safeYmdAddDays(todayYmd,-13);url+=since14?"&preset=custom&since="+encodeURIComponent(since14)+"&until="+encodeURIComponent(todayYmd):"&preset=last_7_days"}else{var since=null,until=null;if("today"===rk)until=since=todayYmd;else if("yesterday"===rk){var yd=todayYmd?safeYmdAddDays(todayYmd,-1):null;since=yd,until=yd}else if(/^d:\d{4}-\d{2}-\d{2}$/.test(rk))since=rk.slice(2),until=rk.slice(2);else{var m=rk.match(/^r:(\d{4}-\d{2}-\d{2}):(\d{4}-\d{2}-\d{2})$/);m&&m[1]&&m[2]&&(since=m[1],until=m[2],m[1]===m[2]&&(isSingleDay=!0))}url+=since&&until?"&preset=custom&since="+encodeURIComponent(String(since))+"&until="+encodeURIComponent(String(until)):"&preset=last_7_days"}return isSingleDay&&(url+="&granularity=hour"),force&&(url+="&force=1&_="+encodeURIComponent(String(stamp||Date.now()))),url}(rk,force,stamp);var url="";if("dash-chart-finishes-30d"===id)url="/api/shopify-finishes?range="+encodeURIComponent(rk),shop&&(url+="&shop="+encodeURIComponent(String(shop)));else if("dash-chart-devices-30d"===id)url="/api/devices/report?range="+encodeURIComponent(rk);else{if("dash-chart-attribution-30d"!==id)return null;url="/api/attribution/report?range="+encodeURIComponent(rk)}return force&&(url+="&force=1&_="+encodeURIComponent(String(stamp||Date.now()))),url}function fetchOverviewCardData(chartId,options){var opts=options&&"object"==typeof options?options:{},force=!!opts.force,renderIfFresh=!!opts.renderIfFresh,id=(null==chartId?"":String(chartId)).trim();if(!id)return Promise.resolve(null);var rk=normalizeOverviewCardRangeKey(null!=opts.rangeKey?opts.rangeKey:dashRangeKeyFromDateRange(),"7d"),shop="dash-chart-finishes-30d"===id?getShopForSales():null,shopKey=shop||"__no_shop__",entry=overviewCardCache&&overviewCardCache[id]?overviewCardCache[id]:null;if(!force&&entry&&entry.payload&&entry.fetchedAt&&Date.now()-entry.fetchedAt<12e4&&entry.rangeKey===rk&&("dash-chart-finishes-30d"!==id||entry.shopKey===shopKey)){if(renderIfFresh)try{renderOverviewCardById(id,entry.payload,{reason:"fresh-cache",rangeKey:rk})}catch(_){}return Promise.resolve(entry.payload)}if(overviewCardInFlight[id]&&!force)return overviewCardInFlight[id];entry&&entry.payload||renderOverviewChartLoading(id,"dash-chart-overview-30d"===id?"Loading revenue & cost…":"Loading…");var stamp=Date.now(),url=buildOverviewCardFetchUrl(id,rk,force,stamp,shop);if(!url)return Promise.resolve(null);var timeoutMs="dash-chart-overview-30d"===id?3e4:25e3;return overviewCardInFlight[id]=function(url,force,timeoutMs){return fetchWithTimeout(url,{credentials:"same-origin",cache:force?"no-store":"default"},timeoutMs||25e3).then(function(r){if(!r){var e0=new Error("No response");throw e0.url=url,e0}if(!r.ok){var e1=new Error("Request failed ("+String(r.status||"")+")");e1.url=url,e1.status=r.status;try{e1.contentType=r.headers&&r.headers.get("content-type")||""}catch(_){}throw e1}return r.json().catch(function(jsonErr){var e2=new Error("Invalid JSON");throw e2.url=url,e2.status=r.status,e2.cause=jsonErr,e2})})}(url,force,timeoutMs).then(function(data){if(!data)return null;overviewCardCache[id]={rangeKey:rk,fetchedAt:Date.now(),payload:data,shopKey:shopKey};try{renderOverviewCardById(id,data,{reason:force?"force-fetch":"fetch",rangeKey:rk,forceRender:!0})}catch(_){}return overviewMiniFetchedAt=Date.now(),
// Mobile reliability: persist the Overview revenue+cost snapshot so transient API failures
// don't blank out the card.
"dash-chart-overview-30d"===id&&function(chartId,rangeKey,payload){try{var key=overviewCardLocalStorageKey(chartId);if(!key)return;localStorage.setItem(key,JSON.stringify({fetchedAt:Date.now(),rangeKey:String(rangeKey||""),payload:payload||null}))}catch(_){}}(id,rk,data),data}).catch(function(err){try{"function"==typeof window.kexoCaptureError&&window.kexoCaptureError(err,{context:"dashboardOverviewCard",chartId:id,page:PAGE})}catch(_){}var cached=overviewCardCache&&overviewCardCache[id]?overviewCardCache[id]:null;if(cached&&cached.payload&&cached.rangeKey===rk){try{renderOverviewCardById(id,cached.payload,{reason:"error-cache",rangeKey:rk,forceRender:!0})}catch(_){}return cached.payload}
// Fallback: try localStorage cache (helps on mobile flakiness).
var ls="dash-chart-overview-30d"===id?function(chartId,maxAgeMs){try{var key=overviewCardLocalStorageKey(chartId);if(!key)return null;var raw=localStorage.getItem(key);if(!raw)return null;var obj=JSON.parse(raw);if(!obj||"object"!=typeof obj)return null;var ts=Number(obj.fetchedAt);if(!Number.isFinite(ts)||ts<=0)return null;var age=Date.now()-ts,ttl=Number.isFinite(Number(maxAgeMs))?Number(maxAgeMs):216e5;return age<0||age>ttl?null:obj}catch(_){return null}}(id,432e5):null;if(ls&&ls.payload){try{renderOverviewCardById(id,ls.payload,{reason:"error-local-cache",rangeKey:rk,forceRender:!0})}catch(_){}return ls.payload}var status=err&&null!=err.status?Number(err.status):NaN;if(!Number.isFinite(status))try{var mm=(err&&err.message?String(err.message):"").match(/\((\d{3})\)/);mm&&mm[1]&&(status=Number(mm[1]))}catch(_){}var msg="Failed to load";401===status||403===status?msg="Session expired":status>=500&&status<=599?msg="Server error":err&&"AbortError"===err.name&&(msg="Timed out");try{renderOverviewChartEmpty(id,msg)}catch(_){}return null}).finally(function(){overviewCardInFlight[id]=null}),overviewCardInFlight[id]}function bindOverviewCardUiOnce(){if(!overviewCardUiBound){overviewCardUiBound=!0;try{bindDashDocumentClickOnce()}catch(_){}}}function renderDashboard(data){if(data){var allSeries=data.series||[],series=allSeries,chartSeries=allSeries,el=function(id){return document.getElementById(id)},sparklineSeries=(data.summary,sumField(series,"revenue"),sumField(series,"orders"),sumField(series,"sessions"),avgField(series,"convRate"),avgField(series,"aov"),avgField(series,"bounceRate"),sumField(series,"adSpend"),getSparklineSeries(chartSeries));chartSeries.length<2&&(!sparklineHistorySeriesCache||sparklineHistorySeriesCache.length<2)&&ensureSparklineHistorySeries().then(function(historySeries){if(historySeries&&!(historySeries.length<2))if(dashCache&&dashLastRangeKey===dashRangeKeyFromDateRange())try{renderDashboard(dashCache)}catch(_){}else try{renderCondensedSparklines(historySeries)}catch(_){}}).catch(function(){});var kpiDataForTone=null;try{kpiDataForTone=getKpiData()}catch(_){kpiDataForTone=null}var kpiRangeForTone=null;try{kpiRangeForTone=getStatsRange()}catch(_){kpiRangeForTone=null}var dataObj,rangeKey,br,r,v,compareTone=kpiDataForTone&&kpiDataForTone.compare?kpiDataForTone.compare:null,currentRevenueTone=numFromRangeMap(kpiDataForTone,"sales",kpiRangeForTone),currentProfitTone=numFromRangeMap(kpiDataForTone,"profit",kpiRangeForTone),currentOrdersTone=numFromRangeMap(kpiDataForTone,"convertedCount",kpiRangeForTone),currentSessionsTone=(rangeKey=kpiRangeForTone,br=(dataObj=kpiDataForTone)&&dataObj.trafficBreakdown?dataObj.trafficBreakdown:null,r=br&&br[rangeKey]?br[rangeKey]:null,"number"==typeof(v=r&&"number"==typeof r.human_sessions?r.human_sessions:null)&&Number.isFinite(v)?v:null),currentConvTone=numFromRangeMap(kpiDataForTone,"conversion",kpiRangeForTone),currentVpvTone=numFromRangeMap(kpiDataForTone,"vpv",kpiRangeForTone),currentReturningTone=numFromRangeMap(kpiDataForTone,"returningCustomerCount",kpiRangeForTone),currentAovTone=numFromRangeMap(kpiDataForTone,"aov",kpiRangeForTone),currentBounceTone=numFromRangeMap(kpiDataForTone,"bounce",kpiRangeForTone),currentRoasTone=numFromRangeMap(kpiDataForTone,"roas",kpiRangeForTone),profitKpiAllowed=!(!kpiDataForTone||!0!==kpiDataForTone.profitKpiAllowed),compareRevenueTone=compareTone&&"number"==typeof compareTone.sales?compareTone.sales:null,compareProfitTone=compareTone&&"number"==typeof compareTone.profit?compareTone.profit:null,compareOrdersTone=compareTone&&"number"==typeof compareTone.convertedCount?compareTone.convertedCount:null,compareSessionsTone=compareTone&&compareTone.trafficBreakdown&&"number"==typeof compareTone.trafficBreakdown.human_sessions?compareTone.trafficBreakdown.human_sessions:null,compareConvTone=compareTone&&"number"==typeof compareTone.conversion?compareTone.conversion:null,compareVpvTone=compareTone&&"number"==typeof compareTone.vpv?compareTone.vpv:null,compareReturningTone=compareTone&&"number"==typeof compareTone.returningCustomerCount?compareTone.returningCustomerCount:null,compareAovTone=compareTone&&"number"==typeof compareTone.aov?compareTone.aov:null,compareBounceTone=compareTone&&"number"==typeof compareTone.bounce?compareTone.bounce:null,compareRoasTone=compareTone&&"number"==typeof compareTone.roas?compareTone.roas:null,extrasTone=kpiExpandedExtrasRange===kpiRangeForTone&&kpiExpandedExtrasCache||null,revenueHistorySpark=(extrasTone&&"number"==typeof extrasTone.itemsSold&&extrasTone.itemsSold,extrasTone&&extrasTone.compare&&"number"==typeof extrasTone.compare.itemsSold&&extrasTone.compare.itemsSold,extrasTone&&"number"==typeof extrasTone.ordersFulfilled&&extrasTone.ordersFulfilled,extrasTone&&extrasTone.compare&&"number"==typeof extrasTone.compare.ordersFulfilled&&extrasTone.compare.ordersFulfilled,extrasTone&&"number"==typeof extrasTone.returns&&extrasTone.returns,extrasTone&&extrasTone.compare&&"number"==typeof extrasTone.compare.returns&&extrasTone.compare.returns,extrasTone&&"number"==typeof extrasTone.cogs&&extrasTone.cogs,extrasTone&&extrasTone.compare&&"number"==typeof extrasTone.compare.cogs&&extrasTone.compare.cogs,sparklineSeries.map(function(d){return d.revenue})),sessionsHistorySpark=sparklineSeries.map(function(d){return d.sessions}),ordersHistorySpark=sparklineSeries.map(function(d){return d.orders}),returningHistorySpark=sparklineSeries.map(function(d){return d.returningCustomerOrders||0}),convHistorySpark=sparklineSeries.map(function(d){return d.convRate}),vpvHistorySpark=sparklineSeries.map(function(d){var r=d&&"number"==typeof d.revenue?d.revenue:null,s=d&&"number"==typeof d.sessions?d.sessions:null;return null!=s&&s>0&&null!=r?r/s:null}),aovHistorySpark=sparklineSeries.map(function(d){return d.aov}),bounceHistorySpark=sparklineSeries.map(function(d){return d.bounceRate}),itemsHistorySpark=sparklineSeries.map(function(d){return d.units||0}),roasHistorySpark=sparklineSeries.map(function(d){var spend=d&&"number"==typeof d.adSpend?d.adSpend:0,rev=d&&"number"==typeof d.revenue?d.revenue:0;return spend>0?rev/spend:0}),profitHistorySpark=profitKpiAllowed&&kpiDataForTone&&Array.isArray(kpiDataForTone.profitSparkline)?kpiDataForTone.profitSparkline:null,revenueSpark=sparkSeriesFromCompare(0,0,revenueHistorySpark),sessionsSpark=sparkSeriesFromCompare(0,0,sessionsHistorySpark),ordersSpark=sparkSeriesFromCompare(0,0,ordersHistorySpark),returningSpark=sparkSeriesFromCompare(0,0,returningHistorySpark),convSpark=sparkSeriesFromCompare(0,0,convHistorySpark),vpvSpark=sparkSeriesFromCompare(0,0,vpvHistorySpark),aovSpark=sparkSeriesFromCompare(0,0,aovHistorySpark),bounceSpark=sparkSeriesFromCompare(0,0,bounceHistorySpark),itemsSpark=sparkSeriesFromCompare(0,0,itemsHistorySpark),roasSpark=sparkSeriesFromCompare(0,0,roasHistorySpark),profitSpark=profitKpiAllowed?sparkSeriesFromCompare(0,0,profitHistorySpark):[],primaryLen=revenueSpark.length;if(profitSpark&&profitSpark.length>=2&&profitSpark.length!==primaryLen){var alignedProfitSpark=alignCompareToPrimary(profitSpark,primaryLen);alignedProfitSpark&&(profitSpark=alignedProfitSpark)}if(ensureDashboardCompareSeries(getKpiData()).then(function(compareSeries){var cmp=compareSeries,revenueSparkCompare=compareFromCache(cmp,primaryLen,function(d){return d.revenue||0}),sessionsSparkCompare=compareFromCache(cmp,primaryLen,function(d){return d.sessions||0}),ordersSparkCompare=compareFromCache(cmp,primaryLen,function(d){return d.orders||0}),returningSparkCompare=compareFromCache(cmp,primaryLen,function(d){return d.returningCustomerOrders||0}),convSparkCompare=compareFromCache(cmp,primaryLen,function(d){return null!=d.convRate?d.convRate:0}),vpvSparkCompare=compareFromCache(cmp,primaryLen,function(d){var r=d&&"number"==typeof d.revenue?d.revenue:null,s=d&&"number"==typeof d.sessions?d.sessions:null;return null!=s&&s>0&&null!=r?r/s:0}),aovSparkCompare=compareFromCache(cmp,primaryLen,function(d){return null!=d.aov?d.aov:0}),bounceSparkCompare=compareFromCache(cmp,primaryLen,function(d){return null!=d.bounceRate?d.bounceRate:0}),roasSparkCompare=null;cmp&&cmp.length>=2&&(roasSparkCompare=alignCompareToPrimary(cmp.map(function(d){var spend=d&&"number"==typeof d.adSpend?d.adSpend:0,rev=d&&"number"==typeof d.revenue?d.revenue:0;return spend>0?rev/spend:0}),primaryLen));var itemsSparkCompare=compareFromCache(cmp,primaryLen,function(d){return d.units||0}),profitSparkCompare=null;try{var profitCmpRaw=profitKpiAllowed&&kpiDataForTone&&Array.isArray(kpiDataForTone.profitSparklineCompare)?kpiDataForTone.profitSparklineCompare:null;profitSparkCompare=profitCmpRaw?alignCompareToPrimary(profitCmpRaw,primaryLen):null}catch(_){profitSparkCompare=null}if(renderSparkline("dash-revenue-sparkline",revenueSpark,sparkToneFromCompare(currentRevenueTone,compareRevenueTone,!1),revenueSparkCompare,"zero"),renderSparkline("dash-sessions-sparkline",sessionsSpark,sparkToneFromCompare(currentSessionsTone,compareSessionsTone,!1),sessionsSparkCompare,"zero"),renderSparkline("dash-orders-sparkline",ordersSpark,sparkToneFromCompare(currentOrdersTone,compareOrdersTone,!1),ordersSparkCompare,"zero"),renderSparkline("dash-returning-sparkline",returningSpark,sparkToneFromCompare(currentReturningTone,compareReturningTone,!1),returningSparkCompare,"zero"),renderSparkline("dash-conv-sparkline",convSpark,sparkToneFromCompare(currentConvTone,compareConvTone,!1),convSparkCompare,"percent"),renderSparkline("dash-vpv-sparkline",vpvSpark,sparkToneFromCompare(currentVpvTone,compareVpvTone,!1),vpvSparkCompare,"zero"),renderSparkline("dash-aov-sparkline",aovSpark,sparkToneFromCompare(currentAovTone,compareAovTone,!1),aovSparkCompare,"zero"),renderSparkline("dash-bounce-sparkline",bounceSpark,sparkToneFromCompare(currentBounceTone,compareBounceTone,!0),bounceSparkCompare,"percent"),renderSparkline("dash-roas-sparkline",roasSpark,sparkToneFromCompare(currentRoasTone,compareRoasTone,!1),roasSparkCompare,"zero"),profitKpiAllowed&&profitSpark&&profitSpark.length)renderSparkline("dash-profit-sparkline",profitSpark,sparkToneFromCompare(currentProfitTone,compareProfitTone,!1),profitSparkCompare,"symmetric");else{var ps=el("dash-profit-sparkline");ps&&(ps.innerHTML="")}renderSparkline("dash-items-sparkline",itemsSpark,DASHBOARD_NEUTRAL_TONE_HEX,itemsSparkCompare,"zero"),renderDashboardKpiSparkBucketLabels(sparklineSeries);
// COGS / Fulfilled / Returns sparklines come from `/api/kpis-expanded-extra` (bucketed per range).
try{var extraSpark=extrasTone&&extrasTone.spark&&"object"==typeof extrasTone.spark?extrasTone.spark:null,extraCmpSpark=extrasTone&&extrasTone.compare&&extrasTone.compare.spark&&"object"==typeof extrasTone.compare.spark?extrasTone.compare.spark:null,cogsArr=extraSpark&&Array.isArray(extraSpark.cogs)?extraSpark.cogs:null,fulfilledArr=extraSpark&&Array.isArray(extraSpark.fulfilled)?extraSpark.fulfilled:null,returnsArr=extraSpark&&Array.isArray(extraSpark.returns)?extraSpark.returns:null,cogsCmpArr=extraCmpSpark&&Array.isArray(extraCmpSpark.cogs)?extraCmpSpark.cogs:null,fulfilledCmpArr=extraCmpSpark&&Array.isArray(extraCmpSpark.fulfilled)?extraCmpSpark.fulfilled:null,returnsCmpArr=extraCmpSpark&&Array.isArray(extraCmpSpark.returns)?extraCmpSpark.returns:null;if(cogsArr&&cogsArr.length)renderSparkline("dash-cogs-sparkline",cogsArr,DASHBOARD_NEUTRAL_TONE_HEX,cogsCmpArr,"zero");else{var cs=el("dash-cogs-sparkline");cs&&(cs.innerHTML="")}if(fulfilledArr&&fulfilledArr.length)renderSparkline("dash-fulfilled-sparkline",fulfilledArr,DASHBOARD_NEUTRAL_TONE_HEX,fulfilledCmpArr,"zero");else{var fs=el("dash-fulfilled-sparkline");fs&&(fs.innerHTML="")}if(returnsArr&&returnsArr.length)renderSparkline("dash-returns-sparkline",returnsArr,DASHBOARD_NEUTRAL_TONE_HEX,returnsCmpArr,"symmetric");else{var rs=el("dash-returns-sparkline");rs&&(rs.innerHTML="")}}catch(_){}try{renderCondensedSparklines(sparklineSeries)}catch(_){}}),el("dash-top-products-body")){var products=data.topProducts||[],prodPageSize=getTableRowsPerPage("dash-top-products","dashboard"),prodPages=Math.max(1,Math.ceil(products.length/prodPageSize));dashTopProductsPage=clampPage(dashTopProductsPage,prodPages),updateCardPagination("dash-top-products",dashTopProductsPage,prodPages);var prodStart=(dashTopProductsPage-1)*prodPageSize,productsPageRows=products.slice(prodStart,prodStart+prodPageSize),prodTotal=productsPageRows.reduce(function(acc,p){return acc+(Number(p&&p.revenue)||0)},0)||0,mainBase=getMainBaseUrl&&getMainBaseUrl(),prodRows=productsPageRows.map(function(p){var rev=Number(p&&p.revenue)||0,pct=prodTotal>0?rev/prodTotal*100:0,crVal=p&&"number"==typeof p.cr&&isFinite(p.cr)?p.cr:null,label=p&&p.title?String(p.title):"Unknown",handle=p&&p.handle?String(p.handle).trim().toLowerCase():"",productId=p&&p.product_id?String(p.product_id).replace(/^gid:\/\/shopify\/Product\//i,"").trim():"",productUrl=mainBase&&handle?mainBase+"/products/"+encodeURIComponent(handle):"#";return{label:label,thumbUrl:p&&p.thumb_url?String(p.thumb_url):null,valueGbp:rev,cr:crVal,pct:pct,productHandle:handle||null,productId:productId&&/^\d+$/.test(productId)?productId:null,productTitle:label,productUrl:productUrl}});renderDashTopList("dash-top-products-body",prodRows,{accentCss:"background: var(--kexo-accent-2);"})}if(el("dash-top-countries-body")){var countries=data.topCountries||[],countryPageSize=getTableRowsPerPage("dash-top-countries","dashboard"),countryPages=Math.max(1,Math.ceil(countries.length/countryPageSize));dashTopCountriesPage=clampPage(dashTopCountriesPage,countryPages),updateCardPagination("dash-top-countries",dashTopCountriesPage,countryPages);var countryStart=(dashTopCountriesPage-1)*countryPageSize,countriesPageRows=countries.slice(countryStart,countryStart+countryPageSize),countryTotal=countriesPageRows.reduce(function(acc,c){return acc+(Number(c&&c.revenue)||0)},0)||0,countryRows=countriesPageRows.map(function(c){var cc=(c&&(c.country_code||c.country)||"XX").toUpperCase();"UK"===cc&&(cc="GB");var name=countryLabelFull(cc),rev=Number(c&&c.revenue)||0,pct=countryTotal>0?rev/countryTotal*100:0,crVal=c&&"number"==typeof c.cr&&isFinite(c.cr)?c.cr:null;return{label:name,iconHtml:'<span class="kexo-dash-top-flag-wrap">'+flagImg(cc,name)+"</span>",valueGbp:rev,cr:crVal,pct:pct}});renderDashTopList("dash-top-countries-body",countryRows,{accentCss:"background: var(--kexo-accent-1);"})}!function(tableId,items,isUp){function sortTrendingRows(list){var out=Array.isArray(list)?list.slice():[];return out.sort(function(a,b){var ad=a&&Number.isFinite(Number(a.deltaRevenue))?Number(a.deltaRevenue):0,bd=b&&Number.isFinite(Number(b.deltaRevenue))?Number(b.deltaRevenue):0,byDelta=isUp?bd-ad:ad-bd;if(0!==byDelta)return byDelta;var ar=a&&Number.isFinite(Number(a.revenueNow))?Number(a.revenueNow):0,byRev=(b&&Number.isFinite(Number(b.revenueNow))?Number(b.revenueNow):0)-ar;if(0!==byRev)return byRev;var at=a&&null!=a.title?String(a.title):"",bt=b&&null!=b.title?String(b.title):"";if(at!==bt)return at<bt?-1:1;var aid=a&&null!=a.product_id?String(a.product_id):"",bid=b&&null!=b.product_id?String(b.product_id):"";return aid!==bid?aid<bid?-1:1:0}),out}if(el(tableId+"-body")){var rows=sortTrendingRows(items),pageSize=getTableRowsPerPage(tableId,"dashboard"),pages=Math.max(1,Math.ceil(rows.length/pageSize));"dash-trending"===tableId&&(dashTrendingPage=clampPage(dashTrendingPage,pages)),updateCardPagination(tableId,page="dash-trending"===tableId?dashTrendingPage:1,pages);var pageStart=(page-1)*pageSize,totalAbs=(pageRows=rows.slice(pageStart,pageStart+pageSize)).reduce(function(acc,p){return acc+Math.abs(Number(p&&p.deltaRevenue)||0)},0)||0,mainBaseTr=getMainBaseUrl&&getMainBaseUrl(),listRows=pageRows.map(function(p){var d=p&&"number"==typeof p.deltaRevenue&&isFinite(p.deltaRevenue)?p.deltaRevenue:0,absD=Math.abs(d),pct=totalAbs>0?absD/totalAbs*100:0,crVal=p&&"number"==typeof p.cr&&isFinite(p.cr)?p.cr:null,label=p&&p.title?String(p.title):"Unknown",handle=p&&p.handle?String(p.handle).trim().toLowerCase():"",productId=p&&p.product_id?String(p.product_id).replace(/^gid:\/\/shopify\/Product\//i,"").trim():"",productUrl=mainBaseTr&&handle?mainBaseTr+"/products/"+encodeURIComponent(handle):"#",valueDisplay=fmtSignedGbp(d),valueClass=d<0?"text-red":"text-green";return{label:label,thumbUrl:p&&p.thumb_url?String(p.thumb_url):null,valueDisplay:valueDisplay,valueClass:valueClass,valueGbp:d,cr:crVal,pct:pct,productHandle:handle||null,productId:productId&&/^\d+$/.test(productId)?productId:null,productTitle:label,productUrl:productUrl}});renderDashTopList(tableId+"-body",listRows,{accentCss:"background: var(--kexo-accent-3);"})}else{var t=el(tableId),tbody=t?t.querySelector("tbody"):null;if(tbody){rows=sortTrendingRows(items);var page,pagePrefix=tableId;pageSize=getTableRowsPerPage(tableId,"dashboard"),pages=Math.max(1,Math.ceil(rows.length/pageSize));"dash-trending"===tableId&&(dashTrendingPage=clampPage(dashTrendingPage,pages)),updateCardPagination(pagePrefix,page="dash-trending"===tableId?dashTrendingPage:1,pages);pageStart=(page-1)*pageSize;var pageRows=rows.slice(pageStart,pageStart+pageSize);if(rows.length){var mainBase=getMainBaseUrl();tbody.innerHTML=pageRows.map(function(p){var title=p&&p.title?String(p.title):"Unknown",handle=p&&p.handle?String(p.handle).trim().toLowerCase():"",productId=p&&p.product_id?String(p.product_id).replace(/^gid:\/\/shopify\/Product\//i,"").trim():"",productUrl=mainBase&&handle?mainBase+"/products/"+encodeURIComponent(handle):"#",titleHtml=handle||productId&&/^\d+$/.test(productId)?'<a class="kexo-product-link js-product-modal-link" href="'+escapeHtml(productUrl)+'" target="_blank" rel="noopener"'+(handle?' data-product-handle="'+escapeHtml(handle)+'"':"")+(productId&&/^\d+$/.test(productId)?' data-product-id="'+escapeHtml(productId)+'"':"")+(title?' data-product-title="'+escapeHtml(title)+'"':"")+">"+escapeHtml(title)+"</a>":escapeHtml(title),revCell="<div>"+function(r){var d=r&&"number"==typeof r.deltaRevenue&&isFinite(r.deltaRevenue)?r.deltaRevenue:0,cls=d>=0?"text-green":"text-red",pctGrowth=r&&"number"==typeof r.pctGrowth&&isFinite(r.pctGrowth)?r.pctGrowth:null,pctStr=null!=pctGrowth?pctGrowth>=999?" new":" ("+(pctGrowth>=0?"+":"")+pctGrowth+"%)":"";return'<span class="dash-trend-delta '+cls+'">'+escapeHtml(fmtSignedGbp(d)+pctStr)+"</span>"}(p)+"</div>",ordCell="<div>"+function(r){var d=r&&"number"==typeof r.deltaOrders&&isFinite(r.deltaOrders)?r.deltaOrders:0;return'<span class="dash-trend-delta '+(d>=0?"text-green":"text-red")+'">'+(d>=0?"+":"")+String(d)+"</span>"}(p)+"</div>",crCell=fmtPct(p&&("number"==typeof p.cr?p.cr:null)),vpvVal=p&&"number"==typeof p.vpv&&isFinite(p.vpv)?p.vpv:null;return'<tr><td><span class="product-cell">'+titleHtml+'</span></td><td class="text-end">'+revCell+'</td><td class="text-end">'+ordCell+'</td><td class="text-end kexo-nowrap">'+crCell+'</td><td class="text-end kexo-nowrap">'+(null!=vpvVal?fmtGbp(vpvVal):"—")+"</td></tr>"}).join("")}else tbody.innerHTML='<tr><td colspan="5" class="dash-empty">No data</td></tr>'}}}("dash-trending","up"===dashTrendingMode?data.trendingUp||[]:data.trendingDown||[],"up"===dashTrendingMode),syncTrendingCardTitleAndChevron();try{"function"==typeof window.__kexoRunStickyColumnResize&&window.__kexoRunStickyColumnResize()}catch(_){}}
// Recompute summary from current period only
function sumField(arr,field){for(var t=0,i=0;i<arr.length;i++)t+=arr[i][field]||0;return t}function avgField(arr,field){return arr.length?sumField(arr,field)/arr.length:0}
// sparkBaseline: 'zero' = include 0 baseline (revenue, sessions, orders, aov, cogs, etc.);
// 'percent' = clamp [0,100] (conversion, bounce); 'symmetric' = include 0 and allow negative (returns).
function renderSparkline(elId,dataArr,color,compareDataArr,sparkBaseline){var sparkEl=el(elId);if(sparkEl&&"undefined"!=typeof ApexCharts){dataArr.length<2&&(dataArr=1===dataArr.length?[dataArr[0],dataArr[0]]:[0,0]);var sparkCfg=getChartsKpiBundle("dashboardCards").sparkline||defaultChartsKpiSparklineConfig("dashboardCards"),sparkMode=String(sparkCfg.mode||"line").toLowerCase();"line"!==sparkMode&&"area"!==sparkMode&&"bar"!==sparkMode&&(sparkMode="line");var sparkCurve=String(sparkCfg.curve||"straight").toLowerCase();"smooth"!==sparkCurve&&"straight"!==sparkCurve&&"stepline"!==sparkCurve&&(sparkCurve="straight"),"bar"===sparkMode&&(sparkCurve="straight");var sparkHeight=Number(sparkCfg.height);Number.isFinite(sparkHeight)||(sparkHeight=50);var sparkStrokeWidth=Number(sparkCfg.strokeWidth);Number.isFinite(sparkStrokeWidth)||(sparkStrokeWidth=2.55);var showCompare=!1!==sparkCfg.showCompare,baseline="percent"===sparkBaseline||"symmetric"===sparkBaseline?sparkBaseline:"zero",nums=dataArr.map(function(v){var n="number"==typeof v?v:Number(v);return isFinite(n)?n:0});"percent"===baseline&&(nums=nums.map(function(n){return Math.max(0,Math.min(100,n))}));var compareNums=Array.isArray(compareDataArr)?compareDataArr.map(function(v){var n="number"==typeof v?v:Number(v);return isFinite(n)?n:0}):null;if("percent"===baseline&&compareNums&&(compareNums=compareNums.map(function(n){return Math.max(0,Math.min(100,n))})),compareNums&&compareNums.length<2&&(compareNums=1===compareNums.length?[compareNums[0],compareNums[0]]:null),showCompare||(compareNums=null),compareNums&&compareNums.length!==nums.length)for(compareNums.length>nums.length&&(compareNums=compareNums.slice(0,nums.length));compareNums.length<nums.length;)compareNums.push(compareNums[compareNums.length-1]||0);for(var allNums=compareNums&&compareNums.length?nums.concat(compareNums):nums.slice(),minVal=allNums[0],maxVal=allNums[0],i=1;i<allNums.length;i++)allNums[i]<minVal&&(minVal=allNums[i]),allNums[i]>maxVal&&(maxVal=allNums[i]);isFinite(minVal)||(minVal=0),isFinite(maxVal)||(maxVal=0);
// Flat/near-flat series can render as visually empty at 40px height.
// Keep a truly zero series flat/neutral; only bump non-zero flat lines.
var span=Math.abs(maxVal-minVal),allZero=span<1e-9&&allNums.every(function(v){return Math.abs(v)<1e-9});if(span<1e-9&&!allZero){var bump=0===maxVal?1:Math.max(.01,.02*Math.abs(maxVal));nums[nums.length-1]=nums[nums.length-1]+bump,minVal=Math.min(minVal,nums[nums.length-1]),maxVal=Math.max(maxVal,nums[nums.length-1]),span=Math.abs(maxVal-minVal)}var yMin=-1,yMax=1;if("percent"===baseline)yMin=0,yMax=100;else if(!allZero){var pad=Math.max(1e-6,.12*span);
// Include zero baseline for non-negative KPIs (zero) or show zero line for symmetric (returns).
if(yMin=minVal-pad,yMax=maxVal+pad,"zero"===baseline)yMin=Math.min(yMin,0),maxVal<=0&&(yMax=0+pad);else if("symmetric"===baseline)if(minVal<0&&maxVal>0){var absMax=Math.max(Math.abs(minVal),Math.abs(maxVal))+pad;yMin=-absMax,yMax=absMax}else yMin=Math.min(yMin,0),maxVal<=0&&(yMax=0+pad)}var hasCompare=!!(compareNums&&compareNums.length>=2),series=[{name:"Current",data:nums}],chartType=sparkMode;
// If the spark mode is `area` and we render a compare series, force the compare to be a line
// so it reads as a dashed reference (not a filled area).
"area"===sparkMode&&hasCompare&&(chartType="line",series[0].type="area");var key,prefix,colors=[color],strokeWidths=["bar"===sparkMode?0:sparkStrokeWidth],dashArray=[0];if(hasCompare){var compareSeries={name:"Compare",data:compareNums};"area"===sparkMode&&(compareSeries.type="line"),series.push(compareSeries);var usePrimary=!1!==sparkCfg.compareUsePrimaryColor,opacityPct=Number(sparkCfg.compareOpacity);Number.isFinite(opacityPct)||(opacityPct=50),opacityPct=Math.max(0,Math.min(100,opacityPct));var compareColor=usePrimary?function(hex,alpha){if(!hex||"string"!=typeof hex)return"rgba(0,0,0,0.5)";var raw=hex.trim(),a="number"==typeof alpha&&Number.isFinite(alpha)?Math.max(0,Math.min(1,alpha)):null;if(/^rgba?\(/i.test(raw)){var m=raw.replace(/\s+/g,"").match(/^rgba?\((\d+),(\d+),(\d+)(?:,([0-9.]+))?\)$/i);if(m){var rr=Math.max(0,Math.min(255,parseInt(m[1],10)||0)),gg=Math.max(0,Math.min(255,parseInt(m[2],10)||0)),bb=Math.max(0,Math.min(255,parseInt(m[3],10)||0)),baseA=null!=m[4]?Math.max(0,Math.min(1,parseFloat(m[4])||0)):1;return"rgba("+rr+","+gg+","+bb+","+(null!=a?a:baseA)+")"}}var h=raw.replace(/^#/,"");return 6!==h.length?"rgba(0,0,0,0.5)":"rgba("+parseInt(h.slice(0,2),16)+","+parseInt(h.slice(2,4),16)+","+parseInt(h.slice(4,6),16)+","+(null!=a?a:.5)+")"}(color,opacityPct/100):(key=String("dashboardCards"||"").trim(),prefix="dashboard","headerStrip"===key?prefix="header":"yearlySnapshot"===key&&(prefix="snapshot"),cssVarColor("--kexo-"+prefix+"-kpi-compare-line","")||cssVarColor("--kexo-kpi-compare-line","#cccccc")||"#cccccc");colors.push(compareColor),strokeWidths.push("bar"===sparkMode?0:Math.max(1,sparkStrokeWidth-.5)),dashArray.push(usePrimary?0:4)}var a,apexOpts={chart:{type:chartType,height:sparkHeight,sparkline:{enabled:!0},animations:{enabled:!1}},series:series,stroke:{show:!0,width:strokeWidths,curve:sparkCurve,lineCap:"butt",dashArray:dashArray},fill:"area"===sparkMode?{type:"gradient",gradient:{shadeIntensity:1,opacityFrom:.26,opacityTo:.04,stops:[0,100]}}:{type:"solid",opacity:1},colors:colors,yaxis:{min:yMin,max:yMax},markers:{size:0},plotOptions:"bar"===sparkMode?{bar:{columnWidth:"55%",borderRadius:2}}:{},grid:{padding:{top:0,right:2,bottom:0,left:2}},tooltip:{enabled:!0},
// ApexCharts 4.x can crash when `annotations` is explicitly set to `undefined`.
// Always provide an annotations object with empty arrays.
annotations:(a={xaxis:[],yaxis:[],points:[],texts:[],images:[]},("zero"===baseline||"symmetric"===baseline)&&yMin<=0&&yMax>=0&&a.yaxis.push({y:0,strokeDashArray:2,borderColor:"rgba(0,0,0,0.15)",borderWidth:1,opacity:.9}),a)};try{var override=sparkCfg.advancedApexOverride;isPlainObject(override)&&Object.keys(override).length&&(apexOpts=deepMergeOptions(apexOpts,override))}catch(_){}try{
// Ensure annotations arrays are always present (ApexCharts 4.x can crash otherwise),
// especially after advancedApexOverride merges.
var ann=apexOpts.annotations;ann&&"object"==typeof ann||(ann=apexOpts.annotations={}),Array.isArray(ann.xaxis)||(ann.xaxis=[]),Array.isArray(ann.yaxis)||(ann.yaxis=[]),Array.isArray(ann.points)||(ann.points=[]),Array.isArray(ann.texts)||(ann.texts=[]),Array.isArray(ann.images)||(ann.images=[])}catch(_){}var existing=dashSparkCharts[elId];if(existing&&"function"==typeof existing.updateOptions&&"function"==typeof existing.updateSeries)try{return existing.updateOptions(apexOpts,!1,!1,!1),void existing.updateSeries(series,!1)}catch(_){try{existing.destroy()}catch(_){}try{delete dashSparkCharts[elId]}catch(_){}}sparkEl.innerHTML="";var chart=new ApexCharts(sparkEl,apexOpts);chart.render(),dashSparkCharts[elId]=chart}}function sparkToneFromCompare(current,baseline,invert,fallbackDataArr){var GREEN=chartsKpiToneColor("dashboardCards","up"),RED=chartsKpiToneColor("dashboardCards","down"),NEUTRAL=chartsKpiToneColor("dashboardCards","flat"),cur="number"==typeof current&&Number.isFinite(current)?current:null,base="number"==typeof baseline&&Number.isFinite(baseline)?baseline:null;if(null==cur||null==base)return NEUTRAL;var delta=cur-base;if(invert&&(delta=-delta),Math.abs(delta)<1e-9)return NEUTRAL;var denom=Math.abs(base);if(denom>1e-9){var ratio=delta/denom;if(Math.abs(ratio)<=KPI_STABLE_RATIO)return NEUTRAL}return delta>=0?GREEN:RED}function numFromRangeMap(dataObj,keyName,rangeKey){var map=dataObj&&dataObj[keyName]?dataObj[keyName]:null,v=map&&"number"==typeof map[rangeKey]?map[rangeKey]:null;return"number"==typeof v&&Number.isFinite(v)?v:null}
// KPI card sparklines should reflect the real per-bucket series returned by `/api/dashboard-series`.
// Do NOT rescale the series to end at the headline KPI totals; that flattens yesterday/day-before views.
function sparkSeriesFromCompare(_current,_baseline,fallbackDataArr){return Array.isArray(fallbackDataArr)?fallbackDataArr.map(function(v){var n="number"==typeof v?v:Number(v);return Number.isFinite(n)?n:0}):[]}function renderDashboardKpiSparkBucketLabels(series){try{if(!Array.isArray(series)||!series.length)return;var labels=series.map(function(d,idx){var key=d&&null!=d.date?String(d.date):"";return key?/^\d{4}-\d{2}-\d{2}$/.test(key)?shortDate(key):key.indexOf(" ")>=0?function(key){var timePart=key.indexOf(" ")>=0?shortHourLabel(key):key;if(!timePart)return timePart;var m=/^0?(\d{1,2}):(\d{2})$/.exec(String(timePart).trim());return m?parseInt(m[1],10)+":"+m[2]:timePart}(key):key:String(idx+1)}),visibleIndices=new Set;if(labels.length<=6)labels.forEach(function(_,i){visibleIndices.add(i)});else for(var i=0;i<6;i++){var idx=0===i?0:5===i?labels.length-1:Math.round(i/5*(labels.length-1));visibleIndices.add(idx)}document.querySelectorAll("#dash-kpi-grid .card-body, #dash-kpi-grid-mid .card-body, #dash-kpi-grid-lower .card-body").forEach(function(bodyEl){bodyEl&&bodyEl.querySelector&&bodyEl.querySelector(".dash-kpi-sparkline-wrap")&&function(bodyEl){if(bodyEl&&bodyEl.querySelector){var wrap=bodyEl.querySelector(".dash-kpi-sparkline-wrap");if(wrap){var row=wrap.querySelector(".dash-kpi-sparkline-labels");row||((row=document.createElement("div")).className="dash-kpi-sparkline-labels",wrap.appendChild(row)),row.innerHTML=labels.map(function(t,i){return'<span class="dash-kpi-sparkline-label'+(visibleIndices.has(i)?"":" is-hidden")+'">'+escapeHtml(t)+"</span>"}).join("")}}}(bodyEl)})}catch(_){}}function alignCompareToPrimary(compareArr,primaryLen){if(!Array.isArray(compareArr)||compareArr.length<2)return null;var arr=compareArr.map(function(v){var n="number"==typeof v?v:Number(v);return Number.isFinite(n)?n:0});if(arr.length===primaryLen)return arr;if(arr.length>primaryLen)return arr.slice(0,primaryLen);for(var last=arr.length&&arr[arr.length-1]||0;arr.length<primaryLen;)arr.push(last);return arr}function compareFromCache(cache,primaryLen,extract){return!cache||!Array.isArray(cache)||cache.length<2?null:alignCompareToPrimary(cache.map(extract),primaryLen)}function fmtSignedGbp(v){var d=normalizeZeroNumber(v,.005);null==d&&(d=0);var s=fmtGbp(Math.abs(d));return d>0?"+"+s:d<0?"-"+s:s}}var _kexoScoreCache=null,dashTrendingMode="up";function syncTrendingCardTitleAndChevron(){var titleEl=document.getElementById("dash-trending-title"),toggleEl=document.getElementById("dash-trending-toggle"),iconEl=document.getElementById("dash-trending-chevron-icon");titleEl&&(titleEl.textContent="up"===dashTrendingMode?"Up":"Down"),toggleEl&&toggleEl.setAttribute("aria-label","up"===dashTrendingMode?"Switch to Trending Down":"Switch to Trending Up"),iconEl&&(iconEl.className=("up"===dashTrendingMode?"fa-solid fa-angle-down":"fa-solid fa-angle-up")+" kexo-trending-chevron")}function isElementVisiblyRendered(el){if(!el)return!1;try{var cs=window.getComputedStyle?window.getComputedStyle(el):null;if(cs&&("none"===cs.display||"hidden"===cs.visibility))return!1}catch(_){}return!0}function shouldFetchKexoScore(){var headerBtn=document.getElementById("header-kexo-score-wrap"),dashCard=document.getElementById("dash-kpi-kexo-score-card");return!(!headerBtn&&!dashCard)&&!(!isElementVisiblyRendered(headerBtn)&&!isElementVisiblyRendered(dashCard))}function fetchKexoScore(rangeKey){return(rangeKey=(null==rangeKey?"":String(rangeKey)).trim().toLowerCase())||(rangeKey="today"),shouldFetchKexoScore()?fetchWithTimeout("/api/kexo-score?range="+encodeURIComponent(rangeKey),{credentials:"same-origin",cache:"default"},15e3).then(function(r){return r&&r.ok?r.json():null}).then(function(scoreData){return scoreData&&shouldFetchKexoScore()&&(_kexoScoreCache=scoreData,function(scoreData){var dashNum=document.getElementById("dash-kpi-kexo-score"),dashRing=document.getElementById("dash-kpi-kexo-score-ring"),headerNum=document.getElementById("header-kexo-score"),headerRing=document.getElementById("header-kexo-score-ring"),score=null;scoreData&&"number"==typeof scoreData.score&&Number.isFinite(scoreData.score)&&(score=Math.max(0,Math.min(100,Number(scoreData.score))));var empty=null==score,dashText=empty?"—":formatKexoScoreNumber(score),headerText=empty?"—":String(Math.round(score)),pct=empty?"0":String(score);dashNum&&(empty?dashNum.innerHTML='<span class="kpi-mini-spinner" aria-hidden="true"></span>':dashNum.textContent=dashText);dashRing&&(dashRing.style.setProperty("--kexo-score-pct",pct),dashRing.setAttribute("data-score",pct),"svg"===dashRing.tagName&&applyKexoScoreRingSvg(dashRing,score));headerNum&&(headerNum.textContent=headerText);headerRing&&("svg"===headerRing.tagName?applyKexoScoreRingSvg(headerRing,score):(headerRing.style.setProperty("--kexo-score-pct",pct),headerRing.style.background=buildHeaderKexoScoreRingBg(score)));applyKexoScoreModalSummary(scoreData),renderKexoScoreOverviewBreakdown(scoreData)}(scoreData)),scoreData}).catch(function(){return null}):Promise.resolve(null)}function formatKexoScoreNumber(rawScore){var n=Number(rawScore);if(!Number.isFinite(n))return"—";n=Math.max(0,Math.min(100,n));var rounded=Math.round(10*n)/10;if(rounded>=100)return"100";var intRounded=Math.round(rounded);return Math.abs(rounded-intRounded)<1e-9?String(intRounded):rounded.toFixed(1).replace(/\.0$/,"")}var KEXO_RING_CIRCUMFERENCE=2*Math.PI*16,KEXO_RING_GAP=2,KEXO_RING_SEGMENT=(KEXO_RING_CIRCUMFERENCE-5*KEXO_RING_GAP)/5,KEXO_RING_SEGMENT_AND_GAP=KEXO_RING_SEGMENT+KEXO_RING_GAP,KEXO_RING_START_OFFSET=.75*KEXO_RING_CIRCUMFERENCE,KEXO_RING_COLOR_ORDER=["var(--kexo-accent-5, #ef4444)","var(--kexo-accent-4, #8b5cf6)","var(--kexo-accent-3, #f59e34)","var(--kexo-accent-1, #4b94e4)","var(--kexo-accent-2, #3eb3ab)"];function applyKexoScoreRingSvg(svg,rawScore){if(svg&&"svg"===svg.tagName){var score=Number(rawScore);Number.isFinite(score)||(score=0),score=Math.max(0,Math.min(100,score));var trackCircle=svg.querySelector(".kexo-score-ring-track");if(trackCircle){var trackDash=KEXO_RING_SEGMENT.toFixed(2)+" "+KEXO_RING_GAP.toFixed(2);trackCircle.setAttribute("stroke-dasharray",trackDash+" "+trackDash+" "+trackDash+" "+trackDash+" "+trackDash),trackCircle.setAttribute("stroke-dashoffset",(-KEXO_RING_START_OFFSET).toFixed(2))}for(var totalFill=score/100*(5*KEXO_RING_SEGMENT),fullRed=0===score,fullGreen=100===score,i=0;i<5;i+=1){var segStart=KEXO_RING_START_OFFSET+i*KEXO_RING_SEGMENT_AND_GAP,fillStart=i*KEXO_RING_SEGMENT,filled=fullRed||fullGreen?KEXO_RING_SEGMENT:Math.max(0,Math.min(KEXO_RING_SEGMENT,totalFill-fillStart)),fillCircle=svg.querySelector(".kexo-score-ring-fill--"+(i+1));
// Fill length advances across segments only (gaps are always unfilled).
if(fillCircle){
// IMPORTANT: keep dasharray sum bounded to circumference so large dashoffsets
// don't land in an effectively infinite gap (which can hide segments).
var gap=Math.max(0,KEXO_RING_CIRCUMFERENCE-filled);fillCircle.setAttribute("stroke-dasharray",filled.toFixed(2)+" "+gap.toFixed(2)),fillCircle.setAttribute("stroke-dashoffset",(-segStart).toFixed(2)),fillCircle.style.stroke=fullRed?"var(--kexo-accent-5, #ef4444)":fullGreen?"var(--kexo-accent-2, #3eb3ab)":KEXO_RING_COLOR_ORDER[i]}}
// Mark initialized so CSS pre-init hiding doesn't override JS dasharrays.
try{svg.setAttribute("data-kexo-ring-init","1")}catch(_){}}}function buildHeaderKexoScoreRingBg(rawScore){var score=Number(rawScore);if(Number.isFinite(score)||(score=0),0===(score=Math.max(0,Math.min(100,score))))return"conic-gradient(from -90deg, var(--kexo-accent-5, #ef4444) 0deg 360deg)";if(100===score)return"conic-gradient(from -90deg, var(--kexo-accent-2, #3eb3ab) 0deg 360deg)";for(var colors=["var(--kexo-accent-5, #ef4444)","var(--kexo-accent-4, #8b5cf6)","var(--kexo-accent-3, #f59e34)","var(--kexo-accent-1, #4b94e4)","var(--kexo-accent-2, #3eb3ab)"],track="var(--kexo-score-track)",segDeg=360/colors.length,fillDeg=3.6*score,stops=[],i=0;i<colors.length;i+=1){var segStart=i*segDeg,segEnd=segStart+segDeg,segFillStart=segStart+2,segFillEnd=segEnd-2,paintedEnd=Math.min(fillDeg,segFillEnd);stops.push("transparent "+segStart.toFixed(2)+"deg "+segFillStart.toFixed(2)+"deg"),paintedEnd<=segFillStart?stops.push(track+" "+segFillStart.toFixed(2)+"deg "+segFillEnd.toFixed(2)+"deg"):paintedEnd>=segFillEnd?stops.push(colors[i]+" "+segFillStart.toFixed(2)+"deg "+segFillEnd.toFixed(2)+"deg"):(stops.push(colors[i]+" "+segFillStart.toFixed(2)+"deg "+paintedEnd.toFixed(2)+"deg"),stops.push(track+" "+paintedEnd.toFixed(2)+"deg "+segFillEnd.toFixed(2)+"deg")),stops.push("transparent "+segFillEnd.toFixed(2)+"deg "+segEnd.toFixed(2)+"deg")}return"conic-gradient(from -90deg, "+stops.join(", ")+")"}function renderKexoScoreOverviewBreakdown(scoreData){var container=document.getElementById("dash-kpi-kexo-score-breakdown");if(container){var rangeKeyForAnim=scoreData&&null!=scoreData.rangeKey?String(scoreData.rangeKey):"",shouldAnimateOnce=(container.getAttribute("data-kexo-score-animated-range")||"")!==rangeKeyForAnim,KEXO_SCORE_V2_UI={floors:{money:100,vpv:.5,mer:.25,conversion:1},stable:{conversionPp:.2,// percentage points
vpvRatio:.05,revenueRatio:.07,profitRatio:.07,merRatio:.09},
// UI-only: additive pad so "max" doesn't saturate at 100% and widths vary by magnitude.
barPadMult:.35,anim:{durationMs:220,gapMs:60}};if(scoreData&&Array.isArray(scoreData.components)&&0!==scoreData.components.length){var metricOrder=scoreData&&scoreData.adsIntegrated?["profit","vpv","conversion","revenue","mer"]:["profit","vpv","conversion","revenue"],rankByKey={};metricOrder.forEach(function(key,idx){rankByKey[key]=idx});var html=scoreData.components.filter(function(c){return Object.prototype.hasOwnProperty.call(rankByKey,normalizeScoreMetricKey(c&&c.key))}).sort(function(a,b){return rankByKey[normalizeScoreMetricKey(a&&a.key)]-rankByKey[normalizeScoreMetricKey(b&&b.key)]}).map(function(c){var label=c.label&&String(c.label).trim()?String(c.label):c.key||"",bars=function(key,curScore,prevScore){var cRaw="number"==typeof curScore&&Number.isFinite(curScore)?curScore:null,pRaw="number"==typeof prevScore&&Number.isFinite(prevScore)?prevScore:null;if(null==cRaw&&null==pRaw)return{prevPct:0,curPct:0,barClass:"bg-secondary",barLabel:"—",isNew:!1};var isNew=null!=cRaw&&null==pRaw,c=null!=cRaw?Math.max(0,Math.min(100,cRaw)):0,p=null!=pRaw?Math.max(0,Math.min(100,pRaw)):0,prevPct=p,curPct=c,barClass="kexo-score-bar-palette kexo-score-bar-palette--flat";if(isNew||null==cRaw||null==pRaw)isNew&&(barClass="kexo-score-bar-palette kexo-score-bar-palette--new");else{var d=c-p,dir=Math.abs(d)>=.5?d>0?1:-1:0;barClass=dir>0?"kexo-score-bar-palette kexo-score-bar-palette--up":dir<0?"kexo-score-bar-palette kexo-score-bar-palette--down":"kexo-score-bar-palette kexo-score-bar-palette--flat"}return{prevPct:prevPct,curPct:curPct,barClass:barClass,barLabel:"",isNew:isNew}}(c.key,c.score,c.previousScore),valueStr=function(key,raw){if(null==raw)return"—";var n=Number(raw);if(!Number.isFinite(n))return"—";var k=String(key||"").trim().toLowerCase();return"revenue"===k||"profit"===k?formatRevenue0(n):"vpv"===k?fmtGbp2(n):"conversion"===k?pct(n):"mer"===k||"roas"===k?n.toFixed(2)+"x":Math.round(10*n)/10}(c.key,c.value),deltaStr=fmtComponentDeltaText(c.key,c.value,c.previous);deltaStr||(deltaStr="—");var detail=String(valueStr)+" | "+String(deltaStr)+" vs prev",curWidth=shouldAnimateOnce?"0%":bars.curPct.toFixed(1)+"%";return'<div class="kexo-score-breakdown-row mb-2"><div class="kexo-score-breakdown-head mb-1"><span class="kexo-score-breakdown-label">'+escapeHtml(label)+'</span><span class="kexo-score-breakdown-value">'+escapeHtml(detail)+'</span></div><div class="progress kexo-score-progress"><div class="progress-bar kexo-score-bar-prev" role="progressbar" data-kexo-width="'+bars.prevPct.toFixed(1)+'%" aria-hidden="true"></div><div class="progress-bar '+bars.barClass+' kexo-score-bar-cur" role="progressbar" data-kexo-width="'+curWidth+'" data-target-pct="'+bars.curPct.toFixed(1)+'" aria-valuenow="'+bars.curPct.toFixed(1)+'" aria-valuemin="0" aria-valuemax="100">'+escapeHtml(bars.barLabel)+"</div></div></div>"}).join("");container.innerHTML=html;try{container.querySelectorAll("[data-kexo-width]").forEach(function(bar){if(bar&&bar.style&&bar.getAttribute){var w=String(bar.getAttribute("data-kexo-width")||"").trim();w&&(bar.style.width=w)}})}catch(_){}shouldAnimateOnce&&(container.setAttribute("data-kexo-score-animated-range",rangeKeyForAnim),requestAnimationFrame(function(){!function(scope){if(scope&&scope.querySelectorAll){var bars=Array.from(scope.querySelectorAll(".kexo-score-breakdown-row .progress-bar.kexo-score-bar-cur[data-target-pct]"));if(bars.length){var reduceMotion=!1;try{reduceMotion=!(!window.matchMedia||!window.matchMedia("(prefers-reduced-motion: reduce)").matches)}catch(_){}var durationMs=Number(KEXO_SCORE_V2_UI.anim&&KEXO_SCORE_V2_UI.anim.durationMs),gapMs=Number(KEXO_SCORE_V2_UI.anim&&KEXO_SCORE_V2_UI.anim.gapMs);(!Number.isFinite(durationMs)||durationMs<=0)&&(durationMs=480),(!Number.isFinite(gapMs)||gapMs<0)&&(gapMs=90),bars.forEach(function(bar,idx){var target=Number(bar.getAttribute("data-target-pct")||"0");if(Number.isFinite(target)||(target=0),target=Math.max(0,Math.min(100,target)),reduceMotion)return bar.style.transition="none",void(bar.style.width=target+"%");bar.style.transition="none",bar.style.width="0%",bar.offsetWidth,requestAnimationFrame(function(){requestAnimationFrame(function(){bar.style.transition="width "+durationMs+"ms cubic-bezier(.22,.61,.36,1)",bar.style.transitionDelay=String(idx*(durationMs+gapMs))+"ms",bar.style.width=target+"%"})})})}}}(container)}))}else container.innerHTML='<div class="kexo-score-breakdown-empty text-muted small">No score data</div>'}function fmtComponentDeltaText(key,rawCur,rawPrev){var k,spec=("roas"===(k=String(key||"").trim().toLowerCase())&&(k="mer"),"conversion"===k?{key:"conversion",floor:KEXO_SCORE_V2_UI.floors.conversion,stableMode:"pp",stable:KEXO_SCORE_V2_UI.stable.conversionPp,denomFloor:.001}:"vpv"===k?{key:"vpv",floor:KEXO_SCORE_V2_UI.floors.vpv,stableMode:"ratio",stable:KEXO_SCORE_V2_UI.stable.vpvRatio,denomFloor:KEXO_SCORE_V2_UI.floors.vpv}:"profit"===k?{key:"profit",floor:KEXO_SCORE_V2_UI.floors.money,stableMode:"ratio",stable:KEXO_SCORE_V2_UI.stable.profitRatio,denomFloor:KEXO_SCORE_V2_UI.floors.money}:"mer"===k?{key:"mer",floor:KEXO_SCORE_V2_UI.floors.mer,stableMode:"ratio",stable:KEXO_SCORE_V2_UI.stable.merRatio,denomFloor:KEXO_SCORE_V2_UI.floors.mer}:"revenue"===k?{key:"revenue",floor:KEXO_SCORE_V2_UI.floors.money,stableMode:"ratio",stable:KEXO_SCORE_V2_UI.stable.revenueRatio,denomFloor:KEXO_SCORE_V2_UI.floors.money}:{key:k,floor:1,stableMode:"ratio",stable:.07,denomFloor:1}),cur=Number(rawCur),prev=Number(rawPrev);if(!Number.isFinite(cur)&&!Number.isFinite(prev))return"—";if(!Number.isFinite(cur)||!Number.isFinite(prev))return"—";if("conversion"===spec.key){var dpp=cur-prev;if(!Number.isFinite(dpp)||Math.abs(dpp)<spec.stable)return"0.0pp";var roundedPp=Math.round(10*dpp)/10;return(roundedPp>0?"+":"")+roundedPp.toFixed(1)+"pp"}if(Math.abs(prev)<1e-9)return Math.abs(cur)<1e-9?"0.0%":"+100%";var deltaPct=(cur-prev)/Math.max(Math.abs(prev),Number(spec.denomFloor)||0,1e-9)*100,rounded=Math.round(10*deltaPct)/10;return Number.isFinite(rounded)?(rounded>0?"+":"")+rounded.toFixed(1)+"%":""}function normalizeScoreMetricKey(rawKey){var k=String(rawKey||"").trim().toLowerCase();return"roas"===k?"mer":k}}function applyKexoScoreModalSummary(scoreData){var modalScoreNum=document.getElementById("kexo-score-modal-score"),modalRing=document.getElementById("kexo-score-modal-ring");if(modalScoreNum||modalRing){var score=null;scoreData&&"number"==typeof scoreData.score&&Number.isFinite(scoreData.score)&&(score=Math.max(0,Math.min(100,Number(scoreData.score))));var empty=null==score,precise=empty?"—":formatKexoScoreNumber(score),pct=empty?"0":String(score);modalScoreNum&&(modalScoreNum.textContent=precise),modalRing&&("svg"===modalRing.tagName?applyKexoScoreRingSvg(modalRing,score):(modalRing.style.setProperty("--kexo-score-pct",pct),modalRing.style.background=buildHeaderKexoScoreRingBg(score)))}}function disposeKexoScorePopovers(scope){if(scope&&scope.querySelectorAll){var Popover=window.bootstrap&&window.bootstrap.Popover;if(Popover){Array.from(scope.querySelectorAll('[data-kexo-score-popover="1"]')).forEach(function(node){try{var existing=Popover.getInstance(node);existing&&(existing.hide(),existing.dispose())}catch(_){}});try{Array.from(scope.querySelectorAll(".popover")).forEach(function(p){try{p.remove()}catch(_){}})}catch(_){}}}}function openKexoScoreModal(){var modal=document.getElementById("kexo-score-modal"),body=document.getElementById("kexo-score-modal-body");if(modal&&body){var KEXO_SCORE_V2_UI={floors:{money:100,vpv:.5,mer:.25,conversion:1},stable:{conversionPp:.2,// percentage points
vpvRatio:.05,revenueRatio:.07,profitRatio:.07,merRatio:.09},barPadMult:.35,anim:{durationMs:260,gapMs:70}},data=_kexoScoreCache;applyKexoScoreModalSummary(data);var breakdownHtml,section,closeBtn,showBtn,rangeKey=dashRangeKeyFromDateRange();if(data&&Array.isArray(data.components)&&0!==data.components.length){var metricOrder=data&&data.adsIntegrated?["profit","vpv","conversion","revenue","mer"]:["profit","vpv","conversion","revenue"],rankByKey={};metricOrder.forEach(function(key,idx){rankByKey[key]=idx}),breakdownHtml=data.components.filter(function(c){return Object.prototype.hasOwnProperty.call(rankByKey,normalizeScoreMetricKey(c&&c.key))}).sort(function(a,b){return rankByKey[normalizeScoreMetricKey(a&&a.key)]-rankByKey[normalizeScoreMetricKey(b&&b.key)]}).map(function(c){var label=c.label&&String(c.label).trim()?String(c.label):c.key||"",bars=function(key,curScore,prevScore){var cRaw="number"==typeof curScore&&Number.isFinite(curScore)?curScore:null,pRaw="number"==typeof prevScore&&Number.isFinite(prevScore)?prevScore:null;if(null==cRaw&&null==pRaw)return{prevPct:0,curPct:0,barClass:"bg-secondary",barLabel:"—",isNew:!1};var isNew=null!=cRaw&&null==pRaw,c=null!=cRaw?Math.max(0,Math.min(100,cRaw)):0,p=null!=pRaw?Math.max(0,Math.min(100,pRaw)):0,prevPct=p,curPct=c,barClass="kexo-score-bar-palette kexo-score-bar-palette--flat";if(isNew||null==cRaw||null==pRaw)isNew&&(barClass="kexo-score-bar-palette kexo-score-bar-palette--new");else{var d=c-p,dir=Math.abs(d)>=.5?d>0?1:-1:0;barClass=dir>0?"kexo-score-bar-palette kexo-score-bar-palette--up":dir<0?"kexo-score-bar-palette kexo-score-bar-palette--down":"kexo-score-bar-palette kexo-score-bar-palette--flat"}return{prevPct:prevPct,curPct:curPct,barClass:barClass,barLabel:"",isNew:isNew}}(c.key,c.score,c.previousScore),valueStr=function(key,raw){if(null==raw)return"—";var n=Number(raw);if(!Number.isFinite(n))return"—";var k=String(key||"").trim().toLowerCase();return"revenue"===k||"profit"===k?formatRevenue0(n):"vpv"===k?fmtGbp2(n):"conversion"===k?pct(n):"mer"===k||"roas"===k?n.toFixed(2)+"x":Math.round(10*n)/10}(c.key,c.value),deltaStr=fmtComponentDeltaText(c.key,c.value,c.previous);deltaStr||(deltaStr="—");var detail=String(valueStr)+" | "+String(deltaStr)+" vs prev";return'<div class="kexo-score-breakdown-row mb-3"><div class="kexo-score-breakdown-head mb-1"><span class="kexo-score-breakdown-label">'+escapeHtml(label)+'</span><span class="kexo-score-breakdown-value">'+escapeHtml(detail)+'</span></div><div class="progress kexo-score-progress"><div class="progress-bar kexo-score-bar-prev" role="progressbar" data-kexo-width="'+bars.prevPct.toFixed(1)+'%" aria-hidden="true"></div><div class="progress-bar '+bars.barClass+' kexo-score-bar-cur" role="progressbar" data-kexo-width="0%" data-target-pct="'+bars.curPct.toFixed(1)+'" aria-valuenow="'+bars.curPct.toFixed(1)+'" aria-valuemin="0" aria-valuemax="100">'+escapeHtml(bars.barLabel)+"</div></div></div>"}).join("")}else breakdownHtml='<div class="kexo-score-breakdown-empty text-muted">No score data. Select a date range and refresh.</div>';body.innerHTML='<div id="kexo-score-summary-section" class="kexo-score-summary-card mb-3 is-hidden" role="region" aria-label="Kexo Score summary"><div class="kexo-score-summary-card-header d-flex align-items-center justify-content-between mb-2"><span class="fw-medium">Summary</span><button type="button" class="btn btn-icon btn-ghost-secondary kexo-score-summary-close" aria-label="Close summary"><i class="fa-light fa-xmark" aria-hidden="true"></i></button></div><div id="kexo-score-summary-wrap"><div class="kexo-score-summary-loading text-muted">Loading summary…</div></div></div><div id="kexo-score-breakdown">'+breakdownHtml+"</div>";try{body.querySelectorAll("[data-kexo-width]").forEach(function(bar){if(bar&&bar.style&&bar.getAttribute){var w=String(bar.getAttribute("data-kexo-width")||"").trim();w&&(bar.style.width=w)}})}catch(_){}section=document.getElementById("kexo-score-summary-section"),closeBtn=section&&section.querySelector(".kexo-score-summary-close"),showBtn=document.getElementById("kexo-score-show-summary-btn"),closeBtn&&section&&closeBtn.addEventListener("click",function(){section.classList.add("is-hidden"),showBtn&&showBtn.classList.remove("is-hidden")}),showBtn&&showBtn.classList.remove("is-hidden"),function(force){var wrap=document.getElementById("kexo-score-summary-wrap");wrap&&(force||(wrap.innerHTML='<div class="kexo-score-summary-loading text-muted">Loading summary…</div>'),fetchWithTimeout("/api/kexo-score-summary?range="+encodeURIComponent(rangeKey)+(force?"&force=1&_="+Date.now():""),{credentials:"same-origin"},15e3).then(function(r){return r&&r.ok?r.json():null}).then(function(payload){if(wrap)if(payload&&!1!==payload.ok){var summary=payload.summary&&String(payload.summary).trim()?escapeHtml(payload.summary):"",drivers=Array.isArray(payload.key_drivers)?payload.key_drivers:[],rec=payload.recommendation&&String(payload.recommendation).trim()?escapeHtml(payload.recommendation):"",parts=[];summary&&parts.push('<p class="kexo-score-summary-text">'+summary+"</p>"),drivers.length&&parts.push('<ul class="kexo-score-summary-drivers">'+drivers.map(function(d){var s=String(d).trim(),idx=s.indexOf(": ");if(idx>0){var label=s.slice(0,idx+1),rest=s.slice(idx+2);return'<li><span class="kexo-score-driver-label">'+escapeHtml(label)+"</span> "+escapeHtml(rest)+"</li>"}return"<li>"+escapeHtml(s)+"</li>"}).join("")+"</ul>"),rec&&parts.push('<p class="kexo-score-summary-recommendation">'+rec+"</p>"),0===parts.length&&parts.push('<p class="kexo-score-summary-text text-muted">No summary for this range.</p>'),wrap.innerHTML=parts.join("")}else wrap.innerHTML='<p class="kexo-score-summary-text text-muted">Summary unavailable.</p>'}).catch(function(){wrap&&(wrap.innerHTML='<p class="kexo-score-summary-text text-muted">Summary unavailable.</p>')}))}();var breakdownEl=document.getElementById("kexo-score-breakdown");disposeKexoScorePopovers(modal),function(scope){if(scope&&scope.querySelectorAll){var Popover=window.bootstrap&&window.bootstrap.Popover;if(Popover&&(Array.from(scope.querySelectorAll('[data-kexo-score-popover="1"]')).forEach(function(node){try{
// If Bootstrap auto-initialized this node from data-bs-toggle before our code runs,
// reconfigure once so we always have a header (title) and a scoped container.
if("1"!==node.getAttribute("data-kexo-score-popover-configured"))try{var existing=Popover.getInstance(node);existing&&existing.dispose()}catch(_){}var popover=Popover.getOrCreateInstance(node,{trigger:node.getAttribute("data-bs-trigger")||"click",placement:node.getAttribute("data-bs-placement")||"bottom",html:!1,container:scope,customClass:"kexo-score-popover",title:"Kexo Score"});"1"!==node.getAttribute("data-kexo-score-popover-configured")&&node.setAttribute("data-kexo-score-popover-configured","1"),"1"!==node.getAttribute("data-kexo-score-popover-bound")&&(node.setAttribute("data-kexo-score-popover-bound","1"),node.addEventListener("shown.bs.popover",function(){var tip=popover&&"function"==typeof popover.getTipElement?popover.getTipElement():node.getAttribute("aria-describedby")?document.getElementById(node.getAttribute("aria-describedby")):scope.querySelector(".popover.show");if(tip&&tip.querySelector&&!tip.querySelector(".kexo-score-popover-close")){var header=tip.querySelector(".popover-header");if(header){var closeBtn=document.createElement("button");closeBtn.type="button",closeBtn.className="btn-close btn-close-sm kexo-score-popover-close position-absolute top-0 end-0 m-2",closeBtn.setAttribute("aria-label","Close"),header.appendChild(closeBtn)}}}))}catch(_){}}),"1"!==scope.getAttribute("data-kexo-score-popover-scope-bound"))){scope.setAttribute("data-kexo-score-popover-scope-bound","1");try{bindDashDocumentClickOnce()}catch(_){}}}}(modal),modal.classList.remove("is-hidden"),modal.setAttribute("aria-hidden","false"),requestAnimationFrame(function(){!function(scope){if(scope&&scope.querySelectorAll){var bars=Array.from(scope.querySelectorAll(".kexo-score-breakdown-row .progress-bar.kexo-score-bar-cur[data-target-pct]"));if(bars.length){var reduceMotion=!1;try{reduceMotion=!(!window.matchMedia||!window.matchMedia("(prefers-reduced-motion: reduce)").matches)}catch(_){}var durationMs=Number(KEXO_SCORE_V2_UI.anim&&KEXO_SCORE_V2_UI.anim.durationMs),gapMs=Number(KEXO_SCORE_V2_UI.anim&&KEXO_SCORE_V2_UI.anim.gapMs);(!Number.isFinite(durationMs)||durationMs<=0)&&(durationMs=520),(!Number.isFinite(gapMs)||gapMs<0)&&(gapMs=110),bars.forEach(function(bar,idx){var target=Number(bar.getAttribute("data-target-pct")||"0");if(Number.isFinite(target)||(target=0),target=Math.max(0,Math.min(100,target)),reduceMotion)return bar.style.transition="none",void(bar.style.width=target+"%");bar.style.transition="none",bar.style.width="0%",bar.offsetWidth,requestAnimationFrame(function(){requestAnimationFrame(function(){bar.style.transition="width "+durationMs+"ms cubic-bezier(.22,.61,.36,1)",bar.style.transitionDelay=String(idx*(durationMs+gapMs))+"ms",bar.style.width=target+"%"})})})}}}(breakdownEl)})}function fmtComponentDeltaText(key,rawCur,rawPrev){var k,spec=("roas"===(k=String(key||"").trim().toLowerCase())&&(k="mer"),"conversion"===k?{key:"conversion",floor:KEXO_SCORE_V2_UI.floors.conversion,stableMode:"pp",stable:KEXO_SCORE_V2_UI.stable.conversionPp,denomFloor:.001}:"vpv"===k?{key:"vpv",floor:KEXO_SCORE_V2_UI.floors.vpv,stableMode:"ratio",stable:KEXO_SCORE_V2_UI.stable.vpvRatio,denomFloor:KEXO_SCORE_V2_UI.floors.vpv}:"profit"===k?{key:"profit",floor:KEXO_SCORE_V2_UI.floors.money,stableMode:"ratio",stable:KEXO_SCORE_V2_UI.stable.profitRatio,denomFloor:KEXO_SCORE_V2_UI.floors.money}:"mer"===k?{key:"mer",floor:KEXO_SCORE_V2_UI.floors.mer,stableMode:"ratio",stable:KEXO_SCORE_V2_UI.stable.merRatio,denomFloor:KEXO_SCORE_V2_UI.floors.mer}:"revenue"===k?{key:"revenue",floor:KEXO_SCORE_V2_UI.floors.money,stableMode:"ratio",stable:KEXO_SCORE_V2_UI.stable.revenueRatio,denomFloor:KEXO_SCORE_V2_UI.floors.money}:{key:k,floor:1,stableMode:"ratio",stable:.07,denomFloor:1}),cur=Number(rawCur),prev=Number(rawPrev);if(!Number.isFinite(cur)&&!Number.isFinite(prev))return"—";if(!Number.isFinite(cur)||!Number.isFinite(prev))return"—";if("conversion"===spec.key){var dpp=cur-prev;if(!Number.isFinite(dpp)||Math.abs(dpp)<spec.stable)return"0.0pp";var roundedPp=Math.round(10*dpp)/10;return(roundedPp>0?"+":"")+roundedPp.toFixed(1)+"pp"}if(Math.abs(prev)<1e-9)return Math.abs(cur)<1e-9?"0.0%":"+100%";var deltaPct=(cur-prev)/Math.max(Math.abs(prev),Number(spec.denomFloor)||0,1e-9)*100,rounded=Math.round(10*deltaPct)/10;return Number.isFinite(rounded)?(rounded>0?"+":"")+rounded.toFixed(1)+"%":""}function normalizeScoreMetricKey(rawKey){var k=String(rawKey||"").trim().toLowerCase();return"roas"===k?"mer":k}}function closeKexoScoreModal(){var modal=document.getElementById("kexo-score-modal");modal&&(disposeKexoScorePopovers(modal),disposeKexoScorePopovers(document),modal.classList.add("is-hidden"),modal.setAttribute("aria-hidden","true"))}function fetchDashboardData(rangeKey,force,opts){if(!dashLoading||force){(rangeKey=(null==rangeKey?"":String(rangeKey)).trim().toLowerCase())||(rangeKey="today");var myRequestId=dashFetchRequestId+=1,trendingPresetAtStart=getTrendingPreset();if(rangeKey!==dashLastRangeKey||trendingPresetAtStart!==dashLastTrendingPreset)try{dashTrendingPage=1}catch(_){}dashLoading=!0;var silent=!(!opts||!opts.silent),reason=opts&&null!=opts.reason?String(opts.reason):"",build=silent?{step:function(){},finish:function(){}}:startReportBuild({key:"dashboard",title:"Preparing dashboard overview",initialStep:"Loading dashboard data"}),buildFinishTimeout=null;silent||"function"!=typeof build.finish||(buildFinishTimeout=setTimeout(function(){buildFinishTimeout=null,dashLoading=!1;try{build.finish()}catch(_){}},35e3));var url="/api/dashboard-series?range="+encodeURIComponent(rangeKey)+"&trendingPreset="+encodeURIComponent(trendingPresetAtStart)+("function"==typeof window.kexoGetTrafficQuerySuffix?window.kexoGetTrafficQuerySuffix():"")+(force?"&force=1&_="+Date.now():""),forceMini=!!force;if(silent&&forceMini&&"new-sale"!==String(reason||"").trim().toLowerCase()){var miniAgeMs=overviewMiniFetchedAt?Date.now()-overviewMiniFetchedAt:Number.POSITIVE_INFINITY;forceMini=miniAgeMs>3e5}fetchKexoScore(rangeKey);try{"function"==typeof window.__applyDashboardKpiUiConfig&&window.__applyDashboardKpiUiConfig()}catch(_){}ensureOverviewHeightSyncObserver();try{syncOverviewHeightGrid()}catch(_){}if(scheduleOverviewHeightSync(),bindOverviewCardUiOnce(),syncAllOverviewCardRangeUi(),document.getElementById("live-online-chart")&&"function"==typeof window.refreshLiveOnlineChart)try{window.refreshLiveOnlineChart({force:!1})}catch(_){}fetchWithTimeout(url,{credentials:"same-origin",cache:force?"no-store":"default"},3e4).then(function(r){return r&&r.ok?r.json():null}).then(function(data){if(myRequestId===dashFetchRequestId){if(dashLoading=!1,data){var nextSig=function(data,rangeKey,trendingPresetOrDays){var safeData=data&&"object"==typeof data?data:{},sigPayload={range:String(rangeKey||""),trendingPreset:null!=trendingPresetOrDays?String(trendingPresetOrDays):"",labels:Array.isArray(safeData.labels)?safeData.labels:[],revenue:Array.isArray(safeData.revenue)?safeData.revenue:[],sessions:Array.isArray(safeData.sessions)?safeData.sessions:[],orders:Array.isArray(safeData.orders)?safeData.orders:[],topProducts:Array.isArray(safeData.topProducts)?safeData.topProducts:[],topCountries:Array.isArray(safeData.topCountries)?safeData.topCountries:[],trendingUp:Array.isArray(safeData.trendingUp)?safeData.trendingUp:[],trendingDown:Array.isArray(safeData.trendingDown)?safeData.trendingDown:[]};try{return fastPayloadHash(JSON.stringify(sigPayload)||"")}catch(_){return fastPayloadHash(String(Date.now()))}}(data,rangeKey,trendingPresetAtStart),shouldRender=!!force||!(dashPayloadSignature&&nextSig&&nextSig===dashPayloadSignature);if(dashCache=data,dashLastRangeKey=rangeKey,dashLastTrendingPreset=trendingPresetAtStart,dashPayloadSignature=nextSig,shouldRender||opts&&opts.rerender){build.step("Rendering dashboard panels"),renderDashboard(data);try{ensureTrendingDaysDropdown()}catch(_){}}}var deferSecondary=function(){fetchOverviewCardData("dash-chart-overview-30d",{force:forceMini}),requestDashboardWidgetsRefresh({force:forceMini,rangeKey:rangeKey})};"function"==typeof requestAnimationFrame?requestAnimationFrame(function(){requestAnimationFrame(deferSecondary)}):setTimeout(deferSecondary,0)}}).catch(function(err){if(myRequestId===dashFetchRequestId){try{"function"==typeof window.kexoCaptureError&&window.kexoCaptureError(err,{context:"dashboardSeries",page:PAGE})}catch(_){}dashLoading=!1,build.step("Dashboard data unavailable"),console.error("[dashboard] fetch error:",err)}}).finally(function(){if(myRequestId===dashFetchRequestId){if(null!=buildFinishTimeout){try{clearTimeout(buildFinishTimeout)}catch(_){}buildFinishTimeout=null}try{build.finish()}catch(_){}}})}}function dashRangeKeyFromDateRange(){
// Use the same normalized API range key as KPIs/stats so Dashboard charts/tables match the header selection.
var rk=getStatsRange();return(rk=(null==rk?"":String(rk)).trim().toLowerCase())||(rk="today"),rk}!function(){var headerBtn=document.getElementById("header-kexo-score-wrap"),closeBtn=document.getElementById("kexo-score-modal-close-btn"),modalEl=document.getElementById("kexo-score-modal");headerBtn&&(headerBtn.addEventListener("click",function(e){e.preventDefault(),openKexoScoreModal()}),headerBtn.addEventListener("keydown",function(e){"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),openKexoScoreModal())})),closeBtn&&closeBtn.addEventListener("click",closeKexoScoreModal);var showSummaryBtn=document.getElementById("kexo-score-show-summary-btn");showSummaryBtn&&showSummaryBtn.addEventListener("click",function(){var section=document.getElementById("kexo-score-summary-section");section&&(section.classList.remove("is-hidden"),showSummaryBtn.classList.add("is-hidden"))}),modalEl&&modalEl.addEventListener("click",function(e){e.target===modalEl&&closeKexoScoreModal()}),document.addEventListener("keydown",function(e){"Escape"===e.key&&modalEl&&!modalEl.classList.contains("is-hidden")&&"true"!==modalEl.getAttribute("aria-hidden")&&closeKexoScoreModal()})}(),function(){var toggleEl=document.getElementById("dash-trending-toggle");function doToggle(e){e.preventDefault(),e.stopPropagation();try{dashTrendingPage=1}catch(_){}dashTrendingMode="up"===dashTrendingMode?"down":"up",syncTrendingCardTitleAndChevron(),dashCache&&rerenderDashboardFromCache()}toggleEl&&(syncTrendingCardTitleAndChevron(),toggleEl.addEventListener("click",doToggle),toggleEl.addEventListener("keydown",function(e){"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),doToggle(e))}))}();var OVERVIEW_TRENDING_DAYS_LS="kexo:overview-trending-days:v1",OVERVIEW_TRENDING_PRESET_LS="kexo:overview-trending-preset:v1",TRENDING_PRESETS=[{value:"today",label:"Today"},{value:"yesterday",label:"Yesterday"},{value:"3d",label:"3 days"},{value:"7d",label:"7 days"},{value:"14d",label:"14 days"}];function getTrendingPreset(){try{var raw=localStorage.getItem(OVERVIEW_TRENDING_PRESET_LS),s=(null==raw?"":String(raw)).trim().toLowerCase();if("today"===s||"yesterday"===s||"3d"===s||"7d"===s||"14d"===s)return s;var legacy=localStorage.getItem(OVERVIEW_TRENDING_DAYS_LS),n=parseInt(legacy,10);if(3===n)return"3d";if(7===n)return"7d";if(14===n)return"14d"}catch(_){}return"3d"}function setTrendingPreset(value){var s=(null==value?"":String(value)).trim().toLowerCase();if("today"===s||"yesterday"===s||"3d"===s||"7d"===s||"14d"===s)try{localStorage.setItem(OVERVIEW_TRENDING_PRESET_LS,s)}catch(_){}}function getTrendingPresetLabel(value){for(var v=(null==value?"":String(value)).trim().toLowerCase(),i=0;i<TRENDING_PRESETS.length;i++)if(TRENDING_PRESETS[i].value===v)return TRENDING_PRESETS[i].label;return"3 days"}function fmtGbp2(n){var v="number"==typeof n?n:Number(n);if(!Number.isFinite(v))return"—";if("function"==typeof formatRevenue2)return formatRevenue2(v)||"—";try{return new Intl.NumberFormat("en-GB",{style:"currency",currency:"GBP",minimumFractionDigits:2,maximumFractionDigits:2}).format(v)}catch(_){return"£"+(Math.round(100*v)/100).toFixed(2)}}function widgetPresent(){try{return!!document.getElementById("dash-overview-widgets-grid")}catch(_){return!1}}function defaultOverviewWidgetsUiConfigV1(){var widgets={};return OVERVIEW_WIDGET_KEYS.forEach(function(key){widgets[key]={sortBy:"revenue",color:""}}),widgets.finishes=Object.assign({},widgets.finishes,{groupBy:"finishes"}),{v:1,order:OVERVIEW_WIDGET_KEYS.slice(),widgets:widgets}}function normalizeOverviewWidgetsUiConfigV1(raw){var parsed=null;try{raw&&"object"==typeof raw?parsed=raw:"string"==typeof raw&&raw&&(parsed=JSON.parse(raw))}catch(_){parsed=null}var out=defaultOverviewWidgetsUiConfigV1();if(!parsed||"object"!=typeof parsed)return out;if(1!==Number(parsed.v))return out;try{if(Array.isArray(parsed.order)){var seen={},next=[];parsed.order.forEach(function(k){var key=(null==k?"":String(k)).trim().toLowerCase();key&&(OVERVIEW_WIDGET_KEYS.indexOf(key)<0||seen[key]||(seen[key]=!0,next.push(key)))}),next.length===OVERVIEW_WIDGET_KEYS.length&&(out.order=next)}}catch(_){}try{var w=parsed.widgets&&"object"==typeof parsed.widgets?parsed.widgets:null;w&&OVERVIEW_WIDGET_KEYS.forEach(function(key){var row=w[key]&&"object"==typeof w[key]?w[key]:null;if(row){if(null!=row.sortBy){var sb=String(row.sortBy||"").trim().toLowerCase();"revenue"!==sb&&"clicks"!==sb&&"ctr"!==sb||(out.widgets[key].sortBy=sb)}if(Object.prototype.hasOwnProperty.call(row,"color")&&(out.widgets[key].color=cssValueFromOverride(row.color)||""),"finishes"===key&&null!=row.groupBy){var gb=String(row.groupBy||"").trim().toLowerCase();gb&&(out.widgets.finishes.groupBy=gb)}}})}catch(_){}return out}function readOverviewWidgetsUiConfigV1(){if(ovwUiCfgLocal)return ovwUiCfgLocal;var fallback=defaultOverviewWidgetsUiConfigV1();try{var raw=localStorage.getItem(OVERVIEW_WIDGETS_UI_CFG_LS_KEY);return ovwUiCfgLocal=raw?normalizeOverviewWidgetsUiConfigV1(raw):fallback}catch(_){return ovwUiCfgLocal=fallback}}function cssValueFromOverride(raw){var v=null==raw?"":String(raw).trim();return v?v.length>80||/[;\r\n{}]/.test(v)?"":/^var\(--[a-zA-Z0-9._-]+\)$/.test(v)||/^#([0-9a-f]{3}|[0-9a-f]{6}|[0-9a-f]{8})$/i.test(v)||/^(rgb|hsl)a?\(/i.test(v)?v:"currentcolor"===v.toLowerCase()?"currentColor":"transparent"===v.toLowerCase()?"transparent":/^[a-z-]+$/i.test(v)?v:"":""}function widgetSupportsSortBy(widgetKey,sortBy){var key=String(widgetKey||"").trim().toLowerCase(),sb=String(sortBy||"").trim().toLowerCase(),row=OVERVIEW_WIDGET_SUPPORTS&&OVERVIEW_WIDGET_SUPPORTS[key]?OVERVIEW_WIDGET_SUPPORTS[key]:null;return row?"clicks"===sb?!0===row.clicks:"ctr"===sb?!0===row.ctr:!1!==row.revenue:"revenue"===sb}function applyOverviewWidgetsLayoutAndColors(cfg){var grid=document.getElementById("dash-overview-widgets-grid");if(grid){var normalized=normalizeOverviewWidgetsUiConfigV1(cfg||readOverviewWidgetsUiConfigV1()),order=Array.isArray(normalized.order)?normalized.order.slice():OVERVIEW_WIDGET_KEYS.slice();
// Layout: reorder columns.
order.forEach(function(key){var col=grid.querySelector('[data-kexo-overview-widget-col="'+key+'"]');col&&grid.appendChild(col)}),
// Colours: position-based unless overridden.
order.forEach(function(key,idx){var col=grid.querySelector('[data-kexo-overview-widget-col="'+key+'"]');if(col){var card=col.querySelector('[data-kexo-overview-widget="'+key+'"]');if(card&&card.style&&card.style.setProperty){var w=normalized.widgets&&normalized.widgets[key]?normalized.widgets[key]:null,override=w&&w.color?String(w.color):"",css=override||"var(--kexo-accent-"+((3+idx)%10+1)+")";card.style.setProperty("--kexo-accent",css),card.setAttribute("data-kexo-overview-widget-position",String(idx+1))}}})}}function upsertOverviewWidgetsUiConfig(nextCfg){var merged=normalizeOverviewWidgetsUiConfigV1(nextCfg||{});ovwUiCfgLocal=merged;try{localStorage.setItem(OVERVIEW_WIDGETS_UI_CFG_LS_KEY,JSON.stringify(merged))}catch(_){}try{document.dispatchEvent(new CustomEvent("kexo:overviewWidgetsUiConfigUpdated",{detail:{cfg:merged}}))}catch(_){}return merged}function scheduleSaveOverviewWidgetsUiConfig(cfg){ovwSaveQueuedCfg=cfg||ovwSaveQueuedCfg,ovwSaveTimer&&clearTimeout(ovwSaveTimer),ovwSaveTimer=setTimeout(function(){if(ovwSaveTimer=null,!ovwSaveInFlight){var next=ovwSaveQueuedCfg;next&&(ovwSaveQueuedCfg=null,ovwSaveInFlight=function(cfg){var payload={overviewWidgetsUiConfig:normalizeOverviewWidgetsUiConfigV1(cfg||readOverviewWidgetsUiConfigV1())};return fetchWithTimeout("/api/settings",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"same-origin",body:JSON.stringify(payload),keepalive:!0},25e3).then(function(r){return r?r.json().catch(function(){return{ok:r.ok}}):{ok:!1}})}(next).catch(function(){}).finally(function(){ovwSaveInFlight=null,ovwSaveQueuedCfg&&
// Flush any changes that landed while in-flight.
scheduleSaveOverviewWidgetsUiConfig(ovwSaveQueuedCfg)}))}},600)}function setOvwModalMsg(text,ok){var el=document.getElementById("kexo-ovw-modal-msg");el&&(el.textContent=text||"",el.className=!0===ok?"form-hint text-success":!1===ok?"form-hint text-danger":"form-hint text-secondary")}function closeOvwModal(){var modalEl=document.getElementById("kexo-ovw-settings-modal");if(modalEl){try{if("undefined"!=typeof bootstrap&&bootstrap.Modal)return void bootstrap.Modal.getOrCreateInstance(modalEl).hide()}catch(_){}modalEl.classList.remove("show"),modalEl.style.display="none",modalEl.setAttribute("aria-hidden","true");try{document.body.classList.remove("modal-open"),ovwModalBackdrop&&ovwModalBackdrop.parentNode&&ovwModalBackdrop.parentNode.removeChild(ovwModalBackdrop),ovwModalBackdrop=null}catch(_){}}}function ensureOvwModal(){var existing=document.getElementById("kexo-ovw-settings-modal");if(existing)return existing;var wrap=document.createElement("div");wrap.innerHTML='<div class="modal modal-blur" id="kexo-ovw-settings-modal" tabindex="-1" aria-hidden="true"><div class="modal-dialog modal-md modal-dialog-centered" role="dialog" aria-modal="true" aria-label="Widget settings"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="kexo-ovw-modal-title">Widget settings</h5><button type="button" class="btn-close" data-kexo-ovw-modal-close aria-label="Close"></button></div><div class="modal-body"><input type="hidden" id="kexo-ovw-widget-key" /><div class="row g-3"><div class="col-12"><label class="form-label">Sort by</label><select class="form-select" id="kexo-ovw-sort-by"><option value="revenue">Revenue</option><option value="clicks">Clicks</option><option value="ctr">CR</option></select><div class="form-hint" id="kexo-ovw-sort-hint"></div></div><div class="col-12"><label class="form-label">Colour</label><select class="form-select" id="kexo-ovw-color"><option value="var(--kexo-accent-1)">Kexo 1</option><option value="var(--kexo-accent-2)">Kexo 2</option><option value="var(--kexo-accent-3)">Kexo 3</option><option value="var(--kexo-accent-4)">Kexo 4</option><option value="var(--kexo-accent-5)">Kexo 5</option><option value="var(--kexo-accent-6)">Kexo 6</option><option value="var(--kexo-accent-7)">Kexo 7</option><option value="var(--kexo-accent-8)">Kexo 8</option><option value="var(--kexo-accent-9)">Kexo 9</option><option value="var(--kexo-accent-10)">Kexo 10</option><option value="custom">Custom</option></select><div class="mt-2 is-hidden" id="kexo-ovw-color-custom-wrap"><input type="text" class="form-control" id="kexo-ovw-color-custom" placeholder="#4b94e4" maxlength="80" /></div></div><div class="col-12"><label class="form-label">Order</label><select class="form-select" id="kexo-ovw-order"></select></div><div class="col-12 is-hidden" id="kexo-ovw-finishes-groupby-wrap"><label class="form-label">Group by</label><select class="form-select" id="kexo-ovw-finishes-groupby"></select><div class="form-hint" id="kexo-ovw-finishes-groupby-hint"></div></div></div><div class="d-flex align-items-center justify-content-between gap-2 mt-3"><button type="button" class="btn btn-secondary" id="kexo-ovw-reset">Reset to default</button><span id="kexo-ovw-modal-msg" class="form-hint text-secondary"></span></div></div></div></div></div>';var modalEl=wrap.firstChild;document.body.appendChild(modalEl);try{var colorSelect=document.getElementById("kexo-ovw-color");colorSelect&&colorSelect.addEventListener("change",function(){var colorEl=document.getElementById("kexo-ovw-color"),wrap=document.getElementById("kexo-ovw-color-custom-wrap");wrap&&(colorEl&&"custom"===String(colorEl.value||"")?wrap.classList.remove("is-hidden"):wrap.classList.add("is-hidden"))})}catch(_){}return modalEl.addEventListener("click",function(e){var t=e&&e.target?e.target:null;if(t&&t.closest){if(t.closest("[data-kexo-ovw-modal-close]"))return e.preventDefault(),void closeOvwModal();if(t.closest("#kexo-ovw-reset")){e.preventDefault();var key=(document.getElementById("kexo-ovw-widget-key")||{}).value||"";if(!key)return;var cfg=readOverviewWidgetsUiConfigV1(),next=JSON.parse(JSON.stringify(cfg||defaultOverviewWidgetsUiConfigV1()));next.widgets&&next.widgets[key]&&(next.widgets[key].color=""),next.widgets&&next.widgets[key]&&(next.widgets[key].sortBy="revenue"),"finishes"===key&&(next.widgets.finishes.groupBy="finishes"),upsertOverviewWidgetsUiConfig(next=normalizeOverviewWidgetsUiConfigV1(next)),applyOverviewWidgetsLayoutAndColors(next),scheduleSaveOverviewWidgetsUiConfig(next),requestDashboardWidgetsRefresh({force:!1,rangeKey:dashRangeKeyFromDateRange()}),openOvwSettings(key),setOvwModalMsg("Reset.",!0)}}}),["change","input"].forEach(function(evt){modalEl.addEventListener(evt,function(e){var t=e&&e.target?e.target:null;t&&("kexo-ovw-sort-by"!==t.id&&"kexo-ovw-color"!==t.id&&"kexo-ovw-color-custom"!==t.id&&"kexo-ovw-order"!==t.id&&"kexo-ovw-finishes-groupby"!==t.id||function(){var key=(document.getElementById("kexo-ovw-widget-key")||{}).value||"";if(key){var cfg=readOverviewWidgetsUiConfigV1(),next=JSON.parse(JSON.stringify(cfg||defaultOverviewWidgetsUiConfigV1())),sortEl=document.getElementById("kexo-ovw-sort-by"),sortBy=sortEl?String(sortEl.value||"revenue").trim().toLowerCase():"revenue";widgetSupportsSortBy(key,sortBy)||(sortBy="revenue"),next.widgets[key]=Object.assign({},next.widgets[key]||{},{sortBy:sortBy});var colorEl=document.getElementById("kexo-ovw-color"),customEl=document.getElementById("kexo-ovw-color-custom"),colorVal=colorEl?String(colorEl.value||""):"",color="";color="custom"===colorVal?cssValueFromOverride(customEl?customEl.value:"")||"":cssValueFromOverride(colorVal)||"",next.widgets[key]=Object.assign({},next.widgets[key]||{},{color:color});var orderEl=document.getElementById("kexo-ovw-order"),pos=orderEl?parseInt(orderEl.value,10):0;(!Number.isFinite(pos)||pos<1)&&(pos=1),pos=Math.min(OVERVIEW_WIDGET_KEYS.length,Math.max(1,pos));var order=Array.isArray(next.order)?next.order.slice():OVERVIEW_WIDGET_KEYS.slice(),curIdx=order.indexOf(key);if(curIdx>=0&&order.splice(curIdx,1),order.splice(pos-1,0,key),next.order=order,"finishes"===key){var gbEl=document.getElementById("kexo-ovw-finishes-groupby"),gb=gbEl?String(gbEl.value||"finishes").trim().toLowerCase():"finishes";next.widgets.finishes=Object.assign({},next.widgets.finishes||{},{groupBy:gb||"finishes"})}upsertOverviewWidgetsUiConfig(next=normalizeOverviewWidgetsUiConfigV1(next)),applyOverviewWidgetsLayoutAndColors(next),scheduleSaveOverviewWidgetsUiConfig(next),requestDashboardWidgetsRefresh({force:!1,rangeKey:dashRangeKeyFromDateRange()}),setOvwModalMsg("Saved.",!0)}}())})}),modalEl}function openOvwSettings(widgetKeyOrBtn){var key="";if("string"==typeof widgetKeyOrBtn)key=widgetKeyOrBtn;else try{var btn=widgetKeyOrBtn,card=btn&&btn.closest?btn.closest("[data-kexo-overview-widget]"):null;key=card?String(card.getAttribute("data-kexo-overview-widget")||""):""}catch(_){key=""}if(key=String(key||"").trim().toLowerCase(),!(OVERVIEW_WIDGET_KEYS.indexOf(key)<0)){0;ensureOvwModal();var cfg=readOverviewWidgetsUiConfigV1();cfg=normalizeOverviewWidgetsUiConfigV1(cfg);var title=document.getElementById("kexo-ovw-modal-title");title&&(title.textContent=(OVERVIEW_WIDGET_TITLES[key]||"Widget")+" settings");var keyEl=document.getElementById("kexo-ovw-widget-key");keyEl&&(keyEl.value=key);var sortEl=document.getElementById("kexo-ovw-sort-by"),hintEl=document.getElementById("kexo-ovw-sort-hint"),sortBy=cfg.widgets&&cfg.widgets[key]&&cfg.widgets[key].sortBy?String(cfg.widgets[key].sortBy):"revenue";sortEl&&(Array.prototype.forEach.call(sortEl.options||[],function(opt){if(opt&&opt.value){var supported=widgetSupportsSortBy(key,opt.value);opt.disabled=!supported}}),widgetSupportsSortBy(key,sortBy)||(sortBy="revenue"),sortEl.value=sortBy,hintEl&&(hintEl.textContent=widgetSupportsSortBy(key,"ctr")?"":"CR is not available for this widget."));var wrapGb=document.getElementById("kexo-ovw-finishes-groupby-wrap");if(wrapGb&&wrapGb.classList.toggle("is-hidden","finishes"!==key),"finishes"===key){var gbEl=document.getElementById("kexo-ovw-finishes-groupby"),gbHint=document.getElementById("kexo-ovw-finishes-groupby-hint"),selected=cfg.widgets&&cfg.widgets.finishes&&cfg.widgets.finishes.groupBy?String(cfg.widgets.finishes.groupBy):"finishes";gbEl&&(gbEl.innerHTML='<option value="finishes">Finishes</option>',gbEl.value=selected||"finishes"),gbHint&&(gbHint.textContent="Loading tables…"),function(rangeKey,force){var rk=null!=rangeKey?String(rangeKey):dashRangeKeyFromDateRange();rk=(null==rk?"":String(rk)).trim().toLowerCase()||"today";var shop=null;try{shop=getShopForSales()}catch(_){shop=null}var shopKey=shop?String(shop):"",url="/api/insights-variants?range="+encodeURIComponent(rk)+(shopKey?"&shop="+encodeURIComponent(shopKey):"")+(force?"&force=1&_="+Date.now():""),cacheKey="finishes|"+rk+"|"+shopKey;return fetchWidgetJson(cacheKey,url,!!force,3e4).then(function(data){var payload=data&&data.ok&&data.payload?data.payload:data,tables=payload&&Array.isArray(payload.tables)?payload.tables:Array.isArray(data&&data.tables)?data.tables:[],out=[];return(tables||[]).forEach(function(t){if(t){var id=null!=t.id?String(t.id).trim():"";if(id){var name=null!=t.name?String(t.name):id;out.push({id:id,name:name||id})}}}),out}).catch(function(){return[]})}(dashRangeKeyFromDateRange(),!1).then(function(tables){if(gbEl){var list=Array.isArray(tables)?tables:[];if(list.length){var html="";list.forEach(function(t){if(t){var id=null!=t.id?String(t.id):"",name=null!=t.name?String(t.name):id;id&&(html+='<option value="'+escapeHtml(id)+'">'+escapeHtml(name||id)+"</option>")}}),html||(html='<option value="finishes">Finishes</option>'),gbEl.innerHTML=html;var next=selected||"finishes",found=!1;try{Array.prototype.forEach.call(gbEl.options||[],function(opt){opt&&String(opt.value)===String(next)&&(found=!0)})}catch(_){found=!1}found||(next=String(list[0]&&list[0].id?list[0].id:"finishes")),gbEl.value=next,gbHint&&(gbHint.textContent="")}else gbHint&&(gbHint.textContent="")}}).catch(function(){gbHint&&(gbHint.textContent="")})}var orderEl=document.getElementById("kexo-ovw-order");if(orderEl){for(var order=Array.isArray(cfg.order)?cfg.order:OVERVIEW_WIDGET_KEYS.slice(),curPos=Math.max(1,order.indexOf(key)+1),html="",i=1;i<=OVERVIEW_WIDGET_KEYS.length;i++)html+='<option value="'+i+'">'+i+"</option>";orderEl.innerHTML=html,orderEl.value=String(curPos)}var colorEl=document.getElementById("kexo-ovw-color"),customEl=document.getElementById("kexo-ovw-color-custom"),c=cfg.widgets&&cfg.widgets[key]&&cfg.widgets[key].color?String(cfg.widgets[key].color).trim():"";if(colorEl)c&&Array.prototype.some.call(colorEl.options||[],function(opt){return opt&&opt.value===c})?colorEl.value=c:c?(colorEl.value="custom",customEl&&(customEl.value=c)):colorEl.value="var(--kexo-accent-1)";customEl&&colorEl&&"custom"!==colorEl.value&&(customEl.value="");var customWrap=document.getElementById("kexo-ovw-color-custom-wrap");customWrap&&customWrap.classList.toggle("is-hidden",!(colorEl&&"custom"===String(colorEl.value||""))),setOvwModalMsg("",null),function(){var modalEl=document.getElementById("kexo-ovw-settings-modal");if(modalEl){try{if("undefined"!=typeof bootstrap&&bootstrap.Modal)return void bootstrap.Modal.getOrCreateInstance(modalEl).show()}catch(_){}modalEl.classList.add("show"),modalEl.style.display="block",modalEl.setAttribute("aria-hidden","false");try{document.body.classList.add("modal-open"),ovwModalBackdrop&&ovwModalBackdrop.parentNode||((ovwModalBackdrop=document.createElement("div")).className="modal-backdrop fade show",ovwModalBackdrop.addEventListener("click",function(){closeOvwModal()}),document.body.appendChild(ovwModalBackdrop))}catch(_){}}}()}}function ensureTrendingDaysDropdown(){var card=document.querySelector('[data-table-id="dash-trending"]'),headRight=card?card.querySelector(".kexo-widget-head-right"):null;if(headRight){var existing=document.getElementById("dash-trending-days"),preset=getTrendingPreset();if(existing)try{existing.setAttribute("data-trending-preset",preset);var label=existing.querySelector("[data-trending-days-label]");label&&(label.textContent=getTrendingPresetLabel(preset)),existing.querySelectorAll("[data-trending-preset-item]").forEach(function(it){var v=String(it.getAttribute("data-trending-preset-item")||"");it.classList.toggle("active",v===preset)})}catch(_){}else{var wrap=document.createElement("div");wrap.className="dropdown";var btn=document.createElement("button");btn.type="button",btn.id="dash-trending-days",btn.className="btn btn-sm btn-ghost-secondary dropdown-toggle kexo-trending-days-dropdown-btn",btn.setAttribute("data-bs-toggle","dropdown"),btn.setAttribute("aria-expanded","false"),btn.setAttribute("aria-label","Trending period"),btn.setAttribute("data-trending-preset",preset),btn.innerHTML="<span data-trending-days-label>"+escapeHtml(getTrendingPresetLabel(preset))+"</span>";var menu=document.createElement("div");menu.className="dropdown-menu dropdown-menu-end kexo-trending-days-dropdown-menu",menu.setAttribute("role","menu"),TRENDING_PRESETS.forEach(function(presetOpt){var item=document.createElement("button");item.type="button",item.className="dropdown-item",item.textContent=presetOpt.label,item.setAttribute("data-trending-preset-item",presetOpt.value),presetOpt.value===preset&&item.classList.add("active"),item.addEventListener("click",function(e){e.preventDefault();var val=presetOpt.value;setTrendingPreset(val);try{btn.setAttribute("data-trending-preset",val)}catch(_){}try{var lbl=btn.querySelector("[data-trending-days-label]");lbl&&(lbl.textContent=presetOpt.label),menu.querySelectorAll("[data-trending-preset-item]").forEach(function(it){it.classList.toggle("active",String(it.getAttribute("data-trending-preset-item")||"")===val)})}catch(_){}try{window.bootstrap&&window.bootstrap.Dropdown&&window.bootstrap.Dropdown.getOrCreateInstance(btn).hide()}catch(_){}try{dashTrendingPage=1}catch(_){}fetchDashboardData(dashRangeKeyFromDateRange(),!0)}),menu.appendChild(item)}),wrap.appendChild(btn),wrap.appendChild(menu),headRight.insertBefore(wrap,headRight.firstChild)}}}function bindDashWidgetsOnce(){if(!dashWidgetsBound){dashWidgetsBound=!0;try{ensureTrendingDaysDropdown()}catch(_){}try{applyOverviewWidgetsLayoutAndColors(readOverviewWidgetsUiConfigV1())}catch(_){}try{bindDashDocumentClickOnce()}catch(_){}try{document.addEventListener("keydown",function(e){e&&"Escape"===e.key&&closeOvwModal()})}catch(_){}try{document.addEventListener("kexo:overviewWidgetsUiConfigUpdated",function(){try{applyOverviewWidgetsLayoutAndColors(readOverviewWidgetsUiConfigV1())}catch(_){}try{requestDashboardWidgetsRefresh({force:!1,rangeKey:dashRangeKeyFromDateRange()})}catch(_){}})}catch(_){}try{document.addEventListener("kexo:cssVarOverridesUpdated",function(){try{applyOverviewWidgetsLayoutAndColors(readOverviewWidgetsUiConfigV1())}catch(_){}try{requestDashboardWidgetsRefresh({force:!1,rangeKey:dashRangeKeyFromDateRange()})}catch(_){}})}catch(_){}}}function widgetSig(data){try{return fastPayloadHash(JSON.stringify(data||null)||"")}catch(_){return fastPayloadHash(String(Date.now()))}}function fetchWidgetJson(cacheKey,url,force,timeoutMs){var key=String(cacheKey||"").trim();if(!key||!url)return Promise.resolve(null);var now=Date.now(),entry=dashWidgetCache&&dashWidgetCache[key]?dashWidgetCache[key]:null;return!force&&entry&&entry.data&&entry.fetchedAt&&now-entry.fetchedAt<DASH_WIDGET_CACHE_TTL_MS?Promise.resolve(entry.data):(dashWidgetInFlight[key]&&!force||(dashWidgetInFlight[key]=fetchWithTimeout(url,{credentials:"same-origin",cache:force?"no-store":"default"},timeoutMs||25e3).then(function(r){return r&&r.ok?r.json():null}).then(function(data){return data?(dashWidgetCache[key]={fetchedAt:Date.now(),sig:widgetSig(data),data:data},data):null}).catch(function(){return entry&&entry.data?entry.data:null}).finally(function(){dashWidgetInFlight[key]=null})),dashWidgetInFlight[key])}function renderDashTopList(mountId,rows,options){var host=document.getElementById(mountId);if(host){var list=Array.isArray(rows)?rows:[],opts=options&&"object"==typeof options?options:{},accentCss=opts.accentCss?String(opts.accentCss):"",accentClass="";try{var m=/--kexo-accent-(\d+)/.exec(accentCss);m&&m[1]&&(accentClass="kexo-accent-bg-"+String(m[1]))}catch(_){accentClass=""}if(list.length){var html='<ul class="kexo-dash-top-list">';list.forEach(function(r){if(r){var label=null!=r.label?String(r.label):"—",valueGbp=null!=r.valueGbp?Number(r.valueGbp):null!=r.value?Number(r.value):0,pct=null!=r.pct?Number(r.pct):0,cr=null!=r.cr&&Number.isFinite(Number(r.cr))?Number(r.cr):null;Number.isFinite(valueGbp)||(valueGbp=0),Number.isFinite(pct)||(pct=0),pct=Math.max(0,Math.min(100,pct));var crText=null!=cr?fmtPct(cr)+" CR":"—",valueText=null!=r.valueDisplay&&""!==String(r.valueDisplay)?String(r.valueDisplay):fmtGbp(valueGbp),valueClass=null!=r.valueClass&&String(r.valueClass)?" "+String(r.valueClass).trim():"",iconHtml=null!=r.iconHtml?String(r.iconHtml):"";if(r.thumbUrl){var thumbImg='<img src="'+escapeHtml(String(r.thumbUrl))+'" alt="" width="40" height="40" class="kexo-dash-top-thumb" loading="lazy">',canOpen=r.productHandle&&String(r.productHandle)||r.productId&&String(r.productId),productUrl=null!=r.productUrl&&""!==String(r.productUrl)&&"#"!==String(r.productUrl)?String(r.productUrl):"#";iconHtml=canOpen?'<a class="kexo-product-link kexo-dash-top-thumb-link js-product-modal-link" href="'+escapeHtml(productUrl)+'" target="_blank" rel="noopener"'+(r.productHandle?' data-product-handle="'+escapeHtml(String(r.productHandle))+'"':"")+(r.productId?' data-product-id="'+escapeHtml(String(r.productId))+'"':"")+(null!=r.productTitle?' data-product-title="'+escapeHtml(String(r.productTitle))+'"':"")+">"+thumbImg+"</a>":thumbImg}iconHtml||(iconHtml='<span class="kexo-dash-top-row-icon-placeholder" aria-hidden="true"></span>'),html+='<li class="kexo-dash-top-row" title="'+escapeHtml(label)+'"><span class="kexo-dash-top-row-icon" aria-hidden="true">'+iconHtml+'</span><span class="kexo-dash-top-row-label">'+escapeHtml(label)+'</span><span class="kexo-dash-top-row-cr">'+escapeHtml(crText)+'</span><span class="kexo-dash-top-row-value'+valueClass+'">'+escapeHtml(valueText)+'</span><div class="kexo-dash-top-row-bar"><span class="kexo-widget-fill'+(accentClass?" "+accentClass:"")+'" data-kexo-bar-fill="'+escapeHtml(String(pct))+'"></span></div></li>'}}),html+="</ul>",host.innerHTML='<div class="kexo-dash-top-list-wrap">'+html+"</div>",animateWidgetFills(host)}else host.innerHTML='<div class="kexo-dash-top-list-wrap"><div class="kexo-widget-empty">No data</div></div>'}}function animateWidgetFills(root){if(root&&root.querySelectorAll)try{if(root._kexoWidgetFillsRaf)return;var fills=root.querySelectorAll("[data-kexo-bar-fill]");if(!fills||!fills.length)return;root._kexoWidgetFillsRaf=requestAnimationFrame(function(){root._kexoWidgetFillsRaf=0,Array.prototype.forEach.call(fills,function(el){var pct=Number(el.getAttribute("data-kexo-bar-fill")||0);Number.isFinite(pct)||(pct=0),pct=Math.max(0,Math.min(100,pct)),el.classList.contains("kexo-widget-vbar-fill")?el.style.height=pct+"%":el.style.width=pct+"%"})})}catch(_){}}function animateWidgetRadials(root){if(root&&root.querySelectorAll)try{var nodes=root.querySelectorAll("[data-kexo-radial-pct][data-kexo-radial-circ]");if(!nodes||!nodes.length)return;requestAnimationFrame(function(){Array.prototype.forEach.call(nodes,function(el){var pct=Number(el.getAttribute("data-kexo-radial-pct")||0),circ=Number(el.getAttribute("data-kexo-radial-circ")||0);if(Number.isFinite(pct)||(pct=0),Number.isFinite(circ)&&!(circ<=0)){var off=circ*(1-(pct=Math.max(0,Math.min(100,pct)))/100);el.style.strokeDashoffset=String(off)}})})}catch(_){}}function requestDashboardWidgetsRefresh(opts){if(widgetPresent()){bindDashWidgetsOnce();try{applyOverviewWidgetsLayoutAndColors(readOverviewWidgetsUiConfigV1())}catch(_){}var next=opts&&"object"==typeof opts?Object.assign({},opts):{};dashWidgetsPendingOpts=dashWidgetsPendingOpts?Object.assign(dashWidgetsPendingOpts,next):next,dashWidgetsRefreshTimer||(dashWidgetsRefreshTimer=setTimeout(function(){dashWidgetsRefreshTimer=null;var pending=dashWidgetsPendingOpts||{};dashWidgetsPendingOpts=null,function(opts){if(!widgetPresent())return;bindDashWidgetsOnce();var options=opts&&"object"==typeof opts?opts:{},force=!!options.force,rk=null!=options.rangeKey?String(options.rangeKey):dashRangeKeyFromDateRange();rk=(null==rk?"":String(rk)).trim().toLowerCase()||"today";var cfg=normalizeOverviewWidgetsUiConfigV1(readOverviewWidgetsUiConfigV1());try{applyOverviewWidgetsLayoutAndColors(cfg)}catch(_){}var shop=null;try{shop=getShopForSales()}catch(_){shop=null}var shopKey=shop?String(shop):"",base="",ovwAssetOverrides={},ovwOverridesUrl=base+"/api/asset-overrides"+(force?"?_="+Date.now():""),ovwOverridePromise=(force?fetch(ovwOverridesUrl,{credentials:"same-origin",cache:"no-store"}).then(function(r){return r&&r.ok?r.json():null}):kexoFetchOkJsonStable(ovwOverridesUrl,{credentials:"same-origin"},6e4)).then(function(body){body&&body.ok&&body.assetOverrides&&"object"==typeof body.assetOverrides&&(ovwAssetOverrides=body.assetOverrides)}).catch(function(err){try{"function"==typeof window.kexoCaptureError&&window.kexoCaptureError(err,{context:"assetOverrides.fetch",page:"dashboard"})}catch(_){}}),urls={finishes:base+"/api/insights-variants?range="+encodeURIComponent(rk)+(shopKey?"&shop="+encodeURIComponent(shopKey):"")+(force?"&force=1&_="+Date.now():""),devices:base+"/api/devices/report?range="+encodeURIComponent(rk)+(force?"&force=1&_="+Date.now():""),browsers:base+"/api/browsers/table?range="+encodeURIComponent(rk)+(force?"&force=1&_="+Date.now():""),attribution:base+"/api/attribution/report?range="+encodeURIComponent(rk)+(force?"&force=1&_="+Date.now():""),payment_methods:base+"/api/payment-methods/report?range="+encodeURIComponent(rk)+(force?"&force=1&_="+Date.now():""),abandoned:base+"/api/abandoned-carts/top-countries?range="+encodeURIComponent(rk)+(force?"&force=1&_="+Date.now():"")},TOP_N=4;function resolveRootCssVar(name,fallback){try{return getComputedStyle(document.documentElement).getPropertyValue(String(name||"")).trim()||fallback||""}catch(_){return fallback||""}}function resolveCssColor(spec){var v=null==spec?"":String(spec).trim();if(!v)return"";var m=v.match(/^var\((--[a-zA-Z0-9._-]+)\)$/);return m?resolveRootCssVar(m[1],"")||"":v}function accentForWidget(widgetKey){var key=String(widgetKey||"").trim().toLowerCase(),card=null;try{card=document.querySelector('[data-kexo-overview-widget="'+key+'"]')}catch(_){card=null}var css="";try{css=card&&card.style?String(card.style.getPropertyValue("--kexo-accent")||"").trim():""}catch(_){css=""}if(!css){var idx=cfg&&Array.isArray(cfg.order)?cfg.order.indexOf(key):-1;css="var(--kexo-accent-"+((3+(idx>=0?idx:0))%10+1)+")"}return resolveCssColor(css)||resolveRootCssVar("--kexo-accent-1","#4b94e4")||"#4b94e4"}function browserIconHtmlForKey(rawKey,label){var k=(null==rawKey?"":String(rawKey)).trim().toLowerCase(),titleAttr=label?' title="'+escapeHtml(label)+'"':"";return k?k.indexOf("chrome")>=0&&k.indexOf("chromium")<0?'<i class="fa-brands fa-chrome" data-icon-key="type-browser-chrome" aria-hidden="true"'+titleAttr+"></i>":k.indexOf("safari")>=0&&k.indexOf("chrome")<0?'<i class="fa-brands fa-safari" data-icon-key="type-browser-safari" aria-hidden="true"'+titleAttr+"></i>":k.indexOf("edge")>=0?'<i class="fa-brands fa-edge" data-icon-key="type-browser-edge" aria-hidden="true"'+titleAttr+"></i>":k.indexOf("firefox")>=0?'<i class="fa-brands fa-firefox-browser" data-icon-key="type-browser-firefox" aria-hidden="true"'+titleAttr+"></i>":k.indexOf("opera")>=0?'<i class="fa-brands fa-opera" data-icon-key="type-browser-opera" aria-hidden="true"'+titleAttr+"></i>":'<i class="fa-light fa-globe" data-icon-key="type-browser-other" aria-hidden="true"'+titleAttr+"></i>":'<i class="fa-light fa-globe" aria-hidden="true"'+titleAttr+"></i>"}function metricValue(row,metric){return row?"clicks"===metric?Number(row.clicks)||0:"ctr"===metric?Number(row.ctr)||0:Number(row.revenue)||0:0}function fmtMetric(metric,row){if(!row)return"—";if("clicks"===metric)return fmtNum(Number(row.clicks)||0);if("ctr"===metric){var p=null!=row.ctr?Number(row.ctr):null;return Number.isFinite(p)?(Math.round(10*p)/10).toFixed(1)+"%":"—"}return fmtGbp2(Number(row.revenue)||0)}function sortTop(rows,metric,limit){var list=Array.isArray(rows)?rows.slice():[];return list.sort(function(a,b){return metricValue(b,metric)-metricValue(a,metric)}),list.slice(0,Math.max(0,Number(limit)||0))}function stripSvgDimensions(html){return"string"==typeof html&&html?html.replace(/<svg(\s[^>]*?)>/gi,function(match,attrs){return"<svg"+attrs.replace(/\s+width\s*=\s*["'][^"']*["']/gi,"").replace(/\s+height\s*=\s*["'][^"']*["']/gi,"")+">"}):html}var LIST_ROW_COUNT=3;function renderList(widgetKey,rows,sortBy,shareBaseRows){var mountId="dash-ovw-"+widgetKey+"-list",host=document.getElementById(mountId);if(host){var i,list=Array.isArray(rows)?rows:[],metric="clicks"===sortBy?"clicks":"ctr"===sortBy?"ctr":"revenue",shareBase=Array.isArray(shareBaseRows)?shareBaseRows:list,total="ctr"===metric?0:shareBase.reduce(function(acc,r){return acc+metricValue(r,metric)},0)||0,html='<ul class="kexo-widget-list">';for(i=0;i<list.length;i++){var r=list[i],label=r&&null!=r.label?String(r.label):"—",icon=r&&r.iconHtml?stripSvgDimensions(String(r.iconHtml)):'<span class="kexo-dash-top-row-icon-placeholder" aria-hidden="true"></span>',valText=fmtMetric(metric,r),seriesVal=metricValue(r,metric),pct="ctr"===metric?Number.isFinite(Number(seriesVal))?Number(seriesVal):0:total>0?seriesVal/total*100:0;Number.isFinite(pct)||(pct=0),pct=Math.max(0,Math.min(100,pct)),html+='<li class="kexo-widget-row" title="'+escapeHtml(label)+'"><span class="kexo-widget-row-icon" aria-hidden="true">'+icon+'</span><span class="kexo-widget-row-label">'+escapeHtml(label)+'</span><span class="kexo-widget-row-value">'+escapeHtml(valText)+'</span><div class="kexo-widget-row-bar"><span data-kexo-bar-fill="'+escapeHtml(String(pct))+'"></span></div></li>'}for(i=list.length;i<LIST_ROW_COUNT;i++)html+='<li class="kexo-widget-row kexo-widget-row--skeleton" aria-hidden="true"><span class="kexo-widget-row-icon"><span class="kexo-dash-top-row-icon-placeholder"></span></span><span class="kexo-widget-row-label kexo-widget-row-skeleton-text"></span><span class="kexo-widget-row-value kexo-widget-row-skeleton-text"></span><div class="kexo-widget-row-bar kexo-widget-row-bar--skeleton"><span></span></div></li>';html+="</ul>",host.innerHTML=html,animateWidgetFills(host)}}function renderChart(widgetKey,rows,sortBy){var chartId="dash-ovw-"+widgetKey+"-chart",chartEl=document.getElementById(chartId);if(chartEl){try{dashCharts&&dashCharts[chartId]&&"function"==typeof dashCharts[chartId].destroy&&(dashCharts[chartId].destroy(),dashCharts[chartId]=null)}catch(_){}var list=Array.isArray(rows)?rows:[];if(list.length){var metric="clicks"===sortBy?"clicks":"ctr"===sortBy?"ctr":"revenue",top=list[0]||null;if(top){var pct=0;if("ctr"===metric)pct=Number(top.ctr),Number.isFinite(pct)||(pct=0),pct=Math.max(0,Math.min(100,pct));else{var total=list.reduce(function(acc,r){return acc+Math.max(0,metricValue(r,metric))},0)||0,topVal=Math.max(0,metricValue(top,metric));pct=total>0?topVal/total*100:0,Number.isFinite(pct)||(pct=0),pct=Math.max(0,Math.min(100,pct))}var icon=top&&top.iconHtml?stripSvgDimensions(String(top.iconHtml)):"",labelText=top&&null!=top.label?String(top.label):"—",valueText=fmtMetric(metric,top),ctrLabel="payment_methods"===widgetKey?"Share":"CR",shareText="ctr"===metric?ctrLabel:String(Math.round(pct))+"% share",tip=labelText+"\n"+valueText+"\n"+("ctr"===metric?ctrLabel+": "+valueText:"Share: "+(Math.round(10*pct)/10).toFixed(1)+"%"),size=111,r=41,strokeW=8,cx=size/2,cy=size/2,circ=Math.round(2*Math.PI*r*1e3)/1e3,dashOffset=Math.round(1e3*(circ-pct/100*circ))/1e3;chartEl.innerHTML='<div class="kexo-ovw-ring-row" title="'+escapeHtml(tip)+'"><div class="kexo-ovw-ring-wrap kexo-ovw-ring-wrap--small"><div class="kexo-ovw-ring"><svg width="'+size+'" height="'+size+'" viewBox="0 0 '+size+" "+size+'" aria-hidden="true"><circle cx="'+cx+'" cy="'+cy+'" r="'+r+'" fill="none" stroke="rgba(15,23,42,0.10)" stroke-width="'+strokeW+'"></circle><circle class="kexo-widget-radial-progress" cx="'+cx+'" cy="'+cy+'" r="'+r+'" fill="none" stroke="var(--kexo-accent, var(--kexo-accent-1, #4b94e4))" stroke-width="'+strokeW+'" stroke-linecap="round" stroke-dasharray="'+escapeHtml(String(circ))+'" stroke-dashoffset="'+escapeHtml(String(dashOffset))+'" data-kexo-radial-pct="'+escapeHtml(String(pct))+'" data-kexo-radial-circ="'+escapeHtml(String(circ))+'"></circle></svg><div class="kexo-ovw-ring-center kexo-ovw-ring-center--icon-only">'+(icon?'<div class="kexo-ovw-ring-icon" aria-hidden="true">'+icon+"</div>":"")+'</div></div></div><div class="kexo-ovw-ring-right"><div class="kexo-ovw-ring-right-name">'+escapeHtml(labelText)+'</div><div class="kexo-ovw-ring-right-value">'+escapeHtml(valueText)+'</div><div class="kexo-ovw-ring-right-pct">'+escapeHtml(shareText)+"</div></div></div>",animateWidgetRadials(chartEl)}else chartEl.innerHTML=""}else chartEl.innerHTML=""}}function extractRows(widgetKey,data){var key=String(widgetKey||"").trim().toLowerCase(),payload=data&&data.ok&&data.payload?data.payload:data;if(!payload||"object"!=typeof payload)return[];if("finishes"===key){var tables=Array.isArray(payload.tables)?payload.tables:[],tableId=cfg&&cfg.widgets&&cfg.widgets.finishes&&cfg.widgets.finishes.groupBy?String(cfg.widgets.finishes.groupBy):"",table=((tableId=tableId.trim().toLowerCase())?tables.find(function(t){return t&&String(t.id||"").trim().toLowerCase()===tableId}):null)||tables[0]||null;return(table&&Array.isArray(table.rows)?table.rows:[]).map(function(r){var label=r&&(r.variant||r.key)?String(r.variant||r.key):"—",iconSpec=r&&null!=r.icon_spec?String(r.icon_spec).trim():"",fallbackSpec=ovwAssetOverrides&&ovwAssetOverrides.overview_widget_finishes?String(ovwAssetOverrides.overview_widget_finishes).trim():"",iconHtml=iconSpec?attributionIconSpecToHtml(iconSpec,label):fallbackSpec?attributionIconSpecToHtml(fallbackSpec,label):'<i class="fa-light fa-gem" data-icon-key="overview-widget-finishes" aria-hidden="true"></i>';return{label:label,revenue:Number(r&&(null!=r.revenue_gbp?r.revenue_gbp:r.revenue))||0,clicks:Number(r&&r.sessions)||0,ctr:r&&null!=r.cr?Number(r.cr):null,iconHtml:iconHtml}})}if("devices"===key){var devRows=payload.devices&&Array.isArray(payload.devices.rows)?payload.devices.rows:[],platformAgg={};return devRows.forEach(function(r){(r&&Array.isArray(r.platforms)?r.platforms:[]).forEach(function(p){var plat=p&&null!=p.platform?String(p.platform).trim().toLowerCase():"";if(plat){var cur=platformAgg[plat]||{sessions:0,orders:0,revenueGbp:0};cur.sessions+=Number(p&&p.sessions)||0,cur.orders+=Number(p&&p.orders)||0,cur.revenueGbp+=Number(p&&(null!=p.revenue_gbp?p.revenue_gbp:p.revenue))||0,platformAgg[plat]=cur}})}),Object.keys(platformAgg).sort(function(a,b){return(platformAgg[b].sessions||0)-(platformAgg[a].sessions||0)}).map(function(plat){var agg=platformAgg[plat],label=plat?plat.charAt(0).toUpperCase()+plat.slice(1):"—",icon="android"===plat?"fa-brands fa-android":"ios"===plat?"fa-brands fa-apple":"windows"===plat?"fa-brands fa-windows":"macos"===plat||"mac"===plat?"fa-brands fa-apple":"linux"===plat?"fa-brands fa-linux":"other"===plat?"fa-light fa-desktop":"fa-light fa-mobile-screen",iconKey="android"===plat?"type-platform-android":"ios"===plat?"type-platform-ios":"windows"===plat?"type-platform-windows":"macos"===plat||"mac"===plat?"type-platform-mac":"linux"===plat?"type-platform-linux":"type-platform-unknown",ctr=agg.sessions>0&&null!=agg.orders?agg.orders/agg.sessions*100:null,devFallback=ovwAssetOverrides&&ovwAssetOverrides.overview_widget_devices?String(ovwAssetOverrides.overview_widget_devices).trim():"",rowIcon=devFallback?attributionIconSpecToHtml(devFallback,label):'<i class="'+escapeHtml(icon)+'" data-icon-key="'+escapeHtml(iconKey)+'" aria-hidden="true"></i>';return{label:label,revenue:Math.round(100*(Number(agg.revenueGbp)||0))/100,clicks:Number(agg.sessions)||0,ctr:Number.isFinite(ctr)?Math.round(10*ctr)/10:null,iconHtml:rowIcon}})}if("browsers"===key){var brRows=Array.isArray(payload.rows)?payload.rows:[],brFallback=ovwAssetOverrides&&ovwAssetOverrides.overview_widget_browsers?String(ovwAssetOverrides.overview_widget_browsers).trim():"";return brRows.map(function(r){var label=r&&null!=r.ua_browser?String(r.ua_browser):"—",iconHtml=brFallback?attributionIconSpecToHtml(brFallback,label):browserIconHtmlForKey(label,label);return{label:label,revenue:Number(r&&r.revenue)||0,clicks:Number(r&&r.sessions)||0,ctr:r&&null!=r.cr?Number(r.cr):null,iconHtml:iconHtml}})}if("abandoned"===key){var abRows=Array.isArray(payload.rows)?payload.rows:[],abFallback=ovwAssetOverrides&&ovwAssetOverrides.overview_widget_abandoned?String(ovwAssetOverrides.overview_widget_abandoned).trim():"";return abRows.map(function(r){var cc=r&&null!=r.country?String(r.country):"—",iconHtml=(cc=String(cc||"").trim().toUpperCase().slice(0,2)||"—")&&/^[A-Z]{2}$/.test(cc)?countryCodeToFlagHtml(cc):abFallback?attributionIconSpecToHtml(abFallback,cc):'<i class="fa-light fa-globe" data-icon-key="overview-widget-abandoned" aria-hidden="true"></i>';return{label:cc,revenue:Number(r&&r.abandoned_value_gbp)||0,clicks:Number(r&&r.checkout_sessions)||0,ctr:null,iconHtml:iconHtml}})}if("attribution"===key){var chans=payload.attribution&&Array.isArray(payload.attribution.rows)?payload.attribution.rows:[],agg={};chans.forEach(function(ch){(ch&&Array.isArray(ch.sources)?ch.sources:[]).forEach(function(s){var k=s&&(s.source_key||s.label)?String(s.source_key||s.label):"";if(k){var cur=agg[k]||{label:"",iconSpec:"",sessions:0,orders:0,revenue:0};cur.label=cur.label||(s&&null!=s.label?String(s.label):k),cur.iconSpec=cur.iconSpec||(s&&null!=s.icon_spec?String(s.icon_spec):""),cur.sessions+=Number(s&&s.sessions)||0,cur.orders+=Number(s&&s.orders)||0,cur.revenue+=Number(s&&s.revenue_gbp)||0,agg[k]=cur}})});var attrFallback=ovwAssetOverrides&&ovwAssetOverrides.overview_widget_attribution?String(ovwAssetOverrides.overview_widget_attribution).trim():"";return Object.keys(agg).map(function(k){var a=agg[k],iconHtml=a.iconSpec?attributionIconSpecToHtml(a.iconSpec,a.label):attrFallback?attributionIconSpecToHtml(attrFallback,a.label):'<i class="fa-light fa-share-nodes" data-icon-key="overview-widget-attribution" aria-hidden="true"></i>',ctr=a.sessions>0?Math.round(a.orders/a.sessions*1e3)/10:null;return{label:a.label||k,revenue:a.revenue||0,clicks:a.sessions||0,ctr:ctr,iconHtml:iconHtml}})}if("payment_methods"===key){var payRows=Array.isArray(payload.rows)?payload.rows:[],payFallback=ovwAssetOverrides&&ovwAssetOverrides.overview_widget_payment_methods?String(ovwAssetOverrides.overview_widget_payment_methods).trim():"";return payRows.map(function(r){var label=r&&null!=r.label?String(r.label):"—",key2=r&&null!=r.key?String(r.key).trim().toLowerCase():"other",iconSpec=r&&null!=r.iconSpec?String(r.iconSpec).trim():"",iconSrc=r&&r.iconSrc?String(r.iconSrc):"",iconAlt=r&&r.iconAlt?String(r.iconAlt):label,iconHtml=iconSpec?attributionIconSpecToHtml(iconSpec,iconAlt):payFallback?attributionIconSpecToHtml(payFallback,iconAlt):iconSrc?'<img src="'+escapeHtml(iconSrc)+'" alt="'+escapeHtml(iconAlt)+'" width="18" height="18" data-icon-key="payment-method-'+escapeHtml(key2||"other")+'">':'<i class="fa-light fa-credit-card" data-icon-key="payment-method-'+escapeHtml(key2||"other")+'" aria-hidden="true"></i>';return{label:label,revenue:Number(r&&(null!=r.revenue?r.revenue:r.revenue_gbp))||0,clicks:Number(r&&r.sessions)||0,ctr:r&&null!=r.cr?Number(r.cr):null,iconHtml:iconHtml}})}return[]}function renderWidget(widgetKey,data){var key=String(widgetKey||"").trim().toLowerCase(),sortBy=cfg&&cfg.widgets&&cfg.widgets[key]&&cfg.widgets[key].sortBy?String(cfg.widgets[key].sortBy):"revenue";widgetSupportsSortBy(key,sortBy=String(sortBy||"").trim().toLowerCase())||(sortBy="revenue");var top=sortTop(extractRows(key,data),sortBy,TOP_N);if("finishes"===key){var payload=data&&data.ok&&data.payload?data.payload:data,tables=Array.isArray(payload&&payload.tables)?payload.tables:[],gb=cfg&&cfg.widgets&&cfg.widgets.finishes&&cfg.widgets.finishes.groupBy?String(cfg.widgets.finishes.groupBy).trim().toLowerCase():"finishes",table=(gb?tables.find(function(t){return t&&String(t.id||"").trim().toLowerCase()===gb}):null)||tables[0]||null,titleText=table&&table.name?String(table.name):"Finishes",titleEl=document.querySelector('[data-kexo-overview-widget="finishes"] .kexo-widget-title');titleEl&&(titleEl.textContent=titleText)}if(top&&top.length){var sig=widgetSig({key:key,rk:rk,sortBy:sortBy,pos:cfg&&Array.isArray(cfg.order)?cfg.order.indexOf(key):-1,color:cfg&&cfg.widgets&&cfg.widgets[key]&&cfg.widgets[key].color?String(cfg.widgets[key].color):"",accent:accentForWidget(key),rows:top}),listMountId="dash-ovw-"+key+"-list";if(force||!dashWidgetLastRenderSig[listMountId]||dashWidgetLastRenderSig[listMountId]!==sig)if(dashWidgetLastRenderSig[listMountId]=sig,renderChart(key,top,sortBy),top.length<=1)try{document.getElementById("dash-ovw-"+key+"-list").innerHTML=""}catch(_){}else renderList(key,top.slice(1),sortBy,top)}else{try{document.getElementById("dash-ovw-"+key+"-chart").innerHTML=""}catch(_){}try{document.getElementById("dash-ovw-"+key+"-list").innerHTML='<div class="kexo-widget-empty">No data</div>'}catch(_){}}}var tasks=(cfg&&Array.isArray(cfg.order)?cfg.order.slice():OVERVIEW_WIDGET_KEYS.slice()).map(function(key){var url=urls[key];return url?fetchWidgetJson(key+"|"+rk+("finishes"===key?"|"+shopKey:""),url,force,"finishes"===key?3e4:25e3).then(function(data){try{renderWidget(key,data)}catch(_){}}):Promise.resolve(null)});
// Wait for asset overrides so overview_widget_* icons are available in extractRows.
ovwOverridePromise.then(function(){return Promise.all(tasks.map(function(p){return Promise.resolve(p).then(function(v){return{status:"fulfilled",value:v}},function(err){return{status:"rejected",reason:err}})}))}).then(function(){})}(pending)},160))}}window.refreshDashboard=function(opts){var force=opts&&opts.force,silent=!(!opts||!opts.silent),rerender=!(!opts||!opts.rerender),reason=opts&&null!=opts.reason?String(opts.reason):"",rk=dashRangeKeyFromDateRange();try{var curYmd=ymdNowInTz();curYmd&&dashLastDayYmd&&dashLastDayYmd!==curYmd&&(dashCache=null,dashLastRangeKey=null,dashLastTrendingPreset=null,dashPayloadSignature="",force=!0),curYmd&&(dashLastDayYmd=curYmd)}catch(_){}var trendingPreset=getTrendingPreset();if(!force&&dashCache&&dashLastRangeKey===rk&&dashLastTrendingPreset===trendingPreset)return rerender&&renderDashboard(dashCache),fetchOverviewCardData("dash-chart-overview-30d",{force:!1,renderIfFresh:!0}),void requestDashboardWidgetsRefresh({force:!1,rangeKey:rk});fetchDashboardData(rk,force,{silent:silent,rerender:rerender,reason:reason})},window.refreshKexoScore=function(){return fetchKexoScore(dashRangeKeyFromDateRange())},document.getElementById("header-kexo-score-wrap")&&fetchKexoScore(dashRangeKeyFromDateRange());
// Initial fetch: refreshDashboard is defined after setTab('dashboard') runs,
// so the initial setTab call can't trigger it. Kick it off now if dashboard is active.
var dashPanel=document.getElementById("tab-panel-dashboard");dashPanel&&(dashPanel.classList.contains("active")||"dashboard"===PAGE)&&fetchDashboardData(dashRangeKeyFromDateRange(),!1);try{window.dashboardController&&"function"==typeof window.dashboardController.destroy&&window.dashboardController.destroy()}catch(_){}dashController=function(){var pollTimer=null,visibilityBound=!1,pageShowBound=!1,mainTabBound=!1,lastResumeAt=0;function isVisible(){try{return!document||!document.visibilityState||"visible"===document.visibilityState}catch(_){return!0}}function stopPolling(){if(pollTimer){try{clearInterval(pollTimer)}catch(_){}pollTimer=null}}function pollTick(){var rk;if(isVisible()&&(function(){try{var p=document.getElementById("tab-panel-dashboard");return p&&p.classList.contains("active")||"dashboard"===PAGE}catch(_){return"dashboard"===PAGE}}()&&("today"===(rk=dashRangeKeyFromDateRange())||"1h"===rk)&&!dashLoading))try{"function"==typeof window.refreshDashboard&&window.refreshDashboard({force:!0,silent:!0})}catch(_){}}function startPolling(){stopPolling(),isVisible()&&(pollTimer=setInterval(pollTick,12e4))}// Skip full refresh if tab was hidden < 30s
function refreshOnceAndResume(reason){var now=Date.now();if(!(now-lastResumeAt<1e3)){var lastHidden="number"==typeof window.__kexoLastHiddenAt?window.__kexoLastHiddenAt:0,idleMs=lastHidden?now-lastHidden:0;if(idleMs>0&&idleMs<3e4)startPolling();else{lastResumeAt=now;try{"function"==typeof window.refreshDashboard&&window.refreshDashboard({force:!0,silent:!0,reason:reason||"resume"})}catch(_){}try{refreshKpis({force:!0})}catch(_){}startPolling()}}}function onVisibilityChange(){if(isVisible()){try{resumeOverviewResizeObservers()}catch(_){}refreshOnceAndResume("visibility")}else{stopPolling();try{window.__kexoLastHiddenAt=Date.now()}catch(_){}try{pauseOverviewResizeObservers()}catch(_){}}}function onPageShow(ev){ev&&ev.persisted&&refreshOnceAndResume("pageshow")}function onMainTabChanged(ev){var next=ev&&ev.detail&&null!=ev.detail.tab?String(ev.detail.tab).trim().toLowerCase():"";if(next&&"dashboard"!==next)try{pauseOverviewResizeObservers()}catch(_){}else try{resumeOverviewResizeObservers()}catch(_){}}return{init:function(){startPolling(),visibilityBound||(document.addEventListener("visibilitychange",onVisibilityChange),visibilityBound=!0),pageShowBound||(window.addEventListener("pageshow",onPageShow),pageShowBound=!0),mainTabBound||(window.addEventListener("kexo:main-tab-changed",onMainTabChanged),mainTabBound=!0)},destroy:function(){if(stopPolling(),visibilityBound){try{document.removeEventListener("visibilitychange",onVisibilityChange)}catch(_){}visibilityBound=!1}if(pageShowBound){try{window.removeEventListener("pageshow",onPageShow)}catch(_){}pageShowBound=!1}if(mainTabBound){try{window.removeEventListener("kexo:main-tab-changed",onMainTabChanged)}catch(_){}mainTabBound=!1}},startPolling:startPolling,stopPolling:stopPolling,onVisibleResume:refreshOnceAndResume,pollNow:pollTick}}();try{window.dashboardController=dashController}catch(_){}try{dashController.init()}catch(_){}
// When Profit Rules are saved via the dashboard Cost Settings modal,
// refresh the 7d overview snapshot payload (cost/revenue series depend on profit rule fingerprint).
try{dashProfitRulesUpdatedHandler||(dashProfitRulesUpdatedHandler=function(){
// This event can fire outside the dashboard context; avoid doing any work unless the dashboard is present/active.
try{var p=document.getElementById("tab-panel-dashboard");if(!p)return;if(!("dashboard"===PAGE||p.classList&&p.classList.contains("active")||"string"==typeof activeMainTab&&"dashboard"===activeMainTab))return}catch(_){}try{fetchOverviewCardData("dash-chart-overview-30d",{force:!0,renderIfFresh:!0})}catch(_){}try{requestDashboardWidgetsRefresh({force:!0,rangeKey:dashRangeKeyFromDateRange()})}catch(_){}}),dashProfitRulesUpdatedBound||(window.addEventListener("kexo:profitRulesUpdated",dashProfitRulesUpdatedHandler),dashProfitRulesUpdatedBound=!0)}catch(_){}
// Failsafe: on some post-login flows (mobile app switching, bfcache restores),
// the first dashboard fetch can be skipped or run while hidden. If we still have
// no cache shortly after load, trigger ONE silent refresh.
"dashboard"===PAGE&&setTimeout(function(){try{if(dashCache)return;if(dashLoading)return;var p=document.getElementById("tab-panel-dashboard");if(!p)return;if(!p.classList.contains("active")&&"dashboard"!==PAGE)return;"function"==typeof window.refreshDashboard&&window.refreshDashboard({force:!0,silent:!0})}catch(_){}},1200),registerCleanup(function(){try{dashController&&"function"==typeof dashController.destroy&&dashController.destroy()}catch(_){}})}(),
// ?????? User avatar: fetch /api/me and populate ????????????????????????????????????????????????????????????????????????
function(){try{
// Stable GETs: use short TTL + error reporting to reduce duplicate fetches.
var avatarEl=document.getElementById("user-avatar"),emailEl=document.getElementById("user-email");
// We still fetch /api/me even if avatar elements are missing, so we can gate master-only UI.
kexoFetchJsonStable("/api/me",{credentials:"same-origin"},6e4).then(function(d){var isMaster=!(!d||!d.isMaster);try{window.__kexoMe=d||null}catch(_){}try{window.__kexoIsMasterUser=isMaster}catch(_){}try{window.dispatchEvent(new CustomEvent("kexo:me-loaded",{detail:{isMaster:isMaster,email:d&&d.email?String(d.email):""}}))}catch(_){}try{"function"==typeof window.__kexoApplyEffectiveViewer&&window.__kexoApplyEffectiveViewer()}catch(_){}d&&d.email&&(avatarEl&&d.initial&&(avatarEl.textContent=d.initial),emailEl&&(emailEl.textContent=d.email))}).catch(function(err){try{"function"==typeof window.kexoCaptureError&&window.kexoCaptureError(err,{context:"me.fetch"})}catch(_){}try{window.__kexoMe=null}catch(_){}try{window.__kexoIsMasterUser=!1}catch(_){}try{window.dispatchEvent(new CustomEvent("kexo:me-loaded",{detail:{isMaster:!1,email:""}}))}catch(_){}try{"function"==typeof window.__kexoApplyEffectiveViewer&&window.__kexoApplyEffectiveViewer()}catch(_){}})}catch(_){}}(),
// ?????? Online badge: populate website name from store config ????????????????????????????????????
function(){try{var el=document.getElementById("kexo-online-website");if(!el)return;kexoFetchJsonStable("/api/store-base-url",{credentials:"same-origin"},3e5).then(function(d){var domain=d&&d.shopDisplayDomain?String(d.shopDisplayDomain).trim():"";el.textContent=domain||"—",el.title=domain||""}).catch(function(err){try{"function"==typeof window.kexoCaptureError&&window.kexoCaptureError(err,{context:"storeBaseUrl.fetch"})}catch(_){}})}catch(_){}}(),
// ?????? Footer action buttons ??????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
function(){function doCacheReload(){var url=window.location.pathname+(window.location.search||"");url+=(url.indexOf("?")>=0?"&":"?")+"_="+Date.now(),window.location.hash&&(url+=window.location.hash),window.location.href=url}document.querySelectorAll(".footer-settings-cache-reload, .footer-cache-reload-btn").forEach(function(btn){btn.addEventListener("click",doCacheReload)});var backToTop=document.getElementById("back-to-top-btn");backToTop&&backToTop.addEventListener("click",function(){function scrollToTop(){try{window.scrollTo({top:0,behavior:"smooth"})}catch(_){window.scrollTo(0,0)}document.documentElement&&(document.documentElement.scrollTop=0),document.body&&(document.body.scrollTop=0);try{window.scrollTo(0,0)}catch(_){}if(window.parent!==window){try{window.parent.scrollTo({top:0,behavior:"smooth"})}catch(_){}try{window.parent.scrollTo(0,0)}catch(_){}}}scrollToTop(),requestAnimationFrame(scrollToTop)})}(),
// ?????? Footer diagnostics strip (status tags from config-status) ?????????????????????
function(){var wrap=document.getElementById("kexo-footer-diagnostics"),tagsEl=document.getElementById("kexo-footer-diagnostics-tags");if(wrap&&tagsEl){var active=!1,token=0;try{"function"==typeof window.__kexoGetEffectiveViewer&&applyFromViewer(window.__kexoGetEffectiveViewer())}catch(_){}window.addEventListener("kexo:viewer-changed",function(ev){try{applyFromViewer(ev&&ev.detail?ev.detail:null)}catch(_){}})}function applyFromViewer(viewer){if(!!(!viewer||!0!==viewer.isAdmin&&!0!==viewer.isMaster))return function(){token+=1,active=!1;try{wrap.style.display="none"}catch(_){}try{tagsEl.innerHTML=""}catch(_){}}();!function(){if(!active){active=!0;var myToken=token+=1,url="/api/config-status";try{var shop=getShopParam()||("string"==typeof shopForSalesFallback&&shopForSalesFallback?shopForSalesFallback:null);shop&&(url+=(url.indexOf("?")>=0?"&":"?")+"shop="+encodeURIComponent(shop))}catch(_){}kexoFetchOkJsonStable(url,{credentials:"same-origin"},15e3).then(function(c){if(myToken===token&&c){var items=[],px=c.pixel,ads=c.ads&&c.ads.status?c.ads.status:null,gaProvider=ads&&Array.isArray(ads.providers)?ads.providers.find(function(p){return p&&"google_ads"===String(p.key||"").toLowerCase()}):null,gaConnected=!(!gaProvider||!gaProvider.connected);items.push({key:"pixel",label:"Kexo Pixel",status:px&&!0===px.installed?"Online":"Offline",ok:!(!px||!0!==px.installed)}),items.push({key:"google_ads",label:"Google Ads",status:gaConnected?"Connected":"Offline",ok:gaConnected});var html="";items.forEach(function(it){var statusCls=it.ok?"kexo-status-indicator--online":"kexo-status-indicator--offline",esc=function(s){return String(s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")};html+='<div class="kexo-footer-diagnostics-tag">',html+='<a href="/settings/admin/diagnostics" class="kexo-footer-diagnostics-tag-link" title="'+esc(it.label)+" "+esc(it.status)+' — click for diagnostics">',html+='<span class="kexo-footer-diagnostics-label">'+esc(it.label)+"</span>",html+="</a>",html+='<span class="kexo-footer-diagnostics-status">',html+='<span class="kexo-status-indicator '+statusCls+'" aria-hidden="true"></span>'+esc(it.status),html+="</span>",html+="</div>"}),tagsEl.innerHTML=html,wrap.style.display="block"}}).catch(function(err){try{"function"==typeof window.kexoCaptureError&&window.kexoCaptureError(err,{context:"configStatus.fetch",page:PAGE||""})}catch(_){}})}}()}}(),
// ?????? Shared Product Insights modal ?????????????????????????????????????????????????????????????????????????????????????????????????????????
function(){if(!window.__productInsightsModalInit){window.__productInsightsModalInit=!0;var modalEl=null,currentMode="product",currentHandle=null,currentProductId=null,currentTitle=null,currentProductUrl=null,currentPageUrl=null,currentLandingKind=null,currentRangeKey="today",lastPayload=null,backdropEl=null,charts={revenue:null,activity:null},apexLoading=!1,apexWaiters=[];
// Delegate clicks from product links (tables, breakdowns, etc.)
document.addEventListener("click",function(e){var a=e&&e.target&&e.target.closest?e.target.closest("a.js-product-modal-link"):null;if(a&&!function(e){return!!e&&(!!e.defaultPrevented||null!=e.button&&0!==e.button||!!(e.metaKey||e.ctrlKey||e.shiftKey||e.altKey))}(e)){var h=normalizeHandle(a.getAttribute("data-product-handle")||"");h||(h=function(href){if(!href)return"";try{var u=new URL(String(href),window.location.origin),m=String(u.pathname||"").match(/^\/products\/([^/?#]+)/i);if(m&&m[1])return normalizeHandle(decodeURIComponent(m[1]))}catch(_){}var m2=String(href).match(/\/products\/([^/?#]+)/i);return m2&&m2[1]?normalizeHandle(m2[1]):""}(a.getAttribute("href")||""));var pid=(a.getAttribute("data-product-id")||"").trim();(h||pid)&&(e.preventDefault(),openProduct(h||pid,{title:a.getAttribute("data-product-title")||"",productUrl:a.getAttribute("href")||"",productId:pid||void 0}))}}),
// Expose for debugging / future use
window.__openProductInsights=openProduct}function normalizeHandle(h){return h?String(h).trim().toLowerCase().slice(0,128):""}function destroyCharts(){try{charts.revenue&&charts.revenue.destroy()}catch(_){}try{charts.activity&&charts.activity.destroy()}catch(_){}charts.revenue=null,charts.activity=null}function ensureDom(){if(modalEl)return modalEl;if(modalEl=document.getElementById("product-insights-modal"))return modalEl;var wrap=document.createElement("div");wrap.className="modal modal-blur fade",wrap.id="product-insights-modal",wrap.tabIndex=-1,wrap.setAttribute("aria-hidden","true"),wrap.style.display="none",wrap.innerHTML='<div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable" role="dialog"><div class="modal-content"><div class="modal-header p-4"><h5 class="modal-title" id="product-insights-title">Product</h5><div class="ms-auto d-flex align-items-center gap-2"><select class="form-select form-select-sm" id="product-insights-range" aria-label="Date range"><option value="today" selected>Today</option><option value="yesterday">Yesterday</option><option value="3d">Last 3 days</option><option value="7d">Last 7 days</option><option value="14d">Last 14 days</option><option value="30d">Last 30 days</option></select><button type="button" class="btn-close" id="product-insights-close" aria-label="Close"></button></div></div><div class="modal-body"><div id="product-insights-status" class="text-muted">Loading…</div><div id="product-insights-body" style="display:none"><div class="row g-3"><div class="col-12 col-lg-5" id="product-insights-col-left"><div class="card"><div class="card-body"><div class="kexo-product-gallery"><div class="product-insights-main-img-wrap"><img id="product-insights-main-img" class="img-fluid" alt=""></div><div class="product-insights-thumbs-bar" aria-label="Product images"><button type="button" class="btn btn-icon btn-ghost-secondary product-insights-thumb-arrow" id="product-insights-thumbs-left" aria-label="Scroll thumbnails left" style="display:none"><i class="fa-light fa-chevron-left" aria-hidden="true"></i></button><div class="product-insights-thumbs-strip" id="product-insights-thumbs"></div><button type="button" class="btn btn-icon btn-ghost-secondary product-insights-thumb-arrow" id="product-insights-thumbs-right" aria-label="Scroll thumbnails right" style="display:none"><i class="fa-light fa-chevron-right" aria-hidden="true"></i></button></div></div></div></div><div class="card mt-3 kexo-card-collapsed" data-collapse-id="product-insights-revenue"><div class="card-header"><h3 class="card-title">Revenue</h3></div><div class="card-body"><div id="product-insights-chart-revenue" class="dash-chart-wrap" style="min-height:240px"></div></div></div><div class="card mt-3 kexo-card-collapsed" data-collapse-id="product-insights-demand"><div class="card-header"><h3 class="card-title">Demand signals</h3></div><div class="card-body"><div id="product-insights-chart-activity" class="dash-chart-wrap" style="min-height:240px"></div></div></div></div><div class="col-12 col-lg-7" id="product-insights-col-right"><div class="card" data-no-card-collapse="1"><div class="card-header"><h3 class="card-title" id="product-insights-details-title">Product details</h3></div><div>'+("function"==typeof buildKexoNativeTable?buildKexoNativeTable({tableId:"product-insights-metrics-table-wrap",bodyId:"product-insights-metrics-table",tableClass:"table table-vcenter card-table table-sm kexo-product-insights-metrics",columns:window.KEXO_APP_MODAL_TABLE_DEFS&&window.KEXO_APP_MODAL_TABLE_DEFS["product-insights-metrics-table"]&&window.KEXO_APP_MODAL_TABLE_DEFS["product-insights-metrics-table"].columns||[{header:"Metric",headerClass:""},{header:"Value",headerClass:"text-end"}]}):'<div class="table-responsive"><table class="table table-vcenter card-table table-sm kexo-product-insights-metrics"><thead><tr><th>Metric</th><th class="text-end">Value</th></tr></thead><tbody id="product-insights-metrics-table"></tbody></table></div>')+'</div></div><div class="card mt-3" data-no-card-collapse="1" id="product-insights-top-countries-card" style="display:none"><div class="card-header"><h3 class="card-title">Top countries</h3></div><div class="card-body"><div id="product-insights-top-countries" class="d-grid gap-2"></div></div></div></div></div></div></div><div class="modal-footer d-flex align-items-center justify-content-end gap-2 p-4"><a class="btn btn-primary" id="product-insights-open-admin" href="#" target="_blank" rel="noopener" style="display:none">Edit on Shopify</a><a class="btn btn-secondary" id="product-insights-open-store" href="#" target="_blank" rel="noopener">View on Website</a></div></div></div>',document.body.appendChild(wrap),modalEl=wrap;var closeBtn=document.getElementById("product-insights-close");closeBtn&&closeBtn.addEventListener("click",function(){close()}),modalEl.addEventListener("click",function(e){e&&e.target===modalEl&&close()}),document.addEventListener("keydown",function(e){modalEl&&modalEl.classList.contains("show")&&("Escape"===(e&&(e.key||e.code)?String(e.key||e.code):"")&&close())});var sel=document.getElementById("product-insights-range");sel&&sel.addEventListener("change",function(){var v=sel.value||"today";currentRangeKey=v,load()});var thumbsLeft=document.getElementById("product-insights-thumbs-left");thumbsLeft&&thumbsLeft.addEventListener("click",function(e){e.preventDefault(),scrollThumbStrip(-1)});var thumbsRight=document.getElementById("product-insights-thumbs-right");thumbsRight&&thumbsRight.addEventListener("click",function(e){e.preventDefault(),scrollThumbStrip(1)});var thumbsStrip=document.getElementById("product-insights-thumbs");thumbsStrip&&thumbsStrip.addEventListener("scroll",function(){syncThumbStripArrows()},{passive:!0});try{window.addEventListener("resize",function(){syncThumbStripArrows(),syncMainImageBalance()})}catch(_){}
// When collapsed chart cards are expanded, render charts at the right size.
return modalEl.addEventListener("click",function(e){(e&&e.target&&e.target.closest?e.target.closest(".kexo-card-collapse-toggle"):null)&&setTimeout(function(){try{syncMainImageBalance()}catch(_){}try{lastPayload&&renderCharts(lastPayload)}catch(_){}},160)}),modalEl}function show(){ensureDom(),function(){if(!backdropEl||!backdropEl.parentNode){var el=document.createElement("div");el.className="modal-backdrop fade show product-insights-backdrop",document.body.appendChild(el),backdropEl=el}}(),modalEl.style.display="block",modalEl.classList.add("show"),modalEl.setAttribute("aria-hidden","false"),document.body.classList.add("modal-open")}function close(){modalEl&&(modalEl.style.display="none",modalEl.classList.remove("show"),modalEl.setAttribute("aria-hidden","true"),document.body.classList.remove("modal-open"),backdropEl&&backdropEl.parentNode&&backdropEl.parentNode.removeChild(backdropEl),backdropEl=null,destroyCharts(),currentMode="product",currentHandle=null,currentProductId=null,currentTitle=null,currentProductUrl=null,currentPageUrl=null,currentLandingKind=null)}function setStatus(msg){var s=document.getElementById("product-insights-status"),b=document.getElementById("product-insights-body");s&&(s.textContent=msg||""),b&&(b.style.display="none"),s&&(s.style.display=msg?"block":"none")}function fmtNum(n){var x="number"==typeof n?n:Number(n);if(!isFinite(x))return"—";try{return x.toLocaleString("en-GB")}catch(_){return String(Math.round(x))}}function renderCharts(payload){if(payload&&payload.series&&payload.series.points){var points=payload.series.points||[],isHourly=!(!payload.series||!payload.series.isHourly),labels=points.map(function(p){return function(ts,isHourly){try{var d=new Date(Number(ts));return isHourly?d.toLocaleTimeString("en-GB",{hour:"2-digit",minute:"2-digit"}):d.toLocaleDateString("en-GB",{day:"2-digit",month:"short"})}catch(_){return""}}(p.ts,isHourly)}),rev=points.map(function(p){return p&&p.revenueGbp?Number(p.revenueGbp):0}),ord=points.map(function(p){return p&&p.orders?Number(p.orders):0}),clicks=points.map(function(p){return p&&p.clicks?Number(p.clicks):0}),views=points.map(function(p){return p&&p.views?Number(p.views):0}),atc=points.map(function(p){return p&&p.addToCart?Number(p.addToCart):0});!function(cb){if("undefined"==typeof ApexCharts){if(apexWaiters.push(cb),!apexLoading){apexLoading=!0;try{var s=document.createElement("script");s.src="https://cdn.jsdelivr.net/npm/apexcharts@4.7.0/dist/apexcharts.min.js",s.defer=!0,s.onload=function(){apexLoading=!1;var q=apexWaiters.slice();apexWaiters=[],q.forEach(function(fn){try{fn()}catch(_){}})},s.onerror=function(){apexLoading=!1,apexWaiters=[]},document.head.appendChild(s)}catch(_){apexLoading=!1,apexWaiters=[]}}}else cb()}(function(){var revEl=document.getElementById("product-insights-chart-revenue"),actEl=document.getElementById("product-insights-chart-activity");if((revEl||actEl)&&"undefined"!=typeof ApexCharts){var canRev=isVisible(revEl),canAct=isVisible(actEl);canRev||canAct?(destroyCharts(),
// Revenue chart (GBP + Orders)
canRev&&(charts.revenue=new ApexCharts(revEl,{chart:{type:"area",height:240,toolbar:{show:!1},fontFamily:"Inter, sans-serif"},series:[{name:"Revenue",data:rev},{name:"Conversions",data:ord}],colors:["#0d9488","#3b82f6"],stroke:{show:!0,width:2,curve:"smooth",lineCap:"round"},fill:{type:"gradient",gradient:{shadeIntensity:1,opacityFrom:.16,opacityTo:.04,stops:[0,100]}},dataLabels:{enabled:!1},xaxis:{categories:labels,labels:{style:{fontSize:"10px"}}},yaxis:[{labels:{style:{fontSize:"11px"},formatter:function(v){return fmtMoneyGbp(v).replace(".00","")}}},{opposite:!0,labels:{style:{fontSize:"11px"},formatter:function(v){return fmtNum(v)}}}],tooltip:{y:{formatter:function(v,o){return o&&0===o.seriesIndex?fmtMoneyGbp(v):fmtNum(v)}}},grid:{borderColor:"#f1f1f1",strokeDashArray:3},legend:{position:"top",fontSize:"11px"}}),revEl.innerHTML="",charts.revenue.render()),
// Activity chart (Clicks / Views / Add to cart)
canAct&&(charts.activity=new ApexCharts(actEl,{chart:{type:"line",height:240,toolbar:{show:!1},fontFamily:"Inter, sans-serif"},series:[{name:"Clicks",data:clicks},{name:"Views (pixel)",data:views},{name:"Add to cart",data:atc}],colors:["#6366f1","#f59e0b","#ef4444"],stroke:{show:!0,width:2,curve:"smooth",lineCap:"round"},markers:{size:2,hover:{size:5}},dataLabels:{enabled:!1},xaxis:{categories:labels,labels:{style:{fontSize:"10px"}}},yaxis:{labels:{style:{fontSize:"11px"},formatter:function(v){return fmtNum(v)}},min:0},tooltip:{y:{formatter:function(v){return fmtNum(v)}}},grid:{borderColor:"#f1f1f1",strokeDashArray:3},legend:{position:"top",fontSize:"11px"}}),actEl.innerHTML="",charts.activity.render())):
// Charts are inside collapsed cards (hidden). We'll re-render when expanded.
destroyCharts()}function isVisible(el){return!!el&&(!((el.clientWidth||0)<30)&&!!el.offsetParent)}})}}function rangeLabelForKey(rangeKey){var rk=(null==rangeKey?"":String(rangeKey)).trim().toLowerCase();rk||(rk="today");try{if(isCustomRangeKey(rk)){var r=ymdRangeFromRangeKey(rk);if(r&&r.startYmd&&r.endYmd)return formatYmdRangeLabel(r.startYmd,r.endYmd)||"Selected dates"}if(isCustomDayRangeKey(rk)){var ymd=ymdFromDayKey(rk);if(ymd)return formatYmdLabel(ymd)||"Selected day"}}catch(_){}try{return function(rangeKey){const rk=normalizeRangeKeyForApi(rangeKey);return"today"===rk?"Today":"yesterday"===rk?"Yesterday":"3d"===rk?"Last 3 days":"7d"===rk?"Last 7 days":"14d"===rk?"Last 14 days":"30d"===rk?"Last 30 days":"month"===rk?"This month":/^d:\d{4}-\d{2}-\d{2}$/.test(rk)?"Selected day":/^r:\d{4}-\d{2}-\d{2}:\d{4}-\d{2}-\d{2}$/.test(rk)?"Selected range":"Current"}(rk)}catch(_){}return rk}function globalRangeKeyOrToday(){try{var rk=getStatsRange();return(rk=(null==rk?"":String(rk)).trim().toLowerCase())||"today"}catch(_){return"today"}}function syncRangeSelect(key){ensureDom();var sel=document.getElementById("product-insights-range");if(sel){var k=(null==key?"":String(key)).trim().toLowerCase();k||(k="today");try{Array.from(sel.querySelectorAll('option[data-dynamic="1"]')).forEach(function(o){o.remove()})}catch(_){}var found=!1;try{for(var i=0;i<sel.options.length;i++){if((sel.options[i]&&null!=sel.options[i].value?String(sel.options[i].value).trim().toLowerCase():"")===k){found=!0;break}}}catch(_){}if(!found)try{var opt=document.createElement("option");opt.value=k,opt.textContent=rangeLabelForKey(k)||k,opt.setAttribute("data-dynamic","1"),sel.appendChild(opt)}catch(_){}try{sel.value=k}catch(_){}}}function syncThumbStripArrows(){ensureDom();var strip=document.getElementById("product-insights-thumbs"),leftBtn=document.getElementById("product-insights-thumbs-left"),rightBtn=document.getElementById("product-insights-thumbs-right");if(strip&&leftBtn&&rightBtn){var max=Math.max(0,(strip.scrollWidth||0)-(strip.clientWidth||0)),hasOverflow=max>6;leftBtn.style.display=hasOverflow?"inline-flex":"none",rightBtn.style.display=hasOverflow?"inline-flex":"none",leftBtn.disabled=!hasOverflow||(strip.scrollLeft||0)<=1,rightBtn.disabled=!hasOverflow||(strip.scrollLeft||0)>=max-1}}function unionHeightOfCards(cards){var top=null,bottom=null;return(cards||[]).forEach(function(card){if(card&&card.getBoundingClientRect&&(el=card)&&el.offsetParent&&!((el.clientWidth||0)<8||(el.clientHeight||0)<8)){var el,r=card.getBoundingClientRect();(null==top||r.top<top)&&(top=r.top),(null==bottom||r.bottom>bottom)&&(bottom=r.bottom)}}),null==top||null==bottom?0:Math.max(0,bottom-top)}function syncMainImageBalance(){ensureDom();var wrap=modalEl?modalEl.querySelector(".product-insights-main-img-wrap"):null;if(wrap)if(function(){try{return!(!window.matchMedia||!window.matchMedia("(min-width: 992px)").matches)}catch(_){return!1}}()){var colLeft=document.getElementById("product-insights-col-left"),colRight=document.getElementById("product-insights-col-right");if(colLeft&&colRight){
// If charts are expanded, let the gallery be its natural size (square).
var revCard=colLeft.querySelector('[data-collapse-id="product-insights-revenue"]'),demCard=colLeft.querySelector('[data-collapse-id="product-insights-demand"]');if(revCard&&!revCard.classList.contains("kexo-card-collapsed")||demCard&&!demCard.classList.contains("kexo-card-collapsed"))wrap.style.height="";else{var leftCards=Array.from(colLeft.querySelectorAll(":scope > .card")),rightCards=Array.from(colRight.querySelectorAll(":scope > .card"));if(leftCards.length&&rightCards.length){var leftHeight=unionHeightOfCards(leftCards),rightHeight=unionHeightOfCards(rightCards);if(leftHeight&&rightHeight){var wrapRect=wrap.getBoundingClientRect(),wrapH=wrapRect.height||0,wrapW=wrapRect.width||0;if(wrapH&&wrapW){var fixedLeft=leftHeight-wrapH;isFinite(fixedLeft)||(fixedLeft=0);var naturalSquare=wrapW,target=rightHeight-fixedLeft,minH=Math.max(220,Math.round(.6*naturalSquare));// default via aspect-ratio: 1/1
// Target = right content height, but clamp so the image doesn't exceed a square.
isFinite(target)||(target=naturalSquare),target=Math.max(minH,Math.min(naturalSquare,target)),
// If we're basically square, clear the override.
Math.abs(target-naturalSquare)<10?wrap.style.height="":wrap.style.height=String(Math.round(target))+"px"}else wrap.style.height=""}else wrap.style.height=""}else wrap.style.height=""}}else wrap.style.height=""}else wrap.style.height=""}function urlWithWidth(rawUrl,width){var raw=null!=rawUrl?String(rawUrl).trim():"";if(!raw)return"";var w=Math.max(32,Math.floor(Number(width)||1e3));try{var u=new URL(raw,window.location.origin);return u.searchParams.set("width",String(w)),u.searchParams.has("height")&&u.searchParams.delete("height"),u.toString()}catch(_){return/[?&]width=\d+/i.test(raw)?raw.replace(/([?&]width=)(\d+)/i,"$1"+String(w)):raw}}function setMainImg(imgEl,rawUrl,alt){if(imgEl){var u=null!=rawUrl?String(rawUrl).trim():"";if(imgEl.alt=alt||"",!u)return imgEl.removeAttribute("src"),imgEl.removeAttribute("srcset"),imgEl.removeAttribute("sizes"),void(imgEl.style.opacity="0.35");imgEl.src=urlWithWidth(u,900)||u,imgEl.srcset=[360,540,720,900,1100,1400].map(function(w){return(urlWithWidth(u,w)||u)+" "+String(w)+"w"}).join(", "),imgEl.sizes="(min-width: 992px) 480px, 92vw",imgEl.style.opacity="1"}}function scrollThumbStrip(dir){ensureDom();var strip=document.getElementById("product-insights-thumbs");if(strip){var step=Math.max(120,Math.round(.85*(strip.clientWidth||0)));step||(step=160);try{strip.scrollBy({left:dir<0?-step:step,behavior:"smooth"})}catch(_){strip.scrollLeft=(strip.scrollLeft||0)+(dir<0?-step:step)}setTimeout(function(){syncThumbStripArrows()},140)}}function load(){ensureDom(),setStatus("Loading…");var shop=null;try{shop=getShopParam()||shopForSalesFallback||null}catch(_){shop=null}var url="";if("page"===currentMode){if(!currentPageUrl)return void setStatus("No page selected.");url="/api/page-insights?url="+encodeURIComponent(currentPageUrl)+"&kind="+encodeURIComponent(currentLandingKind||"entry")+"&range="+encodeURIComponent(currentRangeKey||"today")+"&_="+Date.now()}else{if(!currentHandle&&!currentProductId)return void setStatus("No product selected.");var q="range="+encodeURIComponent(currentRangeKey||"today")+(shop?"&shop="+encodeURIComponent(shop):"")+"&_="+Date.now();url=currentHandle?"/api/product-insights?handle="+encodeURIComponent(currentHandle)+"&"+q:"/api/product-insights?product_id="+encodeURIComponent(currentProductId)+"&"+q}fetchWithTimeout(url,{credentials:"same-origin",cache:"no-store"},3e4).then(function(r){return r&&r.ok?r.json():null}).then(function(data){data&&data.ok?function(payload){lastPayload=payload||null;var status=document.getElementById("product-insights-status"),body=document.getElementById("product-insights-body");status&&(status.style.display="none"),body&&(body.style.display="block");var titleEl=document.getElementById("product-insights-title"),detailsTitleEl=document.getElementById("product-insights-details-title"),openLink=document.getElementById("product-insights-open-store"),adminLink=document.getElementById("product-insights-open-admin"),mainImg=document.getElementById("product-insights-main-img"),thumbsEl=document.getElementById("product-insights-thumbs"),topCountriesCard=document.getElementById("product-insights-top-countries-card"),topCountriesEl=document.getElementById("product-insights-top-countries"),prod=payload&&payload.product?payload.product:null,metrics=payload&&payload.metrics?payload.metrics:{},details=payload&&payload.details?payload.details:{},isPage=payload&&"page"===payload.kind,page=payload&&payload.page?payload.page:null,title=isPage?page&&page.path?page.path:currentPageUrl||"Page":prod&&prod.title?String(prod.title):currentTitle||currentHandle||"Product";if(titleEl&&(titleEl.textContent=title),detailsTitleEl&&(detailsTitleEl.textContent=isPage?"Page details":"Product details"),syncRangeSelect(payload&&payload.rangeKey?String(payload.rangeKey):currentRangeKey),openLink){var href=isPage?currentPageUrl||"#":currentProductUrl||"#";openLink.href=href,openLink.style.display=href&&"#"!==href?"inline-flex":"none",openLink.textContent=isPage?"View page":"View on Website"}if(adminLink){var adminHref=!isPage&&payload&&payload.links&&payload.links.adminProductUrl?String(payload.links.adminProductUrl):"";adminLink.href=adminHref||"#",adminLink.style.display=adminHref&&"#"!==adminHref?"inline-flex":"none",adminLink.textContent="Edit on Shopify"}
// Images
var images=!isPage&&prod&&Array.isArray(prod.images)?prod.images:[],first=images&&images[0]?images[0]:null;if(mainImg)if(isPage){var u=currentPageUrl||(page&&page.url?String(page.url):""),src=u?"/api/og-thumb?url="+encodeURIComponent(u)+"&width=1000":"";setMainImg(mainImg,src,title)}else setMainImg(mainImg,first&&first.url?String(first.url):"",title);if(thumbsEl){thumbsEl.innerHTML=isPage?"":(images||[]).slice(0,20).map(function(img,i){var u=img&&img.url?String(img.url):"",t=img&&img.thumb?String(img.thumb):u;return u?'<button type="button" class="product-insights-thumb'+(0===i?" active":"")+'" data-img="'+escapeHtml(u)+'" aria-label="Image '+(i+1)+'"><img src="'+escapeHtml(t)+'" alt="" loading="lazy"></button>':""}).join("");try{thumbsEl.scrollLeft=0}catch(_){}syncThumbStripArrows(),thumbsEl.querySelectorAll("[data-img]").forEach(function(a){a.addEventListener("click",function(e){e.preventDefault();var u=a.getAttribute("data-img")||"";u&&mainImg&&(thumbsEl.querySelectorAll(".product-insights-thumb").forEach(function(x){x.classList.remove("active")}),a.classList.add("active"),setMainImg(mainImg,u,title))})})}
// Metrics table
var mt=document.getElementById("product-insights-metrics-table");if(mt){function row(label,value){return"<tr><td>"+escapeHtml(label)+'</td><td class="w-1 fw-bold text-end">'+escapeHtml(value)+"</td></tr>"}if(isPage){var sessions=metrics&&null!=metrics.sessions?fmtNum(metrics.sessions):"—",pageViews=metrics&&null!=metrics.pageViews?fmtNum(metrics.pageViews):"—",purchasedSessions=metrics&&null!=metrics.purchasedSessions?fmtNum(metrics.purchasedSessions):"—",checkoutStartedSessions=metrics&&null!=metrics.checkoutStartedSessions?fmtNum(metrics.checkoutStartedSessions):"—",revenue2=metrics&&null!=metrics.revenueGbp?fmtMoneyGbp(metrics.revenueGbp):"—",cr2=metrics&&null!=metrics.cr?fmtPct(metrics.cr):"—",rps=metrics&&null!=metrics.revPerSession?fmtMoneyGbp(metrics.revPerSession):"—";mt.innerHTML=row("Revenue",revenue2)+row("Purchased sessions",purchasedSessions)+row("Checkout started sessions",checkoutStartedSessions)+row("Sessions",sessions)+row("Page views",pageViews)+row("Purchase rate",cr2)+row("Revenue / Session",rps)}else{var revenue=metrics&&null!=metrics.revenueGbp?fmtMoneyGbp(metrics.revenueGbp):"—",units=metrics&&null!=metrics.units?fmtNum(metrics.units):"—",views=metrics&&null!=metrics.views?fmtNum(metrics.views):"—",atc=metrics&&null!=metrics.addToCart?fmtNum(metrics.addToCart):"—",cs=metrics&&null!=metrics.checkoutStarted?fmtNum(metrics.checkoutStarted):"—",atcRate=metrics&&null!=metrics.atcRate?fmtPct(metrics.atcRate):"—",clicks=metrics&&null!=metrics.clicks?fmtNum(metrics.clicks):"—",conv=metrics&&null!=metrics.orders?fmtNum(metrics.orders):"—",cr=metrics&&null!=metrics.cr?fmtPct(metrics.cr):"—",rpc=metrics&&null!=metrics.revPerClick?fmtMoneyGbp(metrics.revPerClick):"—",rpv=metrics&&null!=metrics.revPerView?fmtMoneyGbp(metrics.revPerView):"—",totalSales=details&&null!=details.totalSalesLifetime?fmtNum(details.totalSalesLifetime):"—",totalRev=details&&null!=details.totalRevenueLifetimeGbp?fmtMoneyGbp(details.totalRevenueLifetimeGbp):"—",cogs=details&&null!=details.costOfGoodsLifetimeGbp?fmtMoneyGbp(details.costOfGoodsLifetimeGbp):"—",stockUnits=details&&null!=details.inventoryUnits?fmtNum(details.inventoryUnits):"—",stockVariants=details&&null!=details.inStockVariants?fmtNum(details.inStockVariants):"—";mt.innerHTML=row("Clicks",clicks)+row("Conversions",conv)+row("Conversion rate",cr)+row("Revenue (selected range)",revenue)+row("Units sold (selected range)",units)+row("Views (pixel)",views)+row("Add to cart",atc)+row("Checkout started",cs)+row("View to Cart rate",atcRate)+row("Revenue / Click",rpc)+row("Revenue / View",rpv)+row("In stock (units)",stockUnits)+row("In-stock variants",stockVariants)+row("Total sales (lifetime)",totalSales)+row("Total revenue (lifetime)",totalRev)+row("Cost of goods (lifetime)",cogs)}}if(topCountriesCard&&topCountriesEl){var top=!isPage&&payload&&Array.isArray(payload.topCountries)?payload.topCountries:[];top&&top.length?(topCountriesCard.style.display="",topCountriesEl.innerHTML=top.slice(0,5).map(function(r){var iso=(r&&null!=r.country_code?String(r.country_code):"XX").toUpperCase().slice(0,2);"UK"===iso&&(iso="GB");var name=countryLabel(iso),flag=flagImg(iso,name),conv=r&&null!=r.orders&&Number(r.orders)||0,rev=r&&null!=r.revenueGbp?Number(r.revenueGbp):null,revText=null!=rev&&isFinite(rev)?fmtMoneyGbp(rev):"—";return'<div class="d-flex align-items-center justify-content-between"><div class="d-flex align-items-center gap-2 min-w-0">'+flag+'<span class="text-truncate">'+escapeHtml(name)+'</span></div><div class="text-end"><div class="fw-semibold" style="font-size:.875rem">'+escapeHtml(fmtNum(conv))+' conversions</div><div class="text-muted small">'+escapeHtml(revText)+"</div></div></div>"}).join("")):(topCountriesCard.style.display="none",topCountriesEl.innerHTML="")}syncMainImageBalance(),renderCharts(payload)}(data):setStatus("page"===currentMode?"No data available for this page.":"No data available for this product.")}).catch(function(){setStatus("page"===currentMode?"Could not load page insights.":"Could not load product insights.")})}function openProduct(handleOrProductId,options){options=options||{};var raw=String(handleOrProductId||"").trim(),pid=options.productId?String(options.productId).trim():"";!pid&&/^\d+$/.test(raw)&&(pid=raw),!pid&&/gid:\/\/shopify\/Product\/(\d+)/i.test(raw)&&(pid=raw.replace(/gid:\/\/shopify\/Product\/(\d+)/i,"$1"));var h=pid?null:normalizeHandle(handleOrProductId);(h||pid)&&(currentHandle=h||null,currentProductId=pid||null,currentMode="product",currentPageUrl=null,currentTitle=options.title?String(options.title):null,currentProductUrl=options.productUrl?String(options.productUrl):null,currentLandingKind=options.landingKind?String(options.landingKind):null,currentRangeKey=globalRangeKeyOrToday(),ensureDom(),syncRangeSelect(currentRangeKey),show(),load())}}(),
/**
 * Layout shortcut modals — open table or chart settings in a modal from card header gear.
 * Saves via POST /api/settings; updates localStorage and dispatches kexo:tablesUiConfigUpdated / kexo:chartsUiConfigUpdated.
 */
function(){"use strict";var MODAL_ID="kexo-layout-shortcut-modal";function escapeHtml(str){if(null==str)return"";try{var div=document.createElement("div");return div.textContent=str,div.innerHTML}catch(_){return String(str).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}}function parseRowOptionsText(raw){var parts=(null==raw?"":String(raw)).split(/[^0-9]+/g),out=[],seen={};return parts.forEach(function(p){if(p){var n=parseInt(p,10);!Number.isFinite(n)||n<=0||n>200||seen[n]||(seen[n]=!0,out.push(n))}}),out.sort(function(a,b){return a-b}),out.slice(0,12)}function defaultSingleTableRow(pageKey,tableId){return{id:tableId,name:tableId,order:1,tableClass:"",zone:"",inGrid:!0,rows:{default:20,options:[20,30,40,50]},sticky:{minWidth:null,maxWidth:null}}}function renderTableModalBody(t){var name=null!=t.name?String(t.name):t.id||"",rowOptions=t.rows&&Array.isArray(t.rows.options)?t.rows.options:[20,30,40,50],defaultRows=t.rows&&"number"==typeof t.rows.default?t.rows.default:rowOptions[0]||20;rowOptions.indexOf(defaultRows)<0&&rowOptions.length&&(defaultRows=rowOptions[0]);var list,stickyMin=t.sticky&&"number"==typeof t.sticky.minWidth?t.sticky.minWidth:null,stickyMax=t.sticky&&"number"==typeof t.sticky.maxWidth?t.sticky.maxWidth:null,inGrid=!1!==t.inGrid,defaultOptsHtml=(rowOptions.length?rowOptions:[defaultRows]).map(function(n){return'<option value="'+String(n)+'"'+(Number(n)===Number(defaultRows)?" selected":"")+">"+String(n)+"</option>"}).join("");return'<div class="row g-3"><div class="col-12"><label class="form-label mb-1">Display name</label><input type="text" class="form-control form-control-sm" data-field="name" value="'+escapeHtml(name)+'"></div><div class="col-12 col-md-6"><label class="form-label mb-1">Rows options</label><input type="text" class="form-control form-control-sm" data-field="rows-options" value="'+escapeHtml((list=rowOptions,(Array.isArray(list)?list:[]).map(function(n){return String(n)}).join(", ")))+'" placeholder="e.g. 5, 10, 15, 20"><div class="text-muted small mt-1">Comma-separated values.</div></div><div class="col-12 col-md-6"><label class="form-label mb-1">Default rows</label><select class="form-select form-select-sm" data-field="rows-default">'+defaultOptsHtml+'</select></div><div class="col-12 col-md-6"><label class="form-label mb-1">Sticky min width (px)</label><input type="number" class="form-control form-control-sm" data-field="sticky-min" placeholder="auto" value="'+(null==stickyMin?"":escapeHtml(String(stickyMin)))+'"></div><div class="col-12 col-md-6"><label class="form-label mb-1">Sticky max width (px)</label><input type="number" class="form-control form-control-sm" data-field="sticky-max" placeholder="auto" value="'+(null==stickyMax?"":escapeHtml(String(stickyMax)))+'"></div><div class="col-12"><label class="form-check form-switch m-0"><input class="form-check-input" type="checkbox" data-field="inGrid"'+(inGrid?" checked":"")+'><span class="form-check-label small ms-2">Keep in grid layout</span></label></div></div>'}function readTableModalBody(container){if(!container||!container.querySelector)return null;var nameEl=container.querySelector('input[data-field="name"]'),optionsEl=container.querySelector('input[data-field="rows-options"]'),defaultEl=container.querySelector('select[data-field="rows-default"]'),stickyMinEl=container.querySelector('input[data-field="sticky-min"]'),stickyMaxEl=container.querySelector('input[data-field="sticky-max"]'),inGridEl=container.querySelector('input[data-field="inGrid"]'),options=parseRowOptionsText(optionsEl?optionsEl.value:"");options.length||(options=[20]);var defaultRows=parseInt(String(defaultEl&&null!=defaultEl.value?defaultEl.value:""),10);function parseSticky(inp){if(!inp)return null;var raw=String(inp.value||"").trim();if(!raw)return null;var n=parseInt(raw,10);return Number.isFinite(n)?n:null}return!Number.isFinite(defaultRows)&&options.length&&(defaultRows=options[0]),{name:nameEl&&null!=nameEl.value?String(nameEl.value).trim():"",rows:{default:Number.isFinite(defaultRows)?defaultRows:options[0],options:options},sticky:{minWidth:parseSticky(stickyMinEl),maxWidth:parseSticky(stickyMaxEl)},inGrid:!(!inGridEl||!inGridEl.checked)}}function updateTableDefaultRowsSelect(container){if(container&&container.querySelector){var optionsInput=container.querySelector('input[data-field="rows-options"]'),defaultSel=container.querySelector('select[data-field="rows-default"]');if(optionsInput&&defaultSel){var options=parseRowOptionsText(optionsInput.value);options.length||(options=[20]);var cur=parseInt(String(defaultSel.value||""),10);(!Number.isFinite(cur)||options.indexOf(cur)<0)&&(cur=options[0]),defaultSel.innerHTML=options.map(function(n){return'<option value="'+String(n)+'"'+(n===cur?" selected":"")+">"+String(n)+"</option>"}).join("")}}}function ensureModal(){var existing=document.getElementById(MODAL_ID);if(existing)return existing;var wrap=document.createElement("div");wrap.innerHTML='<div class="modal modal-blur" id="'+MODAL_ID+'" tabindex="-1" role="dialog" aria-labelledby="'+MODAL_ID+'-title" aria-hidden="true"><div class="modal-dialog modal-lg modal-dialog-scrollable modal-dialog-centered" role="document"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="'+MODAL_ID+'-title">Layout settings</h5><button type="button" class="btn-close" aria-label="Close" data-kexo-layout-modal-close></button></div><div class="modal-body" id="'+MODAL_ID+'-body"></div><div class="modal-footer"><span id="'+MODAL_ID+'-msg" class="form-hint me-auto"></span><button type="button" class="btn btn-secondary" data-kexo-layout-modal-close>Cancel</button><button type="button" class="btn btn-primary" id="'+MODAL_ID+'-save-btn">Save</button></div></div></div></div>';var el=wrap.firstChild;document.body.appendChild(el);try{initModalClose()}catch(_){}return el}function setMsg(text,ok){var msg=document.getElementById(MODAL_ID+"-msg");msg&&(msg.textContent=text||"",msg.className="form-hint me-auto "+(!0===ok?"text-success":!1===ok?"text-danger":""))}function closeModal(){var modal=document.getElementById(MODAL_ID);if(modal){try{if(window.bootstrap&&window.bootstrap.Modal){var inst=window.bootstrap.Modal.getInstance(modal);inst&&inst.hide()}}catch(_){}modal.classList.remove("show"),modal.style.display="",document.body.classList.remove("modal-open");try{document.querySelectorAll('.modal-backdrop[data-kexo-layout-backdrop="1"]').forEach(function(b){b&&b.parentNode&&b.parentNode.removeChild(b)})}catch(_){}}}function showModal(){var modal=ensureModal();modal.style.display="block",modal.classList.add("show"),document.body.classList.add("modal-open");var backdrop=document.createElement("div");backdrop.className="modal-backdrop fade show",backdrop.setAttribute("data-kexo-layout-backdrop","1"),document.body.appendChild(backdrop),backdrop.addEventListener("click",function(){closeModal()});try{if(window.bootstrap&&window.bootstrap.Modal)window.bootstrap.Modal.getOrCreateInstance(modal,{backdrop:!0,keyboard:!0}).show()}catch(_){}}function saveTablesUiConfig(cfg){return fetch("/api/settings",{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/json"},body:JSON.stringify({tablesUiConfig:cfg})}).then(function(r){return r.json()}).then(function(data){if(data&&data.ok&&data.tablesUiConfig){try{safeWriteLocalStorageJson("kexo:tables-ui-config:v1",data.tablesUiConfig)}catch(_){}try{window.dispatchEvent(new CustomEvent("kexo:tablesUiConfigUpdated",{detail:data.tablesUiConfig}))}catch(_){}}return data})}function findPageAndTableIndex(cfg,pageKey,tableId){if(!cfg||1!==cfg.v||!Array.isArray(cfg.pages))return{pageIndex:-1,tableIndex:-1};for(var pk=String(pageKey||"").trim().toLowerCase(),tid=String(tableId||"").trim().toLowerCase(),pi=0;pi<cfg.pages.length;pi++){var p=cfg.pages[pi];if(p&&String(p.key||"").trim().toLowerCase()===pk){for(var tables=Array.isArray(p.tables)?p.tables:[],ti=0;ti<tables.length;ti++)if(tables[ti]&&String(tables[ti].id||"").trim().toLowerCase()===tid)return{pageIndex:pi,tableIndex:ti};return{pageIndex:pi,tableIndex:-1}}}return{pageIndex:-1,tableIndex:-1}}function initModalClose(){var modal=document.getElementById(MODAL_ID);function close(e){try{e&&"function"==typeof e.preventDefault&&e.preventDefault()}catch(_){}closeModal()}modal&&"1"!==modal.getAttribute("data-kexo-layout-close-wired")&&(modal.setAttribute("data-kexo-layout-close-wired","1"),modal.querySelectorAll("[data-kexo-layout-modal-close]").forEach(function(btn){btn.addEventListener("click",close)}),modal.addEventListener("click",function(e){e&&e.target===modal&&close(e)}),"1"!==document.documentElement.getAttribute("data-kexo-layout-esc-wired")&&(document.documentElement.setAttribute("data-kexo-layout-esc-wired","1"),document.addEventListener("keydown",function(e){if("Escape"===e.key){var m=document.getElementById(MODAL_ID);m&&m.classList&&m.classList.contains("show")&&close(e)}})))}try{window.KexoLayoutShortcuts={openTableModal:function(opts){var pageKey=opts&&null!=opts.pageKey?String(opts.pageKey).trim().toLowerCase():"",tableId=opts&&null!=opts.tableId?String(opts.tableId).trim():"",cardTitle=opts&&null!=opts.cardTitle?String(opts.cardTitle).trim():tableId;if(pageKey&&tableId){ensureModal();var titleEl=document.getElementById(MODAL_ID+"-title"),bodyEl=document.getElementById(MODAL_ID+"-body"),saveBtn=document.getElementById(MODAL_ID+"-save-btn");titleEl&&(titleEl.textContent="Table: "+cardTitle),bodyEl&&(setMsg("Loading…",null),fetch("/api/settings",{credentials:"same-origin",cache:"no-store"}).then(function(r){return r.json()}).then(function(data){var cfg=data&&data.ok&&data.tablesUiConfig?data.tablesUiConfig:null;cfg&&1===cfg.v&&Array.isArray(cfg.pages)||(cfg=safeReadLocalStorageJson("kexo:tables-ui-config:v1")||{v:1,pages:[]});var t,found=findPageAndTableIndex(cfg,pageKey,tableId);t=found.pageIndex>=0&&found.tableIndex>=0?{id:(t=cfg.pages[found.pageIndex].tables[found.tableIndex]).id,name:t.name,order:t.order,tableClass:t.tableClass,zone:t.zone,inGrid:t.inGrid,rows:t.rows,sticky:t.sticky}:defaultSingleTableRow(0,tableId),bodyEl.innerHTML=renderTableModalBody(t),bodyEl.setAttribute("data-kexo-layout-mode","table"),bodyEl.setAttribute("data-kexo-layout-page-key",pageKey),bodyEl.setAttribute("data-kexo-layout-table-id",tableId),bodyEl.removeAttribute("data-kexo-layout-chart-key"),setMsg("",null),bodyEl.addEventListener("input",function(e){e.target&&"rows-options"===e.target.getAttribute("data-field")&&updateTableDefaultRowsSelect(bodyEl)}),bodyEl.addEventListener("change",function(e){e.target&&"rows-options"===e.target.getAttribute("data-field")&&updateTableDefaultRowsSelect(bodyEl)}),saveBtn.replaceWith(saveBtn.cloneNode(!0)),document.getElementById(MODAL_ID+"-save-btn").addEventListener("click",function(){var patch=readTableModalBody(bodyEl);if(patch){setMsg("Saving…",null);var nextCfg=JSON.parse(JSON.stringify(cfg)),f=findPageAndTableIndex(nextCfg,pageKey,tableId),row={id:tableId,name:patch.name||tableId,order:1,tableClass:t.tableClass||"",zone:t.zone||"",inGrid:patch.inGrid,rows:patch.rows,sticky:patch.sticky};f.pageIndex>=0?f.tableIndex>=0?(row.order=nextCfg.pages[f.pageIndex].tables[f.tableIndex].order,nextCfg.pages[f.pageIndex].tables[f.tableIndex]=row):(row.order=nextCfg.pages[f.pageIndex].tables.length+1,nextCfg.pages[f.pageIndex].tables.push(row)):nextCfg.pages.push({key:pageKey,label:pageKey,tables:[row]}),saveTablesUiConfig(nextCfg).then(function(data){if(data&&data.ok){try{var nextRows=patch&&patch.rows&&"number"==typeof patch.rows.default?patch.rows.default:null;null!=nextRows&&("function"==typeof window.setTableRowsPerPage&&window.setTableRowsPerPage(tableId,nextRows,"live"),"function"==typeof window.applyTableRowsPerPageChange&&window.applyTableRowsPerPageChange(tableId,nextRows))}catch(_){}setMsg("Saved.",!0),closeModal()}else setMsg(data&&data.error?String(data.error):"Save failed",!1)}).catch(function(){setMsg("Save failed",!1)})}}),showModal()}).catch(function(){setMsg("Could not load settings.",!1);var t=defaultSingleTableRow(0,tableId);bodyEl.innerHTML=renderTableModalBody(t),bodyEl.setAttribute("data-kexo-layout-mode","table"),bodyEl.setAttribute("data-kexo-layout-page-key",pageKey),bodyEl.setAttribute("data-kexo-layout-table-id",tableId),bodyEl.removeAttribute("data-kexo-layout-chart-key");var nextCfg={v:1,pages:[]};saveBtn.replaceWith(saveBtn.cloneNode(!0)),document.getElementById(MODAL_ID+"-save-btn").addEventListener("click",function(){var patch=readTableModalBody(bodyEl);if(patch){setMsg("Saving…",null);var row={id:tableId,name:patch.name||tableId,order:1,tableClass:t.tableClass||"",zone:t.zone||"",inGrid:patch.inGrid,rows:patch.rows,sticky:patch.sticky};nextCfg.pages.push({key:pageKey,label:pageKey,tables:[row]}),saveTablesUiConfig(nextCfg).then(function(data){if(data&&data.ok){try{var nextRows=patch&&patch.rows&&"number"==typeof patch.rows.default?patch.rows.default:null;null!=nextRows&&("function"==typeof window.setTableRowsPerPage&&window.setTableRowsPerPage(tableId,nextRows,"live"),"function"==typeof window.applyTableRowsPerPageChange&&window.applyTableRowsPerPageChange(tableId,nextRows))}catch(_){}setMsg("Saved.",!0),closeModal()}else setMsg(data&&data.error?String(data.error):"Save failed",!1)}).catch(function(){setMsg("Save failed",!1)})}}),showModal()}))}},openChartModal:function(opts){window.KexoChartSettingsBuilder&&"function"==typeof window.KexoChartSettingsBuilder.openModal&&window.KexoChartSettingsBuilder.openModal(opts)},saveTablesUiConfig:saveTablesUiConfig,saveChartsUiConfig:function(cfg){return fetch("/api/settings",{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/json"},body:JSON.stringify({chartsUiConfig:cfg})}).then(function(r){return r.json()}).then(function(data){if(data&&data.ok&&data.chartsUiConfig){try{safeWriteLocalStorageJson("kexo:charts-ui-config:v1",data.chartsUiConfig)}catch(_){}try{window.dispatchEvent(new CustomEvent("kexo:chartsUiConfigUpdated",{detail:data.chartsUiConfig}))}catch(_){}}return data})},renderTableModalBody:renderTableModalBody,readTableModalBody:readTableModalBody}}catch(_){}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",initModalClose):initModalClose()}(),
/**
 * Dashboard: Profit Rules modal opener (Cost Settings shortcut).
 * Reuses the same modal markup/IDs as Snapshot, but runs only on dashboard pages.
 */
function(){"use strict";if("dashboard"===function(){try{return String(document.body&&document.body.getAttribute("data-page")||"")}catch(_){return""}}()){var state={open:!1,backdrop:null,rulesDraft:null,editingRuleId:""};"loading"===document.readyState?document.addEventListener("DOMContentLoaded",bind):bind()}function esc(str){try{var div=document.createElement("div");return div.textContent=null==str?"":String(str),div.innerHTML}catch(_){return String(null==str?"":str).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}}function fetchJson(url,opts){return fetch(url,opts||{}).then(function(r){return r&&r.ok?r.json():null}).catch(function(){return null})}function closeModal(){var modal=document.getElementById("profit-rules-modal");modal&&(modal.classList.remove("show"),modal.style.display="none",modal.setAttribute("aria-hidden","true"),state.backdrop&&state.backdrop.parentNode&&state.backdrop.parentNode.removeChild(state.backdrop),state.backdrop=null,state.open=!1,document.body.classList.remove("modal-open"))}function createRuleId(){return"rule_"+Date.now().toString(36)+"_"+Math.random().toString(36).slice(2,7)}function normalizeCountryCode(value){var raw=String(value||"").trim().toUpperCase().slice(0,2);if(!raw)return"";var cc="UK"===raw?"GB":raw;return/^[A-Z]{2}$/.test(cc)?cc:""}function normalizeRulesPayload(payload){for(var src=payload&&"object"==typeof payload?payload:{},list=Array.isArray(src.rules)?src.rules:[],out={enabled:!!src.enabled,currency:"GBP",integrations:{includeGoogleAdsSpend:!(!src.integrations||!0!==src.integrations.includeGoogleAdsSpend),includeShopifyAppBills:!1,includePaymentFees:!(!src.integrations||!0!==src.integrations.includePaymentFees),includeKlarnaFees:!(!src.integrations||!0!==src.integrations.includeKlarnaFees),includeShopifyTaxes:!(!src.integrations||!0!==src.integrations.includeShopifyTaxes)},rules:[]},i=0;i<list.length;i+=1){var row=list[i]&&"object"==typeof list[i]?list[i]:{},appliesMode=row.appliesTo&&"countries"===row.appliesTo.mode?"countries":"all",countries="countries"===appliesMode&&Array.isArray(row.appliesTo&&row.appliesTo.countries)?row.appliesTo.countries.map(normalizeCountryCode).filter(Boolean):[];out.rules.push({id:row.id?String(row.id):createRuleId(),name:row.name?String(row.name):"Expense",type:row.type?String(row.type):"percent_revenue",value:Number.isFinite(Number(row.value))?Number(row.value):0,enabled:!1!==row.enabled,sort:Number.isFinite(Number(row.sort))?Math.trunc(Number(row.sort)):i+1,appliesTo:"countries"===appliesMode&&countries.length?{mode:"countries",countries:countries.slice(0,64)}:{mode:"all",countries:[]}})}return out.rules.sort(function(a,b){return(Number(a.sort)||0)-(Number(b.sort)||0)}),out}function setMessage(text,isOk){var el=document.getElementById("profit-rules-msg");el&&(el.textContent=text||"",el.classList.toggle("is-hidden",!text),el.classList.toggle("text-success",!!isOk),el.classList.toggle("text-danger",!1===isOk))}function sortDraft(){state.rulesDraft&&Array.isArray(state.rulesDraft.rules)&&state.rulesDraft.rules.sort(function(a,b){var sa=Number(a&&null!=a.sort?a.sort:0)||0,sb=Number(b&&null!=b.sort?b.sort:0)||0;return sa!==sb?sa-sb:String(a&&a.id||"").localeCompare(String(b&&b.id||""))})}function reindexDraft(){state.rulesDraft&&Array.isArray(state.rulesDraft.rules)&&(sortDraft(),state.rulesDraft.rules.forEach(function(rule,idx){rule&&(rule.sort=idx+1)}))}function getRuleById(ruleId){return state.rulesDraft&&Array.isArray(state.rulesDraft.rules)&&state.rulesDraft.rules.find(function(rule){return String(rule&&rule.id||"")===String(ruleId||"")})||null}function renderRulesList(){var bodyEl=document.getElementById("profit-rules-table-body");if(bodyEl)if(state.rulesDraft&&Array.isArray(state.rulesDraft.rules)&&state.rulesDraft.rules.length){sortDraft();var html="";state.rulesDraft.rules.forEach(function(rule,idx){var type,countryLabel=rule&&rule.appliesTo&&"countries"===rule.appliesTo.mode?(rule.appliesTo.countries||[]).join(", ")||"-":"ALL";html+='<tr data-rule-id="'+esc(rule.id||"")+'"><td>'+esc(rule.name||"Expense")+"</td><td>"+esc("fixed_per_order"===(type=rule.type)?"Fixed per order":"fixed_per_period"===type?"Fixed per period":"Percent of revenue")+'</td><td class="text-end">'+esc(function(rule){if(!rule)return"-";var value=Number(rule.value);return Number.isFinite(value)?"percent_revenue"===rule.type?value.toFixed(2).replace(/\.00$/,"")+"%":"£"+value.toFixed(2):"-"}(rule))+'</td><td class="text-center">'+esc(countryLabel)+'</td><td class="text-center"><input type="checkbox" data-pr-action="toggle-enabled" data-rule-id="'+esc(rule.id||"")+'"'+(rule.enabled?" checked":"")+' /></td><td class="text-end text-nowrap"><button type="button" class="btn btn-sm btn-ghost-secondary" data-pr-action="move-up" data-rule-id="'+esc(rule.id||"")+'"'+(idx<=0?" disabled":"")+'>Up</button> <button type="button" class="btn btn-sm btn-ghost-secondary" data-pr-action="move-down" data-rule-id="'+esc(rule.id||"")+'"'+(idx>=state.rulesDraft.rules.length-1?" disabled":"")+'>Down</button> <button type="button" class="btn btn-sm btn-ghost-secondary" data-pr-action="edit" data-rule-id="'+esc(rule.id||"")+'">Edit</button> <button type="button" class="btn btn-sm btn-ghost-danger" data-pr-action="delete" data-rule-id="'+esc(rule.id||"")+'">Delete</button></td></tr>'}),bodyEl.innerHTML=html}else bodyEl.innerHTML='<tr><td colspan="6" class="text-muted">No rules yet.</td></tr>'}function hideForm(){var panel=document.getElementById("profit-rules-form-wrap");panel&&panel.classList.add("is-hidden"),state.editingRuleId="";var idEl=document.getElementById("profit-rule-id");idEl&&(idEl.value="")}function showForm(rule){var panel=document.getElementById("profit-rules-form-wrap");panel&&panel.classList.remove("is-hidden"),state.editingRuleId=rule?String(rule.id||""):"";var idEl=document.getElementById("profit-rule-id"),nameEl=document.getElementById("profit-rule-name"),typeEl=document.getElementById("profit-rule-type"),valueEl=document.getElementById("profit-rule-value"),countryEl=document.getElementById("profit-rule-country"),sortEl=document.getElementById("profit-rule-sort"),enabledEl=document.getElementById("profit-rule-enabled");idEl&&(idEl.value=state.editingRuleId),nameEl&&(nameEl.value=rule&&rule.name||""),typeEl&&(typeEl.value=rule&&rule.type||"percent_revenue"),valueEl&&(valueEl.value=rule&&null!=rule.value?String(Number(rule.value)||0):""),countryEl&&(countryEl.value=rule&&rule.appliesTo&&"countries"===rule.appliesTo.mode?(rule.appliesTo.countries||[]).join(","):""),sortEl&&(sortEl.value=rule&&Number.isFinite(Number(rule.sort))?String(Math.trunc(Number(rule.sort))):String(state.rulesDraft&&state.rulesDraft.rules?state.rulesDraft.rules.length+1:1)),enabledEl&&(enabledEl.checked=!rule||!1!==rule.enabled)}function saveRuleDraft(){var parsed=function(){var nameEl=document.getElementById("profit-rule-name"),typeEl=document.getElementById("profit-rule-type"),valueEl=document.getElementById("profit-rule-value"),countryEl=document.getElementById("profit-rule-country"),sortEl=document.getElementById("profit-rule-sort"),enabledEl=document.getElementById("profit-rule-enabled"),name=String(nameEl&&nameEl.value||"").trim();if(!name)return{ok:!1,error:"Rule name is required."};var type=String(typeEl&&typeEl.value||"").trim();if(["percent_revenue","fixed_per_order","fixed_per_period"].indexOf(type)<0)return{ok:!1,error:"Rule type is invalid."};var value=Number(valueEl&&valueEl.value);if(!Number.isFinite(value)||value<0)return{ok:!1,error:"Value must be 0 or higher."};var sort=Math.max(1,Math.trunc(Number(sortEl&&sortEl.value)||1)),countryRaw=String(countryEl&&countryEl.value||"").trim(),appliesTo={mode:"all",countries:[]};if(countryRaw){var countries=countryRaw.split(/[,\s]+/).map(normalizeCountryCode).filter(Boolean);if(!countries.length)return{ok:!1,error:"Use valid 2-letter ISO country codes."};var unique=[],seen={};countries.forEach(function(cc){cc&&!seen[cc]&&(seen[cc]=!0,unique.push(cc))}),appliesTo={mode:"countries",countries:unique.slice(0,64)}}return{ok:!0,rule:{id:state.editingRuleId||createRuleId(),name:name.slice(0,80),type:type,value:value,enabled:!enabledEl||!!enabledEl.checked,sort:sort,appliesTo:appliesTo}}}();if(parsed.ok){state.rulesDraft&&Array.isArray(state.rulesDraft.rules)||(state.rulesDraft=normalizeRulesPayload(null));var existing=getRuleById(parsed.rule.id);existing?(existing.name=parsed.rule.name,existing.type=parsed.rule.type,existing.value=parsed.rule.value,existing.enabled=parsed.rule.enabled,existing.sort=parsed.rule.sort,existing.appliesTo=parsed.rule.appliesTo):state.rulesDraft.rules.push(parsed.rule),reindexDraft(),renderRulesList(),hideForm(),setMessage("Rule saved in draft.",!0)}else setMessage(parsed.error,!1)}function applyDraftToUi(){var enabledToggle=document.getElementById("profit-rules-enabled"),adsToggle=document.getElementById("profit-rules-include-google-ads"),paymentFeesToggle=document.getElementById("profit-rules-include-payment-fees"),klarnaFeesToggle=document.getElementById("profit-rules-include-klarna-fees"),taxToggle=document.getElementById("profit-rules-include-tax");enabledToggle&&(enabledToggle.checked=!(!state.rulesDraft||!state.rulesDraft.enabled)),adsToggle&&(adsToggle.checked=!!(state.rulesDraft&&state.rulesDraft.integrations&&state.rulesDraft.integrations.includeGoogleAdsSpend)),paymentFeesToggle&&(paymentFeesToggle.checked=!!(state.rulesDraft&&state.rulesDraft.integrations&&state.rulesDraft.integrations.includePaymentFees)),klarnaFeesToggle&&(klarnaFeesToggle.checked=!!(state.rulesDraft&&state.rulesDraft.integrations&&state.rulesDraft.integrations.includeKlarnaFees)),taxToggle&&(taxToggle.checked=!!(state.rulesDraft&&state.rulesDraft.integrations&&state.rulesDraft.integrations.includeShopifyTaxes))}function saveRules(){!function(){state.rulesDraft||(state.rulesDraft=normalizeRulesPayload(null));var enabledToggle=document.getElementById("profit-rules-enabled"),adsToggle=document.getElementById("profit-rules-include-google-ads"),paymentFeesToggle=document.getElementById("profit-rules-include-payment-fees"),klarnaFeesToggle=document.getElementById("profit-rules-include-klarna-fees"),taxToggle=document.getElementById("profit-rules-include-tax");state.rulesDraft.enabled=enabledToggle?!!enabledToggle.checked:!!state.rulesDraft.enabled,state.rulesDraft.integrations&&"object"==typeof state.rulesDraft.integrations||(state.rulesDraft.integrations={includeGoogleAdsSpend:!1,includeShopifyAppBills:!1,includePaymentFees:!1,includeKlarnaFees:!1,includeShopifyTaxes:!1}),state.rulesDraft.integrations.includeGoogleAdsSpend=adsToggle?!!adsToggle.checked:!!state.rulesDraft.integrations.includeGoogleAdsSpend,state.rulesDraft.integrations.includeShopifyAppBills=!1,state.rulesDraft.integrations.includePaymentFees=paymentFeesToggle?!!paymentFeesToggle.checked:!!state.rulesDraft.integrations.includePaymentFees,state.rulesDraft.integrations.includeKlarnaFees=klarnaFeesToggle?!!klarnaFeesToggle.checked:!!state.rulesDraft.integrations.includeKlarnaFees,state.rulesDraft.integrations.includeShopifyTaxes=taxToggle?!!taxToggle.checked:!!state.rulesDraft.integrations.includeShopifyTaxes}(),reindexDraft(),setMessage("Saving...",!0);return fetchJson("/api/settings/profit-rules",{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({profitRules:state.rulesDraft}),credentials:"same-origin"}).then(function(payload){state.rulesDraft=normalizeRulesPayload(payload&&payload.profitRules?payload.profitRules:state.rulesDraft),applyDraftToUi(),renderRulesList(),hideForm(),setMessage("Profit rules saved.",!0);try{window.dispatchEvent(new CustomEvent("kexo:profitRulesUpdated"))}catch(_){}return payload}).catch(function(){return setMessage("Failed to save profit rules.",!1),null})}function bind(){if(document.getElementById("profit-rules-modal")){var openBtn=document.getElementById("dash-cost-settings-btn");openBtn&&"1"!==openBtn.getAttribute("data-kexo-profit-bound")&&(openBtn.setAttribute("data-kexo-profit-bound","1"),openBtn.addEventListener("click",function(e){e.preventDefault();try{var url="/settings/cost-expenses/rules";"undefined"!=typeof window&&window.location&&"function"==typeof window.location.assign?window.location.assign(url):window.location.href=url}catch(_){}}));var chartBtn=document.querySelector('[data-kexo-chart-settings-key="dash-chart-overview-30d"]');chartBtn&&"1"!==chartBtn.getAttribute("data-kexo-chart-settings-bound")&&(chartBtn.setAttribute("data-kexo-chart-settings-bound","1"),chartBtn.addEventListener("click",function(e){e.preventDefault(),e.stopPropagation();try{window.KexoLayoutShortcuts&&"function"==typeof window.KexoLayoutShortcuts.openChartModal&&window.KexoLayoutShortcuts.openChartModal({chartKey:"dash-chart-overview-30d",cardTitle:"Overview"})}catch(_){}}));var closeBtn=document.getElementById("profit-rules-close-btn"),dismissBtn=document.getElementById("profit-rules-dismiss-btn"),saveBtn=document.getElementById("profit-rules-save-btn"),addBtn=document.getElementById("profit-rules-add-btn"),formSaveBtn=document.getElementById("profit-rule-save-btn"),formCancelBtn=document.getElementById("profit-rule-cancel-btn"),tableBody=document.getElementById("profit-rules-table-body");closeBtn&&closeBtn.addEventListener("click",closeModal),dismissBtn&&dismissBtn.addEventListener("click",closeModal),saveBtn&&saveBtn.addEventListener("click",saveRules),addBtn&&addBtn.addEventListener("click",function(){showForm(null)}),formSaveBtn&&formSaveBtn.addEventListener("click",saveRuleDraft),formCancelBtn&&formCancelBtn.addEventListener("click",hideForm),document.querySelectorAll("[data-pr-tab]").forEach(function(btn){btn.addEventListener("click",function(){!function(tab){var key="integrations"===tab?"integrations":"rules";document.querySelectorAll("[data-pr-tab]").forEach(function(btn){if(btn&&btn.classList){var v=String(btn.getAttribute("data-pr-tab")||"");btn.classList.toggle("active",v===key)}});var rulesPane=document.getElementById("profit-rules-tab-rules"),integrationsPane=document.getElementById("profit-rules-tab-integrations");rulesPane&&rulesPane.classList.toggle("is-hidden","rules"!==key),integrationsPane&&integrationsPane.classList.toggle("is-hidden","integrations"!==key)}(String(btn.getAttribute("data-pr-tab")||""))})}),tableBody&&(tableBody.addEventListener("click",function(event){var target=event&&event.target?event.target:null;if(target&&target.getAttribute){var action=String(target.getAttribute("data-pr-action")||""),ruleId=String(target.getAttribute("data-rule-id")||"");if(action&&ruleId&&state.rulesDraft&&Array.isArray(state.rulesDraft.rules))if("edit"!==action){if("delete"===action)return state.rulesDraft.rules=state.rulesDraft.rules.filter(function(rule){return String(rule&&rule.id||"")!==ruleId}),reindexDraft(),renderRulesList(),void hideForm();if("move-up"===action||"move-down"===action){sortDraft();var idx=state.rulesDraft.rules.findIndex(function(rule){return String(rule&&rule.id||"")===ruleId});if(idx<0)return;var swapWith="move-up"===action?idx-1:idx+1;if(swapWith<0||swapWith>=state.rulesDraft.rules.length)return;var tmp=state.rulesDraft.rules[idx];state.rulesDraft.rules[idx]=state.rulesDraft.rules[swapWith],state.rulesDraft.rules[swapWith]=tmp,reindexDraft(),renderRulesList()}}else showForm(getRuleById(ruleId))}}),tableBody.addEventListener("change",function(event){var target=event&&event.target?event.target:null;if(target&&target.getAttribute&&"toggle-enabled"===String(target.getAttribute("data-pr-action")||"")){var rule=getRuleById(String(target.getAttribute("data-rule-id")||""));rule&&(rule.enabled=!!target.checked)}})),document.addEventListener("keydown",function(event){state.open&&("Escape"===String(event&&(event.key||event.code)||"")&&closeModal())})}}}(),
/**
 * Unified chart settings modal — opened from chart cog. Persists via PUT /api/chart-settings/:chartKey.
 * Single-init: one document listener for cog clicks; no duplicate bindings.
 */
function(){"use strict";var MODAL_ID="kexo-chart-settings-modal",API="undefined"!=typeof window&&window.API?String(window.API||""):"",lastOpen={key:"",at:0},inFlight={controller:null,chartKey:""},fallbackBackdrop=null;function escapeHtml(str){if(null==str)return"";try{var div=document.createElement("div");return div.textContent=str,div.innerHTML}catch(_){return String(str).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}}function ensureModal(){var existing=document.getElementById(MODAL_ID);if(existing)return existing;var wrap=document.createElement("div");wrap.innerHTML='<div class="modal modal-blur" id="'+MODAL_ID+'" tabindex="-1" role="dialog" aria-labelledby="'+MODAL_ID+'-title" aria-hidden="true"><div class="modal-dialog modal-dialog-centered modal-dialog-scrollable" role="document"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="'+MODAL_ID+'-title">Chart settings</h5><button type="button" class="btn-close" data-kexo-chart-settings-close aria-label="Close"></button></div><div class="modal-body" id="'+MODAL_ID+'-body"></div><div class="modal-footer"><span id="'+MODAL_ID+'-msg" class="form-hint me-auto"></span><button type="button" class="btn btn-secondary" data-kexo-chart-settings-close>Cancel</button><button type="button" class="btn btn-primary" id="'+MODAL_ID+'-save">Save</button></div></div></div></div>';var el=wrap.firstChild;document.body.appendChild(el),el.querySelectorAll("[data-kexo-chart-settings-close]").forEach(function(btn){btn.addEventListener("click",function(){closeModal()})});
// Ensure we always cleanup in-flight requests when the modal closes.
try{"1"!==el.getAttribute("data-kexo-chart-settings-lifecycle")&&(el.setAttribute("data-kexo-chart-settings-lifecycle","1"),el.addEventListener("hidden.bs.modal",function(){abortInFlight()}))}catch(_){}return el}function setMsg(text,ok){var msg=document.getElementById(MODAL_ID+"-msg");msg&&(msg.textContent=text||"",msg.className="form-hint me-auto "+(!0===ok?"text-success":!1===ok?"text-danger":""))}function closeModal(){var modal=document.getElementById(MODAL_ID);if(modal){abortInFlight();var usedBootstrap=!1;try{if(window.bootstrap&&window.bootstrap.Modal){var inst=window.bootstrap.Modal.getInstance(modal);inst&&(inst.hide(),usedBootstrap=!0)}}catch(_){}if(!usedBootstrap){try{modal.style.display="none"}catch(_){}try{modal.classList.remove("show")}catch(_){}try{modal.setAttribute("aria-hidden","true")}catch(_){}try{document&&document.body&&document.body.classList.remove("modal-open")}catch(_){}try{fallbackBackdrop&&fallbackBackdrop.parentNode&&fallbackBackdrop.parentNode.removeChild(fallbackBackdrop)}catch(_){}fallbackBackdrop=null}}}function abortInFlight(){try{inFlight&&inFlight.controller&&"function"==typeof inFlight.controller.abort&&inFlight.controller.abort()}catch(_){}try{inFlight.controller=null}catch(_){}try{inFlight.chartKey=""}catch(_){}}function openModal(opts){var chartKey=opts&&null!=opts.chartKey?String(opts.chartKey).trim().toLowerCase():"",cardTitle=opts&&null!=opts.cardTitle?String(opts.cardTitle).trim():chartKey;if(chartKey){var now=Date.now();if(!(lastOpen.key===chartKey&&now-lastOpen.at<250)){lastOpen.key=chartKey,lastOpen.at=now;ensureModal();var titleEl=document.getElementById(MODAL_ID+"-title"),bodyEl=document.getElementById(MODAL_ID+"-body"),saveBtn=document.getElementById(MODAL_ID+"-save");if(titleEl&&(titleEl.textContent="Chart: "+cardTitle),bodyEl){setMsg("Loading…",null),bodyEl.innerHTML='<div class="text-muted">Loading…</div>',function(){var modal=ensureModal();modal.classList.add("show"),modal.setAttribute("aria-hidden","false");try{if(window.bootstrap&&window.bootstrap.Modal)return void window.bootstrap.Modal.getOrCreateInstance(modal,{backdrop:!0,keyboard:!0}).show()}catch(_){}
// Fallback: display the modal without Bootstrap JS.
try{modal.style.display="block"}catch(_){}try{document&&document.body&&document.body.classList.add("modal-open")}catch(_){}try{fallbackBackdrop||((fallbackBackdrop=document.createElement("div")).className="modal-backdrop fade show",fallbackBackdrop.addEventListener("click",function(){closeModal()}),document.body.appendChild(fallbackBackdrop))}catch(_){}}(),abortInFlight();try{inFlight.chartKey=chartKey,inFlight.controller="undefined"!=typeof AbortController?new AbortController:null}catch(_){inFlight.controller=null}fetch(API+"/api/chart-settings/"+encodeURIComponent(chartKey),{credentials:"same-origin",cache:"no-store",signal:inFlight.controller?inFlight.controller.signal:void 0}).then(function(r){return r?r.json().catch(function(){return{ok:!1,error:"Request failed ("+String(r.status||"")+")"}}):null;
// Always try to surface a useful error in the modal instead of failing silently.
}).then(function(data){if(!data||!data.ok)return setMsg("Failed to load settings",!1),void(bodyEl.innerHTML='<div class="text-muted">Could not load settings.</div>');var key,s=data.settings||{},meta=(key=chartKey,("function"==typeof window.kexoChartMeta?window.kexoChartMeta(key):null)||{modes:["line","area"],series:[],defaultMode:"line",height:200}),modes=meta.modes||["line","area"],mode=String(s.mode||meta.defaultMode||"line").trim().toLowerCase();modes.indexOf(mode)<0&&(mode=modes[0]||"line");var size=Number(s.sizePercent);(!Number.isFinite(size)||size<25||size>100)&&(size=100),size=5*Math.round(size/5);var animations=!(s.style&&!1===s.style.animations),supportsIcons=!(!meta||!meta.capabilities||!0!==meta.capabilities.icons),iconsEnabled=!!supportsIcons&&!(!s.style||!0!==s.style.icons),supportsPieLabels=!(!modes||!(modes.indexOf("pie")>=0||modes.indexOf("donut")>=0)),pieLabelPosition=s&&s.style&&null!=s.style.pieLabelPosition?String(s.style.pieLabelPosition).trim().toLowerCase():"auto";"auto"!==pieLabelPosition&&"inside"!==pieLabelPosition&&"outside"!==pieLabelPosition&&(pieLabelPosition="auto");var pieLabelOffset=s&&s.style&&Number.isFinite(Number(s.style.pieLabelOffset))?Math.round(Number(s.style.pieLabelOffset)):16;Number.isFinite(pieLabelOffset)||(pieLabelOffset=16),pieLabelOffset=Math.round(Math.max(-40,Math.min(40,pieLabelOffset))),"outside"===pieLabelPosition&&(pieLabelOffset=Math.max(6,pieLabelOffset)),"inside"===pieLabelPosition&&(pieLabelOffset=Math.min(0,pieLabelOffset));var finishesCenterLabel=!(s.style&&!1===s.style.radialCenterLabel),isOverview="dash-chart-overview-30d"===chartKey,isFinishes="dash-chart-finishes-30d"===chartKey,colors=s.colors&&Array.isArray(s.colors)?s.colors:meta.series&&meta.series.length?["#3eb3ab","#ef4444","#2fb344","#d63939"].slice(0,meta.series.length):["#3eb3ab"],rev=isOverview&&colors[0]?colors[0]:"#3eb3ab",cost=isOverview&&colors[1]?colors[1]:"#ef4444",profitPos=isOverview&&colors[2]?colors[2]:"#2fb344",profitNeg=isOverview&&colors[3]?colors[3]:"#d63939",fillOpacityRaw=s&&s.style&&Number.isFinite(Number(s.style.fillOpacity))?Math.max(0,Math.min(1,Number(s.style.fillOpacity))):.18,fillOpacityPct=Math.round(100*fillOpacityRaw),fillOpacityVisible="map"!==String(mode||"").trim().toLowerCase(),body="";if(body+='<div class="row g-3">',Array.isArray(modes)&&1===modes.length){var lockVal=String(modes[0]||mode||"line").trim().toLowerCase();body+='<input type="hidden" data-cs-field="mode" value="'+escapeHtml(String(lockVal))+'">'}else body+='<div class="col-12 col-md-6"><label class="form-label">Chart type</label><select class="form-select form-select-sm" data-cs-field="mode">'+function(modes,selected){var labels=window.KEXO_CHART_MODE_LABEL&&"object"==typeof window.KEXO_CHART_MODE_LABEL?window.KEXO_CHART_MODE_LABEL:{},sel=String(selected||"").trim().toLowerCase();return(modes||[]).map(function(m){var v=String(m||"").trim().toLowerCase();if(!v)return"";var label=labels[v]||v;return'<option value="'+escapeHtml(v)+'"'+(v===sel?" selected":"")+">"+escapeHtml(label)+"</option>"}).join("")}(modes,mode)+"</select></div>";var isMapChart="live-online-chart"===chartKey||"countries-map-chart"===chartKey;if(!isMapChart){body+='<div class="col-12 col-md-6"><label class="form-label">Size (% of container)</label><select class="form-select form-select-sm" data-cs-field="sizePercent">';for(var p=25;p<=100;p+=5)body+='<option value="'+p+'"'+(p===size?" selected":"")+">"+p+"%</option>";body+="</select></div>"}isMapChart||(body+='<div class="col-12"><label class="form-check form-switch m-0"><input class="form-check-input" type="checkbox" data-cs-field="animations"'+(animations?" checked":"")+'><span class="form-check-label ms-2">Animations</span></label></div>'),supportsIcons&&(body+='<div class="col-12"><label class="form-check form-switch m-0"><input class="form-check-input" type="checkbox" data-cs-field="icons"'+(iconsEnabled?" checked":"")+'><span class="form-check-label ms-2">Icons</span></label><div class="form-hint">Show source icons in the chart legend.</div></div>'),isFinishes&&(body+='<div class="col-12'+("radialbar"===String(mode||"").toLowerCase()?"":" d-none")+'" data-cs-mode-group="finishes-center-label">',body+='<label class="form-check form-switch m-0"><input class="form-check-input" type="checkbox" data-cs-field="radialCenterLabel"'+(finishesCenterLabel?" checked":"")+'><span class="form-check-label ms-2">Place the highest revenue variant in the center?</span></label>',body+='<div class="form-hint">Only applies to the Radial Bar chart type.</div>',body+="</div>");var capControls=meta&&meta.capabilities&&Array.isArray(meta.capabilities.controls)?meta.capabilities.controls:[];if(capControls&&capControls.length){var styleObj=s&&s.style&&"object"==typeof s.style?s.style:{};function hintIconHtml(txt){var t=null!=txt?String(txt).trim():"";return t?'<span class="text-muted small ms-1 d-inline-flex align-items-center" role="img" aria-label="'+escapeHtml(t)+'" title="'+escapeHtml(t)+'"><i class="fa-light fa-circle-info" aria-hidden="true"></i></span>':""}capControls.forEach(function(c){if(c&&"object"==typeof c){var type=null!=c.type?String(c.type).trim().toLowerCase():"",field=null!=c.field?String(c.field).trim():"";if(type&&field){var label=null!=c.label?String(c.label):field,hint=null!=c.hint?String(c.hint):"",modesOnly=Array.isArray(c.modes)?c.modes.map(function(m){return String(m||"").trim().toLowerCase()}).filter(Boolean):null,modeAttr=modesOnly&&modesOnly.length?' data-cs-modes="'+escapeHtml(modesOnly.join(","))+'"':"";if("select"===type){var options=Array.isArray(c.options)?c.options:[],v=styleObj&&null!=styleObj[field]?String(styleObj[field]).trim().toLowerCase():null!=c.default?String(c.default).trim().toLowerCase():"";options.length&&!options.some(function(o){return o&&String(o.value).trim().toLowerCase()===v})&&(v=String(options[0].value).trim().toLowerCase()),body+='<div class="col-12 col-md-6"'+modeAttr+">",body+='<label class="form-label d-flex align-items-center gap-1">'+escapeHtml(label)+hintIconHtml(hint)+"</label>",body+='<select class="form-select form-select-sm" data-cs-field="'+escapeHtml(field)+'">',options.forEach(function(o){if(o){var ov=null!=o.value?String(o.value).trim().toLowerCase():"",ol=null!=o.label?String(o.label):ov;ov&&(body+='<option value="'+escapeHtml(ov)+'"'+(ov===v?" selected":"")+">"+escapeHtml(ol)+"</option>")}}),body+="</select>",body+="</div>"}else if("range"===type){var min=Number(c.min),max=Number(c.max),step=Number(c.step),unit=null!=c.unit?String(c.unit):"";Number.isFinite(min)||(min=0),Number.isFinite(max)||(max=100),(!Number.isFinite(step)||step<=0)&&(step=1);var raw=styleObj&&null!=styleObj[field]?Number(styleObj[field]):Number(c.default);Number.isFinite(raw)||(raw=min),raw<min&&(raw=min),raw>max&&(raw=max),body+='<div class="col-12 col-md-6"'+modeAttr+">",body+='<label class="form-label d-flex align-items-center justify-content-between">',body+='<span class="d-inline-flex align-items-center gap-1">'+escapeHtml(label)+hintIconHtml(hint)+"</span>",body+='<span class="text-muted small" data-cs-range-value="'+escapeHtml(field)+'">'+escapeHtml(String(raw))+(unit?escapeHtml(unit):"")+"</span>",body+="</label>",body+='<input type="range" class="form-range" min="'+escapeHtml(String(min))+'" max="'+escapeHtml(String(max))+'" step="'+escapeHtml(String(step))+'" value="'+escapeHtml(String(raw))+'" data-cs-field="'+escapeHtml(field)+'" data-cs-range-unit="'+escapeHtml(unit)+'">',body+="</div>"}else if("toggle"===type){var def="boolean"==typeof c.default&&c.default,stored=styleObj&&"boolean"==typeof styleObj[field]?styleObj[field]:def,invert=!!c.invert,checked=invert?!stored:!!stored;body+='<div class="col-12"'+modeAttr+">",body+='<label class="form-check form-switch m-0">',body+='<input class="form-check-input" type="checkbox" data-cs-field="'+escapeHtml(field)+'"'+(checked?" checked":"")+(invert?' data-cs-invert="1"':"")+">",body+='<span class="form-check-label ms-2 d-inline-flex align-items-center gap-1">'+escapeHtml(label)+hintIconHtml(hint)+"</span>",body+="</label>",body+="</div>"}}}})}if(body+='<div class="col-12'+(fillOpacityVisible?"":" d-none")+'" data-cs-mode-group="fill-opacity">',body+='<label class="form-label d-flex align-items-center justify-content-between">',body+="<span data-cs-fill-opacity-label>Area fill opacity</span>",body+='<span class="text-muted small" data-cs-fill-opacity-value>'+fillOpacityPct+"%</span>",body+="</label>",body+='<input type="range" class="form-range" min="0" max="100" step="1" value="'+fillOpacityPct+'" data-cs-field="fillOpacity">',body+='<div class="form-hint">Lower values make chart fills more transparent.</div>',body+="</div>",isMapChart){var mapAccent=colors&&colors[0]?String(colors[0]).trim():"#16a34a",styleIn=s&&s.style&&"object"==typeof s.style?s.style:{},mapFit=null!=styleIn.mapFit?String(styleIn.mapFit).trim().toLowerCase():"cover";"cover"!==mapFit&&"contain"!==mapFit&&(mapFit="cover");var inactiveOpacity=null!=styleIn.mapInactiveOpacity&&Number.isFinite(Number(styleIn.mapInactiveOpacity))?Math.max(0,Math.min(1,Number(styleIn.mapInactiveOpacity))):.09,inactiveOpacityPct=Math.round(100*inactiveOpacity),inactiveColor=null!=styleIn.mapInactiveColor?String(styleIn.mapInactiveColor).trim():"",stageBrowse=null!=styleIn.mapStageBrowseColor?String(styleIn.mapStageBrowseColor).trim():"",stageCart=null!=styleIn.mapStageCartColor?String(styleIn.mapStageCartColor).trim():"",stageCheckout=null!=styleIn.mapStageCheckoutColor?String(styleIn.mapStageCheckoutColor).trim():"",stagePurchase=null!=styleIn.mapStagePurchaseColor?String(styleIn.mapStagePurchaseColor).trim():"";body+='<div class="col-12 col-md-6"><label class="form-label">Map accent (hex)</label>',body+='<div class="kexo-color-input"><input type="text" class="form-control form-control-sm" data-kexo-color-input data-cs-field="map-accent" value="'+escapeHtml(mapAccent)+'" placeholder="#16a34a"><span class="kexo-color-swatch" data-kexo-color-swatch aria-hidden="true"></span></div>',body+='<div class="form-hint">Controls map shading and highlighted regions.</div></div>',body+='<div class="col-12 col-md-6"><label class="form-label">Fit</label>',body+='<select class="form-select form-select-sm" data-cs-field="mapFit">',body+='<option value="cover"'+("cover"===mapFit?" selected":"")+">Fill (cover)</option>",body+='<option value="contain"'+("contain"===mapFit?" selected":"")+">Fit (contain)</option>",body+="</select>",body+='<div class="form-hint">Cover fills the container (crops edges). Contain shows the full world (may leave whitespace).</div></div>',body+='<div class="col-12 col-md-6"><label class="form-label d-flex align-items-center justify-content-between"><span>Inactive regions opacity</span><span class="text-muted small" data-cs-inactive-opacity-value>'+inactiveOpacityPct+"%</span></label>",body+='<input type="range" class="form-range" min="0" max="100" step="1" value="'+inactiveOpacityPct+'" data-cs-field="mapInactiveOpacity">',body+='<div class="form-hint">Opacity for countries with no data (default 9%).</div></div>',body+='<div class="col-12 col-md-6"><label class="form-label">Inactive regions colour</label>',body+='<div class="kexo-color-input"><input type="text" class="form-control form-control-sm" data-kexo-color-input data-cs-field="mapInactiveColor" value="'+escapeHtml(inactiveColor)+'" placeholder="(default)" data-kexo-default-color="'+escapeHtml(mapAccent)+'"><span class="kexo-color-swatch" data-kexo-color-swatch aria-hidden="true"></span></div>',body+='<div class="form-hint">Leave blank to use map accent colour.</div></div>',body+='<div class="col-12"><label class="form-label">Stage colors (legend + pins)</label><div class="row g-2">',body+='<div class="col-6 col-md-3"><label class="form-label small">Browsing</label><div class="kexo-color-input"><input type="text" class="form-control form-control-sm" data-kexo-color-input data-cs-field="mapStageBrowseColor" value="'+escapeHtml(stageBrowse)+'" placeholder="(default)" data-kexo-default-color="#4b94e4"><span class="kexo-color-swatch" data-kexo-color-swatch aria-hidden="true"></span></div></div>',body+='<div class="col-6 col-md-3"><label class="form-label small">In cart</label><div class="kexo-color-input"><input type="text" class="form-control form-control-sm" data-kexo-color-input data-cs-field="mapStageCartColor" value="'+escapeHtml(stageCart)+'" placeholder="(default)" data-kexo-default-color="#f59e34"><span class="kexo-color-swatch" data-kexo-color-swatch aria-hidden="true"></span></div></div>',body+='<div class="col-6 col-md-3"><label class="form-label small">Checkout</label><div class="kexo-color-input"><input type="text" class="form-control form-control-sm" data-kexo-color-input data-cs-field="mapStageCheckoutColor" value="'+escapeHtml(stageCheckout)+'" placeholder="(default)" data-kexo-default-color="#6681e8"><span class="kexo-color-swatch" data-kexo-color-swatch aria-hidden="true"></span></div></div>',body+='<div class="col-6 col-md-3"><label class="form-label small">Purchased</label><div class="kexo-color-input"><input type="text" class="form-control form-control-sm" data-kexo-color-input data-cs-field="mapStagePurchaseColor" value="'+escapeHtml(stagePurchase)+'" placeholder="(default)" data-kexo-default-color="#3eb3ab"><span class="kexo-color-swatch" data-kexo-color-swatch aria-hidden="true"></span></div></div>',body+='</div><div class="form-hint">Leave blank to use theme defaults.</div></div>'}function normalizeHex6(v){var r=(null==v?"":String(v)).trim().toLowerCase();return/^#[0-9a-f]{6}$/.test(r)?r:/^[0-9a-f]{6}$/.test(r)?"#"+r:null}function syncColorPreview(inputEl){if(inputEl){var sw=null;try{sw=inputEl.parentNode?inputEl.parentNode.querySelector("[data-kexo-color-swatch]"):null}catch(_){sw=null}if(sw){var raw=(null==inputEl.value?"":String(inputEl.value)).trim(),hexVal=normalizeHex6(raw),defaultHex=null;if(!raw){try{defaultHex=normalizeHex6(inputEl.getAttribute("data-kexo-default-color"))}catch(_){defaultHex=null}if(!defaultHex)try{defaultHex=normalizeHex6(inputEl.getAttribute("placeholder"))}catch(_){defaultHex=null}}try{var preview=hexVal||defaultHex;preview?(sw.classList.remove("is-empty"),sw.style.setProperty("--kexo-swatch-color",preview)):(sw.classList.add("is-empty"),sw.style.removeProperty("--kexo-swatch-color"))}catch(_){}}}}function syncModeControls(modeVal){var m=String(modeVal||"").trim().toLowerCase(),fillWrap=bodyEl.querySelector('[data-cs-mode-group="fill-opacity"]');if(fillWrap){!function(modeVal){return"map"!==String(modeVal||"").trim().toLowerCase()}(m)?fillWrap.classList.add("d-none"):fillWrap.classList.remove("d-none");var labelEl=fillWrap.querySelector("[data-cs-fill-opacity-label]");labelEl&&(labelEl.textContent=function(modeVal){var m=String(modeVal||"").trim().toLowerCase();return 0===m.indexOf("map")?"Map region opacity":"stacked-area"===m?"Stacked area opacity":"area"===m?"Area fill opacity":"stacked-bar"===m?"Stacked bar opacity":"bar"===m?"Bar opacity":"line"===m||"multi-line-labels"===m?"Line opacity":"pie"===m||"donut"===m?"Slice opacity":"radialbar"===m?"Ring opacity":"Series opacity"}(m))}var pieWrap=bodyEl.querySelector('[data-cs-mode-group="pie-labels"]');pieWrap&&(!supportsPieLabels||"pie"!==m&&"donut"!==m?pieWrap.classList.add("d-none"):pieWrap.classList.remove("d-none"));var finishesWrap=bodyEl.querySelector('[data-cs-mode-group="finishes-center-label"]');finishesWrap&&("radialbar"===m?finishesWrap.classList.remove("d-none"):finishesWrap.classList.add("d-none"));try{for(var modeWraps=bodyEl.querySelectorAll("[data-cs-modes]"),i=0;i<modeWraps.length;i++){var w=modeWraps[i];if(w&&w.getAttribute){var allowed=String(w.getAttribute("data-cs-modes")||"").split(",").map(function(x){return String(x||"").trim().toLowerCase()}).filter(Boolean);allowed.length&&(allowed.indexOf(m)>=0?w.classList.remove("d-none"):w.classList.add("d-none"))}}}catch(_){}}body+='<div class="col-12'+(!supportsPieLabels||"pie"!==mode&&"donut"!==mode?" d-none":"")+'" data-cs-mode-group="pie-labels">',body+='<div class="row g-2">',body+='<div class="col-12 col-md-6">',body+='<label class="form-label">Label position</label>',body+='<select class="form-select form-select-sm" data-cs-field="pieLabelPosition">',body+='<option value="auto"'+("auto"===pieLabelPosition?" selected":"")+">Auto</option>",body+='<option value="inside"'+("inside"===pieLabelPosition?" selected":"")+">Inside</option>",body+='<option value="outside"'+("outside"===pieLabelPosition?" selected":"")+">Outside</option>",body+="</select>",body+='<div class="form-hint">Applies to Pie / Donut chart types.</div>',body+="</div>",body+='<div class="col-12 col-md-6">',body+='<label class="form-label d-flex align-items-center justify-content-between">',body+="<span>Label offset</span>",body+='<span class="text-muted small" data-cs-pie-label-offset-value>'+String(pieLabelOffset)+"px</span>",body+="</label>",body+='<input type="range" class="form-range" min="-40" max="40" step="1" value="'+String(pieLabelOffset)+'" data-cs-field="pieLabelOffset">',body+='<div class="form-hint">Move labels inward (negative) or outward (positive).</div>',body+="</div>",body+="</div>",body+="</div>",isOverview&&(body+='<div class="col-12"><label class="form-label">Colours</label><div class="row g-2">',body+='<div class="col-6 col-md-3"><label class="form-label small">Revenue</label><div class="kexo-color-input"><input type="text" class="form-control form-control-sm" data-kexo-color-input data-cs-field="color-revenue" value="'+escapeHtml(rev)+'" placeholder="#3eb3ab"><span class="kexo-color-swatch" data-kexo-color-swatch aria-hidden="true"></span></div></div>',body+='<div class="col-6 col-md-3"><label class="form-label small">Cost</label><div class="kexo-color-input"><input type="text" class="form-control form-control-sm" data-kexo-color-input data-cs-field="color-cost" value="'+escapeHtml(cost)+'" placeholder="#ef4444"><span class="kexo-color-swatch" data-kexo-color-swatch aria-hidden="true"></span></div></div>',body+='<div class="col-6 col-md-3"><label class="form-label small">Profit (positive)</label><div class="kexo-color-input"><input type="text" class="form-control form-control-sm" data-kexo-color-input data-cs-field="color-profitPos" value="'+escapeHtml(profitPos)+'" placeholder="#2fb344"><span class="kexo-color-swatch" data-kexo-color-swatch aria-hidden="true"></span></div></div>',body+='<div class="col-6 col-md-3"><label class="form-label small">Profit (negative)</label><div class="kexo-color-input"><input type="text" class="form-control form-control-sm" data-kexo-color-input data-cs-field="color-profitNeg" value="'+escapeHtml(profitNeg)+'" placeholder="#d63939"><span class="kexo-color-swatch" data-kexo-color-swatch aria-hidden="true"></span></div></div>',body+="</div></div>",body+='<div class="col-12">',body+='<a class="btn btn-sm btn-secondary" href="/settings/cost-expenses/rules">Open cost settings</a>',body+='<div class="form-hint">Manage cost sources, shipping, and profit rules.</div>',body+="</div>"),body+="</div>",bodyEl.innerHTML=body,bodyEl.setAttribute("data-cs-chart-key",chartKey),setMsg("",null),function(){try{for(var inputs=bodyEl.querySelectorAll("[data-kexo-color-input]"),i=0;i<inputs.length;i++){var el=inputs[i];el&&!el.__kexoColorPreviewBound&&(el.__kexoColorPreviewBound=1,function(inputEl){var sync=function(){syncColorPreview(inputEl)};try{inputEl.addEventListener("input",sync)}catch(_){}try{inputEl.addEventListener("change",sync)}catch(_){}sync()}(el))}}catch(_){}}(),function(){var input=bodyEl.querySelector('[data-cs-field="fillOpacity"]'),valueEl=bodyEl.querySelector("[data-cs-fill-opacity-value]");if(input){try{input.addEventListener("input",sync)}catch(_){}try{input.addEventListener("change",sync)}catch(_){}sync()}function sync(){var raw=parseInt(String(input.value||""),10);Number.isFinite(raw)||(raw=fillOpacityPct),raw=Math.max(0,Math.min(100,raw));try{input.value=String(raw)}catch(_){}valueEl&&(valueEl.textContent=raw+"%")}}(),function(){var input=bodyEl.querySelector('[data-cs-field="mapInactiveOpacity"]'),valueEl=bodyEl.querySelector("[data-cs-inactive-opacity-value]");if(input){try{input.addEventListener("input",sync)}catch(_){}try{input.addEventListener("change",sync)}catch(_){}sync()}function sync(){var raw=parseInt(String(input.value||""),10);Number.isFinite(raw)||(raw=9),raw=Math.max(0,Math.min(100,raw));try{input.value=String(raw)}catch(_){}valueEl&&(valueEl.textContent=raw+"%")}}(),function(){var posEl=bodyEl.querySelector('[data-cs-field="pieLabelPosition"]'),offEl=bodyEl.querySelector('[data-cs-field="pieLabelOffset"]'),valueEl=bodyEl.querySelector("[data-cs-pie-label-offset-value]");if(posEl&&offEl){try{posEl.addEventListener("change",sync)}catch(_){}try{offEl.addEventListener("input",sync)}catch(_){}try{offEl.addEventListener("change",sync)}catch(_){}sync()}function sync(){var pos=String(posEl.value||"").trim().toLowerCase();"auto"!==pos&&"inside"!==pos&&"outside"!==pos&&(pos="auto");try{posEl.value=pos}catch(_){}var next=function(raw,pos){var n=parseInt(String(null==raw?"":raw),10);Number.isFinite(n)||(n=pieLabelOffset),n=Math.round(Math.max(-40,Math.min(40,n)));var p=String(pos||"").trim().toLowerCase();return"outside"===p&&(n=Math.max(6,n)),"inside"===p&&(n=Math.min(0,n)),n}(offEl.value,pos);try{offEl.value=String(next)}catch(_){}valueEl&&(valueEl.textContent=String(next)+"px")}}(),function(){try{for(var inputs=bodyEl.querySelectorAll('input[type="range"][data-cs-range-unit]'),i=0;i<inputs.length;i++){var inp=inputs[i];inp&&!inp.__kexoRangeBound&&(inp.__kexoRangeBound=1,function(el){var field=el.getAttribute("data-cs-field")||"",unit=el.getAttribute("data-cs-range-unit")||"";function sync(){var span=bodyEl.querySelector('[data-cs-range-value="'+field+'"]');span&&(span.textContent=String(el.value||"")+(unit?String(unit):""))}try{el.addEventListener("input",sync)}catch(_){}try{el.addEventListener("change",sync)}catch(_){}sync()}(inp))}}catch(_){}}(),syncModeControls(mode);try{var modeSelect=bodyEl.querySelector('[data-cs-field="mode"]');modeSelect&&modeSelect.addEventListener("change",function(){syncModeControls(modeSelect.value)})}catch(_){}saveBtn&&(saveBtn.replaceWith(saveBtn.cloneNode(!0)),document.getElementById(MODAL_ID+"-save").addEventListener("click",function(){var payload=function(){var modeEl=bodyEl.querySelector('[data-cs-field="mode"]'),sizeEl=bodyEl.querySelector('[data-cs-field="sizePercent"]'),animEl=bodyEl.querySelector('[data-cs-field="animations"]'),iconsEl=supportsIcons?bodyEl.querySelector('[data-cs-field="icons"]'):null,centerEl=isFinishes?bodyEl.querySelector('[data-cs-field="radialCenterLabel"]'):null,piePosEl=supportsPieLabels?bodyEl.querySelector('[data-cs-field="pieLabelPosition"]'):null,pieOffEl=supportsPieLabels?bodyEl.querySelector('[data-cs-field="pieLabelOffset"]'):null,styleBase={};try{s&&s.style&&"object"==typeof s.style&&(styleBase=Object.assign({},s.style))}catch(_){styleBase={}}if(animEl&&(styleBase.animations=!!animEl.checked),supportsIcons&&(styleBase.icons=!(!iconsEl||!iconsEl.checked)),isFinishes&&(styleBase.radialCenterLabel=!(!centerEl||!centerEl.checked)),piePosEl){var pp=String(piePosEl.value||"").trim().toLowerCase();"auto"!==pp&&"inside"!==pp&&"outside"!==pp&&(pp="auto"),styleBase.pieLabelPosition=pp}if(pieOffEl){var po=parseInt(String(pieOffEl.value||""),10);if(Number.isFinite(po)){po=Math.round(Math.max(-40,Math.min(40,po)));var refPos=styleBase&&styleBase.pieLabelPosition?String(styleBase.pieLabelPosition).trim().toLowerCase():"auto";"outside"===refPos&&(po=Math.max(6,po)),"inside"===refPos&&(po=Math.min(0,po)),styleBase.pieLabelOffset=po}}var fillEl=bodyEl.querySelector('[data-cs-field="fillOpacity"]');if(fillEl){var raw=parseInt(String(fillEl.value||""),10);Number.isFinite(raw)&&(styleBase.fillOpacity=Math.max(0,Math.min(1,raw/100)))}try{(capControls||[]).forEach(function(c){if(c&&"object"==typeof c){var type=null!=c.type?String(c.type).trim().toLowerCase():"",field=null!=c.field?String(c.field).trim():"";if(type&&field){var el=bodyEl.querySelector('[data-cs-field="'+field+'"]');if(el)if("select"===type){var sv=null!=el.value?String(el.value).trim().toLowerCase():"";sv&&(styleBase[field]=sv)}else if("range"===type){var min=Number(c.min),max=Number(c.max),step=Number(c.step);Number.isFinite(min)||(min=0),Number.isFinite(max)||(max=100),(!Number.isFinite(step)||step<=0)&&(step=1);var n=Number(el.value);Number.isFinite(n)||(n=Number(c.default)),Number.isFinite(n)||(n=min),n<min&&(n=min),n>max&&(n=max);
// Keep a stable precision for decimals (e.g. strokeWidth step=0.1).
var decimals=String(step).indexOf(".")>=0?String(step).split(".")[1].length:0;n=decimals>0?Number(n.toFixed(Math.min(4,decimals))):Math.round(n),styleBase[field]=n}else if("toggle"===type){var checked=!(!el||!el.checked),invert=!(!0!==c.invert)||el.getAttribute&&"1"===el.getAttribute("data-cs-invert");styleBase[field]=invert?!checked:checked}}}})}catch(_){}var out={key:chartKey,mode:modeEl&&modeEl.value?String(modeEl.value).trim().toLowerCase():mode,sizePercent:sizeEl?parseInt(sizeEl.value,10):100,style:styleBase,colors:s.colors&&Array.isArray(s.colors)?s.colors.slice():meta.series&&meta.series.length?["#3eb3ab","#ef4444","#2fb344","#d63939"].slice(0,meta.series.length):["#3eb3ab"]};if(isMapChart){var mapAccentEl=bodyEl.querySelector('[data-cs-field="map-accent"]'),mapFitEl=bodyEl.querySelector('[data-cs-field="mapFit"]');function normalizeHexOpt(v){var r=(null==v?"":String(v)).trim().toLowerCase();return r?/^#[0-9a-f]{6}$/.test(r)?r:6===r.length&&/^[0-9a-f]{6}$/i.test(r)?"#"+r:"":""}if(mapAccentEl){var acc=normalizeHexOpt(mapAccentEl.value);acc&&(out.colors[0]=acc)}if(mapFitEl){var mf=String(mapFitEl.value||"").trim().toLowerCase();"cover"!==mf&&"contain"!==mf&&(mf="cover"),styleBase.mapFit=mf}var inactiveOpacityEl=bodyEl.querySelector('[data-cs-field="mapInactiveOpacity"]');if(inactiveOpacityEl){var rawOp=parseInt(String(inactiveOpacityEl.value||""),10);Number.isFinite(rawOp)&&(styleBase.mapInactiveOpacity=Math.max(0,Math.min(1,rawOp/100)))}var inactiveColorEl=bodyEl.querySelector('[data-cs-field="mapInactiveColor"]');inactiveColorEl&&(styleBase.mapInactiveColor=normalizeHexOpt(inactiveColorEl.value)||""),["mapStageBrowseColor","mapStageCartColor","mapStageCheckoutColor","mapStagePurchaseColor"].forEach(function(field){var el=bodyEl.querySelector('[data-cs-field="'+field+'"]');if(el){var v=normalizeHexOpt(el.value);styleBase[field]=v||""}})}if(isOverview){var revEl=bodyEl.querySelector('[data-cs-field="color-revenue"]'),costEl=bodyEl.querySelector('[data-cs-field="color-cost"]'),posEl=bodyEl.querySelector('[data-cs-field="color-profitPos"]'),negEl=bodyEl.querySelector('[data-cs-field="color-profitNeg"]'),hex=function(v){var r=(null==v?"":String(v)).trim().toLowerCase();return/^#[0-9a-f]{6}$/.test(r)?r:6===r.length&&/^[0-9a-f]{6}$/i.test(r)?"#"+r:null};revEl&&hex(revEl.value)&&(out.colors[0]=hex(revEl.value)||out.colors[0]),costEl&&hex(costEl.value)&&(out.colors[1]=hex(costEl.value)||out.colors[1]),posEl&&hex(posEl.value)&&(out.colors[2]=hex(posEl.value)||out.colors[2]),negEl&&hex(negEl.value)&&(out.colors[3]=hex(negEl.value)||out.colors[3])}return out}();setMsg("Saving…",null),fetch(API+"/api/chart-settings/"+encodeURIComponent(chartKey),{method:"PUT",credentials:"same-origin",headers:{"Content-Type":"application/json"},body:JSON.stringify({settings:payload})}).then(function(r){return r.json()}).then(function(data){if(data&&data.ok&&data.chartsUiConfig){
// Server response is the only source of truth post-save.
!function(cfg){if(cfg&&1===cfg.v){var toStore;try{toStore=Object.assign({},cfg,{schemaVersion:1,updatedAt:Date.now()})}catch(_){toStore=cfg}try{safeWriteLocalStorageJson("kexo:charts-ui-config:v1",toStore)}catch(_){}}}(data.chartsUiConfig);try{window.dispatchEvent(new CustomEvent("kexo:chartsUiConfigUpdated",{detail:data.chartsUiConfig}))}catch(_){}setMsg("Saved.",!0),closeModal()}else setMsg(data&&data.error?String(data.error):"Save failed",!1)}).catch(function(){setMsg("Save failed",!1)})}))}).catch(function(){
// Ignore aborts (close/back) to avoid showing a spurious error.
try{if(inFlight&&inFlight.controller&&inFlight.controller.signal&&inFlight.controller.signal.aborted)return}catch(_){}setMsg("Could not load settings.",!1),bodyEl&&(bodyEl.innerHTML='<div class="text-muted">Could not load settings.</div>')})}}}}"undefined"!=typeof window&&(window.KexoChartSettingsBuilder={openModal:openModal});var bound=!1;function initDelegation(){try{if(document&&document.documentElement&&"1"===document.documentElement.getAttribute("data-kexo-chart-settings-delegation"))return void(bound=!0)}catch(_){}if(!bound){bound=!0;try{document&&document.documentElement&&document.documentElement.setAttribute("data-kexo-chart-settings-delegation","1")}catch(_){}
// Capture phase so we still handle clicks even if other handlers stop propagation.
document.addEventListener("click",handleSettingsTrigger,!0);try{document.addEventListener("pointerup",handleSettingsTrigger,!0)}catch(_){}}function handleSettingsTrigger(e){if(e&&e.target&&!e.__kexoChartSettingsHandled){
// Some embed contexts can interfere with "click". Pointer events are more reliable.
try{if("pointerup"===e.type)if("mouse"===String(e.pointerType||"").toLowerCase()&&0!==e.button)return}catch(_){}
// Only trigger when clicking an actual settings control (not anywhere inside a chart card).
var hit=function(node,selector){try{for(var el=node&&1===node.nodeType?node:node&&node.parentElement?node.parentElement:null;el&&el!==document&&1===el.nodeType;){if(el.matches&&el.matches(selector))return el;el=el.parentElement}}catch(_){}return null}(e.target,'[data-kexo-chart-settings-key],.kexo-overview-chart-settings-btn,.kexo-builder-icon-link[data-kexo-chart-settings-key],.kexo-builder-icon-link[aria-label="Chart settings"],.kexo-builder-icon-link[title="Chart settings"]');if(hit){var chartKey="";try{chartKey=String(hit.getAttribute("data-kexo-chart-settings-key")||"").trim()}catch(_){chartKey=""}if(!chartKey)try{chartKey=String(hit.getAttribute("data-kexo-chart-key")||hit.getAttribute("data-chart-key")||"").trim()}catch(_){chartKey=""}if(!chartKey)try{var wrap=hit.closest?hit.closest("[data-kexo-chart-key],[data-chart-key]"):null;chartKey=wrap?String(wrap.getAttribute("data-kexo-chart-key")||wrap.getAttribute("data-chart-key")||"").trim():""}catch(_){chartKey=""}if(chartKey){e.preventDefault();try{e.__kexoChartSettingsHandled=!0}catch(_){}try{"function"==typeof e.stopPropagation&&e.stopPropagation()}catch(_){}var title="";try{var card=hit.closest?hit.closest(".card"):null,titleEl=card?card.querySelector(".card-title,.subheader"):null;title=titleEl&&titleEl.textContent?String(titleEl.textContent).trim():""}catch(_){title=""}openModal({chartKey:chartKey,cardTitle:title||chartKey})}}}}}
// Bind immediately (safe even while DOM is still loading).
initDelegation(),"loading"===document.readyState&&document.addEventListener("DOMContentLoaded",initDelegation)}(),
/**
 * Logo rotator: header/footer.
 * - Random per page load (server picks an existing variant).
 * - Single-init, no listeners beyond DOMContentLoaded.
 */
function(){"use strict";function setLogoImg(img,url){if(img&&img.getAttribute&&img.setAttribute)if("1"!==img.getAttribute("data-kexo-logo-rotated")){if(url)try{String(img.getAttribute("src")||"")!==String(url)&&img.setAttribute("src",url),img.setAttribute("data-kexo-logo-rotated","1"),img.setAttribute("data-kexo-logo-ready","1"),img.hasAttribute&&img.hasAttribute("hidden")&&img.removeAttribute("hidden")}catch(_){}}else try{img.setAttribute("data-kexo-logo-ready","1"),img.hasAttribute&&img.hasAttribute("hidden")&&img.removeAttribute("hidden")}catch(_){}}function run(){
// Header (desktop strip)
var headerImg=document.querySelector('img[data-kexo-logo-slot="header"]')||document.querySelector(".kexo-desktop-brand-link img");headerImg&&setLogoImg(headerImg,"/api/header-logo");
// Footer
var footerImg=document.querySelector('img[data-kexo-logo-slot="footer"]')||document.querySelector(".kexo-footer-logo img");footerImg&&setLogoImg(footerImg,"/api/footer-logo")}"undefined"!=typeof window&&"undefined"!=typeof document&&(window.__kexoLogoRotatorBound||(window.__kexoLogoRotatorBound=!0,"loading"===document.readyState?document.addEventListener("DOMContentLoaded",run):run()))}(),
// Insights → Payment Methods (back-compat route: /insights/payment-types)
function(){"use strict";try{if("payment-types"!==String(PAGE||"").trim().toLowerCase())return}catch(_){return}
// Single-init guard (avoid repeated bindings in embed reloads).
try{if(document&&document.documentElement&&"1"===document.documentElement.getAttribute("data-kexo-payment-methods-init"))return;document&&document.documentElement&&document.documentElement.setAttribute("data-kexo-payment-methods-init","1")}catch(_){}function escapeHtml(value){if(null==value)return"";try{const div=document.createElement("div");return div.textContent=String(value),div.innerHTML.replace(/\"/g,"&quot;").replace(/'/g,"&#39;")}catch(_){return String(value).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}}function fmtInt(value){const n=Number(value);return Number.isFinite(n)?Math.max(0,Math.trunc(n)).toLocaleString("en-GB"):"—"}function fmtMoneyGbp2(value){const n=Number(value);if(!Number.isFinite(n))return"—";try{return"£"+n.toLocaleString("en-GB",{minimumFractionDigits:2,maximumFractionDigits:2})}catch(_){return"£"+n.toFixed(2)}}function normalizeRangeKeyForApi(key){const k=(null==key?"":String(key)).trim();if(!k)return"today";const lc=k.toLowerCase();return"7days"===lc?"7d":"14days"===lc?"14d":"30days"===lc?"30d":k}function setUpdated(label){const el=document.getElementById("payment-methods-updated");el&&(el.textContent=label||"Updated —")}function setTableMessage(message,isError){const body=document.getElementById("payment-types-body");if(!body)return;const msg=String(message||"—");body.innerHTML='<div class="grid-row" role="row"><div class="grid-cell empty span-all'+(isError?" text-danger":"")+'" role="cell">'+escapeHtml(msg)+"</div></div>"}function setChartMessage(message,isError){const el=document.getElementById("payment-methods-chart");el&&(el.innerHTML='<div class="'+(isError?"text-danger":"text-secondary")+'">'+escapeHtml(message||"—")+"</div>")}function renderPaymentIconOnly(iconSpec,iconSrc,iconAlt,label){const safeLabel=null!=label?String(label):"Other",safeAlt=null!=iconAlt?String(iconAlt):safeLabel,spec=null!=iconSpec?String(iconSpec).trim():"",url=null!=iconSrc?String(iconSrc).trim():"";return spec?/^<svg[\s>]/i.test(spec)?'<span class="kexo-payment-method-icon kexo-payment-method-icon--fill" aria-hidden="true">'+spec+"</span>":/^(https?:\/\/|\/\/|\/)/i.test(spec)?'<img class="kexo-payment-method-icon kexo-payment-method-icon--fill" src="'+escapeHtml(spec)+'" alt="'+escapeHtml(safeAlt)+'" loading="lazy" />':'<i class="'+escapeHtml(spec)+' kexo-payment-method-fallback-icon" aria-hidden="true"></i>':url?'<img class="kexo-payment-method-icon kexo-payment-method-icon--fill" src="'+escapeHtml(url)+'" alt="'+escapeHtml(safeAlt)+'" loading="lazy" />':'<i class="fa-light fa-circle-question text-secondary kexo-payment-method-fallback-icon" aria-hidden="true"></i>'}const CHART_KEY="payment-methods-chart";let lastPayload=null,inFlight=null,reqSeq=0;function renderChart(payload){const el=document.getElementById("payment-methods-chart");if(!el)return;const categoriesRaw=payload&&Array.isArray(payload.categories)?payload.categories:[],seriesRaw=payload&&Array.isArray(payload.series)?payload.series:[];if(!categoriesRaw.length||!seriesRaw.length)return void setChartMessage("No revenue data for this range.",!1);const categories=categoriesRaw.map(function(v){try{const s=String(v||"");
// Only apply date formatter to YYYY-MM-DD categories; hourly buckets are already formatted.
if(/^\d{4}-\d{2}-\d{2}/.test(s))return formatYmdShort(s)}catch(_){}return String(v||"")}),series=seriesRaw.map(function(s){return{name:s&&null!=s.label?String(s.label):s&&null!=s.key?String(s.key):"—",data:Array.isArray(s&&s.data)?s.data.map(function(v){const n=Number(v);return Number.isFinite(n)?n:0}):[]}});if(!isChartEnabledByUiConfig(CHART_KEY,!0)){try{if(el.__kexoChartInstance){try{el.__kexoChartInstance.destroy()}catch(_){}el.__kexoChartInstance=null}}catch(_){}return void(el.innerHTML="")}const rawMode=chartModeFromUiConfig(CHART_KEY,"line")||"line",showEndLabels="multi-line-labels"===rawMode,mode="multi-line-labels"===rawMode?"line":rawMode,palette=chartColorsFromUiConfig(CHART_KEY,["#4b94e4","#f59e34","#3eb3ab","#8b5cf6","#ef4444","#22c55e","#0ea5e9","#a3e635"]);try{"function"==typeof window.kexoRenderApexChart?window.kexoRenderApexChart({chartKey:CHART_KEY,containerEl:el,categories:categories,series:series,mode:mode,colors:palette,height:320,showEndLabels:showEndLabels,currency:!0,chartStyle:chartStyleFromUiConfig(CHART_KEY),advancedApexOverride:chartAdvancedOverrideFromUiConfig(CHART_KEY,mode)}):setChartMessage("Chart unavailable.",!0)}catch(_){setChartMessage("Failed to render chart.",!0)}}function renderTable(payload){const body=document.getElementById("payment-types-body");if(!body)return;const rows=payload&&Array.isArray(payload.rows)?payload.rows:[];rows.length?body.innerHTML=rows.map(function(r){r&&null!=r.key&&String(r.key);const label=r&&null!=r.label?String(r.label):"Other",iconSpec=r&&null!=r.iconSpec?String(r.iconSpec):"",iconSrc=r&&r.iconSrc?String(r.iconSrc):"",iconAlt=r&&r.iconAlt?String(r.iconAlt):label,payCell=function(iconSpec,iconSrc,iconAlt,label){const safeLabel=null!=label?String(label):"Other";return'<span class="d-inline-flex align-items-center gap-2">'+renderPaymentIconOnly(iconSpec,iconSrc,iconAlt,safeLabel)+"<span>"+escapeHtml(safeLabel)+"</span></span>"}(iconSpec,iconSrc,iconAlt,label);return'<div class="grid-row" role="row"><div class="grid-cell" role="cell">'+payCell+'</div><div class="grid-cell kexo-payments-icon-col kexo-payment-method-icon-cell" role="cell">'+('<span class="d-flex align-items-center justify-content-center w-100 h-100">'+renderPaymentIconOnly(iconSpec,iconSrc,iconAlt,label)+"</span>")+'</div><div class="grid-cell text-center" role="cell">'+escapeHtml(fmtInt(r.sessions))+'</div><div class="grid-cell text-end" role="cell">'+escapeHtml(fmtInt(r.carts))+'</div><div class="grid-cell text-end" role="cell">'+escapeHtml(fmtInt(r.orders))+'</div><div class="grid-cell text-end" role="cell">'+escapeHtml(function(value){if(null==value)return"—";const n=Number(value);return Number.isFinite(n)?n.toFixed(1)+"%":"—"}(r.cr))+'</div><div class="grid-cell text-end" role="cell">'+escapeHtml(fmtMoneyGbp2(r.vpv))+'</div><div class="grid-cell text-end" role="cell">'+escapeHtml(fmtMoneyGbp2(r.revenue))+'</div><div class="grid-cell text-end" role="cell">'+escapeHtml(fmtMoneyGbp2(r.aov))+"</div></div>"}).join(""):setTableMessage("No payment methods for this range.",!1)}function load(options){const force=!!(options&&"object"==typeof options?options:{}).force,range=function(){try{const sel=document.getElementById("global-date-select");if(sel&&sel.value)return normalizeRangeKeyForApi(sel.value)}catch(_){}try{if(void 0!==dateRange&&dateRange)return normalizeRangeKeyForApi(dateRange)}catch(_){}return"today"}()||"today",seq=++reqSeq;setUpdated("Updated —"),setChartMessage("Loading…",!1),setTableMessage("Loading…",!1);const url="/api/payment-methods/report?range="+encodeURIComponent(String(range))+(force?"&_="+Date.now():""),fetcher=fetchWithTimeout(url,{credentials:"same-origin",cache:"no-store"},2e4);return inFlight=Promise.resolve(fetcher).then(function(r){return r&&r.ok?r.json().catch(function(){return null}):null}).then(function(data){if(seq!==reqSeq)return null;if(!data||!data.ok)return setChartMessage("Failed to load payment methods.",!0),setTableMessage("Failed to load payment methods.",!0),null;lastPayload=data,renderChart(data),renderTable(data);try{setUpdated("Updated "+(new Date).toLocaleTimeString("en-GB",{hour:"2-digit",minute:"2-digit"}))}catch(_){}return data}).catch(function(){return seq!==reqSeq||(setChartMessage("Failed to load payment methods.",!0),setTableMessage("Failed to load payment methods.",!0)),null}).finally(function(){inFlight&&seq===reqSeq&&(inFlight=null)}),inFlight}!function(){const sel=document.getElementById("global-date-select");sel&&"1"!==sel.getAttribute("data-payment-methods-bound")&&(sel.setAttribute("data-payment-methods-bound","1"),sel.addEventListener("change",function(){setTimeout(function(){load({force:!0})},0)}));try{window&&window.addEventListener&&window.addEventListener("kexo:chartsUiConfigUpdated",function(){if(lastPayload)try{renderChart(lastPayload)}catch(_){}})}catch(_){}}(),load({force:!1})}(),
/**
 * Notifications offcanvas: tabs (Unread/Read/Archived), type icons, detail with Archive + Delete; mark read on view only.
 * Dedupe in-flight fetches to reduce duplicate requests.
 */
function(){var API=void 0!==window.API?window.API:"",listEl=document.getElementById("notifications-list"),listEmptyEl=document.getElementById("notifications-list-empty"),listViewEl=document.getElementById("notifications-list-view"),detailViewEl=document.getElementById("notifications-detail-view"),detailBodyEl=document.getElementById("notifications-detail-body"),detailActionsEl=document.getElementById("notifications-detail-actions"),backBtn=document.getElementById("notifications-back-btn"),offcanvasEl=document.getElementById("notifications-offcanvas");if(listEl&&offcanvasEl){var currentTab="unread",listData=null,TYPE_ICON_KEYS={daily_report:"notifications-type-daily-report",sale:"notifications-type-sale",sentry:"notifications-type-sentry",pending_signup:"notifications-type-pending-signup",diagnostics_unresolved:"notifications-type-diagnostics-unresolved"},_notificationsListInFlight=null,_notificationsDetailInFlight=new Map;offcanvasEl.addEventListener("shown.bs.offcanvas",function(){listEmptyEl&&(listEmptyEl.textContent="Loading…",listEmptyEl.classList.remove("d-none")),currentTab="unread",setActiveTab("unread"),fetchList().then(renderList)}),listEl.addEventListener("click",function(e){var actionBtn=e.target&&e.target.closest?e.target.closest("[data-notification-action]"):null;if(actionBtn){e.preventDefault(),e.stopPropagation();var action=actionBtn.getAttribute("data-notification-action"),row=actionBtn.closest(".notification-item"),idForAction=row&&row.getAttribute?row.getAttribute("data-id"):null;if(!idForAction)return;return actionBtn.disabled=!0,void("archive"===action?patchNotification(idForAction,{read:!0,archived:!0}).then(function(){fetchList().then(function(d){renderList(d)})}):"delete"===action&&deleteNotification(idForAction).then(function(){fetchList().then(function(d){renderList(d)})}))}var a=e.target&&e.target.closest?e.target.closest(".notification-item"):null;if(a){e.preventDefault();var id=a.getAttribute("data-id");id&&openDetail(id)}}),document.querySelectorAll("[data-notifications-tab]").forEach(function(btn){btn.addEventListener("click",function(){var tab=btn.getAttribute("data-notifications-tab");tab&&setActiveTab(tab)})}),backBtn&&backBtn.addEventListener("click",function(e){e.preventDefault(),showListView()}),fetchList().then(updateBadge);var badgeIntervalId=null;startBadgePoll(),document.addEventListener("visibilitychange",function(){"visible"===document.visibilityState?startBadgePoll():stopBadgePoll()});try{registerCleanup(function(){stopBadgePoll()})}catch(_){}}function getIconKeyForType(type){return TYPE_ICON_KEYS[type]||"notifications-type-default"}function getBadgeEls(){return document.querySelectorAll(".kexo-notifications-unread-badge")}function esc(s){try{if("function"==typeof window.kexoEscapeHtml)return window.kexoEscapeHtml(s)}catch(_){}return null==s?"":String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function formatTime(createdAt){if(null==createdAt)return"";var ts=Number(createdAt);if(!Number.isFinite(ts))return"";var d=new Date(ts),diff=Date.now()-ts;if(diff<6e4)return"Just now";if(diff<36e5)return Math.floor(diff/6e4)+"m ago";if(diff<864e5)return Math.floor(diff/36e5)+"h ago";if(diff<6048e5)return Math.floor(diff/864e5)+"d ago";try{return d.toLocaleDateString(void 0,{month:"short",day:"numeric",year:d.getFullYear()!==(new Date).getFullYear()?"numeric":void 0})}catch(_){return""}}function fetchList(){return _notificationsListInFlight||(_notificationsListInFlight=fetch(API+"/api/notifications",{credentials:"same-origin",cache:"no-store"}).then(function(r){return r&&r.ok?r.json():null}).catch(function(err){try{"function"==typeof window.kexoCaptureError&&window.kexoCaptureError(err,{context:"notifications.fetchList"})}catch(_){}return null}).finally(function(){_notificationsListInFlight=null}))}function patchNotification(id,body){return fetch(API+"/api/notifications/"+encodeURIComponent(String(id)),{method:"PATCH",credentials:"same-origin",headers:{"Content-Type":"application/json"},body:JSON.stringify(body||{})}).then(function(r){return r.ok?r.json():null}).catch(function(){return null})}function deleteNotification(id){return fetch(API+"/api/notifications/"+encodeURIComponent(String(id)),{method:"DELETE",credentials:"same-origin"}).then(function(r){return r.ok?r.json():null}).catch(function(){return null})}function updateTabCounts(data){var unread=data&&data.unread?data.unread.length:0,read=data&&data.read?data.read.length:0,archived=data&&data.archived?data.archived.length:0,countUnread=document.getElementById("notifications-count-unread"),countRead=document.getElementById("notifications-count-read"),countArchived=document.getElementById("notifications-count-archived");countUnread&&(countUnread.textContent=String(unread)),countRead&&(countRead.textContent=String(read)),countArchived&&(countArchived.textContent=String(archived))}function setActiveTab(tab){currentTab=tab;["unread","read","archived"].forEach(function(t){var btn=document.getElementById("notifications-tab-"+t);btn&&(btn.classList.toggle("active",t===tab),btn.setAttribute("aria-selected",t===tab?"true":"false"))}),renderListForTab()}function renderListForTab(){var items=listData&&listData.ok?"unread"===currentTab?listData.unread||[]:"read"===currentTab?listData.read||[]:listData.archived||[]:[],html="";items.forEach(function(n){html+=function(n,readFlag){var iconKey=getIconKeyForType(n.type),readAttr=readFlag?"1":"0",showArchive=!n.archived_at&&"archived"!==currentTab,html='<div class="list-group-item list-group-item-action notification-item" data-id="'+esc(n.id)+'" data-type="'+esc(n.type)+'" data-read="'+readAttr+'">';return html+='<a href="#" class="notification-item-main" data-notification-open="1" aria-label="Open notification">',html+='<span class="notification-type-icon bg-primary-lt text-primary"><i data-icon-key="'+esc(iconKey)+'" aria-hidden="true"></i></span>',html+='<span class="notification-item-content">',html+='<span class="notification-item-title">'+esc(n.title)+"</span>",html+='<span class="notification-item-time d-block">'+esc(formatTime(n.created_at))+"</span>",html+="</span>",html+="</a>",html+='<div class="notification-item-actions" aria-label="Quick actions">',showArchive&&(html+='<button type="button" class="notification-quick-btn notification-quick-btn--archive" data-notification-action="archive" aria-label="Archive"><i data-icon-key="notifications-action-archive" aria-hidden="true"></i></button>'),html+='<button type="button" class="notification-quick-btn notification-quick-btn--delete" data-notification-action="delete" aria-label="Delete permanently"><i data-icon-key="notifications-action-delete" aria-hidden="true"></i></button>',html+="</div>",html+"</div>"}(n,!("unread"===currentTab))}),listEl.innerHTML=html,listEmptyEl&&(listEmptyEl.textContent="unread"===currentTab?"No unread notifications.":"read"===currentTab?"No read notifications.":"No archived notifications.",listEmptyEl.classList.toggle("d-none",items.length>0))}function renderList(data){if(listData=data,!data||!data.ok)return listEmptyEl&&(listEmptyEl.textContent="Unable to load notifications."),listEl&&(listEl.innerHTML=""),void updateTabCounts({unread:0,read:0,archived:0});var unread=data.unread||[];data.read,data.archived;updateTabCounts(data),renderListForTab();var count=null!=data.unreadCount?data.unreadCount:unread.length;getBadgeEls().forEach(function(el){count>0?(el.textContent=count>99?"99+":String(count),el.classList.remove("is-hidden")):el.classList.add("is-hidden")})}function showListView(){listViewEl&&listViewEl.classList.remove("d-none"),listViewEl&&listViewEl.classList.add("d-flex"),detailViewEl&&detailViewEl.classList.add("d-none"),detailViewEl&&detailViewEl.classList.remove("d-flex")}function openDetail(id){var item=listEl.querySelector('.notification-item[data-id="'+CSS.escape(String(id))+'"]'),alreadyRead=item&&"1"===item.getAttribute("data-read");listViewEl&&listViewEl.classList.add("d-none"),listViewEl&&listViewEl.classList.remove("d-flex"),detailViewEl&&detailViewEl.classList.remove("d-none"),detailViewEl&&detailViewEl.classList.add("d-flex","flex-column"),detailBodyEl&&(detailBodyEl.innerHTML='<div class="text-muted">Loading…</div>'),detailActionsEl&&(detailActionsEl.innerHTML=""),function(id){var key=String(id);if(_notificationsDetailInFlight.has(key))return _notificationsDetailInFlight.get(key);var p=fetch(API+"/api/notifications/"+encodeURIComponent(String(id)),{credentials:"same-origin",cache:"no-store"}).then(function(r){return r&&r.ok?r.json():null}).catch(function(err){try{"function"==typeof window.kexoCaptureError&&window.kexoCaptureError(err,{context:"notifications.fetchDetail",id:key})}catch(_){}return null}).finally(function(){try{_notificationsDetailInFlight.delete(key)}catch(_){}});return _notificationsDetailInFlight.set(key,p),p}(id).then(function(res){if(res&&res.notification){var n=res.notification,bodyHtml='<div class="d-flex align-items-start gap-2 mb-2">';bodyHtml+='<span class="notification-type-icon bg-primary-lt text-primary flex-shrink-0"><i data-icon-key="'+esc(getIconKeyForType(n.type))+'" aria-hidden="true"></i></span>',bodyHtml+='<div class="flex-grow-1 min-w-0"><strong>'+esc(n.title)+"</strong></div></div>",bodyHtml+='<div class="small text-muted mb-2">'+esc(formatTime(n.created_at))+"</div>",n.body&&(bodyHtml+='<div class="notification-body">'+esc(n.body).replace(/\n/g,"<br>")+"</div>");var href=function(raw){try{if("function"==typeof window.kexoSafeHref)return window.kexoSafeHref(raw)}catch(_){}var s=null!=raw?String(raw).trim():"";if(!s)return"";if("#"===s[0])return s;if("/"===s[0]||s.startsWith("./")||s.startsWith("../")||"?"===s[0])return s;try{var u=new URL(s,window.location.origin),proto=u&&u.protocol?String(u.protocol).toLowerCase():"";if("http:"===proto||"https:"===proto||"mailto:"===proto||"tel:"===proto)return u.href}catch(_){}return""}(n.link);if(href&&(bodyHtml+='<p class="mt-3"><a href="'+esc(href)+'" class="btn">View</a></p>'),detailBodyEl&&(detailBodyEl.innerHTML=bodyHtml),detailActionsEl){var actionsHtml="";n.archived_at||(actionsHtml+='<button type="button" class="btn btn-light btn-sm" id="notifications-archive-btn" aria-label="Archive"><i class="me-1" data-icon-key="notifications-action-archive" aria-hidden="true"></i>Archive</button>'),actionsHtml+='<button type="button" class="btn btn-danger btn-sm" id="notifications-delete-btn" aria-label="Delete permanently"><i class="me-1" data-icon-key="notifications-action-delete" aria-hidden="true"></i>Delete</button>',detailActionsEl.innerHTML=actionsHtml;var archiveBtn=document.getElementById("notifications-archive-btn");archiveBtn&&archiveBtn.addEventListener("click",function(e){e.preventDefault(),archiveBtn.disabled=!0,patchNotification(id,{read:!0,archived:!0}).then(function(){fetchList().then(function(d){renderList(d),showListView()})})});var deleteBtn=document.getElementById("notifications-delete-btn");deleteBtn&&deleteBtn.addEventListener("click",function(e){e.preventDefault(),deleteBtn.disabled=!0,deleteNotification(id).then(function(){fetchList().then(function(d){renderList(d),showListView()})})})}alreadyRead||patchNotification(id,{read:!0}).then(function(){fetchList().then(function(d){listData=d,updateTabCounts(d&&d.ok?d:null)})})}else detailBodyEl&&(detailBodyEl.innerHTML='<div class="text-danger">Could not load notification.</div>')})}function updateBadge(data){if(data&&data.ok){var count=null!=data.unreadCount?data.unreadCount:(data.unread||[]).length;getBadgeEls().forEach(function(el){count>0?(el.textContent=count>99?"99+":String(count),el.classList.remove("is-hidden")):el.classList.add("is-hidden")})}}function tickBadge(){"visible"===document.visibilityState&&fetchList().then(updateBadge)}function startBadgePoll(){null==badgeIntervalId&&(badgeIntervalId=setInterval(tickBadge,6e4))}function stopBadgePoll(){null!=badgeIntervalId&&(clearInterval(badgeIntervalId),badgeIntervalId=null)}}(),
/**
 * Load kexo-tooltips.js app-wide (when not already loaded, e.g. on Settings)
 * and init tooltips + help popovers on document.body.
 */
function(){"use strict";function run(){if("function"!=typeof window.initKexoTooltips||"function"!=typeof window.initKexoHelpPopovers){var script=document.createElement("script");script.src="/kexo-tooltips.js",script.async=!1,script.onload=function(){try{"function"==typeof window.initKexoTooltips&&window.initKexoTooltips(document.body),"function"==typeof window.initKexoHelpPopovers&&window.initKexoHelpPopovers(document.body)}catch(_){}},document.head.appendChild(script)}else try{window.initKexoTooltips(document.body),window.initKexoHelpPopovers(document.body)}catch(_){}}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",run):run()}()}();
