// @generated from client/app - do not edit. Run: npm run build:app
// checksum: 0e9c3c009e8dbd38

(function () {
  // Shared formatters and fetch – single source for client/app bundle (same IIFE scope).
  function formatMoney(amount, currencyCode) {
    if (amount == null || typeof amount !== 'number') return '';
    var code = (currencyCode || 'GBP').toUpperCase();
    var sym = code === 'GBP' ? '\u00A3' : code === 'USD' ? '$' : code === 'EUR' ? '\u20AC' : code + ' ';
    return sym + (amount % 1 === 0 ? amount : amount.toFixed(2));
  }

  function formatCompactNumber(amount) {
    var raw = typeof amount === 'number' ? amount : Number(amount);
    var n = Number.isFinite(raw) ? Math.abs(raw) : 0;
    if (n < 1000) return String(Math.round(n));
    if (n >= 1e9) {
      var v = n / 1e9;
      var dec = v < 100 ? 1 : 0;
      return v.toFixed(dec).replace(/\.0$/, '') + 'b';
    }
    if (n >= 1e6) {
      var v = n / 1e6;
      var dec = v < 100 ? 1 : 0;
      return v.toFixed(dec).replace(/\.0$/, '') + 'm';
    }
    var v = n / 1e3;
    var dec = v < 100 ? 1 : 0;
    return v.toFixed(dec).replace(/\.0$/, '') + 'k';
  }

  function formatMoneyCompact(amount, currencyCode) {
    if (amount == null || typeof amount !== 'number') return '';
    var code = (currencyCode || 'GBP').toUpperCase();
    var sym = code === 'GBP' ? '\u00A3' : code === 'USD' ? '$' : code === 'EUR' ? '\u20AC' : code + ' ';
    var n = Number.isFinite(amount) ? amount : 0;
    var sign = n < 0 ? '-' : '';
    return sign + sym + formatCompactNumber(n);
  }

  function fmtPct(n) {
    if (n == null || !Number.isFinite(n)) return '\u2014';
    return n.toFixed(1) + '%';
  }

  function fmtMoneyGbp(n) {
    var x = (typeof n === 'number') ? n : Number(n);
    if (!Number.isFinite(x)) return '\u2014';
    try { return '\u00A3' + x.toLocaleString('en-GB', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); } catch (_) { return '\u00A3' + x.toFixed(2); }
  }

  function fetchJson(url, opts) {
    var options = Object.assign({ credentials: 'same-origin', cache: 'no-store' }, opts || {});
    return fetch(url, options).then(function(r) { return r.json(); });
  }

  function normalizePaymentProviderKey(v) {
    if (v == null) return null;
    var s = String(v).trim().toLowerCase();
    if (!s) return null;
    if (s === 'null' || s === 'undefined' || s === 'true' || s === 'false' || s === '[object object]') return null;
    s = s.replace(/[^a-z0-9_-]+/g, '-').replace(/-+/g, '-').replace(/^-|-$/g, '');
    if (!s) return null;
    if (s === 'american-express') s = 'americanexpress';
    if (s === 'amex') s = 'americanexpress';
    if (s === 'apple-pay') s = 'applepay';
    if (s === 'shop-pay') s = 'shop-pay';
    if (s === 'shopify-payments' || s === 'shopifypayments') s = 'shopify-payments';
    return s.length > 64 ? s.slice(0, 64) : s;
  }

  function paymentProviderMeta(key) {
    var k = normalizePaymentProviderKey(key);
    if (!k) return null;
    var map = {
      visa: { label: 'Visa', tablerKey: 'visa' },
      mastercard: { label: 'Mastercard', tablerKey: 'mastercard' },
      americanexpress: { label: 'American Express', tablerKey: 'americanexpress' },
      paypal: { label: 'PayPal', tablerKey: 'paypal' },
      applepay: { label: 'Apple Pay', tablerKey: 'applepay' },
      'google-pay': { label: 'Google Pay', tablerKey: 'google-pay' },
      klarna: { label: 'Klarna', tablerKey: 'klarna' },
      'shop-pay': { label: 'Shop Pay', tablerKey: 'shop-pay' },
      'shopify-payments': { label: 'Shopify Payments', tablerKey: 'shop-pay' },
    };
    return map[k] || { label: k, tablerKey: null };
  }

  function tablerPaymentClassName(providerKey) {
    var meta = paymentProviderMeta(providerKey);
    if (!meta || !meta.tablerKey) return '';
    return 'payment payment-provider-' + meta.tablerKey;
  }
const API = '';
    const PAGE = (document.body && document.body.getAttribute('data-page')) || '';
    try { if (typeof window.kexoSetContext === 'function') window.kexoSetContext(PAGE || 'unknown', { page: PAGE || 'unknown' }); } catch (_) {}
    try { if (typeof window.kexoBreadcrumb === 'function') window.kexoBreadcrumb('app', 'init', { page: PAGE }); } catch (_) {}
    function captureChartError(err, context, extra) {
      try {
        if (typeof window.kexoCaptureError !== 'function') return;
        var payload = {
          context: context || 'chart',
          page: PAGE || 'unknown'
        };
        if (extra && typeof extra === 'object') {
          Object.keys(extra).forEach(function (k) { payload[k] = extra[k]; });
        }
        window.kexoCaptureError(err, payload);
      } catch (_) {}
    }
    function captureChartMessage(message, context, extra, level) {
      try {
        if (typeof window.kexoCaptureMessage !== 'function') return;
        var payload = {
          context: context || 'chart',
          page: PAGE || 'unknown'
        };
        if (extra && typeof extra === 'object') {
          Object.keys(extra).forEach(function (k) { payload[k] = extra[k]; });
        }
        window.kexoCaptureMessage(String(message || ''), payload, level || 'error');
      } catch (_) {}
    }
    const PAGE_LOADER_ENABLED_LS_KEY = 'kexo:page-loader-enabled:v1';

    function defaultPageLoaderEnabledV1() {
      return {
        v: 1,
        pages: {
          dashboard: true,
          live: true,
          sales: true,
          date: true,
          // Snapshot uses its own in-card loaders and never calls report-build finish().
          snapshot: false,
          countries: true,
          products: true,
          variants: true,
          'abandoned-carts': true,
          attribution: true,
          devices: true,
          ads: true,
          'compare-conversion-rate': true,
          'shipping-cr': true,
          'click-order-lookup': true,
          'change-pins': true,
          // Settings must never show the page overlay loader.
          settings: false,
          // Upgrade page is a static marketing/TODO page; never show the overlay loader there.
          upgrade: false,
          // Admin must never show the overlay loader.
          admin: false,
        },
      };
    }

    function normalizePageLoaderEnabledV1(cfg) {
      const base = defaultPageLoaderEnabledV1();
      const out = { v: 1, pages: Object.assign({}, base.pages) };
      if (!cfg || typeof cfg !== 'object') return out;
      if (Number(cfg.v) !== 1) return out;
      const pages = cfg.pages && typeof cfg.pages === 'object' ? cfg.pages : null;
      if (!pages) return out;
      Object.keys(out.pages).forEach(function (key) {
        if (!Object.prototype.hasOwnProperty.call(pages, key)) return;
        out.pages[key] = pages[key] === false ? false : true;
      });
      // Backwards compatibility: legacy Traffic pages.
      if (typeof out.pages.attribution !== 'boolean' && typeof pages.channels === 'boolean') out.pages.attribution = pages.channels !== false;
      if (typeof out.pages.devices !== 'boolean' && typeof pages.type === 'boolean') out.pages.devices = pages.type !== false;
      out.pages.settings = false;
      out.pages.admin = false;
      out.pages.snapshot = false;
      return out;
    }

    var pageLoaderEnabledV1 = null;
    try {
      var cachedLoaderCfg = safeReadLocalStorageJson(PAGE_LOADER_ENABLED_LS_KEY);
      if (cachedLoaderCfg && cachedLoaderCfg.v === 1) {
        pageLoaderEnabledV1 = normalizePageLoaderEnabledV1(cachedLoaderCfg);
      }
    } catch (_) {}
    if (!pageLoaderEnabledV1) pageLoaderEnabledV1 = defaultPageLoaderEnabledV1();

    function applyPageLoaderEnabledV1(cfg) {
      pageLoaderEnabledV1 = normalizePageLoaderEnabledV1(cfg);
      try { window.__kexoPageLoaderEnabledV1 = pageLoaderEnabledV1; } catch (_) {}
      try { safeWriteLocalStorageJson(PAGE_LOADER_ENABLED_LS_KEY, pageLoaderEnabledV1); } catch (_) {}
      return pageLoaderEnabledV1;
    }

    function isPageLoaderEnabled(pageKey) {
      var k = String(pageKey == null ? '' : pageKey).trim().toLowerCase();
      if (!k) k = String(PAGE || '').trim().toLowerCase();
      if (!k) return true;
      if (k === 'settings') return false;
      if (k === 'admin') return false;
      if (k === 'snapshot') return false;
      var cfg = pageLoaderEnabledV1;
      var pages = cfg && cfg.pages && typeof cfg.pages === 'object' ? cfg.pages : null;
      if (!pages) return true;
      if (!Object.prototype.hasOwnProperty.call(pages, k)) return true;
      return pages[k] !== false;
    }

    try { window.__kexoIsPageLoaderEnabled = isPageLoaderEnabled; } catch (_) {}
    try { window.__kexoApplyPageLoaderEnabledV1 = applyPageLoaderEnabledV1; } catch (_) {}

    var _silentOverlayDepth = 0;
    function kexoWithSilentOverlay(fn) {
      _silentOverlayDepth = Math.max(0, Number(_silentOverlayDepth || 0)) + 1;
      try { return fn(); }
      finally { _silentOverlayDepth = Math.max(0, Number(_silentOverlayDepth || 0) - 1); }
    }
    function kexoSilentOverlayActive() {
      return Number(_silentOverlayDepth || 0) > 0;
    }
    try { window.__kexoWithSilentOverlay = kexoWithSilentOverlay; } catch (_) {}
    try { window.__kexoSilentOverlayActive = kexoSilentOverlayActive; } catch (_) {}

    // Change Pins (timeline annotations) — cached for dashboard chart overlays.
    var _changePinsCache = null;
    var _changePinsFetchedAt = 0;
    var _changePinsInFlight = null;
    var CHANGE_PINS_CACHE_TTL_MS = 60 * 1000;

    function fetchChangePinsRecent(days) {
      var d = (typeof days === 'number' && isFinite(days)) ? Math.max(7, Math.min(400, Math.floor(days))) : 120;
      var url = API + '/api/tools/change-pins/recent?days=' + encodeURIComponent(String(d));
      return fetch(url, { credentials: 'same-origin', cache: 'no-store' })
        .then(function (r) { return (r && r.ok) ? r.json().catch(function () { return null; }) : null; })
        .then(function (json) {
          var pins = json && json.ok && Array.isArray(json.pins) ? json.pins : null;
          if (!pins) return null;
          _changePinsCache = pins;
          _changePinsFetchedAt = Date.now();
          return pins;
        })
        .catch(function (err) {
          try { if (typeof window.kexoCaptureError === 'function') window.kexoCaptureError(err, { context: 'changePins.fetch' }); } catch (_) {}
          return null;
        });
    }

    function getChangePinsRecent(days, force) {
      var fresh = _changePinsCache && _changePinsFetchedAt && (Date.now() - _changePinsFetchedAt) < CHANGE_PINS_CACHE_TTL_MS;
      if (!force && fresh) return Promise.resolve(_changePinsCache);
      if (_changePinsInFlight) return _changePinsInFlight;
      _changePinsInFlight = fetchChangePinsRecent(days).finally(function () { _changePinsInFlight = null; });
      return _changePinsInFlight;
    }

    try { window.__kexoGetChangePinsRecent = getChangePinsRecent; } catch (_) {}
    try { window.__kexoReadChangePinsRecentCache = function () { return _changePinsCache; }; } catch (_) {}

    // ?????? Admin preview mode (UI-only) ????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
    // Preview is an admin tool: it affects client UI gating only and cannot bypass server auth.
    const PREVIEW_LS_KEY = 'kexo:preview:v1';
    function normalizePreviewTier(raw) {
      var t = raw == null ? '' : String(raw).trim().toLowerCase();
      if (!t) return '';
      var allowed = new Set(['starter', 'growth', 'scale', 'max', 'admin']);
      return allowed.has(t) ? t : '';
    }
    function previewTierLabel(tier) {
      var t = normalizePreviewTier(tier);
      if (t === 'starter') return 'Starter';
      if (t === 'growth') return 'Growth';
      if (t === 'scale') return 'Scale';
      if (t === 'max') return 'Max';
      if (t === 'admin') return 'Admin';
      return '';
    }
    function readPreviewConfig() {
      try {
        var raw = localStorage.getItem(PREVIEW_LS_KEY);
        if (!raw) return null;
        var parsed = JSON.parse(raw);
        if (!parsed || typeof parsed !== 'object') return null;
        if (Number(parsed.v) !== 1) return null;
        if (parsed.enabled !== true) return null;
        var tier = normalizePreviewTier(parsed.tier);
        if (!tier) return null;
        return { v: 1, enabled: true, tier: tier };
      } catch (_) {
        return null;
      }
    }
    function writePreviewConfig(tierOrOff) {
      var tier = normalizePreviewTier(tierOrOff);
      if (!tier) {
        try { localStorage.removeItem(PREVIEW_LS_KEY); } catch (_) {}
        return '';
      }
      try { localStorage.setItem(PREVIEW_LS_KEY, JSON.stringify({ v: 1, enabled: true, tier: tier })); } catch (_) {}
      return tier;
    }
    function clearPreviewConfig() {
      try { localStorage.removeItem(PREVIEW_LS_KEY); } catch (_) {}
    }
    function isAdminLikeRole(raw) {
      var r = raw == null ? '' : String(raw).trim().toLowerCase();
      // Backwards-compatible while Master???Admin migration rolls out.
      return r === 'admin' || r === 'master';
    }
    function isRealAdminViewer(me) {
      if (!me || typeof me !== 'object') return false;
      if (me.isMaster === true) return true;
      return isAdminLikeRole(me.role);
    }
    function getEffectiveViewer(realMe) {
      var me = (realMe && typeof realMe === 'object') ? realMe : (window.__kexoMe && typeof window.__kexoMe === 'object' ? window.__kexoMe : null);
      var realIsAdmin = isRealAdminViewer(me);
      var previewStored = readPreviewConfig();
      var preview = null;
      if (realIsAdmin) preview = previewStored;
      else if (me && previewStored) {
        // Safety: preview should not leak into normal user sessions.
        clearPreviewConfig();
      }
      var previewTier = preview && preview.tier ? String(preview.tier) : '';
      var previewEnabled = !!previewTier;
      var effectiveIsAdmin = realIsAdmin;
      if (previewEnabled) effectiveIsAdmin = previewTier === 'admin';
      var tier = previewEnabled
        ? previewTier
        : (me && me.tier != null ? String(me.tier).trim().toLowerCase() : '');
      return {
        email: me && me.email ? String(me.email) : null,
        role: effectiveIsAdmin ? 'admin' : 'user',
        tier: tier || null,
        isAdmin: effectiveIsAdmin,
        // Keep legacy name for existing code paths.
        isMaster: effectiveIsAdmin,
        preview: { enabled: previewEnabled, tier: previewTier || '' },
        real: {
          role: me && me.role != null ? String(me.role) : null,
          tier: me && me.tier != null ? String(me.tier) : null,
          isAdmin: realIsAdmin,
        },
      };
    }
    function applyAdminOnlyVisibility(isAdmin) {
      try {
        var els = document.querySelectorAll ? document.querySelectorAll('.kexo-admin-only') : [];
        if (!els || !els.length) return;
        els.forEach(function (el) {
          if (!el || !el.classList) return;
          if (isAdmin) el.classList.remove('d-none');
          else el.classList.add('d-none');
        });
      } catch (_) {}
    }
    function ensurePreviewExitMenuItem(viewer) {
      var menu = document.getElementById('navbar-settings-menu');
      if (!menu) return;
      var btn = menu.querySelector('[data-kexo-preview-exit="1"]');
      var div = menu.querySelector('[data-kexo-preview-divider="1"]');
      if (!btn) {
        btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'dropdown-item kexo-top-strip-settings-item';
        btn.setAttribute('data-kexo-preview-exit', '1');
        btn.innerHTML = '<i class="fa-jelly fa-eye kexo-top-strip-settings-item-icon" aria-hidden="true"></i><span data-kexo-preview-exit-label>Preview</span>';
        btn.addEventListener('click', function () {
          try { clearPreviewConfig(); } catch (_) {}
          try { window.location.reload(); } catch (_) {}
        });
        menu.insertBefore(btn, menu.firstChild);
      }
      if (!div) {
        div = document.createElement('div');
        div.className = 'dropdown-divider';
        div.setAttribute('data-kexo-preview-divider', '1');
        if (btn.nextSibling) menu.insertBefore(div, btn.nextSibling);
        else menu.appendChild(div);
      }

      var enabled = !!(viewer && viewer.preview && viewer.preview.enabled);
      if (!enabled) {
        btn.style.display = 'none';
        div.style.display = 'none';
        return;
      }
      var label = previewTierLabel(viewer.preview.tier) || 'Preview';
      var text = 'Preview: ' + label + ' (Exit)';
      var span = btn.querySelector('[data-kexo-preview-exit-label]');
      if (span) span.textContent = text;
      else btn.textContent = text;
      btn.style.display = '';
      div.style.display = '';
    }
    var _effectiveViewerCache = null;
    function applyEffectiveViewer() {
      var v = getEffectiveViewer(window.__kexoMe);
      _effectiveViewerCache = v;
      try { window.__kexoEffectiveViewer = v; } catch (_) {}
      try { window.__kexoEffectiveIsAdmin = !!v.isAdmin; } catch (_) {}
      try { applyAdminOnlyVisibility(!!v.isAdmin); } catch (_) {}
      try { ensurePreviewExitMenuItem(v); } catch (_) {}
      try { window.dispatchEvent(new CustomEvent('kexo:viewer-changed', { detail: v })); } catch (_) {}
      return v;
    }
    try { window.__kexoGetEffectiveViewer = function() { return getEffectiveViewer(window.__kexoMe); }; } catch (_) {}
    try { window.__kexoApplyEffectiveViewer = applyEffectiveViewer; } catch (_) {}
    try {
      window.__kexoSetPreviewTier = function(tierOrOff) {
        writePreviewConfig(tierOrOff);
        applyEffectiveViewer();
      };
    } catch (_) {}

    const TABLE_CLASS_CONFIG = Object.freeze({
      dashboard: Object.freeze({ defaultRows: 5, rowOptions: Object.freeze([5, 10]) }),
      product: Object.freeze({ defaultRows: 10, rowOptions: Object.freeze([10, 15, 20]) }),
      live: Object.freeze({ defaultRows: 20, rowOptions: Object.freeze([20, 30, 40, 50]) }),
    });
    const TABLE_ROWS_STORAGE_PREFIX = 'kexo:table-rows:v1';
    const TABLE_CLASS_FALLBACK_BY_ID = Object.freeze({
      'sessions-table': 'live',
      'dash-top-products': 'dashboard',
      'dash-top-countries': 'dashboard',
      'dash-trending': 'dashboard',
      'best-sellers-table': 'product',
      'best-variants-table': 'product',
      'type-necklaces-table': 'product',
      'type-bracelets-table': 'product',
      'type-earrings-table': 'product',
      'type-sets-table': 'product',
      'type-charms-table': 'product',
      'type-extras-table': 'product',
      'country-table': 'live',
      'best-geo-products-table': 'live',
      'ads-root': 'live',
    });

    var _kexoCleanupFns = [];
    function registerCleanup(fn) {
      if (typeof fn === 'function') _kexoCleanupFns.push(fn);
    }
    function runCleanup() {
      _kexoCleanupFns.forEach(function(f) { try { f(); } catch (_) {} });
      // Do not clear _kexoCleanupFns so bfcache restore can re-init and next pagehide still cleans up
    }
    try {
      window.addEventListener('beforeunload', runCleanup);
      window.addEventListener('pagehide', runCleanup);
    } catch (_) {}

    (function initKexoTableMounts() {
      function run() {
        var mounts = document.querySelectorAll('[data-kexo-table]');
        if (!mounts.length) return;
        var build = typeof window.buildKexoGridTable === 'function' ? window.buildKexoGridTable : null;
        var buildNative = typeof window.buildKexoNativeTable === 'function' ? window.buildKexoNativeTable : null;
        var defs = window.KEXO_TABLE_DEFS;
        var nativeDefs = window.KEXO_NATIVE_TABLE_DEFS;
        if (!build && !buildNative) return;
        mounts.forEach(function (mount) {
          var tableId = mount.getAttribute('data-kexo-table');
          if (!tableId) return;
          var def = defs && defs[tableId];
          var nativeDef = nativeDefs && nativeDefs[tableId];
          if (def && build) {
            // Live View: hide Exit column only on /dashboard/live.
            var cols = Array.isArray(def.columns) ? def.columns.slice() : [];
            try {
              if (String(PAGE || '').trim().toLowerCase() === 'live' && String(tableId || '').trim().toLowerCase() === 'sessions-table') {
                cols = cols.filter(function (c) {
                  var k = c && c.key != null ? String(c.key).trim().toLowerCase() : '';
                  return k !== 'exit';
                });
              }
            } catch (_) {}
            var config = Object.assign({}, def, {
              tableId: tableId,
              wrapId: (mount.id || tableId + '-mount') + '-wrap',
              bodyId: def.bodyId || tableId + '-body',
              columns: cols
            });
            mount.outerHTML = build(config);
          } else if (nativeDef && buildNative) {
            var dashTopListIds = ['dash-top-products', 'dash-top-countries', 'dash-trending'];
            if (dashTopListIds.indexOf(tableId) >= 0) {
              var wrapId = tableId + '-wrap';
              var bodyId = tableId + '-body';
              mount.outerHTML = '<div id="' + wrapId + '"><div id="' + bodyId + '" class="kexo-dash-top-list" role="list" aria-label="' + (tableId.replace(/-/g, ' ') + ' list') + '"></div></div>';
            } else {
              var nativeConfig = Object.assign({}, nativeDef, { tableId: tableId });
              mount.outerHTML = buildNative(nativeConfig);
            }
          }
        });
      }
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', run);
      } else {
        run();
      }
    })();

    const tableRowsCache = {};
    const TABLES_UI_CFG_LS_KEY = 'kexo:tables-ui-config:v1';
    var tablesUiConfigV1 = null;

    // Hydrate table layout/pagination prefs from localStorage for first paint.
    try {
      var cachedTables = safeReadLocalStorageJson(TABLES_UI_CFG_LS_KEY);
      if (cachedTables && cachedTables.v === 1 && Array.isArray(cachedTables.pages)) {
        tablesUiConfigV1 = cachedTables;
        try { window.__kexoTablesUiConfigV1 = cachedTables; } catch (_) {}
      }
    } catch (_) {}

    function normalizeUiPageKey(key) {
      var k = String(key == null ? '' : key).trim().toLowerCase();
      return k || '';
    }

    function normalizeUiTableId(id) {
      return String(id == null ? '' : id).trim().toLowerCase();
    }

    function getTablesUiPageCfg(pageKey) {
      var cfg = tablesUiConfigV1;
      if (!cfg || cfg.v !== 1 || !Array.isArray(cfg.pages)) return null;
      var pk = normalizeUiPageKey(pageKey || PAGE);
      if (!pk) return null;
      for (var i = 0; i < cfg.pages.length; i++) {
        var p = cfg.pages[i];
        if (!p || typeof p !== 'object') continue;
        var k = p.key != null ? normalizeUiPageKey(p.key) : '';
        if (k && k === pk) return p;
      }
      return null;
    }

    function resolveVariantsTableId(tableId, pageKey) {
      var id = String(tableId == null ? '' : tableId).trim().toLowerCase();
      var pk = normalizeUiPageKey(pageKey || PAGE);
      if (id.indexOf('variants-table-') === 0 && pk === 'variants') return 'insights-variants-tables';
      return id;
    }
    function getTablesUiTableCfg(tableId, pageKey) {
      var p = getTablesUiPageCfg(pageKey || PAGE);
      if (!p || !Array.isArray(p.tables)) return null;
      var id = normalizeUiTableId(resolveVariantsTableId(tableId, pageKey));
      if (!id) return null;
      for (var i = 0; i < p.tables.length; i++) {
        var t = p.tables[i];
        if (!t || typeof t !== 'object') continue;
        var tid = t.id != null ? normalizeUiTableId(t.id) : '';
        if (tid && tid === id) return t;
      }
      return null;
    }

    function tablesUiConfigSignature(cfg) {
      try { return JSON.stringify(cfg || null); } catch (_) { return ''; }
    }

    function applyTablesUiConfigV1(cfg) {
      if (!cfg || typeof cfg !== 'object' || cfg.v !== 1 || !Array.isArray(cfg.pages)) return false;
      var prevSig = tablesUiConfigSignature(tablesUiConfigV1);
      var nextSig = tablesUiConfigSignature(cfg);
      tablesUiConfigV1 = cfg;
      try { window.__kexoTablesUiConfigV1 = cfg; } catch (_) {}
      try { safeWriteLocalStorageJson(TABLES_UI_CFG_LS_KEY, cfg); } catch (_) {}
      try {
        Object.keys(tableRowsCache).forEach(function (k) { delete tableRowsCache[k]; });
      } catch (_) {}
      var changed = prevSig !== nextSig;
      if (changed) {
        try { syncDashboardTableRowsOverridesFromUiConfig(cfg); } catch (_) {}
      }
      return changed;
    }

    function syncDashboardTableRowsOverridesFromUiConfig(cfg) {
      // Dashboard tables are frequently configured in Settings/Modals, but a stale per-table localStorage
      // override can take precedence and make "Default rows" appear ignored. When the UI config changes,
      // sync dashboard table row overrides to the configured defaults so the saved setting wins.
      if (!cfg || cfg.v !== 1 || !Array.isArray(cfg.pages)) return;
      var dashPage = null;
      for (var i = 0; i < cfg.pages.length; i++) {
        var p = cfg.pages[i];
        if (!p || typeof p !== 'object') continue;
        if (normalizeUiPageKey(p.key) === 'dashboard') { dashPage = p; break; }
      }
      if (!dashPage || !Array.isArray(dashPage.tables)) return;

      dashPage.tables.forEach(function (t) {
        if (!t || typeof t !== 'object') return;
        var tableId = t.id != null ? normalizeUiTableId(t.id) : '';
        if (!tableId) return;
        var classKey = getTableClassByTableId(tableId, 'dashboard');
        if (classKey !== 'dashboard') return;
        if (!t.rows || typeof t.rows !== 'object') return;

        var defaultRows = t.rows.default;
        if (typeof defaultRows !== 'number' || !Number.isFinite(defaultRows)) return;
        defaultRows = Math.round(defaultRows);
        if (defaultRows <= 0 || defaultRows > 200) return;

        var rowOptions = null;
        var opts = Array.isArray(t.rows.options) ? t.rows.options : null;
        if (opts && opts.length) {
          var seen = {};
          var normalized = [];
          opts.forEach(function (n) {
            var x = Math.round(Number(n));
            if (!Number.isFinite(x) || x <= 0 || x > 200) return;
            if (seen[x]) return;
            seen[x] = true;
            normalized.push(x);
          });
          normalized.sort(function (a, b) { return a - b; });
          if (normalized.length) rowOptions = normalized.slice(0, 12);
        }
        if (!rowOptions || !rowOptions.length) {
          var fallback = tableClassConfig('dashboard');
          rowOptions = Array.isArray(fallback && fallback.rowOptions) ? fallback.rowOptions.slice() : [5, 10];
        }
        if (rowOptions.indexOf(defaultRows) < 0) {
          var nearest = rowOptions[0];
          var nearestDiff = Math.abs(nearest - defaultRows);
          for (var j = 1; j < rowOptions.length; j++) {
            var diff = Math.abs(rowOptions[j] - defaultRows);
            if (diff < nearestDiff) {
              nearest = rowOptions[j];
              nearestDiff = diff;
            }
          }
          defaultRows = nearest;
        }

        tableRowsCache[tableId] = defaultRows;
        try { localStorage.setItem(tableRowsStorageKey(tableId), String(defaultRows)); } catch (_) {}
      });
    }

    function tableRowsConfigForTableId(tableId, classKey) {
      var cfg = tableClassConfig(classKey);
      var defaultRows = cfg && typeof cfg.defaultRows === 'number' ? cfg.defaultRows : 20;
      var rowOptions = Array.isArray(cfg && cfg.rowOptions) ? cfg.rowOptions.slice() : [defaultRows];

      var ui = getTablesUiTableCfg(tableId, PAGE);
      if (ui && ui.rows && typeof ui.rows === 'object') {
        var opts = Array.isArray(ui.rows.options) ? ui.rows.options : null;
        if (opts && opts.length) {
          var seen = {};
          var normalized = [];
          opts.forEach(function (n) {
            var x = Math.round(Number(n));
            if (!Number.isFinite(x) || x <= 0 || x > 200) return;
            if (seen[x]) return;
            seen[x] = true;
            normalized.push(x);
          });
          normalized.sort(function (a, b) { return a - b; });
          if (normalized.length) rowOptions = normalized.slice(0, 12);
        }
        var dr = ui.rows.default;
        if (typeof dr === 'number' && Number.isFinite(dr)) defaultRows = Math.round(dr);
      }

      if (!rowOptions.length) rowOptions = [defaultRows];
      if (rowOptions.indexOf(defaultRows) < 0) {
        // Pick nearest allowed option for robustness.
        var nearest = rowOptions[0];
        var nearestDiff = Math.abs(nearest - defaultRows);
        for (var i = 1; i < rowOptions.length; i++) {
          var d = Math.abs(rowOptions[i] - defaultRows);
          if (d < nearestDiff) {
            nearest = rowOptions[i];
            nearestDiff = d;
          }
        }
        defaultRows = nearest;
      }

      return { defaultRows: defaultRows, rowOptions: rowOptions };
    }

    function syncPageBodyLoaderOffset(scope) {
      try {
        if (!scope || !scope.classList || !scope.classList.contains('page-body')) return;
        var rect = scope.getBoundingClientRect ? scope.getBoundingClientRect() : null;
        var top = rect && Number.isFinite(rect.top) ? Math.max(0, Math.round(rect.top)) : 0;
        scope.style.setProperty('--kexo-loader-page-top', String(top) + 'px');
      } catch (_) {}
    }

    (function primePageBodyLoader() {
      // Default behavior: keep content visible and avoid global overlay on initial load.
      var pageBody = document.querySelector('.page-body');
      var overlay = document.getElementById('page-body-loader');
      if (!pageBody || !overlay) return;
      syncPageBodyLoaderOffset(pageBody);
      pageBody.classList.remove('report-building');
      overlay.classList.add('is-hidden');
    })();

    function normalizeTableClass(classKey) {
      var key = String(classKey == null ? '' : classKey).trim().toLowerCase();
      if (key && TABLE_CLASS_CONFIG[key]) return key;
      return 'live';
    }

    function tableClassConfig(classKey) {
      return TABLE_CLASS_CONFIG[normalizeTableClass(classKey)] || TABLE_CLASS_CONFIG.live;
    }

    function clampTableRows(value, tableId, classKey) {
      var cfg = tableRowsConfigForTableId(tableId, classKey);
      var opts = Array.isArray(cfg && cfg.rowOptions) ? cfg.rowOptions : [cfg.defaultRows];
      var n = Number(value);
      if (!Number.isFinite(n)) return cfg.defaultRows;
      n = Math.round(n);
      if (opts.indexOf(n) >= 0) return n;
      // Pick nearest allowed option for robustness against stale values.
      var nearest = opts[0];
      var nearestDiff = Math.abs(nearest - n);
      for (var i = 1; i < opts.length; i++) {
        var d = Math.abs(opts[i] - n);
        if (d < nearestDiff) {
          nearest = opts[i];
          nearestDiff = d;
        }
      }
      return nearest;
    }

    function inferTableIdFromCard(card) {
      if (!card || !card.querySelector) return '';
      if (card.dataset && card.dataset.tableId) return String(card.dataset.tableId).trim();
      var el = card.querySelector('table[id], .grid-table[id], [id="ads-root"]');
      return el && el.id ? String(el.id).trim() : '';
    }

    function findTableCardById(tableId) {
      var id = String(tableId == null ? '' : tableId).trim();
      if (!id || !document || !document.querySelector) return null;
      var byCardAttr = document.querySelector('.card[data-table-id="' + id + '"]');
      if (byCardAttr) return byCardAttr;
      var tableEl = document.getElementById(id);
      if (!tableEl || !tableEl.closest) return null;
      return tableEl.closest('.card');
    }

    function applyTablesUiLayoutForPage() {
      try {
        if (String(PAGE || '').toLowerCase() === 'settings') return;
        var pageCfg = getTablesUiPageCfg(PAGE);
        if (!pageCfg || !Array.isArray(pageCfg.tables)) return;

        // Titles (opt-in via data attr to avoid clobbering dynamic headers).
        pageCfg.tables.forEach(function (t) {
          if (!t || typeof t !== 'object') return;
          var tableId = t.id != null ? String(t.id).trim() : '';
          if (!tableId) return;
          var name = t.name != null ? String(t.name).trim() : '';
          if (!name) return;
          var card = findTableCardById(tableId);
          if (!card || !card.querySelector) return;
          var titleEl = card.querySelector('[data-kexo-table-title="1"]');
          if (!titleEl) return;
          titleEl.textContent = name;
        });

        function isBootstrapCol(el) {
          if (!el || !el.classList) return false;
          for (var i = 0; i < el.classList.length; i++) {
            var c = el.classList[i];
            if (c === 'col' || String(c).indexOf('col-') === 0) return true;
          }
          return false;
        }

        function setColWrapperFullWidth(colEl, full) {
          if (!colEl) return;
          var orig = colEl.getAttribute('data-kexo-orig-col-class');
          if (!orig) {
            try { colEl.setAttribute('data-kexo-orig-col-class', colEl.className || ''); } catch (_) {}
            orig = colEl.className || '';
          }
          if (!full) {
            colEl.className = orig;
            return;
          }
          var keep = [];
          String(orig || '').split(/\s+/g).filter(Boolean).forEach(function (cls) {
            if (cls === 'col' || String(cls).indexOf('col-') === 0) return;
            keep.push(cls);
          });
          keep.push('col-12');
          colEl.className = keep.join(' ');
        }

        // Per group (row/stats-row): order + grid/full width
        var groups = new Map();
        pageCfg.tables.forEach(function (t) {
          if (!t || typeof t !== 'object') return;
          var tableId = t.id != null ? String(t.id).trim() : '';
          if (!tableId) return;
          var card = findTableCardById(tableId);
          if (!card || !card.closest) return;

          var group = card.closest('.stats-row, .row');
          if (!group) return;

          var unit = card;
          try {
            if (group.classList && group.classList.contains('row') && card.parentElement && isBootstrapCol(card.parentElement) && card.parentElement.parentElement === group) {
              unit = card.parentElement;
            }
          } catch (_) {}

          var inGrid = !(t.inGrid === false);
          if (unit !== card) {
            // Bootstrap column wrapper
            setColWrapperFullWidth(unit, !inGrid);
          } else {
            // Flex/grid card
            card.classList.toggle('kexo-layout-full', !inGrid);
          }

          var list = groups.get(group) || [];
          list.push({ order: Number(t.order) || 0, unit: unit });
          groups.set(group, list);
        });

        groups.forEach(function (list, group) {
          if (!group || !Array.isArray(list) || list.length < 2) return;
          list.sort(function (a, b) { return (a.order || 0) - (b.order || 0); });
          list.forEach(function (it) {
            if (!it || !it.unit || !it.unit.parentElement) return;
            try { group.appendChild(it.unit); } catch (_) {}
          });
        });
      } catch (_) {}
    }

    (function primeTablesUiLayout() {
      try {
        if (!tablesUiConfigV1) return;
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', function() {
            try { scheduleTablesUiApply(); } catch (_) {}
          });
        } else {
          scheduleTablesUiApply();
        }
      } catch (_) {}
    })();

    function getTableClassByTableId(tableId, fallbackClassKey) {
      var id = String(tableId == null ? '' : tableId).trim();
      var card = findTableCardById(id);
      if (card && card.dataset && card.dataset.tableClass) return normalizeTableClass(card.dataset.tableClass);
      if (id && TABLE_CLASS_FALLBACK_BY_ID[id]) return normalizeTableClass(TABLE_CLASS_FALLBACK_BY_ID[id]);
      return normalizeTableClass(fallbackClassKey || 'live');
    }

    function tableRowsStorageKey(tableId) {
      var id = String(tableId == null ? '' : tableId).trim().toLowerCase();
      var resolved = resolveVariantsTableId(id, PAGE);
      return TABLE_ROWS_STORAGE_PREFIX + ':' + (resolved || id);
    }

    function getTableRowsPerPage(tableId, fallbackClassKey) {
      var id = String(tableId == null ? '' : tableId).trim();
      if (!id) return tableClassConfig(fallbackClassKey || 'live').defaultRows;
      var resolved = resolveVariantsTableId(id, PAGE);
      if (Object.prototype.hasOwnProperty.call(tableRowsCache, id)) return tableRowsCache[id];
      var classKey = getTableClassByTableId(id, fallbackClassKey);
      var cfg = tableRowsConfigForTableId(resolved || id, classKey);
      var raw = null;
      // Dashboard tables: "Default rows" in UI config should always win.
      // Ignore stale persisted overrides (common cause of Trending Up/Down stuck at 10).
      if (classKey !== 'dashboard') {
        try { raw = localStorage.getItem(tableRowsStorageKey(id)); } catch (_) { raw = null; }
      }
      var value = clampTableRows(raw == null ? cfg.defaultRows : Number(raw), resolved || id, classKey);
      tableRowsCache[id] = value;
      return value;
    }

    function setTableRowsPerPage(tableId, rows, fallbackClassKey) {
      var id = String(tableId == null ? '' : tableId).trim();
      if (!id) return null;
      var resolved = resolveVariantsTableId(id, PAGE);
      var classKey = getTableClassByTableId(id, fallbackClassKey);
      var next = clampTableRows(rows, resolved || id, classKey);
      tableRowsCache[id] = next;
      try { localStorage.setItem(tableRowsStorageKey(id), String(next)); } catch (_) {}
      try {
        window.dispatchEvent(new CustomEvent('kexo:table-rows-changed', {
          detail: { tableId: id, rows: next, tableClass: classKey },
        }));
      } catch (_) {}
      try {
        if (typeof window.__kexoOnTableRowsPerPageChanged === 'function') {
          window.__kexoOnTableRowsPerPageChanged(id, next, classKey);
        }
      } catch (_) {}
      return next;
    }

    // Desktop date picker is mounted into the page header right slot.

    // Page progress bar (Tabler Turbo-style): refcount + width animation
    var _progressEl = null;
    var _progressBarEl = null;
    var _progressActive = 0;
    var _progressHideTimer = null;
    function _ensureProgress() {
      if (_progressEl) return;
      _progressEl = document.createElement('div');
      _progressEl.className = 'page-progress';
      _progressEl.innerHTML = '<div class="page-progress-bar"></div>';
      document.body.prepend(_progressEl);
      _progressBarEl = _progressEl.querySelector('.page-progress-bar');
    }
    function showPageProgress() {
      _ensureProgress();
      _progressActive += 1;
      _progressEl.classList.add('active');
      if (_progressBarEl) {
        _progressBarEl.style.width = '';
        _progressBarEl.offsetHeight;
        _progressBarEl.style.width = '70%';
      }
      if (_progressHideTimer) {
        clearTimeout(_progressHideTimer);
        _progressHideTimer = null;
      }
    }
    function hidePageProgress() {
      _progressActive = Math.max(0, _progressActive - 1);
      if (_progressActive > 0 || !_progressEl || !_progressBarEl) return;
      _progressBarEl.style.width = '100%';
      _progressHideTimer = setTimeout(function() {
        _progressHideTimer = null;
        _progressEl.classList.remove('active');
        _progressBarEl.style.width = '0%';
      }, 200);
    }
    const LIVE_REFRESH_MS = 60000;
    const RANGE_REFRESH_MS = 5 * 60 * 1000; // Today and Sales refresh every 5 min
    const LIVE_SALES_POLL_MS = 10 * 1000; // Only /dashboard/live + /dashboard/sales poll automatically
    const ACTIVE_WINDOW_MS = 5 * 60 * 1000; // Live view: only show sessions seen in last 5 min
    const ARRIVED_WINDOW_MS = 60 * 60 * 1000; // Live view: only show sessions that arrived in last 60 min
    const STATS_REFRESH_MS = 5 * 60 * 1000; // Breakdown / Products / Traffic refresh (Today only)
    const KPI_REFRESH_MS = 120000; // 2 min: reduce repeated KPI queries during fast nav
    const KPI_CACHE_TTL_MS = KPI_REFRESH_MS;
    const KPI_CACHE_STALE_OK_MS = 30 * 60 * 1000; // paint stale values while revalidating
    const KPI_EXTRAS_CACHE_TTL_MS = 30 * 60 * 1000;
    const KPI_EXTRAS_CACHE_STALE_OK_MS = 60 * 60 * 1000;
    const KPI_CACHE_LS_KEY = 'kexo-kpis-cache-v1';
    const KPI_EXTRAS_CACHE_LS_KEY = 'kexo-kpis-expanded-extra-cache-v1';
    const KPI_SPINNER_MIN_MS = 800;
    let kpisSpinnerShownOnce = false;
    let updateAvailable = false;
    const SALE_MUTED_KEY = 'livevisitors-sale-muted';
    const TOP_TABLE_PAGE_SIZE = 10;
    const COUNTRY_PAGE_SIZE = 20;
    const COUNTRY_PRODUCTS_PAGE_SIZE = 20;
    const BREAKDOWN_PAGE_SIZE = 25;
    const ROWS_PER_PAGE_DEFAULT = 20;
    function loadRowsPerPage() {
      return getTableRowsPerPage('sessions-table', 'live');
    }
    let rowsPerPage = loadRowsPerPage();
    let sessions = [];
    let sessionsLoadError = null;
    let statsCache = {};
    let attributionCache = null;
    let devicesCache = null;
    let browsersCache = null;
    // Acquisition ??? Attribution (tree/table + chart state)
    let attributionExpandedChannels = null; // null = first render, default all open
    let attributionExpandedSources = null; // null = first render, default all open
    let attributionChartInstance = null;
    let attributionChartData = null;
    // Acquisition ??? Devices (tree/table + chart state)
    let devicesExpanded = null; // null = first render, default all open
    let devicesChartInstance = null;
    let devicesChartData = null;
    let dateRange = PAGE === 'sales' ? 'sales' : PAGE === 'date' ? 'today' : PAGE === 'dashboard' ? 'today' : PAGE === 'abandoned-carts' ? 'today' : 'live';
    let customRangeStartYmd = null; // YYYY-MM-DD (admin TZ)
    let customRangeEndYmd = null; // YYYY-MM-DD (admin TZ)
    let pendingCustomRangeStartYmd = null; // modal-only pending selection
    let pendingCustomRangeEndYmd = null; // modal-only pending selection
    let customCalendarLastPayload = null; // last /api/available-days payload used for rendering
    const ABANDONED_MODE_LS_KEY = 'kexo:abandoned-mode:v1';
    let abandonedMode = 'cart'; // cart | checkout
    /** When dateRange is 'live' or 'sales', stats/KPIs use today's data; only the main table shows those special views. */
    function normalizeRangeKeyForApi(key) {
      const k = (key == null ? '' : String(key)).trim().toLowerCase();
      // UI uses friendly labels (7days/14days/30days) but APIs + server payload keys use 7d/14d/30d.
      if (k === '7days') return '7d';
      if (k === '14days') return '14d';
      if (k === '30days') return '30d';
      return k;
    }

    function normalizeAbandonedMode(value) {
      var s = value != null ? String(value).trim().toLowerCase() : '';
      if (s === 'checkout' || s === 'checkouts') return 'checkout';
      return 'cart';
    }

    function abandonedModeDisplayLabel(mode) {
      return normalizeAbandonedMode(mode) === 'checkout' ? 'Abandoned Checkouts' : 'Abandoned Carts';
    }

    function loadAbandonedMode() {
      var raw = '';
      try { raw = localStorage.getItem(ABANDONED_MODE_LS_KEY) || ''; } catch (_) { raw = ''; }
      return normalizeAbandonedMode(raw);
    }

    function saveAbandonedMode(mode) {
      try { localStorage.setItem(ABANDONED_MODE_LS_KEY, normalizeAbandonedMode(mode)); } catch (_) {}
    }

    function syncAbandonedModeUi() {
      if (PAGE !== 'abandoned-carts') return;
      var titleTextEl = document.getElementById('abandoned-page-title-text');
      if (titleTextEl) titleTextEl.textContent = abandonedModeDisplayLabel(abandonedMode);

      var switchEl = document.getElementById('abandoned-mode-switch');
      if (switchEl) {
        var next = normalizeAbandonedMode(abandonedMode) === 'checkout' ? 'cart' : 'checkout';
        switchEl.textContent = 'Switch to ' + abandonedModeDisplayLabel(next);
        switchEl.setAttribute('data-abandoned-mode', next);
        switchEl.setAttribute('aria-label', 'Switch to ' + abandonedModeDisplayLabel(next));
      }
      var tableTitle = document.getElementById('table-title-text');
      if (tableTitle) tableTitle.textContent = abandonedModeDisplayLabel(abandonedMode);
    }

    function setAbandonedMode(nextMode, opts) {
      var next = normalizeAbandonedMode(nextMode);
      if (next === abandonedMode) {
        syncAbandonedModeUi();
        return;
      }
      abandonedMode = next;
      saveAbandonedMode(next);
      syncAbandonedModeUi();
      if (PAGE === 'abandoned-carts') {
        abandonedCartsChartKey = '';
        abandonedCartsTopCacheKey = '';
        try { refreshAbandonedCarts({ force: false }); } catch (_) { try { fetchSessions(); } catch (_) {} }
      }
    }

    // Abandoned Carts page: init mode dropdown state + bindings.
    if (PAGE === 'abandoned-carts') {
      try { abandonedMode = loadAbandonedMode(); } catch (_) { abandonedMode = 'cart'; }
      syncAbandonedModeUi();
      try {
        var switchEl = document.getElementById('abandoned-mode-switch');
        if (switchEl && switchEl.getAttribute('data-kexo-bound') !== '1') {
          switchEl.setAttribute('data-kexo-bound', '1');
          switchEl.addEventListener('keydown', function(e) {
            if (!e) return;
            if (e.key !== 'Enter' && e.key !== ' ') return;
            e.preventDefault();
            try { switchEl.click(); } catch (_) {}
          });
        }
      } catch (_) {}
      try {
        document.addEventListener('click', function(e) {
          var t = e && e.target ? e.target : null;
          var btn = t && t.closest ? t.closest('[data-abandoned-mode]') : null;
          if (!btn) return;
          e.preventDefault();
          setAbandonedMode(btn.getAttribute('data-abandoned-mode') || 'cart', { source: 'ui' });
        });
      } catch (_) {}
    }

    function setUpdateAvailable(next, opts) {
      updateAvailable = !!next;
      const reason = opts && opts.reason ? String(opts.reason) : '';
      try { document.body.classList.toggle('kexo-update-available', updateAvailable); } catch (_) {}
      try { document.documentElement.toggleAttribute('data-kexo-update-available', updateAvailable); } catch (_) {}
      try {
        const btn = document.getElementById('refresh-btn');
        if (btn) btn.setAttribute('title', updateAvailable ? ('Update available. Click to reload.' + (reason ? (' ' + reason) : '')) : 'Refresh');
      } catch (_) {}
      try {
        document.querySelectorAll('.footer-refresh-btn').forEach(function(btn) {
          if (!btn) return;
          btn.setAttribute('title', updateAvailable ? ('Update available. Click to reload.' + (reason ? (' ' + reason) : '')) : 'Refresh');
        });
      } catch (_) {}
    }
    function getStatsRange() {
      const raw = (dateRange === 'live' || dateRange === 'sales' || dateRange === '1h') ? 'today' : dateRange;
      return normalizeRangeKeyForApi(raw);
    }
    function getRangeDisplayLabel(rangeKey) {
      const rk = normalizeRangeKeyForApi(rangeKey);
      if (rk === 'today') return 'Today';
      if (rk === 'yesterday') return 'Yesterday';
      if (rk === '3d') return 'Last 3 days';
      if (rk === '7d') return 'Last 7 days';
      if (rk === '14d') return 'Last 14 days';
      if (rk === '30d') return 'Last 30 days';
      if (rk === 'month') return 'This month';
      if (/^d:\d{4}-\d{2}-\d{2}$/.test(rk)) return 'Selected day';
      if (/^r:\d{4}-\d{2}-\d{2}:\d{4}-\d{2}-\d{2}$/.test(rk)) return 'Selected range';
      return 'Current';
    }
    function getCompareDisplayLabel(rangeKey) {
      const rk = normalizeRangeKeyForApi(rangeKey);
      if (rk === 'today') return 'Yesterday';
      if (rk === 'yesterday') return 'Day before';
      if (rk === '3d') return 'Previous 3 days';
      if (rk === '7d') return 'Previous 7 days';
      if (rk === '14d') return 'Previous 14 days';
      if (rk === '30d') return 'Previous 30 days';
      if (rk === 'month') return 'Previous month';
      if (/^d:\d{4}-\d{2}-\d{2}$/.test(rk)) return 'Previous day';
      if (/^r:\d{4}-\d{2}-\d{2}:\d{4}-\d{2}-\d{2}$/.test(rk)) {
        var m = rk.match(/^r:(\d{4}-\d{2}-\d{2}):(\d{4}-\d{2}-\d{2})$/);
        if (m && m[1] && m[2]) {
          try {
            var a = Date.parse(m[1] + 'T00:00:00Z');
            var b = Date.parse(m[2] + 'T00:00:00Z');
            if (Number.isFinite(a) && Number.isFinite(b)) {
              var spanDays = Math.abs(Math.round((b - a) / 86400000)) + 1;
              if (spanDays <= 1) return 'Previous day';
              return 'Previous ' + String(spanDays) + ' days';
            }
          } catch (_) {}
        }
        return 'Previous period';
      }
      return 'Previous period';
    }

    function showDashboardSecondaryCompare(rangeKey) {
      const rk = normalizeRangeKeyForApi(rangeKey);
      return rk === 'today' || rk === 'yesterday';
    }

    // Shopify embedded app: keep the signed query params on internal navigation.
    // Without this, moving from `/?shop=...&hmac=...` to `/dashboard/overview` drops the signature and API calls can 401.
    (function propagateShopifySignedQueryToLinks() {
      try {
        const cur = new URL(window.location.href);
        const sp = cur.searchParams;
        const shop = sp.get('shop');
        const hmac = sp.get('hmac');
        const ts = sp.get('timestamp');
        if (!shop || !hmac || !ts) return;
        if (!/\.myshopify\.com$/i.test(shop)) return;

        const signedEntries = [];
        sp.forEach(function(v, k) { signedEntries.push([k, v]); });
        const signedKeys = new Set(signedEntries.map(function(e) { return e[0]; }));

        const isAssetPath = function(p) {
          if (!p) return false;
          if (p.startsWith('/assets/')) return true;
          return /\.(css|js|png|webp|jpg|jpeg|gif|svg|ico|map|txt)$/i.test(p);
        };

        document.querySelectorAll('a[href]').forEach(function(a) {
          const rawHref = a.getAttribute('href');
          if (!rawHref) return;
          const h = rawHref.trim();
          if (!h || h[0] === '#') return;
          if (/^(javascript:|mailto:|tel:)/i.test(h)) return;

          let u;
          try { u = new URL(h, cur.origin); } catch (_) { return; }
          if (u.origin !== cur.origin) return;
          if ((u.pathname || '').startsWith('/api/')) return;
          if (isAssetPath(u.pathname || '')) return;

          // Don't add signed params to links that already have extra params:
          // adding any new key would invalidate the existing hmac.
          let hasNonSigned = false;
          u.searchParams.forEach(function(_v, k) { if (!signedKeys.has(k)) hasNonSigned = true; });
          if (hasNonSigned) return;

          signedEntries.forEach(function(pair) {
            u.searchParams.set(pair[0], pair[1]);
          });
          a.setAttribute('href', u.pathname + '?' + u.searchParams.toString() + (u.hash || ''));
        });
      } catch (_) {}
    })();

    // Sync data-label from header to body cells for mobile card layout
    (function initGridTableMobileLabels() {
      function syncLabels(tableEl) {
        if (!tableEl || !tableEl.querySelector) return;
        var headerRow = tableEl.querySelector('.grid-row--header');
        var headerCells = headerRow ? headerRow.querySelectorAll('.grid-cell') : [];
        var labels = Array.from(headerCells).map(function(c) {
          var a = c.getAttribute('aria-label');
          if (a) return a.trim();
          var long = c.querySelector('.th-label-long');
          if (long && long.textContent) return long.textContent.trim();
          return (c.textContent || '').trim();
        });
        if (labels.length === 0) return;
        tableEl.querySelectorAll('.grid-body .grid-row').forEach(function(row) {
          var cells = row.querySelectorAll('.grid-cell:not(.span-all)');
          cells.forEach(function(cell, i) {
            if (labels[i]) cell.setAttribute('data-label', labels[i]);
          });
        });
      }
      function observeGridBodies() {
        document.querySelectorAll('.grid-table .grid-body').forEach(function(body) {
          if (body._gridLabelsObserved) return;
          body._gridLabelsObserved = true;
          syncLabels(body.closest('.grid-table'));
          var mo = new MutationObserver(function() {
            syncLabels(body.closest('.grid-table'));
          });
          mo.observe(body, { childList: true, subtree: true });
        });
      }
      function run() {
        observeGridBodies();
      }
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', run);
      } else {
        run();
      }
      setTimeout(run, 800);
      setTimeout(run, 2000);
    })();

    (function initHorizontalDragScroll() {
      var WRAP_SELECTOR = '.table-scroll-wrap, .country-table-wrap, .table-responsive, .tools-table-wrap';

      function shouldIgnoreTarget(target) {
        if (!target || !target.closest) return false;
        return !!target.closest('a, button, input, select, textarea, label, [role="button"], [data-no-drag-scroll]');
      }

      function setDragEnabledClass(wrap) {
        if (!wrap) return;
        var canDrag = (wrap.scrollWidth || 0) > ((wrap.clientWidth || 0) + 1);
        wrap.classList.toggle('is-drag-scroll', !!canDrag);
      }

      function shouldSkipStickyScrollClass(wrap) {
        if (!wrap || !wrap.querySelector) return true;
        return !!wrap.querySelector('#latest-sales-table');
      }

      function updateStickyScrollClass(wrap) {
        if (!wrap || shouldSkipStickyScrollClass(wrap)) return;
        var scrolled = (wrap.scrollLeft || 0) > 0;
        wrap.classList.toggle('kexo-sticky-scrolled', scrolled);
      }

      function bind(wrap) {
        if (!wrap || wrap.getAttribute('data-drag-scroll-bound') === '1') return;
        wrap.setAttribute('data-drag-scroll-bound', '1');
        setDragEnabledClass(wrap);

        if (!shouldSkipStickyScrollClass(wrap)) {
          updateStickyScrollClass(wrap);
          wrap.addEventListener('scroll', function() { updateStickyScrollClass(wrap); }, { passive: true });
        }

        var startX = 0;
        var startScrollLeft = 0;
        var dragging = false;
        var moved = false;

        wrap.addEventListener('pointerdown', function(e) {
          if (!e) return;
          var pt = String(e.pointerType || '').toLowerCase();
          if (pt === 'mouse' && e.button !== 0) return;
          var scrollbarHidden = (getComputedStyle(wrap).getPropertyValue('scrollbar-width') || '').trim() === 'none';
          if ((e.pointerType || '') === 'touch' && !scrollbarHidden) return; // native swipe when scrollbar visible; when hidden (mobile/emulation), run our drag
          if (!wrap.classList.contains('is-drag-scroll')) return;
          if (shouldIgnoreTarget(e.target)) return;
          dragging = true;
          moved = false;
          startX = e.clientX;
          startScrollLeft = wrap.scrollLeft;
          wrap.classList.add('is-dragging');
          try { wrap.setPointerCapture(e.pointerId); } catch (_) {}
        });

        wrap.addEventListener('pointermove', function(e) {
          if (!dragging) return;
          var dx = e.clientX - startX;
          if (!moved && Math.abs(dx) > 3) moved = true;
          wrap.scrollLeft = startScrollLeft - dx;
          if (moved) e.preventDefault();
        });

        function endDrag(e) {
          if (!dragging) return;
          dragging = false;
          wrap.classList.remove('is-dragging');
          try { if (e && e.pointerId != null) wrap.releasePointerCapture(e.pointerId); } catch (_) {}
        }

        wrap.addEventListener('pointerup', endDrag);
        wrap.addEventListener('pointercancel', endDrag);
        wrap.addEventListener('pointerleave', function(e) {
          if (!dragging) return;
          if (e && e.buttons === 1) return;
          endDrag(e);
        });

        if (typeof ResizeObserver !== 'undefined') {
          try {
            var ro = new ResizeObserver(function() {
              setDragEnabledClass(wrap);
              if (!shouldSkipStickyScrollClass(wrap)) updateStickyScrollClass(wrap);
            });
            ro.observe(wrap);
            wrap._dragScrollObserver = ro;
          } catch (_) {}
        }
      }

      function run() {
        document.querySelectorAll(WRAP_SELECTOR).forEach(function(wrap) { bind(wrap); });
      }

      var resizeTid;
      function refreshAll() {
        document.querySelectorAll(WRAP_SELECTOR).forEach(function(wrap) {
          if (wrap.getAttribute('data-drag-scroll-bound') !== '1') return;
          setDragEnabledClass(wrap);
          if (!shouldSkipStickyScrollClass(wrap)) updateStickyScrollClass(wrap);
        });
      }
      window.addEventListener('resize', function() {
        clearTimeout(resizeTid);
        resizeTid = setTimeout(refreshAll, 80);
      });

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', run);
      } else {
        run();
      }
      setTimeout(run, 700);
      setTimeout(run, 1800);
    })();

    (function initTableCardCollapse() {
      var STORAGE_PREFIX = 'kexo:table-collapse:v1';
      var CARD_SELECTOR = '.card';
      var TABLE_CONTENT_SELECTOR = '.table-scroll-wrap, .country-table-wrap, .table-responsive, .grid-table, table';
      var CHART_CONTENT_SELECTOR = '.dash-chart-wrap, [id^="dash-chart-"], #live-online-chart, #sessions-overview-chart, #ads-overview-chart, #attribution-chart, #devices-chart, #products-chart, #countries-map-chart';
      var HEADER_SELECTOR = '.card-header';

      function getPageScope() {
        var page = '';
        try { page = (document.body && document.body.getAttribute('data-page')) || ''; } catch (_) { page = ''; }
        if (page) return String(page).trim().toLowerCase();
        var path = '';
        try { path = (window.location && window.location.pathname) ? String(window.location.pathname) : ''; } catch (_) { path = ''; }
        path = path.replace(/^\/+/, '').trim().toLowerCase();
        return path || 'dashboard';
      }

      function slugify(value) {
        return String(value == null ? '' : value)
          .trim()
          .toLowerCase()
          .replace(/[^a-z0-9]+/g, '-')
          .replace(/^-+|-+$/g, '') || 'table-card';
      }

      function getDirectHeader(card) {
        if (!card || !card.querySelector) return null;
        var header = null;
        try { header = card.querySelector(':scope > .card-header'); } catch (_) { header = null; }
        if (header) return header;
        return card.querySelector(HEADER_SELECTOR);
      }

      function hasTableContent(card) {
        if (!card || !card.querySelector) return false;
        if (card.querySelector(TABLE_CONTENT_SELECTOR)) return true;
        if (card.querySelector(CHART_CONTENT_SELECTOR)) return true;
        return false;
      }

      function hasChartContent(card) {
        if (!card || !card.querySelector) return false;
        return !!card.querySelector(CHART_CONTENT_SELECTOR);
      }

      function isChartOnlyCard(card) {
        if (!card) return false;
        if (card.dataset && card.dataset.tableId) return false;
        // Product Insights modal Revenue/Demand cards keep collapse chevrons (not gear)
        if (card.dataset && card.dataset.collapseId && String(card.dataset.collapseId).indexOf('product-insights-') === 0) return false;
        var wrap = card.closest ? card.closest('[data-kexo-chart-key]') : null;
        if (wrap) return true;
        return hasChartContent(card) && !card.querySelector(TABLE_CONTENT_SELECTOR);
      }

      function getCollapseId(card, index) {
        if (!card || !card.dataset) return 'table-card-' + String(index || 0);
        if (card.dataset.collapseId) return card.dataset.collapseId;
        var id = '';
        if (card.id) id = String(card.id).trim();
        if (!id) {
          var titleEl = card.querySelector('.card-header .card-title');
          var title = titleEl ? String(titleEl.textContent || '').trim() : '';
          if (title) id = slugify(title) + '-' + String(index || 0);
        }
        if (!id) id = 'table-card-' + String(index || 0);
        card.dataset.collapseId = id;
        return id;
      }

      function getStorageKey(card, index) {
        return STORAGE_PREFIX + ':' + getPageScope() + ':' + getCollapseId(card, index);
      }

      function refreshIconTheme() {
        try {
          window.dispatchEvent(new CustomEvent('kexo:icon-theme-changed'));
          if (window.KexoIconTheme && typeof window.KexoIconTheme.refresh === 'function') window.KexoIconTheme.refresh();
        } catch (_) {}
      }

      function setCollapseChevron(button, collapsed) {
        if (!button || !button.querySelector) return;
        var icon = button.querySelector('.kexo-card-collapse-chevron');
        if (!icon) return;
        var isCollapsed = !!collapsed;
        var glyph = isCollapsed ? 'fa-chevron-right' : 'fa-chevron-down';
        var key = isCollapsed ? 'card-collapse-collapsed' : 'card-collapse-expanded';
        icon.setAttribute('data-icon-key', key);
        icon.className = 'kexo-card-collapse-chevron fa-light ' + glyph;
        refreshIconTheme();
      }

      function setCollapsed(card, button, collapsed, persist, storageKey) {
        if (!card) return;
        var isCollapsed = !!collapsed;
        card.classList.toggle('kexo-card-collapsed', isCollapsed);
        if (button) {
          button.classList.toggle('is-collapsed', isCollapsed);
          button.setAttribute('aria-expanded', isCollapsed ? 'false' : 'true');
          button.setAttribute('aria-label', isCollapsed ? 'Expand section' : 'Collapse section');
          button.title = isCollapsed ? 'Expand section' : 'Collapse section';
          setCollapseChevron(button, isCollapsed);
        }
        if (persist && storageKey) {
          try { sessionStorage.setItem(storageKey, isCollapsed ? '1' : '0'); } catch (_) {}
        }
      }

      function restoreCollapsed(card, button, storageKey) {
        var raw = null;
        try { raw = sessionStorage.getItem(storageKey); } catch (_) { raw = null; }
        if (raw == null) {
          // Keep any default collapsed state already present in the DOM (useful for
          // dynamically-inserted cards like modals).
          var already = !!(card && card.classList && card.classList.contains('kexo-card-collapsed'));
          setCollapsed(card, button, already, false, storageKey);
          return;
        }
        setCollapsed(card, button, raw === '1', false, storageKey);
      }

      function ensureToggle(card, index) {
        if (!card || card.getAttribute('data-no-card-collapse') === '1') return;
        if (!hasTableContent(card)) return;
        var header = getDirectHeader(card);
        if (!header) return;

        if (card.dataset && card.dataset.tableId) {
          if (header.querySelector('.kexo-builder-icon-link')) return;
          var tableId = String(card.dataset.tableId || '').trim();
          var pageKey = getPageScope();
          var titleEl = card.querySelector('.card-header .card-title');
          var cardTitle = (titleEl && titleEl.textContent) ? String(titleEl.textContent).trim() : tableId;
          var link = document.createElement('button');
          link.type = 'button';
          link.className = 'kexo-builder-icon-link';
          link.title = 'Table settings';
          link.setAttribute('aria-label', 'Table settings');
          link.innerHTML = '<i class="fa-light fa-gear" data-icon-key="table-builder-icon" aria-hidden="true"></i>';
          link.addEventListener('click', function (e) {
            e.preventDefault();
            e.stopPropagation();
            if (tableId === 'ads-root') {
              window.location.href = '/settings?tab=integrations&integrationsTab=googleads';
              return;
            }
            if (typeof window.KexoLayoutShortcuts !== 'undefined' && typeof window.KexoLayoutShortcuts.openTableModal === 'function') {
              window.KexoLayoutShortcuts.openTableModal({ pageKey: pageKey, tableId: tableId, cardTitle: cardTitle });
            }
          });
          var actions = header.querySelector(':scope > .card-actions');
          if (!actions) {
            actions = document.createElement('div');
            actions.className = 'card-actions d-flex align-items-center gap-2 ms-auto';
            header.appendChild(actions);
          }
          actions.appendChild(link);
          return;
        }

        if (isChartOnlyCard(card)) {
          var existingChartLink = header.querySelector('.kexo-builder-icon-link');
          var existingCollapse = header.querySelector('.kexo-card-collapse-toggle');
          if (existingCollapse) existingCollapse.remove();
          if (existingChartLink) return;
          var chartWrap = card.closest ? card.closest('[data-kexo-chart-key]') : null;
          var chartKey = (card.dataset && card.dataset.kexoChartKey) ? String(card.dataset.kexoChartKey).trim().toLowerCase() : (chartWrap && chartWrap.getAttribute('data-kexo-chart-key')) ? String(chartWrap.getAttribute('data-kexo-chart-key')).trim().toLowerCase() : '';
          if (!chartKey) return;
          var chartTitleEl = card.querySelector('.card-header .card-title');
          var chartCardTitle = (chartTitleEl && chartTitleEl.textContent) ? String(chartTitleEl.textContent).trim() : chartKey;
          var chartLink = document.createElement('button');
          chartLink.type = 'button';
          chartLink.className = 'kexo-builder-icon-link';
          chartLink.title = 'Chart settings';
          chartLink.setAttribute('aria-label', 'Chart settings');
          chartLink.setAttribute('data-kexo-chart-settings-key', chartKey);
          chartLink.innerHTML = '<i class="fa-light fa-gear" data-icon-key="chart-builder-icon" aria-hidden="true"></i>';
          chartLink.addEventListener('click', function (e) {
            e.preventDefault();
            e.stopPropagation();
            // Back-compat: if delegation doesn't run for any reason, open via unified builder directly.
            if (window.KexoChartSettingsBuilder && typeof window.KexoChartSettingsBuilder.openModal === 'function') {
              window.KexoChartSettingsBuilder.openModal({ chartKey: chartKey, cardTitle: chartCardTitle });
              return;
            }
            if (typeof window.KexoLayoutShortcuts !== 'undefined' && typeof window.KexoLayoutShortcuts.openChartModal === 'function') {
              window.KexoLayoutShortcuts.openChartModal({ chartKey: chartKey, cardTitle: chartCardTitle });
            }
          });
          var chartActions = header.querySelector(':scope > .card-actions');
          if (!chartActions) {
            chartActions = document.createElement('div');
            chartActions.className = 'card-actions d-flex align-items-center gap-2 ms-auto';
            header.appendChild(chartActions);
          }
          chartActions.appendChild(chartLink);
          return;
        }

        var storageKey = getStorageKey(card, index);
        var btn = header.querySelector('.kexo-card-collapse-toggle');
        if (!btn) {
          btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'btn btn-icon btn-ghost-secondary kexo-card-collapse-toggle';
          btn.innerHTML = '<i class="kexo-card-collapse-chevron fa-light fa-chevron-down" data-icon-key="card-collapse-expanded" aria-hidden="true"></i>';
          var actions = null;
          try { actions = header.querySelector(':scope > .card-actions'); } catch (_) { actions = null; }
          if (actions && actions.parentElement === header) {
            header.appendChild(btn);
          } else {
            btn.classList.add('ms-auto');
            header.appendChild(btn);
          }
        }
        if (btn.getAttribute('data-collapse-bound') !== '1') {
          btn.setAttribute('data-collapse-bound', '1');
          btn.addEventListener('click', function(e) {
            e.preventDefault();
            var next = !card.classList.contains('kexo-card-collapsed');
            setCollapsed(card, btn, next, true, storageKey);
          });
        }
        restoreCollapsed(card, btn, storageKey);
      }

      function run(root) {
        var scope = root && root.querySelectorAll ? root : document;
        var cards = scope.querySelectorAll(CARD_SELECTOR);
        cards.forEach(function(card, idx) { ensureToggle(card, idx); });
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() { run(document); });
      } else {
        run(document);
      }

      var gridDocObserver = null;
      function initGridDocObserver() {
        if (gridDocObserver) return;
        try {
          gridDocObserver = new MutationObserver(function(muts) {
            muts.forEach(function(m) {
              (m.addedNodes || []).forEach(function(n) {
                if (!(n instanceof Element)) return;
                run(n);
              });
            });
          });
          gridDocObserver.observe(document.documentElement, { childList: true, subtree: true });
          if (typeof registerCleanup === 'function') {
            registerCleanup(function() {
              try { if (gridDocObserver && typeof gridDocObserver.disconnect === 'function') gridDocObserver.disconnect(); } catch (_) {}
              gridDocObserver = null;
            });
          }
        } catch (_) {}
      }
      try { window.__kexoInitGridDocObserver = initGridDocObserver; } catch (_) {}
      initGridDocObserver();

      try { window.addEventListener('hashchange', function() { setTimeout(function() { run(document); }, 0); }); } catch (_) {}
      setTimeout(function() { run(document); }, 800);
      setTimeout(function() { run(document); }, 1800);
    })();

    (function initTableRowsPerPageControls() {
      var CARD_SELECTOR = '.card[data-table-class][data-table-id]';

      function getDirectHeader(card) {
        if (!card || !card.querySelector) return null;
        try { return card.querySelector(':scope > .card-header'); } catch (_) {}
        return card.querySelector('.card-header');
      }

      function ensureActionsContainer(header) {
        if (!header || !header.querySelector) return null;
        var actions = null;
        try { actions = header.querySelector(':scope > .card-actions'); } catch (_) { actions = null; }
        if (actions && actions.parentElement === header) return actions;
        actions = document.createElement('div');
        actions.className = 'card-actions d-flex align-items-center gap-2 ms-auto kexo-table-actions';
        header.appendChild(actions);
        return actions;
      }

      function ensureRowsControl(card) {
        if (!card) return;
        var tableId = (card.dataset && card.dataset.tableId) ? String(card.dataset.tableId).trim() : inferTableIdFromCard(card);
        if (!tableId) return;
        var classKey = normalizeTableClass(card.dataset && card.dataset.tableClass ? card.dataset.tableClass : 'live');
        var cfg = tableRowsConfigForTableId(tableId, classKey);
        var selectedRows = getTableRowsPerPage(tableId, classKey);
        var header = getDirectHeader(card);
        if (!header) return;
        var actions = ensureActionsContainer(header);
        if (!actions) return;

        var collapseBtn = header.querySelector('.kexo-card-collapse-toggle');
        var builderLink = header.querySelector('.kexo-builder-icon-link');
        if (collapseBtn && collapseBtn.parentElement !== actions) {
          collapseBtn.classList.remove('ms-auto');
          actions.appendChild(collapseBtn);
        }
        if (builderLink && builderLink.parentElement !== actions) {
          builderLink.classList.remove('ms-auto');
          actions.appendChild(builderLink);
        }

        // Acquisition → Attribution: quick link to Settings → Attribution → Mapping.
        try {
          var page = (document.body && document.body.getAttribute) ? String(document.body.getAttribute('data-page') || '') : '';
          if (page.trim().toLowerCase() === 'attribution' && String(tableId || '').trim().toLowerCase() === 'attribution-table') {
            var existingSettingsLink = actions.querySelector('.kexo-attribution-settings-link');
            if (!existingSettingsLink) {
              var a = document.createElement('a');
              a.className = 'kexo-attribution-settings-link';
              a.href = '/settings?tab=attribution&attributionTab=mapping';
              a.title = 'Attribution settings';
              a.setAttribute('aria-label', 'Attribution settings');
              a.innerHTML = '<i class="fa-light fa-sliders" aria-hidden="true"></i>';
              // Place next to the table settings cog when present.
              if (builderLink && builderLink.parentElement === actions) actions.insertBefore(a, builderLink.nextSibling);
              else actions.appendChild(a);
            }
          }
        } catch (_) {}

        var control = actions.querySelector('.kexo-table-rows-control[data-table-id="' + tableId + '"]');
        if (!control) {
          control = document.createElement('label');
          control.className = 'kexo-table-rows-control';
          control.setAttribute('data-table-id', tableId);
          control.innerHTML = '<select class="form-select form-select-sm kexo-table-rows-select" aria-label="Rows per table"></select>';
          var insertBefore = (collapseBtn && collapseBtn.parentElement === actions) ? collapseBtn : (builderLink && builderLink.parentElement === actions) ? builderLink : null;
          if (insertBefore) {
            actions.insertBefore(control, insertBefore);
          } else {
            actions.appendChild(control);
          }
        }

        var selectEl = control.querySelector('.kexo-table-rows-select');
        if (!selectEl) return;
        var options = Array.isArray(cfg && cfg.rowOptions) ? cfg.rowOptions : [cfg.defaultRows];
        selectEl.innerHTML = options.map(function(opt) {
          return '<option value="' + String(opt) + '">' + String(opt) + '</option>';
        }).join('');
        selectEl.value = String(clampTableRows(selectedRows, tableId, classKey));
        if (selectEl.getAttribute('data-rows-bound') !== '1') {
          selectEl.setAttribute('data-rows-bound', '1');
          selectEl.addEventListener('change', function() {
            var next = setTableRowsPerPage(tableId, Number(selectEl.value), classKey);
            applyTableRowsPerPageChange(tableId, next);
          });
        }
      }

      function run(root) {
        var scope = root && root.querySelectorAll ? root : document;
        var cards = scope.querySelectorAll(CARD_SELECTOR);
        cards.forEach(function(card) { ensureRowsControl(card); });
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() { run(document); });
      } else {
        run(document);
      }
      var observer = new MutationObserver(function(muts) {
        muts.forEach(function(m) {
          m.addedNodes.forEach(function(n) {
            if (!(n instanceof Element)) return;
            run(n);
          });
        });
      });
      observer.observe(document.documentElement, { childList: true, subtree: true });
      window.addEventListener('kexo:table-rows-changed', function() {
        run(document);
      });
      window.addEventListener('kexo:tablesUiConfigApplied', function() {
        run(document);
      });
      window.addEventListener('kexo:variant-cards-rendered', function() {
        run(document);
      });
      window.addEventListener('kexo:icon-theme-changed', function() {
        run(document);
        setTimeout(function() { run(document); }, 80);
      });
      setTimeout(function() { run(document); }, 900);
      setTimeout(function() { run(document); }, 2000);
    })();

    (function initStickyColumnResize() {
      var page = '';
      try { page = (document.body && document.body.getAttribute('data-page')) || ''; } catch (_) { page = ''; }
      if (String(page || '').toLowerCase() === 'settings') return;
      var WRAP_SELECTOR = '.table-scroll-wrap, .country-table-wrap, .table-responsive, .tools-table-wrap';
      var ABS_MIN_WIDTH = 72;
      var ABS_MAX_WIDTH = 420;
      var LS_KEY = 'kexo-sticky-col-width';

      function getViewportBucket() {
        try {
          return (window.matchMedia && window.matchMedia('(max-width: 991.98px)').matches) ? 'mobile' : 'desktop';
        } catch (_) {
          return 'desktop';
        }
      }

      function getWrapTableId(wrap) {
        if (!wrap) return '';
        try {
          var table = wrap.querySelector ? wrap.querySelector('table[id], .grid-table[id]') : null;
          if (table && table.id) return String(table.id).trim();
        } catch (_) {}
        // Prefer the owning card's declared table id so related wraps (e.g. Ads footer)
        // share the same sticky width key.
        try {
          var card = wrap.closest ? wrap.closest('.card[data-table-id]') : null;
          if (card && card.dataset && card.dataset.tableId) return String(card.dataset.tableId).trim();
        } catch (_) {}
        try {
          if (wrap.id) return String(wrap.id).trim();
        } catch (_) {}
        return '';
      }

      function getWrapTableClass(wrap) {
        try {
          var card = wrap && wrap.closest ? wrap.closest('.card') : null;
          if (card && card.dataset && card.dataset.tableClass) return normalizeTableClass(card.dataset.tableClass);
        } catch (_) {}
        return getTableClassByTableId(getWrapTableId(wrap), 'live');
      }

      function getTableCardsInGroupCount(wrap) {
        if (!wrap || !wrap.closest || !wrap.querySelectorAll) return 1;
        var card = wrap.closest('.card');
        if (!card) return 1;
        var group = card.closest('.stats-row, .row');
        if (!group || !group.querySelectorAll) return 1;
        var cards = group.querySelectorAll('.card[data-table-id]');
        var count = 0;
        cards.forEach(function(c) {
          if (!c || !c.closest) return;
          var owner = c.closest('.stats-row, .row');
          if (owner === group) count++;
        });
        return count > 0 ? count : 1;
      }

      function getBounds(wrap) {
        var classKey = getWrapTableClass(wrap);
        var gridCount = getTableCardsInGroupCount(wrap);
        var min = classKey === 'dashboard' ? 90 : ABS_MIN_WIDTH;
        var max = classKey === 'dashboard' ? 180 : (classKey === 'product' ? 240 : 280);
        var def = classKey === 'dashboard' ? 120 : 120;

        // Live-class tables (20/30/40/50 rows) can expand wider for sticky labels.
        if (classKey === 'live') max = Math.max(max, 400);

        // Site-wide sticky sizing rules by table-grid cardinality.
        if (classKey !== 'live' && gridCount === 1) max = Math.min(max, 250);
        // On mobile the cards stack; allow sticky labels to expand more naturally.
        if (classKey !== 'live' && gridCount === 2 && getViewportBucket() !== 'mobile') max = Math.min(max, 150);
        if (gridCount >= 3) min = Math.max(min, 100);

        // Optional per-table overrides from Settings ??? Layout ??? Tables.
        try {
          var tableId = getWrapTableId(wrap);
          var ui = getTablesUiTableCfg(tableId, page);
          if (ui && ui.sticky && typeof ui.sticky === 'object') {
            if (typeof ui.sticky.minWidth === 'number' && Number.isFinite(ui.sticky.minWidth)) min = ui.sticky.minWidth;
            if (typeof ui.sticky.maxWidth === 'number' && Number.isFinite(ui.sticky.maxWidth)) max = ui.sticky.maxWidth;
          }
        } catch (_) {}

        var wrapW = wrap && wrap.clientWidth ? Number(wrap.clientWidth) : 0;
        var colCount = 0;
        try {
          var headerRow = wrap && wrap.querySelector ? wrap.querySelector('.grid-row--header') : null;
          if (headerRow && headerRow.querySelectorAll) {
            colCount = headerRow.querySelectorAll('.grid-cell').length;
          } else {
            var tableHeadRow = wrap && wrap.querySelector ? wrap.querySelector('table thead tr') : null;
            if (tableHeadRow && tableHeadRow.children) colCount = tableHeadRow.children.length || 0;
          }
        } catch (_) { colCount = 0; }
        if (Number.isFinite(wrapW) && wrapW > 0) {
          var isMobile = getViewportBucket() === 'mobile';
          var fitRatio = isMobile ? 0.8 : 0.65;
          var softMax = Math.max(min + 16, Math.round(wrapW * fitRatio));
          max = Math.min(max, softMax);
          if (colCount > 1) {
            var minOtherColWidth = classKey === 'live' ? 72 : 64;
            var byRemainingCols = wrapW - (minOtherColWidth * (colCount - 1));
            var isScrollable = (wrap.scrollWidth || 0) > ((wrap.clientWidth || 0) + 1);
            if (!isScrollable && byRemainingCols >= min + 16) max = Math.min(max, byRemainingCols);
          }
        }
        min = Math.max(ABS_MIN_WIDTH, Math.min(min, ABS_MAX_WIDTH - 16));
        max = Math.max(min + 16, Math.min(max, ABS_MAX_WIDTH));
        def = Math.max(min, Math.min(max, def));
        return { min: min, max: max, def: def };
      }

      function clampWidth(wrap, n) {
        var bounds = getBounds(wrap);
        var x = Number(n);
        if (!Number.isFinite(x)) return bounds.def;
        return Math.max(bounds.min, Math.min(bounds.max, Math.round(x)));
      }

      function getHeaderStickyCell(wrap) {
        if (!wrap || !wrap.querySelector) return null;
        return wrap.querySelector('.grid-row--header .grid-cell:first-child, table thead th:first-child');
      }

      function getWrapIndex(wrap) {
        if (!wrap || !document.querySelectorAll) return 0;
        var list = [];
        try { list = Array.prototype.slice.call(document.querySelectorAll(WRAP_SELECTOR)); } catch (_) {}
        var i = list.indexOf(wrap);
        return i >= 0 ? i : 0;
      }

      function getStorageKey(wrap) {
        var suffix = 'default';
        try {
          var tableId = getWrapTableId(wrap);
          if (tableId) suffix = resolveVariantsTableId(tableId, page || PAGE) || tableId;
          else if (page) suffix = String(page).trim().toLowerCase();
        } catch (_) {}
        return LS_KEY + ':' + suffix + ':' + getViewportBucket() + ':' + getWrapIndex(wrap);
      }

      function readSavedWidth(wrap) {
        var raw = null;
        var key = getStorageKey(wrap);
        try { raw = localStorage.getItem(key); } catch (_) { raw = null; }
        var fallback = getBounds(wrap).def;
        return clampWidth(wrap, raw == null ? fallback : Number(raw));
      }

      function saveWidth(wrap, width) {
        var n = Number(width);
        if (!Number.isFinite(n)) return;
        var key = getStorageKey(wrap);
        try { localStorage.setItem(key, String(Math.round(n))); } catch (_) {}
      }

      function wrapWidth(wrap) {
        var style = null;
        try { style = getComputedStyle(wrap); } catch (_) { style = null; }
        var raw = style ? style.getPropertyValue('--kexo-sticky-col-width') : '';
        var n = parseFloat(String(raw || '').trim());
        if (!Number.isFinite(n)) {
          var cell = getHeaderStickyCell(wrap);
          if (cell) {
            try { n = parseFloat(getComputedStyle(cell).width); } catch (_) { n = NaN; }
          }
        }
        return clampWidth(wrap, Number.isFinite(n) ? n : getBounds(wrap).def);
      }

      function applyWidthSingle(wrap, width) {
        if (!wrap || !wrap.style) return;
        var bounds = getBounds(wrap);
        var next = clampWidth(wrap, width);
        wrap.style.setProperty('--kexo-sticky-col-min-width', bounds.min + 'px');
        wrap.style.setProperty('--kexo-sticky-col-max-width', bounds.max + 'px');
        wrap.style.setProperty('--kexo-sticky-col-width', next + 'px');
      }

      function applyWidthToGroup(wrap, width) {
        if (!wrap) return;
        applyWidthSingle(wrap, width);
        var applied = wrapWidth(wrap);
        if (wrap.id === 'ads-root' && Number.isFinite(applied)) {
          try {
            var footer = document.getElementById('ads-footer');
            if (footer && footer !== wrap) applyWidthSingle(footer, applied);
          } catch (_) {}
        }
      }

      function markResizeInteraction(wrap) {
        var ts = Date.now();
        try { if (wrap) wrap.setAttribute('data-sticky-resize-at', String(ts)); } catch (_) {}
        try { window.__kexoLastStickyResizeAt = ts; } catch (_) {}
      }

      function bindHandle(wrap, handle) {
        if (!wrap || !handle || handle.getAttribute('data-sticky-resize-bound') === '1') return;
        handle.setAttribute('data-sticky-resize-bound', '1');
        var startX = 0;
        var startW = getBounds(wrap).def;
        var resizing = false;
        var didDrag = false;

        function ensureResizeClickGuard() {
          try {
            var root = document.documentElement;
            if (!root || root.getAttribute('data-kexo-sticky-resize-click-guard') === '1') return;
            root.setAttribute('data-kexo-sticky-resize-click-guard', '1');
          } catch (_) {}
          try {
            document.addEventListener('click', function (e) {
              var until = Number(window.__kexoStickyResizeSuppressClickUntil || 0);
              if (!Number.isFinite(until) || until <= 0) return;
              if (Date.now() > until) return;
              // A resize drag ends with a "click" on the header; eat it so it doesn't trigger sort/reorder.
              try { e.preventDefault(); } catch (_) {}
              try { e.stopPropagation(); } catch (_) {}
              try { if (typeof e.stopImmediatePropagation === 'function') e.stopImmediatePropagation(); } catch (_) {}
              try { window.__kexoStickyResizeSuppressClickUntil = 0; } catch (_) {}
            }, true);
          } catch (_) {}
        }

        function suppressNextClick() {
          ensureResizeClickGuard();
          try { window.__kexoStickyResizeSuppressClickUntil = Date.now() + 600; } catch (_) {}
        }

        function stopResize(e) {
          if (!resizing) return;
          if (e && typeof e.preventDefault === 'function') e.preventDefault();
          if (e && typeof e.stopPropagation === 'function') e.stopPropagation();
          resizing = false;
          wrap.classList.remove('is-resizing-first-col');
          try { if (e && e.pointerId != null) handle.releasePointerCapture(e.pointerId); } catch (_) {}
          markResizeInteraction(wrap);
          saveWidth(wrap, wrapWidth(wrap));
          if (didDrag) suppressNextClick();
        }

        handle.addEventListener('pointerdown', function(e) {
          if (!e) return;
          var pt = String(e.pointerType || '').toLowerCase();
          if (pt === 'mouse' && e.button !== 0) return;
          e.preventDefault();
          e.stopPropagation();
          resizing = true;
          didDrag = false;
          startX = e.clientX;
          startW = wrapWidth(wrap);
          wrap.classList.add('is-resizing-first-col');
          markResizeInteraction(wrap);
          try { handle.setPointerCapture(e.pointerId); } catch (_) {}
        });

        handle.addEventListener('pointermove', function(e) {
          if (!resizing) return;
          e.preventDefault();
          e.stopPropagation();
          if (!didDrag) {
            try { didDrag = Math.abs((e.clientX || 0) - (startX || 0)) > 2; } catch (_) { didDrag = true; }
          }
          var next = startW + (e.clientX - startX);
          applyWidthToGroup(wrap, next);
          markResizeInteraction(wrap);
        });

        handle.addEventListener('pointerup', stopResize);
        handle.addEventListener('pointercancel', stopResize);
        handle.addEventListener('lostpointercapture', stopResize);
        handle.addEventListener('click', function (e) {
          // Prevent header click/sort when user interacts with the resize handle.
          try { e.preventDefault(); } catch (_) {}
          try { e.stopPropagation(); } catch (_) {}
        }, true);
      }

      var STICKY_DEBOUNCE_MS = 60;
      function ensureHandle(wrap) {
        var cell = getHeaderStickyCell(wrap);
        if (!cell) return;
        var handle = cell.querySelector('.kexo-sticky-resize-handle');
        if (!handle) {
          handle = document.createElement('span');
          handle.className = 'kexo-sticky-resize-handle';
          handle.setAttribute('aria-hidden', 'true');
          handle.setAttribute('data-no-drag-scroll', '1');
          var iconEl = document.createElement('i');
          iconEl.setAttribute('data-icon-key', 'table-sticky-resize-handle');
          iconEl.setAttribute('aria-hidden', 'true');
          handle.appendChild(iconEl);
          cell.appendChild(handle);
        }
        bindHandle(wrap, handle);
      }
      function debouncedEnsureHandle(wrap) {
        if (!wrap) return;
        try {
          if (wrap._stickyEnsureHandleTimer != null) clearTimeout(wrap._stickyEnsureHandleTimer);
          wrap._stickyEnsureHandleTimer = setTimeout(function() {
            wrap._stickyEnsureHandleTimer = null;
            ensureHandle(wrap);
          }, STICKY_DEBOUNCE_MS);
        } catch (_) {}
      }

      function bind(wrap) {
        if (!wrap) return;
        // Latest Sales (Live View) is intentionally not sticky/resizable.
        try {
          var tid = String(getWrapTableId(wrap) || '').trim().toLowerCase();
          if (tid === 'latest-sales-table') return;
        } catch (_) {}
        try { wrap.classList.add('kexo-sticky-wrap'); } catch (_) {}
        applyWidthSingle(wrap, readSavedWidth(wrap));
        ensureHandle(wrap);
        if (wrap.getAttribute('data-sticky-resize-wrap-bound') === '1') return;
        wrap.setAttribute('data-sticky-resize-wrap-bound', '1');
        if (typeof ResizeObserver !== 'undefined') {
          try {
            var ro = new ResizeObserver(function() {
              applyWidthSingle(wrap, wrapWidth(wrap));
              debouncedEnsureHandle(wrap);
            });
            ro.observe(wrap);
            wrap._stickyResizeObserver = ro;
          } catch (_) {}
        }
        if (typeof MutationObserver !== 'undefined') {
          try {
            var mo = new MutationObserver(function() { debouncedEnsureHandle(wrap); });
            mo.observe(wrap, { childList: true, subtree: true });
            wrap._stickyResizeMutationObserver = mo;
          } catch (_) {}
        }
      }

      function run() {
        document.querySelectorAll(WRAP_SELECTOR).forEach(function(wrap) { bind(wrap); });
      }
      try { window.__kexoRunStickyColumnResize = run; } catch (_) {}
      try {
        window.addEventListener('kexo:tablesUiConfigApplied', function() { run(); });
      } catch (_) {}

      var docMo = null;
      function initStickyDocObserver() {
        if (docMo) return;
        if (typeof MutationObserver === 'undefined') return;
        try {
          docMo = new MutationObserver(function(muts) {
            muts.forEach(function(m) {
              (m.addedNodes || []).forEach(function(n) {
                if (!(n instanceof Element)) return;
                try {
                  if (n.matches && n.matches(WRAP_SELECTOR)) bind(n);
                } catch (_) {}
                try {
                  if (n.querySelectorAll) n.querySelectorAll(WRAP_SELECTOR).forEach(function(w) { bind(w); });
                } catch (_) {}
              });
            });
          });
          docMo.observe(document.documentElement, { childList: true, subtree: true });
          if (typeof registerCleanup === 'function') {
            registerCleanup(function() {
              try { if (docMo && typeof docMo.disconnect === 'function') docMo.disconnect(); } catch (_) {}
              docMo = null;
            });
          }
        } catch (_) {}
      }
      try { window.__kexoInitStickyDocObserver = initStickyDocObserver; } catch (_) {}
      initStickyDocObserver();

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', run);
      } else {
        run();
      }
      setTimeout(run, 700);
      setTimeout(run, 1800);
    })();

    function getKpiData() {
      const statsRange = getStatsRange();
      if (kpiCache && kpiCacheRange === statsRange) return kpiCache;
      if (statsRange === 'today') return {};
      return statsCache || {};
    }
    let activeMainTab = 'spy';
    let nextLiveAt = 0;
    let nextRangeAt = 0; // next refresh for Today/Sales (5 min)
    let lastSessionsFetchedAt = 0;
    let lastSessionsMode = null; // 'live' or 'range' - helps avoid Online count flicker when switching modes
    let lastStatsFetchedAt = 0;
    let lastKpisFetchedAt = 0;
    let lastAttributionFetchedAt = 0;
    let lastDevicesFetchedAt = 0;
    let lastBrowsersFetchedAt = 0;
    let lastProductsFetchedAt = 0;
    let kpiCache = null;
    let kpiCacheRange = '';
    let kpiCacheSource = '';
    let liveRefreshInFlight = null;
    let liveSalesPollTimer = null;
    let liveSalesPollInFlight = null;
    let liveSalesPendingPayload = null;
    let liveSalesPendingAt = 0;
    let statsRefreshInFlight = null;
    let attributionRefreshInFlight = null;
    let devicesRefreshInFlight = null;
    let browsersRefreshInFlight = null;
    let productsRefreshInFlight = null;
    let kpisRefreshInFlight = null;
    let kpisRefreshRangeKey = '';
    let configStatusRefreshInFlight = null;
    let activeKpiCompareKey = 'conv';
    let reportBuildTokens = { stats: 0, breakdown: 0, products: 0, attribution: 0, devices: 0, sessions: 0, diagnostics: 0, kpiCompare: 0, dashboard: 0 };
    var _intervals = [];
    var _eventSource = null;
    var _fetchAbortControllers = {};
    let lastUpdateTime = null;
    let lastConvertedCountToday = 0;
    let hasSeenConvertedCountToday = false; // prevents "sale" triggers on first load
    let convertedCountDayYmd = null; // YYYY-MM-DD in admin TZ; resets converted-count baseline daily
    let lastSaleAt = null; // ms; authoritative timestamp of most recent sale we know about (Shopify truth preferred)
    let lastOnlineCount = null; // when dateRange !== 'live', we fetch active count so Online always shows real people online
    let onlineCountInFlight = false;
    let onlineCountLastFetchedAt = 0;
    let onlineCountPollTimer = null;
    let onlineCountAuthBlocked = false;
    const ONLINE_COUNT_POLL_MS = 15000;
    const ONLINE_COUNT_RETRY_MS = 30000;
    let liveOnlineChart = null;
    let liveOnlineChartType = '';
    let liveOnlineChartFetchedAt = 0;
    let liveOnlineChartInFlight = null;
    let liveOnlineMapChartInstance = null;
    let liveOnlineMapSessions = [];
    let liveOnlineMapSessionsFetchedAt = 0;
    let liveOnlineMapSessionsInFlight = null;
    let rangeOverviewChart = null;
    let rangeOverviewChartKey = '';
    let rangeOverviewChartInFlight = null;
    let abandonedCartsChart = null;
    let abandonedCartsChartKey = '';
    let abandonedCartsChartInFlight = null;
    let abandonedCartsChartInFlightKey = '';
    let abandonedCartsChartReqSeq = 0;
    let abandonedCartsSeriesCache = {};
    let abandonedCartsSeriesCacheOrder = [];
    let abandonedCartsSeriesPrefetchInFlight = {};
    const ABANDONED_CARTS_SERIES_CACHE_MAX = 12;
    let abandonedCartsTopCacheKey = '';
    let abandonedCartsTopCountriesCache = null;
    let abandonedCartsTopCountryProductsCache = null;
    let abandonedCartsTopInFlight = null;
    let shopifySalesToday = null;
    let shopifyOrderCountToday = null;
    let shopifySalesTodayLoaded = false; // true once we have attempted to fetch (success or failure)
    let shopifySalesTodayLoading = false;
    let shopifySessionsToday = null;
    let shopifySessionsTodayLoaded = false;
    let shopifySessionsTodayLoading = false;
    let dashCache = null;
    const PRODUCTS_LEADERBOARD_VIEW_KEY = 'products-leaderboard-view';
    const PRODUCTS_LEADERBOARD_FETCH_LIMIT = 20;
    let productsLeaderboardView = 'title';
    let leaderboardCache = null;
    let leaderboardLoading = false;
    const PRODUCTS_VARIANT_CARDS_VIEW_KEY = 'products-variant-cards-view';
    let productsVariantCardsView = 'finishes';
    let finishesCache = null;
    let finishesLoading = false;
    let lengthsCache = null;
    let lengthsLoading = false;
    let chainStylesCache = null;
    let chainStylesLoading = false;
    let bestSellersCache = null;
    let bestVariantsCache = null;
    let countryPage = 1;
    let lastCountryRowCount = 0;
    let bestGeoProductsPage = 1;
    let bestSellersPage = 1;
    let bestVariantsPage = 1;
    let attributionPage = 1;
    let devicesPage = 1;
    let browsersPage = 1;
    let dashTopProductsPage = 1;
    let dashTopCountriesPage = 1;
    let dashTrendingPage = 1;
    let bestSellersSortBy = 'rev';
    let bestSellersSortDir = 'desc';
    const tableSortState = {
      country: { by: 'rev', dir: 'desc' },
      bestGeoProducts: { by: 'rev', dir: 'desc' },
      aov: { by: 'aov', dir: 'desc' },
      bestVariants: { by: 'rev', dir: 'desc' },
      attribution: { by: 'rev', dir: 'desc' },
      devices: { by: 'rev', dir: 'desc' },
      browsers: { by: 'rev', dir: 'desc' },
    };
    const TABLE_SORT_DEFAULTS = {
      country: { country: 'asc', cr: 'desc', sales: 'desc', clicks: 'desc', rev: 'desc' },
      bestGeoProducts: { country: 'asc', cr: 'desc', sales: 'desc', clicks: 'desc', rev: 'desc' },
      aov: { aov: 'desc' },
      bestVariants: { variant: 'asc', sales: 'desc', clicks: 'desc', rev: 'desc', cr: 'desc' },
      attribution: { attribution: 'asc', cr: 'desc', orders: 'desc', sessions: 'desc', rev: 'desc' },
      devices: { device: 'asc', cr: 'desc', orders: 'desc', sessions: 'desc', rev: 'desc' },
      browsers: { browser: 'asc', cr: 'desc', orders: 'desc', carts: 'desc', sessions: 'desc', aov: 'desc', vpv: 'desc', rev: 'desc' },
    };

    function rerenderDashboardFromCache() {
      try {
        if (typeof window.refreshDashboard === 'function') {
          window.refreshDashboard({ force: false, silent: true, rerender: true });
          return true;
        }
      } catch (_) {}
      return false;
    }

    function applyTableRowsPerPageChange(tableId, rows) {
      var id = String(tableId == null ? '' : tableId).trim();
      var n = Number(rows);
      if (!id || !Number.isFinite(n)) return;
      if (id === 'sessions-table') {
        rowsPerPage = n;
        currentPage = 1;
        if (sessionsTotal != null) fetchSessions();
        else renderTable();
        return;
      }
      if (id === 'best-sellers-table') {
        bestSellersPage = 1;
        fetchBestSellers({ force: true });
        return;
      }
      if (id === 'best-variants-table') {
        bestVariantsPage = 1;
        fetchBestVariants({ force: true });
        return;
      }
      if (id === 'country-table') {
        countryPage = 1;
        renderCountry(statsCache || {});
        return;
      }
      if (id === 'best-geo-products-table') {
        bestGeoProductsPage = 1;
        renderBestGeoProducts(statsCache || {});
        return;
      }
      if (id === 'attribution-table') {
        attributionPage = 1;
        try { renderAttributionTables(attributionCache || {}); } catch (_) {}
        return;
      }
      if (id === 'devices-table') {
        devicesPage = 1;
        try { renderDevicesTables(devicesCache || {}); } catch (_) {}
        return;
      }
      if (id === 'browsers-table') {
        browsersPage = 1;
        try { renderBrowsersTables(browsersCache || {}); } catch (_) {}
        return;
      }
      if (id === 'dash-top-products') {
        dashTopProductsPage = 1;
        rerenderDashboardFromCache();
        return;
      }
      if (id === 'dash-top-countries') {
        dashTopCountriesPage = 1;
        rerenderDashboardFromCache();
        return;
      }
      if (id === 'dash-trending') {
        dashTrendingPage = 1;
        rerenderDashboardFromCache();
        return;
      }
      var typeMatch = id.match(/^type-([a-z0-9-]+)-table$/i);
      if (typeMatch && typeMatch[1]) {
        var typeId = String(typeMatch[1]).toLowerCase();
        typeTablePages[typeId] = 1;
        var def = TYPE_TABLE_DEFS.find(function(d) { return d && d.id === typeId; });
        if (def) renderTypeTable(leaderboardCache, def);
        return;
      }
      try {
        if (typeof window.__adsRowsPerPageChanged === 'function') {
          window.__adsRowsPerPageChanged(id, n);
        }
      } catch (_) {}
    }
    let saleAudio = null;
    let saleMuted = false;
    let saleAudioPrimed = false;
    let saleSoundDeferredOnce = false;
    let saleSoundDeferredHandler = null;
    let saleSoundLastOrigin = '';
    let saleSoundLastKey = '';
    let saleSoundLastAt = 0;
    const SALE_SOUND_DEDUPE_WINDOW_MS = 8000;
    const SALE_TOAST_SEEN_STORAGE_KEY = 'kexo:sale-toast-seen:v1';
    const SALE_TOAST_SEEN_KEY_MAX = 500;
    let saleToastSeenKeys = new Set();
    let saleToastSeenOrder = [];
    let saleToastActive = false;
    let saleToastToken = 0; // increments per toast trigger; prevents stale latest-sale fetch overwriting newer toasts
    let saleToastSessionId = null; // best-effort: session_id that opened the current toast (used to avoid double plays)
    let saleToastHideTimer = null;
    let saleToastLastOrderId = null;
    let saleToastLastPayload = null;
    let saleToastPinned = false;
    let saleToastLastShownAt = 0;
    let currentPage = 1;
    let sortBy = 'last_seen';
    let sortDir = 'desc';
    const SORT_DEFAULTS = { landing: 'asc', from: 'asc', arrived: 'desc', source: 'asc', device: 'asc', cart: 'desc', last_seen: 'desc', history: 'desc' };

    (function restoreProductsVariantCardsView() {
      try {
        const raw = sessionStorage.getItem(PRODUCTS_VARIANT_CARDS_VIEW_KEY);
        const s = raw != null ? String(raw).trim().toLowerCase() : '';
        productsVariantCardsView = (s === 'lengths' || s === 'length') ? 'lengths' : 'finishes';
      } catch (_) {
        productsVariantCardsView = 'finishes';
      }
    })();

    (function restoreProductsLeaderboardView() {
      try {
        const raw = sessionStorage.getItem(PRODUCTS_LEADERBOARD_VIEW_KEY);
        const s = raw != null ? String(raw).trim().toLowerCase() : '';
        productsLeaderboardView = (s === 'type') ? 'type' : 'title';
      } catch (_) {
        productsLeaderboardView = 'title';
      }
    })();

    // Auto-configure pixel when opened from Shopify (shop in URL) so merchants don't run mutations manually
    (function ensurePixelOnce() {
      const params = new URLSearchParams(window.location.search);
      const shop = params.get('shop');
      if (shop && /\.myshopify\.com$/i.test(shop)) {
        fetch(API + '/api/pixel/ensure?shop=' + encodeURIComponent(shop), { credentials: 'same-origin' })
          .then(function (r) { return r.json(); })
          .then(function (data) {
            if (data.ok && data.action) console.log('[Live Visitors] Pixel', data.action);
          })
          .catch(function () {});
      }
    })();
    // 'active' = Live view (last 5 min + arrived 60 min). Range mode uses ?range= with pagination.
    let filter = 'active';
    let sessionsTotal = null; // set when fetching by range (today/yesterday/3d/7d); null for Live
    let selectedSessionId = null;
    let timeTick = null;
    const tz = 'Europe/London';
    const MIN_YMD = '2025-02-01';

    function floorAllowsYesterday() {
      try {
        return ymdNowInTz() > MIN_YMD;
      } catch (_) {
        return true;
      }
    }

    function updateServerTimeDisplay() {
      const el = document.getElementById('server-time-msg');
      if (!el) return;
      var now = new Date();
      el.textContent = now.toLocaleTimeString('en-GB', { timeZone: tz, hour: '2-digit', minute: '2-digit', hour12: false });
    }

    function updateNextUpdateUi() {
      const block = document.querySelector('#tab-panel-spy .next-update-block');
      if (!block) {
        // Recent Sales no longer shows the next-update UI; don't let queued payloads get stuck.
        try {
          if (liveSalesPendingPayload && typeof liveSalesCanAutoApply === 'function' && liveSalesCanAutoApply()) {
            applyLiveSalesPending();
          }
        } catch (_) {}
        return;
      }
      const labelEl = document.getElementById('next-update-label');
      const timerWrap = document.getElementById('next-update-timer-wrap');
      const isSales = PAGE === 'sales';
      const show = activeMainTab === 'sales' && isSales;
      block.classList.toggle('is-hidden', !show);
      if (!show) return;

      // "Updates available" CTA when polling is paused (sorting/paging).
      const hasPending = !!liveSalesPendingPayload;
      let pendingBtn = document.getElementById('live-sales-updates-btn');
      if (!pendingBtn) {
        try {
          pendingBtn = document.createElement('button');
          pendingBtn.type = 'button';
          pendingBtn.id = 'live-sales-updates-btn';
          pendingBtn.className = 'btn btn-sm btn-outline-primary is-hidden';
          pendingBtn.textContent = 'Updates available';
          block.appendChild(pendingBtn);
        } catch (_) { pendingBtn = null; }
      }
      if (pendingBtn && pendingBtn.getAttribute('data-bound') !== '1') {
        try {
          pendingBtn.setAttribute('data-bound', '1');
          pendingBtn.addEventListener('click', function(e) {
            if (e && typeof e.preventDefault === 'function') e.preventDefault();
            applyLiveSalesPending();
          });
        } catch (_) {}
      }

      if (hasPending && pendingBtn) {
        try { pendingBtn.classList.remove('is-hidden'); } catch (_) {}
        if (labelEl) labelEl.classList.add('is-hidden');
        if (timerWrap) timerWrap.classList.add('is-hidden');
        return;
      } else if (pendingBtn) {
        try { pendingBtn.classList.add('is-hidden'); } catch (_) {}
      }

      if (labelEl) labelEl.classList.remove('is-hidden');
      if (timerWrap) timerWrap.classList.remove('is-hidden');
      if (!timerWrap) return;

      const duration = LIVE_SALES_POLL_MS;
      const target = (typeof nextLiveAt === 'number' && nextLiveAt > Date.now())
        ? nextLiveAt
        : (typeof nextRangeAt === 'number' && nextRangeAt > Date.now())
          ? nextRangeAt
          : (Date.now() + duration);
      const remaining = Math.max(0, target - Date.now());
      const progress = Math.min(1, 1 - remaining / duration);
      timerWrap.style.setProperty('--progress', String(progress));
    }

    function toMs(v) {
      if (v == null || v === '') return null;
      let n = typeof v === 'number' ? v : Number(v);
      if (Number.isNaN(n)) return null;
      if (n < 1e12) n *= 1000;
      return n;
    }

    function formatTs(ms) {
      const n = toMs(ms);
      if (n == null) return '\u2014';
      const d = new Date(n);
      if (Number.isNaN(d.getTime())) return '\u2014';
      return d.toLocaleString('en-GB', { timeZone: tz, dateStyle: 'short', timeStyle: 'short' });
    }

    function formatRelative(ms) {
      const n = toMs(ms);
      if (n == null) return '';
      const s = Math.floor((Date.now() - n) / 1000);
      if (s < 0) return 'now';
      if (s < 60) return s + 's ago';
      if (s < 3600) return Math.floor(s / 60) + 'm ago';
      if (s < 86400) return Math.floor(s / 3600) + 'h ago';
      var d = Math.floor(s / 86400);
      return d + (d === 1 ? ' day' : ' days') + ' ago';
    }

    function formatExitDelta(ms) {
      var n = typeof ms === 'number' ? ms : Number(ms);
      if (!Number.isFinite(n) || n < 0) return '\u2014';
      var s = Math.round(n / 1000);
      if (s < 60) return String(s) + 's';
      var m = Math.floor(s / 60);
      var rem = s % 60;
      if (m < 60) return String(m) + 'm ' + String(rem) + 's';
      var h = Math.floor(m / 60);
      var remM = m % 60;
      return String(h) + 'h ' + String(remM) + 'm';
    }

    function sessionActionsCount(s) {
      var n = s && s.actions_count != null ? Number(s.actions_count) : null;
      if (typeof n !== 'number' || !Number.isFinite(n) || n < 0) return 0;
      return Math.round(n);
    }

    function sessionExitLabel(s) {
      // Live view: still active, no meaningful "exit" yet.
      if (sessionsTotal == null && filter === 'active') return 'Live';
      var lastSeen = toMs(s && s.last_seen);
      var lastAction = toMs(s && s.last_action_ts);
      var lastEvent = toMs(s && s.last_event_ts);
      var baseline = lastAction != null ? lastAction : lastEvent;
      if (lastSeen == null || baseline == null) return '\u2014';
      var delta = lastSeen - baseline;
      if (!Number.isFinite(delta) || delta < 0) return '\u2014';
      return formatExitDelta(delta);
    }

    function formatSaleTime(ms) {
      const n = toMs(ms);
      if (n == null) return '\u2014';
      const d = new Date(n);
      if (Number.isNaN(d.getTime())) return '\u2014';
      try {
        return d.toLocaleTimeString('en-GB', { timeZone: tz, hour: '2-digit', minute: '2-digit', hour12: false });
      } catch (_) {
        return d.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', hour12: false });
      }
    }

    function ymdNowInTz() {
      try {
        // en-CA yields YYYY-MM-DD.
        return new Intl.DateTimeFormat('en-CA', { timeZone: tz, year: 'numeric', month: '2-digit', day: '2-digit' }).format(new Date());
      } catch (_) {
        return new Date().toISOString().slice(0, 10);
      }
    }

    function updateLastSaleAgo() {
      var els = document.querySelectorAll('.last-sale-ago');
      if (!els.length) return;
      var text = lastSaleAt == null ? '\u2014' : formatRelative(lastSaleAt);
      els.forEach(function(el) { el.textContent = text; });
    }

    function setLastSaleAt(ms) {
      const n = toMs(ms);
      if (n == null) return;
      const cur = lastSaleAt == null ? null : toMs(lastSaleAt);
      if (cur == null || n > cur) {
        lastSaleAt = n;
        updateLastSaleAgo();
      }
    }

    function formatDuration(startMs) {
      const n = toMs(startMs);
      if (n == null) return '';
      const s = Math.floor((Date.now() - n) / 1000);
      const m = Math.floor(s / 60);
      const h = Math.floor(m / 60);
      if (h > 0) return h + 'h ' + (m % 60) + 'm';
      if (m > 0) return m + 'm ' + (s % 60) + 's';
      return s + 's';
    }

    var countryNames = { GB: 'UK', US: 'USA', CA: 'CA', AU: 'AU', DE: 'DE', FR: 'FR', IE: 'IE', ES: 'ES', IT: 'IT', NL: 'NL', IN: 'IN', JP: 'JP', DK: 'DK', SE: 'SE', NO: 'NO', TH: 'TH', NZ: 'NZ', RO: 'RO', BE: 'BE', FI: 'FI', AE: 'UAE', XX: '\u2014' };
    var countryNamesFull = { GB: 'United Kingdom', US: 'United States', CA: 'Canada', AU: 'Australia', DE: 'Germany', FR: 'France', IE: 'Ireland', ES: 'Spain', IT: 'Italy', NL: 'Netherlands', IN: 'India', JP: 'Japan', DK: 'Denmark', SE: 'Sweden', NO: 'Norway', TH: 'Thailand', NZ: 'New Zealand', RO: 'Romania', BE: 'Belgium', FI: 'Finland', AE: 'United Arab Emirates', XX: '\u2014' };

    function countryLabel(code) {
      if (!code) return 'Unknown';
      var c = (code || 'XX').toUpperCase().slice(0, 2);
      return countryNames[c] || c;
    }

    function countryLabelFull(code) {
      if (!code) return 'Unknown';
      var c = (code || 'XX').toUpperCase().slice(0, 2);
      return countryNamesFull[c] || countryNames[c] || c;
    }

    // Add width=100 to hotlinked images (? or & depending on existing params).
    function hotImg(url) {
      if (typeof url !== 'string') return url;
      if (/[?&]width=/i.test(url)) return url;
      if (/^https?:\/\//i.test(url)) {
        try {
          const u = new URL(url);
          u.searchParams.set('width', '100');
          return u.toString();
        } catch (_) {
          return url + (url.indexOf('?') >= 0 ? '&' : '?') + 'width=100';
        }
      }
      return url + (url.indexOf('?') >= 0 ? '&' : '?') + 'width=100';
    }
    // Product thumbs: request square (width + height) so object-fit: cover gives identical framing.
    function hotImgSquare(url) {
      if (typeof url !== 'string') return url;
      if (/^https?:\/\//i.test(url)) {
        try {
          const u = new URL(url);
          u.searchParams.set('width', '100');
          u.searchParams.set('height', '100');
          if (u.hostname.includes('shopify.com')) u.searchParams.set('crop', 'center');
          return u.toString();
        } catch (_) {
          const sep = url.indexOf('?') >= 0 ? '&' : '?';
          return url + sep + 'width=100&height=100';
        }
      }
      return url + (url.indexOf('?') >= 0 ? '&' : '?') + 'width=100&height=100';
    }

    function flagImg(code, label) {
      const raw = (code || '').toString().trim().toLowerCase();
      const safeLabel = label != null ? String(label) : (code ? String(code) : '?');
      const titleAttr = label ? ' title="' + escapeHtml(safeLabel) + '"' : '';
      if (!raw || raw === 'xx' || !/^[a-z]{2}$/.test(raw)) {
        return '<span class="kexo-flag-fallback" style="display:inline-flex;align-items:center;justify-content:center;width:1rem;height:1rem;opacity:.8"' + titleAttr + ' aria-label="' + escapeHtml(safeLabel) + '"><i class="fa-light fa-globe"></i></span>';
      }
      return '<span class="flag flag-xs flag-country-' + raw + '"' + titleAttr + ' aria-label="' + escapeHtml(safeLabel) + '"></span>';
    }

    function flagImgSmall(code) {
      const raw = (code || '').toString().trim().toLowerCase();
      if (!raw || raw === 'xx' || !/^[a-z]{2}$/.test(raw)) {
        return '<span class="kexo-flag-fallback" style="display:inline-flex;align-items:center;justify-content:center;width:1rem;height:1rem;opacity:.8" aria-hidden="true"><i class="fa-light fa-globe"></i></span>';
      }
      return '<span class="flag flag-xs flag-country-' + raw + '" aria-hidden="true"></span>';
    }

    function arrivedAgo(startedAt) {
      var n = toMs(startedAt);
      if (n == null) return '\u2014';
      var s = Math.floor((Date.now() - n) / 1000);
      if (s < 0) return 'now';
      if (s < 60) return s + 's';
      if (s < 3600) return Math.floor(s / 60) + 'm';
      if (s < 86400) return Math.floor(s / 3600) + 'h';
      var d = Math.floor(s / 86400);
      return d + 'd';
    }

    var storeBaseUrlFallback = '';
    var mainBaseUrlFallback = '';
    var assetsBaseUrlFallback = '';
    var shopForSalesFallback = '';
    var storeBaseUrlLoaded = false;
    (function fetchStoreBaseUrl() {
      fetch(API + '/api/store-base-url', { credentials: 'same-origin' })
        .then(function(r) { return r.json(); })
        .then(function(d) {
          if (d) {
            if (d.baseUrl) storeBaseUrlFallback = d.baseUrl;
            if (d.mainBaseUrl) mainBaseUrlFallback = d.mainBaseUrl;
            if (d.assetsBaseUrl) assetsBaseUrlFallback = d.assetsBaseUrl;
            if (d.shopForSales) shopForSalesFallback = d.shopForSales;
            if (sessions.length) renderTable();
            if (assetsBaseUrlFallback) {
              var link = document.querySelector('link[rel="icon"]');
              if (link) link.href = '/assets/logos/new/kexo.webp';
              if (typeof saleAudio !== 'undefined' && saleAudio && typeof getCashRegisterMp3Url === 'function') {
                setSaleAudioSrc(getCashRegisterMp3Url());
              }
            }
            if (shopForSalesFallback) {
              if (activeMainTab === 'products' && typeof refreshProducts === 'function') refreshProducts({ force: false });
              if (activeMainTab === 'stats' && typeof refreshStats === 'function') refreshStats({ force: false });
              if (activeMainTab === 'attribution' && typeof refreshAttribution === 'function') refreshAttribution({ force: false });
              if (activeMainTab === 'devices' && typeof refreshDevices === 'function') refreshDevices({ force: false });
              if (activeMainTab === 'browsers' && typeof refreshBrowsers === 'function') refreshBrowsers({ force: false });
              if (typeof requestDashboardWidgetsRefresh === 'function') requestDashboardWidgetsRefresh({ force: false });
            }
          }
          storeBaseUrlLoaded = true;
          if (typeof renderSales === 'function') renderSales(statsCache);
        })
        .catch(function() { storeBaseUrlLoaded = true; if (typeof renderSales === 'function') renderSales(statsCache); });
    })();

    function getShopForSales() {
      var shop = getShopParam() || shopForSalesFallback || null;
      return shop && /\.myshopify\.com$/i.test(shop) ? shop : null;
    }

    function getStoreBaseUrl() {
      var params = new URLSearchParams(window.location.search);
      var shop = params.get('shop');
      if (shop && /\.myshopify\.com$/i.test(shop)) return 'https://' + shop;
      return storeBaseUrlFallback || '';
    }
    function getMainBaseUrl() {
      if (mainBaseUrlFallback) return mainBaseUrlFallback;
      return getStoreBaseUrl();
    }
    function getAssetsBase() {
      if (assetsBaseUrlFallback) return assetsBaseUrlFallback;
      return (API || '') + '/assets';
    }

    var HICON_URL = hotImg('https://cdn.shopify.com/s/files/1/0847/7261/8587/files/hicon.webp?v=1770084894');
    var DOLLAR_URL = hotImg('https://cdn.shopify.com/s/files/1/0847/7261/8587/files/dollar.png?v=1770085223');
    // Sale toast chime: prefer assetOverrides.saleSound, then assets base, else local default.
    var DEFAULT_SALE_SOUND = '/assets/ui-alert/1.mp3';
    var CASH_REGISTER_MP3_CDN = 'https://cdn.shopify.com/s/files/1/0847/7261/8587/files/cash-register.mp3?v=1770171264';
    function getCashRegisterMp3Url() {
      try {
        var override = (typeof window !== 'undefined' && window.__kexoSaleSoundOverrideUrl) ? String(window.__kexoSaleSoundOverrideUrl).trim() : '';
        if (override && /^https?:\/\//i.test(override)) return override;
        if (override && override.charAt(0) === '/') return override;
      } catch (_) {}
      var defaultAssetsBase = (API || '') + '/assets';
      var assetsBase = '';
      try {
        assetsBase = typeof getAssetsBase === 'function' ? String(getAssetsBase() || '').trim() : '';
      } catch (_) {
        assetsBase = '';
      }
      // Only use a custom assets host/path when it is explicitly configured.
      if (assetsBase && assetsBase !== defaultAssetsBase) {
        return assetsBase.replace(/\/+$/, '') + '/ui-alert/1.mp3';
      }
      return DEFAULT_SALE_SOUND;
    }

    function bindSaleAudioFallback() {
      if (!saleAudio) return;
      try {
        var a = saleAudio;
        if (a.__kexoSaleAudioOnError) {
          try { a.removeEventListener('error', a.__kexoSaleAudioOnError); } catch (_) {}
        }
        a.__kexoSaleAudioOnError = function() {
          try {
            if (!a || !DEFAULT_SALE_SOUND) return;
            var cur = String(a.currentSrc || a.src || '');
            if (cur && cur.indexOf(DEFAULT_SALE_SOUND) >= 0) return;
            a.src = DEFAULT_SALE_SOUND;
            try { a.load(); } catch (_) {}
          } catch (_) {}
        };
        a.addEventListener('error', a.__kexoSaleAudioOnError);
      } catch (_) {}
    }

    function setSaleAudioSrc(nextUrl) {
      if (!saleAudio) return;
      var url = nextUrl != null ? String(nextUrl) : '';
      if (!url) return;
      bindSaleAudioFallback();
      try {
        saleAudio.src = url;
        try { saleAudio.load(); } catch (_) {}
      } catch (_) {}
    }

    function titleCaseFromHandle(handle) {
      if (typeof handle !== 'string') return null;
      let s = handle;
      try { s = decodeURIComponent(s); } catch (_) {}
      s = s.replace(/[-_]+/g, ' ').replace(/\s+/g, ' ').trim();
      if (!s) return null;
      return s.split(' ').filter(Boolean).map(function(w) {
        const lower = w.toLowerCase();
        return lower.charAt(0).toUpperCase() + lower.slice(1);
      }).join(' ');
    }

    /** Sort key for landing column: use server-provided landing_title, else path. */
    function landingSortKey(s) {
      var title = (s && s.landing_title != null) ? String(s.landing_title).trim() : '';
      if (title) return title;
      function trimStr(v) { return v != null ? String(v).trim() : ''; }
      var path = trimStr(s && s.first_path);
      var handle = trimStr(s && s.first_product_handle);
      if (!path && handle) path = '/products/' + handle.replace(/^\/+/, '');
      if (path && !path.startsWith('/')) path = '/' + path;
      try { if (/^https?:\/\//i.test(path)) path = new URL(path).pathname || '/'; } catch (_) {}
      path = (path || '').split('#')[0].split('?')[0].replace(/\/+$/, '') || '/';
      return path;
    }

    function visitsCount(s) {
      var n = 0;
      try { n = s && s.returning_count != null ? Number(s.returning_count) : 0; } catch (_) { n = 0; }
      if (!Number.isFinite(n)) n = 0;
      return n + 1;
    }

    function landingPageCell(s) {
      function trimStr(v) { return v != null ? String(v).trim() : ''; }
      function normalizeHandle(v) {
        var h = trimStr(v);
        if (!h) return '';
        h = h.replace(/^\/+/, '').split('#')[0].split('?')[0].trim().toLowerCase();
        if (!h) return '';
        return h.slice(0, 128);
      }
      function handleFromPath(v) {
        var raw = trimStr(v);
        if (!raw) return '';
        try { if (/^https?:\/\//i.test(raw)) raw = new URL(raw).pathname || ''; } catch (_) {}
        var m = raw.match(/\/products\/([^/?#]+)/i);
        return m && m[1] ? normalizeHandle(m[1]) : '';
      }

      var path = '';
      try { path = (s && s.first_path != null && s.first_path !== '' ? s.first_path : (s && s.last_path != null ? s.last_path : '')).trim(); } catch (_) { path = ''; }
      if (path && !path.startsWith('/')) path = '/' + path;
      try { if (/^https?:\/\//i.test(path)) path = new URL(path).pathname || '/'; } catch (_) {}
      path = (path || '').split('#')[0].split('?')[0].replace(/\/+$/, '') || '/';
      var label = (s && s.landing_title != null) ? String(s.landing_title).trim() : '';
      var display = label || path || '\u2014';
      var handle = handleFromPath(s && s.first_path) || handleFromPath(s && s.last_path);
      if (!handle) handle = '';
      var mainBase = getMainBaseUrl();
      var productUrl = (mainBase && handle) ? (mainBase + '/products/' + encodeURIComponent(handle)) : '';

      if (handle && productUrl) {
        var title = label || handle;
        return '<div class="last-action-cell">' +
          '<a class="kexo-product-link js-product-modal-link" href="' + escapeHtml(productUrl) + '" target="_blank" rel="noopener"' +
            ' data-product-handle="' + escapeHtml(handle) + '"' +
            ' data-product-title="' + escapeHtml(title) + '"' +
          '>' + escapeHtml(display) + '</a>' +
        '</div>';
      }

      return '<div class="last-action-cell">' + escapeHtml(display) + '</div>';
    }

    function sourceLabel(s) {
      const parts = [];
      if (s.utm_source && String(s.utm_source).trim()) parts.push('utm_source: ' + escapeHtml(String(s.utm_source).trim()));
      if (s.utm_campaign && String(s.utm_campaign).trim()) parts.push('utm_campaign: ' + escapeHtml(String(s.utm_campaign).trim()));
      if (s.utm_medium && String(s.utm_medium).trim()) parts.push('utm_medium: ' + escapeHtml(String(s.utm_medium).trim()));
      if (s.utm_content && String(s.utm_content).trim()) parts.push('utm_content: ' + escapeHtml(String(s.utm_content).trim()));
      if (s.referrer && String(s.referrer).trim()) parts.push('referrer: ' + escapeHtml(String(s.referrer).trim()));
      return parts.join(' ');
    }

    function sourceUtmString(s) {
      return [s.utm_source, s.utm_campaign, s.utm_medium, s.utm_content].filter(Boolean).join(' ').toLowerCase();
    }

    function isGoogleAdsSource(s) {
      return sourceUtmString(s).indexOf('googleads') !== -1;
    }

    /** Derive friendly source name from referrer URL host (when no UTM). Use for tooltip and to collect images. */
    function sourceReferrerFriendlyLabel(s) {
      const ref = s.referrer && String(s.referrer).trim();
      if (!ref) return null;
      try {
        const u = new URL(ref);
        const host = (u.hostname || '').toLowerCase().replace(/^www\./, '');
        if (!host) return null;
        if (host === 'account.heybigday.com') return 'HeyBigDay Account';
        if (host === 'account.hbdjewellery.com') return 'HBD Account';
        if (host === 'hbdjewellery.com' || host.endsWith('.myshopify.com')) return 'Store';
        if (host.indexOf('omnisend') !== -1) return 'Omnisend';
        if (host.indexOf('google') !== -1) return 'Google';
        if (host.indexOf('facebook') !== -1 || host.indexOf('fb.') === 0 || host === 'fb.com') return 'Facebook';
        if (host.indexOf('instagram') !== -1) return 'Instagram';
        if (host.indexOf('pinterest') !== -1) return 'Pinterest';
        if (host.indexOf('tiktok') !== -1) return 'TikTok';
        if (host.indexOf('twitter') !== -1 || host.indexOf('x.com') !== -1) return 'X (Twitter)';
        if (host.indexOf('youtube') !== -1) return 'YouTube';
        if (host.indexOf('linkedin') !== -1) return 'LinkedIn';
        if (host.indexOf('bing') !== -1) return 'Bing';
        if (host.indexOf('yahoo') !== -1) return 'Yahoo';
        if (host.indexOf('duckduckgo') !== -1) return 'DuckDuckGo';
        return host;
      } catch (_) { return null; }
    }

    function sourceFriendlyLabel(s) {
      const str = sourceUtmString(s);
      if (str) {
        if (str.indexOf('googleads') !== -1) return null;
        if (str.indexOf('google') !== -1) return 'Google';
        if (str.indexOf('bing') !== -1) return 'Bing';
        if (str.indexOf('omnisend') !== -1) return 'Omnisend';
        if (str.indexOf('chatgpt') !== -1 || str.indexOf('chat gpt') !== -1) return 'Chatgpt';
        return null;
      }
      return sourceReferrerFriendlyLabel(s);
    }

    function sourceSortKey(s) {
      try {
        const variant = s && (s.attribution_variant ?? s.attributionVariant) != null ? String(s.attribution_variant ?? s.attributionVariant).trim() : '';
        if (variant) return variant.toLowerCase();
        const source = s && (s.attribution_source ?? s.attributionSource) != null ? String(s.attribution_source ?? s.attributionSource).trim() : '';
        if (source) return source.toLowerCase();
        const channel = s && (s.attribution_channel ?? s.attributionChannel) != null ? String(s.attribution_channel ?? s.attributionChannel).trim() : '';
        if (channel) return channel.toLowerCase();
      } catch (_) {}
      // Fallback: derive from UTMs/referrer (best-effort; older rows may not have attribution yet).
      if (isGoogleAdsSource(s)) return 'google ads';
      const friendly = sourceFriendlyLabel(s);
      if (friendly) return friendly.toLowerCase();
      if (sourceUtmString(s)) return 'other';
      if (s && s.referrer && String(s.referrer).trim()) return 'other';
      return 'direct';
    }

    const SOURCE_GOOGLE_IMG = hotImg('https://cdn.shopify.com/s/files/1/0847/7261/8587/files/google.png?v=1770086632');
    const SOURCE_DIRECT_IMG = hotImg('https://cdn.shopify.com/s/files/1/0847/7261/8587/files/arrow-right.png?v=1770086632');
    const BOUGHT_OVERLAY_SVG = '<i class="fa-light fa-cart-shopping" data-icon-key="live-bought-overlay" aria-hidden="true"></i>';
    const SOURCE_UNKNOWN_IMG = hotImg('https://cdn.shopify.com/s/files/1/0847/7261/8587/files/question.png?v=1770135816');
    const SOURCE_OMNISEND_IMG = hotImg('https://cdn.shopify.com/s/files/1/0847/7261/8587/files/omnisend.png?v=1770141052');
    const SOURCE_BING_IMG = hotImg('https://cdn.shopify.com/s/files/1/0847/7261/8587/files/bing.png?v=1770141094');
    const SOURCE_LIVEVIEW_SOURCE_IMG = hotImg('https://cdn.shopify.com/s/files/1/0847/7261/8587/files/liveview-source-logo.png?v=1770141081');
    function sourceCell(s) {
      function icon(src, alt, title, extraClass) {
        const cls = (extraClass ? (extraClass + ' ') : '') + 'source-icon-img';
        const t = title ? ' title="' + escapeHtml(String(title)) + '"' : '';
        return '<img src="' + escapeHtml(hotImg(src) || src || '') + '" alt="' + escapeHtml(alt || '') + '" class="' + cls + '" width="20" height="20"' + t + '>';
      }

      function iconFromSpec(specRaw, label, extraClass) {
        const spec = specRaw != null ? String(specRaw).trim() : '';
        if (!spec) return '';
        const t = label ? ' title="' + escapeHtml(String(label)) + '"' : '';
        const extra = extraClass ? (' ' + String(extraClass)) : '';
        if (/^<svg[\s>]/i.test(spec)) {
          return '<span class="source-icon-svg' + escapeHtml(extra) + '"' + t + ' aria-hidden="true">' + spec + '</span>';
        }
        if (/^(https?:\/\/|\/\/|\/)/i.test(spec)) {
          return icon(spec, label, label, extraClass);
        }
        return '<i class="' + escapeHtml(spec) + ' source-icon-fa' + escapeHtml(extra) + '"' + t + ' aria-hidden="true"></i>';
      }

      // Acquisition attribution: use persisted `attribution_*` fields (single source of truth).
      const variant = s && (s.attribution_variant ?? s.attributionVariant) != null ? String(s.attribution_variant ?? s.attributionVariant).trim().toLowerCase() : '';
      const channel = s && (s.attribution_channel ?? s.attributionChannel) != null ? String(s.attribution_channel ?? s.attributionChannel).trim().toLowerCase() : '';
      const source = s && (s.attribution_source ?? s.attributionSource) != null ? String(s.attribution_source ?? s.attributionSource).trim().toLowerCase() : '';
      const confidence = s && (s.attribution_confidence ?? s.attributionConfidence) != null ? String(s.attribution_confidence ?? s.attributionConfidence).trim().toLowerCase() : '';

      const labelRaw = variant || (channel && source ? (channel + ' / ' + source) : (channel || source || 'unknown'));
      const title = confidence ? (labelRaw + ' (' + confidence + ')') : labelRaw;
      const head = (variant ? variant.split(':')[0] : channel) || '';

      let spec = '';
      let extraClass = '';
      if (head === 'google_ads' || head === 'google_organic' || head === 'google') {
        spec = SOURCE_GOOGLE_IMG;
        if (head === 'google_ads') extraClass = 'source-googleads-img';
      } else if (head === 'bing_ads' || head === 'bing_organic' || head === 'bing') {
        spec = SOURCE_BING_IMG;
      } else if (head === 'omnisend' || head === 'klaviyo' || head === 'email') {
        spec = SOURCE_OMNISEND_IMG;
      } else if (head.indexOf('meta') >= 0 || head === 'facebook' || head === 'instagram') {
        spec = 'fa-brands fa-facebook';
      } else if (head.indexOf('tiktok') >= 0) {
        spec = 'fa-brands fa-tiktok';
      } else if (head.indexOf('pinterest') >= 0) {
        spec = 'fa-brands fa-pinterest';
      } else if (head.indexOf('affiliate') >= 0 || channel === 'affiliate') {
        spec = 'fa-light fa-handshake';
      } else if (head === 'direct' || channel === 'direct') {
        spec = SOURCE_DIRECT_IMG;
      } else if (head) {
        spec = SOURCE_UNKNOWN_IMG;
      } else {
        spec = SOURCE_UNKNOWN_IMG;
      }

      const html = iconFromSpec(spec || 'fa-light fa-circle-question', title, extraClass);
      return html ? ('<span class="source-icons"><span class="visually-hidden">' + escapeHtml(String(title || '')) + '</span>' + html + '</span>') : '';
    }

    function buildFullEntryUrlForCopy(s) {
      var entry = s && s.entry_url != null ? String(s.entry_url).trim() : '';
      if (!entry) return '';
      try {
        var u = new URL(entry);
        var map = {
          utm_source: s && s.utm_source != null ? String(s.utm_source).trim() : '',
          utm_medium: s && s.utm_medium != null ? String(s.utm_medium).trim() : '',
          utm_campaign: s && s.utm_campaign != null ? String(s.utm_campaign).trim() : '',
          utm_content: s && s.utm_content != null ? String(s.utm_content).trim() : '',
          utm_term: s && s.utm_term != null ? String(s.utm_term).trim() : '',
        };
        Object.keys(map).forEach(function (k) {
          var v = map[k];
          if (!v) return;
          try { if (!u.searchParams.has(k)) u.searchParams.set(k, v); } catch (_) {}
        });
        return u.toString();
      } catch (_) {
        return entry;
      }
    }

    function sourceDetailForPanel(s) {
      function truncateUrlForPanel(raw, maxChars) {
        var txt = raw != null ? String(raw) : '';
        var max = Number.isFinite(Number(maxChars)) ? Math.max(24, Math.trunc(Number(maxChars))) : 160;
        if (txt.length <= max) return txt;
        return txt.slice(0, Math.max(0, max - 5)) + '.....';
      }
      const lines = [];
      const entry = s.entry_url && String(s.entry_url).trim();
      if (entry) {
        const full = buildFullEntryUrlForCopy(s);
        const fullDisplay = truncateUrlForPanel(full, 180);
        const entryDisplay = truncateUrlForPanel(entry, 180);
        if (full && full !== entry) {
          lines.push('URL: ' + fullDisplay);
          lines.push('Entry URL (raw): ' + entryDisplay);
        } else {
          lines.push('URL: ' + entryDisplay);
        }
      }
      const ref = s.referrer && String(s.referrer).trim();
      if (ref) lines.push('Referrer: ' + ref);
      if (s.utm_source != null && String(s.utm_source).trim() !== '') lines.push('utm_source: ' + String(s.utm_source).trim());
      if (s.utm_medium != null && String(s.utm_medium).trim() !== '') lines.push('utm_medium: ' + String(s.utm_medium).trim());
      if (s.utm_campaign != null && String(s.utm_campaign).trim() !== '') lines.push('utm_campaign: ' + String(s.utm_campaign).trim());
      if (s.utm_content != null && String(s.utm_content).trim() !== '') lines.push('utm_content: ' + String(s.utm_content).trim());
      if (lines.length === 0) return '\u2014';
      return lines.join('\n');
    }

    function deviceInfoForSession(s) {
      const uaDeviceTypeRaw = s && (s.ua_device_type ?? s.uaDeviceType) != null ? String(s.ua_device_type ?? s.uaDeviceType) : '';
      const uaPlatformRaw = s && (s.ua_platform ?? s.uaPlatform) != null ? String(s.ua_platform ?? s.uaPlatform) : '';
      const uaModelRaw = s && (s.ua_model ?? s.uaModel) != null ? String(s.ua_model ?? s.uaModel) : '';
      const legacyDeviceRaw = s && s.device != null ? String(s.device) : '';

      function norm(v) { return (v || '').trim().toLowerCase(); }
      function isOneOf(v, list) { return list.indexOf(v) >= 0; }
      function derivePlatformFallback() {
        const d = norm(legacyDeviceRaw);
        if (!d) return '';
        if (d === 'ios') return 'ios';
        if (d === 'android') return 'android';
        if (d === 'windows') return 'windows';
        if (d === 'mac') return 'mac';
        if (d === 'chrome os' || d === 'chromeos') return 'chromeos';
        if (d === 'linux') return 'linux';
        if (d === 'windows phone') return 'windows';
        return '';
      }

      const deviceType = (() => {
        const v = norm(uaDeviceTypeRaw);
        if (isOneOf(v, ['desktop', 'mobile', 'tablet'])) return v;
        return 'unknown';
      })();

      const platform = (() => {
        const v = norm(uaPlatformRaw) || derivePlatformFallback();
        if (isOneOf(v, ['ios', 'android', 'windows', 'mac', 'chromeos', 'linux'])) return v;
        if (v === 'other') return 'other';
        return 'unknown';
      })();

      const model = (() => {
        const v = norm(uaModelRaw);
        if (isOneOf(v, ['iphone', 'ipad'])) return v;
        return '';
      })();

      return { deviceType, platform, model };
    }

    function deviceIconKeyForPlatform(platform) {
      const p = (platform || '').trim().toLowerCase();
      if (p === 'ios') return 'type-platform-ios';
      if (p === 'mac') return 'type-platform-mac';
      if (p === 'android') return 'type-platform-android';
      if (p === 'windows') return 'type-platform-windows';
      if (p === 'chromeos') return 'type-platform-chromeos';
      if (p === 'linux') return 'type-platform-linux';
      return 'type-platform-unknown';
    }

    function deviceIconKeyForDeviceType(deviceType) {
      const d = (deviceType || '').trim().toLowerCase();
      if (d === 'desktop') return 'type-device-desktop';
      if (d === 'mobile') return 'type-device-mobile';
      if (d === 'tablet') return 'type-device-tablet';
      return 'type-device-unknown';
    }

    function deviceSortKey(s) {
      const info = deviceInfoForSession(s);
      return (info.platform + ' ' + (info.model || '') + ' ' + info.deviceType).trim().toLowerCase();
    }

    function deviceCell(s) {
      const info = deviceInfoForSession(s);
      const platformIconKey = deviceIconKeyForPlatform(info.platform);
      const deviceIconKey = deviceIconKeyForDeviceType(info.deviceType);

      function titleize(v) {
        const s = (v || '').trim().toLowerCase();
        if (!s) return '';
        if (s === 'ios') return 'iOS';
        if (s === 'mac') return 'Mac';
        if (s === 'android') return 'Android';
        if (s === 'windows') return 'Windows';
        if (s === 'chromeos') return 'Chrome OS';
        if (s === 'linux') return 'Linux';
        if (s === 'desktop') return 'Desktop';
        if (s === 'mobile') return 'Mobile';
        if (s === 'tablet') return 'Tablet';
        if (s === 'iphone') return 'iPhone';
        if (s === 'ipad') return 'iPad';
        if (s === 'other') return 'Other';
        if (s === 'unknown') return 'Unknown';
        return s;
      }

      const titleParts = [];
      if (info.platform && info.platform !== 'unknown') titleParts.push(titleize(info.platform));
      if (info.model) titleParts.push(titleize(info.model));
      if (info.deviceType && info.deviceType !== 'unknown') titleParts.push(titleize(info.deviceType));
      const title = titleParts.length ? titleParts.join(' - ') : (s && s.device != null ? String(s.device) : 'Unknown');
      const t = title ? ' title="' + escapeHtml(String(title)) + '"' : '';

      return '' +
        '<span class="kexo-device-icons"' + t + '>' +
          '<i class="fa-light fa-circle-question" data-icon-key="' + escapeHtml(platformIconKey) + '" aria-hidden="true"></i>' +
          '<i class="fa-light fa-globe" data-icon-key="' + escapeHtml(deviceIconKey) + '" aria-hidden="true"></i>' +
          '<span class="visually-hidden">' + escapeHtml(String(title || '')) + '</span>' +
        '</span>';
    }

    var liveComplianceMarkersCache = {};
    function getComplianceCellHtmlFromState(hasSale, hasEval, triggered, score) {
      var scoreText = (typeof score === 'number' && Number.isFinite(score)) ? String(Math.trunc(score)) : '';
      var title = hasEval
        ? (triggered
          ? ('Compliance warning' + (scoreText ? (' (score ' + scoreText + ')') : ''))
          : ('Compliance passed' + (scoreText ? (' (score ' + scoreText + ')') : '')))
        : 'Compliance';
      var saleIcon = hasSale
        ? '<i class="fa-solid fa-sterling-sign compliance-sale-icon" data-icon-key="table-icon-converted-sale" aria-hidden="true"></i>'
        : '';
      var statusIcon = '';
      if (hasEval) {
        statusIcon = triggered
          ? '<i class="fa-light fa-triangle-exclamation compliance-status-icon is-warn" data-icon-key="table-icon-compliance-warning" aria-hidden="true"></i>'
          : '<i class="fa-light fa-circle-check compliance-status-icon is-ok" data-icon-key="table-icon-compliance-check" aria-hidden="true"></i>';
      } else {
        statusIcon = '<i class="fa-light fa-magnifying-glass compliance-status-icon is-search" data-icon-key="table-icon-compliance-search" aria-hidden="true"></i>';
      }
      return '<span class="compliance-icons" aria-label="' + escapeHtml(title) + '" title="' + escapeHtml(title) + '">' + saleIcon + statusIcon + '</span>';
    }

    function inferPaymentProviderKeyFromSession(s) {
      try {
        if (!s || !s.has_purchased) return null;
        var candidates = [];
        if (s.payment_method_type != null) candidates.push(String(s.payment_method_type));
        if (s.payment_gateway != null) candidates.push(String(s.payment_gateway));
        if (s.payment_method_name != null) candidates.push(String(s.payment_method_name));
        for (var i = 0; i < candidates.length; i++) {
          var raw = (candidates[i] || '').trim();
          if (!raw) continue;
          var low = raw.toLowerCase();
          if (low.includes('paypal')) return 'paypal';
          if (low.includes('apple') && low.includes('pay')) return 'applepay';
          if (low.includes('google') && low.includes('pay')) return 'google-pay';
          if (low.includes('klarna')) return 'klarna';
          if (low.includes('shop') && low.includes('pay')) return 'shop-pay';
          if (low.includes('visa')) return 'visa';
          if (low.includes('mastercard')) return 'mastercard';
          if (low.includes('american') && low.includes('express')) return 'americanexpress';
          if (typeof normalizePaymentProviderKey === 'function') {
            var k = normalizePaymentProviderKey(raw);
            if (k) {
              var meta = (typeof paymentProviderMeta === 'function') ? paymentProviderMeta(k) : null;
              if (meta && meta.tablerKey) return k;
            }
          }
        }
      } catch (_) {}
      return null;
    }

    function paymentIconHtmlForSession(s) {
      try {
        var k = inferPaymentProviderKeyFromSession(s);
        if (!k) return '';
        var meta = (typeof paymentProviderMeta === 'function') ? paymentProviderMeta(k) : null;
        if (!meta || !meta.tablerKey) return '';
        var cls = (typeof tablerPaymentClassName === 'function') ? tablerPaymentClassName(k) : '';
        if (!cls) return '';
        return '<span class="' + escapeHtml(cls + ' payment-xxs') + '" aria-label="' + escapeHtml(meta.label || '') + '" title="' + escapeHtml(meta.label || '') + '"></span>';
      } catch (_) {
        return '';
      }
    }

    function renderRow(s) {
      const countryCode = s.country_code || 'XX';
      const visits = (s.returning_count != null ? s.returning_count : 0) + 1;
      const visitsLabel = String(visits);
      const actionsLabel = String(sessionActionsCount(s));
      const exitLabel = String(sessionExitLabel(s) || '\u2014');
      const showExit = String(PAGE || '').trim().toLowerCase() !== 'live';
      const exitCell = showExit ? `<div class="grid-cell" role="cell">${escapeHtml(exitLabel)}</div>` : '';
      const cartValueNum = s.cart_value != null ? Number(s.cart_value) : NaN;
      const cartVal = s.has_purchased ? '' : ((s.cart_value != null && !Number.isNaN(cartValueNum))
        ? formatMoney(Math.floor(cartValueNum), s.cart_currency)
        : '');
      const saleVal = s.has_purchased ? formatMoney(s.order_total != null ? Number(s.order_total) : null, s.order_currency) : '';
      const paymentIcon = s.has_purchased ? paymentIconHtmlForSession(s) : '';
      const cartOrSaleCell = s.has_purchased
        ? ('<span class="d-inline-flex align-items-center gap-2">' +
            '<span class="cart-value-sale">' + escapeHtml(saleVal) + '</span>' +
            paymentIcon +
          '</span>')
        : cartVal;
      const cached = liveComplianceMarkersCache[s.session_id];
      const hasEval = cached ? !!cached.hasEval : false;
      const triggered = cached ? !!cached.triggered : false;
      const score = (cached && cached.score != null) ? Number(cached.score) : null;
      const complianceCellHtml = getComplianceCellHtmlFromState(!!s.has_purchased, hasEval, triggered, score);
      const fromCell = flagImg(countryCode);
      let consentDebug = '';
      if (s && s.meta_json) {
        try {
          const mj = JSON.parse(String(s.meta_json || '{}'));
          consentDebug = (mj && mj.customer_privacy_debug) ? 'yes' : '';
        } catch (_) {}
      }
      return `<div class="grid-row clickable ${s.is_returning ? 'returning' : ''} ${s.has_purchased ? 'converted' : ''}" role="row" data-session-id="${s.session_id}">
        <div class="grid-cell landing-cell" role="cell">${landingPageCell(s)}</div>
        <div class="grid-cell compliance-cell" role="cell">${complianceCellHtml}</div>
        <div class="grid-cell flag-cell" role="cell">${fromCell}</div>
        <div class="grid-cell source-cell" role="cell">${sourceCell(s)}</div>
        <div class="grid-cell device-cell" role="cell">${deviceCell(s)}</div>
        <div class="grid-cell cart-value-cell" role="cell">${cartOrSaleCell}</div>
        <div class="grid-cell arrived-cell" role="cell"><span data-started="${s.started_at}">${arrivedAgo(s.started_at)}</span></div>
        <div class="grid-cell last-seen-cell" role="cell"><span data-last-seen="${s.last_seen}">${arrivedAgo(s.last_seen)}</span></div>
        <div class="grid-cell" role="cell">${escapeHtml(actionsLabel)}</div>
        ${exitCell}
        <div class="grid-cell" role="cell">${visitsLabel}</div>
        <div class="grid-cell consent-debug consent-col is-hidden" role="cell">${escapeHtml(consentDebug)}</div>
      </div>`;
    }

    function escapeHtml(str) {
      if (str == null) return '';
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    function cartSortValue(s) {
      if (s.has_purchased && s.order_total != null) return Number(s.order_total);
      if (s.cart_value != null) { const n = Number(s.cart_value); if (!Number.isNaN(n)) return n; }
      return -Infinity;
    }

    function getSortedSessions() {
      if (!sortBy) return sessions.slice();
      const list = sessions.slice();
      const mult = sortDir === 'asc' ? 1 : -1;
      list.sort(function (a, b) {
        var va, vb;
        if (sortBy === 'landing') {
          va = (landingSortKey(a) || '').toLowerCase();
          vb = (landingSortKey(b) || '').toLowerCase();
          return mult * (va < vb ? -1 : va > vb ? 1 : 0);
        }
        if (sortBy === 'from') {
          va = (a.country_code || 'ZZ').toUpperCase();
          vb = (b.country_code || 'ZZ').toUpperCase();
          return mult * (va < vb ? -1 : va > vb ? 1 : 0);
        }
        if (sortBy === 'arrived') {
          va = toMs(a.started_at) ?? 0;
          vb = toMs(b.started_at) ?? 0;
          return mult * (va - vb);
        }
        if (sortBy === 'source') {
          va = sourceSortKey(a);
          vb = sourceSortKey(b);
          return mult * (va < vb ? -1 : va > vb ? 1 : 0);
        }
        if (sortBy === 'device') {
          va = deviceSortKey(a);
          vb = deviceSortKey(b);
          return mult * (va < vb ? -1 : va > vb ? 1 : 0);
        }
        if (sortBy === 'cart') {
          va = cartSortValue(a);
          vb = cartSortValue(b);
          return mult * (va - vb);
        }
        if (sortBy === 'last_seen') {
          va = toMs(a.last_seen) ?? 0;
          vb = toMs(b.last_seen) ?? 0;
          return mult * (va - vb);
        }
        if (sortBy === 'history') {
          va = visitsCount(a);
          vb = visitsCount(b);
          return mult * (va - vb);
        }
        return 0;
      });
      return list;
    }

    function sessionRowSig(s) {
      try {
        if (!s) return '';
        return [
          s.session_id != null ? String(s.session_id) : '',
          s.last_seen != null ? String(s.last_seen) : '',
          s.started_at != null ? String(s.started_at) : '',
          s.has_purchased ? '1' : '0',
          s.order_total != null ? String(s.order_total) : '',
          s.order_currency != null ? String(s.order_currency) : '',
          s.cart_value != null ? String(s.cart_value) : '',
          s.cart_currency != null ? String(s.cart_currency) : '',
          s.cart_qty != null ? String(s.cart_qty) : '',
          s.device != null ? String(s.device) : '',
          s.country_code != null ? String(s.country_code) : '',
          s.is_returning ? '1' : '0',
          s.returning_count != null ? String(s.returning_count) : '',
          s.last_product_handle != null ? String(s.last_product_handle) : '',
          s.first_product_handle != null ? String(s.first_product_handle) : '',
        ].join('|');
      } catch (_) {
        return '';
      }
    }

    function rowElFromHtml(html) {
      const wrap = document.createElement('div');
      wrap.innerHTML = String(html || '').trim();
      return wrap.firstElementChild;
    }

    var PATCH_CHUNK_SIZE = 12;
    var PATCH_CHUNK_YIELD_THRESHOLD = 15;

    function patchSessionsTableBodySync(tbody, list, existing, hadRows, desired) {
      list.forEach(function(s) {
        const sid = s && s.session_id != null ? String(s.session_id) : '';
        if (!sid) return;
        const sig = sessionRowSig(s);
        const cur = existing.get(sid);
        if (cur && cur.getAttribute('data-kexo-sig') === sig) {
          existing.delete(sid);
          desired.push(cur);
          return;
        }
        const next = rowElFromHtml(renderRow(s));
        if (!next) return;
        try { next.setAttribute('data-kexo-sig', sig); } catch (_) {}
        if (cur && cur.parentNode === tbody) {
          try { cur.replaceWith(next); } catch (_) {}
          if (hadRows) { try { next.classList.add('kexo-row-update'); } catch (_) {} }
        } else {
          if (hadRows) { try { next.classList.add('kexo-row-insert'); } catch (_) {} }
        }
        existing.delete(sid);
        desired.push(next);
      });
    }

    function patchSessionsTableBody(tbody, pageSessions) {
      if (!tbody) return;
      const list = Array.isArray(pageSessions) ? pageSessions : [];
      if (!list.length) return;

      const existing = new Map();
      Array.from(tbody.querySelectorAll('.grid-row[data-session-id]')).forEach(function(row) {
        const sid = row && row.getAttribute ? (row.getAttribute('data-session-id') || '') : '';
        if (sid) existing.set(String(sid), row);
      });
      const hadRows = existing.size > 0;
      const desired = [];

      if (list.length <= PATCH_CHUNK_YIELD_THRESHOLD) {
        patchSessionsTableBodySync(tbody, list, existing, hadRows, desired);
      } else {
        var chunkStart = 0;
        function flushPatch() {
          var cursor = tbody.firstElementChild;
          desired.forEach(function(row) {
            if (!row) return;
            if (row === cursor) {
              cursor = cursor.nextElementSibling;
              return;
            }
            try { tbody.insertBefore(row, cursor); } catch (_) {}
          });
          existing.forEach(function(row) { try { row.remove(); } catch (_) {} });
          try {
            Array.from(tbody.querySelectorAll('.grid-row:not([data-session-id])')).forEach(function(row) { row.remove(); });
          } catch (_) {}
          desired.forEach(function(row) {
            if (!row || !row.classList) return;
            if (!row.classList.contains('kexo-row-insert') && !row.classList.contains('kexo-row-update')) return;
            setTimeout(function() {
              try { row.classList.remove('kexo-row-insert', 'kexo-row-update'); } catch (_) {}
            }, 900);
          });
          try { refreshComplianceMarkersForSessionsTable(); } catch (_) {}
        }
        function doChunk() {
          var chunkEnd = Math.min(chunkStart + PATCH_CHUNK_SIZE, list.length);
          var chunk = list.slice(chunkStart, chunkEnd);
          patchSessionsTableBodySync(tbody, chunk, existing, hadRows, desired);
          chunkStart = chunkEnd;
          if (chunkStart < list.length && typeof requestAnimationFrame === 'function') {
            requestAnimationFrame(doChunk);
            return;
          }
          flushPatch();
        }
        doChunk();
        return;
      }


      var cursor = tbody.firstElementChild;
      desired.forEach(function(row) {
        if (!row) return;
        if (row === cursor) {
          cursor = cursor.nextElementSibling;
          return;
        }
        try { tbody.insertBefore(row, cursor); } catch (_) {}
      });
      existing.forEach(function(row) { try { row.remove(); } catch (_) {} });
      try {
        Array.from(tbody.querySelectorAll('.grid-row:not([data-session-id])')).forEach(function(row) { row.remove(); });
      } catch (_) {}

      try {
        desired.forEach(function(row) {
          if (!row || !row.classList) return;
          if (!row.classList.contains('kexo-row-insert') && !row.classList.contains('kexo-row-update')) return;
          setTimeout(function() {
            try { row.classList.remove('kexo-row-insert', 'kexo-row-update'); } catch (_) {}
          }, 900);
        });
      } catch (_) {}
    }

    function renderTable() {
      const renderStart = typeof performance !== 'undefined' && performance.now ? performance.now() : Date.now();
      const tbody = document.getElementById('table-body');
      if (!tbody) return; // Sessions table not present (e.g. Settings page)
      if (tbody.getAttribute('data-kexo-click-bound') !== '1') {
        try {
          tbody.setAttribute('data-kexo-click-bound', '1');
          tbody.addEventListener('click', function(e) {
            const target = e && e.target ? e.target : null;
            // Clicking interactive elements inside a row should not open the side panel.
            // Product links open the Product Insights modal only.
            if (target && target.closest && target.closest('a.js-product-modal-link')) return;
            const row = target && target.closest ? target.closest('.grid-row.clickable[data-session-id]') : null;
            if (!row || !tbody.contains(row)) return;
            selectedSessionId = row.getAttribute('data-session-id');
            openSidePanel(selectedSessionId);
          });
        } catch (_) {}
      }
      const sorted = getSortedSessions();
      const isRangeMode = sessionsTotal != null;
      const totalPages = isRangeMode
        ? Math.max(1, Math.ceil(sessionsTotal / rowsPerPage))
        : Math.max(1, Math.ceil(sorted.length / rowsPerPage));
      currentPage = Math.min(Math.max(1, currentPage), totalPages);
      const start = (currentPage - 1) * rowsPerPage;
      const pageSessions = isRangeMode ? sorted : sorted.slice(start, start + rowsPerPage);
      if (pageSessions.length === 0) {
        var emptyMsg = sessionsLoadError ? sessionsLoadError : 'No sessions in this view.';
        tbody.innerHTML = '<div class="grid-row" role="row"><div class="grid-cell empty span-all" role="cell">' + escapeHtml(emptyMsg) + '</div></div>';
      } else {
        // Avoid janky full rerenders: patch rows in-place so new rows animate cleanly.
        patchSessionsTableBody(tbody, pageSessions);
      }
      var paginWrap = document.getElementById('table-pagination');
      if (paginWrap) {
        paginWrap.classList.toggle('is-hidden', totalPages <= 1);
        if (totalPages > 1) paginWrap.innerHTML = buildPaginationHtml(currentPage, totalPages);
      }
      const rowsSelect = document.getElementById('rows-per-page-select');
      if (rowsSelect) rowsSelect.value = String(rowsPerPage);
      updateSortHeaders();
      syncSessionsTableTightMode();
      tickTimeOnSite();
      try {
        if (typeof performance !== 'undefined' && performance.now) {
          var ms = Math.round((performance.now() - renderStart) * 100) / 100;
          try { window.__kexoPerfMetrics = window.__kexoPerfMetrics || {}; window.__kexoPerfMetrics.lastTableRenderMs = ms; } catch (_) {}
        }
      } catch (_) {}
      try { refreshComplianceMarkersForSessionsTable(); } catch (_) {}
    }

    // Fraud markers + modal (fail-open; markers fetched in batches).
    var fraudUiBound = false;
    var fraudMarkersFetchInFlight = null; // { key, p }
    var fraudMarkersLastKey = '';
    var fraudMarkersLastAt = 0;

    function buildFraudAlertIconHtml(entityType, entityId, marker) {
      var et = entityType ? String(entityType) : 'session';
      var eid = entityId != null ? String(entityId) : '';
      if (!eid) return '';
      var score = marker && marker.score != null ? Number(marker.score) : null;
      var scoreText = (typeof score === 'number' && Number.isFinite(score)) ? String(Math.trunc(score)) : '';
      var title = scoreText ? ('Fraud alert (score ' + scoreText + ')') : 'Fraud alert';
      return (
        '<i class="fa-light fa-triangle-exclamation fraud-alert-icon"' +
          ' data-icon-key="fraud-alert"' +
          ' data-fraud-open="1"' +
          ' data-fraud-entity-type="' + escapeHtml(et) + '"' +
          ' data-fraud-entity-id="' + escapeHtml(eid) + '"' +
          ' aria-label="' + escapeHtml(title) + '"' +
          ' title="' + escapeHtml(title) + '"' +
        '></i>'
      );
    }

    function fetchFraudMarkers(entityType, ids) {
      var et = entityType ? String(entityType).trim().toLowerCase() : '';
      if (et !== 'session' && et !== 'order') return Promise.resolve({});
      var list = Array.isArray(ids) ? ids.map(function(x) { return x != null ? String(x).trim() : ''; }).filter(Boolean) : [];
      if (!list.length) return Promise.resolve({});
      if (list.length > 200) list = list.slice(0, 200);
      var key = et + ':' + list.join(',');
      if (fraudMarkersFetchInFlight && fraudMarkersFetchInFlight.key === key) return fraudMarkersFetchInFlight.p;
      var url = API + '/api/fraud/markers?entityType=' + encodeURIComponent(et) + '&ids=' + encodeURIComponent(list.join(',')) + '&_=' + Date.now();
      var p = fetch(url, { credentials: 'same-origin', cache: 'no-store' })
        .then(function(r) { return r.ok ? r.json() : null; })
        .then(function(json) { return (json && typeof json === 'object') ? json : {}; })
        .catch(function(err) {
          try { if (typeof window.kexoCaptureError === 'function') window.kexoCaptureError(err, { context: 'fraudMarkersFetch', page: (document.body && document.body.getAttribute('data-page')) || '' }); } catch (_) {}
          return {};
        })
        .finally(function() { if (fraudMarkersFetchInFlight && fraudMarkersFetchInFlight.key === key) fraudMarkersFetchInFlight = null; });
      fraudMarkersFetchInFlight = { key: key, p: p };
      return p;
    }

    var complianceHelpGlobalBound = false;
    function ensureComplianceHeaderUi() {
      var table = document.getElementById('sessions-table');
      if (!table || !table.querySelector) return;
      var th = table.querySelector('.grid-row--header .grid-cell.compliance-cell');
      if (!th) return;
      if (th.getAttribute('data-compliance-header') === '1') return;
      th.setAttribute('data-compliance-header', '1');
      th.innerHTML = '<i class="compliance-header-icon" data-icon-key="table-icon-compliance-header" aria-hidden="true"></i>';
    }

    function complianceCellHtml(sessionId, options) {
      var sid = sessionId != null ? String(sessionId) : '';
      if (!sid) return '';
      var opts = options && typeof options === 'object' ? options : {};
      return getComplianceCellHtmlFromState(!!opts.hasSale, !!opts.hasEval, !!opts.triggered, opts.score != null ? Number(opts.score) : null);
    }

    function refreshComplianceMarkersForSessionsTable() {
      ensureComplianceHeaderUi();
      var tbody = document.getElementById('table-body');
      if (!tbody) return;
      var rows = Array.from(tbody.querySelectorAll('.grid-row[data-session-id]'));
      if (!rows.length) return;
      var ids = rows.map(function(r) { return r.getAttribute('data-session-id') || ''; }).filter(Boolean);
      if (!ids.length) return;
      // Avoid spamming when renderTable is called repeatedly in quick succession.
      var key = ids.join(',');
      var now = Date.now();
      if (key === fraudMarkersLastKey && (now - fraudMarkersLastAt) >= 0 && (now - fraudMarkersLastAt) < 600) return;
      fraudMarkersLastKey = key;
      fraudMarkersLastAt = now;
      fetchFraudMarkers('session', ids).then(function(markers) {
        rows.forEach(function(row) {
          if (!row || !row.querySelector) return;
          var sid = row.getAttribute('data-session-id') || '';
          var cell = row.querySelector('.grid-cell.compliance-cell');
          if (!cell) return;
          var m = markers && markers[sid] ? markers[sid] : null;
          var hasEval = !!(m && (m.has_eval === true || m.hasEval === true));
          var triggered = !!(m && m.triggered === true);
          var score = m && m.score != null ? Number(m.score) : null;
          try { liveComplianceMarkersCache[sid] = { hasEval: hasEval, triggered: triggered, score: score }; } catch (_) {}
          var hasSale = false;
          try { hasSale = row.classList && row.classList.contains('converted'); } catch (_) { hasSale = false; }
          var sig = (hasSale ? '1' : '0') + '|' + (hasEval ? '1' : '0') + '|' + (triggered ? '1' : '0') + '|' + (score != null && Number.isFinite(score) ? String(Math.trunc(score)) : '');
          if (cell.getAttribute('data-compliance-sig') === sig) return;
          try { cell.setAttribute('data-compliance-sig', sig); } catch (_) {}
          cell.innerHTML = complianceCellHtml(sid, { hasSale: hasSale, hasEval: hasEval, triggered: triggered, score: score });
        });
      }).catch(function(err) {
        try { if (typeof window.kexoCaptureError === 'function') window.kexoCaptureError(err, { context: 'complianceMarkersRefresh', page: (document.body && document.body.getAttribute('data-page')) || '' }); } catch (_) {}
      });
    }

    function refreshFraudMarkersForLatestSalesTable() {
      var table = document.getElementById('latest-sales-table');
      if (!table) return;
      var rows = Array.from(table.querySelectorAll('tbody tr[data-session-id]'));
      if (!rows.length) return;
      var ids = rows.map(function(tr) { return tr.getAttribute('data-session-id') || ''; }).filter(Boolean);
      if (!ids.length) return;
      fetchFraudMarkers('session', ids).then(function(markers) {
        rows.forEach(function(tr) {
          if (!tr || !tr.querySelector) return;
          var sid = tr.getAttribute('data-session-id') || '';
          var slot = tr.querySelector('.latest-sales-fraud-slot');
          if (!slot) return;
          var m = markers && markers[sid] ? markers[sid] : null;
          var triggered = !!(m && m.triggered === true);
          slot.innerHTML = triggered ? buildFraudAlertIconHtml('session', sid, m) : '';
        });
      }).catch(function(err) {
        try { if (typeof window.kexoCaptureError === 'function') window.kexoCaptureError(err, { context: 'latestSalesFraudMarkersRefresh', page: (document.body && document.body.getAttribute('data-page')) || '' }); } catch (_) {}
      });
    }

    function ensureFraudModal() {
      var existing = document.getElementById('fraud-detail-modal');
      if (existing) return existing;
      var wrap = document.createElement('div');
      wrap.innerHTML = (
        '<div class="modal modal-blur" id="fraud-detail-modal" tabindex="-1" role="dialog" aria-hidden="true">' +
          '<div class="modal-dialog modal-lg modal-dialog-centered" role="document">' +
            '<div class="modal-content">' +
              '<div class="modal-header">' +
                '<h5 class="modal-title">Fraud alert</h5>' +
                '<button type="button" class="btn-close" aria-label="Close" data-fraud-close="1"></button>' +
              '</div>' +
              '<div class="modal-body" id="fraud-detail-body"></div>' +
              '<div class="modal-footer">' +
                '<button type="button" class="btn btn-outline-secondary" data-fraud-open-session="1" style="display:none">Open session</button>' +
                '<a class="btn btn-outline-secondary" data-fraud-shopify-order="1" target="_blank" rel="noopener" style="display:none">Open order (Shopify)</a>' +
                '<button type="button" class="btn btn-primary" data-fraud-close="1">Close</button>' +
              '</div>' +
            '</div>' +
          '</div>' +
        '</div>'
      );
      var el = wrap.firstChild;
      document.body.appendChild(el);
      return el;
    }

    function showFraudModal() {
      var el = ensureFraudModal();
      try {
        if (window.bootstrap && window.bootstrap.Modal) {
          var inst = window.bootstrap.Modal.getOrCreateInstance(el, { backdrop: true, focus: true, keyboard: true });
          inst.show();
          return;
        }
      } catch (_) {}
      // Minimal fallback (should rarely be used).
      try { el.style.display = 'block'; } catch (_) {}
      try { el.classList.add('show'); } catch (_) {}
      try {
        var bd = document.createElement('div');
        bd.className = 'modal-backdrop fade show';
        bd.setAttribute('data-fraud-backdrop', '1');
        document.body.appendChild(bd);
      } catch (_) {}
    }

    function hideFraudModal() {
      var el = document.getElementById('fraud-detail-modal');
      if (!el) return;
      try {
        if (window.bootstrap && window.bootstrap.Modal) {
          var inst = window.bootstrap.Modal.getOrCreateInstance(el);
          inst.hide();
        }
      } catch (_) {}
      try { el.classList.remove('show'); } catch (_) {}
      try { el.style.display = 'none'; } catch (_) {}
      try {
        Array.from(document.querySelectorAll('[data-fraud-backdrop="1"]')).forEach(function(n) { n.remove(); });
      } catch (_) {}
    }

    function shopifyAdminOrderUrl(orderId) {
      var oid = orderId != null ? String(orderId).trim() : '';
      if (!oid || !/^\d+$/.test(oid)) return null;
      var shop = null;
      try { shop = getShopParam() || shopForSalesFallback || null; } catch (_) { shop = null; }
      if (!shop) return null;
      return 'https://' + shop + '/admin/orders/' + encodeURIComponent(oid);
    }

    function renderFraudDetailBody(detail) {
      var d = detail && detail.evaluation ? detail : { evaluation: null };
      var ev = d && d.evaluation ? d.evaluation : null;
      if (!ev) return '<div class="text-muted">Unavailable.</div>';
      var score = ev.score != null ? Number(ev.score) : null;
      var scoreText = (typeof score === 'number' && Number.isFinite(score)) ? String(Math.trunc(score)) : '\u2014';
      var risk = d && d.analysis && d.analysis.risk_level ? String(d.analysis.risk_level) : 'Unknown';
      var summary = d && d.analysis && d.analysis.summary ? String(d.analysis.summary) : '';
      var rec = d && d.analysis && d.analysis.recommended_action ? String(d.analysis.recommended_action) : '';
      var reasons = d && d.analysis && Array.isArray(d.analysis.key_reasons) ? d.analysis.key_reasons : [];
      var flags = ev.flags && Array.isArray(ev.flags) ? ev.flags : [];
      var evidence = ev.evidence && typeof ev.evidence === 'object' ? ev.evidence : {};
      var badge = (risk === 'High') ? 'bg-red-lt text-red' : (risk === 'Medium') ? 'bg-yellow-lt text-yellow' : 'bg-green-lt text-green';
      function listKeys(obj) {
        try {
          if (!obj || typeof obj !== 'object') return [];
          return Object.keys(obj).filter(function(k) { return obj[k] != null && String(obj[k]).trim() !== ''; }).slice(0, 8);
        } catch (_) { return []; }
      }
      function flagDetail(flagKey) {
        var k = String(flagKey || '').trim().toLowerCase();
        var attr = evidence && evidence.attribution ? evidence.attribution : {};
        var eng = evidence && evidence.engagement ? evidence.engagement : {};
        var sig = evidence && evidence.signals ? evidence.signals : {};
        if (k === 'google_ads_conflict') {
          var paid = attr && attr.paid_click_ids ? attr.paid_click_ids : {};
          var aff = attr && attr.affiliate_click_ids ? attr.affiliate_click_ids : {};
          var pk = listKeys(paid);
          var ak = listKeys(aff);
          return 'Paid click IDs (' + (pk.length ? pk.join(', ') : 'none') + ') and affiliate click IDs (' + (ak.length ? ak.join(', ') : 'none') + ') both detected.';
        }
        if (k === 'late_injection') {
          var late = attr && attr.late ? attr.late : null;
          var affLate = late && late.affiliate_click_ids ? late.affiliate_click_ids : {};
          var ak = listKeys(affLate);
          var seenAt = late && late.seen_at != null ? Number(late.seen_at) : null;
          var when = (seenAt && Number.isFinite(seenAt)) ? ('seen_at ' + new Date(seenAt).toLocaleString()) : 'seen late';
          return 'Affiliate click IDs appeared late (' + (ak.length ? ak.join(', ') : 'unknown') + '), ' + when + '.';
        }
        if (k === 'low_engagement') {
          var pv = eng && eng.page_views != null ? Number(eng.page_views) : null;
          var te = eng && eng.total_events != null ? Number(eng.total_events) : null;
          return 'Very few interactions before checkout (page_views: ' + (pv != null && Number.isFinite(pv) ? pv : '\u2014') + ', total_events: ' + (te != null && Number.isFinite(te) ? te : '\u2014') + ').';
        }
        if (k === 'suspicious_referrer') {
          var ref = attr && attr.referrer ? String(attr.referrer) : '';
          return ref ? ('Referrer matches coupon/deal patterns: ' + ref) : 'Referrer matches coupon/deal patterns.';
        }
        if (k === 'duplicate_ip_pattern') {
          var n = sig && sig.duplicate_ip_triggered_recent != null ? Number(sig.duplicate_ip_triggered_recent) : null;
          var h = sig && sig.duplicate_ip_window_hours != null ? Number(sig.duplicate_ip_window_hours) : null;
          if (n != null && Number.isFinite(n) && h != null && Number.isFinite(h)) {
            return 'Triggered evaluations from the same IP hash in last ' + h + 'h: ' + n + '.';
          }
          if (n != null && Number.isFinite(n)) return 'Multiple triggered evaluations share the same IP hash (count: ' + n + ').';
          return 'Multiple triggered evaluations share the same IP hash in a short window.';
        }
        if (k === 'no_affiliate_evidence') {
          var net = attr && attr.affiliate_network_hint ? String(attr.affiliate_network_hint) : '';
          var idh = attr && attr.affiliate_id_hint ? String(attr.affiliate_id_hint) : '';
          var um = attr && attr.utm_medium ? String(attr.utm_medium) : '';
          var parts = [];
          if (net) parts.push('network: ' + net);
          if (idh) parts.push('affiliate_id: ' + idh);
          if (um) parts.push('utm_medium: ' + um);
          return 'Affiliate attribution hints present but no reliable click ID evidence' + (parts.length ? (' (' + parts.join(', ') + ')') : '') + '.';
        }
        return '';
      }
      var flagsHtml = flags.length
        ? (
            '<ul class="fraud-flag-lines">' +
              flags.map(function(f) {
                var desc = flagDetail(f);
                return '<li><span class="badge bg-azure-lt">' + escapeHtml(String(f)) + '</span>' + (desc ? ('<span class="fraud-flag-desc">' + escapeHtml(desc) + '</span>') : '') + '</li>';
              }).join('') +
            '</ul>'
          )
        : '<div class="text-muted">No flags recorded.</div>';
      var reasonsHtml = reasons.length
        ? ('<ul class="fraud-reasons">' + reasons.map(function(r) { return '<li>' + escapeHtml(String(r)) + '</li>'; }).join('') + '</ul>')
        : '';
      var evidenceJson = '';
      try { evidenceJson = JSON.stringify(evidence, null, 2); } catch (_) { evidenceJson = ''; }
      return (
        '<div class="fraud-detail-grid">' +
          '<div class="fraud-score">' +
            '<div class="fraud-score-num">' + escapeHtml(scoreText) + '</div>' +
            '<div class="fraud-score-meta">' +
              '<span class="badge ' + escapeHtml(badge) + '" style="font-weight:500">' + escapeHtml(risk) + '</span>' +
              '<div class="text-muted" style="margin-top:.25rem">Fraud score (0\u2013100)</div>' +
            '</div>' +
          '</div>' +
          '<div class="fraud-analysis">' +
            '<div class="mb-2" style="font-weight:500">Analysis</div>' +
            '<div class="fraud-summary">' + escapeHtml(summary || '\u2014') + '</div>' +
            (reasonsHtml ? ('<div class="mt-2">' + reasonsHtml + '</div>') : '') +
            (rec ? ('<div class="mt-2 text-muted"><span style="font-weight:500">Suggested action:</span> ' + escapeHtml(rec) + '</div>') : '') +
          '</div>' +
        '</div>' +
        '<hr class="my-3" />' +
        '<div class="mb-2" style="font-weight:500">Flags</div>' +
        flagsHtml +
        '<hr class="my-3" />' +
        '<div class="mb-2 d-flex align-items-center justify-content-between">' +
          '<div style="font-weight:500">Evidence (safe snapshot)</div>' +
          '<button type="button" class="btn btn-sm btn-outline-secondary" data-fraud-copy-evidence="1">Copy</button>' +
        '</div>' +
        '<pre class="fraud-evidence-pre" data-fraud-evidence-pre="1">' + escapeHtml(evidenceJson || '{}') + '</pre>'
      );
    }

    function openFraudDetailModal(entityType, entityId) {
      var et = entityType ? String(entityType).trim().toLowerCase() : 'session';
      var eid = entityId != null ? String(entityId).trim() : '';
      if (!eid) return;
      var modal = ensureFraudModal();
      var body = modal.querySelector('#fraud-detail-body');
      if (body) body.innerHTML = '<div class="text-muted">Loading\u2026</div>';
      // Hide action buttons until we have links.
      try {
        var btnSession = modal.querySelector('[data-fraud-open-session]');
        var btnOrder = modal.querySelector('[data-fraud-shopify-order]');
        if (btnSession) btnSession.style.display = 'none';
        if (btnOrder) btnOrder.style.display = 'none';
      } catch (_) {}
      showFraudModal();
      var url = API + '/api/fraud/detail?entityType=' + encodeURIComponent(et) + '&entityId=' + encodeURIComponent(eid) + '&_=' + Date.now();
      fetch(url, { credentials: 'same-origin', cache: 'no-store' })
        .then(function(r) { return r.ok ? r.json() : null; })
        .then(function(json) {
          if (!json || !json.ok || !json.evaluation) {
            if (body) body.innerHTML = '<div class="text-muted">Unavailable.</div>';
            return null;
          }
          if (body) body.innerHTML = renderFraudDetailBody(json);
          try {
            var links = json.links || {};
            var sid = links && links.session_id ? String(links.session_id) : '';
            var oid = links && links.order_id ? String(links.order_id) : '';
            var btnSession = modal.querySelector('[data-fraud-open-session]');
            if (btnSession && sid) {
              btnSession.style.display = '';
              btnSession.setAttribute('data-fraud-open-session', sid);
            }
            var btnOrder = modal.querySelector('[data-fraud-shopify-order]');
            var orderUrl = shopifyAdminOrderUrl(oid);
            if (btnOrder && orderUrl) {
              btnOrder.style.display = '';
              btnOrder.setAttribute('href', orderUrl);
            }
          } catch (_) {}
          return json;
        })
        .catch(function() {
          if (body) body.innerHTML = '<div class="text-muted">Unavailable.</div>';
          return null;
        });
    }

    (function initFraudUi() {
      if (fraudUiBound) return;
      fraudUiBound = true;
      try {
        document.addEventListener('click', function(e) {
          var target = e && e.target ? e.target : null;
          var openEl = target && target.closest ? target.closest('[data-fraud-open]') : null;
          if (openEl) {
            try { e.preventDefault(); } catch (_) {}
            try { e.stopPropagation(); } catch (_) {}
            var et = openEl.getAttribute('data-fraud-entity-type') || 'session';
            var eid = openEl.getAttribute('data-fraud-entity-id') || '';
            openFraudDetailModal(et, eid);
            return;
          }
          var closeEl = target && target.closest ? target.closest('[data-fraud-close]') : null;
          if (closeEl) {
            try { e.preventDefault(); } catch (_) {}
            hideFraudModal();
            return;
          }
          var openSessionEl = target && target.closest ? target.closest('[data-fraud-open-session]') : null;
          if (openSessionEl) {
            var sid = openSessionEl.getAttribute('data-fraud-open-session') || '';
            if (sid) {
              try { e.preventDefault(); } catch (_) {}
              hideFraudModal();
              try { openSidePanel(sid); } catch (_) {}
            }
            return;
          }
          var copyEl = target && target.closest ? target.closest('[data-fraud-copy-evidence]') : null;
          if (copyEl) {
            try { e.preventDefault(); } catch (_) {}
            try {
              var pre = document.querySelector('#fraud-detail-modal [data-fraud-evidence-pre="1"]');
              var txt = pre ? (pre.textContent || '') : '';
              if (txt && navigator && navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(txt).catch(function() {});
              }
            } catch (_) {}
          }
        }, true);
      } catch (_) {}
    })();

    function syncSessionsTableTightMode() {
      const wrap = document.querySelector('.table-scroll-wrap');
      const table = document.getElementById('sessions-table');
      if (!wrap || !table) return;
      // "Max mode": when all columns fit, remove extra inter-column padding.
      const fits = table.scrollWidth <= wrap.clientWidth + 1;
      wrap.classList.toggle('tight-cols', !!fits);
    }

    function updateSortHeaders() {
      document.querySelectorAll('.table-scroll-wrap .grid-cell.sortable').forEach(function (th) {
        var col = th.getAttribute('data-sort');
        th.classList.remove('th-sort-asc', 'th-sort-desc');
        th.setAttribute('aria-sort', sortBy === col ? (sortDir === 'asc' ? 'ascending' : 'descending') : 'none');
        if (sortBy === col) th.classList.add(sortDir === 'asc' ? 'th-sort-asc' : 'th-sort-desc');
      });
    }

    function shouldIgnoreStickyResizeSortClick(e) {
      var target = e && e.target && e.target.closest ? e.target : null;
      if (target && target.closest('.kexo-sticky-resize-handle')) return true;
      var wrap = target ? target.closest('.table-scroll-wrap, .country-table-wrap, .table-responsive') : null;
      var ts = wrap ? Number(wrap.getAttribute('data-sticky-resize-at') || '0') : 0;
      if (!Number.isFinite(ts) || ts <= 0) ts = Number(window.__kexoLastStickyResizeAt || 0);
      return Number.isFinite(ts) && ts > 0 && (Date.now() - ts) < 400;
    }

    function setupSortableHeaders() {
      document.querySelectorAll('.table-scroll-wrap .grid-cell.sortable').forEach(function (th) {
        function activate() {
          var col = (th.getAttribute('data-sort') || '').trim();
          if (!col) return;
          if (sortBy === col) sortDir = sortDir === 'asc' ? 'desc' : 'asc';
          else { sortBy = col; sortDir = SORT_DEFAULTS[col] || 'asc'; }
          renderTable();
        }
        th.addEventListener('click', function (e) {
          if (e && typeof e.preventDefault === 'function') e.preventDefault();
          if (shouldIgnoreStickyResizeSortClick(e)) return;
          activate();
        });
        th.addEventListener('keydown', function (e) {
          if (!e || (e.key !== 'Enter' && e.key !== ' ')) return;
          e.preventDefault();
          activate();
        });
      });
    }

    function tickTimeOnSite() {
      document.querySelectorAll('#table-body span[data-started]').forEach(span => {
        const started = parseInt(span.getAttribute('data-started'), 10);
        span.textContent = arrivedAgo(started);
      });
      document.querySelectorAll('#table-body span[data-last-seen]').forEach(span => {
        const lastSeen = parseInt(span.getAttribute('data-last-seen'), 10);
        span.textContent = arrivedAgo(lastSeen);
      });
    }

    function pct(v) { return v != null ? v.toFixed(1) + '%' : ''; }

    function formatRevenue0(num) {
      if (num == null || typeof num !== 'number' || !Number.isFinite(num)) return '';
      try {
        return '\u00A3' + Math.round(num).toLocaleString('en-GB');
      } catch (_) {
        return '\u00A3' + String(Math.round(num));
      }
    }

    function isEffectivelyZero(value, epsilon) {
      var n = (typeof value === 'number') ? value : Number(value);
      if (!Number.isFinite(n)) return false;
      var tol = (typeof epsilon === 'number' && Number.isFinite(epsilon) && epsilon >= 0) ? epsilon : 1e-9;
      return Math.abs(n) <= tol;
    }

    function normalizeZeroNumber(value, epsilon) {
      var n = (typeof value === 'number') ? value : Number(value);
      if (!Number.isFinite(n)) return null;
      return isEffectivelyZero(n, epsilon) ? 0 : n;
    }

    function formatSignedPercentOneDecimalFromRatio(rawRatio) {
      var ratio = normalizeZeroNumber(rawRatio, 0.0005); // <0.05% should render as 0%
      if (ratio == null) return '\u2014';
      var pct = Math.round(ratio * 1000) / 10;
      if (isEffectivelyZero(pct, 1e-9)) pct = 0;
      var sign = pct > 0 ? '+' : (pct < 0 ? '-' : '');
      return sign + Math.abs(pct).toFixed(1).replace(/\.0$/, '') + '%';
    }

    function formatNegativeCurrencyOrZero(value, useWholePounds) {
      var n = (typeof value === 'number' && Number.isFinite(value)) ? Math.abs(value) : null;
      if (n == null) return '\u2014';
      var epsilon = useWholePounds ? 0.5 : 0.005;
      if (n < epsilon) return useWholePounds ? '\u00A30' : '\u00A30.00';
      var s = useWholePounds ? formatRevenue0(n) : formatRevenue(n);
      if (!s) return '\u2014';
      return '-' + s;
    }

    function crPillHtml(v) {
      const n = v != null ? Number(v) : NaN;
      if (!Number.isFinite(n)) return '';
      return '<span class="aov-card-cr-pill" title="Conversion rate">CR ' + escapeHtml(pct(n)) + '</span>';
    }

    function formatRevenue(num) {
      if (num == null || typeof num !== 'number' || !Number.isFinite(num)) return '';
      // Keep dashboard currency formatting consistent everywhere (thousands separators + 2dp).
      try {
        return '\u00A3' + num.toLocaleString('en-GB', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      } catch (_) {
        return '\u00A3' + num.toFixed(2);
      }
    }

    function formatRevenueSub(num) {
      if (num == null || typeof num !== 'number' || !Number.isFinite(num)) return '\u2014';
      return formatRevenue(num) || '\u2014';
    }

    function isIconMode() {
      try {
        return !!(window.matchMedia && window.matchMedia('(max-width: 768px)').matches);
      } catch (_) {
        return false;
      }
    }

    function formatRevenueTableHtml(num) {
      if (num == null || typeof num !== 'number' || !Number.isFinite(num)) return '\u2014';
      if (isIconMode()) return '\u00A3' + Math.round(num).toLocaleString('en-GB');
      if (num % 1 === 0) return '\u00A3' + num.toLocaleString('en-GB');
      let fixed = null;
      try {
        fixed = num.toLocaleString('en-GB', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      } catch (_) {
        fixed = num.toFixed(2);
      }
      const parts = String(fixed).split('.');
      return '\u00A3' + parts[0] + '<span class="rev-decimal">.' + (parts[1] || '00') + '</span>';
    }

    function animateTickerText(el, nextText) {
      if (!el) return;
      const prev = el.textContent != null ? String(el.textContent) : '';
      const next = nextText != null ? String(nextText) : '';
      if (prev === next) {
        el.textContent = next;
        return;
      }
      const wrap = document.createElement('span');
      wrap.className = 'kpi-ticker';
      const stack = document.createElement('span');
      stack.className = 'kpi-ticker-stack';
      const a = document.createElement('span');
      a.className = 'kpi-ticker-line';
      a.textContent = prev;
      const b = document.createElement('span');
      b.className = 'kpi-ticker-line';
      b.textContent = next;
      stack.appendChild(a);
      stack.appendChild(b);
      wrap.appendChild(stack);
      while (el.firstChild) el.removeChild(el.firstChild);
      el.appendChild(wrap);
      requestAnimationFrame(function() { wrap.classList.add('run'); });
      setTimeout(function() {
        // Finalize (but only if the wrapper is still present).
        if (el && el.contains(wrap)) el.textContent = next;
      }, 460);
    }

    function animateOdometerText(el, nextText) {
      if (!el) return;
      const next = nextText != null ? String(nextText) : '';
      const prevStored = el.getAttribute('data-odometer');
      const prev = prevStored != null ? String(prevStored) : (el.textContent != null ? String(el.textContent) : '');
      if (prev === next) {
        el.textContent = next;
        el.setAttribute('data-odometer', next);
        return;
      }
      const wrap = document.createElement('span');
      wrap.className = 'kpi-odometer';
      const stacks = [];
      for (let i = 0; i < next.length; i++) {
        const ch = next[i];
        if (ch >= '0' && ch <= '9') {
          const prevCh = prev[i] || '0';
          const prevDigit = (prevCh >= '0' && prevCh <= '9') ? parseInt(prevCh, 10) : 0;
          const digit = parseInt(ch, 10);
          const digitWrap = document.createElement('span');
          digitWrap.className = 'kpi-odometer-digit';
          const stack = document.createElement('span');
          stack.className = 'kpi-odometer-stack';
          for (let d = 0; d <= 9; d++) {
            const line = document.createElement('span');
            line.textContent = String(d);
            stack.appendChild(line);
          }
          stack.style.transform = 'translateY(' + (-prevDigit) + 'em)';
          digitWrap.appendChild(stack);
          wrap.appendChild(digitWrap);
          stacks.push({ stack, digit });
        } else {
          const span = document.createElement('span');
          span.className = 'kpi-odometer-char';
          span.textContent = ch;
          wrap.appendChild(span);
        }
      }
      while (el.firstChild) el.removeChild(el.firstChild);
      el.appendChild(wrap);
      el.setAttribute('data-odometer', next);
      requestAnimationFrame(function() {
        stacks.forEach(function(item) {
          item.stack.style.transform = 'translateY(' + (-item.digit) + 'em)';
        });
      });
      setTimeout(function() {
        if (!el || !el.contains(wrap)) return;
        el.textContent = next;
      }, 460);
    }

    function productUrlFromHandle(handle) {
      const h = handle != null ? String(handle).trim() : '';
      if (!h) return '';
      const base = getMainBaseUrl();
      if (!base) return '';
      return base + '/products/' + encodeURIComponent(h.replace(/^\/+/, ''));
    }

    function resolveSaleToastThumbSrc(data) {
      if (!data) return '';
      const rawThumb = data.productThumbUrl != null ? String(data.productThumbUrl).trim() : '';
      if (rawThumb) return hotImgSquare(rawThumb) || rawThumb;
      const directUrl = data.productUrl != null ? String(data.productUrl).trim() : '';
      const handleUrl = data.productHandle ? productUrlFromHandle(data.productHandle) : '';
      const finalUrl = directUrl || handleUrl;
      if (!finalUrl) return '';
      return (API || '') + '/api/og-thumb?url=' + encodeURIComponent(finalUrl) + '&width=100';
    }

    function setSaleToastContent(patch) {
      patch = patch && typeof patch === 'object' ? patch : {};
      const data = { ...(saleToastLastPayload || {}) };
      const hasOwn = Object.prototype.hasOwnProperty;
      if (hasOwn.call(patch, 'countryCode')) data.countryCode = patch.countryCode;
      if (hasOwn.call(patch, 'productTitle')) data.productTitle = patch.productTitle;
      if (hasOwn.call(patch, 'amountGbp')) data.amountGbp = patch.amountGbp;
      if (hasOwn.call(patch, 'productHandle')) data.productHandle = patch.productHandle;
      if (hasOwn.call(patch, 'productUrl')) data.productUrl = patch.productUrl;
      if (hasOwn.call(patch, 'productThumbUrl')) data.productThumbUrl = patch.productThumbUrl;
      if (hasOwn.call(patch, 'createdAt')) data.createdAt = patch.createdAt;

      const cc = (data.countryCode || 'XX').toString().trim().toUpperCase().slice(0, 2) || 'XX';
      const product = data.productTitle != null ? String(data.productTitle) : '';
      const amountRaw = data.amountGbp != null ? Number(data.amountGbp) : null;
      const amountGbp = (amountRaw != null && Number.isFinite(amountRaw)) ? amountRaw : null;

      saleToastLastPayload = {
        ...data,
        countryCode: cc,
        productTitle: product,
        amountGbp: amountGbp,
      };

      const inlineFlagEl = document.getElementById('sale-toast-inline-flag');
      const productEl = document.getElementById('sale-toast-product');
      const amountEl = document.getElementById('sale-toast-amount');
      if (inlineFlagEl) inlineFlagEl.innerHTML = flagImgSmall(cc);
      if (productEl) productEl.textContent = product && product.trim() ? product : '\u2014';
      if (amountEl) amountEl.textContent = (amountGbp != null) ? (formatRevenue(amountGbp) || '\u00A3\u2014') : '\u00A3\u2014';
      if (data.createdAt != null) {
        try { setLastSaleAt(data.createdAt); } catch (_) {}
      }
    }

    function updateSaleToastToggle() {
      var isPinned = !!saleToastPinned;
      ['last-sale-toggle', 'footer-last-sale-toggle'].forEach(function(id) {
        var btn = document.getElementById(id);
        if (!btn) return;
        btn.classList.toggle('is-on', isPinned);
        btn.setAttribute('aria-pressed', isPinned ? 'true' : 'false');
        btn.setAttribute('aria-label', isPinned ? 'Hide last sale toast' : 'Show last sale toast');
        var eyeOn = btn.querySelector('.fa-eye');
        var eyeOff = btn.querySelector('.fa-eye-slash');
        if (eyeOn) eyeOn.style.display = isPinned ? 'none' : '';
        if (eyeOff) eyeOff.style.display = isPinned ? '' : 'none';
      });
    }

    function showSaleToast() {
      const banner = document.getElementById('sale-toast-banner');
      if (!banner) return;
      saleToastActive = true;
      saleToastLastShownAt = Date.now();
      banner.removeAttribute('hidden');
      banner.setAttribute('aria-hidden', 'false');
      requestAnimationFrame(function() { banner.classList.add('active'); });
    }

    function hideSaleToast() {
      const banner = document.getElementById('sale-toast-banner');
      if (saleToastHideTimer) {
        clearTimeout(saleToastHideTimer);
        saleToastHideTimer = null;
      }
      if (!banner) {
        saleToastActive = false;
        saleToastSessionId = null;
        return;
      }
      banner.classList.remove('active');
      banner.setAttribute('aria-hidden', 'true');
      setTimeout(function() {
        banner.setAttribute('hidden', '');
        saleToastActive = false;
        saleToastSessionId = null;

        // Sale banner indicates KPIs are about to change. Reset caches once the banner disappears.
        try { clearKpiLocalStorageCaches(); } catch (_) {}
        try { lastKpisFetchedAt = 0; } catch (_) {}
        try { kpiCacheRange = ''; } catch (_) {}
        try { kpiCacheSource = ''; } catch (_) {}
        try { kpiExpandedExtrasFetchedAt = 0; } catch (_) {}

        // Pull fresh KPI data (fast metrics) immediately after cache reset.
        try { refreshKpis({ force: true }); } catch (_) {}
        // Keep the dashboard tables/charts in sync, but do not re-show the global loader.
        try { if (PAGE === 'dashboard' && typeof window.refreshDashboard === 'function') window.refreshDashboard({ force: true, silent: true }); } catch (_) {}
        // Refresh condensed KPI extras as well.
        try { refreshKpiExtrasSoft(); } catch (_) {}
      }, 320);
    }

    let latestSaleFetchInFlight = null;
    function fetchLatestSaleForToast(options = {}) {
      const forceNew = !!(options && options.forceNew);
      if (!forceNew && latestSaleFetchInFlight) return latestSaleFetchInFlight;
      const url = API + '/api/latest-sale?_=' + Date.now();
      const p = fetch(url, { credentials: 'same-origin', cache: 'no-store' })
        .then(function(r) { return r.ok ? r.json() : null; })
        .then(function(json) { return (json && json.ok && json.sale) ? json.sale : null; })
        .catch(function() { return null; })
        .finally(function() { if (latestSaleFetchInFlight === p) latestSaleFetchInFlight = null; });
      latestSaleFetchInFlight = p;
      return p;
    }

    function hydrateLastSaleFooterFromApi(options = {}) {
      var forceNew = !!(options && options.forceNew);
      return fetchLatestSaleForToast({ forceNew: forceNew })
        .then(function(sale) {
          if (!sale || sale.createdAt == null) return null;
          setLastSaleAt(sale.createdAt);
          return sale;
        })
        .catch(function() { return null; });
    }

    // Latest sales table (/dashboard/live): last 5 converted sessions (desktop only).
    let latestSalesFetchInFlight = null;
    let latestSalesCache = null; // array of normalized rows
    let latestSalesRefetchTimer = null;

    function normalizeLatestSaleRow(row) {
      const r = row && typeof row === 'object' ? row : {};
      const sid = r.session_id != null ? String(r.session_id) : '';
      const cc = r.country_code != null ? String(r.country_code).trim().toUpperCase().slice(0, 2) : 'XX';
      const purchasedAt = r.purchased_at != null ? toMs(r.purchased_at) : null;
      const totalRaw = r.order_total != null ? (typeof r.order_total === 'number' ? r.order_total : parseFloat(String(r.order_total))) : null;
      const total = (typeof totalRaw === 'number' && Number.isFinite(totalRaw)) ? totalRaw : null;
      const cur = r.order_currency != null ? String(r.order_currency).trim().toUpperCase() : '';
      const lastHandle = r.last_product_handle != null ? String(r.last_product_handle).trim() : '';
      const firstHandle = r.first_product_handle != null ? String(r.first_product_handle).trim() : '';
      const out = {
        session_id: sid || null,
        country_code: cc || 'XX',
        purchased_at: purchasedAt,
        order_total: total,
        order_currency: cur || null,
        last_product_handle: lastHandle || null,
        first_product_handle: firstHandle || null,
      };
      const totalGbpRaw = r.order_total_gbp != null ? (typeof r.order_total_gbp === 'number' ? r.order_total_gbp : parseFloat(String(r.order_total_gbp))) : null;
      const totalGbp = (typeof totalGbpRaw === 'number' && Number.isFinite(totalGbpRaw)) ? totalGbpRaw : null;
      if (totalGbp != null) out.order_total_gbp = totalGbp;
      const pidRaw = r.product_id != null ? String(r.product_id).replace(/^gid:\/\/shopify\/Product\//i, '').trim() : '';
      if (pidRaw && /^\d+$/.test(pidRaw)) out.product_id = pidRaw;
      const titleRaw = r.product_title != null ? String(r.product_title).trim() : '';
      if (titleRaw) out.product_title = titleRaw;
      return out;
    }

    function renderLatestSalesTable(rows) {
      const table = document.getElementById('latest-sales-table');
      if (!table) return;
      const tbody = table.querySelector('tbody');
      if (!tbody) return;
      const list = Array.isArray(rows) ? rows : [];
      if (!list.length) {
        tbody.innerHTML = '<tr><td colspan="4" class="dash-empty">No sales</td></tr>';
        return;
      }
      const mainBase = getMainBaseUrl();
      const pageSize = getTableRowsPerPage('latest-sales-table', 'dashboard');
      tbody.innerHTML = list.slice(0, pageSize).map(function(s) {
        const sid = (s && s.session_id != null) ? String(s.session_id) : '';
        const cc = (s && s.country_code ? String(s.country_code) : 'XX').toUpperCase().slice(0, 2) || 'XX';
        const productId = (s && s.product_id != null) ? String(s.product_id).replace(/^gid:\/\/shopify\/Product\//i, '').trim() : '';
        const pid = (productId && /^\d+$/.test(productId)) ? productId : '';
        const handle = (s && s.last_product_handle) ? String(s.last_product_handle).trim()
          : (s && s.first_product_handle) ? String(s.first_product_handle).trim()
          : '';
        const explicitTitle = (s && s.product_title != null) ? String(s.product_title).trim() : '';
        const title = explicitTitle || (handle ? (titleCaseFromHandle(handle) || '') : '') || 'Unknown product';
        const productUrl = (mainBase && handle) ? (mainBase + '/products/' + encodeURIComponent(handle)) : '#';
        const canOpen = !!(handle || pid);
        const titleHtml = canOpen
          ? (
              '<a class="kexo-product-link js-product-modal-link" href="' + escapeHtml(productUrl || '#') + '" target="_blank" rel="noopener"' +
                (handle ? (' data-product-handle="' + escapeHtml(handle) + '"') : '') +
                (pid ? (' data-product-id="' + escapeHtml(pid) + '"') : '') +
                (title ? (' data-product-title="' + escapeHtml(title) + '"') : '') +
              '>' + escapeHtml(title) + '</a>'
            )
          : escapeHtml(title || 'Unknown product');
        const ago = (s && s.purchased_at != null) ? arrivedAgo(s.purchased_at) : '\u2014';
        const money = (s && typeof s.order_total_gbp === 'number')
          ? (formatMoney(s.order_total_gbp, 'GBP') || '\u2014')
          : (s && s.order_total != null) ? (formatMoney(s.order_total, s.order_currency) || '\u2014') : '\u2014';
        return (
          '<tr' + (sid ? (' data-session-id="' + escapeHtml(sid) + '"') : '') + '>' +
            '<td class="w-1 latest-sales-flag-cell">' + flagImgSmall(cc) + '<span class="latest-sales-fraud-slot" aria-hidden="true"></span></td>' +
            '<td>' + titleHtml + '</td>' +
            '<td class="text-end text-muted">' + escapeHtml(ago) + '</td>' +
            '<td class="text-end fw-semibold">' + escapeHtml(money) + '</td>' +
          '</tr>'
        );
      }).join('');
      try { refreshFraudMarkersForLatestSalesTable(); } catch (_) {}
    }

    function upsertLatestSaleRow(nextRaw) {
      const table = document.getElementById('latest-sales-table');
      if (!table) return;
      const next = normalizeLatestSaleRow(nextRaw);
      if (!next || !next.session_id || next.purchased_at == null) return;
      const cur = Array.isArray(latestSalesCache) ? latestSalesCache.slice() : [];
      const idx = cur.findIndex(function(r) { return r && r.session_id && String(r.session_id) === String(next.session_id); });
      if (idx >= 0) {
        cur[idx] = { ...(cur[idx] || {}), ...next };
      } else {
        cur.unshift(next);
      }
      cur.sort(function(a, b) { return (toMs(b && b.purchased_at) || 0) - (toMs(a && a.purchased_at) || 0); });
      latestSalesCache = cur.slice(0, 5);
      renderLatestSalesTable(latestSalesCache);

      // SSE gives us the raw session row (may lack product title / GBP conversion).
      // Refresh the server-enriched latest-sales payload shortly after a new sale is detected.
      if (idx < 0) {
        try {
          if (latestSalesRefetchTimer) clearTimeout(latestSalesRefetchTimer);
          latestSalesRefetchTimer = setTimeout(function() {
            latestSalesRefetchTimer = null;
            try { fetchLatestSales({ force: true }); } catch (_) {}
          }, 400);
        } catch (_) {}
      }
    }

    function fetchLatestSales(options = {}) {
      const force = !!(options && options.force);
      if (!force && latestSalesFetchInFlight) return latestSalesFetchInFlight;
      const table = document.getElementById('latest-sales-table');
      if (!table) return Promise.resolve(null);
      const url = API + '/api/latest-sales?limit=5&_=' + Date.now();
      const p = fetch(url, { credentials: 'same-origin', cache: 'no-store' })
        .then(function(r) { return r.ok ? r.json() : null; })
        .then(function(json) {
          const list = (json && Array.isArray(json.sales)) ? json.sales : [];
          latestSalesCache = list.map(normalizeLatestSaleRow).filter(function(r) { return r && r.session_id; }).slice(0, 5);
          renderLatestSalesTable(latestSalesCache);
          return latestSalesCache;
        })
        .catch(function() { return null; })
        .finally(function() { if (latestSalesFetchInFlight === p) latestSalesFetchInFlight = null; });
      latestSalesFetchInFlight = p;
      return p;
    }

    (function initLatestSalesTable() {
      const table = document.getElementById('latest-sales-table');
      if (!table) return;
      renderLatestSalesTable([]);
      fetchLatestSales({ force: false });
    })();

    function buildSalesKpiUpdateFromStats(data) {
      const rangeKey = getStatsRange();
      const sales = data && data.sales ? data.sales : {};
      const convertedCountMap = data && data.convertedCount ? data.convertedCount : {};
      const salesVal = typeof sales[rangeKey] === 'number' ? sales[rangeKey] : null;
      const orderCountVal = typeof convertedCountMap[rangeKey] === 'number' ? convertedCountMap[rangeKey] : null;
      return {
        labelText: orderCountVal != null ? (orderCountVal + ' Orders') : 'Orders',
        valueText: salesVal != null ? (formatRevenue(salesVal) || '\u2014') : '\u2014',
      };
    }

    // Sale sound: prime/unlock on first user interaction, and retry once on click if autoplay is blocked.
    function primeSaleAudio() {
      if (!saleAudio || saleAudioPrimed) return;
      const a = saleAudio;
      saleAudioPrimed = true;
      const prevMuted = !!a.muted;
      const prevVol = (typeof a.volume === 'number' && Number.isFinite(a.volume)) ? a.volume : 1;
      try { a.preload = 'auto'; } catch (_) {}
      try { a.load(); } catch (_) {}
      try { a.muted = true; } catch (_) {}
      try { a.volume = 0; } catch (_) {}
      try {
        const p = a.play();
        if (p && typeof p.then === 'function') {
          p.then(function() {
            try { a.pause(); } catch (_) {}
            try { a.currentTime = 0; } catch (_) {}
          }).catch(function() {
            saleAudioPrimed = false;
          }).finally(function() {
            try { a.pause(); } catch (_) {}
            try { a.currentTime = 0; } catch (_) {}
            try { a.muted = prevMuted; } catch (_) {}
            try { a.volume = prevVol; } catch (_) {}
          });
          return;
        }
      } catch (_) {
        saleAudioPrimed = false;
      }
      try { a.pause(); } catch (_) {}
      try { a.currentTime = 0; } catch (_) {}
      try { a.muted = prevMuted; } catch (_) {}
      try { a.volume = prevVol; } catch (_) {}
    }

    function playSaleSound(options = {}) {
      const deferOnClick = options.deferOnClick !== false;
      if (saleMuted || !saleAudio) return;
      try { saleAudio.currentTime = 0; } catch (_) {}
      const p = saleAudio.play();
      if (p && typeof p.catch === 'function') {
        p.catch(function() {
          if (!deferOnClick) return;
          if (saleSoundDeferredOnce || saleSoundDeferredHandler) return;
          saleSoundDeferredOnce = true;
          saleSoundDeferredHandler = function deferredSaleSoundPlay() {
            ['pointerdown', 'touchstart', 'click', 'keydown'].forEach(function(evt) {
              try { document.removeEventListener(evt, saleSoundDeferredHandler, true); } catch (_) {}
            });
            saleSoundDeferredHandler = null;
            saleSoundDeferredOnce = false;
            if (saleMuted || !saleAudio) return;
            try { primeSaleAudio(); } catch (_) {}
            try { saleAudio.currentTime = 0; } catch (_) {}
            saleAudio.play().catch(function() {});
          };
          ['pointerdown', 'touchstart', 'click', 'keydown'].forEach(function(evt) {
            try { document.addEventListener(evt, saleSoundDeferredHandler, { once: true, capture: true }); } catch (_) {}
          });
        });
      }
    }

    function normalizeSaleToastIdentityPart(v, maxLen = 256) {
      if (v == null) return '';
      const s = String(v).trim();
      if (!s) return '';
      const low = s.toLowerCase();
      if (low === 'null' || low === 'undefined' || low === '[object object]') return '';
      return s.length > maxLen ? s.slice(0, maxLen) : s;
    }

    function pushSaleToastIdentityKey(keys, key) {
      const normalized = normalizeSaleToastIdentityPart(key, 384).toLowerCase();
      if (!normalized) return;
      if (keys.indexOf(normalized) >= 0) return;
      keys.push(normalized);
    }

    function loadSaleToastSeenKeys() {
      saleToastSeenKeys = new Set();
      saleToastSeenOrder = [];
      try {
        const raw = localStorage.getItem(SALE_TOAST_SEEN_STORAGE_KEY);
        if (!raw) return;
        const parsed = JSON.parse(raw);
        if (!Array.isArray(parsed)) return;
        parsed.slice(-SALE_TOAST_SEEN_KEY_MAX).forEach(function(entry) {
          const key = normalizeSaleToastIdentityPart(entry, 384).toLowerCase();
          if (!key || saleToastSeenKeys.has(key)) return;
          saleToastSeenKeys.add(key);
          saleToastSeenOrder.push(key);
        });
      } catch (_) {}
    }

    function saveSaleToastSeenKeys() {
      try {
        if (saleToastSeenOrder.length > SALE_TOAST_SEEN_KEY_MAX) {
          saleToastSeenOrder = saleToastSeenOrder.slice(-SALE_TOAST_SEEN_KEY_MAX);
          saleToastSeenKeys = new Set(saleToastSeenOrder);
        }
        localStorage.setItem(SALE_TOAST_SEEN_STORAGE_KEY, JSON.stringify(saleToastSeenOrder));
      } catch (_) {}
    }

    function hasSeenSaleToastIdentity(keys) {
      if (!Array.isArray(keys) || !keys.length) return false;
      for (let i = 0; i < keys.length; i += 1) {
        const key = normalizeSaleToastIdentityPart(keys[i], 384).toLowerCase();
        if (!key) continue;
        if (saleToastSeenKeys.has(key)) return true;
      }
      return false;
    }

    function rememberSaleToastIdentity(keys) {
      if (!Array.isArray(keys) || !keys.length) return;
      let changed = false;
      keys.forEach(function(rawKey) {
        const key = normalizeSaleToastIdentityPart(rawKey, 384).toLowerCase();
        if (!key || saleToastSeenKeys.has(key)) return;
        saleToastSeenKeys.add(key);
        saleToastSeenOrder.push(key);
        changed = true;
      });
      if (!changed) return;
      if (saleToastSeenOrder.length > SALE_TOAST_SEEN_KEY_MAX) {
        saleToastSeenOrder = saleToastSeenOrder.slice(-SALE_TOAST_SEEN_KEY_MAX);
        saleToastSeenKeys = new Set(saleToastSeenOrder);
      }
      saveSaleToastSeenKeys();
    }

    function buildSaleToastIdentityKeys(opts) {
      const inOpts = opts && typeof opts === 'object' ? opts : {};
      const keys = [];
      const explicit = normalizeSaleToastIdentityPart(inOpts.toastDedupeKey, 256);
      if (explicit) pushSaleToastIdentityKey(keys, 'toast:' + explicit);
      const soundKey = normalizeSaleToastIdentityPart(inOpts.soundDedupeKey, 256);
      if (soundKey) pushSaleToastIdentityKey(keys, 'sound:' + soundKey);

      const session = inOpts.session && typeof inOpts.session === 'object' ? inOpts.session : null;
      if (session) {
        const orderId = normalizeSaleToastIdentityPart(
          session.order_id != null ? session.order_id : session.orderId,
          64
        );
        const checkoutToken = normalizeSaleToastIdentityPart(
          session.checkout_token != null ? session.checkout_token : session.checkoutToken,
          128
        );
        const clickId = normalizeSaleToastIdentityPart(
          session.session_id != null ? session.session_id : session.sessionId,
          128
        );
        const purchasedAt = session.purchased_at != null
          ? toMs(session.purchased_at)
          : (session.purchasedAt != null ? toMs(session.purchasedAt) : null);
        if (orderId) pushSaleToastIdentityKey(keys, 'order:' + orderId);
        if (checkoutToken) pushSaleToastIdentityKey(keys, 'token:' + checkoutToken);
        if (clickId) pushSaleToastIdentityKey(keys, 'click:' + clickId);
        if (clickId && purchasedAt != null) pushSaleToastIdentityKey(keys, 'click-sale:' + clickId + ':' + String(purchasedAt));
        if (purchasedAt != null) pushSaleToastIdentityKey(keys, 'sale-at:' + String(purchasedAt));
      }

      const latestSale = inOpts.latestSale && typeof inOpts.latestSale === 'object'
        ? inOpts.latestSale
        : (inOpts.sale && typeof inOpts.sale === 'object' ? inOpts.sale : null);
      if (latestSale) {
        const orderId = normalizeSaleToastIdentityPart(
          latestSale.orderId != null ? latestSale.orderId : latestSale.order_id,
          64
        );
        const checkoutToken = normalizeSaleToastIdentityPart(
          latestSale.checkoutToken != null ? latestSale.checkoutToken : latestSale.checkout_token,
          128
        );
        const clickId = normalizeSaleToastIdentityPart(
          latestSale.sessionId != null ? latestSale.sessionId : latestSale.session_id,
          128
        );
        const createdAt = latestSale.createdAt != null
          ? toMs(latestSale.createdAt)
          : (latestSale.created_at != null ? toMs(latestSale.created_at) : null);
        if (orderId) pushSaleToastIdentityKey(keys, 'order:' + orderId);
        if (checkoutToken) pushSaleToastIdentityKey(keys, 'token:' + checkoutToken);
        if (clickId) pushSaleToastIdentityKey(keys, 'click:' + clickId);
        if (createdAt != null) pushSaleToastIdentityKey(keys, 'sale-at:' + String(createdAt));
      }

      const payload = inOpts.payload && typeof inOpts.payload === 'object' ? inOpts.payload : null;
      if (payload) {
        const createdAt = payload.createdAt != null
          ? toMs(payload.createdAt)
          : (payload.created_at != null ? toMs(payload.created_at) : null);
        if (createdAt != null) pushSaleToastIdentityKey(keys, 'sale-at:' + String(createdAt));
      }

      return keys;
    }

    (function initSaleToastIdentityStore() {
      loadSaleToastSeenKeys();
    })();

    function buildSaleSoundDedupeKey(opts) {
      const inOpts = opts && typeof opts === 'object' ? opts : {};
      const explicit = inOpts.soundDedupeKey != null ? String(inOpts.soundDedupeKey).trim() : '';
      if (explicit) return explicit;
      const session = inOpts.session && typeof inOpts.session === 'object' ? inOpts.session : null;
      if (session) {
        const orderId = session.order_id != null
          ? String(session.order_id).trim()
          : (session.orderId != null ? String(session.orderId).trim() : '');
        if (orderId) return 'order:' + orderId;
        const sid = session.session_id != null ? String(session.session_id).trim() : '';
        const purchasedAt = session.purchased_at != null ? toMs(session.purchased_at) : null;
        if (sid && purchasedAt != null) return 'session-sale:' + sid + ':' + String(purchasedAt);
        if (sid) return 'session:' + sid;
        if (purchasedAt != null) return 'purchased:' + String(purchasedAt);
      }
      const payload = inOpts.payload && typeof inOpts.payload === 'object' ? inOpts.payload : null;
      if (payload && payload.createdAt != null) {
        const createdAt = toMs(payload.createdAt);
        if (createdAt != null) return 'payload:' + String(createdAt);
      }
      const latest = lastSaleAt != null ? toMs(lastSaleAt) : null;
      if (latest != null) return 'last-sale:' + String(latest);
      return '';
    }

    function shouldPlaySaleSoundForToast(opts) {
      const inOpts = opts && typeof opts === 'object' ? opts : {};
      const origin = inOpts.origin != null ? String(inOpts.origin).trim().toLowerCase() : '';
      // Keep manual test/toggle behavior unchanged (always audible).
      if (origin === 'manual') return true;
      const now = Date.now();
      if (
        origin === 'stats' &&
        saleSoundLastOrigin === 'sse' &&
        saleSoundLastAt > 0 &&
        (now - saleSoundLastAt) < SALE_SOUND_DEDUPE_WINDOW_MS
      ) {
        return false;
      }
      const dedupeKey = buildSaleSoundDedupeKey(inOpts);
      if (
        dedupeKey &&
        saleSoundLastKey === dedupeKey &&
        saleSoundLastAt > 0 &&
        (now - saleSoundLastAt) < SALE_SOUND_DEDUPE_WINDOW_MS
      ) {
        return false;
      }
      if (dedupeKey) saleSoundLastKey = dedupeKey;
      saleSoundLastOrigin = origin || 'unknown';
      saleSoundLastAt = now;
      return true;
    }

    function triggerSaleToast(opts) {
      opts = opts && typeof opts === 'object' ? opts : {};
      const session = opts.session || null;
      const playSound = opts.playSound !== false;
      const payload = opts.payload || null;
      const skipLatest = !!opts.skipLatest;
      const persist = !!opts.persist;
      const allowReplay = !!opts.allowReplay;
      const latestSale = opts.latestSale && typeof opts.latestSale === 'object' ? opts.latestSale : null;
      const identityKeys = buildSaleToastIdentityKeys(opts);
      if (!allowReplay) {
        // Guardrail: automatic notifications must carry a stable identity, otherwise we risk duplicates.
        if (!identityKeys.length) return;
        if (hasSeenSaleToastIdentity(identityKeys)) return;
        rememberSaleToastIdentity(identityKeys);
      }
      const toastToken = ++saleToastToken; // newest toast wins
      saleToastLastPayload = null;
      saleToastSessionId = session && session.session_id != null ? String(session.session_id) : null;
      saleToastLastOrderId = null;
      if (latestSale && latestSale.orderId != null) saleToastLastOrderId = String(latestSale.orderId);
      if (persist) {
        saleToastPinned = true;
        updateSaleToastToggle();
      } else if (saleToastPinned) {
        saleToastPinned = false;
        updateSaleToastToggle();
      }

      showSaleToast();

      if (payload) {
        setSaleToastContent(payload);
      } else {
        // Fast, best-effort content from the session update (then refined by truth).
        try {
          const cc = session && session.country_code ? String(session.country_code).toUpperCase().slice(0, 2) : 'XX';
          let productTitle = '';
          let productHandle = '';
          if (session && session.last_product_handle) productHandle = String(session.last_product_handle).trim();
          if (!productHandle && session && session.first_product_handle) productHandle = String(session.first_product_handle).trim();
          if (productHandle) productTitle = titleCaseFromHandle(String(productHandle));
          let amountGbp = null;
          if (session && session.order_total != null) {
            const n = typeof session.order_total === 'number' ? session.order_total : parseFloat(String(session.order_total));
            if (Number.isFinite(n)) amountGbp = n;
          }
          const createdAt = (session && session.purchased_at != null)
            ? session.purchased_at
            : (session && session.last_seen != null)
              ? session.last_seen
              : (session && session.started_at != null)
                ? session.started_at
                : Date.now();
          setSaleToastContent({
            countryCode: cc,
            productTitle: productTitle || 'Processing\u2026',
            amountGbp,
            productHandle: productHandle || '',
            createdAt,
          });
        } catch (_) {}
      }

      if (playSound && shouldPlaySaleSoundForToast(opts)) {
        try { primeSaleAudio(); } catch (_) {}
        playSaleSound({ deferOnClick: true });
      }

      if (saleToastHideTimer) clearTimeout(saleToastHideTimer);
      if (!persist) saleToastHideTimer = setTimeout(hideSaleToast, 10000);

      if (skipLatest) return;
      fetchLatestSaleForToast({ forceNew: true }).then(function(sale) {
        if (!sale) return;
        if (toastToken !== saleToastToken) return; // stale fetch (a newer sale toast is showing)
        if (!saleToastActive) return;
        if (!allowReplay) {
          try { rememberSaleToastIdentity(buildSaleToastIdentityKeys({ latestSale: sale })); } catch (_) {}
        }
        const orderId = sale.orderId != null ? String(sale.orderId) : '';
        if (orderId) saleToastLastOrderId = orderId;
        const cc = sale.countryCode ? String(sale.countryCode).toUpperCase().slice(0, 2) : 'XX';
        const product = sale.productTitle && String(sale.productTitle).trim() ? String(sale.productTitle).trim() : '';
        const amount = sale.amountGbp != null ? Number(sale.amountGbp) : null;
        const productHandle = sale.productHandle != null ? String(sale.productHandle).trim() : '';
        const productThumbUrl = sale.productThumbUrl != null ? String(sale.productThumbUrl).trim() : '';
        const createdAt = sale.createdAt != null ? sale.createdAt : null;
        setSaleToastContent({
          countryCode: cc || 'XX',
          productTitle: product || (document.getElementById('sale-toast-product') ? document.getElementById('sale-toast-product').textContent : '\u2014'),
          amountGbp: (amount != null && Number.isFinite(amount)) ? amount : null,
          productHandle: productHandle || '',
          productThumbUrl: productThumbUrl || '',
          createdAt,
        });
      });
    }

    function buildSaleToastPayloadFromSale(sale) {
      if (!sale) return null;
      const cc = sale.countryCode ? String(sale.countryCode).toUpperCase().slice(0, 2) : 'XX';
      const productTitle = sale.productTitle && String(sale.productTitle).trim() ? String(sale.productTitle).trim() : '';
      const amount = sale.amountGbp != null ? Number(sale.amountGbp) : null;
      return {
        countryCode: cc || 'XX',
        productTitle,
        amountGbp: (amount != null && Number.isFinite(amount)) ? amount : null,
        productHandle: sale.productHandle != null ? String(sale.productHandle).trim() : '',
        productThumbUrl: sale.productThumbUrl != null ? String(sale.productThumbUrl).trim() : '',
        createdAt: sale.createdAt != null ? sale.createdAt : null,
      };
    }

    function triggerManualSaleToast(persist) {
      const keep = !!persist;
      const cached = saleToastLastPayload;
      const hasCache = cached && (cached.productTitle || cached.amountGbp != null || cached.productHandle || cached.productThumbUrl);
      const placeholder = { countryCode: 'XX', productTitle: 'Loading\u2026', amountGbp: null, productHandle: '', productThumbUrl: '', createdAt: null };
      const payload = hasCache ? cached : placeholder;
      // Show banner immediately (no wait for API), then refresh when fetch completes.
      triggerSaleToast({ origin: 'manual', payload: payload, playSound: true, skipLatest: true, persist: keep, allowReplay: true });
      fetchLatestSaleForToast({ forceNew: true }).then(function(sale) {
        const next = buildSaleToastPayloadFromSale(sale);
        if (!next) return;
        if (saleToastActive) setSaleToastContent(next);
      });
    }

    (function initSaleToastToggle() {
      function handleToggle(e) {
        if (e && typeof e.preventDefault === 'function') e.preventDefault();
        if (saleToastPinned) {
          saleToastPinned = false;
          updateSaleToastToggle();
          hideSaleToast();
        } else {
          triggerManualSaleToast(true);
        }
      }
      function primeOnPointerDown() { try { primeSaleAudio(); } catch (_) {} }
      ['last-sale-toggle', 'footer-last-sale-toggle'].forEach(function(id) {
        var btn = document.getElementById(id);
        if (btn) {
          btn.addEventListener('click', handleToggle);
          btn.addEventListener('pointerdown', primeOnPointerDown, { capture: true });
          btn.addEventListener('touchstart', primeOnPointerDown, { capture: true });
        }
      });
      updateSaleToastToggle();
    })();

    (function initSaleToastCloseBtn() {
      var btn = document.getElementById('sale-toast-close');
      if (!btn) return;
      btn.addEventListener('click', function(e) {
        if (e) e.preventDefault();
        saleToastPinned = false;
        updateSaleToastToggle();
        hideSaleToast();
      });
    })();

    function getShopParam() {
      var p = new URLSearchParams(window.location.search);
      var shop = p.get('shop') || '';
      return shop && /\.myshopify\.com$/i.test(shop) ? shop : null;
    }

    function fetchShopifySales() {
      var shop = getShopForSales();
      if (!shop || getStatsRange() !== 'today') {
        // If the store-base-url lookup is done and we still have no shop, stop waiting and fall back to DB.
        if (getStatsRange() === 'today' && storeBaseUrlLoaded && !shop) shopifySalesTodayLoaded = true;
        shopifySalesTodayLoading = false;
        return;
      }
      if (shopifySalesTodayLoading) return;
      shopifySalesTodayLoading = true;
      fetch(API + '/api/shopify-sales?shop=' + encodeURIComponent(shop), { credentials: 'same-origin' })
        .then(function(r) { return r.ok ? r.json() : null; })
        .then(function(data) {
          shopifySalesToday = data && typeof data.salesToday === 'number' ? data.salesToday : null;
          shopifyOrderCountToday = data && typeof data.orderCountToday === 'number' ? data.orderCountToday : null;
          shopifySalesTodayLoaded = true;
          shopifySalesTodayLoading = false;
          renderSales(statsCache);
          renderLiveKpis(getKpiData());
        })
        .catch(function() {
          shopifySalesToday = null;
          shopifyOrderCountToday = null;
          shopifySalesTodayLoaded = true;
          shopifySalesTodayLoading = false;
          renderSales(statsCache);
          renderLiveKpis(getKpiData());
        });
    }

    function fetchShopifySessions() {
      var shop = getShopForSales();
      if (!shop || getStatsRange() !== 'today') {
        if (getStatsRange() === 'today' && storeBaseUrlLoaded && !shop) shopifySessionsTodayLoaded = true;
        shopifySessionsTodayLoading = false;
        return;
      }
      if (shopifySessionsTodayLoading) return;
      shopifySessionsTodayLoading = true;
      fetch(API + '/api/shopify-sessions?shop=' + encodeURIComponent(shop), { credentials: 'same-origin' })
        .then(function(r) { return r.ok ? r.json() : null; })
        .then(function(data) {
          shopifySessionsToday = data && typeof data.sessionsToday === 'number' ? data.sessionsToday : null;
          shopifySessionsTodayLoaded = true;
          shopifySessionsTodayLoading = false;
          renderLiveKpis(getKpiData());
        })
        .catch(function() {
          shopifySessionsToday = null;
          shopifySessionsTodayLoaded = true;
          shopifySessionsTodayLoading = false;
          renderLiveKpis(getKpiData());
        });
    }

    function fetchBestSellers(options = {}) {
      const force = !!options.force;
      var shop = getShopParam() || shopForSalesFallback || null;
      if (!shop) {
        bestSellersCache = null;
        renderBestSellers(null);
        return Promise.resolve(null);
      }
      var pageSize = getTableRowsPerPage('best-sellers-table', 'product');
      let url = API + '/api/shopify-best-sellers?shop=' + encodeURIComponent(shop) +
          '&range=' + encodeURIComponent(getStatsRange()) +
          '&page=' + encodeURIComponent(String(bestSellersPage || 1)) +
          '&pageSize=' + encodeURIComponent(String(pageSize)) +
          '&sort=' + encodeURIComponent(String(bestSellersSortBy || 'rev')) +
          '&dir=' + encodeURIComponent(String(bestSellersSortDir || 'desc'));
      if (force) url += '&_=' + Date.now();
      return fetchWithTimeout(url, { credentials: 'same-origin', cache: force ? 'no-store' : 'default' }, 30000)
        .then(function(r) { return r.json().then(function(data) { return { ok: r.ok, status: r.status, data: data || {} }; }).catch(function() { return { ok: r.ok, status: r.status, data: {} }; }); })
        .then(function(result) {
          if (result.ok) {
            bestSellersCache = result.data;
            renderProductsChart(result.data);
            renderBestSellers(result.data);
            return result.data;
          }
          var msg = (result.data && result.data.error) ? result.data.error : ('Error ' + result.status);
          if (result.data && result.data.hint) msg += '. ' + result.data.hint;
          bestSellersCache = null;
          renderBestSellers(null, msg);
          return null;
        })
        .catch(function() { bestSellersCache = null; renderBestSellers(null); return null; });
    }

    function normalizeProductsLeaderboardView(v) {
      const s = v != null ? String(v).trim().toLowerCase() : '';
      return s === 'type' ? 'type' : 'title';
    }

    function labelForProductsLeaderboardView(view) {
      return normalizeProductsLeaderboardView(view) === 'type' ? 'Product Type' : 'Product Title';
    }

    function updateProductsLeaderboardDropdownUi() {
      const view = normalizeProductsLeaderboardView(productsLeaderboardView);
      const labelEl = document.getElementById('products-leaderboard-label');
      const grid = document.getElementById('leaderboard-cards-grid');
      const wrap = document.getElementById('leaderboard-cards-wrap');
      const menu = document.getElementById('products-leaderboard-menu');
      if (labelEl) labelEl.textContent = labelForProductsLeaderboardView(view);
      if (grid) grid.setAttribute('data-leaderboard-view', view);
      if (wrap) wrap.setAttribute('data-leaderboard-view', view);
      if (menu) {
        const opts = menu.querySelectorAll('.aov-cards-title-option');
        opts.forEach(function(el) {
          const v = normalizeProductsLeaderboardView(el && el.getAttribute ? el.getAttribute('data-view') : '');
          el.setAttribute('aria-current', v === view ? 'true' : 'false');
        });
      }
    }

    function closeProductsLeaderboardMenu() {
      const btn = document.getElementById('products-leaderboard-btn');
      const menu = document.getElementById('products-leaderboard-menu');
      if (btn) btn.setAttribute('aria-expanded', 'false');
      if (menu) {
        menu.classList.remove('open');
        menu.setAttribute('aria-hidden', 'true');
      }
    }

    function toggleProductsLeaderboardMenu() {
      const btn = document.getElementById('products-leaderboard-btn');
      const menu = document.getElementById('products-leaderboard-menu');
      if (!btn || !menu) return;
      const open = btn.getAttribute('aria-expanded') === 'true';
      if (open) {
        closeProductsLeaderboardMenu();
      } else {
        btn.setAttribute('aria-expanded', 'true');
        menu.classList.add('open');
        menu.setAttribute('aria-hidden', 'false');
      }
    }

    function setProductsLeaderboardView(nextView, options = {}) {
      const force = !!(options && options.force);
      const view = normalizeProductsLeaderboardView(nextView);
      productsLeaderboardView = view;
      try { sessionStorage.setItem(PRODUCTS_LEADERBOARD_VIEW_KEY, view); } catch (_) {}
      updateProductsLeaderboardDropdownUi();
      closeProductsLeaderboardMenu();
      renderProductsLeaderboard(leaderboardCache);
      if (activeMainTab !== 'breakdown' && activeMainTab !== 'products') return;
      fetchProductsLeaderboard({ force }).catch(function() {});
    }

    (function initProductsLeaderboardDropdown() {
      updateProductsLeaderboardDropdownUi();
      const btn = document.getElementById('products-leaderboard-btn');
      const menu = document.getElementById('products-leaderboard-menu');
      const root = document.getElementById('products-leaderboard-dropdown');
      if (!btn || !menu || !root) return;
      btn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        toggleProductsLeaderboardMenu();
      });
      menu.addEventListener('click', function(e) {
        const t = e && e.target ? e.target : null;
        const opt = t && t.closest ? t.closest('.aov-cards-title-option') : null;
        if (!opt) return;
        e.preventDefault();
        e.stopPropagation();
        setProductsLeaderboardView(opt.getAttribute('data-view') || '', { force: false });
      });
      document.addEventListener('click', function(e) {
        const target = e && e.target ? e.target : null;
        if (target && root.contains && root.contains(target)) return;
        closeProductsLeaderboardMenu();
      });
      document.addEventListener('keydown', function(e) {
        if (!e || e.key !== 'Escape') return;
        closeProductsLeaderboardMenu();
      });
    })();

    function normalizeProductsVariantCardsView(v) {
      const s = v != null ? String(v).trim().toLowerCase() : '';
      if (s === 'lengths' || s === 'length') return 'lengths';
      return 'finishes';
    }

    function labelForProductsVariantCardsView(view) {
      return normalizeProductsVariantCardsView(view) === 'lengths' ? 'Variant Length' : 'Variant Finish';
    }

    function updateProductsVariantCardsDropdownUi() {
      const view = normalizeProductsVariantCardsView(productsVariantCardsView);
      const labelEl = document.getElementById('products-variant-cards-label');
      const grid = document.getElementById('finishes-cards-grid');
      const wrap = document.getElementById('finishes-cards-wrap');
      const menu = document.getElementById('products-variant-cards-menu');
      if (labelEl) labelEl.textContent = labelForProductsVariantCardsView(view);
      if (grid) grid.setAttribute('data-cards-view', view);
      if (wrap) wrap.setAttribute('data-cards-view', view);
      if (menu) {
        const opts = menu.querySelectorAll('.aov-cards-title-option');
        opts.forEach(function(el) {
          const v = normalizeProductsVariantCardsView(el && el.getAttribute ? el.getAttribute('data-view') : '');
          el.setAttribute('aria-current', v === view ? 'true' : 'false');
        });
      }
    }

    function closeProductsVariantCardsMenu() {
      const btn = document.getElementById('products-variant-cards-btn');
      const menu = document.getElementById('products-variant-cards-menu');
      if (btn) btn.setAttribute('aria-expanded', 'false');
      if (menu) {
        menu.classList.remove('open');
        menu.setAttribute('aria-hidden', 'true');
      }
    }

    function toggleProductsVariantCardsMenu() {
      const btn = document.getElementById('products-variant-cards-btn');
      const menu = document.getElementById('products-variant-cards-menu');
      if (!btn || !menu) return;
      const open = btn.getAttribute('aria-expanded') === 'true';
      if (open) {
        closeProductsVariantCardsMenu();
      } else {
        btn.setAttribute('aria-expanded', 'true');
        menu.classList.add('open');
        menu.setAttribute('aria-hidden', 'false');
      }
    }

    function setProductsVariantCardsView(nextView, options = {}) {
      const force = !!(options && options.force);
      const view = normalizeProductsVariantCardsView(nextView);
      productsVariantCardsView = view;
      try { sessionStorage.setItem(PRODUCTS_VARIANT_CARDS_VIEW_KEY, view); } catch (_) {}
      updateProductsVariantCardsDropdownUi();
      closeProductsVariantCardsMenu();
      if (activeMainTab !== 'breakdown' && activeMainTab !== 'products') return;
      if (view === 'lengths') {
        if (lengthsCache) renderLengths(lengthsCache);
        fetchLengths({ force }).catch(function() {});
      } else {
        if (finishesCache) renderFinishes(finishesCache);
        fetchFinishes({ force }).catch(function() {});
      }
    }

    (function initProductsVariantCardsDropdown() {
      updateProductsVariantCardsDropdownUi();
      const btn = document.getElementById('products-variant-cards-btn');
      const menu = document.getElementById('products-variant-cards-menu');
      const root = document.getElementById('products-variant-cards-dropdown');
      if (!btn || !menu || !root) return;
      btn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        toggleProductsVariantCardsMenu();
      });
      menu.addEventListener('click', function(e) {
        const t = e && e.target ? e.target : null;
        const opt = t && t.closest ? t.closest('.aov-cards-title-option') : null;
        if (!opt) return;
        e.preventDefault();
        e.stopPropagation();
        setProductsVariantCardsView(opt.getAttribute('data-view') || '', { force: false });
      });
      document.addEventListener('click', function(e) {
        const target = e && e.target ? e.target : null;
        if (target && root.contains && root.contains(target)) return;
        closeProductsVariantCardsMenu();
      });
      document.addEventListener('keydown', function(e) {
        if (!e || e.key !== 'Escape') return;
        closeProductsVariantCardsMenu();
      });
    })();

    function fetchProductsLeaderboard(options = {}) {
      const force = !!options.force;
      var shop = getShopParam() || shopForSalesFallback || null;
      if (!shop) {
        leaderboardLoading = false;
        leaderboardCache = null;
        renderProductsLeaderboard(null);
        return Promise.resolve(null);
      }
      leaderboardLoading = true;
      if (!leaderboardCache) renderProductsLeaderboard(null);
      let url = API + '/api/shopify-leaderboard?shop=' + encodeURIComponent(shop) +
        '&topProducts=' + encodeURIComponent(String(PRODUCTS_LEADERBOARD_FETCH_LIMIT)) +
        '&topTypes=' + encodeURIComponent(String(PRODUCTS_LEADERBOARD_FETCH_LIMIT)) +
        '&range=' + encodeURIComponent(getStatsRange());
      if (force) url += '&_=' + Date.now();
      return fetchWithTimeout(url, { credentials: 'same-origin', cache: force ? 'no-store' : 'default' }, 30000)
        .then(function(r) { return r.ok ? r.json() : null; })
        .then(function(data) {
          leaderboardCache = data;
          leaderboardLoading = false;
          renderProductsLeaderboard(data);
          renderAllTypeTables(data);
          return data;
        })
        .catch(function() { leaderboardCache = null; leaderboardLoading = false; renderProductsLeaderboard(null); renderAllTypeTables(null); return null; })
        .finally(function() { leaderboardLoading = false; });
    }

    function productsLeaderboardIsMobile() {
      return !!(window.matchMedia && window.matchMedia('(max-width: 768px)').matches);
    }

    function productsLeaderboardIsMedium() {
      return !!(window.matchMedia && window.matchMedia('(max-width: 980px)').matches);
    }

    function productsLeaderboardColumnsForView(view) {
      const v = normalizeProductsLeaderboardView(view);
      const isMobile = productsLeaderboardIsMobile();
      const isMedium = !isMobile && productsLeaderboardIsMedium();
      if (v === 'type') {
        if (isMobile) return 1;
        if (isMedium) return 2;
        return 4;
      }
      // v === 'title'
      if (isMobile) return 2;
      if (isMedium) return 4;
      return 6;
    }

    function productsLeaderboardMaxItems() {
      return productsLeaderboardIsMobile() ? 4 : 12;
    }

    function sliceProductsLeaderboardEven(list, view) {
      const arr = Array.isArray(list) ? list : [];
      const cols = productsLeaderboardColumnsForView(view);
      const max = productsLeaderboardMaxItems();
      const target = Math.min(arr.length, max);
      if (target <= 0) return [];
      if (cols <= 1 || target < cols) return arr.slice(0, target);
      const even = target - (target % cols);
      return arr.slice(0, even || target);
    }

    function renderProductsLeaderboard(data) {
      const view = normalizeProductsLeaderboardView(productsLeaderboardView);
      const grid = document.getElementById('leaderboard-cards-grid');
      if (!grid) return;
      grid.setAttribute('data-leaderboard-view', view);

      const hasData = !!(data && data.ok);
      const listAll = hasData ? (view === 'type' ? (data.byType || []) : (data.byTitle || [])) : [];
      const list = sliceProductsLeaderboardEven(listAll, view);

      if (!hasData || !listAll.length) {
        if (leaderboardLoading) {
          grid.innerHTML = '<div class="aov-card aov-card-empty aov-card--leaderboard-loading"><span class="inline-spinner" aria-hidden="true"></span><span>Building leaderboards...</span></div>';
        } else {
          grid.innerHTML = '<div class="aov-card aov-card-empty">No data</div>';
        }
        return;
      }

      if (view === 'type') {
        grid.innerHTML = list.map(function(row) {
          const label = row && (row.label || row.key) ? String(row.label || row.key) : 'Unknown';
          const rev = row && row.revenueGbp != null ? Number(row.revenueGbp) : 0;
          const value = formatMoneyCompact(Number.isFinite(rev) ? rev : 0, 'GBP') || '\u00A30';
          const cr = crPillHtml(row && row.cr);
          return '<div class="aov-card aov-card--leaderboard aov-card--leaderboard-type">' +
              '<div class="aov-card-left"><span class="aov-card-name leaderboard-type-name">' + escapeHtml(label || 'Unknown') + '</span></div>' +
              '<div class="aov-card-value"><span class="aov-card-value-main">' + escapeHtml(value) + '</span>' + cr + '</div>' +
            '</div>';
        }).join('');
        return;
      }

      // view === 'title'
      const mainBase = getMainBaseUrl();
      grid.innerHTML = list.map(function(row) {
        const title = row && row.title != null ? String(row.title) : 'Product';
        const handle = row && row.handle ? String(row.handle) : '';
        const productId = (row && row.product_id) ? String(row.product_id).replace(/^gid:\/\/shopify\/Product\//i, '').trim() : '';
        const thumb = row && row.thumb_url ? String(row.thumb_url) : '';
        const rev = row && row.revenueGbp != null ? Number(row.revenueGbp) : 0;
        const value = formatMoneyCompact(Number.isFinite(rev) ? rev : 0, 'GBP') || '\u00A30';
        const cr = crPillHtml(row && row.cr);
        const productUrl = (mainBase && handle) ? (mainBase + '/products/' + encodeURIComponent(handle)) : '#';
        const canOpen = handle || (productId && /^\d+$/.test(productId));
        const thumbInner = '<span class="thumb-wrap">' +
            (thumb
              ? '<img class="landing-thumb" src="' + escapeHtml(hotImgSquare(thumb) || thumb) + '" alt="" loading="lazy" onerror="this.remove()">'
              : '') +
          '</span>';
        const img = canOpen
          ? '<a class="leaderboard-thumb-link js-product-modal-link" href="' + escapeHtml(productUrl) + '" target="_blank" rel="noopener" aria-label="Open product: ' + escapeHtml(title || 'Product') + '"' +
            (handle ? (' data-product-handle="' + escapeHtml(handle) + '"') : '') +
            (productId && /^\d+$/.test(productId) ? (' data-product-id="' + escapeHtml(productId) + '"') : '') +
            (title ? (' data-product-title="' + escapeHtml(title) + '"') : '') +
            (thumb ? (' data-product-thumb="' + escapeHtml(thumb) + '"') : '') +
          '>' + thumbInner + '</a>'
          : thumbInner;
        return '<div class="aov-card aov-card--leaderboard aov-card--leaderboard-title">' +
            '<div class="aov-card-left">' +
              img +
              '<span class="aov-card-name sr-only">' + escapeHtml(title || 'Product') + '</span>' +
            '</div>' +
            '<div class="aov-card-value"><span class="aov-card-value-main">' + escapeHtml(value) + '</span>' + cr + '</div>' +
          '</div>';
      }).join('');
    }

    // ?????? Product Type Tables (Necklaces, Bracelets, Earrings, Sets, Charms, Extras) ??????
    function setHiddenById(id, hidden) {
      var el = document.getElementById(id);
      if (!el) return;
      el.classList.toggle('is-hidden', !!hidden);
    }

    var TYPE_TABLE_DEFS = [
      { id: 'necklaces', keys: ['necklaces', 'necklace'] },
      { id: 'bracelets', keys: ['bracelets', 'bracelet'] },
      { id: 'earrings',  keys: ['earrings', 'earring'] },
      { id: 'sets',      keys: ['jewellery sets', 'jewellery set', 'jewelry sets', 'jewelry set', 'sets', 'set'] },
      { id: 'charms',    keys: ['charms', 'charm'] },
      { id: 'extras',    keys: ['extras', 'extra'] },
    ];
    function getTypeTablePageSize(def) {
      var id = def && def.id ? ('type-' + def.id + '-table') : '';
      return getTableRowsPerPage(id, 'product');
    }
    var typeTablePages = {};
    TYPE_TABLE_DEFS.forEach(function(d) { typeTablePages[d.id] = 1; });

    function getTypeProducts(data, def) {
      if (!data || !data.productsByType) return [];
      var out = [];
      for (var i = 0; i < def.keys.length; i++) {
        var arr = data.productsByType[def.keys[i]];
        if (Array.isArray(arr)) out = out.concat(arr);
      }
      return out;
    }

    function renderTypeTable(data, def) {
      var tbody = document.getElementById('type-' + def.id + '-body');
      if (!tbody) return;
      var rows = getTypeProducts(data, def);
      var sessionsTotal = 0;
      for (var i = 0; i < rows.length; i++) sessionsTotal += Number(rows[i] && rows[i].sessions) || 0;
      var hideCard = !leaderboardLoading && sessionsTotal <= 0;
      setHiddenById('stats-type-' + def.id, hideCard);
      if (hideCard) {
        tbody.innerHTML = '';
        updateCardPagination('type-' + def.id, 1, 1);
        return;
      }
      if (!rows.length) {
        tbody.innerHTML = '<div class="grid-row" role="row"><div class="grid-cell empty span-all" role="cell">' + (leaderboardLoading ? 'Loading\u2026' : 'No data') + '</div></div>';
        updateCardPagination('type-' + def.id, 1, 1);
        return;
      }
      var pageSize = getTypeTablePageSize(def);
      var totalPages = Math.max(1, Math.ceil(rows.length / pageSize));
      var page = clampPage(typeTablePages[def.id] || 1, totalPages);
      typeTablePages[def.id] = page;
      updateCardPagination('type-' + def.id, page, totalPages);
      var start = (page - 1) * pageSize;
      var pageRows = rows.slice(start, start + pageSize);
      const mainBase = getMainBaseUrl();
      tbody.innerHTML = pageRows.map(function(r) {
        var title = r && r.title ? String(r.title) : '\u2014';
        var orders = r && r.orders != null ? Number(r.orders) : 0;
        var sessions = r && r.sessions != null ? Number(r.sessions) : 0;
        var revNum = r && r.revenueGbp != null ? Number(r.revenueGbp) : null;
        if (!Number.isFinite(revNum)) revNum = null;
        var rev = revNum != null ? formatRevenueTableHtml(revNum) : '\u2014';
        var cr = r && r.cr != null ? pct(r.cr) : '\u2014';
        var vpvNum = (revNum != null && sessions > 0) ? (revNum / sessions) : null;
        var vpv = (vpvNum != null && Number.isFinite(vpvNum)) ? formatRevenue(vpvNum) : '\u2014';
        var handle = r && r.handle ? String(r.handle) : '';
        var productId = (r && r.product_id) ? String(r.product_id).replace(/^gid:\/\/shopify\/Product\//i, '').trim() : '';
        var productUrl = (mainBase && handle) ? (mainBase + '/products/' + encodeURIComponent(handle)) : '#';
        var canOpen = handle || (productId && /^\d+$/.test(productId));
        var nameInner = canOpen
          ? (
              '<a class="kexo-product-link js-product-modal-link" href="' + escapeHtml(productUrl) + '" target="_blank" rel="noopener"' +
                (handle ? (' data-product-handle="' + escapeHtml(handle) + '"') : '') +
                (productId && /^\d+$/.test(productId) ? (' data-product-id="' + escapeHtml(productId) + '"') : '') +
                (title ? (' data-product-title="' + escapeHtml(title) + '"') : '') +
              '>' + escapeHtml(title) + '</a>'
            )
          : escapeHtml(title);
        var name = '<span class="bs-name" title="' + escapeHtml(title) + '">' + nameInner + '</span>';
        return '<div class="grid-row" role="row">' +
          '<div class="grid-cell bs-product-col" role="cell"><div class="product-cell">' + name + '</div></div>' +
          '<div class="grid-cell" role="cell">' + formatSessions(sessions) + '</div>' +
          '<div class="grid-cell" role="cell">' + formatSessions(orders) + '</div>' +
          '<div class="grid-cell" role="cell">' + cr + '</div>' +
          '<div class="grid-cell" role="cell">' + vpv + '</div>' +
          '<div class="grid-cell" role="cell">' + rev + '</div>' +
        '</div>';
      }).join('');
    }

    function renderAllTypeTables(data) {
      TYPE_TABLE_DEFS.forEach(function(def) { renderTypeTable(data, def); });
      // If every type table is hidden (0 sessions), hide the whole row.
      try {
        var rowWrap = document.getElementById('products-type-tables-row');
        if (rowWrap) {
          var anyVisible = false;
          for (var i = 0; i < TYPE_TABLE_DEFS.length; i++) {
            var id = TYPE_TABLE_DEFS[i] && TYPE_TABLE_DEFS[i].id ? String(TYPE_TABLE_DEFS[i].id) : '';
            if (!id) continue;
            var card = document.getElementById('stats-type-' + id);
            if (card && !card.classList.contains('is-hidden')) { anyVisible = true; break; }
          }
          rowWrap.classList.toggle('is-hidden', !anyVisible);
        }
        var note = document.getElementById('products-hidden-tables-note');
        if (note) {
          var hiddenCount = 0;
          for (var i = 0; i < TYPE_TABLE_DEFS.length; i++) {
            var id = TYPE_TABLE_DEFS[i] && TYPE_TABLE_DEFS[i].id ? String(TYPE_TABLE_DEFS[i].id) : '';
            if (!id) continue;
            var card = document.getElementById('stats-type-' + id);
            if (card && card.classList.contains('is-hidden')) hiddenCount++;
          }
          note.style.display = hiddenCount > 0 ? '' : 'none';
        }
      } catch (_) {}
    }

    (function initTypeTablePagination() {
      TYPE_TABLE_DEFS.forEach(function(def) {
        var wrap = document.getElementById('type-' + def.id + '-pagination');
        if (!wrap) return;
        wrap.addEventListener('click', function(e) {
          var link = e.target.closest('a[data-page]');
          if (!link) return;
          e.preventDefault();
          if (link.closest('.page-item.disabled') || link.closest('.page-item.active')) return;
          var pg = parseInt(link.dataset.page, 10);
          if (!pg || pg < 1) return;
          typeTablePages[def.id] = pg;
          renderTypeTable(leaderboardCache, def);
        });
      });
    })();

    (function initProductsLeaderboardResizeWatcher() {
      let raf = null;
      function schedule() {
        if (activeMainTab !== 'products') return;
        if (!leaderboardCache && !leaderboardLoading) return;
        if (typeof requestAnimationFrame !== 'function') {
          renderProductsLeaderboard(leaderboardCache);
          return;
        }
        if (raf) cancelAnimationFrame(raf);
        raf = requestAnimationFrame(function() {
          raf = null;
          if (activeMainTab !== 'products') return;
          renderProductsLeaderboard(leaderboardCache);
        });
      }
      try { window.addEventListener('resize', schedule); } catch (_) {}
    })();

    function fetchFinishes(options = {}) {
      const force = !!options.force;
      var shop = getShopParam() || shopForSalesFallback || null;
      if (!shop) {
        finishesLoading = false;
        finishesCache = null;
        if (normalizeProductsVariantCardsView(productsVariantCardsView) === 'finishes') renderFinishes(null);
        return Promise.resolve(null);
      }
      finishesLoading = true;
      if (!finishesCache && normalizeProductsVariantCardsView(productsVariantCardsView) === 'finishes') renderFinishes(null);
      let url = API + '/api/shopify-finishes?shop=' + encodeURIComponent(shop) +
          '&range=' + encodeURIComponent(getStatsRange());
      if (force) url += '&_=' + Date.now();
      return fetchWithTimeout(url, { credentials: 'same-origin', cache: force ? 'no-store' : 'default' }, 30000)
        .then(function(r) { return r.ok ? r.json() : null; })
        .then(function(data) {
          finishesCache = data;
          if (normalizeProductsVariantCardsView(productsVariantCardsView) === 'finishes') renderFinishes(data);
          return data;
        })
        .catch(function() { finishesCache = null; finishesLoading = false; if (normalizeProductsVariantCardsView(productsVariantCardsView) === 'finishes') renderFinishes(null); return null; })
        .finally(function() { finishesLoading = false; });
    }

    function fetchLengths(options = {}) {
      const force = !!options.force;
      var shop = getShopParam() || shopForSalesFallback || null;
      if (!shop) {
        lengthsLoading = false;
        lengthsCache = null;
        if (normalizeProductsVariantCardsView(productsVariantCardsView) === 'lengths') renderLengths(null);
        return Promise.resolve(null);
      }
      lengthsLoading = true;
      if (!lengthsCache && normalizeProductsVariantCardsView(productsVariantCardsView) === 'lengths') renderLengths(null);
      let url = API + '/api/shopify-lengths?shop=' + encodeURIComponent(shop) +
          '&range=' + encodeURIComponent(getStatsRange());
      if (force) url += '&_=' + Date.now();
      return fetchWithTimeout(url, { credentials: 'same-origin', cache: force ? 'no-store' : 'default' }, 30000)
        .then(function(r) { return r.ok ? r.json() : null; })
        .then(function(data) {
          lengthsCache = data;
          if (normalizeProductsVariantCardsView(productsVariantCardsView) === 'lengths') renderLengths(data);
          return data;
        })
        .catch(function() { lengthsCache = null; lengthsLoading = false; if (normalizeProductsVariantCardsView(productsVariantCardsView) === 'lengths') renderLengths(null); return null; })
        .finally(function() { lengthsLoading = false; });
    }

    function fetchChainStyles(options = {}) {
      const force = !!options.force;
      var shop = getShopParam() || shopForSalesFallback || null;
      if (!shop) {
        chainStylesLoading = false;
        chainStylesCache = null;
        return Promise.resolve(null);
      }
      chainStylesLoading = true;
      let url = API + '/api/shopify-chain-styles?shop=' + encodeURIComponent(shop) +
          '&range=' + encodeURIComponent(getStatsRange());
      if (force) url += '&_=' + Date.now();
      return fetchWithTimeout(url, { credentials: 'same-origin', cache: force ? 'no-store' : 'default' }, 30000)
        .then(function(r) { return r.ok ? r.json() : null; })
        .then(function(data) {
          chainStylesCache = data;
          chainStylesLoading = false;
          return data;
        })
        .catch(function() { chainStylesCache = null; chainStylesLoading = false; return null; })
        .finally(function() { chainStylesLoading = false; });
    }

    function fetchBestVariants(options = {}) {
      const force = !!options.force;
      var shop = getShopParam() || shopForSalesFallback || null;
      if (!shop) {
        bestVariantsCache = null;
        renderBestVariants(null);
        return Promise.resolve(null);
      }
      var pageSize = getTableRowsPerPage('best-variants-table', 'product');
      let url = API + '/api/shopify-best-variants?shop=' + encodeURIComponent(shop) +
          '&range=' + encodeURIComponent(getStatsRange()) +
          '&page=' + encodeURIComponent(String(bestVariantsPage || 1)) +
          '&pageSize=' + encodeURIComponent(String(pageSize));
      if (force) url += '&_=' + Date.now();
      return fetchWithTimeout(url, { credentials: 'same-origin', cache: force ? 'no-store' : 'default' }, 30000)
        .then(function(r) { return r.json().then(function(data) { return { ok: r.ok, status: r.status, data: data || {} }; }).catch(function() { return { ok: r.ok, status: r.status, data: {} }; }); })
        .then(function(result) {
          if (result.ok) {
            bestVariantsCache = result.data;
            renderBestVariants(result.data);
            return result.data;
          }
          var msg = (result.data && result.data.error) ? result.data.error : ('Error ' + result.status);
          if (result.data && result.data.hint) msg += '. ' + result.data.hint;
          bestVariantsCache = null;
          renderBestVariants(null, msg);
          return null;
        })
        .catch(function() { bestVariantsCache = null; renderBestVariants(null); return null; });
    }

    function renderBestVariants(data, errorMessage) {
      const tbody = document.getElementById('best-variants-body');
      if (!tbody) return;
      if (!data || !Array.isArray(data.bestVariants)) {
        setHiddenById('stats-best-variants', false);
        tbody.innerHTML = '<div class="grid-row" role="row"><div class="grid-cell empty span-all" role="cell">' + (errorMessage ? escapeHtml(errorMessage) : 'No shop or no data') + '</div></div>';
        updateSortHeadersInContainer(document.getElementById('best-variants-table'), tableSortState.bestVariants.by, tableSortState.bestVariants.dir);
        updateCardPagination('best-variants', 1, 1);
        return;
      }
      const rows = data.bestVariants.slice();
      var hasSessions = false;
      for (var i = 0; i < rows.length; i++) {
        if ((Number(rows[i] && rows[i].clicks) || 0) > 0) { hasSessions = true; break; }
      }
      setHiddenById('stats-best-variants', !hasSessions);
      if (!hasSessions) {
        tbody.innerHTML = '';
        updateCardPagination('best-variants', 1, 1);
        return;
      }
      const bvBy = (tableSortState.bestVariants.by || 'rev').toString().trim().toLowerCase();
      const bvDir = (tableSortState.bestVariants.dir || 'desc').toString().trim().toLowerCase() === 'asc' ? 'asc' : 'desc';
      function displayVariantName(v) {
        const variantName = (v && v.variant_title && String(v.variant_title).trim()) ? String(v.variant_title).trim() : 'Default';
        const productName = (v && v.title && String(v.title).trim()) ? String(v.title).trim() : '';
        return variantName + (productName ? (' \u2014 ' + productName) : '');
      }
      rows.sort(function(a, b) {
        var primary = 0;
        if (bvBy === 'variant') primary = cmpNullableText(displayVariantName(a), displayVariantName(b), bvDir);
        else if (bvBy === 'sales') primary = cmpNullableNumber(a && a.orders, b && b.orders, bvDir);
        else if (bvBy === 'clicks') primary = cmpNullableNumber(a && a.clicks, b && b.clicks, bvDir);
        else if (bvBy === 'rev') primary = cmpNullableNumber(a && a.revenue, b && b.revenue, bvDir);
        else if (bvBy === 'vpv') primary = cmpNullableNumber(vpvFromRow(a), vpvFromRow(b), bvDir);
        else if (bvBy === 'cr') {
          primary = cmpNullableNumber(a && a.cr, b && b.cr, bvDir) ||
            cmpNullableNumber(a && a.orders, b && b.orders, 'desc');
        }
        function vpvFromRow(r) {
          if (r && typeof r.vpv === 'number' && Number.isFinite(r.vpv)) return r.vpv;
          var rev = r && typeof r.revenue === 'number' ? r.revenue : null;
          var sess = r && (typeof r.clicks === 'number' || typeof r.sessions === 'number') ? (r.clicks != null ? r.clicks : r.sessions) : null;
          return (sess != null && sess > 0 && rev != null) ? (rev / sess) : null;
        }
        return primary ||
          cmpNullableNumber(a && a.revenue, b && b.revenue, 'desc') ||
          cmpNullableNumber(a && a.orders, b && b.orders, 'desc') ||
          cmpNullableText(displayVariantName(a), displayVariantName(b), 'asc');
      });
      const pageSize = (data && typeof data.pageSize === 'number' && data.pageSize > 0)
        ? data.pageSize
        : getTableRowsPerPage('best-variants-table', 'product');
      const totalCount = (data && typeof data.totalCount === 'number' && data.totalCount >= 0) ? data.totalCount : rows.length;
      const totalPages = Math.max(1, Math.ceil(totalCount / pageSize));
      bestVariantsPage = clampPage((data && typeof data.page === 'number') ? data.page : bestVariantsPage, totalPages);
      updateCardPagination('best-variants', bestVariantsPage, totalPages);
      if (rows.length === 0) {
        tbody.innerHTML = '<div class="grid-row" role="row"><div class="grid-cell empty span-all" role="cell">No orders in this range</div></div>';
        updateSortHeadersInContainer(document.getElementById('best-variants-table'), bvBy, bvDir);
        return;
      }
      tbody.innerHTML = rows.map(function(v) {
        const mainBase = getMainBaseUrl();
        const handle = (v && v.handle) ? String(v.handle).trim().toLowerCase() : '';
        const productId = (v && v.product_id) ? String(v.product_id).replace(/^gid:\/\/shopify\/Product\//i, '').trim() : '';
        const productUrl = (mainBase && handle) ? (mainBase + '/products/' + encodeURIComponent(String(handle))) : '#';
        const title = (v && v.title) ? String(v.title).trim() : '';

        const nameText = displayVariantName(v);
        const canOpen = handle || (productId && /^\d+$/.test(productId));
        const nameInner = canOpen
          ? (
              '<a class="kexo-product-link js-product-modal-link" href="' + escapeHtml(productUrl) + '" target="_blank" rel="noopener"' +
                (handle ? (' data-product-handle="' + escapeHtml(handle) + '"') : '') +
                (productId && /^\d+$/.test(productId) ? (' data-product-id="' + escapeHtml(productId) + '"') : '') +
                (title ? (' data-product-title="' + escapeHtml(title) + '"') : '') +
              '>' + escapeHtml(nameText) + '</a>'
            )
          : escapeHtml(nameText);
        const name = '<span class="bs-name" title="' + escapeHtml(nameText) + '">' + nameInner + '</span>';

        const ordersNum = (v && typeof v.orders === 'number') ? v.orders : (v && v.orders != null ? Number(v.orders) : 0);
        const orders = formatSessions(Number(ordersNum) || 0);
        const clicks = (v && typeof v.clicks === 'number') ? formatSessions(v.clicks) : '\u2014';
        const revenue = formatRevenueTableHtml(v && v.revenue != null ? v.revenue : null);
        const crVal = (v && typeof v.cr === 'number') ? v.cr : null;
        const cr = crVal != null ? pct(crVal) : '\u2014';
        const vpvNum = (v && typeof v.vpv === 'number' && Number.isFinite(v.vpv)) ? v.vpv : ((v && v.clicks > 0 && v.revenue != null) ? (v.revenue / v.clicks) : null);
        const vpv = vpvNum != null ? formatRevenue(vpvNum) : '\u2014';

        return '<div class="grid-row" role="row">' +
          '<div class="grid-cell bs-product-col" role="cell"><div class="product-cell">' + name + '</div></div>' +
          '<div class="grid-cell" role="cell">' + clicks + '</div>' +
          '<div class="grid-cell" role="cell">' + orders + '</div>' +
          '<div class="grid-cell" role="cell">' + cr + '</div>' +
          '<div class="grid-cell" role="cell">' + vpv + '</div>' +
          '<div class="grid-cell" role="cell">' + revenue + '</div>' +
        '</div>';
      }).join('');
      updateSortHeadersInContainer(document.getElementById('best-variants-table'), bvBy, bvDir);
    }

    function normalizeChartType(value, fallback) {
      const v = String(value == null ? '' : value).trim().toLowerCase();
      if (v === 'multi-line-labels') return 'line';
      if (v === 'donut') return 'pie';
      if (v === 'radialbar' || v === 'radial-bar') return 'radialbar';
      if (v === 'area' || v === 'bar' || v === 'line' || v === 'pie') return v;
      return normalizeChartType(fallback, 'area');
    }

    // Chart-type switchers were removed theme-wide; keep this helper as a
    // compatibility shim so existing render paths can still pick defaults.
    function ensureChartTypeControls(_chartId, _scope, fallbackType) {
      return normalizeChartType(fallbackType, 'area');
    }

    let productsChartInstance = null;
    let productsChartData = null;

    function ensureThumbWidthParam(url, width) {
      const raw = url != null ? String(url).trim() : '';
      if (!raw) return '';
      const targetWidth = Math.max(32, Number(width) || 100);
      if (/^data:/i.test(raw)) return raw;
      if (/[?&]width=\d+/i.test(raw)) return raw;
      try {
        const u = new URL(raw, window.location.origin);
        if (!u.searchParams.has('width')) u.searchParams.set('width', String(targetWidth));
        return u.toString();
      } catch (_) {
        const joiner = raw.indexOf('?') === -1 ? '?' : '&';
        return raw + joiner + 'width=' + targetWidth;
      }
    }

    function renderProductsChart(data) {
      const el = document.getElementById('products-chart');
      if (!el) return;

      if (typeof ApexCharts === 'undefined') {
        // Avoid an unbounded retry loop if the CDN is blocked (adblock/network).
        const tries = (el.__kexoApexWaitTries || 0) + 1;
        el.__kexoApexWaitTries = tries;
        if (tries >= 25) {
          el.__kexoApexWaitTries = 0;
          captureChartMessage('Chart library failed to load.', 'productsChartLibraryLoad', { chartKey: 'products-chart', tries: tries }, 'error');
          el.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:280px;color:var(--tblr-secondary);text-align:center;padding:0 18px;font-size:.875rem">Chart library failed to load.</div>';
          return;
        }
        setTimeout(function() { renderProductsChart(data); }, 200);
        return;
      }
      try { el.__kexoApexWaitTries = 0; } catch (_) {}
      var chartKey = 'products-chart';
      if (!isChartEnabledByUiConfig(chartKey, true)) {
        if (productsChartInstance) { try { productsChartInstance.destroy(); } catch (_) {} productsChartInstance = null; }
        el.innerHTML = '';
        return;
      }

      if (productsChartInstance) {
        productsChartInstance.destroy();
        productsChartInstance = null;
      }

      if (data) productsChartData = data;
      var d = productsChartData;

      if (!d || !Array.isArray(d.bestSellers) || d.bestSellers.length === 0) {
        el.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:280px;color:var(--tblr-secondary);font-size:.875rem">No product data available</div>';
        return;
      }

      const products = d.bestSellers.slice().sort(function(a, b) {
        return (b.revenue || 0) - (a.revenue || 0);
      }).slice(0, 10);

      if (!products.length) {
        el.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:280px;color:var(--tblr-secondary);font-size:.875rem">No product data available</div>';
        return;
      }

      const mainBase = getMainBaseUrl();
      const chartRows = products.map(function (p) {
        const handle = (p && p.handle != null) ? String(p.handle).trim() : '';
        const productUrl = (mainBase && handle) ? (mainBase + '/products/' + encodeURIComponent(handle)) : '';
        const srcRaw = (p && p.thumb_url) ? (hotImgSquare(String(p.thumb_url)) || String(p.thumb_url)) : '';
        const ogThumb = productUrl ? ((API || '') + '/api/og-thumb?url=' + encodeURIComponent(productUrl) + '&width=100') : '';
        const thumb = ensureThumbWidthParam(srcRaw || ogThumb || '', 100);
        const titleRaw = (p && p.title != null) ? String(p.title).trim() : '';
        const title = titleRaw || 'Unknown Product';
        return {
          title: title,
          titleShort: title.length > 38 ? (title.slice(0, 35) + '...') : title,
          revenue: Number((p && p.revenue) || 0),
          thumb: thumb,
          productUrl: productUrl,
        };
      });

      const chartHeight = Math.max(280, chartRows.length * 30);
      var thumbsHtml = chartRows.map(function(row) {
        var thumb = row.thumb ? ('<img src="' + escapeHtml(row.thumb) + '" alt="" class="products-chart-thumb-img" loading="lazy">') : '<span class="products-chart-thumb-placeholder"></span>';
        return '<div class="products-chart-thumb" title="' + escapeHtml(row.title) + '">' + thumb + '</div>';
      }).join('');
      el.innerHTML = '<div class="products-chart-plot" id="products-chart-plot"></div>' +
        '<div class="products-chart-thumbs" id="products-chart-thumbs" aria-label="Product thumbnails">' + thumbsHtml + '</div>';
      const plotEl = document.getElementById('products-chart-plot');
      if (!plotEl) return;
      const categories = chartRows.map(function(row) { return row.titleShort; });

      var rawMode = chartModeFromUiConfig(chartKey, 'line') || 'line';
      var showEndLabels = rawMode === 'multi-line-labels';
      var mode = rawMode === 'multi-line-labels' ? 'line' : rawMode;
      var palette = chartColorsFromUiConfig(chartKey, ['#3eb3ab']);

      if (mode === 'pie') {
        try {
          var productsPieOpts = {
            chart: {
              type: 'pie',
              height: Math.max(300, chartHeight),
              fontFamily: 'Inter, sans-serif',
              toolbar: { show: false },
            },
            series: chartRows.map(function (row) { return row.revenue; }),
            labels: categories,
            colors: palette,
            dataLabels: { enabled: true, formatter: function(pct) { return (typeof pct === 'number' && isFinite(pct)) ? (pct.toFixed(0) + '%') : ''; } },
            tooltip: {
              custom: function(ctx) {
                var idx = ctx && ctx.dataPointIndex != null ? Number(ctx.dataPointIndex) : -1;
                var row = idx >= 0 && idx < chartRows.length ? chartRows[idx] : null;
                if (!row) return '';
                var thumb = row.thumb
                  ? ('<img src="' + escapeHtml(row.thumb) + '" alt="" style="width:28px;height:28px;border-radius:6px;object-fit:cover;border:1px solid rgba(15,23,42,.08);margin-right:8px;">')
                  : '';
                return '<div style="padding:8px 10px;min-width:170px;">' +
                  '<div style="display:flex;align-items:center;margin-bottom:4px;">' + thumb +
                    '<div style="font-weight:600;font-size:12px;line-height:1.2;">' + escapeHtml(row.title) + '</div>' +
                  '</div>' +
                  '<div style="font-size:12px;color:#475569;">Revenue: <strong style="color:#0f172a;">' + escapeHtml(formatRevenue(row.revenue) || '\u2014') + '</strong></div>' +
                '</div>';
              }
            },
            legend: { position: 'bottom', fontSize: '12px' },
          };
          try {
            var productsPieOverride = chartAdvancedOverrideFromUiConfig(chartKey, 'pie');
            if (productsPieOverride && isPlainObject(productsPieOverride)) {
              productsPieOpts = deepMergeOptions(productsPieOpts, productsPieOverride);
            }
          } catch (_) {}
          productsChartInstance = new ApexCharts(plotEl, productsPieOpts);
          var pieRender = productsChartInstance.render();
          if (pieRender && typeof pieRender.then === 'function') {
            pieRender.catch(function (err) {
              captureChartError(err, 'productsChartRender', { chartKey: 'products-chart', mode: 'pie' });
            });
          }
        } catch (err) {
          captureChartError(err, 'productsChartRender', { chartKey: 'products-chart', mode: 'pie' });
          el.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:280px;color:#ef4444;font-size:.875rem">Chart rendering failed</div>';
        }
        return;
      }

      var chartType = normalizeChartType(mode, 'line');
      try {
        var productsOpts = {
          chart: {
            type: chartType,
            height: chartHeight,
            fontFamily: 'Inter, sans-serif',
            toolbar: { show: false },
          },
          series: [{
            name: 'Revenue',
            data: chartRows.map(function (row) { return row.revenue; })
          }],
          colors: palette,
          stroke: { show: true, width: chartType === 'bar' ? 0 : 3, curve: 'smooth', lineCap: 'round' },
          markers: { size: chartType === 'line' ? 4 : 0, hover: { size: 6 } },
          fill: chartType === 'bar'
            ? { type: 'solid', opacity: 1 }
            : { type: 'gradient', gradient: { opacityFrom: 0.38, opacityTo: 0.08, stops: [0, 100] } },
          plotOptions: chartType === 'bar' ? { bar: { columnWidth: '56%', borderRadius: 3 } } : {},
          dataLabels: (showEndLabels && chartType === 'line') ? {
            enabled: true,
            formatter: function(val, ctx) {
              try {
                var dp = ctx && ctx.dataPointIndex != null ? Number(ctx.dataPointIndex) : -1;
                var w = ctx && ctx.w ? ctx.w : null;
                var last = w && w.globals && Array.isArray(w.globals.labels) ? (w.globals.labels.length - 1) : -1;
                if (dp !== last) return '';
              } catch (_) { return ''; }
              return formatRevenue(Number(val)) || '\u2014';
            },
            style: { fontSize: '10px' },
            background: { enabled: true, borderRadius: 4, padding: 3, opacity: 0.85 },
            offsetY: -3,
          } : { enabled: false },
          xaxis: {
            categories: categories,
            labels: {
              style: { fontSize: '11px' },
              rotate: -18,
              trim: true,
              hideOverlappingLabels: true,
              formatter: function() { return ''; }
            }
          },
          yaxis: {
            min: 0,
            forceNiceScale: true,
            labels: {
              style: { fontSize: '11px' },
              formatter: function(value) { return formatRevenue(Number(value)) || '\u2014'; }
            }
          },
          tooltip: {
            custom: function(ctx) {
              var idx = ctx && ctx.dataPointIndex != null ? Number(ctx.dataPointIndex) : -1;
              var row = idx >= 0 && idx < chartRows.length ? chartRows[idx] : null;
              if (!row) return '';
              var thumb = row.thumb
                ? ('<img src="' + escapeHtml(row.thumb) + '" alt="" style="width:28px;height:28px;border-radius:6px;object-fit:cover;border:1px solid rgba(15,23,42,.08);margin-right:8px;">')
                : '';
              return '<div style="padding:8px 10px;min-width:170px;">' +
                '<div style="display:flex;align-items:center;margin-bottom:4px;">' + thumb +
                  '<div style="font-weight:600;font-size:12px;line-height:1.2;">' + escapeHtml(row.title) + '</div>' +
                '</div>' +
                '<div style="font-size:12px;color:#475569;">Revenue: <strong style="color:#0f172a;">' + escapeHtml(formatRevenue(row.revenue) || '\u2014') + '</strong></div>' +
              '</div>';
            }
          },
          grid: {
            borderColor: '#eef2f6',
            strokeDashArray: 3,
            padding: { left: 4, right: 8, top: 8, bottom: 8 }
          }
        };
        try {
          var productsOverride = chartAdvancedOverrideFromUiConfig(chartKey, chartType);
          if (productsOverride && isPlainObject(productsOverride)) {
            productsOpts = deepMergeOptions(productsOpts, productsOverride);
          }
        } catch (_) {}
        productsChartInstance = new ApexCharts(plotEl, productsOpts);
        var productsRender = productsChartInstance.render();
        if (productsRender && typeof productsRender.then === 'function') {
          productsRender.catch(function (err) {
            captureChartError(err, 'productsChartRender', { chartKey: 'products-chart', mode: chartType });
          });
        }
      } catch (err) {
        captureChartError(err, 'productsChartRender', { chartKey: 'products-chart', mode: chartType });
        el.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:280px;color:#ef4444;font-size:.875rem">Chart rendering failed</div>';
      }
    }

    function renderBestSellers(data, errorMessage) {
      const tbody = document.getElementById('best-sellers-body');
      if (!tbody) return;
      if (!data || !Array.isArray(data.bestSellers)) {
        setHiddenById('stats-best-sellers', false);
        tbody.innerHTML = '<div class="grid-row" role="row"><div class="grid-cell empty span-all" role="cell">' + (errorMessage ? escapeHtml(errorMessage) : 'No shop or no data') + '</div></div>';
        updateBestSellersSortHeaders();
        updateCardPagination('best-sellers', 1, 1);
        return;
      }
      const rows = data.bestSellers.slice();
      var hasSessions = false;
      for (var i = 0; i < rows.length; i++) {
        if ((Number(rows[i] && rows[i].clicks) || 0) > 0) { hasSessions = true; break; }
      }
      setHiddenById('stats-best-sellers', !hasSessions);
      if (!hasSessions) {
        tbody.innerHTML = '';
        updateCardPagination('best-sellers', 1, 1);
        return;
      }
      const sortKey = (bestSellersSortBy || 'rev').toString().trim().toLowerCase();
      const sortDir = (bestSellersSortDir || 'desc').toString().trim().toLowerCase() === 'asc' ? 'asc' : 'desc';
      rows.sort(function(a, b) {
        if (sortKey === 'title') return cmpNullableText(a && a.title, b && b.title, sortDir);
        if (sortKey === 'orders') return cmpNullableNumber(a && a.orders, b && b.orders, sortDir);
        if (sortKey === 'clicks') return cmpNullableNumber(a && a.clicks, b && b.clicks, sortDir);
        if (sortKey === 'rev') return cmpNullableNumber(a && a.revenue, b && b.revenue, sortDir);
        if (sortKey === 'vpv') return cmpNullableNumber(vpvFromRow(a), vpvFromRow(b), sortDir);
        if (sortKey === 'cr') {
          return cmpNullableNumber(a && a.cr, b && b.cr, sortDir) ||
            cmpNullableNumber(a && a.orders, b && b.orders, 'desc');
        }
        return 0;
      });
      function vpvFromRow(r) {
        if (r && typeof r.vpv === 'number' && Number.isFinite(r.vpv)) return r.vpv;
        var rev = r && typeof r.revenue === 'number' ? r.revenue : null;
        var sess = r && (typeof r.clicks === 'number' || typeof r.sessions === 'number') ? (r.clicks != null ? r.clicks : r.sessions) : null;
        return (sess != null && sess > 0 && rev != null) ? (rev / sess) : null;
      }
      const pageSize = (data && typeof data.pageSize === 'number' && data.pageSize > 0)
        ? data.pageSize
        : getTableRowsPerPage('best-sellers-table', 'product');
      const totalCount = (data && typeof data.totalCount === 'number' && data.totalCount >= 0) ? data.totalCount : rows.length;
      const totalPages = Math.max(1, Math.ceil(totalCount / pageSize));
      bestSellersPage = clampPage((data && typeof data.page === 'number') ? data.page : bestSellersPage, totalPages);
      updateCardPagination('best-sellers', bestSellersPage, totalPages);
      if (rows.length === 0) {
        tbody.innerHTML = '<div class="grid-row" role="row"><div class="grid-cell empty span-all" role="cell">No orders in this range</div></div>';
        updateBestSellersSortHeaders();
        return;
      }
      tbody.innerHTML = rows.map(function(p) {
        const mainBase = getMainBaseUrl();
        const handle = (p && p.handle) ? String(p.handle).trim().toLowerCase() : '';
        const productId = (p && p.product_id) ? String(p.product_id).replace(/^gid:\/\/shopify\/Product\//i, '').trim() : '';
        const productUrl = (mainBase && handle) ? (mainBase + '/products/' + encodeURIComponent(String(handle))) : '#';
        const title = (p && p.title) ? String(p.title).trim() : '';
        const canOpen = handle || (productId && /^\d+$/.test(productId));
        const nameInner = canOpen
          ? (
              '<a class="kexo-product-link js-product-modal-link" href="' + escapeHtml(productUrl) + '" target="_blank" rel="noopener"' +
                (handle ? (' data-product-handle="' + escapeHtml(handle) + '"') : '') +
                (productId && /^\d+$/.test(productId) ? (' data-product-id="' + escapeHtml(productId) + '"') : '') +
                (title ? (' data-product-title="' + escapeHtml(title) + '"') : '') +
              '>' + escapeHtml(title) + '</a>'
            )
          : escapeHtml(title);
        const name = '<span class="bs-name" title="' + escapeHtml(title) + '">' + nameInner + '</span>';
        const orders = String(p.orders != null ? p.orders : 0);
        const clicks = (typeof p.clicks === 'number') ? formatSessions(p.clicks) : '\u2014';
        const revenue = formatRevenueTableHtml(p.revenue);
        const cr = p.cr != null ? pct(p.cr) : '\u2014';
        const vpvNum = vpvFromRow(p);
        const vpv = vpvNum != null ? formatRevenue(vpvNum) : '\u2014';
        return '<div class="grid-row" role="row">' +
          '<div class="grid-cell bs-product-col" role="cell"><div class="product-cell">' + name + '</div></div>' +
          '<div class="grid-cell" role="cell">' + clicks + '</div>' +
          '<div class="grid-cell" role="cell">' + orders + '</div>' +
          '<div class="grid-cell" role="cell">' + cr + '</div>' +
          '<div class="grid-cell" role="cell">' + vpv + '</div>' +
          '<div class="grid-cell" role="cell">' + revenue + '</div>' +
        '</div>';
      }).join('');
      updateBestSellersSortHeaders();
    }

    function updateBestSellersSortHeaders() {
      document.querySelectorAll('#best-sellers-wrap .grid-cell.sortable').forEach(function(th) {
        var col = th.getAttribute('data-sort');
        th.classList.remove('th-sort-asc', 'th-sort-desc');
        th.setAttribute('aria-sort', bestSellersSortBy === col ? (bestSellersSortDir === 'asc' ? 'ascending' : 'descending') : 'none');
        if (bestSellersSortBy === col) th.classList.add(bestSellersSortDir === 'asc' ? 'th-sort-asc' : 'th-sort-desc');
      });
    }

    function setupBestSellersSort() {
      document.querySelectorAll('#best-sellers-wrap .grid-cell.sortable').forEach(function(th) {
        function activate() {
          var col = (th.getAttribute('data-sort') || '').trim();
          if (!col) return;
          if (bestSellersSortBy === col) bestSellersSortDir = bestSellersSortDir === 'asc' ? 'desc' : 'asc';
          else { bestSellersSortBy = col; bestSellersSortDir = col === 'title' ? 'asc' : 'desc'; }
          bestSellersPage = 1;
          updateBestSellersSortHeaders();
          fetchBestSellers();
        }
        th.addEventListener('click', function(e) {
          if (e && typeof e.preventDefault === 'function') e.preventDefault();
          if (shouldIgnoreStickyResizeSortClick(e)) return;
          activate();
        });
        th.addEventListener('keydown', function(e) {
          if (!e || (e.key !== 'Enter' && e.key !== ' ')) return;
          e.preventDefault();
          activate();
        });
      });
    }

    function asSortText(v) {
      if (v == null) return '';
      return String(v).trim().toLowerCase();
    }

    function asFiniteNumber(v) {
      const n = (typeof v === 'number') ? v : Number(v);
      return Number.isFinite(n) ? n : null;
    }

    function cmpNullableText(a, b, dir) {
      const da = asSortText(a);
      const db = asSortText(b);
      const d = dir === 'asc' ? 'asc' : 'desc';
      if (!da && !db) return 0;
      if (!da) return 1;
      if (!db) return -1;
      if (da === db) return 0;
      if (d === 'asc') return da < db ? -1 : 1;
      return da < db ? 1 : -1;
    }

    function cmpNullableNumber(a, b, dir) {
      const na = asFiniteNumber(a);
      const nb = asFiniteNumber(b);
      const d = dir === 'asc' ? 'asc' : 'desc';
      if (na == null && nb == null) return 0;
      if (na == null) return 1;
      if (nb == null) return -1;
      if (na === nb) return 0;
      return d === 'asc' ? (na - nb) : (nb - na);
    }

    function updateSortHeadersInContainer(container, sortBy, sortDir) {
      const root = typeof container === 'string' ? document.querySelector(container) : container;
      if (!root) return;
      root.querySelectorAll('.grid-cell.sortable').forEach(function(th) {
        var col = (th.getAttribute('data-sort') || '').trim();
        th.classList.remove('th-sort-asc', 'th-sort-desc');
        th.setAttribute('aria-sort', sortBy === col ? (sortDir === 'asc' ? 'ascending' : 'descending') : 'none');
        if (sortBy === col) th.classList.add(sortDir === 'asc' ? 'th-sort-asc' : 'th-sort-desc');
      });
    }

    function setupTableSortHeaders(container, state, defaults, onChange) {
      const root = typeof container === 'string' ? document.querySelector(container) : container;
      if (!root || !state) return;
      root.querySelectorAll('.grid-cell.sortable').forEach(function(th) {
        function activate() {
          var col = (th.getAttribute('data-sort') || '').trim();
          if (!col) return;
          var prevCol = state.by;
          if (state.by === col) state.dir = state.dir === 'asc' ? 'desc' : 'asc';
          else { state.by = col; state.dir = (defaults && defaults[col]) ? defaults[col] : 'asc'; }
          state.dir = state.dir === 'asc' ? 'asc' : 'desc';
          updateSortHeadersInContainer(root, state.by, state.dir);
          if (typeof onChange === 'function') onChange({ by: state.by, dir: state.dir, columnChanged: prevCol !== state.by });
        }
        th.addEventListener('click', function(e) {
          if (e && typeof e.preventDefault === 'function') e.preventDefault();
          if (shouldIgnoreStickyResizeSortClick(e)) return;
          activate();
        });
        th.addEventListener('keydown', function(e) {
          if (!e || (e.key !== 'Enter' && e.key !== ' ')) return;
          e.preventDefault();
          activate();
        });
      });
      state.dir = state.dir === 'asc' ? 'asc' : 'desc';
      updateSortHeadersInContainer(root, state.by, state.dir);
    }

    function setupAllTableSorts() {
      setupTableSortHeaders(document.getElementById('country-table'), tableSortState.country, TABLE_SORT_DEFAULTS.country, function(info) {
        if (info && info.columnChanged) countryPage = 1;
        renderCountry(statsCache);
      });
      setupTableSortHeaders(document.getElementById('best-geo-products-table'), tableSortState.bestGeoProducts, TABLE_SORT_DEFAULTS.bestGeoProducts, function(info) {
        if (info && info.columnChanged) bestGeoProductsPage = 1;
        renderBestGeoProducts(statsCache);
      });
      setupTableSortHeaders(document.getElementById('best-variants-table'), tableSortState.bestVariants, TABLE_SORT_DEFAULTS.bestVariants, function(info) {
        if (info && info.columnChanged) {
          bestVariantsPage = 1;
          fetchBestVariants();
          return;
        }
        if (bestVariantsCache) renderBestVariants(bestVariantsCache);
        else fetchBestVariants();
      });
      setupTableSortHeaders(document.getElementById('attribution-table'), tableSortState.attribution, TABLE_SORT_DEFAULTS.attribution, function(info) {
        if (info && info.columnChanged) attributionPage = 1;
        renderAttributionTables(attributionCache || {});
      });
      setupTableSortHeaders(document.getElementById('devices-table'), tableSortState.devices, TABLE_SORT_DEFAULTS.devices, function(info) {
        if (info && info.columnChanged) devicesPage = 1;
        renderDevicesTables(devicesCache || {});
      });
      setupTableSortHeaders(document.getElementById('browsers-table'), tableSortState.browsers, TABLE_SORT_DEFAULTS.browsers, function(info) {
        if (info && info.columnChanged) browsersPage = 1;
        renderBrowsersTables(browsersCache || {});
      });
    }

    function formatSessions(n) {
      if (n == null || typeof n !== 'number') return '\u2014';
      return n.toLocaleString();
    }

    function clampPage(p, totalPages) {
      const n = typeof p === 'number' ? p : parseInt(String(p), 10);
      if (!Number.isFinite(n)) return 1;
      return Math.min(Math.max(1, n), Math.max(1, totalPages || 1));
    }

    function buildPaginationHtml(page, totalPages) {
      var p = Math.max(1, page);
      var tp = Math.max(1, totalPages);
      var chevL = '<i class="fa-light fa-chevron-left" data-icon-key="pagination-prev"></i>';
      var chevR = '<i class="fa-light fa-chevron-right" data-icon-key="pagination-next"></i>';
      var h = '<ul class="pagination m-0">';
      h += '<li class="page-item' + (p <= 1 ? ' disabled' : '') + '"><a class="page-link" href="#" data-page="' + (p - 1) + '" tabindex="-1" aria-label="Previous">' + chevL + '</a></li>';
      // Build page numbers with ellipsis
      var pages = [];
      if (tp <= 7) {
        for (var i = 1; i <= tp; i++) pages.push(i);
      } else {
        pages.push(1);
        if (p > 3) pages.push('...');
        var start = Math.max(2, p - 1);
        var end = Math.min(tp - 1, p + 1);
        if (p <= 3) { start = 2; end = 4; }
        if (p >= tp - 2) { start = tp - 3; end = tp - 1; }
        for (var i = start; i <= end; i++) pages.push(i);
        if (p < tp - 2) pages.push('...');
        pages.push(tp);
      }
      for (var j = 0; j < pages.length; j++) {
        var pg = pages[j];
        if (pg === '...') {
          h += '<li class="page-item disabled"><span class="page-link">...</span></li>';
        } else {
          h += '<li class="page-item' + (pg === p ? ' active' : '') + '"><a class="page-link" href="#" data-page="' + pg + '">' + pg + '</a></li>';
        }
      }
      h += '<li class="page-item' + (p >= tp ? ' disabled' : '') + '"><a class="page-link" href="#" data-page="' + (p + 1) + '" aria-label="Next">' + chevR + '</a></li>';
      h += '</ul>';
      return h;
    }
    try { window.__kexoBuildPaginationHtml = buildPaginationHtml; } catch (_) {}

    function updateCardPagination(prefix, page, totalPages) {
      var wrap = document.getElementById(prefix + '-pagination');
      if (!wrap) return;
      var pages = Math.max(1, totalPages || 1);
      var show = pages > 1;
      wrap.dataset.paginated = show ? '1' : '0';
      wrap.dataset.pages = String(pages);
      wrap.dataset.page = String(page);
      wrap.classList.toggle('is-hidden', !show);
      if (show) wrap.innerHTML = buildPaginationHtml(page, pages);
    }

    function scheduleBreakdownSync() {
      // No-op: layout is handled via CSS grid/flex.
    }

    function renderSales(data) {
      const sales = data.sales || {};
      const salesTodayEl = document.getElementById('sales-today');
      const range = getStatsRange();
      const baseSales = (sales[range] != null ? sales[range] : 0);
      if (salesTodayEl) salesTodayEl.textContent = formatRevenue(baseSales);
      const salesYesterdayEl = document.getElementById('sales-yesterday');
      if (salesYesterdayEl) salesYesterdayEl.textContent = formatRevenue(sales.yesterday);
    }

    function renderConversion(data) {
      const c = data.conversion || {};
      const range = getStatsRange();
      document.getElementById('conversion-range').textContent = pct(c[range]);
      const productCr = (data.productConversion || {})[range];
      const productCrEl = document.getElementById('conversion-product-cr');
      if (productCrEl) productCrEl.textContent = productCr != null ? pct(productCr) : '\u2014';
    }

    function renderSessions(data) {
      const breakdown = data && data.trafficBreakdown ? data.trafficBreakdown : {};
      const forRange = breakdown[getStatsRange()];
      const forYesterday = breakdown.yesterday;
      const main = forRange != null ? forRange.human_sessions : null;
      const yesterday = forYesterday != null ? forYesterday.human_sessions : null;
      const sessionsRangeEl = document.getElementById('sessions-range');
      const sessionsYesterdayEl = document.getElementById('sessions-yesterday');
      if (sessionsRangeEl) sessionsRangeEl.textContent = formatSessions(main);
      if (sessionsYesterdayEl) sessionsYesterdayEl.textContent = formatSessions(yesterday);
    }

    var breakdownAovPage = 1;
    function renderAov(data) {
      const rows = (data.country || {})[getStatsRange()] || [];
      const tbody = document.getElementById('breakdown-aov-body');
      if (!tbody) return;
      const filtered = rows.filter(r => (r && (r.revenue != null || r.aov != null || r.conversion != null)));
      if (filtered.length === 0) {
        tbody.innerHTML = '<div class="grid-row" role="row"><div class="grid-cell empty span-all" role="cell">No data</div></div>';
        updateCardPagination('breakdown-aov', 1, 1);
        return;
      }
      const list = filtered.slice();
      list.sort(function(a, b) {
        return cmpNullableNumber(a && a.revenue, b && b.revenue, 'desc') ||
          cmpNullableNumber(a && a.aov, b && b.aov, 'desc') ||
          cmpNullableNumber(a && a.conversion, b && b.conversion, 'desc');
      });
      var totalPages = Math.max(1, Math.ceil(list.length / TOP_TABLE_PAGE_SIZE));
      breakdownAovPage = clampPage(breakdownAovPage, totalPages);
      updateCardPagination('breakdown-aov', breakdownAovPage, totalPages);
      var start = (breakdownAovPage - 1) * TOP_TABLE_PAGE_SIZE;
      var pageRows = list.slice(start, start + TOP_TABLE_PAGE_SIZE);
      tbody.innerHTML = pageRows.map(r => {
        const iso = (r.country_code || 'XX').toUpperCase().slice(0, 2);
        const label = countryLabelFull(iso);
        const flag = flagImg(iso, label);
        const revenue = r && r.revenue != null ? formatRevenueTableHtml(r.revenue) : '\u2014';
        const aov = r && r.aov != null ? formatRevenueTableHtml(r.aov) : '\u2014';
        const cr = r && r.conversion != null ? pct(r.conversion) : '\u2014';
        return '<div class="grid-row" role="row">' +
          '<div class="grid-cell" role="cell"><span class="country-cell">' + flag + '<span class="country-label"><span class="country-name">' + escapeHtml(label) + '</span></span></span></div>' +
          '<div class="grid-cell" role="cell">' + revenue + '</div>' +
          '<div class="grid-cell" role="cell">' + aov + '</div>' +
          '<div class="grid-cell" role="cell">' + cr + '</div>' +
        '</div>';
      }).join('');
    }

    function renderFinishes(data) {
      const grid = document.getElementById('finishes-cards-grid');
      if (!grid) return;
      const rows = (data && Array.isArray(data.finishes)) ? data.finishes : [];
      if (rows.length === 0) {
        const msg = finishesLoading ? 'Loading finishes\u2026' : 'No data';
        grid.innerHTML = '<div class="aov-card aov-card-empty">' + escapeHtml(msg) + '</div>';
        return;
      }
      function iconFor(key) {
        const k = (key || '').toString().trim().toLowerCase();
        if (k === 'gold') return '<span class="finish-icon finish-icon-gold" aria-hidden="true"></span>';
        if (k === 'silver') return '<span class="finish-icon finish-icon-silver" aria-hidden="true"></span>';
        if (k === 'vermeil') return '<span class="finish-icon finish-icon-vermeil" aria-hidden="true"></span>';
        if (k === 'solid_silver' || k === 'solid-silver') return '<span class="finish-icon finish-icon-solid-silver" aria-hidden="true"></span>';
        return '<span class="finish-icon" aria-hidden="true"></span>';
      }
      const ordered = rows.slice();
      const orderIndex = { gold: 0, silver: 1, vermeil: 2, solid_silver: 3, 'solid-silver': 3 };
      ordered.sort(function(a, b) {
        const primary = cmpNullableNumber(a && a.revenueGbp, b && b.revenueGbp, 'desc');
        if (primary) return primary;
        const ak = a && a.key != null ? String(a.key) : '';
        const bk = b && b.key != null ? String(b.key) : '';
        const ai = Object.prototype.hasOwnProperty.call(orderIndex, ak) ? orderIndex[ak] : 99;
        const bi = Object.prototype.hasOwnProperty.call(orderIndex, bk) ? orderIndex[bk] : 99;
        return ai - bi;
      });
      grid.innerHTML = ordered.map(function(r) {
        const label = (r && r.label != null) ? String(r.label) : '';
        const revenue = (r && r.revenueGbp != null) ? Number(r.revenueGbp) : null;
        const value = (revenue != null && Number.isFinite(revenue)) ? formatRevenueTableHtml(revenue) : '\u2014';
        const cr = crPillHtml(r && r.cr);
        return '<div class="aov-card">' +
          '<div class="aov-card-left">' + iconFor(r && r.key) + '<span class="aov-card-name">' + escapeHtml(label || '\u2014') + '</span></div>' +
          '<div class="aov-card-value"><span class="aov-card-value-main">' + value + '</span>' + cr + '</div>' +
        '</div>';
      }).join('');
    }

    function renderLengths(data) {
      const grid = document.getElementById('finishes-cards-grid');
      if (!grid) return;
      const rows = (data && Array.isArray(data.lengths)) ? data.lengths : [];
      if (rows.length === 0) {
        const msg = lengthsLoading ? 'Loading lengths\u2026' : 'No data';
        grid.innerHTML = '<div class="aov-card aov-card-empty">' + escapeHtml(msg) + '</div>';
        return;
      }
      const ordered = rows.slice();
      ordered.sort(function(a, b) {
        return cmpNullableNumber(a && a.revenueGbp, b && b.revenueGbp, 'desc') ||
          cmpNullableNumber(a && a.inches, b && b.inches, 'asc');
      });
      grid.innerHTML = ordered.map(function(r) {
        const inches = (r && r.inches != null) ? Number(r.inches) : null;
        const label = (r && r.label != null) ? String(r.label) : (inches != null && Number.isFinite(inches) ? (String(inches) + '"') : '');
        const revenue = (r && r.revenueGbp != null) ? Number(r.revenueGbp) : null;
        const value = (revenue != null && Number.isFinite(revenue)) ? formatRevenueTableHtml(revenue) : '\u2014';
        const cr = crPillHtml(r && r.cr);
        const icon = '<span class="length-icon" aria-hidden="true"><span class="length-icon-text">' + escapeHtml(label || '\u2014') + '</span></span>';
        const sr = '<span class="aov-card-name sr-only">' + escapeHtml((label || '\u2014') + ' Inches') + '</span>';
        return '<div class="aov-card aov-card--length">' +
          '<div class="aov-card-left">' + icon + sr + '</div>' +
          '<div class="aov-card-value"><span class="aov-card-value-main">' + value + '</span>' + cr + '</div>' +
        '</div>';
      }).join('');
    }

    var breakdownTitlePage = 1;
    function renderBreakdownTitles(data) {
      const tbody = document.getElementById('breakdown-title-body');
      if (!tbody) return;
      const hasData = !!(data && data.ok);
      const list = hasData ? (data.byTitle || []) : [];
      if (!list.length) {
        tbody.innerHTML = '<div class="grid-row" role="row"><div class="grid-cell empty span-all" role="cell">' + (leaderboardLoading ? 'Loading\u2026' : 'No data') + '</div></div>';
        updateCardPagination('breakdown-title', 1, 1);
        return;
      }
      var totalPages = Math.max(1, Math.ceil(list.length / TOP_TABLE_PAGE_SIZE));
      breakdownTitlePage = clampPage(breakdownTitlePage, totalPages);
      updateCardPagination('breakdown-title', breakdownTitlePage, totalPages);
      var start = (breakdownTitlePage - 1) * TOP_TABLE_PAGE_SIZE;
      var pageRows = list.slice(start, start + TOP_TABLE_PAGE_SIZE);
      const mainBase = getMainBaseUrl();
      tbody.innerHTML = pageRows.map(function(row) {
        const title = row && row.title != null ? String(row.title) : 'Product';
        const handle = row && row.handle ? String(row.handle) : '';
        const productId = (row && row.product_id) ? String(row.product_id).replace(/^gid:\/\/shopify\/Product\//i, '').trim() : '';
        const rev = row && row.revenueGbp != null ? Number(row.revenueGbp) : 0;
        const value = formatMoneyCompact(Number.isFinite(rev) ? rev : 0, 'GBP') || '\u00A30';
        const cr = row && row.cr != null ? pct(row.cr) : '\u2014';
        const productUrl = (mainBase && handle) ? (mainBase + '/products/' + encodeURIComponent(handle)) : '#';
        const placeholderSvg = '<i class="fa-light fa-image" data-icon-key="breakdown-placeholder-image" aria-hidden="true"></i>';
        const normalizedHandle = handle ? String(handle).trim().toLowerCase() : '';
        const canOpen = normalizedHandle || (productId && /^\d+$/.test(productId));
        const titleLink = canOpen
          ? '<a class="kexo-product-link js-product-modal-link" href="' + escapeHtml(productUrl) + '" target="_blank" rel="noopener"' +
              (normalizedHandle ? (' data-product-handle="' + escapeHtml(normalizedHandle) + '"') : '') +
              (productId && /^\d+$/.test(productId) ? (' data-product-id="' + escapeHtml(productId) + '"') : '') +
              (title ? (' data-product-title="' + escapeHtml(title) + '"') : '') +
            '>' + escapeHtml(title) + '</a>'
          : escapeHtml(title);
        return '<div class="grid-row" role="row">' +
          '<div class="grid-cell" role="cell"><span class="breakdown-cell"><span class="breakdown-thumb-wrap" aria-hidden="true">' + placeholderSvg + '</span><span class="breakdown-label"><span class="breakdown-product-name">' + titleLink + '</span><span class="sr-only">' + escapeHtml(title) + '</span></span></span></div>' +
          '<div class="grid-cell" role="cell">' + escapeHtml(value) + '</div>' +
          '<div class="grid-cell" role="cell">' + cr + '</div>' +
        '</div>';
      }).join('');
    }

    function renderBreakdownTypes(data) {
      const tbody = document.getElementById('breakdown-type-body');
      if (!tbody) return;
      const hasData = !!(data && data.ok);
      const list = hasData ? (data.byType || []) : [];
      if (!list.length) {
        tbody.innerHTML = '<div class="grid-row" role="row"><div class="grid-cell empty span-all" role="cell">' + (leaderboardLoading ? 'Loading\u2026' : 'No data') + '</div></div>';
        return;
      }
      const iconSvg = '<span class="breakdown-icon" aria-hidden="true"><i class="fa-light fa-image" data-icon-key="breakdown-icon-image"></i></span>';
      tbody.innerHTML = list.map(function(row) {
        const label = row && (row.label || row.key) ? String(row.label || row.key) : 'Unknown';
        const rev = row && row.revenueGbp != null ? Number(row.revenueGbp) : 0;
        const value = formatMoneyCompact(Number.isFinite(rev) ? rev : 0, 'GBP') || '\u00A30';
        const cr = row && row.cr != null ? pct(row.cr) : '\u2014';
        return '<div class="grid-row" role="row">' +
          '<div class="grid-cell" role="cell"><span class="breakdown-cell">' + iconSvg + '<span class="breakdown-label">' + escapeHtml(label) + '</span></span></div>' +
          '<div class="grid-cell" role="cell">' + escapeHtml(value) + '</div>' +
          '<div class="grid-cell" role="cell">' + cr + '</div>' +
        '</div>';
      }).join('');
    }

    var breakdownFinishPage = 1;
    function renderBreakdownFinishes(data) {
      const tbody = document.getElementById('breakdown-finish-body');
      if (!tbody) return;
      const rows = (data && Array.isArray(data.finishes)) ? data.finishes : [];
      if (!rows.length) {
        tbody.innerHTML = '<div class="grid-row" role="row"><div class="grid-cell empty span-all" role="cell">' + (finishesLoading ? 'Loading\u2026' : 'No data') + '</div></div>';
        updateCardPagination('breakdown-finish', 1, 1);
        return;
      }
      function iconFor(key) {
        const k = (key || '').toString().trim().toLowerCase();
        if (k === 'gold') return '<span class="finish-icon finish-icon-gold" aria-hidden="true"></span>';
        if (k === 'silver') return '<span class="finish-icon finish-icon-silver" aria-hidden="true"></span>';
        if (k === 'vermeil') return '<span class="finish-icon finish-icon-vermeil" aria-hidden="true"></span>';
        if (k === 'solid_silver' || k === 'solid-silver') return '<span class="finish-icon finish-icon-solid-silver" aria-hidden="true"></span>';
        return '<span class="breakdown-icon" aria-hidden="true"><i class="fa-light fa-star" data-icon-key="breakdown-icon-star"></i></span>';
      }
      var ordered = rows.slice();
      ordered.sort(function(a, b) { return cmpNullableNumber(a && a.revenueGbp, b && b.revenueGbp, 'desc'); });
      var totalPages = Math.max(1, Math.ceil(ordered.length / BREAKDOWN_PAGE_SIZE));
      breakdownFinishPage = clampPage(breakdownFinishPage, totalPages);
      updateCardPagination('breakdown-finish', breakdownFinishPage, totalPages);
      var start = (breakdownFinishPage - 1) * BREAKDOWN_PAGE_SIZE;
      var pageRows = ordered.slice(start, start + BREAKDOWN_PAGE_SIZE);
      tbody.innerHTML = pageRows.map(function(r) {
        const label = (r && r.label != null) ? String(r.label) : '\u2014';
        const revenue = (r && r.revenueGbp != null) ? Number(r.revenueGbp) : null;
        const value = (revenue != null && Number.isFinite(revenue)) ? formatRevenueTableHtml(revenue) : '\u2014';
        const cr = r && r.cr != null ? pct(r.cr) : '\u2014';
        return '<div class="grid-row" role="row">' +
          '<div class="grid-cell" role="cell"><span class="breakdown-cell">' + iconFor(r && r.key) + '<span class="breakdown-label">' + escapeHtml(label) + '</span></span></div>' +
          '<div class="grid-cell" role="cell">' + value + '</div>' +
          '<div class="grid-cell" role="cell">' + cr + '</div>' +
        '</div>';
      }).join('');
    }

    var breakdownLengthPage = 1;
    function renderBreakdownLengths(data) {
      const tbody = document.getElementById('breakdown-length-body');
      if (!tbody) return;
      const rows = (data && Array.isArray(data.lengths)) ? data.lengths : [];
      if (!rows.length) {
        tbody.innerHTML = '<div class="grid-row" role="row"><div class="grid-cell empty span-all" role="cell">' + (lengthsLoading ? 'Loading\u2026' : 'No data') + '</div></div>';
        updateCardPagination('breakdown-length', 1, 1);
        return;
      }
      var ordered = rows.slice();
      ordered.sort(function(a, b) {
        return cmpNullableNumber(a && a.revenueGbp, b && b.revenueGbp, 'desc') ||
          cmpNullableNumber(a && a.inches, b && b.inches, 'asc');
      });
      var totalPages = Math.max(1, Math.ceil(ordered.length / BREAKDOWN_PAGE_SIZE));
      breakdownLengthPage = clampPage(breakdownLengthPage, totalPages);
      updateCardPagination('breakdown-length', breakdownLengthPage, totalPages);
      var start = (breakdownLengthPage - 1) * BREAKDOWN_PAGE_SIZE;
      var pageRows = ordered.slice(start, start + BREAKDOWN_PAGE_SIZE);
      const iconSvg = '<span class="breakdown-icon" aria-hidden="true"><i class="fa-light fa-chart-column" data-icon-key="breakdown-icon-chart-column"></i></span>';
      tbody.innerHTML = pageRows.map(function(r) {
        const inches = (r && r.inches != null) ? Number(r.inches) : null;
        const label = (r && r.label != null) ? String(r.label) : (inches != null && Number.isFinite(inches) ? (String(inches) + '"') : '\u2014');
        const revenue = (r && r.revenueGbp != null) ? Number(r.revenueGbp) : null;
        const value = (revenue != null && Number.isFinite(revenue)) ? formatRevenueTableHtml(revenue) : '\u2014';
        const cr = r && r.cr != null ? pct(r.cr) : '\u2014';
        return '<div class="grid-row" role="row">' +
          '<div class="grid-cell" role="cell"><span class="breakdown-cell">' + iconSvg + '<span class="breakdown-label">' + escapeHtml(label) + '</span></span></div>' +
          '<div class="grid-cell" role="cell">' + value + '</div>' +
          '<div class="grid-cell" role="cell">' + cr + '</div>' +
        '</div>';
      }).join('');
    }

    var breakdownChainStylePage = 1;
    function renderBreakdownChainStyles(data) {
      const tbody = document.getElementById('breakdown-chainstyle-body');
      if (!tbody) return;
      const rows = (data && Array.isArray(data.chainStyles)) ? data.chainStyles : [];
      if (!rows.length) {
        tbody.innerHTML = '<div class="grid-row" role="row"><div class="grid-cell empty span-all" role="cell">' + (chainStylesLoading ? 'Loading\u2026' : 'No data') + '</div></div>';
        updateCardPagination('breakdown-chainstyle', 1, 1);
        return;
      }
      var ordered = rows.slice();
      ordered.sort(function(a, b) { return cmpNullableNumber(a && a.revenueGbp, b && b.revenueGbp, 'desc'); });
      var totalPages = Math.max(1, Math.ceil(ordered.length / BREAKDOWN_PAGE_SIZE));
      breakdownChainStylePage = clampPage(breakdownChainStylePage, totalPages);
      updateCardPagination('breakdown-chainstyle', breakdownChainStylePage, totalPages);
      var start = (breakdownChainStylePage - 1) * BREAKDOWN_PAGE_SIZE;
      var pageRows = ordered.slice(start, start + BREAKDOWN_PAGE_SIZE);
      const iconSvg = '<span class="breakdown-icon" aria-hidden="true"><i class="fa-light fa-link" data-icon-key="breakdown-icon-link"></i></span>';
      tbody.innerHTML = pageRows.map(function(r) {
        const label = (r && r.label != null) ? String(r.label) : '\u2014';
        const revenue = (r && r.revenueGbp != null) ? Number(r.revenueGbp) : null;
        const value = (revenue != null && Number.isFinite(revenue)) ? formatRevenueTableHtml(revenue) : '\u2014';
        const cr = r && r.cr != null ? pct(r.cr) : '\u2014';
        return '<div class="grid-row" role="row">' +
          '<div class="grid-cell" role="cell"><span class="breakdown-cell">' + iconSvg + '<span class="breakdown-label">' + escapeHtml(label) + '</span></span></div>' +
          '<div class="grid-cell" role="cell">' + value + '</div>' +
          '<div class="grid-cell" role="cell">' + cr + '</div>' +
        '</div>';
      }).join('');
    }

    function renderCountry(data) {
      const c = data.country || {};
      const rows = c[getStatsRange()] || [];
      const tbody = document.getElementById('by-country-body');
      if (!tbody) return;
      if (rows.length === 0) {
        tbody.innerHTML = '<div class="grid-row" role="row"><div class="grid-cell empty span-all" role="cell">No data</div></div>';
        updateSortHeadersInContainer(document.getElementById('country-table'), tableSortState.country.by, tableSortState.country.dir);
        updateCardPagination('country', 1, 1);
        return;
      }
      const list = rows.slice();
      const countryBy = (tableSortState.country.by || 'rev').toString().trim().toLowerCase();
      const countryDir = (tableSortState.country.dir || 'desc').toString().trim().toLowerCase() === 'asc' ? 'asc' : 'desc';
      function labelFor(r) {
        const code = (r && r.country_code != null ? String(r.country_code) : 'XX').toUpperCase().slice(0, 2);
        return countryLabel(code);
      }
      function countryVpv(r) {
        var rev = r && typeof r.revenue === 'number' ? r.revenue : null;
        var tot = r && typeof r.total === 'number' ? r.total : null;
        return (tot != null && tot > 0 && rev != null) ? (rev / tot) : null;
      }
      list.sort(function(a, b) {
        if (countryBy === 'country') return cmpNullableText(labelFor(a), labelFor(b), countryDir);
        if (countryBy === 'vpv') return cmpNullableNumber(countryVpv(a), countryVpv(b), countryDir) || cmpNullableText(labelFor(a), labelFor(b), 'asc');
        if (countryBy === 'cr') return cmpNullableNumber(a && a.conversion, b && b.conversion, countryDir) || cmpNullableText(labelFor(a), labelFor(b), 'asc');
        if (countryBy === 'sales') return cmpNullableNumber(a && a.converted, b && b.converted, countryDir) || cmpNullableText(labelFor(a), labelFor(b), 'asc');
        if (countryBy === 'clicks') return cmpNullableNumber(a && a.total, b && b.total, countryDir) || cmpNullableText(labelFor(a), labelFor(b), 'asc');
        if (countryBy === 'rev') return cmpNullableNumber(a && a.revenue, b && b.revenue, countryDir) || cmpNullableText(labelFor(a), labelFor(b), 'asc');
        return 0;
      });

      lastCountryRowCount = list.length;
      var countryPageSize = getTableRowsPerPage('country-table', 'live');
      var totalPages = Math.max(1, Math.ceil(list.length / countryPageSize));
      countryPage = clampPage(countryPage, totalPages);
      updateCardPagination('country', countryPage, totalPages);
      var start = (countryPage - 1) * countryPageSize;
      var pageRows = list.slice(start, start + countryPageSize);
      tbody.innerHTML = pageRows.map(r => {
        const code = (r.country_code || 'XX').toUpperCase().slice(0, 2);
        const label = countryLabel(code);
        const conversion = pct(r.conversion);
        const salesCount = r.converted != null ? Number(r.converted) : 0;
        const clicks = r.total != null ? formatSessions(r.total) : '\u2014';
        const revenue = formatRevenueTableHtml(r.revenue);
        const vpvNum = countryVpv(r);
        const vpv = vpvNum != null ? formatRevenue(vpvNum) : '\u2014';
        const flag = flagImg(code, label);
        const labelHtml = '<span class="country-label">' + escapeHtml(label) + '</span>';
        return '<div class="grid-row" role="row">' +
          '<div class="grid-cell" role="cell"><span class="country-cell">' + flag + labelHtml + '</span></div>' +
          '<div class="grid-cell" role="cell">' + clicks + '</div>' +
          '<div class="grid-cell" role="cell">' + salesCount + '</div>' +
          '<div class="grid-cell" role="cell">' + conversion + '</div>' +
          '<div class="grid-cell" role="cell">' + vpv + '</div>' +
          '<div class="grid-cell" role="cell">' + revenue + '</div>' +
        '</div>';
      }).join('');
      updateSortHeadersInContainer(document.getElementById('country-table'), countryBy, countryDir);
      scheduleBreakdownSync();
    }

    // Countries map chart
    let countriesMapChartInstance = null;

    function clearCountriesFlowOverlay(el) {
      if (!el) return;
      var existing = el.querySelector('.kexo-map-flow-overlay');
      if (existing && existing.parentNode) existing.parentNode.removeChild(existing);
    }

    function mapRegionCenter(mapSvg, mapRect, iso2) {
      if (!mapSvg || !mapRect) return null;
      var iso = String(iso2 || '').trim().toUpperCase();
      if (!iso) return null;
      var lowerIso = iso.toLowerCase();
      var node = mapSvg.querySelector('[data-code="' + iso + '"], [data-code="' + lowerIso + '"], .jvm-region-' + lowerIso + ', .jvm-region-' + iso);
      if (!node) return null;
      var rect = node.getBoundingClientRect();
      if (!rect || !(rect.width > 0) || !(rect.height > 0)) return null;
      return {
        x: (rect.left - mapRect.left) + (rect.width / 2),
        y: (rect.top - mapRect.top) + (rect.height / 2),
      };
    }

    function renderCountriesFlowOverlay(el, rows, primaryRgb, originIso2) {
      if (!el) return;
      clearCountriesFlowOverlay(el);
      var mapSvg = el.querySelector('svg');
      if (!mapSvg) return;
      var mapRect = mapSvg.getBoundingClientRect();
      if (!mapRect || !(mapRect.width > 20) || !(mapRect.height > 20)) return;

      var originIso = String(originIso2 || 'GB').trim().toUpperCase().slice(0, 2);
      if (originIso === 'UK') originIso = 'GB';
      if (!originIso) originIso = 'GB';

      var NS = 'http://www.w3.org/2000/svg';
      var overlay = document.createElementNS(NS, 'svg');
      overlay.setAttribute('class', 'kexo-map-flow-overlay');
      overlay.setAttribute('viewBox', '0 0 ' + mapRect.width + ' ' + mapRect.height);
      overlay.setAttribute('width', String(mapRect.width));
      overlay.setAttribute('height', String(mapRect.height));

      var ranked = (Array.isArray(rows) ? rows : [])
        .map(function (r) {
          var rawIso = r && r.country_code != null ? String(r.country_code) : 'XX';
          var iso = rawIso.trim().toUpperCase().slice(0, 2);
          if (iso === 'UK') iso = 'GB';
          return {
            iso: iso,
            orders: Number((r && r.converted) || 0),
          };
        })
        .filter(function (r) { return r.iso && r.iso !== 'XX' && r.iso !== originIso && r.orders > 0; })
        .sort(function (a, b) { return b.orders - a.orders; })
        .slice(0, 8);

      if (!ranked.length) {
        el.appendChild(overlay);
        return;
      }

      var origin = mapRegionCenter(mapSvg, mapRect, originIso) ||
        { x: mapRect.width * 0.52, y: mapRect.height * 0.42 };
      var palette = [
        'rgba(' + primaryRgb + ',0.78)',
        'rgba(' + primaryRgb + ',0.6)',
        'rgba(' + primaryRgb + ',0.44)',
      ];

      ranked.forEach(function (item, idx) {
        var target = mapRegionCenter(mapSvg, mapRect, item.iso);
        if (!target) return;
        var midX = (origin.x + target.x) / 2;
        var bend = Math.max(18, Math.min(74, (Math.abs(target.x - origin.x) * 0.16) + (idx * 3)));
        var midY = (origin.y + target.y) / 2 - bend;
        var stroke = palette[idx % palette.length];

        var path = document.createElementNS(NS, 'path');
        path.setAttribute('class', 'kexo-map-flow-line');
        path.setAttribute('d', 'M ' + origin.x + ' ' + origin.y + ' Q ' + midX + ' ' + midY + ' ' + target.x + ' ' + target.y);
        path.setAttribute('stroke', stroke);
        path.style.animationDelay = String(idx * 0.24) + 's';
        overlay.appendChild(path);

        var dot = document.createElementNS(NS, 'circle');
        dot.setAttribute('class', 'kexo-map-flow-dot');
        dot.setAttribute('cx', String(target.x));
        dot.setAttribute('cy', String(target.y));
        dot.setAttribute('r', '3.2');
        dot.setAttribute('fill', stroke);
        dot.style.animationDelay = String(0.12 + idx * 0.24) + 's';
        overlay.appendChild(dot);
      });

      var originDot = document.createElementNS(NS, 'circle');
      originDot.setAttribute('class', 'kexo-map-flow-origin');
      originDot.setAttribute('cx', String(origin.x));
      originDot.setAttribute('cy', String(origin.y));
      originDot.setAttribute('r', '4.2');
      originDot.setAttribute('fill', 'rgba(' + primaryRgb + ',0.86)');
      overlay.appendChild(originDot);

      el.appendChild(overlay);
    }

    function setCountriesMapState(el, text, opts) {
      if (!el) return;
      var message = String(text == null ? '' : text).trim() || 'Unavailable';
      var isError = !!(opts && opts.error);
      var color = isError ? '#ef4444' : 'var(--tblr-secondary)';
      if (isError) captureChartMessage(message, 'countriesMapState', { chartKey: 'countries-map-chart' }, 'error');
      el.innerHTML =
        '<div style="display:flex;align-items:center;justify-content:center;height:320px;color:' + color + ';text-align:center;padding:0 18px;">' +
          escapeHtml(message) +
        '</div>';
    }

    var WORLD_MAP_ISO2 = ['AE','AF','AG','AL','AM','AO','AR','AT','AU','AZ','BA','BB','BD','BE','BF','BG','BI','BJ','BN','BO','BR','BS','BT','BW','BY','BZ','CA','CD','CF','CG','CH','CI','CL','CM','CN','CO','CR','CU','CV','CY','CZ','DE','DJ','DK','DM','DO','DZ','EC','EE','EG','ER','ES','ET','FI','FJ','FK','FR','GA','GB','GD','GE','GF','GH','GL','GM','GN','GQ','GR','GT','GW','GY','HN','HR','HT','HU','ID','IE','IL','IN','IQ','IR','IS','IT','JM','JO','JP','KE','KG','KH','KM','KN','KP','KR','KW','KZ','LA','LB','LC','LK','LR','LS','LT','LV','LY','MA','MD','MG','MK','ML','MM','MN','MR','MT','MU','MV','MW','MX','MY','MZ','NA','NC','NE','NG','NI','NL','NO','NP','NZ','OM','PA','PE','PF','PG','PH','PK','PL','PT','PY','QA','RE','RO','RS','RU','SA','SB','SC','SD','SE','SI','SK','SL','SN','SO','SR','ST','SV','SY','SZ','TD','TG','TH','TJ','TL','TM','TN','TR','TT','TW','TZ','UA','UG','US','UY','UZ','VE','VN','VU','YE','ZA','ZM','ZW'];
    function buildMapFillScaleByIso(valuesByIso2, primaryRgb, minAlpha, maxAlpha) {
      var src = valuesByIso2 && typeof valuesByIso2 === 'object' ? valuesByIso2 : {};
      var entries = [];
      var keys = Object.keys(src);
      for (var i = 0; i < keys.length; i++) {
        var iso = String(keys[i] || '').trim().toUpperCase();
        if (!iso) continue;
        var n = Number(src[iso]);
        if (!Number.isFinite(n) || n <= 0) continue;
        entries.push({ iso: iso, value: n });
      }
      var defaultFill = 'rgba(' + (primaryRgb || '62,179,171') + ',0.18)';
      var out = {};
      var idx;
      for (idx = 0; idx < WORLD_MAP_ISO2.length; idx++) {
        out[WORLD_MAP_ISO2[idx]] = defaultFill;
      }
      if (entries.length) {
        var min = Infinity;
        var max = -Infinity;
        for (var j = 0; j < entries.length; j++) {
          var v = entries[j].value;
          if (v < min) min = v;
          if (v > max) max = v;
        }
        var lo = typeof minAlpha === 'number' ? minAlpha : 0.24;
        var hi = typeof maxAlpha === 'number' ? maxAlpha : 0.92;
        for (var k = 0; k < entries.length; k++) {
          var row = entries[k];
          var alpha = hi;
          if (max > min) {
            var t = (row.value - min) / (max - min);
            if (!Number.isFinite(t)) t = 0;
            t = Math.max(0, Math.min(1, t));
            alpha = lo + t * (hi - lo);
          }
          out[row.iso] = 'rgba(' + (primaryRgb || '62,179,171') + ',' + alpha + ')';
        }
      }
      return out;
    }

    var mapTooltipScrollBound;
    function hideMapTooltipOnLeave(container) {
      if (!container || container.__kexoMapTooltipCleanup) return;
      container.__kexoMapTooltipCleanup = true;
      function hideTooltips() {
        document.querySelectorAll('.jvm-tooltip').forEach(function(t) { t.style.display = 'none'; });
      }
      container.addEventListener('mouseleave', hideTooltips, { passive: true });
      if (!mapTooltipScrollBound) {
        mapTooltipScrollBound = true;
        window.addEventListener('scroll', hideTooltips, { passive: true });
      }
    }

    function setVectorMapTooltipContent(tooltip, html, text) {
      if (!tooltip) return;
      var htmlContent = html == null ? '' : String(html);
      var textContent = text == null ? '' : String(text);
      try {
        if (typeof tooltip.text === 'function') {
          tooltip.text(htmlContent, true);
          return;
        }
      } catch (_) {}
      try {
        if (typeof tooltip.html === 'function') {
          tooltip.html(htmlContent);
          return;
        }
      } catch (_) {}
      try {
        if (tooltip.element && tooltip.element.nodeType === 1) {
          tooltip.element.innerHTML = htmlContent;
          return;
        }
      } catch (_) {}
      try {
        if (tooltip.nodeType === 1) {
          tooltip.innerHTML = htmlContent;
          return;
        }
      } catch (_) {}
      try {
        if (typeof tooltip.setContent === 'function') {
          tooltip.setContent(htmlContent || textContent);
        }
      } catch (_) {}
    }

    function renderCountriesMapChart(data) {
      const el = document.getElementById('countries-map-chart');
      if (!el) return;
      if (typeof jsVectorMap === 'undefined') {
        if (!el.__kexoJvmWaitTries) {
          setCountriesMapState(el, 'Loading map library...');
        }
        // Avoid an unbounded retry loop if the CDN/map script is blocked (adblock/network).
        const tries = (el.__kexoJvmWaitTries || 0) + 1;
        el.__kexoJvmWaitTries = tries;
        if (tries >= 25) {
          el.__kexoJvmWaitTries = 0;
          setCountriesMapState(el, 'Map library failed to load.', { error: true });
          return;
        }
        setTimeout(function() { renderCountriesMapChart(data); }, 200);
        return;
      }
      try { el.__kexoJvmWaitTries = 0; } catch (_) {}
      var chartKey = 'countries-map-chart';
      if (!isChartEnabledByUiConfig(chartKey, true)) {
        if (countriesMapChartInstance) {
          try { countriesMapChartInstance.destroy(); } catch (_) {}
          countriesMapChartInstance = null;
        }
        clearCountriesFlowOverlay(el);
        setCountriesMapState(el, 'Map disabled in Settings > Charts.');
        return;
      }

      // jsVectorMap snapshots container size at init. If we render while hidden (page loader / collapsed),
      // it can end up with a 0x0 SVG (scale(0)) and never recover. Wait until the container is measurable.
      try {
        var rect = (el && el.getBoundingClientRect) ? el.getBoundingClientRect() : null;
        var w = rect && Number.isFinite(rect.width) ? rect.width : Number(el && el.offsetWidth);
        var h = rect && Number.isFinite(rect.height) ? rect.height : Number(el && el.offsetHeight);
        if (!(w > 20) || !(h > 20)) {
          var tries = (el.__kexoJvmSizeWaitTries || 0) + 1;
          el.__kexoJvmSizeWaitTries = tries;
          if (tries <= 60) {
            setTimeout(function() { renderCountriesMapChart(data); }, 220);
          } else {
            el.__kexoJvmSizeWaitTries = 0;
          }
          return;
        }
        el.__kexoJvmSizeWaitTries = 0;
      } catch (_) {}

      if (countriesMapChartInstance) {
        try { countriesMapChartInstance.destroy(); } catch (_) {}
        countriesMapChartInstance = null;
      }
      clearCountriesFlowOverlay(el);

      const c = data && data.country ? data.country : {};
      const rows = c[getStatsRange()] || [];
      if (!rows.length) {
        setCountriesMapState(el, 'No country data for this range.');
        return;
      }

      const revenueByIso2 = {};
      const ordersByIso2 = {};
      const mapMetricByIso2 = {};
      for (const r of rows || []) {
        let iso = (r && r.country_code != null) ? String(r.country_code).trim().toUpperCase().slice(0, 2) : 'XX';
        if (!iso || iso === 'XX') continue;
        if (iso === 'UK') iso = 'GB';
        const rev = (r && typeof r.revenue === 'number') ? r.revenue : 0;
        const ord = (r && r.converted != null) ? Number(r.converted) : 0;
        if (!Number.isFinite(rev) && !Number.isFinite(ord)) continue;
        revenueByIso2[iso] = (revenueByIso2[iso] || 0) + (Number.isFinite(rev) ? rev : 0);
        ordersByIso2[iso] = (ordersByIso2[iso] || 0) + (Number.isFinite(ord) ? ord : 0);
        const metric = (Number.isFinite(rev) && rev > 0) ? rev : ((Number.isFinite(ord) && ord > 0) ? ord : 0);
        if (metric > 0) {
          mapMetricByIso2[iso] = (mapMetricByIso2[iso] || 0) + metric;
        }
      }

      el.innerHTML = '';
      try {
        const rootCss = getComputedStyle(document.documentElement);
        const border = (rootCss.getPropertyValue('--tblr-border-color') || '#d4dee5').trim();
        const muted = (rootCss.getPropertyValue('--tblr-secondary') || '#626976').trim();
        const rawMode = chartModeFromUiConfig(chartKey, 'map-flat') || 'map-flat';
        const isAnimated = rawMode !== 'map-flat';
        const palette = chartColorsFromUiConfig(chartKey, ['#3eb3ab']);
        const accent = (palette && palette[0]) ? String(palette[0]).trim() : '#3eb3ab';

        function rgbFromColor(c) {
          const s = String(c || '').trim();
          let m = /^#([0-9a-f]{6})$/i.exec(s);
          if (m) {
            const hex = m[1];
            const r = parseInt(hex.slice(0, 2), 16);
            const g = parseInt(hex.slice(2, 4), 16);
            const b = parseInt(hex.slice(4, 6), 16);
            return { r, g, b, rgb: r + ',' + g + ',' + b };
          }
          m = /^rgba?\(\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})/i.exec(s);
          if (m) {
            const r = Math.max(0, Math.min(255, parseInt(m[1], 10) || 0));
            const g = Math.max(0, Math.min(255, parseInt(m[2], 10) || 0));
            const b = Math.max(0, Math.min(255, parseInt(m[3], 10) || 0));
            return { r, g, b, rgb: r + ',' + g + ',' + b };
          }
          return { r: 62, g: 179, b: 171, rgb: '62,179,171' };
        }
        const rgb = rgbFromColor(accent);
        const primaryRgb = rgb.rgb;
        const regionFillByIso2 = buildMapFillScaleByIso(mapMetricByIso2, primaryRgb, 0.24, 0.92);

        countriesMapChartInstance = new jsVectorMap({
          selector: '#countries-map-chart',
          map: 'world',
          backgroundColor: 'transparent',
          zoomButtons: false,
          zoomOnScroll: false,
          zoomAnimate: false,
          regionStyle: {
            initial: { fill: 'rgba(' + primaryRgb + ',0.18)', stroke: border, strokeWidth: 0.7 },
            hover: { fill: 'rgba(' + primaryRgb + ',0.46)' },
            selected: { fill: 'rgba(' + primaryRgb + ',0.78)' },
          },
          onRegionTooltipShow: function(event, tooltip, code) {
            const iso = (code || '').toString().trim().toUpperCase();
            const name = (countriesMapChartInstance && typeof countriesMapChartInstance.getRegionName === 'function')
              ? (countriesMapChartInstance.getRegionName(iso) || iso)
              : iso;
            const rev = revenueByIso2[iso] || 0;
            const ord = ordersByIso2[iso] || 0;
            if (!rev && !ord) {
              setVectorMapTooltipContent(
                tooltip,
                '<div style="min-width:140px;font-weight:600">' + escapeHtml(name) + '</div>',
                name
              );
              return;
            }
            const revHtml = formatRevenue(Number(rev) || 0) || '\u2014';
            const ordHtml = ord ? (formatSessions(ord) + ' orders') : '\u2014';
            setVectorMapTooltipContent(
              tooltip,
              '<div style="min-width:180px">' +
                '<div style="font-weight:600;margin-bottom:2px">' + escapeHtml(name) + '</div>' +
                '<div style="color:' + escapeHtml(muted) + ';font-size:.8125rem">Revenue: <span style="color:inherit">' + escapeHtml(revHtml) + '</span></div>' +
                '<div style="color:' + escapeHtml(muted) + ';font-size:.8125rem">Orders: <span style="color:inherit">' + escapeHtml(ordHtml) + '</span></div>' +
              '</div>',
              name + ' | Revenue: ' + revHtml + ' | Orders: ' + ordHtml
            );
          }
        });

        if (countriesMapChartInstance && countriesMapChartInstance.regions) {
          var regions = countriesMapChartInstance.regions;
          for (var code in regionFillByIso2) {
            if (regions[code] && regions[code].element && typeof regions[code].element.setStyle === 'function') {
              try { regions[code].element.setStyle('fill', regionFillByIso2[code]); } catch (_) {}
            }
          }
        }
        hideMapTooltipOnLeave(el);

        if (isAnimated) {
          setTimeout(function () {
            try { renderCountriesFlowOverlay(el, rows, primaryRgb); } catch (_) {}
          }, 140);
        }
      } catch (err) {
        captureChartError(err, 'countriesMapRender', { chartKey: 'countries-map-chart' });
        console.error('[countries-map] map render error:', err);
        setCountriesMapState(el, 'Map rendering failed.', { error: true });
      }
    }

    function renderBestGeoProducts(data) {
      const map = data && data.bestGeoProducts ? data.bestGeoProducts : {};
      const rows = map[getStatsRange()] || [];
      const tbody = document.getElementById('best-geo-products-body');
      if (!tbody) return;
      if (!Array.isArray(rows) || rows.length === 0) {
        tbody.innerHTML = '<div class="grid-row" role="row"><div class="grid-cell empty span-all" role="cell">No data</div></div>';
        updateSortHeadersInContainer(document.getElementById('best-geo-products-table'), tableSortState.bestGeoProducts.by, tableSortState.bestGeoProducts.dir);
        updateCardPagination('best-geo-products', 1, 1);
        return;
      }
      const list = rows.slice();
      const geoBy = (tableSortState.bestGeoProducts.by || 'rev').toString().trim().toLowerCase();
      const geoDir = (tableSortState.bestGeoProducts.dir || 'desc').toString().trim().toLowerCase() === 'asc' ? 'asc' : 'desc';
      function geoCountryLabel(r) {
        const iso = (r && r.country_code != null ? String(r.country_code) : 'XX').toUpperCase().slice(0, 2);
        return countryLabel(iso);
      }
      function geoProductTitle(r) {
        return (r && r.product_title != null) ? String(r.product_title).trim() : '';
      }
      function geoVpv(r) {
        var rev = r && typeof r.revenue === 'number' ? r.revenue : null;
        var tot = r && typeof r.total === 'number' ? r.total : null;
        return (tot != null && tot > 0 && rev != null) ? (rev / tot) : null;
      }
      list.sort(function(a, b) {
        if (geoBy === 'country') {
          return cmpNullableText(geoCountryLabel(a), geoCountryLabel(b), geoDir) ||
            cmpNullableText(geoProductTitle(a), geoProductTitle(b), 'asc');
        }
        if (geoBy === 'vpv') return cmpNullableNumber(geoVpv(a), geoVpv(b), geoDir) || cmpNullableNumber(a && a.revenue, b && b.revenue, 'desc');
        if (geoBy === 'cr') return cmpNullableNumber(a && a.conversion, b && b.conversion, geoDir) || cmpNullableNumber(a && a.total, b && b.total, 'desc');
        if (geoBy === 'sales') return cmpNullableNumber(a && a.converted, b && b.converted, geoDir) || cmpNullableNumber(a && a.revenue, b && b.revenue, 'desc');
        if (geoBy === 'clicks') return cmpNullableNumber(a && a.total, b && b.total, geoDir) || cmpNullableNumber(a && a.converted, b && b.converted, 'desc');
        if (geoBy === 'rev') return cmpNullableNumber(a && a.revenue, b && b.revenue, geoDir) || cmpNullableNumber(a && a.converted, b && b.converted, 'desc');
        return 0;
      });

      const geoPageSize = getTableRowsPerPage('best-geo-products-table', 'live');
      const totalPages = Math.max(1, Math.ceil(list.length / geoPageSize));
      bestGeoProductsPage = clampPage(bestGeoProductsPage, totalPages);
      updateCardPagination('best-geo-products', bestGeoProductsPage, totalPages);
      const start = (bestGeoProductsPage - 1) * geoPageSize;
      const pageRows = list.slice(start, start + geoPageSize);
      tbody.innerHTML = pageRows.map(r => {
        const iso = (r.country_code || 'XX').toUpperCase().slice(0, 2);
        const label = countryLabel(iso);
        const productTitle = (r.product_title && String(r.product_title).trim()) ? String(r.product_title).trim() : '\u2014';
        const productHandle = (r && r.product_handle != null) ? String(r.product_handle).trim() : '';
        const productId = (r && r.product_id) ? String(r.product_id).replace(/^gid:\/\/shopify\/Product\//i, '').trim() : '';
        const mainBase = getMainBaseUrl();
        const productUrl = (mainBase && productHandle) ? (mainBase + '/products/' + encodeURIComponent(productHandle)) : '#';
        const conversion = pct(r.conversion);
        const salesCount = r.converted != null ? Number(r.converted) : 0;
        const clicks = r.total != null ? formatSessions(r.total) : '\u2014';
        const revenue = formatRevenueTableHtml(r.revenue);
        const vpvNum = (r && r.total > 0 && r.revenue != null) ? (r.revenue / r.total) : null;
        const vpv = vpvNum != null ? formatRevenue(vpvNum) : '\u2014';
        const flag = flagImg(iso, label);
        const normalizedHandle = productHandle ? String(productHandle).trim().toLowerCase() : '';
        const canOpen = normalizedHandle || (productId && /^\d+$/.test(productId));
        const titleLink = canOpen
          ? '<a class="kexo-product-link js-product-modal-link" href="' + escapeHtml(productUrl) + '" target="_blank" rel="noopener"' +
              (normalizedHandle ? (' data-product-handle="' + escapeHtml(normalizedHandle) + '"') : '') +
              (productId && /^\d+$/.test(productId) ? (' data-product-id="' + escapeHtml(productId) + '"') : '') +
              (productTitle ? (' data-product-title="' + escapeHtml(productTitle) + '"') : '') +
            '>' + escapeHtml(productTitle) + '</a>'
          : escapeHtml(productTitle);
        const labelHtml =
          '<span class="country-product-stack">' +
            '<span class="country-label">' + escapeHtml(label) + '</span>' +
            '<span class="country-product-label">' + titleLink + '</span>' +
          '</span>';
        return '<div class="grid-row" role="row">' +
          '<div class="grid-cell" role="cell"><span class="country-cell">' + flag + labelHtml + '</span></div>' +
          '<div class="grid-cell" role="cell">' + clicks + '</div>' +
          '<div class="grid-cell" role="cell">' + salesCount + '</div>' +
          '<div class="grid-cell" role="cell">' + conversion + '</div>' +
          '<div class="grid-cell" role="cell">' + vpv + '</div>' +
          '<div class="grid-cell" role="cell">' + revenue + '</div>' +
        '</div>';
      }).join('');
      updateSortHeadersInContainer(document.getElementById('best-geo-products-table'), geoBy, geoDir);
      scheduleBreakdownSync();
    }

    function isCustomDayRangeKey(v) {
      return typeof v === 'string' && /^d:\d{4}-\d{2}-\d{2}$/.test(v);
    }

    function isCustomRangeKey(v) {
      return typeof v === 'string' && /^r:\d{4}-\d{2}-\d{2}:\d{4}-\d{2}-\d{2}$/.test(v);
    }

    function ymdFromDayKey(dayKey) {
      if (!isCustomDayRangeKey(dayKey)) return null;
      return dayKey.slice(2);
    }

    function ymdRangeFromRangeKey(rangeKey) {
      if (!isCustomRangeKey(rangeKey)) return null;
      const parts = String(rangeKey).split(':');
      if (parts.length !== 3) return null;
      const a = String(parts[1] || '').trim();
      const b = String(parts[2] || '').trim();
      if (!/^\d{4}-\d{2}-\d{2}$/.test(a) || !/^\d{4}-\d{2}-\d{2}$/.test(b)) return null;
      const startYmd = a <= b ? a : b;
      const endYmd = a <= b ? b : a;
      return { startYmd, endYmd };
    }

    function appliedYmdRangeFromDateRange() {
      if (isCustomRangeKey(dateRange)) return ymdRangeFromRangeKey(dateRange);
      if (isCustomDayRangeKey(dateRange)) {
        const ymd = ymdFromDayKey(dateRange);
        return ymd ? { startYmd: ymd, endYmd: ymd } : null;
      }
      return null;
    }

    function formatYmdLabel(ymd) {
      if (!ymd || !/^\d{4}-\d{2}-\d{2}$/.test(String(ymd))) return String(ymd || '');
      const y = parseInt(String(ymd).slice(0, 4), 10);
      const m = parseInt(String(ymd).slice(5, 7), 10);
      const d = parseInt(String(ymd).slice(8, 10), 10);
      if (!Number.isFinite(y) || !Number.isFinite(m) || !Number.isFinite(d)) return String(ymd || '');
      const dt = new Date(Date.UTC(y, m - 1, d, 12, 0, 0));
      try {
        return new Intl.DateTimeFormat('en-GB', { weekday: 'short', day: 'numeric', month: 'short' }).format(dt);
      } catch (_) {
        return String(ymd || '');
      }
    }

    function formatYmdRangeLabel(startYmd, endYmd) {
      if (!startYmd || !endYmd) return '';
      if (startYmd === endYmd) return formatYmdShort(startYmd);
      // Same month? Compact as "5–7 Feb"
      if (startYmd.slice(0, 7) === endYmd.slice(0, 7)) {
        var d1 = parseInt(startYmd.slice(8, 10), 10);
        var d2 = parseInt(endYmd.slice(8, 10), 10);
        var suffix = formatYmdShort(endYmd);
        return d1 + '\u2013' + suffix;
      }
      return formatYmdShort(startYmd) + ' \u2013 ' + formatYmdShort(endYmd);
    }

    function formatYmdShort(ymd) {
      if (!ymd || !/^\d{4}-\d{2}-\d{2}$/.test(String(ymd))) return String(ymd || '');
      var y = parseInt(String(ymd).slice(0, 4), 10);
      var m = parseInt(String(ymd).slice(5, 7), 10);
      var d = parseInt(String(ymd).slice(8, 10), 10);
      if (!Number.isFinite(y) || !Number.isFinite(m) || !Number.isFinite(d)) return String(ymd || '');
      var dt = new Date(Date.UTC(y, m - 1, d, 12, 0, 0));
      try {
        return new Intl.DateTimeFormat('en-GB', { day: 'numeric', month: 'short' }).format(dt);
      } catch (_) {
        return String(ymd || '');
      }
    }

    function makeRangeKeyFromYmds(startYmd, endYmd) {
      const a = String(startYmd || '').trim();
      const b = String(endYmd || '').trim();
      if (!/^\d{4}-\d{2}-\d{2}$/.test(a) || !/^\d{4}-\d{2}-\d{2}$/.test(b)) return null;
      const s = a <= b ? a : b;
      const e = a <= b ? b : a;
      return 'r:' + s + ':' + e;
    }

    function updateLiveViewTitle() {
      const sel = document.getElementById('global-date-select');
      // Date page: sync the table card title with the selected range
      if (PAGE === 'date') {
        const titleEl = document.getElementById('table-title-text');
        if (titleEl) {
          let label = null;
          const applied = appliedYmdRangeFromDateRange();
          if (applied && applied.startYmd && applied.endYmd) {
            label = formatYmdRangeLabel(applied.startYmd, applied.endYmd);
          } else if (sel) {
            const opt = sel.querySelector('option[value="' + dateRange + '"]') || sel.options[sel.selectedIndex];
            label = opt && opt.textContent ? String(opt.textContent).trim() : null;
          }
          const fallback = { today: 'Today', yesterday: 'Yesterday', '3d': 'Last 3 Days', '7d': 'Last 7 Days', '1h': 'Last Hour', custom: 'Custom' };
          titleEl.textContent = label || fallback[dateRange] || 'Today';
        }
      }
    }

    function updateRowsPerPageVisibility() {
      const wrap = document.getElementById('rows-per-page-wrap');
      if (wrap) wrap.classList.toggle('is-hidden', dateRange === 'live');
    }

    function syncHeaderDateDisplay() {
      const sel = document.getElementById('global-date-select');
      const displayBtn = document.getElementById('kexo-date-display');
      if (!sel || !displayBtn) return;

      let label = null;
      try {
        const opt = sel.options[sel.selectedIndex];
        label = opt && opt.textContent ? String(opt.textContent).trim() : null;
      } catch (_) {}

      if (!label) {
        const fallback = { today: 'Today', yesterday: 'Yesterday', '7days': 'Last 7 days', '14days': 'Last 14 days', '30days': 'Last 30 days', custom: 'Custom' };
        label = fallback[String(dateRange || 'today')] || 'Today';
      }
      var lbl = displayBtn.querySelector('.kexo-date-btn-label');
      if (lbl) lbl.textContent = label; else displayBtn.textContent = label;
    }

    function syncHeaderDateMenuAvailability() {
      const sel = document.getElementById('global-date-select');
      const menu = document.getElementById('kexo-date-menu');
      if (!sel || !menu) return;

      // Mirror visibility/disabled + labels from the <select> options.
      try {
        menu.querySelectorAll('[data-range]').forEach(function(item) {
          const key = String(item.getAttribute('data-range') || '').trim();
          if (!key) return;
          const opt = sel.querySelector('option[value="' + key + '"]');
          if (!opt) return;
          const hidden = !!opt.hidden;
          const disabled = !!opt.disabled;
          item.style.display = hidden ? 'none' : '';
          if (disabled) item.setAttribute('disabled', 'disabled');
          else item.removeAttribute('disabled');
          item.classList.toggle('disabled', disabled);
          item.setAttribute('aria-disabled', disabled ? 'true' : 'false');
          if (opt.textContent) item.textContent = String(opt.textContent).trim();
        });
      } catch (_) {}

      // Active item highlight: custom ranges map to the "Custom???" item.
      let active = '';
      try { active = String(sel.value || '').trim(); } catch (_) { active = ''; }
      const isCustom = isCustomRangeKey(active) || isCustomDayRangeKey(active);
      menu.querySelectorAll('[data-range]').forEach(function(btn) {
        const v = String(btn.getAttribute('data-range') || '').trim();
        btn.classList.toggle('active', isCustom ? (v === 'custom') : (v === active));
      });
    }

    function syncPageHeaderTripleLayout(headerRow) {
      try {
        const row =
          headerRow ||
          document.querySelector('.page-header .row.align-items-center') ||
          document.querySelector('.page-header .row');
        if (!row) return;

        const dateCol = row.querySelector('.kexo-page-header-date-col');
        if (!dateCol) {
          row.classList.remove('kexo-page-header-layout-triple');
          return;
        }

        // Skip headers that have other right-side actions (buttons, etc).
        // Only inspect direct children so nested controls inside the date dropdown
        // do not accidentally disable the triple layout. Exclude our own leftCol.
        let hasOtherAuto = false;
        try {
          hasOtherAuto = !!row.querySelector(':scope > .col-auto:not(.kexo-page-header-date-col):not(.kexo-page-header-left-col)');
        } catch (_) {
          hasOtherAuto = Array.prototype.slice.call(row.children || []).some(function(ch) {
            if (!ch || !ch.classList) return false;
            if (!ch.classList.contains('col-auto')) return false;
            if (ch.classList.contains('kexo-page-header-date-col') || ch.classList.contains('kexo-page-header-left-col')) return false;
            return true;
          });
        }
        if (hasOtherAuto) {
          row.classList.remove('kexo-page-header-layout-triple');
          return;
        }

        const pretitle = row.querySelector('.page-pretitle');
        const title = row.querySelector('.page-title');
        if (!pretitle || !title) return;

        const legacyPretitleParent = pretitle.parentElement;
        const legacyTitleParent = title.parentElement;

        let leftCol = row.querySelector('.kexo-page-header-left-col');
        if (!leftCol) {
          leftCol = document.createElement('div');
          leftCol.className = 'col-auto kexo-page-header-left-col';
        }

        let titleCol = row.querySelector('.kexo-page-header-title-col');
        if (!titleCol) {
          titleCol = document.createElement('div');
          titleCol.className = 'col kexo-page-header-title-col';
        }

        // Ensure order: left, title, date.
        if (leftCol.parentElement !== row) {
          row.insertBefore(leftCol, row.firstChild || null);
        }
        if (titleCol.parentElement !== row) {
          row.insertBefore(titleCol, dateCol);
        }
        if (dateCol.parentElement === row && dateCol.nextElementSibling) {
          row.appendChild(dateCol);
        }

        if (pretitle.parentElement !== leftCol) leftCol.appendChild(pretitle);
        if (title.parentElement !== titleCol) titleCol.appendChild(title);

        // Clean up legacy wrapper(s) if we emptied them.
        try {
          [legacyPretitleParent, legacyTitleParent].forEach(function(p) {
            if (!p) return;
            if (p === leftCol || p === titleCol || p === row) return;
            if (p.children && p.children.length === 0) p.remove();
          });
        } catch (_) {}

        row.classList.add('kexo-page-header-layout-triple');
      } catch (_) {}
    }

    function mountDesktopDatePickerIntoPageHeader() {
      try {
        const sourceLi = document.querySelector('.kexo-desktop-nav .kexo-nav-date-slot');
        if (document.body) {
          const page = String(document.body.getAttribute('data-page') || '');
          const dateBtn = document.getElementById('kexo-date-display');
          const dateWrap = dateBtn && dateBtn.closest ? dateBtn.closest('.kexo-topbar-date') : null;
          if (page === 'settings' || page === 'snapshot') return;
          try { if (sourceLi) sourceLi.style.display = ''; } catch (_) {}
          try { if (dateWrap) dateWrap.style.display = ''; } catch (_) {}
        }
        const dateBtn = document.getElementById('kexo-date-display');
        const dateWrap = dateBtn && dateBtn.closest ? dateBtn.closest('.kexo-topbar-date') : null;
        if (!dateWrap) return;
        const headerRow = document.querySelector('.page-header .row.align-items-center') || document.querySelector('.page-header .row');
        const canRelocate = !!headerRow;

        if (!canRelocate) {
          if (sourceLi && dateWrap.parentElement !== sourceLi) {
            sourceLi.appendChild(dateWrap);
          }
          if (sourceLi) {
            sourceLi.classList.add('is-date-inline-fallback');
            sourceLi.classList.remove('is-date-relocated');
          }
          return;
        }

        let dateCol = headerRow.querySelector('.kexo-page-header-date-col');
        if (!dateCol) {
          dateCol = document.createElement('div');
          dateCol.className = 'col-auto kexo-page-header-date-col';
          headerRow.appendChild(dateCol);
        }

        if (dateWrap.parentElement !== dateCol) {
          dateCol.appendChild(dateWrap);
        }
        if (sourceLi) {
          sourceLi.classList.add('is-date-relocated');
          sourceLi.classList.remove('is-date-inline-fallback');
        }
        syncPageHeaderTripleLayout(headerRow);
      } catch (_) {}
    }

    function initHeaderDateMenu() {
      const sel = document.getElementById('global-date-select');
      const menu = document.getElementById('kexo-date-menu');
      if (!sel || !menu) return;
      if (menu.getAttribute('data-kexo-bound') === '1') return;
      menu.setAttribute('data-kexo-bound', '1');

      menu.addEventListener('click', function(e) {
        const target = e && e.target ? e.target : null;
        const btn = target && target.closest ? target.closest('[data-range]') : null;
        if (!btn) return;
        const v = String(btn.getAttribute('data-range') || '').trim();
        if (!v) return;
        if (btn.disabled || btn.classList.contains('disabled') || btn.getAttribute('aria-disabled') === 'true') return;
        sel.value = v;
        try { sel.dispatchEvent(new Event('change', { bubbles: true })); } catch (_) {}
        syncHeaderDateDisplay();
        syncHeaderDateMenuAvailability();
      });

      syncHeaderDateDisplay();
      syncHeaderDateMenuAvailability();
    }

    function syncDateSelectOptions() {
      const sel = document.getElementById('global-date-select');
      if (!sel) return;
      const hasLive = sel.querySelector('option[value="live"]');
      if (hasLive) hasLive.remove();
      // Keep the "Custom" option stable, and create a dynamic option for the currently applied custom range.
      const customOpt = document.getElementById('date-opt-custom') || sel.querySelector('option[value="custom"]');
      if (customOpt) customOpt.textContent = 'Custom';

      // Remove previous dynamic custom-range option(s).
      sel.querySelectorAll('option[data-custom-range="1"]').forEach(function(o) { try { o.remove(); } catch (_) {} });

      // Normalize legacy single-day custom keys into the new range key.
      if (isCustomDayRangeKey(dateRange)) {
        const ymd = ymdFromDayKey(dateRange);
        const rk = ymd ? makeRangeKeyFromYmds(ymd, ymd) : null;
        if (rk) dateRange = rk;
      }

      const applied = appliedYmdRangeFromDateRange();
      if (applied && applied.startYmd && applied.endYmd) {
        customRangeStartYmd = applied.startYmd;
        customRangeEndYmd = applied.endYmd;
        const label = formatYmdRangeLabel(applied.startYmd, applied.endYmd) || 'Selected dates';
        const opt = document.createElement('option');
        opt.value = String(dateRange);
        opt.textContent = label;
        opt.setAttribute('data-custom-range', '1');
        if (customOpt && customOpt.parentNode === sel) sel.insertBefore(opt, customOpt);
        else sel.appendChild(opt);
        sel.value = String(dateRange);
      } else if (activeMainTab === 'spy' || activeMainTab === 'sales' || activeMainTab === 'date') {
        // Table pages: dropdown stays on Today/Yesterday/Custom.
        sel.value = (dateRange === 'live' || dateRange === 'sales' || dateRange === '1h') ? 'today' : String(dateRange || 'today');
      } else {
        // Other tabs only use day/range ranges; if somehow on live, treat as Today.
        if (dateRange === 'live') {
          dateRange = 'today';
          sessionsTotal = null;
        }
        sel.value = (dateRange === 'live' || dateRange === 'sales' || dateRange === '1h') ? 'today' : String(dateRange || 'today');
      }

      // Apply user-configured labels/visibility for the standard date ranges.
      try { applyDateRangeUiConfigToSelect(sel); } catch (_) {}

      updateLiveViewTitle();
      updateRowsPerPageVisibility();
      syncHeaderDateDisplay();
      syncHeaderDateMenuAvailability();
    }

    function applyRangeAvailable(available) {
      const sel = document.getElementById('global-date-select');
      if (!sel) return;
      const keys = ['today', 'yesterday'];
      const allowYesterday = floorAllowsYesterday();
      if (dateRange === 'yesterday' && !allowYesterday) {
        dateRange = 'today';
        customRangeStartYmd = null;
        customRangeEndYmd = null;
        syncDateSelectOptions();
      }
      keys.forEach((key) => {
        const o = sel.querySelector('option[value="' + key + '"]');
        if (!o) return;
        const ok = key === 'yesterday' ? (allowYesterday && !!(available && available[key])) : !!(available && available[key]);
        o.disabled = !ok;
        try { o.hidden = (key === 'yesterday' && !allowYesterday); } catch (_) {}
      });

      if (dateRange !== 'live' && !isCustomDayRangeKey(dateRange) && !isCustomRangeKey(dateRange) && available && available[dateRange] === false) {
        dateRange = 'today';
        customRangeStartYmd = null;
        customRangeEndYmd = null;
        syncDateSelectOptions();
      }
      updateLiveViewTitle();
      updateRowsPerPageVisibility();
      syncHeaderDateDisplay();
      syncHeaderDateMenuAvailability();
    }

    // Custom date calendar (last 30 days, disabled if no data)
    let availableDaysMemo = null;
    let availableDaysMemoAt = 0;
    let availableDaysInflight = null;
    const AVAILABLE_DAYS_MEMO_TTL_MS = 60 * 1000;

    function fetchAvailableDays(days, opts = {}) {
      const force = !!opts.force;
      const now = Date.now();
      if (!force && availableDaysMemo && (now - availableDaysMemoAt) < AVAILABLE_DAYS_MEMO_TTL_MS) {
        return Promise.resolve(availableDaysMemo);
      }
      if (!force && availableDaysInflight) return availableDaysInflight;
      const url = API + '/api/available-days?days=' + encodeURIComponent(String(days || 30)) + (force ? ('&_=' + now) : '');
      const p = fetchWithTimeout(url, { credentials: 'same-origin', cache: force ? 'no-store' : 'default' }, 20000)
        .then((r) => (r && r.ok) ? r.json() : null)
        .then((data) => {
          if (data && data.ok) {
            availableDaysMemo = data;
            availableDaysMemoAt = Date.now();
          }
          return data;
        })
        .catch(() => null)
        .finally(() => {
          if (availableDaysInflight === p) availableDaysInflight = null;
        });
      availableDaysInflight = p;
      return p;
    }

    function pad2(n) { return String(n).padStart(2, '0'); }

    // Flatpickr instance for custom date picker
    let flatpickrInstance = null;
    let availableDatesSet = new Set();
    let customDateApplyOverride = null; // function({ rangeKey, startYmd, endYmd })
    let customDatePrefillRangeKey = null;

    function initFlatpickrDatePicker(payload) {
      const input = document.getElementById('date-range-picker');
      if (!input) return;

      // Destroy existing instance
      if (flatpickrInstance) {
        flatpickrInstance.destroy();
        flatpickrInstance = null;
      }

      // Parse available days from API
      const data = payload && payload.ok ? payload : null;
      if (data && Array.isArray(data.days)) {
        availableDatesSet = new Set(
          data.days
            .filter(function(d) { return d && d.date && d.hasSessions; })
            .map(function(d) { return String(d.date); })
        );
      }

      // Wait for flatpickr to be available
      if (typeof flatpickr === 'undefined') {
        setTimeout(function() { initFlatpickrDatePicker(payload); }, 200);
        return;
      }

      // Initialize flatpickr
      flatpickrInstance = flatpickr(input, {
        mode: 'range',
        dateFormat: 'Y-m-d',
        maxDate: 'today',
        minDate: MIN_YMD || '2025-02-01',
        disable: [
          function(date) {
            const y = date.getFullYear();
            const m = date.getMonth() + 1;
            const d = date.getDate();
            const ymd = y + '-' + pad2(m) + '-' + pad2(d);
            return !availableDatesSet.has(ymd);
          }
        ],
        onChange: function(selectedDates) {
          if (selectedDates.length === 0) {
            pendingCustomRangeStartYmd = null;
            pendingCustomRangeEndYmd = null;
            updateCustomDateFooter();
            return;
          }
          if (selectedDates.length === 1) {
            const d = selectedDates[0];
            const ymd = d.getFullYear() + '-' + pad2(d.getMonth() + 1) + '-' + pad2(d.getDate());
            pendingCustomRangeStartYmd = ymd;
            pendingCustomRangeEndYmd = null;
            updateCustomDateFooter();
            return;
          }
          if (selectedDates.length === 2) {
            const d1 = selectedDates[0];
            const d2 = selectedDates[1];
            const ymd1 = d1.getFullYear() + '-' + pad2(d1.getMonth() + 1) + '-' + pad2(d1.getDate());
            const ymd2 = d2.getFullYear() + '-' + pad2(d2.getMonth() + 1) + '-' + pad2(d2.getDate());

            // Check 30-day limit
            const diffMs = Math.abs(d2 - d1);
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            if (diffDays > 30) {
              // Exceeded limit - reset
              flatpickrInstance.clear();
              pendingCustomRangeStartYmd = null;
              pendingCustomRangeEndYmd = null;
              updateCustomDateFooter();
              const summaryEl = document.getElementById('date-custom-summary');
              if (summaryEl) summaryEl.textContent = 'Range exceeds 30 days. Please select a shorter period.';
              return;
            }

            pendingCustomRangeStartYmd = ymd1 <= ymd2 ? ymd1 : ymd2;
            pendingCustomRangeEndYmd = ymd1 <= ymd2 ? ymd2 : ymd1;
            updateCustomDateFooter();
          }
        }
      });

      // Set initial dates if already selected
      if (pendingCustomRangeStartYmd && pendingCustomRangeEndYmd) {
        flatpickrInstance.setDate([pendingCustomRangeStartYmd, pendingCustomRangeEndYmd]);
      } else if (pendingCustomRangeStartYmd) {
        flatpickrInstance.setDate(pendingCustomRangeStartYmd);
      }
    }

    function closeCustomDateModal() {
      const modal = document.getElementById('date-custom-modal');
      if (!modal) return;
      modal.style.display = '';
      modal.classList.remove('show');
      document.body.classList.remove('modal-open');
      pendingCustomRangeStartYmd = null;
      pendingCustomRangeEndYmd = null;
      customDateApplyOverride = null;
      customDatePrefillRangeKey = null;
      if (flatpickrInstance) {
        flatpickrInstance.destroy();
        flatpickrInstance = null;
      }
      syncDateSelectOptions();
    }

    var timeframeOverlayToken = 0;
    function applyDateRangeChange(opts) {
      opts = opts && typeof opts === 'object' ? opts : {};
      var showTimeframeOverlay = opts.showTimeframeOverlay === true;
      if (PAGE === 'settings') showTimeframeOverlay = false;

      if (dateRange !== 'live') lastOnlineCount = null;
      countryPage = 1;
      bestGeoProductsPage = 1;
      aovPage = 1;
      bestSellersPage = 1;
      bestVariantsPage = 1;
      attributionPage = 1;
      devicesPage = 1;
      currentPage = 1;
      syncDateSelectOptions();
      // Reset caches when range changes.
      leaderboardCache = null;
      finishesCache = null;
      lengthsCache = null;
      chainStylesCache = null;
      bestSellersCache = null;
      bestVariantsCache = null;
      abandonedCartsChartKey = '';
      abandonedCartsTopCacheKey = '';
      attributionCache = null;
      devicesCache = null;
      lastStatsFetchedAt = 0;
      lastProductsFetchedAt = 0;
      lastAttributionFetchedAt = 0;
      lastDevicesFetchedAt = 0;
      updateNextUpdateUi();

      if (showTimeframeOverlay) {
        timeframeOverlayToken += 1;
        var token = timeframeOverlayToken;
        var dateLabel = 'date range';
        try {
          var applied = appliedYmdRangeFromDateRange();
          if (applied && applied.startYmd && applied.endYmd) {
            dateLabel = formatYmdRangeLabel(applied.startYmd, applied.endYmd) || dateLabel;
          } else {
            var fallback = { today: 'Today', yesterday: 'Yesterday', '7days': 'Last 7 days', '14days': 'Last 14 days', '30days': 'Last 30 days' };
            dateLabel = fallback[String(dateRange || 'today')] || 'Today';
          }
        } catch (_) {}
        var overlay = document.getElementById('page-body-loader');
        var titleEl = overlay && overlay.querySelector ? overlay.querySelector('.report-build-title') : null;
        var stepEl = document.getElementById('page-body-build-step');
        var indeterminateWrap = overlay && overlay.querySelector ? overlay.querySelector('.page-loader-progress:not(.page-loader-progress--determinate)') : null;
        var determinateWrap = document.getElementById('page-body-loader-determinate');
        var determinateBar = document.getElementById('page-body-loader-determinate-bar');
        if (titleEl) titleEl.textContent = 'Preparing ' + dateLabel + ' reports';
        if (stepEl) stepEl.textContent = 'Loading…';
        if (indeterminateWrap) indeterminateWrap.style.display = 'none';
        if (determinateWrap) { determinateWrap.style.display = ''; }
        if (determinateBar) { determinateBar.style.width = '0%'; determinateBar.setAttribute('aria-valuenow', 0); }
        if (overlay) {
          overlay.classList.remove('is-hidden');
          overlay.classList.add('timeframe-overlay');
        }
        var scope = document.querySelector('.page-body');
        if (scope) try { scope.classList.add('report-building'); } catch (_) {}
        try { document.body.classList.add('kexo-report-loading'); } catch (_) {}

        var promises = [];
        try { promises.push(refreshKpis({ force: true })); } catch (_) {}
        try {
          var kexoP = typeof window.refreshKexoScore === 'function' ? window.refreshKexoScore() : null;
          if (kexoP && typeof kexoP.then === 'function') promises.push(kexoP);
        } catch (_) {}
        var tabPromise = null;
        if (activeMainTab === 'stats') { try { tabPromise = refreshStats({ force: false }); } catch (_) {} }
        else if (activeMainTab === 'products') { try { tabPromise = refreshProducts({ force: false }); } catch (_) {} }
        else if (activeMainTab === 'attribution') { try { tabPromise = refreshAttribution({ force: false }); } catch (_) {} }
        else if (activeMainTab === 'devices') { try { tabPromise = refreshDevices({ force: false }); } catch (_) {} }
        else if (activeMainTab === 'browsers') { try { tabPromise = refreshBrowsers({ force: false }); } catch (_) {} }
        else if (activeMainTab === 'variants') {
          try { tabPromise = typeof window.__refreshVariantsInsights === 'function' ? window.__refreshVariantsInsights({ force: true }) : null; } catch (_) {}
        } else if (activeMainTab === 'abandoned-carts') { try { tabPromise = refreshAbandonedCarts({ force: true }); } catch (_) {} }
        if (tabPromise && typeof tabPromise.then === 'function') promises.push(tabPromise);
        if (activeMainTab === 'dashboard') { try { if (typeof refreshDashboard === 'function') refreshDashboard({ force: false }); } catch (_) {} }
        if (activeMainTab === 'ads' || PAGE === 'ads') { try { if (window.__adsRefresh) window.__adsRefresh({ force: false }); } catch (_) {} }
        if (activeMainTab !== 'dashboard' && activeMainTab !== 'stats' && activeMainTab !== 'products' && activeMainTab !== 'attribution' && activeMainTab !== 'devices' && activeMainTab !== 'variants' && activeMainTab !== 'abandoned-carts') {
          updateKpis();
          try { fetchSessions(); } catch (_) {}
        }

        var total = Math.max(1, promises.length);
        var completed = 0;
        function updateProgress(pct) {
          if (timeframeOverlayToken !== token) return;
          var bar = document.getElementById('page-body-loader-determinate-bar');
          if (bar) { bar.style.width = pct + '%'; bar.setAttribute('aria-valuenow', Math.round(pct)); }
        }
        function hideTimeframeOverlay() {
          if (timeframeOverlayToken !== token) return;
          var ov = document.getElementById('page-body-loader');
          if (ov) { ov.classList.add('is-hidden'); ov.classList.remove('timeframe-overlay'); }
          var ind = ov && ov.querySelector ? ov.querySelector('.page-loader-progress:not(.page-loader-progress--determinate)') : null;
          if (ind) ind.style.display = '';
          var det = document.getElementById('page-body-loader-determinate');
          if (det) det.style.display = 'none';
          var detBar = document.getElementById('page-body-loader-determinate-bar');
          if (detBar) { detBar.style.width = '0%'; detBar.setAttribute('aria-valuenow', 0); }
          if (scope) try { scope.classList.remove('report-building'); } catch (_) {}
          try { document.body.classList.remove('kexo-report-loading'); } catch (_) {}
        }
        promises.forEach(function(p) {
          if (p && typeof p.finally === 'function') {
            p.finally(function() {
              completed += 1;
              updateProgress((completed / total) * 100);
              if (completed >= total) hideTimeframeOverlay();
            });
          } else {
            completed += 1;
            updateProgress((completed / total) * 100);
            if (completed >= total) hideTimeframeOverlay();
          }
        });
        if (promises.length === 0) {
          updateProgress(100);
          hideTimeframeOverlay();
        }
        updateKpis();
        return;
      }

      // Top KPI grid refreshes independently (every minute). On range change, force a refresh immediately.
      refreshKpis({ force: false });
      try { refreshKpiExtrasSoft(); } catch (_) {}
      try { if (typeof window.refreshKexoScore === 'function') window.refreshKexoScore(); } catch (_) {}
      // Keep the desktop navbar "visitors" status eager on every range change.
      updateKpis();

      if (activeMainTab === 'dashboard') {
        try { if (typeof refreshDashboard === 'function') refreshDashboard({ force: false }); } catch (_) {}
      } else if (activeMainTab === 'stats') {
        refreshStats({ force: false });
      } else if (activeMainTab === 'attribution') {
        try { refreshAttribution({ force: false }); } catch (_) {}
      } else if (activeMainTab === 'devices') {
        try { refreshDevices({ force: false }); } catch (_) {}
      } else if (activeMainTab === 'browsers') {
        try { refreshBrowsers({ force: false }); } catch (_) {}
      } else if (activeMainTab === 'products') {
        refreshProducts({ force: false });
      } else if (activeMainTab === 'variants') {
        try { if (typeof window.__refreshVariantsInsights === 'function') window.__refreshVariantsInsights({ force: true }); } catch (_) {}
      } else if (activeMainTab === 'abandoned-carts') {
        try { refreshAbandonedCarts({ force: true }); } catch (_) { fetchSessions(); }
      } else if (activeMainTab === 'ads' || PAGE === 'ads') {
        try { if (window.__adsRefresh) window.__adsRefresh({ force: false }); } catch (_) {}
      } else {
        updateKpis();
        fetchSessions();
      }
    }

    function openCustomDateModalFor(opts) {
      const o = opts && typeof opts === 'object' ? opts : {};
      customDateApplyOverride = (typeof o.onApply === 'function') ? o.onApply : null;
      customDatePrefillRangeKey = (o.prefillRangeKey != null) ? String(o.prefillRangeKey).trim().toLowerCase() : null;
      const modal = document.getElementById('date-custom-modal');
      const input = document.getElementById('date-range-picker');
      if (!modal || !input) return;
      modal.style.display = 'block';
      modal.classList.add('show');
      document.body.classList.add('modal-open');
      let applied = null;
      try {
        if (customDatePrefillRangeKey) {
          if (isCustomRangeKey(customDatePrefillRangeKey)) applied = ymdRangeFromRangeKey(customDatePrefillRangeKey);
          else if (isCustomDayRangeKey(customDatePrefillRangeKey)) {
            const ymd = ymdFromDayKey(customDatePrefillRangeKey);
            applied = ymd ? { startYmd: ymd, endYmd: ymd } : null;
          }
        }
      } catch (_) { applied = null; }
      if (!applied) applied = appliedYmdRangeFromDateRange();
      pendingCustomRangeStartYmd = applied && applied.startYmd && applied.startYmd >= MIN_YMD ? applied.startYmd : null;
      pendingCustomRangeEndYmd = applied && applied.endYmd && applied.endYmd >= MIN_YMD ? applied.endYmd : null;
      customCalendarLastPayload = null;
      updateCustomDateFooter();
      input.placeholder = 'Loading...';
      input.disabled = true;
      fetchAvailableDays(30).then((payload) => {
        customCalendarLastPayload = payload;
        initFlatpickrDatePicker(payload);
        input.placeholder = 'Select dates...';
        input.disabled = false;
        updateCustomDateFooter();
      });
    }

    function openCustomDateModal() {
      openCustomDateModalFor({});
    }

    function updateCustomDateFooter() {
      const summaryEl = document.getElementById('date-custom-summary');
      const clearBtn = document.getElementById('date-custom-clear');
      const applyBtn = document.getElementById('date-custom-apply');
      if (!summaryEl) return;
      const a = pendingCustomRangeStartYmd;
      const b = pendingCustomRangeEndYmd;
      if (!a) {
        summaryEl.textContent = 'Select a start date.';
        if (clearBtn) clearBtn.disabled = true;
        if (applyBtn) applyBtn.disabled = true;
        return;
      }
      if (!b) {
        summaryEl.textContent = 'Start: ' + formatYmdLabel(a) + '. Select an end date.';
        if (clearBtn) clearBtn.disabled = false;
        if (applyBtn) applyBtn.disabled = true;
        return;
      }
      const startYmd = a <= b ? a : b;
      const endYmd = a <= b ? b : a;
      summaryEl.textContent = 'Selected: ' + (formatYmdRangeLabel(startYmd, endYmd) || (startYmd + ' \u2013 ' + endYmd));
      if (clearBtn) clearBtn.disabled = false;
      if (applyBtn) applyBtn.disabled = false;
    }

    let customDateModalInited = false;
    function initCustomDateModal() {
      if (customDateModalInited) return;
      customDateModalInited = true;
      const modal = document.getElementById('date-custom-modal');
      if (!modal) return;
      const closeBtn = document.getElementById('date-custom-close-btn');
      if (closeBtn) closeBtn.addEventListener('click', function(e) { e.preventDefault(); closeCustomDateModal(); });
      modal.addEventListener('click', function(e) {
        if (e && e.target === modal) closeCustomDateModal();
      });
      document.addEventListener('keydown', function(e) {
        if (!modal.classList.contains('show')) return;
        const key = e && (e.key || e.code) ? String(e.key || e.code) : '';
        if (key === 'Escape') closeCustomDateModal();
      });
      const clearBtn = document.getElementById('date-custom-clear');
      const applyBtn = document.getElementById('date-custom-apply');
      if (clearBtn) {
        clearBtn.addEventListener('click', function(e) {
          e.preventDefault();
          pendingCustomRangeStartYmd = null;
          pendingCustomRangeEndYmd = null;
          if (flatpickrInstance) flatpickrInstance.clear();
          updateCustomDateFooter();
        });
      }
      if (applyBtn) {
        applyBtn.addEventListener('click', function(e) {
          e.preventDefault();
          const a = pendingCustomRangeStartYmd;
          const b = pendingCustomRangeEndYmd;
          if (!a || !b) return;
          const startYmd = a <= b ? a : b;
          const endYmd = a <= b ? b : a;
          if (startYmd < MIN_YMD || endYmd < MIN_YMD) return;
          const rk = makeRangeKeyFromYmds(startYmd, endYmd);
          if (!rk) return;
          const override = customDateApplyOverride;
          if (typeof override === 'function') {
            closeCustomDateModal();
            try { override({ rangeKey: rk, startYmd: startYmd, endYmd: endYmd }); } catch (_) {}
            return;
          }
          customRangeStartYmd = startYmd;
          customRangeEndYmd = endYmd;
          dateRange = rk;
          closeCustomDateModal();
          applyDateRangeChange({ showTimeframeOverlay: true });
        });
      }
      // Flatpickr handles date selection via its own UI
    }

    try { window.__kexoOpenCustomDateModalFor = openCustomDateModalFor; } catch (_) {}

    function maybeTriggerSaleToastFromStatsLikeData(data) {
      const conv = data && data.convertedCount ? data.convertedCount : {};
      const haveToday = (typeof conv.today === 'number' && Number.isFinite(conv.today));
      if (!haveToday) return;

      // Reset the converted-count baseline daily (admin TZ).
      try {
        const day = ymdNowInTz();
        if (convertedCountDayYmd == null) convertedCountDayYmd = day;
        if (day && convertedCountDayYmd !== day) {
          convertedCountDayYmd = day;
          hasSeenConvertedCountToday = false;
          lastConvertedCountToday = 0;
        }
      } catch (_) {}

      // Guard against stale/cache drift where counts briefly move backwards (would cause double "sale" sounds).
      if (hasSeenConvertedCountToday && conv.today < lastConvertedCountToday) return;

      const increased = hasSeenConvertedCountToday && conv.today > lastConvertedCountToday;
      if (increased) {
        const statsTodayKey = 'stats:today:' + String(conv.today);
        fetchLatestSaleForToast({ forceNew: true })
          .then(function(sale) {
            if (!sale) return;
            triggerSaleToast({
              origin: 'stats',
              playSound: true,
              soundDedupeKey: statsTodayKey,
              toastDedupeKey: statsTodayKey,
              latestSale: sale,
              payload: buildSaleToastPayloadFromSale(sale),
              skipLatest: true,
            });
          })
          .catch(function() {});
        // Keep Home tables in sync when a toast fires outside SSE (Today/Sales/Live).
        if (activeMainTab === 'spy' && (dateRange === 'today' || dateRange === 'sales' || dateRange === 'live' || dateRange === '1h')) {
          try { fetchSessions(); } catch (_) {}
        }
        // Pull the authoritative timestamp (truth/evidence) so the footer is accurate.
        try { refreshConfigStatus(); } catch (_) {}
      }
      lastConvertedCountToday = conv.today;
      hasSeenConvertedCountToday = true;
    }

    function setLiveKpisLoading() {
      const spinner = '<span class="kpi-mini-spinner" aria-hidden="true"></span>';
      const ids = [
        'cond-kpi-orders',
        'cond-kpi-revenue',
        'cond-kpi-profit',
        'cond-kpi-sessions',
        'cond-kpi-conv',
        'cond-kpi-vpv',
        'cond-kpi-roas',
        'cond-kpi-returning',
        'cond-kpi-aov',
        'cond-kpi-cogs',
        'cond-kpi-bounce',
        'cond-kpi-items-sold',
        'cond-kpi-orders-fulfilled',
        'cond-kpi-returns',
      ];
      ids.forEach(function(id) {
        const el = document.getElementById(id);
        if (!el) return;
        el.removeAttribute('data-odometer');
        el.innerHTML = spinner;
      });
    }

    function renderStats(data) {
      statsCache = data || {};
      // IMPORTANT: keep the condensed KPI strip sourced from /api/kpis so compare windows
      // and truth semantics remain consistent across all pages. Stats payload is optimized
      // for reports/tables and may not include compare (or may differ from truth sources).
      maybeTriggerSaleToastFromStatsLikeData(statsCache);
      if (statsCache.rangeAvailable) applyRangeAvailable(statsCache.rangeAvailable);
      renderCountriesMapChart(statsCache);
      renderCountry(statsCache);
      renderBestGeoProducts(statsCache);
      renderAov(statsCache);
      renderLiveKpis(getKpiData());
      scheduleBreakdownSync();
    }

    function kpiDelta(current, baseline) {
      const cur = typeof current === 'number' ? current : NaN;
      const base = typeof baseline === 'number' ? baseline : NaN;
      if (!Number.isFinite(cur) || !Number.isFinite(base)) return null;
      const diff = cur - base;
      if (diff === 0) return 0;
      if (base <= 0) return diff > 0 ? 1 : -1;
      return diff / base;
    }

    // Treat small changes as "stable" (blue/flat) instead of flipping colors.
    // KPI deltas often jitter in short windows (Today/1h), so we use a deadband.
    const KPI_STABLE_RATIO = 0.05; // ??5% relative change
    const KPI_STABLE_PCT = 5; // ??5 percentage points (already-percent deltas)
    const DASHBOARD_NEUTRAL_DELTA_KEYS = new Set(['cogs', 'fulfilled', 'returns', 'items']);
    const DASHBOARD_NEUTRAL_TONE_HEX = '#999';
    let runtimeProfitKpiAllowed = false;

    function setRuntimeProfitKpiAllowed(nextAllowed) {
      var allowed = !!nextAllowed;
      if (runtimeProfitKpiAllowed === allowed) return;
      runtimeProfitKpiAllowed = allowed;
      try {
        if (kpiUiConfigV1 && kpiUiConfigV1.v === 1) {
          applyCondensedKpiUiConfig(kpiUiConfigV1);
          applyDashboardKpiUiConfig(kpiUiConfigV1);
        }
      } catch (_) {}
    }

    function cssVarColor(name, fallback) {
      try {
        const v = getComputedStyle(document.documentElement).getPropertyValue(name).trim();
        return v || fallback;
      } catch (_) {
        return fallback;
      }
    }

    function kpiDeltaToneColor(dir, bundleKey) {
      if (bundleKey) return chartsKpiToneColor(bundleKey, dir);
      const d = String(dir || '').toLowerCase();
      if (d === 'up') {
        return cssVarColor('--kexo-kpi-delta-up', cssVarColor('--kexo-accent-2', '#3eb3ab'));
      }
      if (d === 'down') {
        return cssVarColor('--kexo-kpi-delta-down', cssVarColor('--kexo-accent-4', '#e4644b'));
      }
      return cssVarColor('--kexo-kpi-delta-same', cssVarColor('--kexo-accent-1', '#4b94e4'));
    }

    function normalizeIconStyleClass(value, fallback) {
      const raw = value == null ? '' : String(value).trim().toLowerCase();
      if (!raw) return fallback;
      if (raw.indexOf('fa-jelly-filled') >= 0 || raw === 'jelly-filled') return 'fa-jelly-filled';
      if (raw.indexOf('fa-jelly') >= 0 || raw === 'jelly') return 'fa-jelly';
      if (raw.indexOf('fa-solid') >= 0 || raw === 'solid') return 'fa-solid';
      if (raw.indexOf('fa-light') >= 0 || raw === 'light') return 'fa-light';
      if (raw.indexOf('fa-brands') >= 0 || raw === 'brands' || raw === 'brand') return 'fa-brands';
      return fallback;
    }

    function getStoredIconStyleClass(lsSuffix, fallback) {
      let v = null;
      try { v = localStorage.getItem('tabler-theme-' + lsSuffix); } catch (_) { v = null; }
      return normalizeIconStyleClass(v, fallback);
    }

    function sanitizeIconClassString(value) {
      return String(value == null ? '' : value).trim().replace(/\s+/g, ' ');
    }

    function isFontAwesomeSubsetToken(token) {
      return token === 'fa-sharp' || token === 'fa-sharp-light' || token === 'fa-sharp-regular' ||
        token === 'fa-sharp-solid' || token === 'fa-sharp-thin' || token === 'fa-sharp-duotone';
    }

    function isIconStyleToken(token) {
      return token === 'fa-jelly' || token === 'fa-jelly-filled' || token === 'fa-light' ||
        token === 'fa-solid' || token === 'fa-brands' || token === 'fa-regular' ||
        token === 'fa-thin' || token === 'fa-duotone' || isFontAwesomeSubsetToken(token) ||
        token === 'fas' || token === 'far' || token === 'fal' || token === 'fab' ||
        token === 'fat' || token === 'fad';
    }

    function parseIconGlyphInput(value, fallbackGlyph) {
      const raw = sanitizeIconClassString(value).toLowerCase();
      const safeFallback = fallbackGlyph || 'fa-circle';
      if (!raw) return { mode: 'glyph', value: safeFallback };
      const tokens = raw.split(/\s+/).filter(Boolean);
      const faTokens = tokens.filter(function (t) {
        return t === 'fa' || t.indexOf('fa-') === 0 || t === 'fas' || t === 'far' ||
          t === 'fal' || t === 'fab' || t === 'fat' || t === 'fad';
      });
      const hasExplicitStyle = tokens.some(isIconStyleToken);
      if (hasExplicitStyle || faTokens.length >= 2) {
        const full = tokens.slice();
        const hasGlyph = full.some(function (t) { return t.indexOf('fa-') === 0 && !isIconStyleToken(t); });
        if (!hasGlyph) full.push(safeFallback);
        return { mode: 'full', value: full.join(' ') };
      }
      const m = raw.match(/fa-[a-z0-9-]+/);
      if (m && m[0]) return { mode: 'glyph', value: m[0] };
      if (/^[a-z0-9-]+$/.test(raw)) return { mode: 'glyph', value: 'fa-' + raw };
      return { mode: 'glyph', value: safeFallback };
    }

    function applyIconClassSpec(iconEl, classSpec, styleFallback, glyphFallback) {
      if (!iconEl) return;
      const keep = [];
      Array.prototype.forEach.call(iconEl.classList, function (cls) {
        if (cls === 'fa' || cls === 'fas' || cls === 'far' || cls === 'fal' || cls === 'fab' || cls === 'fat' || cls === 'fad') return;
        if (cls.indexOf('fa-') === 0) return;
        keep.push(cls);
      });
      const tokens = sanitizeIconClassString(classSpec).toLowerCase().split(/\s+/).filter(Boolean);
      const parsed = tokens.length ? tokens : [styleFallback || 'fa-jelly', glyphFallback || 'fa-circle'];
      let hasStyle = false;
      let hasGlyph = false;
      parsed.forEach(function (t) {
        if (isIconStyleToken(t)) hasStyle = true;
        if (t.indexOf('fa-') === 0 && !isIconStyleToken(t)) hasGlyph = true;
      });
      if (!hasStyle) parsed.unshift(styleFallback || 'fa-jelly');
      if (!hasGlyph) parsed.push(glyphFallback || 'fa-circle');
      iconEl.className = keep.concat(parsed).join(' ').trim();
    }

    function applyCondensedKpiDelta(key, current, baseline, invert) {
      const deltaEl = document.getElementById('cond-kpi-' + key + '-delta');
      const barEl = document.getElementById('cond-kpi-' + key + '-bar');
      if (!deltaEl && !barEl) return;

      const cur = typeof current === 'number' && Number.isFinite(current) ? current : null;
      const base = typeof baseline === 'number' && Number.isFinite(baseline) ? baseline : null;
      const rawDelta = (cur != null && base != null) ? kpiDelta(cur, base) : null;
      let toneDelta = null;
      if (cur != null && base != null) {
        const diff = cur - base;
        const denom = Math.abs(base);
        toneDelta = denom > 1e-9 ? (diff / denom) : (diff === 0 ? 0 : (diff > 0 ? 1 : -1));
        if (invert) toneDelta = -toneDelta;
      }
      const isNew = cur != null && base === 0 && cur !== 0;
      const isUp = isNew || (toneDelta != null && toneDelta > KPI_STABLE_RATIO);
      const isDown = !isNew && toneDelta != null && toneDelta < -KPI_STABLE_RATIO;
      const isFlat = !isNew && toneDelta != null && !isUp && !isDown;

      if (deltaEl) {
        const textEl = deltaEl.querySelector('.kexo-kpi-chip-delta-text');
        let text = '\u2014';
        let dir = 'none';

        if (rawDelta != null) {
          text = isNew ? 'new' : formatSignedPercentOneDecimalFromRatio(rawDelta);
          dir = isUp ? 'up' : (isDown ? 'down' : 'flat');
        }

        deltaEl.classList.remove('is-up', 'is-down', 'is-flat');
        if (dir === 'up') deltaEl.classList.add('is-up');
        else if (dir === 'down') deltaEl.classList.add('is-down');
        else if (dir === 'flat') deltaEl.classList.add('is-flat');
        deltaEl.setAttribute('data-dir', dir);
        try {
          var styleCfg = getChartsKpiBundle('headerStrip').deltaStyle;
          var toneColor = chartsKpiToneColor('headerStrip', dir === 'none' ? 'same' : dir);
          deltaEl.style.fontSize = String(styleCfg.fontSize) + 'px';
          deltaEl.style.fontWeight = String(styleCfg.fontWeight);
          deltaEl.style.color = styleCfg.fontColor || toneColor;
          var iconEl = deltaEl.querySelector('i');
          if (iconEl) {
            iconEl.style.fontSize = String(styleCfg.iconSize) + 'px';
            iconEl.style.color = styleCfg.iconColor || toneColor;
          }
        } catch (_) {}
        if (textEl) textEl.textContent = text;
        else deltaEl.textContent = text;
      }

      if (barEl) {
        barEl.classList.remove('bg-success', 'bg-danger', 'bg-secondary');
        const progressEl = (barEl.closest && barEl.closest('.progress')) ? barEl.closest('.progress') : null;
        const srText = barEl.querySelector ? barEl.querySelector('.visually-hidden') : null;

        // When compare is missing, avoid misleading "0% complete" semantics.
        if (rawDelta == null) {
          if (progressEl) progressEl.classList.add('is-hidden');
          barEl.style.width = '0%';
          barEl.classList.add('bg-secondary');
          barEl.setAttribute('aria-valuenow', '0');
          barEl.setAttribute('aria-label', 'No comparison available');
          if (srText) srText.textContent = 'No comparison available';
          return;
        }

        if (progressEl) progressEl.classList.remove('is-hidden');
        let widthPct = 0;
        let barClass = 'bg-secondary';
        const deltaPctAbs = Number.isFinite(rawDelta) ? (Math.round(Math.abs(rawDelta) * 1000) / 10) : null;

        if (!isFlat) {
          widthPct = isNew ? 100 : Math.max(6, Math.min(100, Math.round(Math.abs(rawDelta) * 100)));
          barClass = isUp ? 'bg-success' : 'bg-danger';
        }

        barEl.style.width = String(widthPct) + '%';
        barEl.classList.add(barClass);
        barEl.setAttribute('aria-valuenow', String(widthPct));
        if (isNew) {
          barEl.setAttribute('aria-label', 'New metric (baseline was 0)');
          if (srText) srText.textContent = 'New metric (baseline was 0)';
        } else if (deltaPctAbs != null) {
          barEl.setAttribute('aria-label', String(deltaPctAbs) + '% change');
          if (srText) srText.textContent = String(deltaPctAbs) + '% change';
        } else {
          barEl.setAttribute('aria-label', String(widthPct) + '% change');
          if (srText) srText.textContent = String(widthPct) + '% change';
        }
      }
    }

    var condensedSeriesCache = null;
    var condensedSeriesRange = null;
    var condensedSeriesFetchedAt = 0;
    var condensedSparklineOverrides = {};
    var sparklineHistorySeriesCache = null;
    var sparklineHistorySeriesRange = null;
    var sparklineHistorySeriesFetchedAt = 0;
    var sparklineHistorySeriesInFlight = null;

    function getSparklineSeries(series) {
      if (Array.isArray(series) && series.length >= 2) return series;
      if (Array.isArray(sparklineHistorySeriesCache) && sparklineHistorySeriesCache.length >= 2) return sparklineHistorySeriesCache;
      return Array.isArray(series) ? series : [];
    }

    function getSparklineFallbackRangeKey() {
      var rk = normalizeRangeKeyForApi(getStatsRange());
      if (!rk || rk === 'today' || rk === 'yesterday' || rk === '1h' || /^d:\d{4}-\d{2}-\d{2}$/.test(rk)) return '7d';
      return rk;
    }

    function ensureSparklineHistorySeries() {
      var fallbackRange = getSparklineFallbackRangeKey();
      var stale = !sparklineHistorySeriesFetchedAt || (Date.now() - sparklineHistorySeriesFetchedAt) > KPI_CACHE_TTL_MS;
      if (!stale && sparklineHistorySeriesRange === fallbackRange && sparklineHistorySeriesCache && sparklineHistorySeriesCache.length >= 2) {
        return Promise.resolve(sparklineHistorySeriesCache);
      }
      if (sparklineHistorySeriesInFlight) return sparklineHistorySeriesInFlight;
      sparklineHistorySeriesInFlight = fetchWithTimeout(API + '/api/dashboard-series?range=' + encodeURIComponent(fallbackRange), { credentials: 'same-origin', cache: 'default' }, 15000)
        .then(function(r) { return r && r.ok ? r.json() : null; })
        .then(function(data) {
          var s = data && Array.isArray(data.series) ? data.series : [];
          if (s.length >= 2) {
            sparklineHistorySeriesCache = s;
            sparklineHistorySeriesRange = fallbackRange;
            sparklineHistorySeriesFetchedAt = Date.now();
          }
          return sparklineHistorySeriesCache;
        })
        .catch(function() { return sparklineHistorySeriesCache; })
        .finally(function() { sparklineHistorySeriesInFlight = null; });
      return sparklineHistorySeriesInFlight;
    }

    function renderCondensedSparklines(series) {
      if (typeof ApexCharts === 'undefined') return;
      var sourceSeries = getSparklineSeries(series);
      if (!sourceSeries || !sourceSeries.length) return;
      var bundleCfg = getChartsKpiBundle('headerStrip');
      var sparkCfg = bundleCfg.sparkline || defaultChartsKpiSparklineConfig('headerStrip');
      var GREEN = bundleCfg.palette && bundleCfg.palette.up ? bundleCfg.palette.up : kpiDeltaToneColor('up');
      var RED = bundleCfg.palette && bundleCfg.palette.down ? bundleCfg.palette.down : kpiDeltaToneColor('down');
      var NEUTRAL = bundleCfg.palette && bundleCfg.palette.same ? bundleCfg.palette.same : kpiDeltaToneColor('flat');
      var map = {
        'cond-kpi-orders-sparkline': function(d) { return d.orders; },
        'cond-kpi-revenue-sparkline': function(d) { return d.revenue; },
        'cond-kpi-profit-sparkline': function() { return null; },
        'cond-kpi-conv-sparkline': function(d) { return d.convRate; },
        'cond-kpi-vpv-sparkline': function(d) {
          var rev = d && typeof d.revenue === 'number' ? d.revenue : 0;
          var sess = d && typeof d.sessions === 'number' ? d.sessions : 0;
          return (sess > 0) ? (rev / sess) : null;
        },
        'cond-kpi-roas-sparkline': function(d) {
          var spend = d && typeof d.adSpend === 'number' ? d.adSpend : 0;
          var rev = d && typeof d.revenue === 'number' ? d.revenue : 0;
          return (spend > 0) ? (rev / spend) : 0;
        },
        'cond-kpi-sessions-sparkline': function(d) { return d.sessions; },
        'cond-kpi-returning-sparkline': function(d) { return d.returningCustomerOrders || 0; },
        'cond-kpi-aov-sparkline': function(d) { return d.aov; },
        'cond-kpi-cogs-sparkline': function() { return null; },
        'cond-kpi-bounce-sparkline': function(d) { return d.bounceRate; },
        'cond-kpi-orders-fulfilled-sparkline': function() { return null; },
        'cond-kpi-returns-sparkline': function() { return null; },
        'cond-kpi-items-sold-sparkline': function(d) { return d.units || 0; }
      };
      Object.keys(map).forEach(function(id) {
        var el = document.getElementById(id);
        if (!el) return;
        var overrideData = condensedSparklineOverrides && Array.isArray(condensedSparklineOverrides[id]) ? condensedSparklineOverrides[id] : null;
        var dataArr = overrideData && overrideData.length ? overrideData.slice() : sourceSeries.map(map[id]);
        if (dataArr.length < 2) dataArr = dataArr.length === 1 ? [dataArr[0], dataArr[0]] : [0, 0];
        var tone = String(el.getAttribute('data-tone') || '').toLowerCase();
        if (tone !== 'up' && tone !== 'down') {
          tone = 'neutral';
        }
        var sparkColor = tone === 'down' ? RED : (tone === 'up' ? GREEN : NEUTRAL);
        el.innerHTML = '';
        if (typeof window.kexoRenderSparkline === 'function') {
          try {
            window.kexoRenderSparkline({
              containerEl: el,
              data: dataArr,
              color: sparkColor,
              height: Number(sparkCfg.height) || 30,
              mode: sparkCfg.mode || 'line',
              curve: sparkCfg.curve || 'smooth',
              strokeWidth: sparkCfg.strokeWidth,
              showCompare: false,
              advancedApexOverride: sparkCfg.advancedApexOverride || {}
            });
            return;
          } catch (_) {}
        }
        try {
          var chart = new ApexCharts(el, {
            chart: { type: sparkCfg.mode || 'line', height: Number(sparkCfg.height) || 30, sparkline: { enabled: true }, animations: { enabled: false } },
            series: [{ data: dataArr }],
            stroke: { show: true, width: Number(sparkCfg.strokeWidth) || 2.15, curve: sparkCfg.curve || 'smooth', lineCap: 'round' },
            // NOTE: ApexCharts 4.x can incorrectly apply fill opacity to line stroke color.
            // Keep fill opacity at 1 for visible strokes; line charts still render line-only.
            fill: { type: 'solid', opacity: 1 },
            colors: [sparkColor],
            markers: { size: 0 },
            grid: { padding: { top: 0, right: 0, bottom: -2, left: 0 } },
            tooltip: { enabled: true }
          });
          chart.render();
        } catch (_) {}
      });
    }

    function fetchCondensedSeries() {
      var rangeKey = getStatsRange();
      if (!rangeKey) return;
      var stale = !condensedSeriesFetchedAt || (Date.now() - condensedSeriesFetchedAt) > KPI_CACHE_TTL_MS;
      if (!stale && condensedSeriesCache && condensedSeriesRange === rangeKey) {
        renderCondensedSparklines(condensedSeriesCache);
        return;
      }
      fetchWithTimeout(API + '/api/dashboard-series?range=' + encodeURIComponent(rangeKey), { credentials: 'same-origin', cache: 'default' }, 15000)
        .then(function(r) { return r && r.ok ? r.json() : null; })
        .then(function(data) {
          var s = data && data.series ? data.series : null;
          if (s && s.length) {
            condensedSeriesCache = s;
            condensedSeriesRange = rangeKey;
            condensedSeriesFetchedAt = Date.now();
            renderCondensedSparklines(s);
            if (s.length < 2) {
              ensureSparklineHistorySeries().then(function(historySeries) {
                if (historySeries && historySeries.length >= 2) renderCondensedSparklines(s);
              }).catch(function() {});
            }
          }
        })
        .catch(function() {});
    }

    function renderLiveKpis(data) {
      const sales = data && data.sales ? data.sales : {};
      const convertedCountMap = data && data.convertedCount ? data.convertedCount : {};
      const returningCustomerCountMap = data && data.returningCustomerCount ? data.returningCustomerCount : {};
      const breakdown = data && data.trafficBreakdown ? data.trafficBreakdown : {};
      const conv = data && data.conversion ? data.conversion : {};
      const vpvMap = data && data.vpv ? data.vpv : {};
      const aovMap = data && data.aov ? data.aov : {};
      const bounceMap = data && data.bounce ? data.bounce : {};
      const costMap = data && data.cost ? data.cost : {};
      const profitMap = data && data.profit ? data.profit : {};
      const condOrdersEl = document.getElementById('cond-kpi-orders');
      const condRevenueEl = document.getElementById('cond-kpi-revenue');
      const condProfitEl = document.getElementById('cond-kpi-profit');
      const condConvEl = document.getElementById('cond-kpi-conv');
      const condVpvEl = document.getElementById('cond-kpi-vpv');
      const condSessionsEl = document.getElementById('cond-kpi-sessions');
      const condReturningEl = document.getElementById('cond-kpi-returning');
      const condAovEl = document.getElementById('cond-kpi-aov');
      const condRoasEl = document.getElementById('cond-kpi-roas');
      const condBounceEl = document.getElementById('cond-kpi-bounce');
      const topbarOrdersEl = document.getElementById('topbar-kpi-orders');
      const topbarClicksEl = document.getElementById('topbar-kpi-clicks');
      const topbarConvEl = document.getElementById('topbar-kpi-conv');
      const topbarOrdersDeltaEl = document.getElementById('topbar-kpi-orders-delta');
      const topbarOrdersDeltaTextEl = document.getElementById('topbar-kpi-orders-delta-text');
      const topbarClicksDeltaEl = document.getElementById('topbar-kpi-clicks-delta');
      const topbarClicksDeltaTextEl = document.getElementById('topbar-kpi-clicks-delta-text');
      const topbarConvDeltaEl = document.getElementById('topbar-kpi-conv-delta');
      const topbarConvDeltaTextEl = document.getElementById('topbar-kpi-conv-delta-text');
      const kpiRange = getStatsRange();
      const profitKpiAllowed = !!(data && data.profitKpiAllowed === true);
      setRuntimeProfitKpiAllowed(profitKpiAllowed);
      const forRange = breakdown[kpiRange];
      const sessionsVal = forRange != null && typeof forRange.human_sessions === 'number' ? forRange.human_sessions : null;
      const orderCountVal = typeof convertedCountMap[kpiRange] === 'number' ? convertedCountMap[kpiRange] : null;
      const revenueVal = typeof sales[kpiRange] === 'number' ? sales[kpiRange] : null;
      const costVal = typeof costMap[kpiRange] === 'number' ? costMap[kpiRange] : null;
      let profitVal = typeof profitMap[kpiRange] === 'number' ? profitMap[kpiRange] : null;
      if (profitVal == null && revenueVal != null && costVal != null) {
        profitVal = Math.round((revenueVal - costVal) * 100) / 100;
      }
      if (!profitKpiAllowed) profitVal = null;
      const returningVal = typeof returningCustomerCountMap[kpiRange] === 'number' ? returningCustomerCountMap[kpiRange] : null;
      const convVal = typeof conv[kpiRange] === 'number' ? conv[kpiRange] : null;
      const vpvVal = typeof vpvMap[kpiRange] === 'number' ? vpvMap[kpiRange] : null;
      const aovVal = typeof aovMap[kpiRange] === 'number' ? aovMap[kpiRange] : null;
      const roasVal = data && data.roas && typeof data.roas[kpiRange] === 'number' ? data.roas[kpiRange] : null;
      const bounceVal = typeof bounceMap[kpiRange] === 'number' ? bounceMap[kpiRange] : null;
      const compare = data && data.compare ? data.compare : null;
      const compareBreakdown = compare && compare.trafficBreakdown ? compare.trafficBreakdown : null;
      const compareSessionsVal = compareBreakdown && typeof compareBreakdown.human_sessions === 'number' ? compareBreakdown.human_sessions : null;
      const compareOrdersVal = compare && typeof compare.convertedCount === 'number' ? compare.convertedCount : null;
      const compareRevenueVal = compare && typeof compare.sales === 'number' ? compare.sales : null;
      const compareCostVal = compare && typeof compare.cost === 'number' ? compare.cost : null;
      let compareProfitVal = compare && typeof compare.profit === 'number' ? compare.profit : null;
      if (compareProfitVal == null && compareRevenueVal != null && compareCostVal != null) {
        compareProfitVal = Math.round((compareRevenueVal - compareCostVal) * 100) / 100;
      }
      if (!profitKpiAllowed) compareProfitVal = null;
      const compareReturningVal = compare && typeof compare.returningCustomerCount === 'number' ? compare.returningCustomerCount : null;
      const compareConvVal = compare && typeof compare.conversion === 'number' ? compare.conversion : null;
      const compareVpvVal = compare && typeof compare.vpv === 'number' ? compare.vpv : null;
      const compareAovVal = compare && typeof compare.aov === 'number' ? compare.aov : null;
      const compareRoasVal = compare && typeof compare.roas === 'number' ? compare.roas : null;
      const compareBounceVal = compare && typeof compare.bounce === 'number' ? compare.bounce : null;
      function setCondensedSparklineTone(id, current, baseline, invert) {
        const sparkEl = document.getElementById(id);
        if (!sparkEl) return;
        const cur = (typeof current === 'number' && Number.isFinite(current)) ? current : null;
        const base = (typeof baseline === 'number' && Number.isFinite(baseline)) ? baseline : null;
        if (cur == null || base == null) {
          sparkEl.removeAttribute('data-tone');
          return;
        }
        const delta = invert ? (base - cur) : (cur - base);
        if (Math.abs(delta) < 1e-9) {
          sparkEl.removeAttribute('data-tone');
          return;
        }
        const denom = Math.abs(base);
        if (denom > 1e-9) {
          const ratio = delta / denom;
          if (Math.abs(ratio) <= KPI_STABLE_RATIO) {
            sparkEl.removeAttribute('data-tone');
            return;
          }
        }
        sparkEl.setAttribute('data-tone', delta < 0 ? 'down' : 'up');
      }

      if (condOrdersEl) condOrdersEl.textContent = orderCountVal != null ? formatSessions(orderCountVal) : '\u2014';
      if (condRevenueEl) condRevenueEl.textContent = revenueVal != null ? formatRevenue(revenueVal) : '\u2014';
      if (condProfitEl) condProfitEl.textContent = profitVal != null ? formatRevenue(profitVal) : '\u2014';
      if (condSessionsEl) condSessionsEl.textContent = sessionsVal != null ? formatSessions(sessionsVal) : '\u2014';
      if (condConvEl) condConvEl.textContent = convVal != null ? pct(convVal) : '\u2014';
      if (condVpvEl) condVpvEl.textContent = vpvVal != null ? formatRevenue(vpvVal) : '\u2014';
      if (condReturningEl) condReturningEl.textContent = returningVal != null ? formatSessions(returningVal) : '\u2014';
      if (condAovEl) condAovEl.textContent = aovVal != null ? formatRevenue(aovVal) : '\u2014';
      if (condRoasEl) condRoasEl.textContent = roasVal != null ? Number(roasVal).toFixed(2) + 'x' : '\u2014';
      if (condBounceEl) condBounceEl.textContent = bounceVal != null ? pct(bounceVal) : '\u2014';
      applyCondensedKpiDelta('orders', orderCountVal, compareOrdersVal, false);
      applyCondensedKpiDelta('revenue', revenueVal, compareRevenueVal, false);
      applyCondensedKpiDelta('profit', profitVal, compareProfitVal, false);
      applyCondensedKpiDelta('sessions', sessionsVal, compareSessionsVal, false);
      applyCondensedKpiDelta('conv', convVal, compareConvVal, false);
      applyCondensedKpiDelta('vpv', vpvVal, compareVpvVal, false);
      applyCondensedKpiDelta('returning', returningVal, compareReturningVal, false);
      applyCondensedKpiDelta('aov', aovVal, compareAovVal, false);
      applyCondensedKpiDelta('roas', roasVal, compareRoasVal, false);
      applyCondensedKpiDelta('bounce', bounceVal, compareBounceVal, true);
      setCondensedSparklineTone('cond-kpi-orders-sparkline', orderCountVal, compareOrdersVal);
      setCondensedSparklineTone('cond-kpi-revenue-sparkline', revenueVal, compareRevenueVal);
      setCondensedSparklineTone('cond-kpi-profit-sparkline', profitVal, compareProfitVal);
      setCondensedSparklineTone('cond-kpi-conv-sparkline', convVal, compareConvVal);
      setCondensedSparklineTone('cond-kpi-vpv-sparkline', vpvVal, compareVpvVal);
      setCondensedSparklineTone('cond-kpi-roas-sparkline', roasVal, compareRoasVal);
      setCondensedSparklineTone('cond-kpi-sessions-sparkline', sessionsVal, compareSessionsVal);
      setCondensedSparklineTone('cond-kpi-returning-sparkline', returningVal, compareReturningVal);
      setCondensedSparklineTone('cond-kpi-aov-sparkline', aovVal, compareAovVal);
      setCondensedSparklineTone('cond-kpi-bounce-sparkline', bounceVal, compareBounceVal, true);
      if (!condensedSparklineOverrides || typeof condensedSparklineOverrides !== 'object') condensedSparklineOverrides = {};
      var profitSparkline = (data && Array.isArray(data.profitSparkline)) ? data.profitSparkline : null;
      if (!profitKpiAllowed) {
        condensedSparklineOverrides['cond-kpi-profit-sparkline'] = null;
      } else if (profitSparkline && profitSparkline.length >= 2) {
        condensedSparklineOverrides['cond-kpi-profit-sparkline'] = profitSparkline.slice();
      } else {
        condensedSparklineOverrides['cond-kpi-profit-sparkline'] = (profitVal != null && compareProfitVal != null)
          ? [compareProfitVal, profitVal]
          : null;
      }
      try { if (condensedSeriesCache) renderCondensedSparklines(condensedSeriesCache); } catch (_) {}
      try { updateCondensedKpiOverflow(); } catch (_) {}

      // Header quick KPIs (compact)
      if (topbarOrdersEl) topbarOrdersEl.textContent = orderCountVal != null ? formatSessions(orderCountVal) : '\u2014';
      if (topbarClicksEl) topbarClicksEl.textContent = sessionsVal != null ? formatSessions(sessionsVal) : '\u2014';
      if (topbarConvEl) topbarConvEl.textContent = convVal != null ? pct(convVal) : '\u2014';

      function deltaPct(curr, prev) {
        const c = (typeof curr === 'number' && Number.isFinite(curr)) ? curr : null;
        const p = (typeof prev === 'number' && Number.isFinite(prev)) ? prev : null;
        if (c == null || p == null) return null;
        // Avoid divide-by-zero: show "new" when baseline is 0 and current is non-zero.
        if (p === 0) return (c === 0) ? 0 : Infinity;
        return ((c - p) / p) * 100;
      }
      function applyTopbarDelta(deltaWrap, deltaTextEl, pctVal) {
        if (!deltaWrap || !deltaTextEl) return;
        var headerDeltaStyle = getChartsKpiBundle('headerStrip').deltaStyle;
        function applyHeaderTone(dir) {
          var tone = chartsKpiToneColor('headerStrip', dir);
          deltaWrap.style.fontSize = String(headerDeltaStyle.fontSize) + 'px';
          deltaWrap.style.fontWeight = String(headerDeltaStyle.fontWeight);
          deltaWrap.style.color = headerDeltaStyle.fontColor || tone;
          var iconEl = deltaWrap.querySelector('i');
          if (iconEl) {
            iconEl.style.fontSize = String(headerDeltaStyle.iconSize) + 'px';
            iconEl.style.color = headerDeltaStyle.iconColor || tone;
          }
        }
        if (pctVal == null || !Number.isFinite(pctVal)) {
          if (pctVal === Infinity) {
            deltaWrap.classList.remove('is-hidden');
            deltaWrap.classList.add('is-up');
            deltaWrap.classList.remove('is-down', 'is-flat');
            deltaTextEl.textContent = 'new';
            applyHeaderTone('up');
            return;
          }
          deltaWrap.classList.add('is-hidden');
          deltaWrap.classList.remove('is-up', 'is-down', 'is-flat');
          return;
        }
        const p = Math.round(pctVal * 10) / 10;
        const up = p > KPI_STABLE_PCT;
        const down = p < -KPI_STABLE_PCT;
        deltaWrap.classList.remove('is-hidden');
        deltaWrap.classList.toggle('is-up', up);
        deltaWrap.classList.toggle('is-down', down);
        deltaWrap.classList.toggle('is-flat', !up && !down);
        applyHeaderTone(up ? 'up' : (down ? 'down' : 'same'));
        deltaTextEl.textContent = Math.abs(p).toFixed(1).replace(/\.0$/, '') + '%';
      }

      applyTopbarDelta(
        topbarOrdersDeltaEl,
        topbarOrdersDeltaTextEl,
        deltaPct(orderCountVal, compareOrdersVal)
      );
      applyTopbarDelta(
        topbarClicksDeltaEl,
        topbarClicksDeltaTextEl,
        deltaPct(sessionsVal, compareSessionsVal)
      );
      applyTopbarDelta(
        topbarConvDeltaEl,
        topbarConvDeltaTextEl,
        deltaPct(convVal, compareConvVal)
      );
    }

    // Dashboard KPI cards:
    // - Left compare slot always uses true previous-period values from /api/kpis compare payload.
    // - Right compare slot is optional context (Previous 7 days) shown only on today/yesterday.
    let _dashKpiSecondaryFetchedAt = 0;
    let _dashKpiSecondaryInFlight = null;
    let _dashKpisSecondary = null; // /api/kpis?range=7d
    let _dashKpiExtrasSecondaryFetchedAt = 0;
    let _dashKpiExtrasSecondaryInFlight = null;
    let _dashKpiExtrasSecondary = null; // /api/kpis-expanded-extra?range=7d

    function fetchKpisForRangeKey(rangeKey) {
      rangeKey = (rangeKey == null ? '' : String(rangeKey)).trim().toLowerCase();
      if (!rangeKey) rangeKey = 'today';
      const url = API + '/api/kpis?range=' + encodeURIComponent(rangeKey);
      return fetchWithTimeout(url, { credentials: 'same-origin', cache: 'no-store' }, 25000)
        .then(function(r) {
          if (!r || !r.ok) throw new Error('KPIs HTTP ' + (r ? r.status : '0'));
          return r.json();
        });
    }

    function fetchExpandedExtrasForRangeKey(rangeKey) {
      rangeKey = (rangeKey == null ? '' : String(rangeKey)).trim().toLowerCase();
      if (!rangeKey) rangeKey = 'today';
      let url = API + '/api/kpis-expanded-extra?range=' + encodeURIComponent(rangeKey);
      try {
        const shop = getShopForSales();
        if (shop) url += '&shop=' + encodeURIComponent(shop);
      } catch (_) {}
      return fetchWithTimeout(url, { credentials: 'same-origin', cache: 'no-store' }, 25000)
        .then(function(r) {
          if (!r || !r.ok) throw new Error('KPI extras HTTP ' + (r ? r.status : '0'));
          return r.json();
        });
    }

    function ensureDashboardSecondaryKpis() {
      const ttlMs = 120 * 1000;
      const fresh = _dashKpiSecondaryFetchedAt && (Date.now() - _dashKpiSecondaryFetchedAt) < ttlMs;
      if (fresh && _dashKpisSecondary) return Promise.resolve(_dashKpisSecondary);
      if (_dashKpiSecondaryInFlight) return _dashKpiSecondaryInFlight;
      _dashKpiSecondaryInFlight = fetchKpisForRangeKey('7d')
        .catch(function() { return null; })
        .then(function(part) {
          _dashKpisSecondary = part || null;
          _dashKpiSecondaryFetchedAt = Date.now();
          return _dashKpisSecondary;
        }).finally(function() {
          _dashKpiSecondaryInFlight = null;
        });
      return _dashKpiSecondaryInFlight;
    }

    function ensureDashboardSecondaryExtras() {
      const ttlMs = 120 * 1000;
      const fresh = _dashKpiExtrasSecondaryFetchedAt && (Date.now() - _dashKpiExtrasSecondaryFetchedAt) < ttlMs;
      if (fresh && _dashKpiExtrasSecondary) return Promise.resolve(_dashKpiExtrasSecondary);
      if (_dashKpiExtrasSecondaryInFlight) return _dashKpiExtrasSecondaryInFlight;
      _dashKpiExtrasSecondaryInFlight = fetchExpandedExtrasForRangeKey('7d')
        .catch(function() { return null; })
        .then(function(part) {
          _dashKpiExtrasSecondary = part || null;
          _dashKpiExtrasSecondaryFetchedAt = Date.now();
          return _dashKpiExtrasSecondary;
        }).finally(function() {
          _dashKpiExtrasSecondaryInFlight = null;
        });
      return _dashKpiExtrasSecondaryInFlight;
    }

    function setDashboardCompareLabels(primaryLabel, secondaryLabel, showSecondary) {
      var p = String(primaryLabel || 'Previous period').trim() || 'Previous period';
      var s = String(secondaryLabel || 'Previous 7 days').trim() || 'Previous 7 days';
      document.querySelectorAll('.dash-kpi-compare-row').forEach(function(row) {
        if (!row) return;
        var items = row.querySelectorAll('.dash-kpi-compare-item');
        var left = items && items[0] ? items[0] : null;
        var right = items && items[1] ? items[1] : null;
        if (left) {
          var leftLabel = left.querySelector('.text-muted.small');
          if (leftLabel) leftLabel.textContent = p + ':';
        }
        if (right) {
          right.classList.toggle('is-hidden', !showSecondary);
          var rightLabel = right.querySelector('.text-muted.small');
          if (rightLabel) rightLabel.textContent = s + ':';
        }
      });
    }

    // Dashboard compare labels: use explicit date/date-range strings (avoid "Day before", "Previous 7 days").
    function kpiDateLabelFormat() {
      try {
        var cfg = (typeof kpiUiConfigV1 !== 'undefined' && kpiUiConfigV1 && kpiUiConfigV1.v === 1) ? kpiUiConfigV1 : null;
        var general = cfg && cfg.options && cfg.options.general && typeof cfg.options.general === 'object' ? cfg.options.general : null;
        var raw = String(general && general.dateLabelFormat ? general.dateLabelFormat : '').trim().toLowerCase();
        return raw === 'mdy' ? 'mdy' : 'dmy';
      } catch (_) {
        return 'dmy';
      }
    }

    function formatYmdMonthDay(ymd, includeYear) {
      if (!ymd || !/^\d{4}-\d{2}-\d{2}$/.test(String(ymd))) return String(ymd || '');
      var y = parseInt(String(ymd).slice(0, 4), 10);
      var m = parseInt(String(ymd).slice(5, 7), 10);
      var d = parseInt(String(ymd).slice(8, 10), 10);
      if (!Number.isFinite(y) || !Number.isFinite(m) || !Number.isFinite(d) || m < 1 || m > 12 || d < 1 || d > 31) return String(ymd || '');
      var order = kpiDateLabelFormat();
      var base = order === 'mdy'
        ? (String(m) + '/' + String(d))
        : (String(d) + '/' + String(m));
      if (!includeYear) return base;
      return base + '/' + String(y);
    }

    function formatYmdRangeMonthDay(startYmd, endYmd) {
      if (!startYmd || !endYmd) return '';
      if (startYmd === endYmd) return formatYmdMonthDay(startYmd, false);
      var includeYear = String(startYmd).slice(0, 4) !== String(endYmd).slice(0, 4);
      return formatYmdMonthDay(startYmd, includeYear) + ' \u2013 ' + formatYmdMonthDay(endYmd, includeYear);
    }

    function ymdAddDays(ymd, deltaDays) {
      if (!ymd || !/^\d{4}-\d{2}-\d{2}$/.test(String(ymd))) return null;
      var y = parseInt(String(ymd).slice(0, 4), 10);
      var m = parseInt(String(ymd).slice(5, 7), 10);
      var d = parseInt(String(ymd).slice(8, 10), 10);
      if (!Number.isFinite(y) || !Number.isFinite(m) || !Number.isFinite(d)) return null;
      var dt = new Date(Date.UTC(y, m - 1, d, 12, 0, 0));
      dt.setUTCDate(dt.getUTCDate() + (Number(deltaDays) || 0));
      return dt.toISOString().slice(0, 10);
    }

    function rollingRangeYmdBounds(rangeKey) {
      var rk = (rangeKey == null ? '' : String(rangeKey)).trim().toLowerCase();
      if (!rk) return null;
      var endYmd = null;
      try { endYmd = ymdNowInTz(); } catch (_) { endYmd = null; }
      if (!endYmd || !/^\d{4}-\d{2}-\d{2}$/.test(String(endYmd))) return null;
      if (rk === '3d') return { startYmd: ymdAddDays(endYmd, -2), endYmd: endYmd };
      if (rk === '7d') return { startYmd: ymdAddDays(endYmd, -6), endYmd: endYmd };
      if (rk === '14d') return { startYmd: ymdAddDays(endYmd, -13), endYmd: endYmd };
      if (rk === '30d') return { startYmd: ymdAddDays(endYmd, -29), endYmd: endYmd };
      if (rk === 'month') return { startYmd: String(endYmd).slice(0, 7) + '-01', endYmd: endYmd };
      return null;
    }

    function compareLabelFromRange(rangeObj, opts) {
      var startMs = rangeObj && rangeObj.start != null ? Number(rangeObj.start) : NaN;
      var endMs = rangeObj && rangeObj.end != null ? Number(rangeObj.end) : NaN;
      if (!Number.isFinite(startMs) || !Number.isFinite(endMs) || !(endMs > startMs)) return '';
      var startYmd = ymdInAdminTzFromMs(startMs);
      var endYmd = ymdInAdminTzFromMs(Math.max(startMs, endMs - 1));
      if (!startYmd || !endYmd) return '';
      return formatYmdRangeMonthDay(startYmd, endYmd);
    }

    function renderDashboardKpisFromApi(primaryData) {
      if (!primaryData || PAGE !== 'dashboard') return;
      var el = function(id) { return document.getElementById(id); };
      var kpiRange = getStatsRange();
      var showSecondary = showDashboardSecondaryCompare(kpiRange);

      function numFromMap(dataObj, keyName, rangeKey) {
        var map = dataObj && dataObj[keyName] ? dataObj[keyName] : null;
        var v = map && typeof map[rangeKey] === 'number' ? map[rangeKey] : null;
        return (typeof v === 'number' && Number.isFinite(v)) ? v : null;
      }

      function sessionsFromBreakdownMap(dataObj, rangeKey) {
        var br = dataObj && dataObj.trafficBreakdown ? dataObj.trafficBreakdown : null;
        var r = br && br[rangeKey] ? br[rangeKey] : null;
        var v = r && typeof r.human_sessions === 'number' ? r.human_sessions : null;
        return (typeof v === 'number' && Number.isFinite(v)) ? v : null;
      }

      function sessionsFromBreakdownCompare(compareObj) {
        var br = compareObj && compareObj.trafficBreakdown ? compareObj.trafficBreakdown : null;
        var v = br && typeof br.human_sessions === 'number' ? br.human_sessions : null;
        return (typeof v === 'number' && Number.isFinite(v)) ? v : null;
      }

      function numFromCompare(compareObj, keyName) {
        var v = compareObj && typeof compareObj[keyName] === 'number' ? compareObj[keyName] : null;
        return (typeof v === 'number' && Number.isFinite(v)) ? v : null;
      }

      function round2Local(v) {
        return (typeof v === 'number' && Number.isFinite(v)) ? (Math.round(v * 100) / 100) : null;
      }

      var main = primaryData;
      var profitKpiAllowed = !!(main && main.profitKpiAllowed === true);
      setRuntimeProfitKpiAllowed(profitKpiAllowed);
      var salesVal = numFromMap(main, 'sales', kpiRange);
      var costVal = numFromMap(main, 'cost', kpiRange);
      var profitVal = numFromMap(main, 'profit', kpiRange);
      if (profitVal == null && salesVal != null && costVal != null) profitVal = round2Local(salesVal - costVal);
      if (!profitKpiAllowed) profitVal = null;
      var ordersVal = numFromMap(main, 'convertedCount', kpiRange);
      var sessionsVal = sessionsFromBreakdownMap(main, kpiRange);
      var convVal = numFromMap(main, 'conversion', kpiRange);
      var vpvVal = numFromMap(main, 'vpv', kpiRange);
      var aovVal = numFromMap(main, 'aov', kpiRange);
      var bounceVal = numFromMap(main, 'bounce', kpiRange);
      var returningVal = numFromMap(main, 'returningCustomerCount', kpiRange);
      var roasVal = numFromMap(main, 'roas', kpiRange);
      var extrasMain = (kpiExpandedExtrasRange === kpiRange) ? (kpiExpandedExtrasCache || null) : null;
      var itemsVal = extrasMain && typeof extrasMain.itemsSold === 'number' ? extrasMain.itemsSold : null;
      var fulfilledVal = extrasMain && typeof extrasMain.ordersFulfilled === 'number' ? extrasMain.ordersFulfilled : null;
      var returnsVal = extrasMain && typeof extrasMain.returns === 'number' ? extrasMain.returns : null;
      var cogsVal = extrasMain && typeof extrasMain.cogs === 'number' ? extrasMain.cogs : null;

      function setDashValueText(id, textValue) {
        var node = el(id);
        if (!node) return;
        if (textValue == null || textValue === '') {
          node.innerHTML = '<span class="kpi-mini-spinner" aria-hidden="true"></span>';
          return;
        }
        node.textContent = String(textValue);
      }

      setDashValueText('dash-kpi-revenue', salesVal != null ? formatRevenue0(salesVal) : '\u2014');
      setDashValueText('dash-kpi-profit', profitVal != null ? formatRevenue0(profitVal) : '\u2014');
      // Overview card Profit is set only by the chart (setOverviewSalesRunningTotals) so it stays in sync with the graph; do not overwrite from KPI.
      setDashValueText('dash-kpi-orders', ordersVal != null ? Math.round(ordersVal).toLocaleString() : '\u2014');
      setDashValueText('dash-kpi-sessions', sessionsVal != null ? formatSessions(sessionsVal) : '\u2014');
      setDashValueText('dash-kpi-conv', convVal != null ? pct(convVal) : '\u2014');
      setDashValueText('dash-kpi-vpv', vpvVal != null ? formatRevenue(vpvVal) : '\u2014');
      setDashValueText('dash-kpi-aov', aovVal != null ? formatRevenue0(aovVal) : '\u2014');
      setDashValueText('dash-kpi-bounce', bounceVal != null ? pct(bounceVal) : '\u2014');
      setDashValueText('dash-kpi-returning', returningVal != null ? Math.round(returningVal).toLocaleString() : '\u2014');
      setDashValueText('dash-kpi-roas', roasVal != null ? roasVal.toFixed(2) + 'x' : '\u2014');
      setDashValueText('dash-kpi-items', itemsVal != null ? Math.round(itemsVal).toLocaleString() : '\u2014');
      setDashValueText('dash-kpi-fulfilled', fulfilledVal != null ? Math.round(fulfilledVal).toLocaleString() : '\u2014');
      setDashValueText('dash-kpi-returns', returnsVal != null ? formatNegativeCurrencyOrZero(returnsVal, true) : '\u2014');
      setDashValueText('dash-kpi-cogs', cogsVal != null ? formatRevenue0(cogsVal) : '\u2014');

      function renderCompareSlot(slotSuffix, values) {
        values = values || {};
        var sales = values.sales;
        var profit = values.profit;
        var orders = values.orders;
        var sessions = values.sessions;
        var conv = values.conv;
        var vpv = values.vpv;
        var aov = values.aov;
        var bounce = values.bounce;
        var returning = values.returning;
        var roas = values.roas;
        var items = values.items;
        var fulfilled = values.fulfilled;
        var returns = values.returns;
        var cogs = values.cogs;

        setDashValueText('dash-revenue-' + slotSuffix, sales != null ? formatRevenue0(sales) : '\u2014');
        setDashValueText('dash-profit-' + slotSuffix, profit != null ? formatRevenue0(profit) : '\u2014');
        setDashValueText('dash-orders-' + slotSuffix, orders != null ? Math.round(orders).toLocaleString() : '\u2014');
        setDashValueText('dash-sessions-' + slotSuffix, sessions != null ? formatSessions(sessions) : '\u2014');
        setDashValueText('dash-conv-' + slotSuffix, conv != null ? pct(conv) : '\u2014');
        setDashValueText('dash-vpv-' + slotSuffix, vpv != null ? formatRevenue(vpv) : '\u2014');
        setDashValueText('dash-aov-' + slotSuffix, aov != null ? formatRevenue0(aov) : '\u2014');
        setDashValueText('dash-bounce-' + slotSuffix, bounce != null ? pct(bounce) : '\u2014');
        setDashValueText('dash-returning-' + slotSuffix, returning != null ? Math.round(returning).toLocaleString() : '\u2014');
        setDashValueText('dash-roas-' + slotSuffix, roas != null ? roas.toFixed(2) + 'x' : '\u2014');
        setDashValueText('dash-items-' + slotSuffix, items != null ? Math.round(items).toLocaleString() : '\u2014');
        setDashValueText('dash-fulfilled-' + slotSuffix, fulfilled != null ? Math.round(fulfilled).toLocaleString() : '\u2014');
        setDashValueText('dash-returns-' + slotSuffix, returns != null ? formatNegativeCurrencyOrZero(returns, true) : '\u2014');
        setDashValueText('dash-cogs-' + slotSuffix, cogs != null ? formatRevenue0(cogs) : '\u2014');
      }

      function applyDashDelta(key, current, baseline, invert) {
        var wrap = el('dash-kpi-' + key + '-delta');
        var textEl = el('dash-kpi-' + key + '-delta-text');
        if (!wrap || !textEl) return;

        var cur = typeof current === 'number' && Number.isFinite(current) ? current : null;
        var base = typeof baseline === 'number' && Number.isFinite(baseline) ? baseline : null;
        var rawDelta = (cur != null && base != null) ? kpiDelta(cur, base) : null;
        var toneDelta = null;
        if (cur != null && base != null) {
          var diff = cur - base;
          var denom = Math.abs(base);
          toneDelta = denom > 1e-9 ? (diff / denom) : (diff === 0 ? 0 : (diff > 0 ? 1 : -1));
          if (invert) toneDelta = -toneDelta;
        }
        var isNew = base === 0 && cur != null && cur !== 0;
        var isUp = isNew || (toneDelta != null && toneDelta > KPI_STABLE_RATIO);
        var isDown = !isNew && toneDelta != null && toneDelta < -KPI_STABLE_RATIO;
        var isFlat = !isNew && toneDelta != null && !isUp && !isDown;

        var dir = 'none';
        var text = '\u2014';
        if (rawDelta != null) {
          text = isNew ? 'new' : formatSignedPercentOneDecimalFromRatio(rawDelta);
          dir = isUp ? 'up' : (isDown ? 'down' : 'flat');
        }
        var forceNeutralTone = DASHBOARD_NEUTRAL_DELTA_KEYS.has(String(key || '').toLowerCase());
        var visualDir = (forceNeutralTone && dir !== 'none') ? 'flat' : dir;

        wrap.classList.remove('is-up', 'is-down', 'is-flat');
        if (rawDelta == null) {
          wrap.classList.add('is-hidden');
          wrap.setAttribute('data-dir', 'none');
          textEl.textContent = '\u2014';
          return;
        }

        wrap.classList.remove('is-hidden');
        if (visualDir === 'up') wrap.classList.add('is-up');
        else if (visualDir === 'down') wrap.classList.add('is-down');
        else if (visualDir === 'flat') wrap.classList.add('is-flat');
        wrap.setAttribute('data-dir', visualDir);
        textEl.textContent = text;
        try {
          var dashDeltaStyle = getChartsKpiBundle('dashboardCards').deltaStyle;
          var dashTone = forceNeutralTone
            ? DASHBOARD_NEUTRAL_TONE_HEX
            : chartsKpiToneColor('dashboardCards', visualDir === 'none' ? 'same' : visualDir);
          wrap.style.fontSize = String(dashDeltaStyle.fontSize) + 'px';
          wrap.style.fontWeight = String(dashDeltaStyle.fontWeight);
          wrap.style.color = forceNeutralTone ? DASHBOARD_NEUTRAL_TONE_HEX : (dashDeltaStyle.fontColor || dashTone);
        } catch (_) {}

        var icon = wrap.querySelector ? wrap.querySelector('i') : null;
        if (icon) {
          var iconKey = 'dash-kpi-delta-up';
          if (visualDir === 'down') iconKey = 'dash-kpi-delta-down';
          else if (visualDir === 'flat') iconKey = 'dash-kpi-delta-flat';
          icon.setAttribute('data-icon-key', iconKey);
          icon.classList.remove('fa-arrow-trend-up', 'fa-arrow-trend-down', 'fa-minus');
          if (visualDir === 'down') icon.classList.add('fa-arrow-trend-down');
          else if (visualDir === 'flat') icon.classList.add('fa-minus');
          else icon.classList.add('fa-arrow-trend-up');
          try {
            var dashDeltaStyleIcon = getChartsKpiBundle('dashboardCards').deltaStyle;
            var dashToneIcon = forceNeutralTone
              ? DASHBOARD_NEUTRAL_TONE_HEX
              : chartsKpiToneColor('dashboardCards', visualDir === 'none' ? 'same' : visualDir);
            icon.style.fontSize = String(dashDeltaStyleIcon.iconSize) + 'px';
            icon.style.color = forceNeutralTone ? DASHBOARD_NEUTRAL_TONE_HEX : (dashDeltaStyleIcon.iconColor || dashToneIcon);
          } catch (_) {}
          try {
            if (!forceNeutralTone && window.KexoIconTheme && typeof window.KexoIconTheme.applyElement === 'function') {
              window.KexoIconTheme.applyElement(icon);
            }
          } catch (_) {}
        }
      }

      var primaryCompare = main && main.compare ? main.compare : null;
      var primaryExtrasCompare = extrasMain && extrasMain.compare ? extrasMain.compare : null;
      var salesBase = numFromCompare(primaryCompare, 'sales');
      var costBase = numFromCompare(primaryCompare, 'cost');
      var profitBase = numFromCompare(primaryCompare, 'profit');
      if (profitBase == null && salesBase != null && costBase != null) profitBase = round2Local(salesBase - costBase);
      if (!profitKpiAllowed) profitBase = null;
      var ordersBase = numFromCompare(primaryCompare, 'convertedCount');
      var sessionsBase = sessionsFromBreakdownCompare(primaryCompare);
      var convBase = numFromCompare(primaryCompare, 'conversion');
      var vpvBase = numFromCompare(primaryCompare, 'vpv');
      var aovBase = numFromCompare(primaryCompare, 'aov');
      var bounceBase = numFromCompare(primaryCompare, 'bounce');
      var returningBase = numFromCompare(primaryCompare, 'returningCustomerCount');
      var roasBase = numFromCompare(primaryCompare, 'roas');
      var itemsBase = primaryExtrasCompare && typeof primaryExtrasCompare.itemsSold === 'number' ? primaryExtrasCompare.itemsSold : null;
      var fulfilledBase = primaryExtrasCompare && typeof primaryExtrasCompare.ordersFulfilled === 'number' ? primaryExtrasCompare.ordersFulfilled : null;
      var returnsBase = primaryExtrasCompare && typeof primaryExtrasCompare.returns === 'number' ? primaryExtrasCompare.returns : null;
      var cogsBase = primaryExtrasCompare && typeof primaryExtrasCompare.cogs === 'number' ? primaryExtrasCompare.cogs : null;

      applyDashDelta('revenue', salesVal, salesBase, false);
      applyDashDelta('profit', profitVal, profitBase, false);
      applyDashDelta('orders', ordersVal, ordersBase, false);
      applyDashDelta('sessions', sessionsVal, sessionsBase, false);
      applyDashDelta('conv', convVal, convBase, false);
      applyDashDelta('vpv', vpvVal, vpvBase, false);
      applyDashDelta('aov', aovVal, aovBase, false);
      applyDashDelta('bounce', bounceVal, bounceBase, true);
      applyDashDelta('returning', returningVal, returningBase, false);
      applyDashDelta('roas', roasVal, roasBase, false);
      applyDashDelta('items', itemsVal, itemsBase, false);
      applyDashDelta('fulfilled', fulfilledVal, fulfilledBase, false);
      applyDashDelta('returns', returnsVal, returnsBase, true);
      applyDashDelta('cogs', cogsVal, cogsBase, true);
      renderCompareSlot('yesterday', {
        sales: salesBase,
        profit: profitBase,
        orders: ordersBase,
        sessions: sessionsBase,
        conv: convBase,
        vpv: vpvBase,
        aov: aovBase,
        bounce: bounceBase,
        returning: returningBase,
        roas: roasBase,
        items: itemsBase,
        fulfilled: fulfilledBase,
        returns: returnsBase,
        cogs: cogsBase,
      });

      var primaryCompareLabel = '';
      try {
        var rkNorm = normalizeRangeKeyForApi(kpiRange);
        primaryCompareLabel = compareLabelFromRange(primaryCompare && primaryCompare.range ? primaryCompare.range : null, { sameTime: rkNorm === 'today' });
      } catch (_) {
        primaryCompareLabel = '';
      }
      if (!primaryCompareLabel) {
        try { primaryCompareLabel = getCompareDisplayLabel(kpiRange); } catch (_) { primaryCompareLabel = 'Previous period'; }
      }

      var secondaryCompareLabel = '';
      try {
        var sec = rollingRangeYmdBounds('7d');
        if (sec && sec.startYmd && sec.endYmd) secondaryCompareLabel = formatYmdRangeMonthDay(sec.startYmd, sec.endYmd);
      } catch (_) {
        secondaryCompareLabel = '';
      }
      if (!secondaryCompareLabel) secondaryCompareLabel = 'Previous 7 days';

      setDashboardCompareLabels(primaryCompareLabel, secondaryCompareLabel, showSecondary);

      if (showSecondary) {
        var secondary = _dashKpisSecondary;
        var secondaryRangeKey = '7d';
        var secondaryExtras = _dashKpiExtrasSecondary;
        var secondarySales = numFromMap(secondary, 'sales', secondaryRangeKey);
        var secondaryCost = numFromMap(secondary, 'cost', secondaryRangeKey);
        var secondaryProfit = numFromMap(secondary, 'profit', secondaryRangeKey);
        if (secondaryProfit == null && secondarySales != null && secondaryCost != null) secondaryProfit = round2Local(secondarySales - secondaryCost);
        if (!profitKpiAllowed) secondaryProfit = null;
        renderCompareSlot('7d', {
          sales: secondarySales,
          profit: secondaryProfit,
          orders: numFromMap(secondary, 'convertedCount', secondaryRangeKey),
          sessions: sessionsFromBreakdownMap(secondary, secondaryRangeKey),
          conv: numFromMap(secondary, 'conversion', secondaryRangeKey),
          vpv: numFromMap(secondary, 'vpv', secondaryRangeKey),
          aov: numFromMap(secondary, 'aov', secondaryRangeKey),
          bounce: numFromMap(secondary, 'bounce', secondaryRangeKey),
          returning: numFromMap(secondary, 'returningCustomerCount', secondaryRangeKey),
          roas: numFromMap(secondary, 'roas', secondaryRangeKey),
          items: secondaryExtras && typeof secondaryExtras.itemsSold === 'number' ? secondaryExtras.itemsSold : null,
          fulfilled: secondaryExtras && typeof secondaryExtras.ordersFulfilled === 'number' ? secondaryExtras.ordersFulfilled : null,
          returns: secondaryExtras && typeof secondaryExtras.returns === 'number' ? secondaryExtras.returns : null,
          cogs: secondaryExtras && typeof secondaryExtras.cogs === 'number' ? secondaryExtras.cogs : null,
        });
      } else {
        renderCompareSlot('7d', {});
      }

      // Fetch optional secondary compare in background only when slot is visible.
      if (showSecondary && !_dashKpisSecondary) {
        ensureDashboardSecondaryKpis().then(function() {
          try { if (PAGE === 'dashboard') renderDashboardKpisFromApi(primaryData); } catch (_) {}
        }).catch(function() {});
      }
      if (showSecondary && !_dashKpiExtrasSecondary) {
        ensureDashboardSecondaryExtras().then(function() {
          try { if (PAGE === 'dashboard') renderDashboardKpisFromApi(primaryData); } catch (_) {}
        }).catch(function() {});
      }

      // Main extras are fetched on-demand from the selected range.
      if (!extrasMain) {
        fetchExpandedKpiExtras({ force: false }).then(function() {
          try { if (PAGE === 'dashboard') renderDashboardKpisFromApi(primaryData); } catch (_) {}
        }).catch(function() {});
      }
    }

    // Condensed KPI strip only (expanded overlay removed).
    let _condensedOverflowRaf = 0;
    let _condensedStripResizeObserver = null;
    function updateCondensedKpiOverflow() {
      const strip = document.getElementById('kexo-condensed-kpis');
      if (!strip) return;
      const chipsAll = Array.prototype.slice.call(strip.querySelectorAll('.kexo-kpi-chip'));
      const chips = chipsAll.filter(function(ch) { return ch && ch.classList ? !ch.classList.contains('is-user-disabled') : true; });
      if (!chips.length) return;
      const isMobileViewport = !!(window.matchMedia && window.matchMedia('(max-width: 991.98px)').matches);
      if (isMobileViewport) {
        strip.style.removeProperty('--kexo-kpi-width');
        strip.style.removeProperty('--kexo-kpi-min-width');
        strip.style.setProperty('--kexo-kpi-spark-width', '36px');
        strip.style.setProperty('--kexo-kpi-spark-right', '4px');
        for (let i = 0; i < chips.length; i++) {
          chips[i].classList.remove('is-hidden');
          chips[i].setAttribute('aria-hidden', 'false');
        }
        return;
      }
      // Auto-fit chips to available width; hide overflow chips from the end.
      const avail = strip.clientWidth || 0;
      if (!Number.isFinite(avail) || avail <= 0) return;

      const stripStyle = window.getComputedStyle(strip);
      const gapPx = parseFloat(stripStyle.columnGap || stripStyle.gap) || 0;
      const rootStyle = window.getComputedStyle(document.documentElement);
      const configuredMin = parseFloat(rootStyle.getPropertyValue('--kexo-kpi-min-width')) || 120;
      const minWidth = Math.max(100, configuredMin); // never below 100; hide chips when below min

      function widthFor(count) {
        const n = Math.max(1, Number(count) || 1);
        const totalGap = gapPx * Math.max(0, n - 1);
        return (avail - totalGap) / n;
      }

      let visibleCount = chips.length;
      let chipWidth = widthFor(visibleCount);
      while (visibleCount > 1 && chipWidth < minWidth) {
        visibleCount -= 1;
        chipWidth = widthFor(visibleCount);
      }

      // If we can???t satisfy the floor (extremely narrow), show 1 chip at whatever width we have.
      if (!Number.isFinite(chipWidth) || chipWidth <= 0) return;

      const w = Math.max(0, Math.round(chipWidth * 100) / 100);
      const wStr = String(w).replace(/\.0+$/, '');
      strip.style.setProperty('--kexo-kpi-width', wStr + 'px');
      strip.style.setProperty('--kexo-kpi-min-width', wStr + 'px');

      // Condensed sparkline sizing: shrink more aggressively on tight chips so the chart
      // doesn't sit behind the label/value text when chips are auto-fit small.
      const tight = w <= 136;
      const sparkRatio = tight ? 0.24 : 0.30;
      const sparkW = Math.max(28, Math.min(45, Math.round(w * sparkRatio)));
      strip.style.setProperty('--kexo-kpi-spark-width', String(sparkW) + 'px');
      strip.style.setProperty('--kexo-kpi-spark-right', (tight ? '0px' : '6px'));

      for (let i = 0; i < chips.length; i++) {
        const show = i < visibleCount;
        chips[i].classList.toggle('is-hidden', !show);
        chips[i].setAttribute('aria-hidden', show ? 'false' : 'true');
      }
    }
    function scheduleCondensedKpiOverflowUpdate() {
      if (_condensedOverflowRaf) return;
      const raf = (typeof requestAnimationFrame === 'function') ? requestAnimationFrame : function(cb) { return setTimeout(cb, 16); };
      _condensedOverflowRaf = raf(function() {
        _condensedOverflowRaf = 0;
        updateCondensedKpiOverflow();
      });
    }

    // ?????? KPI + date range UI config (stored in /api/settings) ?????????????????????????????????????????????
    var uiSettingsCache = null;
    var uiSettingsFetchedAt = 0;
    var uiSettingsInFlight = null;
    var kpiUiConfigV1 = null;
    var chartsUiConfigV1 = null;
    var overviewWidgetsUiConfigV1 = null;
    var cssVarOverridesV1 = null;
    var _dashboardKpiResizeWired = false;
    var _dashboardKpiResizeTimer = 0;
    var KPI_UI_CFG_LS_KEY = 'kexo:kpi-ui-config:v1';
    var CHARTS_UI_CFG_LS_KEY = 'kexo:charts-ui-config:v1';
    var OVERVIEW_WIDGETS_UI_CFG_LS_KEY = 'kexo:overview_widgets_ui_config:v1';
    var CSS_VAR_OVERRIDES_LS_KEY = 'kexo:css_var_overrides:v1';
    var CHARTS_KPI_BUNDLE_KEYS = ['dashboardCards', 'headerStrip', 'yearlySnapshot'];

    function readLocalStorageJsonMaybe(key) {
      try {
        if (typeof safeReadLocalStorageJson === 'function') return safeReadLocalStorageJson(key);
      } catch (_) {}
      try {
        var raw = localStorage.getItem(String(key || ''));
        if (!raw) return null;
        return JSON.parse(raw);
      } catch (_) {
        return null;
      }
    }

    var OVERVIEW_WIDGET_KEYS = ['finishes', 'devices', 'browsers', 'abandoned', 'attribution', 'payment_methods'];

    function defaultOverviewWidgetsUiConfigV1() {
      var widgets = {};
      OVERVIEW_WIDGET_KEYS.forEach(function (key) { widgets[key] = { sortBy: 'revenue', color: '' }; });
      widgets.finishes = Object.assign({}, widgets.finishes, { groupBy: 'finishes' });
      return { v: 1, order: OVERVIEW_WIDGET_KEYS.slice(), widgets: widgets };
    }

    function normalizeCssVarOverrideValue(raw) {
      var v = raw == null ? '' : String(raw).trim();
      if (!v) return '';
      if (v.length > 80) return '';
      if (/[;\r\n{}]/.test(v)) return '';
      if (/^var\(--[a-zA-Z0-9._-]+\)$/.test(v)) return v;
      if (/^#([0-9a-f]{3}|[0-9a-f]{6}|[0-9a-f]{8})$/i.test(v)) return v;
      if (/^(rgb|hsl)a?\(/i.test(v)) return v;
      if (v.toLowerCase() === 'currentcolor') return 'currentColor';
      if (v.toLowerCase() === 'transparent') return 'transparent';
      if (/^[a-z-]+$/i.test(v)) return v;
      return '';
    }

    function normalizeOverviewWidgetsUiConfigV1(raw) {
      var parsed = null;
      try {
        if (raw && typeof raw === 'object') parsed = raw;
        else if (typeof raw === 'string' && raw) parsed = JSON.parse(raw);
      } catch (_) { parsed = null; }
      var out = defaultOverviewWidgetsUiConfigV1();
      if (!parsed || typeof parsed !== 'object') return out;
      if (Number(parsed.v) !== 1) return out;
      try {
        if (Array.isArray(parsed.order)) {
          var seen = {};
          var next = [];
          parsed.order.forEach(function (k) {
            var key = (k == null ? '' : String(k)).trim().toLowerCase();
            if (!key) return;
            if (OVERVIEW_WIDGET_KEYS.indexOf(key) < 0) return;
            if (seen[key]) return;
            seen[key] = true;
            next.push(key);
          });
          if (next.length === OVERVIEW_WIDGET_KEYS.length) out.order = next;
        }
      } catch (_) {}
      try {
        var w = parsed.widgets && typeof parsed.widgets === 'object' ? parsed.widgets : null;
        if (w) {
          OVERVIEW_WIDGET_KEYS.forEach(function (key) {
            var row = w[key] && typeof w[key] === 'object' ? w[key] : null;
            if (!row) return;
            if (row.sortBy != null) {
              var sb = String(row.sortBy || '').trim().toLowerCase();
              if (sb === 'revenue' || sb === 'clicks' || sb === 'ctr') out.widgets[key].sortBy = sb;
            }
            if (Object.prototype.hasOwnProperty.call(row, 'color')) {
              out.widgets[key].color = normalizeCssVarOverrideValue(row.color) || '';
            }
            if (key === 'finishes' && row.groupBy != null) {
              var gb = String(row.groupBy || '').trim().toLowerCase();
              if (gb) out.widgets.finishes.groupBy = gb;
            }
          });
        }
      } catch (_) {}
      return out;
    }

    var _overviewWidgetsUiCfgSig = '';
    function applyOverviewWidgetsUiConfigV1(cfg, opts) {
      opts = opts && typeof opts === 'object' ? opts : {};
      var next = normalizeOverviewWidgetsUiConfigV1(cfg);
      var sig = '';
      try { sig = JSON.stringify(next || null) || ''; } catch (_) { sig = String(Date.now()); }
      var changed = sig !== _overviewWidgetsUiCfgSig;
      _overviewWidgetsUiCfgSig = sig;
      overviewWidgetsUiConfigV1 = next;
      if (changed) {
        try { localStorage.setItem(OVERVIEW_WIDGETS_UI_CFG_LS_KEY, JSON.stringify(next)); } catch (_) {}
      }
      if (changed && opts.dispatch !== false) {
        try { document.dispatchEvent(new CustomEvent('kexo:overviewWidgetsUiConfigUpdated', { detail: { cfg: next } })); } catch (_) {}
      }
      return next;
    }

    function defaultCssVarOverridesV1() { return { v: 1, vars: {} }; }

    function normalizeCssVarOverridesV1(raw) {
      var parsed = null;
      try {
        if (raw && typeof raw === 'object') parsed = raw;
        else if (typeof raw === 'string' && raw) parsed = JSON.parse(raw);
      } catch (_) { parsed = null; }
      var out = defaultCssVarOverridesV1();
      if (!parsed || typeof parsed !== 'object') return out;
      if (Number(parsed.v) !== 1) return out;
      var vars = parsed.vars && typeof parsed.vars === 'object' ? parsed.vars : null;
      if (!vars) return out;
      var next = {};
      var keys = Object.keys(vars);
      for (var i = 0; i < keys.length && i < 50; i++) {
        var name = String(keys[i] || '').trim();
        if (!/^--[a-zA-Z0-9._-]+$/.test(name)) continue;
        var val = normalizeCssVarOverrideValue(vars[name]);
        if (!val) continue;
        next[name] = val;
      }
      out.vars = next;
      return out;
    }

    var _cssVarsApplied = {};
    var _cssVarOverridesSig = '';
    function applyCssVarOverridesV1(cfg, opts) {
      opts = opts && typeof opts === 'object' ? opts : {};
      var next = normalizeCssVarOverridesV1(cfg);
      var sig = '';
      try { sig = JSON.stringify(next || null) || ''; } catch (_) { sig = String(Date.now()); }
      var changed = sig !== _cssVarOverridesSig;
      _cssVarOverridesSig = sig;
      cssVarOverridesV1 = next;
      if (changed) {
        try { localStorage.setItem(CSS_VAR_OVERRIDES_LS_KEY, JSON.stringify(next)); } catch (_) {}
      }
      try {
        var root = document.documentElement;
        var vars = next && next.vars && typeof next.vars === 'object' ? next.vars : {};
        Object.keys(_cssVarsApplied || {}).forEach(function (k) {
          if (!Object.prototype.hasOwnProperty.call(vars, k)) {
            try { root.style.removeProperty(k); } catch (_) {}
          }
        });
        Object.keys(vars).forEach(function (k) {
          try { root.style.setProperty(k, String(vars[k])); } catch (_) {}
        });
        _cssVarsApplied = Object.assign({}, vars);
      } catch (_) {}
      if (changed && opts.dispatch !== false) {
        try { document.dispatchEvent(new CustomEvent('kexo:cssVarOverridesUpdated', { detail: { cfg: next } })); } catch (_) {}
      }
      return next;
    }

    function defaultChartsKpiBundlePalette(bundleKey) {
      var key = String(bundleKey || '').trim().toLowerCase();
      var same = '#66bdb7';
      if (key === 'dashboardcards') {
        same = cssVarColor('--kexo-accent-1', '#4b94e4');
      }
      return { up: '#2fb344', down: '#d63939', same: same, compareLine: '#cccccc' };
    }

    function defaultChartsKpiSparklineConfig(bundleKey) {
      if (bundleKey === 'headerStrip') return { mode: 'line', curve: 'smooth', strokeWidth: 2.15, height: 30, showCompare: false, advancedApexOverride: {} };
      if (bundleKey === 'yearlySnapshot') return { mode: 'line', curve: 'smooth', strokeWidth: 2.55, height: 56, showCompare: false, advancedApexOverride: {} };
      return { mode: 'line', curve: 'straight', strokeWidth: 2.55, height: 50, showCompare: true, compareUsePrimaryColor: false, compareOpacity: 50, advancedApexOverride: {} };
    }

    function defaultChartsKpiDeltaStyle(bundleKey) {
      if (bundleKey === 'headerStrip') return { fontSize: 11, fontWeight: 500, iconSize: 10, fontColor: '', iconColor: '' };
      if (bundleKey === 'yearlySnapshot') return { fontSize: 12, fontWeight: 500, iconSize: 12, fontColor: '', iconColor: '' };
      return { fontSize: 14, fontWeight: 500, iconSize: 12, fontColor: '', iconColor: '' };
    }

    function defaultChartsKpiBundle(bundleKey) {
      return {
        sparkline: defaultChartsKpiSparklineConfig(bundleKey),
        deltaStyle: defaultChartsKpiDeltaStyle(bundleKey),
        palette: defaultChartsKpiBundlePalette(bundleKey),
      };
    }

    function isPlainObject(value) {
      return !!value && Object.prototype.toString.call(value) === '[object Object]';
    }

    function deepMergeOptions(base, override) {
      if (!isPlainObject(base) || !isPlainObject(override)) return base;
      Object.keys(override).forEach(function (key) {
        var next = override[key];
        if (Array.isArray(next)) {
          base[key] = next.slice();
          return;
        }
        if (isPlainObject(next)) {
          var cur = isPlainObject(base[key]) ? base[key] : {};
          base[key] = deepMergeOptions(cur, next);
          return;
        }
        base[key] = next;
      });
      return base;
    }

    function normalizeHexColorStrict(v, fallback) {
      var raw = v == null ? '' : String(v).trim().toLowerCase();
      if (/^#[0-9a-f]{6}$/.test(raw)) return raw;
      return fallback;
    }

    function normalizeOptionalHexColorStrict(v) {
      var raw = v == null ? '' : String(v).trim().toLowerCase();
      if (!raw) return '';
      if (/^#[0-9a-f]{6}$/.test(raw)) return raw;
      return '';
    }

    function normalizeChartsKpiBundle(bundleKey, rawBundle) {
      var src = rawBundle && typeof rawBundle === 'object' ? rawBundle : {};
      var def = defaultChartsKpiBundle(bundleKey);
      var spark = src.sparkline && typeof src.sparkline === 'object' ? src.sparkline : {};
      var delta = src.deltaStyle && typeof src.deltaStyle === 'object' ? src.deltaStyle : {};
      var palette = src.palette && typeof src.palette === 'object' ? src.palette : {};
      var mode = String(spark.mode || def.sparkline.mode).trim().toLowerCase();
      if (['line', 'area', 'bar'].indexOf(mode) < 0) mode = def.sparkline.mode;
      var curve = String(spark.curve || def.sparkline.curve).trim().toLowerCase();
      if (['smooth', 'straight', 'stepline'].indexOf(curve) < 0) curve = def.sparkline.curve;
      var strokeWidth = Number(spark.strokeWidth);
      if (!Number.isFinite(strokeWidth)) strokeWidth = Number(def.sparkline.strokeWidth);
      strokeWidth = Math.max(0.5, Math.min(6, strokeWidth));
      var height = Number(spark.height);
      if (!Number.isFinite(height)) height = Number(def.sparkline.height);
      height = Math.max(18, Math.min(120, Math.round(height)));
      var fontSize = Number(delta.fontSize);
      if (!Number.isFinite(fontSize)) fontSize = Number(def.deltaStyle.fontSize);
      fontSize = Math.max(9, Math.min(24, Math.round(fontSize)));
      var iconSize = Number(delta.iconSize);
      if (!Number.isFinite(iconSize)) iconSize = Number(def.deltaStyle.iconSize);
      iconSize = Math.max(8, Math.min(24, Math.round(iconSize)));
      var fontWeight = parseInt(String(delta.fontWeight != null ? delta.fontWeight : def.deltaStyle.fontWeight), 10);
      if (fontWeight !== 400 && fontWeight !== 500) fontWeight = def.deltaStyle.fontWeight;
      var supportsCompare = bundleKey === 'dashboardCards';
      var compareUsePrimaryColor = supportsCompare ? (spark.compareUsePrimaryColor !== false) : false;
      var compareOpacity = Number(spark.compareOpacity);
      if (!Number.isFinite(compareOpacity)) compareOpacity = 50;
      compareOpacity = Math.max(0, Math.min(100, Math.round(compareOpacity)));
      var out = {
        sparkline: {
          mode: mode,
          curve: curve,
          strokeWidth: strokeWidth,
          height: height,
          showCompare: supportsCompare ? !(spark.showCompare === false) : false,
          compareUsePrimaryColor: compareUsePrimaryColor,
          compareOpacity: compareOpacity,
          advancedApexOverride: isPlainObject(spark.advancedApexOverride) ? spark.advancedApexOverride : {},
        },
        deltaStyle: {
          fontSize: fontSize,
          fontWeight: fontWeight,
          iconSize: iconSize,
          fontColor: normalizeOptionalHexColorStrict(delta.fontColor || ''),
          iconColor: normalizeOptionalHexColorStrict(delta.iconColor || ''),
        },
        palette: {
          up: normalizeHexColorStrict(palette.up, def.palette.up),
          down: normalizeHexColorStrict(palette.down, def.palette.down),
          same: normalizeHexColorStrict(palette.same, def.palette.same),
          compareLine: normalizeHexColorStrict(palette.compareLine, def.palette.compareLine),
        },
      };
      if (bundleKey === 'dashboardCards') {
        var same = String(out.palette.same || '').trim().toLowerCase();
        if (same === '#66bdb7') {
          out.palette.same = cssVarColor('--kexo-accent-1', '#4b94e4');
        }
      }
      return out;
    }

    function getChartsKpiBundle(bundleKey) {
      var key = String(bundleKey || '').trim();
      if (CHARTS_KPI_BUNDLE_KEYS.indexOf(key) < 0) key = 'dashboardCards';
      var cfg = chartsUiConfigV1;
      var raw = (cfg && cfg.v === 1 && cfg.kpiBundles && typeof cfg.kpiBundles === 'object')
        ? cfg.kpiBundles[key]
        : null;
      // Guardrail: KPI sparkline/palette/delta style is user-managed in Settings ??? Layout ??? Charts.
      // Keep runtime reading from charts_ui_config_v1; do not hardcode replacement colors/sizes here.
      return normalizeChartsKpiBundle(key, raw);
    }

    function chartsKpiToneColor(bundleKey, dir) {
      var bundle = getChartsKpiBundle(bundleKey);
      var d = String(dir || '').toLowerCase();
      if (d === 'up') return bundle.palette.up;
      if (d === 'down') return bundle.palette.down;
      return bundle.palette.same;
    }

    function chartsKpiCompareLineColor(bundleKey) {
      var bundle = getChartsKpiBundle(bundleKey);
      return bundle.palette.compareLine || '#cccccc';
    }

    // Hydrate KPI prefs from localStorage so disabled KPIs are hidden on first paint.
    try {
      var cachedKpis = safeReadLocalStorageJson(KPI_UI_CFG_LS_KEY);
      if (cachedKpis && cachedKpis.v === 1 && cachedKpis.kpis) {
        kpiUiConfigV1 = cachedKpis;
        try { window.__kexoKpiUiConfigV1 = cachedKpis; } catch (_) {}
      }
    } catch (_) {}

    // Hydrate chart prefs from localStorage so first paint uses the last saved config.
    try {
      var cachedCharts = safeReadLocalStorageJson(CHARTS_UI_CFG_LS_KEY);
      if (cachedCharts && cachedCharts.v === 1 && Array.isArray(cachedCharts.charts)) {
        chartsUiConfigV1 = cachedCharts;
        try { window.__kexoChartsUiConfigV1 = cachedCharts; } catch (_) {}
      }
    } catch (_) {}

    // Hydrate Overview widget prefs + CSS var overrides from localStorage for first paint.
    try {
      var cachedOvw = readLocalStorageJsonMaybe(OVERVIEW_WIDGETS_UI_CFG_LS_KEY);
      if (cachedOvw && cachedOvw.v === 1) {
        overviewWidgetsUiConfigV1 = normalizeOverviewWidgetsUiConfigV1(cachedOvw);
        applyOverviewWidgetsUiConfigV1(overviewWidgetsUiConfigV1, { dispatch: false });
      }
    } catch (_) {}
    try {
      var cachedCssVars = readLocalStorageJsonMaybe(CSS_VAR_OVERRIDES_LS_KEY);
      if (cachedCssVars && cachedCssVars.v === 1) {
        applyCssVarOverridesV1(cachedCssVars, { dispatch: false });
      }
    } catch (_) {}

    function isChartsMobileViewport() {
      try {
        return !!(window.matchMedia && window.matchMedia('(max-width: 991.98px)').matches);
      } catch (_) {
        return false;
      }
    }

    function shouldHideChartsOnMobile() {
      var cfg = chartsUiConfigV1;
      // Default ON when config is missing/outdated (requested project policy).
      if (!cfg || typeof cfg !== 'object' || cfg.v !== 1) return true;
      return cfg.hideOnMobile !== false;
    }

    function applyHideChartsOnMobileClass() {
      var root = null;
      try { root = document.documentElement; } catch (_) { root = null; }
      if (!root || !root.classList) return;
      var on = shouldHideChartsOnMobile();
      var mobile = isChartsMobileViewport();
      root.classList.toggle('kexo-hide-charts-mobile', !!(on && mobile));
    }

    try {
      applyHideChartsOnMobileClass();
      try { applyKpiBundleCssVars(); } catch (_) {}
      window.addEventListener('resize', function() {
        try { applyHideChartsOnMobileClass(); } catch (_) {}
      });
    } catch (_) {}

    function getChartsUiItem(key) {
      var cfg = chartsUiConfigV1;
      if (!cfg || cfg.v !== 1 || !Array.isArray(cfg.charts)) return null;
      var k = String(key == null ? '' : key).trim().toLowerCase();
      if (!k) return null;
      for (var i = 0; i < cfg.charts.length; i++) {
        var it = cfg.charts[i];
        if (!it || typeof it !== 'object') continue;
        var ik = it.key != null ? String(it.key).trim().toLowerCase() : '';
        if (ik && ik === k) return it;
      }
      return null;
    }

    function isChartEnabledByUiConfig(key, fallbackEnabled) {
      if (shouldHideChartsOnMobile() && isChartsMobileViewport()) return false;
      var it = getChartsUiItem(key);
      if (it && it.enabled === false) return false;
      return fallbackEnabled !== false;
    }

    function validateChartType(key, mode, fallbackMode) {
      var fb = String(fallbackMode || '').trim().toLowerCase() || 'area';
      var m = String(mode || '').trim().toLowerCase();
      if (!m) m = fb;
      try {
        if (typeof window.kexoChartMeta === 'function') {
          var meta = window.kexoChartMeta(key);
          var allowed = meta && Array.isArray(meta.modes) ? meta.modes.map(function(v) { return String(v).trim().toLowerCase(); }) : [];
          if (allowed.length && allowed.indexOf(m) < 0) {
            if (allowed.indexOf(fb) >= 0) return fb;
            if (meta && meta.defaultMode) return String(meta.defaultMode).trim().toLowerCase();
            return allowed[0];
          }
        }
      } catch (_) {}
      return m || fb;
    }

    function chartModeFromUiConfig(key, fallbackMode) {
      var k = String(key == null ? '' : key).trim().toLowerCase();
      var it = getChartsUiItem(k);
      var m = it && it.mode != null ? String(it.mode).trim().toLowerCase() : '';
      if (k === 'live-online-chart') {
        if (m === 'map-animated' || m === 'map-flat') return m;
        return 'map-flat';
      }
      if (k === 'countries-map-chart') {
        if (m === 'map-animated' || m === 'map-flat') return m;
        return 'map-flat';
      }
      return validateChartType(k, m || fallbackMode, fallbackMode);
    }

    function chartColorsFromUiConfig(key, fallbackColors) {
      var it = getChartsUiItem(key);
      var arr = it && Array.isArray(it.colors) ? it.colors.filter(Boolean).map(function(c) { return String(c).trim(); }).filter(Boolean) : [];
      if (arr.length) return arr;
      return Array.isArray(fallbackColors) ? fallbackColors : [];
    }

    function chartSizePercentFromUiConfig(key, fallbackPercent) {
      var it = getChartsUiItem(key);
      var n = it && it.sizePercent != null ? Number(it.sizePercent) : Number(fallbackPercent);
      if (!Number.isFinite(n)) n = 100;
      n = Math.round(n / 5) * 5;
      if (n < 25) n = 25;
      if (n > 100) n = 100;
      return n;
    }

    function chartPieMetricFromUiConfig(key, fallbackMetric) {
      var it = getChartsUiItem(key);
      var raw = it && it.pieMetric != null ? String(it.pieMetric).trim().toLowerCase() : '';
      if (raw === 'sessions' || raw === 'orders' || raw === 'revenue') return raw;
      var fb = String(fallbackMetric || 'sessions').trim().toLowerCase();
      if (fb === 'sessions' || fb === 'orders' || fb === 'revenue') return fb;
      return 'sessions';
    }

    function defaultChartsLineStyleConfig() {
      return {
        curve: 'smooth',
        strokeWidth: 2.6,
        dashArray: 0,
        markerSize: 3,
        fillOpacity: 0.18,
        gridDash: 3,
        dataLabels: 'auto',
        toolbar: false,
        animations: false,
        icons: false,
        radialCenterLabel: true,
        pieDonut: false,
        pieDonutSize: 66,
        pieLabelPosition: 'auto',
        pieLabelContent: 'percent',
        pieLabelOffset: 16,
        pieCountryFlags: false,
      };
    }

    function normalizeChartStyleConfig(raw) {
      var src = isPlainObject(raw) ? raw : {};
      var def = defaultChartsLineStyleConfig();
      var curve = String(src.curve != null ? src.curve : def.curve).trim().toLowerCase();
      if (curve !== 'smooth' && curve !== 'straight' && curve !== 'stepline') curve = def.curve;
      var dataLabels = String(src.dataLabels != null ? src.dataLabels : def.dataLabels).trim().toLowerCase();
      if (dataLabels !== 'auto' && dataLabels !== 'on' && dataLabels !== 'off') dataLabels = def.dataLabels;
      var pieLabelPosition = String(src.pieLabelPosition != null ? src.pieLabelPosition : def.pieLabelPosition).trim().toLowerCase();
      if (pieLabelPosition !== 'auto' && pieLabelPosition !== 'inside' && pieLabelPosition !== 'outside') pieLabelPosition = def.pieLabelPosition;
      var pieLabelContent = String(src.pieLabelContent != null ? src.pieLabelContent : def.pieLabelContent).trim().toLowerCase();
      if (pieLabelContent !== 'percent' && pieLabelContent !== 'label' && pieLabelContent !== 'label_percent') pieLabelContent = def.pieLabelContent;
      var icons = (src.icons === true) ? true : (src.icons === false) ? false : (def.icons === true);
      function n(v, fb, min, max) {
        var x = Number(v);
        if (!Number.isFinite(x)) x = Number(fb);
        if (!Number.isFinite(x)) x = min;
        if (x < min) x = min;
        if (x > max) x = max;
        return x;
      }
      return {
        curve: curve,
        strokeWidth: n(src.strokeWidth, def.strokeWidth, 0, 8),
        dashArray: n(src.dashArray, def.dashArray, 0, 20),
        markerSize: n(src.markerSize, def.markerSize, 0, 12),
        fillOpacity: n(src.fillOpacity, def.fillOpacity, 0, 1),
        gridDash: n(src.gridDash, def.gridDash, 0, 16),
        dataLabels: dataLabels,
        toolbar: !!src.toolbar,
        animations: src.animations === true,
        icons: icons,
        radialCenterLabel: src.radialCenterLabel !== false,
        pieDonut: !!src.pieDonut,
        pieDonutSize: Math.round(n(src.pieDonutSize, def.pieDonutSize, 30, 90)),
        pieLabelPosition: pieLabelPosition,
        pieLabelContent: pieLabelContent,
        pieLabelOffset: Math.round(n(src.pieLabelOffset, def.pieLabelOffset, -40, 40)),
        pieCountryFlags: !!src.pieCountryFlags,
      };
    }

    function chartStyleFromUiConfig(key) {
      var it = getChartsUiItem(key);
      var raw = it && isPlainObject(it.style) ? it.style : null;
      return normalizeChartStyleConfig(raw || {});
    }

    function chartStyleOverrideFromUiConfig(key, modeHint) {
      var mode = normalizeChartType(String(modeHint || '').trim().toLowerCase() || 'line', 'line');
      if (mode === 'map-animated' || mode === 'map-flat') return null;
      var style = chartStyleFromUiConfig(key);
      var out = {
        chart: {
          toolbar: { show: !!style.toolbar },
          animations: { enabled: !!style.animations }
        },
        grid: { strokeDashArray: style.gridDash }
      };
      if (style.dataLabels === 'on') out.dataLabels = { enabled: true };
      if (style.dataLabels === 'off') out.dataLabels = { enabled: false };
      if (mode === 'pie') {
        var labelOffset = style.pieLabelPosition === 'outside'
          ? Math.max(4, style.pieLabelOffset)
          : (style.pieLabelPosition === 'inside' ? Math.min(0, style.pieLabelOffset) : style.pieLabelOffset);
        out.plotOptions = {
          pie: {
            dataLabels: { offset: labelOffset }
          }
        };
        if (style.pieDonut) {
          out.plotOptions.pie.donut = { size: String(Math.max(30, Math.min(90, Number(style.pieDonutSize) || 66))) + '%' };
        }
      } else if (mode === 'radialbar') {
        if (style.dataLabels === 'on' || style.dataLabels === 'off') {
          out.plotOptions = out.plotOptions || {};
          out.plotOptions.radialBar = out.plotOptions.radialBar || {};
          out.plotOptions.radialBar.dataLabels = out.plotOptions.radialBar.dataLabels || {};
          out.plotOptions.radialBar.dataLabels.value = out.plotOptions.radialBar.dataLabels.value || {};
          out.plotOptions.radialBar.dataLabels.value.show = style.dataLabels === 'on';
        }
        out.fill = { opacity: style.fillOpacity > 0 ? style.fillOpacity : 1 };
      } else {
        out.stroke = {
          show: true,
          curve: style.curve,
          width: mode === 'bar' ? 0 : style.strokeWidth,
          lineCap: 'round',
          dashArray: mode === 'bar' ? 0 : style.dashArray
        };
        out.markers = {
          size: mode === 'line' ? style.markerSize : 0,
          hover: { size: Math.max(4, style.markerSize + 2) }
        };
        if (mode === 'area') {
          out.fill = {
            type: 'gradient',
            gradient: {
              shadeIntensity: 1,
              opacityFrom: style.fillOpacity,
              opacityTo: Math.max(0, style.fillOpacity * 0.35),
              stops: [0, 100]
            }
          };
        } else if (mode === 'bar') {
          out.fill = { type: 'solid', opacity: style.fillOpacity > 0 ? style.fillOpacity : 1 };
        }
      }
      return out;
    }

    function chartAdvancedOverrideFromUiConfig(key, modeHint) {
      var it = getChartsUiItem(key);
      var raw = it && it.advancedApexOverride && typeof it.advancedApexOverride === 'object'
        ? it.advancedApexOverride
        : null;
      var merged = {};
      var styleOverride = chartStyleOverrideFromUiConfig(key, modeHint);
      if (styleOverride && isPlainObject(styleOverride)) deepMergeOptions(merged, styleOverride);
      if (isPlainObject(raw)) deepMergeOptions(merged, raw);
      return Object.keys(merged).length ? merged : null;
    }

    function chartUiConfigSignature(cfg) {
      try { return JSON.stringify(cfg || null); } catch (_) { return ''; }
    }

    function applyKpiBundleCssVars() {
      var root = document && document.documentElement ? document.documentElement : null;
      if (!root || !root.style) return;
      function applyBundleVars(bundleKey, prefix) {
        var bundle = getChartsKpiBundle(bundleKey);
        root.style.setProperty('--kexo-' + prefix + '-kpi-up', bundle.palette.up);
        root.style.setProperty('--kexo-' + prefix + '-kpi-down', bundle.palette.down);
        root.style.setProperty('--kexo-' + prefix + '-kpi-same', bundle.palette.same);
        root.style.setProperty('--kexo-' + prefix + '-kpi-compare-line', bundle.palette.compareLine);
        root.style.setProperty('--kexo-' + prefix + '-kpi-delta-font-size', String(bundle.deltaStyle.fontSize) + 'px');
        root.style.setProperty('--kexo-' + prefix + '-kpi-delta-font-weight', String(bundle.deltaStyle.fontWeight));
        root.style.setProperty('--kexo-' + prefix + '-kpi-delta-icon-size', String(bundle.deltaStyle.iconSize) + 'px');
      }
      applyBundleVars('dashboardCards', 'dashboard');
      applyBundleVars('headerStrip', 'header');
      applyBundleVars('yearlySnapshot', 'snapshot');
      var dash = getChartsKpiBundle('dashboardCards');
      root.style.setProperty('--kexo-kpi-delta-up', dash.palette.up);
      root.style.setProperty('--kexo-kpi-delta-down', dash.palette.down);
      root.style.setProperty('--kexo-kpi-delta-same', dash.palette.same);
      root.style.setProperty('--kexo-kpi-compare-line', dash.palette.compareLine);
    }

    function applyChartsUiConfigV1(cfg) {
      if (!cfg || typeof cfg !== 'object' || cfg.v !== 1 || !Array.isArray(cfg.charts)) return false;
      var prevSig = chartUiConfigSignature(chartsUiConfigV1);
      var nextSig = chartUiConfigSignature(cfg);
      chartsUiConfigV1 = cfg;
      try { window.__kexoChartsUiConfigV1 = cfg; } catch (_) {}
      try { safeWriteLocalStorageJson(CHARTS_UI_CFG_LS_KEY, cfg); } catch (_) {}
      try { applyHideChartsOnMobileClass(); } catch (_) {}
      try { applyKpiBundleCssVars(); } catch (_) {}
      return prevSig !== nextSig;
    }

    var chartsUiReRenderTimer = null;
    function scheduleChartsUiReRender() {
      if (chartsUiReRenderTimer) {
        try { clearTimeout(chartsUiReRenderTimer); } catch (_) {}
      }
      chartsUiReRenderTimer = setTimeout(function() {
        chartsUiReRenderTimer = null;
        try {
          if (activeMainTab === 'dashboard') {
            if (typeof refreshDashboard === 'function') refreshDashboard({ force: true });
            return;
          }
          if (activeMainTab === 'stats') {
            refreshStats({ force: true });
            return;
          }
          if (activeMainTab === 'products') {
            refreshProducts({ force: true });
            return;
          }
          if (activeMainTab === 'attribution') {
            try { refreshAttribution({ force: true }); } catch (_) {}
            return;
          }
          if (activeMainTab === 'devices') {
            try { refreshDevices({ force: true }); } catch (_) {}
            return;
          }
          if (activeMainTab === 'browsers') {
            try { refreshBrowsers({ force: true }); } catch (_) {}
            return;
          }
          if (activeMainTab === 'ads') {
            if (window.__adsRefresh) window.__adsRefresh({ force: true });
            return;
          }
          if (activeMainTab === 'spy' || activeMainTab === 'sales' || activeMainTab === 'date') {
            fetchSessions();
            return;
          }
        } catch (_) {}
      }, 80);
    }

    var tablesUiApplyTimer = null;
    function scheduleTablesUiApply() {
      if (tablesUiApplyTimer) {
        try { clearTimeout(tablesUiApplyTimer); } catch (_) {}
      }
      tablesUiApplyTimer = setTimeout(function() {
        tablesUiApplyTimer = null;
        try { applyTablesUiLayoutForPage(); } catch (_) {}
        try {
          window.dispatchEvent(new CustomEvent('kexo:tablesUiConfigApplied', {
            detail: { v: 1 }
          }));
        } catch (_) {}
      }, 80);
    }

    function applyDateRangeUiConfigToSelect(sel) {
      if (!sel) return;
      var cfg = kpiUiConfigV1;
      if (!cfg || cfg.v !== 1 || !Array.isArray(cfg.dateRanges)) return;
      var byKey = {};
      cfg.dateRanges.forEach(function(it) {
        if (!it || typeof it !== 'object') return;
        var k = it.key != null ? String(it.key).trim().toLowerCase() : '';
        if (!k) return;
        byKey[k] = it;
      });

      function labelOf(key, fallback) {
        var it = byKey[key] || null;
        var lbl = it && it.label != null ? String(it.label).trim() : '';
        return lbl || fallback || '';
      }
      function enabledOf(key, defaultEnabled) {
        var it = byKey[key] || null;
        if (it && it.enabled === false) return false;
        return defaultEnabled !== false;
      }

      function applyOne(key, fallbackLabel, defaultEnabled, preserveExistingDisabledHidden) {
        var opt = sel.querySelector('option[value="' + key + '"]');
        if (!opt) return;
        opt.textContent = labelOf(key, fallbackLabel);
        var enabled = enabledOf(key, defaultEnabled);
        // Guardrails: never allow disabling Today/Custom via UI config.
        if (key === 'today' || key === 'custom') enabled = true;

        if (!enabled) {
          opt.disabled = true;
          try { opt.hidden = true; } catch (_) {}
          return;
        }
        if (preserveExistingDisabledHidden) return;
        opt.disabled = false;
        try { opt.hidden = false; } catch (_) {}
      }

      applyOne('today', 'Today', true, false);
      // For yesterday, keep availability rules from applyRangeAvailable (floor + rangeAvailable)
      applyOne('yesterday', 'Yesterday', true, true);
      applyOne('7days', 'Last 7 days', true, false);
      applyOne('14days', 'Last 14 days', true, false);
      applyOne('30days', 'Last 30 days', true, false);
      applyOne('custom', 'Custom\u2026', true, false);
    }

    function applyHeaderKpiStripVisibilityByPage(cfg) {
      try {
        var bar = document.getElementById('kexo-kpis');
        if (!bar || !cfg || cfg.v !== 1) return;
        var page = '';
        try {
          page = String(document.body && document.body.getAttribute ? document.body.getAttribute('data-page') : '').trim().toLowerCase();
        } catch (_) { page = ''; }
        if (!page) return;
        var pages = cfg && cfg.headerStrip && cfg.headerStrip.pages && typeof cfg.headerStrip.pages === 'object' ? cfg.headerStrip.pages : null;
        if (!pages) return;
        if (pages[page] === false) bar.style.display = 'none';
        else bar.style.display = '';
      } catch (_) {}
    }

    function applyCondensedKpiUiConfig(cfg) {
      var strip = document.getElementById('kexo-condensed-kpis');
      if (!strip || !cfg || cfg.v !== 1) return;
      var list = cfg && cfg.kpis && Array.isArray(cfg.kpis.header) ? cfg.kpis.header : null;
      if (!list) return;

      var idByKey = {
        orders: 'cond-kpi-orders',
        revenue: 'cond-kpi-revenue',
        profit: 'cond-kpi-profit',
        conv: 'cond-kpi-conv',
        vpv: 'cond-kpi-vpv',
        roas: 'cond-kpi-roas',
        sessions: 'cond-kpi-sessions',
        returning: 'cond-kpi-returning',
        aov: 'cond-kpi-aov',
        cogs: 'cond-kpi-cogs',
        bounce: 'cond-kpi-bounce',
        fulfilled: 'cond-kpi-orders-fulfilled',
        returns: 'cond-kpi-returns',
        items: 'cond-kpi-items-sold',
      };
      var chipByKey = {};
      Object.keys(idByKey).forEach(function(key) {
        var valueEl = document.getElementById(idByKey[key]);
        var chip = valueEl && valueEl.closest ? valueEl.closest('.kexo-kpi-chip') : null;
        if (chip) chipByKey[key] = chip;
      });

      var allChips = Array.prototype.slice.call(strip.querySelectorAll('.kexo-kpi-chip'));
      var seen = new Set();
      var frag = document.createDocumentFragment();

      list.forEach(function(item) {
        if (!item || typeof item !== 'object') return;
        var key = item.key != null ? String(item.key).trim().toLowerCase() : '';
        if (!key) return;
        var chip = chipByKey[key] || null;
        if (!chip) return;
        var labelEl = chip.querySelector ? chip.querySelector('.kexo-kpi-chip-label') : null;
        if (labelEl && item.label != null) {
          var lbl = String(item.label).trim();
          if (lbl) labelEl.textContent = lbl;
        }
        var enabled = item.enabled !== false;
        if (key === 'profit' && !runtimeProfitKpiAllowed) enabled = false;
        chip.classList.toggle('is-user-disabled', !enabled);
        frag.appendChild(chip);
        seen.add(chip);
      });

      allChips.forEach(function(chip) {
        if (!chip || seen.has(chip)) return;
        try {
          var isProfitChip = !!(chip.querySelector && chip.querySelector('#cond-kpi-profit'));
          if (isProfitChip) chip.classList.toggle('is-user-disabled', !runtimeProfitKpiAllowed);
        } catch (_) {}
        frag.appendChild(chip);
      });

      strip.appendChild(frag);
      scheduleCondensedKpiOverflowUpdate();

      // Options: hide/show common elements via inline style so other logic doesn't flip them back.
      var opt = cfg.options && cfg.options.condensed ? cfg.options.condensed : {};
      var showDelta = opt.showDelta !== false;
      var showProgress = opt.showProgress !== false;
      var showSparkline = opt.showSparkline !== false;
      strip.querySelectorAll('.kexo-kpi-chip').forEach(function(chip) {
        if (!chip) return;
        var deltaEl = chip.querySelector ? chip.querySelector('.kexo-kpi-chip-delta') : null;
        var progEl = chip.querySelector ? chip.querySelector('.kexo-kpi-chip-progress') : null;
        var sparkEl = chip.querySelector ? chip.querySelector('.kexo-kpi-chip-sparkline') : null;
        if (deltaEl) deltaEl.style.display = showDelta ? '' : 'none';
        if (progEl) progEl.style.display = showProgress ? '' : 'none';
        if (sparkEl) sparkEl.style.display = showSparkline ? '' : 'none';
      });
    }

    function applyDashboardKpiUiConfig(cfg) {
      var grid = document.getElementById('dash-kpi-grid');
      var midGrid = document.getElementById('dash-kpi-grid-mid');
      var lowerGrid = document.getElementById('dash-kpi-grid-lower');
      if (!grid || !midGrid || !lowerGrid) return;
      var list = cfg && cfg.v === 1 && cfg.kpis && Array.isArray(cfg.kpis.dashboard) ? cfg.kpis.dashboard : null;
      var topCap = 4;
      var desktop = false;
      try {
        desktop = !!(window && window.matchMedia && window.matchMedia('(min-width: 1200px)').matches);
        if (desktop) topCap = 4;
      } catch (_) {}
      var midCap = 4;
      var topVisibleCount = 0;
      var midVisibleCount = 0;

      function pinToLower(key) {
        // Keep special/tall KPI cards out of the top+mid layout so the left KPI stacks
        // align exactly with the 4 overview charts on the right (4 top, 4 mid).
        var k = key != null ? String(key).trim().toLowerCase() : '';
        if (!desktop) return false;
        return k === 'kexo_score';
      }

      var idByKey = {
        revenue: 'dash-kpi-revenue',
        profit: 'dash-kpi-profit',
        orders: 'dash-kpi-orders',
        conv: 'dash-kpi-conv',
        vpv: 'dash-kpi-vpv',
        aov: 'dash-kpi-aov',
        sessions: 'dash-kpi-sessions',
        bounce: 'dash-kpi-bounce',
        returning: 'dash-kpi-returning',
        roas: 'dash-kpi-roas',
        cogs: 'dash-kpi-cogs',
        fulfilled: 'dash-kpi-fulfilled',
        returns: 'dash-kpi-returns',
        items: 'dash-kpi-items',
        kexo_score: 'dash-kpi-kexo-score',
      };
      var defaultKpiOrder = ['revenue', 'profit', 'orders', 'conv', 'vpv', 'aov', 'sessions', 'bounce', 'returning', 'roas', 'kexo_score', 'cogs', 'fulfilled', 'returns', 'items'];
      var colByKey = {};
      var keyByCol = new Map();
      Object.keys(idByKey).forEach(function(key) {
        var valueEl = document.getElementById(idByKey[key]);
        var col = valueEl && valueEl.closest ? valueEl.closest('.col-sm-6') : null;
        if (col) {
          colByKey[key] = col;
          keyByCol.set(col, key);
        }
      });

      var allColsPrimary = Array.prototype.slice.call(grid.children || []).filter(function(el) {
        return el && el.classList && el.classList.contains('col-sm-6');
      });
      var allColsMid = Array.prototype.slice.call(midGrid.children || []).filter(function(el) {
        return el && el.classList && el.classList.contains('col-sm-6');
      });
      var allColsLower = lowerGrid ? Array.prototype.slice.call(lowerGrid.children || []).filter(function(el) {
        return el && el.classList && el.classList.contains('col-sm-6');
      }) : [];
      var allCols = allColsPrimary.concat(allColsMid).concat(allColsLower);
      var seen = new Set();
      var fragPrimary = document.createDocumentFragment();
      var fragMid = document.createDocumentFragment();
      var fragLower = document.createDocumentFragment();

      function chooseBucket(key, enabled) {
        if (!enabled) return 'lower';
        if (pinToLower(key)) return 'lower';
        if (topVisibleCount < topCap) {
          topVisibleCount += 1;
          return 'top';
        }
        if (midVisibleCount < midCap) {
          midVisibleCount += 1;
          return 'mid';
        }
        return 'lower';
      }

      if (list && list.length > 0) {
        list.forEach(function(item) {
          if (!item || typeof item !== 'object') return;
          var key = item.key != null ? String(item.key).trim().toLowerCase() : '';
          if (!key) return;
          var col = colByKey[key] || null;
          if (!col) return;
          var labelEl = col.querySelector ? col.querySelector('.subheader') : null;
          if (labelEl && item.label != null) {
            var lbl = String(item.label).trim();
            if (lbl) labelEl.textContent = lbl;
          }
          var enabled = item.enabled !== false;
          if (key === 'profit' && !runtimeProfitKpiAllowed) enabled = false;
          col.classList.toggle('is-user-disabled', !enabled);
          var bucket = chooseBucket(key, enabled);
          if (bucket === 'top') fragPrimary.appendChild(col);
          else if (bucket === 'mid') fragMid.appendChild(col);
          else fragLower.appendChild(col);
          seen.add(col);
        });
        allCols.forEach(function(col) {
          if (!col || seen.has(col)) return;
          var key = keyByCol && keyByCol.get ? (keyByCol.get(col) || '') : '';
          var enabled = !(key === 'profit' && !runtimeProfitKpiAllowed);
          col.classList.toggle('is-user-disabled', !enabled);
          var bucket = chooseBucket(key, enabled);
          if (bucket === 'top') fragPrimary.appendChild(col);
          else if (bucket === 'mid') fragMid.appendChild(col);
          else fragLower.appendChild(col);
        });
      } else {
        defaultKpiOrder.forEach(function(key) {
          var col = colByKey[key];
          if (!col || seen.has(col)) return;
          var enabled = !(key === 'profit' && !runtimeProfitKpiAllowed);
          col.classList.toggle('is-user-disabled', !enabled);
          var bucket = chooseBucket(key, enabled);
          if (bucket === 'top') fragPrimary.appendChild(col);
          else if (bucket === 'mid') fragMid.appendChild(col);
          else fragLower.appendChild(col);
          seen.add(col);
        });
        allCols.forEach(function(col) {
          if (!col || seen.has(col)) return;
          var key = keyByCol && keyByCol.get ? (keyByCol.get(col) || '') : '';
          var enabled = !(key === 'profit' && !runtimeProfitKpiAllowed);
          col.classList.toggle('is-user-disabled', !enabled);
          var bucket = chooseBucket(key, enabled);
          if (bucket === 'top') fragPrimary.appendChild(col);
          else if (bucket === 'mid') fragMid.appendChild(col);
          else fragLower.appendChild(col);
        });
      }
      grid.appendChild(fragPrimary);
      midGrid.appendChild(fragMid);
      lowerGrid.appendChild(fragLower);

      var showDelta = (cfg && cfg.options && cfg.options.dashboard && cfg.options.dashboard.showDelta === false) ? false : true;
      var deltaEls = Array.prototype.slice.call(grid.querySelectorAll('.dash-kpi-delta'));
      deltaEls = deltaEls.concat(Array.prototype.slice.call(midGrid.querySelectorAll('.dash-kpi-delta')));
      if (lowerGrid) deltaEls = deltaEls.concat(Array.prototype.slice.call(lowerGrid.querySelectorAll('.dash-kpi-delta')));
      deltaEls.forEach(function(el) {
        if (!el) return;
        el.style.display = showDelta ? '' : 'none';
      });
    }

    function isStandardDateRangeKey(key) {
      var k = key != null ? String(key).trim().toLowerCase() : '';
      return k === 'today' || k === 'yesterday' || k === '7days' || k === '14days' || k === '30days' || k === 'custom';
    }

    function ensureDateRangeAllowedByUiConfig() {
      var cfg = kpiUiConfigV1;
      if (!cfg || cfg.v !== 1 || !Array.isArray(cfg.dateRanges)) return;
      if (!isStandardDateRangeKey(dateRange)) return;
      if (dateRange === 'today' || dateRange === 'custom') return;
      var key = String(dateRange || '').trim().toLowerCase();
      var item = cfg.dateRanges.find(function(it) { return it && typeof it === 'object' && String(it.key || '').trim().toLowerCase() === key; }) || null;
      if (item && item.enabled === false) {
        dateRange = 'today';
        try { syncDateSelectOptions(); } catch (_) {}
        try { applyDateRangeChange(); } catch (_) {}
      }
    }

    function applyKpiUiConfigV1(cfg) {
      if (!cfg || typeof cfg !== 'object' || cfg.v !== 1) return;
      if (cfg.headerStrip && typeof cfg.headerStrip.pages === 'object') {
        cfg.headerStrip.pages.dashboard = true;
      } else if (cfg.headerStrip) {
        cfg.headerStrip.pages = cfg.headerStrip.pages || {};
        cfg.headerStrip.pages.dashboard = true;
      } else {
        cfg.headerStrip = { pages: { dashboard: true } };
      }
      kpiUiConfigV1 = cfg;
      try { window.__kexoKpiUiConfigV1 = cfg; } catch (_) {}
      try { safeWriteLocalStorageJson(KPI_UI_CFG_LS_KEY, cfg); } catch (_) {}
      try { applyHeaderKpiStripVisibilityByPage(cfg); } catch (_) {}
      try { applyCondensedKpiUiConfig(cfg); } catch (_) {}
      try { applyDashboardKpiUiConfig(cfg); } catch (_) {}
      if (!_dashboardKpiResizeWired) {
        _dashboardKpiResizeWired = true;
        try {
          window.addEventListener('resize', function () {
            if (_dashboardKpiResizeTimer) {
              try { clearTimeout(_dashboardKpiResizeTimer); } catch (_) {}
            }
            _dashboardKpiResizeTimer = setTimeout(function () {
              _dashboardKpiResizeTimer = 0;
              try {
                if (kpiUiConfigV1 && kpiUiConfigV1.v === 1) applyDashboardKpiUiConfig(kpiUiConfigV1);
              } catch (_) {}
            }, 120);
          });
        } catch (_) {}
      }
      try { syncDateSelectOptions(); } catch (_) {}
      try { ensureDateRangeAllowedByUiConfig(); } catch (_) {}
    }

    // Apply cached KPI settings immediately (before async /api/settings returns).
    try { if (kpiUiConfigV1) applyKpiUiConfigV1(kpiUiConfigV1); } catch (_) {}
    try { window.__applyDashboardKpiUiConfig = function() { applyDashboardKpiUiConfig(kpiUiConfigV1 || null); }; } catch (_) {}

    function ensureUiSettingsLoaded(options) {
      options = options && typeof options === 'object' ? options : {};
      var force = !!options.force;
      var ttlMs = 5 * 60 * 1000;
      if (!force && uiSettingsCache && uiSettingsFetchedAt && (Date.now() - uiSettingsFetchedAt) < ttlMs) {
        if (options.apply && uiSettingsCache.kpiUiConfig) applyKpiUiConfigV1(uiSettingsCache.kpiUiConfig);
        if (options.apply && uiSettingsCache.chartsUiConfig) {
          var changedFromCache = applyChartsUiConfigV1(uiSettingsCache.chartsUiConfig);
          if (changedFromCache) scheduleChartsUiReRender();
        }
        if (options.apply && uiSettingsCache.overviewWidgetsUiConfig) {
          try { applyOverviewWidgetsUiConfigV1(uiSettingsCache.overviewWidgetsUiConfig); } catch (_) {}
        }
        if (options.apply && uiSettingsCache.cssVarOverridesV1) {
          try { applyCssVarOverridesV1(uiSettingsCache.cssVarOverridesV1); } catch (_) {}
        }
        if (options.apply && uiSettingsCache.tablesUiConfig) {
          try { applyTablesUiConfigV1(uiSettingsCache.tablesUiConfig); } catch (_) {}
          try { scheduleTablesUiApply(); } catch (_) {}
        }
        if (options.apply && uiSettingsCache.pageLoaderEnabled) {
          try { applyPageLoaderEnabledV1(uiSettingsCache.pageLoaderEnabled); } catch (_) {}
        }
        if (options.apply && uiSettingsCache.assetOverrides) {
          var cachedUrl = (uiSettingsCache.assetOverrides.saleSound || uiSettingsCache.assetOverrides.sale_sound || '').trim();
          try { window.__kexoSaleSoundOverrideUrl = cachedUrl || ''; } catch (_) {}
          if (typeof window.__kexoApplySaleSoundOverride === 'function') {
            try { window.__kexoApplySaleSoundOverride(cachedUrl ? cachedUrl : null); } catch (_) {}
          }
        }
        return Promise.resolve(uiSettingsCache);
      }
      if (uiSettingsInFlight) return uiSettingsInFlight;
      var url = API + '/api/settings' + (force ? ('?_=' + Date.now()) : '');
      uiSettingsInFlight = fetchWithTimeout(url, { credentials: 'same-origin', cache: 'no-store' }, 15000)
        .then(function(r) { return (r && r.ok) ? r.json() : null; })
        .then(function(data) {
          uiSettingsCache = (data && data.ok) ? data : null;
          uiSettingsFetchedAt = Date.now();
          if (options.apply && uiSettingsCache && uiSettingsCache.kpiUiConfig) applyKpiUiConfigV1(uiSettingsCache.kpiUiConfig);
          if (options.apply && uiSettingsCache && uiSettingsCache.chartsUiConfig) {
            var changedFromFetch = applyChartsUiConfigV1(uiSettingsCache.chartsUiConfig);
            if (changedFromFetch) scheduleChartsUiReRender();
          }
          if (options.apply && uiSettingsCache && uiSettingsCache.overviewWidgetsUiConfig) {
            try { applyOverviewWidgetsUiConfigV1(uiSettingsCache.overviewWidgetsUiConfig); } catch (_) {}
          }
          if (options.apply && uiSettingsCache && uiSettingsCache.cssVarOverridesV1) {
            try { applyCssVarOverridesV1(uiSettingsCache.cssVarOverridesV1); } catch (_) {}
          }
          if (options.apply && uiSettingsCache && uiSettingsCache.tablesUiConfig) {
            try { applyTablesUiConfigV1(uiSettingsCache.tablesUiConfig); } catch (_) {}
            try { scheduleTablesUiApply(); } catch (_) {}
          }
          if (options.apply && uiSettingsCache && uiSettingsCache.pageLoaderEnabled) {
            try { applyPageLoaderEnabledV1(uiSettingsCache.pageLoaderEnabled); } catch (_) {}
          }
          if (options.apply && uiSettingsCache && uiSettingsCache.assetOverrides) {
            var url = (uiSettingsCache.assetOverrides.saleSound || uiSettingsCache.assetOverrides.sale_sound || '').trim();
            try { window.__kexoSaleSoundOverrideUrl = url || ''; } catch (_) {}
            if (typeof window.__kexoApplySaleSoundOverride === 'function') {
              try { window.__kexoApplySaleSoundOverride(url ? url : null); } catch (_) {}
            }
          }
          return uiSettingsCache;
        })
        .catch(function() { return null; })
        .finally(function() { uiSettingsInFlight = null; });
      return uiSettingsInFlight;
    }

    try {
      window.addEventListener('kexo:kpiUiConfigUpdated', function(e) {
        var cfg = e && e.detail ? e.detail : null;
        try { applyKpiUiConfigV1(cfg); } catch (_) {}
      });
    } catch (_) {}

    try {
      window.addEventListener('kexo:chartsUiConfigUpdated', function(e) {
        var cfg = e && e.detail ? e.detail : null;
        try {
          var changed = applyChartsUiConfigV1(cfg);
          if (changed) scheduleChartsUiReRender();
        } catch (_) {}
      });
    } catch (_) {}

    try {
      window.addEventListener('kexo:tablesUiConfigUpdated', function(e) {
        var cfg = e && e.detail ? e.detail : null;
        try {
          applyTablesUiConfigV1(cfg);
          scheduleTablesUiApply();
        } catch (_) {}
      });
    } catch (_) {}

    let kpiExpandedExtrasCache = null;
    let kpiExpandedExtrasRange = null;
    let kpiExpandedExtrasFetchedAt = 0;
    let kpiExpandedExtrasInFlight = null;

    function renderExpandedKpiExtras(extras) {
      const condItemsEl = document.getElementById('cond-kpi-items-sold');
      const condFulfilledEl = document.getElementById('cond-kpi-orders-fulfilled');
      const condReturnsEl = document.getElementById('cond-kpi-returns');
      const condCogsEl = document.getElementById('cond-kpi-cogs');
      if (!condItemsEl && !condFulfilledEl && !condReturnsEl && !condCogsEl) return;

      const itemsSold = extras && typeof extras.itemsSold === 'number' ? extras.itemsSold : null;
      const ordersFulfilled = extras && typeof extras.ordersFulfilled === 'number' ? extras.ordersFulfilled : null;
      const returnsAmount = extras && typeof extras.returns === 'number' ? extras.returns : null;
      const cogsAmount = extras && typeof extras.cogs === 'number' ? extras.cogs : null;
      const compare = extras && extras.compare ? extras.compare : null;
      const itemsSoldCompare = compare && typeof compare.itemsSold === 'number' ? compare.itemsSold : null;
      const ordersFulfilledCompare = compare && typeof compare.ordersFulfilled === 'number' ? compare.ordersFulfilled : null;
      const returnsCompare = compare && typeof compare.returns === 'number' ? compare.returns : null;
      const cogsCompare = compare && typeof compare.cogs === 'number' ? compare.cogs : null;

      function formatReturns(v) {
        return formatNegativeCurrencyOrZero(v, false);
      }
      if (condItemsEl) condItemsEl.textContent = itemsSold != null ? formatSessions(itemsSold) : '\u2014';
      if (condFulfilledEl) condFulfilledEl.textContent = ordersFulfilled != null ? formatSessions(ordersFulfilled) : '\u2014';
      if (condReturnsEl) condReturnsEl.textContent = returnsAmount != null ? formatReturns(returnsAmount) : '\u2014';
      if (condCogsEl) condCogsEl.textContent = cogsAmount != null ? formatRevenue(cogsAmount) : '\u2014';
      applyCondensedKpiDelta('items-sold', itemsSold, itemsSoldCompare, false);
      applyCondensedKpiDelta('orders-fulfilled', ordersFulfilled, ordersFulfilledCompare, false);
      applyCondensedKpiDelta('returns', returnsAmount, returnsCompare, true);
      applyCondensedKpiDelta('cogs', cogsAmount, cogsCompare, true);

      function setTone(id, current, baseline, invert) {
        const sparkEl = document.getElementById(id);
        if (!sparkEl) return;
        const cur = (typeof current === 'number' && Number.isFinite(current)) ? current : null;
        const base = (typeof baseline === 'number' && Number.isFinite(baseline)) ? baseline : null;
        if (cur == null || base == null) {
          sparkEl.removeAttribute('data-tone');
          return;
        }
        const delta = invert ? (base - cur) : (cur - base);
        if (Math.abs(delta) < 1e-9) {
          sparkEl.removeAttribute('data-tone');
          return;
        }
        const denom = Math.abs(base);
        if (denom > 1e-9) {
          const ratio = delta / denom;
          if (Math.abs(ratio) <= KPI_STABLE_RATIO) {
            sparkEl.removeAttribute('data-tone');
            return;
          }
        }
        sparkEl.setAttribute('data-tone', delta < 0 ? 'down' : 'up');
      }
      setTone('cond-kpi-items-sold-sparkline', itemsSold, itemsSoldCompare, false);
      setTone('cond-kpi-orders-fulfilled-sparkline', ordersFulfilled, ordersFulfilledCompare, false);
      setTone('cond-kpi-returns-sparkline', returnsAmount, returnsCompare, true);
      setTone('cond-kpi-cogs-sparkline', cogsAmount, cogsCompare, true);

      if (!condensedSparklineOverrides || typeof condensedSparklineOverrides !== 'object') condensedSparklineOverrides = {};
      condensedSparklineOverrides['cond-kpi-orders-fulfilled-sparkline'] = (ordersFulfilled != null && ordersFulfilledCompare != null) ? [ordersFulfilledCompare, ordersFulfilled] : null;
      condensedSparklineOverrides['cond-kpi-returns-sparkline'] = (returnsAmount != null && returnsCompare != null) ? [returnsCompare, returnsAmount] : null;
      condensedSparklineOverrides['cond-kpi-cogs-sparkline'] = (cogsAmount != null && cogsCompare != null) ? [cogsCompare, cogsAmount] : null;

      try { renderCondensedSparklines(condensedSeriesCache || sparklineHistorySeriesCache || []); } catch (_) {}

      try { updateCondensedKpiOverflow(); } catch (_) {}
    }

    function fetchExpandedKpiExtras(options = {}) {
      const force = !!options.force;
      const rangeKey = getStatsRange();
      if (!rangeKey) return Promise.resolve(null);
      // Paint from localStorage first to avoid empty KPI boxes on fast navigation.
      if (!force) {
        try {
          const wantHydrate =
            (!kpiExpandedExtrasCache || kpiExpandedExtrasRange !== rangeKey) ||
            (!kpiExpandedExtrasFetchedAt || (Date.now() - kpiExpandedExtrasFetchedAt) > KPI_EXTRAS_CACHE_TTL_MS);
          if (wantHydrate) hydrateExpandedExtrasFromLocalStorage(rangeKey, true);
        } catch (_) {}
      }

      const stale = !kpiExpandedExtrasFetchedAt || (Date.now() - kpiExpandedExtrasFetchedAt) > KPI_EXTRAS_CACHE_TTL_MS;
      if (!force && !stale && kpiExpandedExtrasCache && kpiExpandedExtrasRange === rangeKey) {
        return Promise.resolve(kpiExpandedExtrasCache);
      }
      if (kpiExpandedExtrasInFlight && !force && kpiExpandedExtrasRange === rangeKey) return kpiExpandedExtrasInFlight;
      let url = API + '/api/kpis-expanded-extra?range=' + encodeURIComponent(rangeKey);
      try {
        const shop = getShopForSales();
        if (shop) url += '&shop=' + encodeURIComponent(shop);
      } catch (_) {}
      if (force) url += (url.indexOf('?') >= 0 ? '&' : '?') + '_=' + Date.now();
      const cacheMode = force ? 'no-store' : 'default';
      kpiExpandedExtrasRange = rangeKey;
      // Extras KPIs can be expensive (Shopify updated-orders scan); allow longer to avoid aborting on cold cache.
      kpiExpandedExtrasInFlight = fetchWithTimeout(url, { credentials: 'same-origin', cache: cacheMode }, 60000)
        .then(function(r) { return (r && r.ok) ? r.json() : null; })
        .then(function(extras) {
          kpiExpandedExtrasCache = extras || null;
          kpiExpandedExtrasFetchedAt = Date.now();
          try { setRangeCacheEntry(KPI_EXTRAS_CACHE_LS_KEY, rangeKey, kpiExpandedExtrasCache, 12); } catch (_) {}
          // Dashboard KPI cards use extras spark series for COGS/Fulfilled/Returns.
          // Once extras arrive, silently re-render the cached dashboard so sparklines appear without a refetch.
          try {
            if (PAGE === 'dashboard' && dashCache && typeof window.refreshDashboard === 'function') {
              window.refreshDashboard({ force: false, silent: true });
            }
          } catch (_) {}
          return kpiExpandedExtrasCache;
        })
        .catch(function() { return null; })
        .finally(function() { kpiExpandedExtrasInFlight = null; });
      return kpiExpandedExtrasInFlight;
    }

    (function initCondensedKpisUi() {
      try { window.addEventListener('resize', function() { scheduleCondensedKpiOverflowUpdate(); }); } catch (_) {}
      try { window.addEventListener('orientationchange', function() { scheduleCondensedKpiOverflowUpdate(); }); } catch (_) {}
      try {
        const strip = document.getElementById('kexo-condensed-kpis');
        if (strip && typeof ResizeObserver !== 'undefined') {
          _condensedStripResizeObserver = new ResizeObserver(function() { scheduleCondensedKpiOverflowUpdate(); });
          _condensedStripResizeObserver.observe(strip);
        }
      } catch (_) {}
      scheduleCondensedKpiOverflowUpdate();
    })();

    function delay(ms) {
      const n = Number(ms) || 0;
      if (n <= 0) return Promise.resolve();
      return new Promise(function(resolve) { setTimeout(resolve, n); });
    }

    function fetchWithTimeout(url, options, timeoutMs) {
      const ms = Number(timeoutMs) || 0;
      const timeout = ms > 0 ? ms : 25000;
      if (typeof AbortController === 'undefined') {
        return Promise.race([
          fetch(url, options),
          new Promise(function(_, reject) {
            setTimeout(function() { reject(new Error('Request timed out')); }, timeout);
          }),
        ]);
      }
      const controller = new AbortController();
      const timer = setTimeout(function() { try { controller.abort(); } catch (_) {} }, timeout);
      const opts = Object.assign({}, options || {}, { signal: controller.signal });
      return fetch(url, opts).finally(function() { clearTimeout(timer); });
    }

    function defaultReportBuildTitleForKey(key) {
      const k = key != null ? String(key).trim().toLowerCase() : '';
      if (k === 'stats') return 'Preparing country report';
      if (k === 'products') return 'Preparing product report';
      if (k === 'dashboard') return 'Preparing dashboard overview';
      if (k === 'attribution') return 'Preparing attribution report';
      if (k === 'devices') return 'Preparing devices report';
      if (k === 'sessions') return 'Preparing sessions table';
      if (k === 'diagnostics') return 'Preparing diagnostics';
      if (k === 'kpicompare') return 'Preparing KPI comparison';
      return 'Preparing data';
    }

    function ensureReportBuildMarkup(overlay, titleText, stepId) {
      if (!overlay) return { titleEl: null, stepEl: null };
      let wrap = overlay.querySelector('.report-build-wrap');
      if (!wrap) {
        overlay.innerHTML = '' +
          '<div class="container container-slim py-4 report-build-wrap">' +
            '<div class="text-center">' +
              '<div class="text-secondary mb-2 report-build-title">Preparing application</div>' +
              '<div class="text-secondary mb-3 report-build-step">Preparing application</div>' +
              '<div class="progress progress-sm page-loader-progress"><div class="progress-bar progress-bar-indeterminate"></div></div>' +
            '</div>' +
          '</div>';
        wrap = overlay.querySelector('.report-build-wrap');
      }
      try {
        wrap.querySelectorAll('.spinner-border, .report-build-spinner, .ads-loader-spinner').forEach(function(node) {
          if (node && node.parentNode) node.parentNode.removeChild(node);
        });
      } catch (_) {}
      let titleEl = wrap.querySelector('.report-build-title');
      if (!titleEl) {
        titleEl = document.createElement('div');
        titleEl.className = 'text-secondary mb-2 report-build-title';
        wrap.appendChild(titleEl);
      }
      if (titleText != null) titleEl.textContent = String(titleText);
      let stepEl = null;
      const sid = stepId ? String(stepId) : '';
      if (sid) {
        stepEl = document.getElementById(sid);
        if (!stepEl) {
          stepEl = document.createElement('div');
          stepEl.id = sid;
          stepEl.className = 'report-build-step';
          wrap.appendChild(stepEl);
        }
      } else {
        stepEl = wrap.querySelector('.report-build-step');
        if (!stepEl) {
          stepEl = document.createElement('div');
          stepEl.className = 'text-secondary small mb-3 report-build-step';
          wrap.appendChild(stepEl);
        }
      }
      let progressEl = wrap.querySelector('.page-loader-progress');
      if (!progressEl) {
        progressEl = document.createElement('div');
        progressEl.className = 'progress progress-sm page-loader-progress';
        progressEl.innerHTML = '<div class="progress-bar progress-bar-indeterminate"></div>';
        wrap.appendChild(progressEl);
      }
      try { overlay.setAttribute('aria-live', 'polite'); } catch (_) {}
      return { titleEl: titleEl, stepEl: stepEl };
    }

    function resolveReportBuildOverlay(opts, key) {
      const sharedOverlay = document.getElementById('page-body-loader');
      if (sharedOverlay) return { overlayId: 'page-body-loader', overlayEl: sharedOverlay };
      const explicitId = opts.overlayId ? String(opts.overlayId) : '';
      if (explicitId) {
        const explicitEl = document.getElementById(explicitId);
        if (explicitEl) return { overlayId: explicitId, overlayEl: explicitEl };
      }
      const keyed = document.querySelector('[data-loader-key="' + key + '"]');
      if (keyed && keyed.id) return { overlayId: keyed.id, overlayEl: keyed };
      return { overlayId: explicitId || '', overlayEl: explicitId ? document.getElementById(explicitId) : null };
    }

    function resolveReportBuildScope(opts, overlay) {
      const pageBody = document.querySelector('.page-body');
      if (pageBody) return pageBody;
      if (opts && opts.scopeEl && opts.scopeEl instanceof Element) return opts.scopeEl;
      const scopeId = opts && opts.scopeId ? String(opts.scopeId) : '';
      if (scopeId) {
        const byId = document.getElementById(scopeId);
        if (byId) return byId;
      }
      if (overlay && overlay.closest) {
        const panel = overlay.closest('.main-tab-panel');
        if (panel) return panel;
      }
      return overlay ? (overlay.parentElement || null) : null;
    }

    const reportBuildScopeState = typeof WeakMap !== 'undefined' ? new WeakMap() : null;
    let reportBuildGlobalActive = 0;
    function beginGlobalReportLoading() {
      reportBuildGlobalActive = Math.max(0, reportBuildGlobalActive) + 1;
      if (reportBuildGlobalActive === 1) {
        try { document.body.classList.add('kexo-report-loading'); } catch (_) {}
      }
    }
    function endGlobalReportLoading() {
      reportBuildGlobalActive = Math.max(0, reportBuildGlobalActive - 1);
      if (reportBuildGlobalActive <= 0) {
        reportBuildGlobalActive = 0;
        try { document.body.classList.remove('kexo-report-loading'); } catch (_) {}
      }
    }
    try {
      window.__kexoBeginGlobalReportLoading = beginGlobalReportLoading;
      window.__kexoEndGlobalReportLoading = endGlobalReportLoading;
    } catch (_) {}
    function beginReportBuildScope(scope) {
      if (!scope) return;
      if (!reportBuildScopeState) {
        scope.classList.add('report-building');
        return;
      }
      let state = reportBuildScopeState.get(scope);
      if (!state) state = { count: 0, prevMinHeight: '' };
      if (state.count <= 0) {
        state.prevMinHeight = scope.style.minHeight || '';
        if (scope.classList && scope.classList.contains('page-body')) {
          syncPageBodyLoaderOffset(scope);
          var topPx = scope.style.getPropertyValue('--kexo-loader-page-top') || '0px';
          scope.style.minHeight = 'calc(100vh - ' + topPx + ')';
        } else {
          const h = Number(scope.offsetHeight || 0);
          if (h > 0) scope.style.minHeight = String(Math.ceil(h)) + 'px';
        }
        scope.classList.add('report-building');
      }
      state.count += 1;
      reportBuildScopeState.set(scope, state);
      beginGlobalReportLoading();
    }

    function endReportBuildScope(scope) {
      if (!scope) return;
      if (!reportBuildScopeState) {
        scope.classList.remove('report-building');
        return;
      }
      let state = reportBuildScopeState.get(scope);
      if (!state) return;
      state.count = Math.max(0, Number(state.count || 0) - 1);
      if (state.count <= 0) {
        scope.classList.remove('report-building');
        scope.style.minHeight = state.prevMinHeight || '';
        reportBuildScopeState.delete(scope);
        endGlobalReportLoading();
        return;
      }
      reportBuildScopeState.set(scope, state);
      endGlobalReportLoading();
    }

    function startReportBuild(opts) {
      opts = opts && typeof opts === 'object' ? opts : {};
      const key = opts.key ? String(opts.key) : '';
      if (!key || !reportBuildTokens || typeof reportBuildTokens[key] !== 'number') {
        return { step: function() {}, title: function() {}, finish: function() {} };
      }

      // Default: keep the page visible (top progress bar + header spinner only).
      // Only show the full overlay when explicitly requested.
      // Also respect per-page loader enable (Admin ??? Controls). Admin is always disabled.
      var allowOverlay = true;
      try { allowOverlay = isPageLoaderEnabled(PAGE); } catch (_) { allowOverlay = true; }
      try { if (kexoSilentOverlayActive && typeof kexoSilentOverlayActive === 'function' && kexoSilentOverlayActive()) allowOverlay = false; } catch (_) {}
      var showOverlay = opts.showOverlay === true && allowOverlay;
      if (!showOverlay) {
        reportBuildTokens[key] = (reportBuildTokens[key] || 0) + 1;
        const token = reportBuildTokens[key];
        beginGlobalReportLoading();
        showPageProgress();
        var finished = false;
        return {
          step: function() {},
          title: function() {},
          finish: function() {
            if (reportBuildTokens[key] !== token) return;
            if (finished) return;
            finished = true;
            endGlobalReportLoading();
            try { window.dispatchEvent(new CustomEvent('kexo:table-rows-changed')); } catch (_) {}
            hidePageProgress();
          }
        };
      }

      reportBuildTokens[key] = (reportBuildTokens[key] || 0) + 1;
      const token = reportBuildTokens[key];
      const resolved = resolveReportBuildOverlay(opts, key);
      const overlay = resolved && resolved.overlayEl ? resolved.overlayEl : null;
      const scope = resolveReportBuildScope(opts, overlay);
      let overlayOrigin = null;
      if (overlay && scope && overlay.parentElement && overlay.parentElement !== scope && scope.contains(overlay)) {
        overlayOrigin = { parent: overlay.parentElement, next: overlay.nextSibling };
        try { scope.insertBefore(overlay, scope.firstChild); } catch (_) {}
      }
      const stepId = overlay && overlay.getAttribute('data-step-id') ? String(overlay.getAttribute('data-step-id')) : '';
      const titleText = opts.title != null ? String(opts.title) : defaultReportBuildTitleForKey(key);
      const ensured = ensureReportBuildMarkup(overlay, titleText, stepId);
      const titleEl = ensured.titleEl;
      const stepEl = ensured.stepEl;

      beginReportBuildScope(scope);
      if (key === 'sessions' && scope) try { scope.classList.add('report-building-sessions'); } catch (_) {}
      if (overlay) overlay.classList.remove('is-hidden');
      if (stepEl) {
        if (opts.initialStep != null) stepEl.textContent = String(opts.initialStep);
        else if (!String(stepEl.textContent || '').trim()) stepEl.textContent = 'Preparing application';
      }
      showPageProgress();

      function title(text) {
        if (reportBuildTokens[key] !== token) return;
        if (!titleEl) return;
        titleEl.textContent = text != null ? String(text) : '';
      }

      function step(text, nextTitle) {
        if (reportBuildTokens[key] !== token) return;
        if (typeof nextTitle === 'string') title(nextTitle);
        if (!stepEl) return;
        stepEl.textContent = text != null ? String(text) : '';
      }

      function finish() {
        if (reportBuildTokens[key] !== token) return;
        if (key === 'sessions' && scope) try { scope.classList.remove('report-building-sessions'); } catch (_) {}
        if (overlay) overlay.classList.add('is-hidden');
        if (overlay && overlayOrigin && overlayOrigin.parent) {
          try {
            if (overlayOrigin.next && overlayOrigin.next.parentNode === overlayOrigin.parent) overlayOrigin.parent.insertBefore(overlay, overlayOrigin.next);
            else overlayOrigin.parent.appendChild(overlay);
          } catch (_) {}
        }
        endReportBuildScope(scope);
        try { window.dispatchEvent(new CustomEvent('kexo:table-rows-changed')); } catch (_) {}
        hidePageProgress();
      }

      return { step: step, title: title, finish: finish };
    }

    function fetchStatsData(options = {}) {
      const force = !!options.force;
      let url = API + '/api/stats?range=' + encodeURIComponent(getStatsRange());
      if (force) url += (url.indexOf('?') >= 0 ? '&' : '?') + '_=' + Date.now();
      const cacheMode = force ? 'no-store' : 'default';
      return fetchWithTimeout(url, { credentials: 'same-origin', cache: cacheMode }, 30000)
        .then(function(r) {
          if (!r.ok) throw new Error('Stats HTTP ' + r.status);
          return r.json();
        })
        .then(function(data) {
          lastStatsFetchedAt = Date.now();
          lastUpdateTime = new Date();
          updateServerTimeDisplay();
          renderStats(data && typeof data.country === 'object' ? data : {});
          return data;
        })
        .catch(function(err) {
          try { if (typeof window.kexoCaptureError === 'function') window.kexoCaptureError(err, { context: 'reportBuildStats', page: PAGE }); } catch (_) {}
          console.error(err);
          renderStats(statsCache || {});
          return null;
        });
    }

    // ?????? KPI local cache (prevents empty KPI boxes during fast navigation) ??????
    function safeReadLocalStorageJson(key) {
      try {
        const raw = localStorage.getItem(key);
        if (!raw) return null;
        return JSON.parse(raw);
      } catch (_) {
        return null;
      }
    }

    function safeWriteLocalStorageJson(key, value) {
      try {
        localStorage.setItem(key, JSON.stringify(value));
      } catch (_) {}
    }

    function getRangeCacheEntry(lsKey, rangeKey) {
      if (!lsKey || !rangeKey) return null;
      const root = safeReadLocalStorageJson(lsKey);
      const byRange = root && typeof root === 'object' && root.byRange && typeof root.byRange === 'object' ? root.byRange : null;
      if (!byRange) return null;
      const entry = byRange[rangeKey];
      if (!entry || typeof entry !== 'object') return null;
      const at = entry.at != null ? Number(entry.at) : NaN;
      if (!Number.isFinite(at) || at <= 0) return null;
      return { at, data: entry.data };
    }

    function setRangeCacheEntry(lsKey, rangeKey, data, maxEntries) {
      if (!lsKey || !rangeKey) return;
      let root = safeReadLocalStorageJson(lsKey);
      if (!root || typeof root !== 'object') root = { v: 1, byRange: {} };
      if (!root.byRange || typeof root.byRange !== 'object') root.byRange = {};
      root.byRange[rangeKey] = { at: Date.now(), data: data == null ? null : data };

      const cap = (typeof maxEntries === 'number' && Number.isFinite(maxEntries) && maxEntries > 0) ? Math.trunc(maxEntries) : 12;
      try {
        const keys = Object.keys(root.byRange);
        if (keys.length > cap) {
          keys.sort(function(a, b) {
            const ta = root.byRange[a] && root.byRange[a].at != null ? Number(root.byRange[a].at) : 0;
            const tb = root.byRange[b] && root.byRange[b].at != null ? Number(root.byRange[b].at) : 0;
            return ta - tb;
          });
          while (keys.length > cap) {
            const k = keys.shift();
            if (k) delete root.byRange[k];
          }
        }
      } catch (_) {}

      safeWriteLocalStorageJson(lsKey, root);
    }

    function hydrateKpisFromLocalStorage(rangeKey, allowStale) {
      const entry = getRangeCacheEntry(KPI_CACHE_LS_KEY, rangeKey);
      if (!entry) return false;
      const age = Date.now() - entry.at;
      if (!Number.isFinite(age) || age < 0) return false;
      const maxAge = allowStale ? KPI_CACHE_STALE_OK_MS : KPI_CACHE_TTL_MS;
      if (age > maxAge) return false;
      if (!entry.data || typeof entry.data !== 'object') return false;
      if (lastKpisFetchedAt && entry.at <= lastKpisFetchedAt) return false;
      kpiCache = entry.data;
      kpiCacheRange = rangeKey;
      kpiCacheSource = 'kpis';
      lastKpisFetchedAt = entry.at;
      // If we can paint real numbers immediately, don't flash KPI spinners.
      kpisSpinnerShownOnce = true;
      return true;
    }

    function hydrateExpandedExtrasFromLocalStorage(rangeKey, allowStale) {
      const entry = getRangeCacheEntry(KPI_EXTRAS_CACHE_LS_KEY, rangeKey);
      if (!entry) return false;
      const age = Date.now() - entry.at;
      if (!Number.isFinite(age) || age < 0) return false;
      const maxAge = allowStale ? KPI_EXTRAS_CACHE_STALE_OK_MS : KPI_EXTRAS_CACHE_TTL_MS;
      if (age > maxAge) return false;
      kpiExpandedExtrasCache = entry.data || null;
      kpiExpandedExtrasRange = rangeKey;
      kpiExpandedExtrasFetchedAt = entry.at;
      return true;
    }

    function clearKpiLocalStorageCaches() {
      try { localStorage.removeItem(KPI_CACHE_LS_KEY); } catch (_) {}
      try { localStorage.removeItem(KPI_EXTRAS_CACHE_LS_KEY); } catch (_) {}
      try { kpiCacheRange = ''; } catch (_) {}
      try { kpiCacheSource = ''; } catch (_) {}
    }

    function fetchKpisData(options = {}) {
      const force = !!options.force;
      let url = API + '/api/kpis?range=' + encodeURIComponent(getStatsRange());
      if (force) url += (url.indexOf('?') >= 0 ? '&' : '?') + 'force=1';
      return fetchWithTimeout(url, { credentials: 'same-origin', cache: 'no-store' }, 25000)
        .then(function(r) {
          if (!r.ok) throw new Error('KPIs HTTP ' + r.status);
          return r.json();
        });
    }

    function refreshKpiExtrasSoft() {
      // Condensed strip includes these KPIs; keep them warm in the background.
      const hasExtrasEls = !!document.getElementById('cond-kpi-items-sold');
      if (!hasExtrasEls) return;
      fetchExpandedKpiExtras({ force: false })
        .then(function(extras) { try { renderExpandedKpiExtras(extras); } catch (_) {} })
        .catch(function() {});
    }

    function refreshKpis(options = {}) {
      const force = !!options.force;
      const rangeKey = getStatsRange();
      if (!rangeKey) return Promise.resolve(null);

      // Hydrate from localStorage so KPI boxes render instantly on fast nav.
      if (!force) {
        try { hydrateKpisFromLocalStorage(rangeKey, true); } catch (_) {}
      }

      const cacheMatchesRange = !!(kpiCache && kpiCacheRange === rangeKey);
      const stale = !cacheMatchesRange || !lastKpisFetchedAt || (Date.now() - lastKpisFetchedAt) > KPI_CACHE_TTL_MS;
      const trustedKpiCache = cacheMatchesRange && kpiCacheSource !== 'stats';

      // If cache is still fresh, avoid refetching.
      if (!force && !stale && trustedKpiCache) {
        try { renderLiveKpis(getKpiData()); } catch (_) {}
        try { if (typeof renderDashboardKpisFromApi === 'function') renderDashboardKpisFromApi(getKpiData()); } catch (_) {}
        try { if (PAGE === 'dashboard' && typeof window.refreshDashboard === 'function') window.refreshDashboard({ force: false }); } catch (_) {}
        try { refreshKpiExtrasSoft(); } catch (_) {}
        try { fetchCondensedSeries(); } catch (_) {}
        return Promise.resolve(kpiCache);
      }

      if (kpisRefreshInFlight && kpisRefreshRangeKey === rangeKey) return kpisRefreshInFlight;

      // Stale-while-revalidate: keep showing last known values while we refresh.
      try {
        if (cacheMatchesRange) {
          renderLiveKpis(getKpiData());
          if (typeof renderDashboardKpisFromApi === 'function') renderDashboardKpisFromApi(getKpiData());
          try { if (PAGE === 'dashboard' && typeof window.refreshDashboard === 'function') window.refreshDashboard({ force: false }); } catch (_) {}
          fetchCondensedSeries();
        }
      } catch (_) {}

      // Only show the KPI mini spinners on the very first load (avoid visual noise on refreshes).
      const showSpinner = !kpisSpinnerShownOnce && !cacheMatchesRange;
      if (showSpinner) {
        kpisSpinnerShownOnce = true;
        setLiveKpisLoading();
      }

      const fetchP = fetchKpisData({ force });
      kpisRefreshRangeKey = rangeKey;
      kpisRefreshInFlight = (showSpinner ? Promise.all([fetchP, delay(KPI_SPINNER_MIN_MS)]) : fetchP)
        .then(function(partsOrData) {
          const data = showSpinner
            ? (partsOrData && partsOrData[0] && typeof partsOrData[0] === 'object' ? partsOrData[0] : null)
            : (partsOrData && typeof partsOrData === 'object' ? partsOrData : null);
          if (data) {
            lastKpisFetchedAt = Date.now();
            kpiCache = data;
            kpiCacheRange = rangeKey;
            kpiCacheSource = 'kpis';
            maybeTriggerSaleToastFromStatsLikeData(kpiCache);
            try { setRangeCacheEntry(KPI_CACHE_LS_KEY, rangeKey, kpiCache, 12); } catch (_) {}
          }
          renderLiveKpis(getKpiData());
          try { if (typeof renderDashboardKpisFromApi === 'function') renderDashboardKpisFromApi(getKpiData()); } catch (_) {}
          try { if (PAGE === 'dashboard' && typeof window.refreshDashboard === 'function') window.refreshDashboard({ force: false }); } catch (_) {}
          try { refreshKpiExtrasSoft(); } catch (_) {}
          try { fetchCondensedSeries(); } catch (_) {}
          return data;
        })
        .catch(function(err) {
          try { if (typeof window.kexoCaptureError === 'function') window.kexoCaptureError(err, { context: 'reportBuildKpis', page: PAGE }); } catch (_) {}
          console.error(err);
          renderLiveKpis(getKpiData());
          try { if (typeof renderDashboardKpisFromApi === 'function') renderDashboardKpisFromApi(getKpiData()); } catch (_) {}
          try { if (PAGE === 'dashboard' && typeof window.refreshDashboard === 'function') window.refreshDashboard({ force: false }); } catch (_) {}
          try { refreshKpiExtrasSoft(); } catch (_) {}
          return null;
        });
      var activeRequest = kpisRefreshInFlight;
      var wrappedRequest = activeRequest.finally(function() {
        if (kpisRefreshInFlight === wrappedRequest) {
          kpisRefreshInFlight = null;
          if (kpisRefreshRangeKey === rangeKey) kpisRefreshRangeKey = '';
        }
      });
      kpisRefreshInFlight = wrappedRequest;
      return wrappedRequest;
    }

    function refreshStats(options = {}) {
      const force = !!options.force;
      if (statsRefreshInFlight) return statsRefreshInFlight;

      const build = startReportBuild({
        key: 'stats',
        overlayId: 'stats-loading-overlay',
        stepId: 'stats-build-step',
        title: 'Preparing country report',
      });
      build.step('Loading country performance data');
      statsRefreshInFlight = fetchStatsData({ force })
        .then(function(data) {
          build.step('Analyzing average order value');
          return delay(180).then(function() {
            build.step('Building country table');
            return delay(120).then(function() {
              return delay(180).then(function() { return data; });
            });
          });
        })
        .finally(function() {
          statsRefreshInFlight = null;
          build.finish();
        });
      return statsRefreshInFlight;
    }

    function refreshProducts(options = {}) {
      const force = !!options.force;
      if (productsRefreshInFlight) return productsRefreshInFlight;
      var shop = getShopParam() || shopForSalesFallback || null;
      if (!shop) return Promise.resolve(null);

      const build = startReportBuild({
        key: 'products',
        overlayId: 'products-loading-overlay',
        stepId: 'products-build-step',
        title: 'Preparing product report',
      });
      let bestP = null;
      let variantsP = null;
      let leaderboardP = null;
      let variantCardsP = null;
      try { bestP = fetchBestSellers({ force }); } catch (err) { console.error(err); bestP = Promise.resolve(null); }
      try { variantsP = fetchBestVariants({ force }); } catch (err) { console.error(err); variantsP = Promise.resolve(null); }
      try { leaderboardP = fetchProductsLeaderboard({ force }); } catch (err) { console.error(err); leaderboardP = Promise.resolve(null); }
      try {
        variantCardsP = (normalizeProductsVariantCardsView(productsVariantCardsView) === 'lengths')
          ? fetchLengths({ force })
          : fetchFinishes({ force });
      } catch (err) {
        console.error(err);
        variantCardsP = Promise.resolve(null);
      }
      function settled(p) {
        return Promise.resolve(p)
          .then(function(v) { return { ok: true, value: v }; })
          .catch(function(err) { console.error(err); return { ok: false, error: err }; });
      }
      const bestS = settled(bestP);
      const variantsS = settled(variantsP);
      const leaderboardS = settled(leaderboardP);
      const variantCardsS = settled(variantCardsP);

      productsRefreshInFlight = Promise.resolve()
        .then(function() { build.step('Loading best-selling products'); return bestS; })
        .then(function() { return delay(180); })
        .then(function() { build.step('Loading top variants'); return variantsS; })
        .then(function() { return delay(180); })
        .then(function() { build.step('Analyzing product leaderboard'); return leaderboardS; })
        .then(function() { return delay(140); })
        .then(function() { build.step('Building product tables'); return variantCardsS; })
        .then(function() { return delay(140); })
        .then(function() { lastProductsFetchedAt = Date.now(); })
        .catch(function(err) {
          try { if (typeof window.kexoCaptureError === 'function') window.kexoCaptureError(err, { context: 'trafficSourceMapsFetch', page: PAGE }); } catch (_) {}
          console.error(err);
          return null;
        })
        .finally(function() {
          productsRefreshInFlight = null;
          build.finish();
        });
      return productsRefreshInFlight;
    }

    function renderAttributionTables(data) {
      const body = document.getElementById('attribution-body');
      if (!body) return;

      const by = (tableSortState.attribution.by || 'rev').toString().trim().toLowerCase();
      const dir = (tableSortState.attribution.dir || 'desc').toString().trim().toLowerCase() === 'asc' ? 'asc' : 'desc';

      const rows = data && data.attribution && Array.isArray(data.attribution.rows) ? data.attribution.rows.slice() : [];
      const filtered = rows.filter(function(r) {
        const s = r && typeof r.sessions === 'number' ? r.sessions : 0;
        const o = r && typeof r.orders === 'number' ? r.orders : 0;
        return s >= 1 || o >= 1;
      });

      function stripSvgSizing(svgMarkup) {
        var raw = svgMarkup != null ? String(svgMarkup) : '';
        if (!raw) return '';
        if (!/^<svg[\s>]/i.test(raw.trim())) return raw;
        // If the SVG has no viewBox, removing/overriding width/height can clip the artwork.
        // In that case, leave the original sizing attributes intact and rely on CSS max-size.
        try {
          var m = raw.trim().match(/^<svg\b([^>]*)>/i);
          var attrs = m && m[1] ? String(m[1]) : '';
          if (!/\sviewBox\s*=/i.test(attrs)) return raw;
        } catch (_) {}
        // Remove width/height attributes from the root <svg ...> tag so CSS can enforce sizing.
        raw = raw.replace(/^<svg\b([^>]*)>/i, function (_m, attrs) {
          var a = String(attrs || '');
          a = a.replace(/\s(width|height)\s*=\s*(?:"[^"]*"|'[^']*'|[^\s>]+)/gi, '');
          // Best-effort: remove width/height declarations from inline style (keep other styles).
          a = a.replace(/\sstyle\s*=\s*(["'])([\s\S]*?)\1/i, function (_m2, q, style) {
            var s = String(style || '');
            var cleaned = s
              .replace(/(^|;)\s*width\s*:\s*[^;]+/gi, '$1')
              .replace(/(^|;)\s*height\s*:\s*[^;]+/gi, '$1')
              .replace(/;;+/g, ';')
              .replace(/^\s*;\s*|\s*;\s*$/g, '')
              .trim();
            if (!cleaned) return '';
            return ' style=' + q + cleaned + q;
          });
          return '<svg' + a + '>';
        });
        return raw;
      }

      function iconSpecHtml(iconSpecRaw, labelRaw) {
        const spec = iconSpecRaw != null ? String(iconSpecRaw).trim() : '';
        const label = labelRaw != null ? String(labelRaw).trim() : '';
        const t = label ? (' title="' + escapeHtml(label) + '"') : '';
        if (!spec) return '';
        if (/^<svg[\s>]/i.test(spec)) {
          const svg = stripSvgSizing(spec);
          return '<span class="source-icons"' + t + ' aria-hidden="true">' + svg + '</span>';
        }
        if (/^(https?:\/\/|\/\/|\/)/i.test(spec)) {
          const src = hotImg(spec) || spec;
          return '<span class="source-icons"><img src="' + escapeHtml(src) + '" alt="' + escapeHtml(label) + '" class="source-icon-img" width="20" height="20"' + t + '></span>';
        }
        return '<span class="source-icons"><i class="' + escapeHtml(spec) + '"' + t + ' aria-hidden="true"></i></span>';
      }

      function channelLabel(r) {
        if (!r) return 'unknown';
        if (r.label != null && String(r.label).trim() !== '') return String(r.label);
        if (r.channel_key != null && String(r.channel_key).trim() !== '') return String(r.channel_key);
        return 'unknown';
      }
      function sourceLabel(r) {
        if (!r) return 'unknown';
        if (r.label != null && String(r.label).trim() !== '') return String(r.label);
        if (r.source_key != null && String(r.source_key).trim() !== '') return String(r.source_key);
        return 'unknown';
      }
      function variantLabel(r) {
        if (!r) return 'unknown';
        if (r.label != null && String(r.label).trim() !== '') return String(r.label);
        if (r.variant_key != null && String(r.variant_key).trim() !== '') return String(r.variant_key);
        return 'unknown';
      }

      function metric(r, key) {
        if (!r) return null;
        if (key === 'cr') return (typeof r.conversion_pct === 'number') ? r.conversion_pct : null;
        if (key === 'orders') return (typeof r.orders === 'number') ? r.orders : null;
        if (key === 'sessions') return (typeof r.sessions === 'number') ? r.sessions : null;
        if (key === 'rev') return (typeof r.revenue_gbp === 'number') ? r.revenue_gbp : null;
        if (key === 'vpv') {
          const rev = (typeof r.revenue_gbp === 'number') ? r.revenue_gbp : null;
          const sess = (typeof r.sessions === 'number') ? r.sessions : null;
          return (sess != null && sess > 0 && rev != null) ? (rev / sess) : null;
        }
        return null;
      }

      filtered.sort(function(a, b) {
        let primary = 0;
        if (by === 'attribution') primary = cmpNullableText(channelLabel(a), channelLabel(b), dir);
        else primary = cmpNullableNumber(metric(a, by), metric(b, by), dir);
        return primary ||
          cmpNullableNumber(metric(a, 'rev'), metric(b, 'rev'), 'desc') ||
          cmpNullableNumber(metric(a, 'orders'), metric(b, 'orders'), 'desc') ||
          cmpNullableNumber(metric(a, 'sessions'), metric(b, 'sessions'), 'desc') ||
          cmpNullableText(channelLabel(a), channelLabel(b), 'asc');
      });

      if (!filtered.length) {
        body.innerHTML = '<div class="grid-row" role="row"><div class="grid-cell empty span-all" role="cell">No attribution data yet.</div></div>';
        updateCardPagination('attribution', 1, 1);
        updateSortHeadersInContainer(document.getElementById('attribution-table'), by, dir);
        return;
      }

      const pageSize = getTableRowsPerPage('attribution-table', 'live');
      const totalPages = Math.max(1, Math.ceil(filtered.length / pageSize));
      attributionPage = clampPage(attributionPage, totalPages);
      updateCardPagination('attribution', attributionPage, totalPages);
      const pageStart = (attributionPage - 1) * pageSize;
      const pageChannels = filtered.slice(pageStart, pageStart + pageSize);

      function channelKey(r) {
        const k = r && r.channel_key != null ? String(r.channel_key).trim().toLowerCase() : '';
        return k || 'other';
      }
      function sourceKey(r) {
        const k = r && r.source_key != null ? String(r.source_key).trim().toLowerCase() : '';
        return k || 'other';
      }
      function variantKey(r) {
        const k = r && r.variant_key != null ? String(r.variant_key).trim().toLowerCase() : '';
        return k || 'other:house';
      }

      function isChannelOpen(key) {
        if (attributionExpandedChannels === null) return true;
        if (!attributionExpandedChannels || typeof attributionExpandedChannels !== 'object') return true;
        if (!Object.prototype.hasOwnProperty.call(attributionExpandedChannels, key)) return true;
        return !!attributionExpandedChannels[key];
      }
      function isSourceOpen(chKey, srcKey) {
        if (attributionExpandedSources === null) return true;
        if (!attributionExpandedSources || typeof attributionExpandedSources !== 'object') return true;
        const k = chKey + '|' + srcKey;
        if (!Object.prototype.hasOwnProperty.call(attributionExpandedSources, k)) return true;
        return !!attributionExpandedSources[k];
      }

      let html = '';
      pageChannels.forEach(function(ch) {
        const chKey = channelKey(ch);
        const chOpen = isChannelOpen(chKey);
        const chLabel = channelLabel(ch);
        const chCr = (ch && typeof ch.conversion_pct === 'number') ? pct(ch.conversion_pct) : '-';
        const chOrders = (ch && typeof ch.orders === 'number') ? formatSessions(ch.orders) : '-';
        const chSessions = (ch && typeof ch.sessions === 'number') ? formatSessions(ch.sessions) : '-';
        const chRev = (ch && typeof ch.revenue_gbp === 'number') ? formatRevenueTableHtml(ch.revenue_gbp) : '-';
        const chVpv = metric(ch, 'vpv') != null ? formatRevenue(metric(ch, 'vpv')) : '\u2014';
        html += '<div class="grid-row traffic-type-parent attribution-channel-parent" role="row" data-channel="' + escapeHtml(chKey) + '">' +
          '<div class="grid-cell" role="cell">' +
            '<button type="button" class="traffic-type-toggle attribution-channel-toggle" data-channel="' + escapeHtml(chKey) + '" aria-expanded="' + (chOpen ? 'true' : 'false') + '">' +
              '<span>' + escapeHtml(chLabel) + '</span>' +
            '</button>' +
          '</div>' +
          '<div class="grid-cell" role="cell">' + escapeHtml(chSessions || '-') + '</div>' +
          '<div class="grid-cell" role="cell">' + escapeHtml(chOrders || '-') + '</div>' +
          '<div class="grid-cell" role="cell">' + escapeHtml(chCr || '-') + '</div>' +
          '<div class="grid-cell" role="cell">' + chVpv + '</div>' +
          '<div class="grid-cell" role="cell">' + (chRev || '-') + '</div>' +
        '</div>';

        const sources = ch && Array.isArray(ch.sources) ? ch.sources.slice() : [];
        sources.sort(function(a, b) {
          let primary = 0;
          if (by === 'attribution') primary = cmpNullableText(sourceLabel(a), sourceLabel(b), dir);
          else primary = cmpNullableNumber(metric(a, by), metric(b, by), dir);
          return primary ||
            cmpNullableNumber(metric(a, 'rev'), metric(b, 'rev'), 'desc') ||
            cmpNullableNumber(metric(a, 'orders'), metric(b, 'orders'), 'desc') ||
            cmpNullableNumber(metric(a, 'sessions'), metric(b, 'sessions'), 'desc') ||
            cmpNullableText(sourceLabel(a), sourceLabel(b), 'asc');
        });

        sources.forEach(function(src) {
          const sKey = sourceKey(src);
          const srcOpen = chOpen && isSourceOpen(chKey, sKey);
          const sLabel = sourceLabel(src);
          const sIcon = iconSpecHtml(src && src.icon_spec != null ? src.icon_spec : null, sLabel);
          const sCr = (src && typeof src.conversion_pct === 'number') ? pct(src.conversion_pct) : '-';
          const sOrders = (src && typeof src.orders === 'number') ? formatSessions(src.orders) : '-';
          const sSessions = (src && typeof src.sessions === 'number') ? formatSessions(src.sessions) : '-';
          const sRev = (src && typeof src.revenue_gbp === 'number') ? formatRevenueTableHtml(src.revenue_gbp) : '-';
          const sVpv = metric(src, 'vpv') != null ? formatRevenue(metric(src, 'vpv')) : '\u2014';
          html += '<div class="grid-row traffic-type-child attribution-source-row' + (chOpen ? '' : ' is-hidden') + '" role="row" data-parent="' + escapeHtml(chKey) + '" data-channel="' + escapeHtml(chKey) + '" data-source="' + escapeHtml(sKey) + '">' +
            '<div class="grid-cell" role="cell">' +
              '<button type="button" class="traffic-type-toggle attribution-source-toggle" data-channel="' + escapeHtml(chKey) + '" data-source="' + escapeHtml(sKey) + '" aria-expanded="' + (srcOpen ? 'true' : 'false') + '">' +
                (sIcon || '') +
                '<span>' + escapeHtml(sLabel) + '</span>' +
              '</button>' +
            '</div>' +
            '<div class="grid-cell" role="cell">' + escapeHtml(sSessions || '-') + '</div>' +
            '<div class="grid-cell" role="cell">' + escapeHtml(sOrders || '-') + '</div>' +
            '<div class="grid-cell" role="cell">' + escapeHtml(sCr || '-') + '</div>' +
            '<div class="grid-cell" role="cell">' + sVpv + '</div>' +
            '<div class="grid-cell" role="cell">' + (sRev || '-') + '</div>' +
          '</div>';

          const variants = src && Array.isArray(src.variants) ? src.variants.slice() : [];
          variants.sort(function(a, b) {
            let primary = 0;
            if (by === 'attribution') primary = cmpNullableText(variantLabel(a), variantLabel(b), dir);
            else primary = cmpNullableNumber(metric(a, by), metric(b, by), dir);
            return primary ||
              cmpNullableNumber(metric(a, 'rev'), metric(b, 'rev'), 'desc') ||
              cmpNullableNumber(metric(a, 'orders'), metric(b, 'orders'), 'desc') ||
              cmpNullableNumber(metric(a, 'sessions'), metric(b, 'sessions'), 'desc') ||
              cmpNullableText(variantLabel(a), variantLabel(b), 'asc');
          });

          const parentKey = chKey + '|' + sKey;
          variants.forEach(function(v) {
            const vKey = variantKey(v);
            const vLabel = variantLabel(v);
            const vIcon = iconSpecHtml(v && v.icon_spec != null ? v.icon_spec : null, vLabel);
            const vCr = (v && typeof v.conversion_pct === 'number') ? pct(v.conversion_pct) : '-';
            const vOrders = (v && typeof v.orders === 'number') ? formatSessions(v.orders) : '-';
            const vSessions = (v && typeof v.sessions === 'number') ? formatSessions(v.sessions) : '-';
            const vRev = (v && typeof v.revenue_gbp === 'number') ? formatRevenueTableHtml(v.revenue_gbp) : '-';
            const vVpv = metric(v, 'vpv') != null ? formatRevenue(metric(v, 'vpv')) : '\u2014';
            const ownerKind = v && v.owner_kind != null ? String(v.owner_kind).trim().toLowerCase() : '';
            const ownerBadge = ownerKind && ownerKind !== 'house'
              ? (' <span class="text-muted small">(' + escapeHtml(ownerKind) + ')</span>')
              : '';
            html += '<div class="grid-row traffic-type-child attribution-variant-row' + (srcOpen ? '' : ' is-hidden') + '" role="row" data-parent="' + escapeHtml(parentKey) + '" data-channel="' + escapeHtml(chKey) + '" data-source="' + escapeHtml(sKey) + '">' +
              '<div class="grid-cell" role="cell"><span style="display:inline-flex;align-items:center;gap:8px;padding-left:18px">' + (vIcon || '') + '<span>' + escapeHtml(vLabel) + '</span>' + ownerBadge + '</span></div>' +
              '<div class="grid-cell" role="cell">' + escapeHtml(vSessions || '-') + '</div>' +
              '<div class="grid-cell" role="cell">' + escapeHtml(vOrders || '-') + '</div>' +
              '<div class="grid-cell" role="cell">' + escapeHtml(vCr || '-') + '</div>' +
              '<div class="grid-cell" role="cell">' + vVpv + '</div>' +
              '<div class="grid-cell" role="cell">' + (vRev || '-') + '</div>' +
            '</div>';
          });
        });
      });

      body.innerHTML = html;
      updateSortHeadersInContainer(document.getElementById('attribution-table'), by, dir);
    }

    function renderAttributionChart(data) {
      const el = document.getElementById('attribution-chart');
      if (!el) return;
      const chartKey = 'attribution-chart';
      if (!isChartEnabledByUiConfig(chartKey, true)) {
        try {
          if (el.__kexoChartInstance) {
            try { el.__kexoChartInstance.destroy(); } catch (_) {}
            el.__kexoChartInstance = null;
          }
        } catch (_) {}
        el.innerHTML = '';
        return;
      }

      const rows = data && data.attribution && Array.isArray(data.attribution.rows) ? data.attribution.rows.slice() : [];
      if (!rows.length) {
        el.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:320px;color:#6b7280;font-size:.875rem">No attribution data</div>';
        return;
      }

      function channelLabel(r) {
        if (!r) return 'Unknown';
        if (r.label != null && String(r.label).trim() !== '') return String(r.label);
        if (r.channel_key != null && String(r.channel_key).trim() !== '') return String(r.channel_key);
        return 'Unknown';
      }
      function metricValue(r, metricKey) {
        if (!r) return 0;
        if (metricKey === 'orders') return Math.max(0, Number(r.orders) || 0);
        if (metricKey === 'revenue') return Math.max(0, Number(r.revenue_gbp) || 0);
        return Math.max(0, Number(r.sessions) || 0);
      }

      const rawMode = chartModeFromUiConfig(chartKey, 'line') || 'line';
      const showEndLabels = rawMode === 'multi-line-labels';
      const mode = rawMode === 'multi-line-labels' ? 'line' : rawMode;
      const metricKey = chartPieMetricFromUiConfig(chartKey, 'sessions');
      const palette = chartColorsFromUiConfig(chartKey, ['#4b94e4', '#f59e34', '#3eb3ab', '#8b5cf6', '#ef4444', '#22c55e']);
      const isCurrency = metricKey === 'revenue';
      const seriesName = metricKey === 'orders' ? 'Orders' : (metricKey === 'revenue' ? 'Revenue' : 'Sessions');

      const items = rows
        .map(function (r) { return { label: channelLabel(r), value: metricValue(r, metricKey) }; })
        .filter(function (it) { return it && it.value > 0; })
        .sort(function (a, b) { return (b.value - a.value) || String(a.label).localeCompare(String(b.label)); })
        .slice(0, 10);

      if (!items.length) {
        el.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:320px;color:#6b7280;font-size:.875rem">No attribution data</div>';
        return;
      }

      const categories = items.map(function (it) { return it.label; });
      const values = items.map(function (it) { return it.value; });
      const series = (String(mode).toLowerCase() === 'pie')
        ? categories.map(function (name, idx) { return { name: name, data: [values[idx]] }; })
        : [{ name: seriesName, data: values }];

      try {
        window.kexoRenderApexChart({
          chartKey: chartKey,
          containerEl: el,
          categories: categories,
          series: series,
          mode: mode,
          colors: palette,
          height: 320,
          currency: isCurrency,
          showEndLabels: showEndLabels,
          chartStyle: chartStyleFromUiConfig(chartKey),
          advancedApexOverride: chartAdvancedOverrideFromUiConfig(chartKey, mode),
        });
      } catch (_) {
        el.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:320px;color:#ef4444;font-size:.875rem">Chart rendering failed</div>';
      }
    }

    function renderAttribution(data) {
      attributionCache = data || attributionCache || null;
      try { renderAttributionTables(attributionCache || {}); } catch (_) {}
      try { renderAttributionChart(attributionCache || {}); } catch (_) {}
    }

    function fetchAttributionData(options = {}) {
      const force = !!options.force;
      let url = API + '/api/attribution/report?range=' + encodeURIComponent(getStatsRange());
      if (force) url += (url.indexOf('?') >= 0 ? '&' : '?') + '_=' + Date.now();
      const cacheMode = force ? 'no-store' : 'default';
      return fetchWithTimeout(url, { credentials: 'same-origin', cache: cacheMode }, 25000)
        .then(function(r) {
          if (!r.ok) throw new Error('Attribution HTTP ' + r.status);
          return r.json();
        })
        .then(function(data) {
          lastAttributionFetchedAt = Date.now();
          renderAttribution(data && typeof data === 'object' ? data : null);
          return data;
        })
        .catch(function(err) {
          try { if (typeof window.kexoCaptureError === 'function') window.kexoCaptureError(err, { context: 'attributionFetch', page: PAGE }); } catch (_) {}
          renderAttribution(attributionCache || null);
          return null;
        });
    }

    function refreshAttribution(options = {}) {
      const force = !!options.force;
      if (attributionRefreshInFlight) return attributionRefreshInFlight;
      const build = startReportBuild({ key: 'attribution', title: 'Preparing attribution report' });
      build.step('Loading attribution performance');
      attributionRefreshInFlight = fetchAttributionData({ force })
        .finally(function() {
          attributionRefreshInFlight = null;
          build.finish();
        });
      return attributionRefreshInFlight;
    }

    function renderDevicesTables(data) {
      const body = document.getElementById('devices-body');
      if (!body) return;

      const by = (tableSortState.devices.by || 'rev').toString().trim().toLowerCase();
      const dir = (tableSortState.devices.dir || 'desc').toString().trim().toLowerCase() === 'asc' ? 'asc' : 'desc';

      const rows = data && data.devices && Array.isArray(data.devices.rows) ? data.devices.rows.slice() : [];
      const filtered = rows.filter(function(r) {
        const s = r && typeof r.sessions === 'number' ? r.sessions : 0;
        const o = r && typeof r.orders === 'number' ? r.orders : 0;
        return s >= 1 || o >= 1;
      });

      function deviceLabel(r) {
        if (!r) return 'unknown';
        const k = r.device_type != null ? String(r.device_type).trim().toLowerCase() : '';
        return k || 'unknown';
      }

      function metric(r, key) {
        if (!r) return null;
        if (key === 'cr') return (typeof r.conversion_pct === 'number') ? r.conversion_pct : null;
        if (key === 'orders') return (typeof r.orders === 'number') ? r.orders : null;
        if (key === 'sessions') return (typeof r.sessions === 'number') ? r.sessions : null;
        if (key === 'rev') return (typeof r.revenue_gbp === 'number') ? r.revenue_gbp : null;
        if (key === 'vpv') {
          const rev = (typeof r.revenue_gbp === 'number') ? r.revenue_gbp : null;
          const sess = (typeof r.sessions === 'number') ? r.sessions : null;
          return (sess != null && sess > 0 && rev != null) ? (rev / sess) : null;
        }
        return null;
      }

      function trafficTypeDeviceIcon(device) {
        var d = (device || '').trim().toLowerCase();
        var s = 'width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"';
        if (d === 'desktop') return '<i class="' + s + ' fa-light fa-desktop" data-icon-key="type-device-desktop"></i>';
        if (d === 'mobile') return '<i class="' + s + ' fa-light fa-mobile-screen" data-icon-key="type-device-mobile"></i>';
        if (d === 'tablet') return '<i class="' + s + ' fa-light fa-tablet-screen-button" data-icon-key="type-device-tablet"></i>';
        return '<i class="' + s + ' fa-light fa-globe" data-icon-key="type-device-unknown"></i>';
      }
      function trafficTypePlatformIcon(platform) {
        var p = (platform || '').trim().toLowerCase();
        if (p === 'ios') return '<i class="fa-light fa-apple" data-icon-key="type-platform-ios"></i>';
        if (p === 'mac') return '<i class="fa-light fa-apple" data-icon-key="type-platform-mac"></i>';
        if (p === 'android') return '<i class="fa-light fa-android" data-icon-key="type-platform-android"></i>';
        if (p === 'windows') return '<i class="fa-light fa-windows" data-icon-key="type-platform-windows"></i>';
        if (p === 'chromeos') return '<i class="fa-brands fa-chrome" data-icon-key="type-platform-chromeos"></i>';
        if (p === 'linux') return '<i class="fa-light fa-linux" data-icon-key="type-platform-linux"></i>';
        return '<i class="fa-light fa-circle-question" data-icon-key="type-platform-unknown"></i>';
      }

      filtered.sort(function(a, b) {
        let primary = 0;
        if (by === 'device') primary = cmpNullableText(deviceLabel(a), deviceLabel(b), dir);
        else primary = cmpNullableNumber(metric(a, by), metric(b, by), dir);
        return primary ||
          cmpNullableNumber(metric(a, 'rev'), metric(b, 'rev'), 'desc') ||
          cmpNullableNumber(metric(a, 'orders'), metric(b, 'orders'), 'desc') ||
          cmpNullableNumber(metric(a, 'sessions'), metric(b, 'sessions'), 'desc') ||
          cmpNullableText(deviceLabel(a), deviceLabel(b), 'asc');
      });

      if (!filtered.length) {
        body.innerHTML = '<div class="grid-row" role="row"><div class="grid-cell empty span-all" role="cell">No device data yet.</div></div>';
        updateCardPagination('devices', 1, 1);
        updateSortHeadersInContainer(document.getElementById('devices-table'), by, dir);
        return;
      }

      const pageSize = getTableRowsPerPage('devices-table', 'live');
      const totalPages = Math.max(1, Math.ceil(filtered.length / pageSize));
      devicesPage = clampPage(devicesPage, totalPages);
      updateCardPagination('devices', devicesPage, totalPages);
      const pageStart = (devicesPage - 1) * pageSize;
      const pageGroups = filtered.slice(pageStart, pageStart + pageSize);

      function isDeviceOpen(key) {
        if (devicesExpanded === null) return true;
        if (!devicesExpanded || typeof devicesExpanded !== 'object') return true;
        if (!Object.prototype.hasOwnProperty.call(devicesExpanded, key)) return true;
        return !!devicesExpanded[key];
      }

      let html = '';
      pageGroups.forEach(function(g) {
        const dKey = deviceLabel(g);
        const open = isDeviceOpen(dKey);
        const label = dKey;
        const cr = (g && typeof g.conversion_pct === 'number') ? pct(g.conversion_pct) : '-';
        const orders = (g && typeof g.orders === 'number') ? formatSessions(g.orders) : '-';
        const sessions = (g && typeof g.sessions === 'number') ? formatSessions(g.sessions) : '-';
        const rev = (g && typeof g.revenue_gbp === 'number') ? formatRevenueTableHtml(g.revenue_gbp) : '-';
        const vpv = metric(g, 'vpv') != null ? formatRevenue(metric(g, 'vpv')) : '\u2014';
        html += '<div class="grid-row traffic-type-parent devices-parent" role="row" data-device-type="' + escapeHtml(dKey) + '">' +
          '<div class="grid-cell" role="cell">' +
            '<button type="button" class="traffic-type-toggle devices-toggle" data-device-type="' + escapeHtml(dKey) + '" aria-expanded="' + (open ? 'true' : 'false') + '">' +
              '<span class="tt-device-icon" aria-hidden="true">' + trafficTypeDeviceIcon(dKey) + '</span>' +
              '<span>' + escapeHtml(label) + '</span>' +
            '</button>' +
          '</div>' +
          '<div class="grid-cell" role="cell">' + escapeHtml(sessions || '-') + '</div>' +
          '<div class="grid-cell" role="cell">' + escapeHtml(orders || '-') + '</div>' +
          '<div class="grid-cell" role="cell">' + escapeHtml(cr || '-') + '</div>' +
          '<div class="grid-cell" role="cell">' + vpv + '</div>' +
          '<div class="grid-cell" role="cell">' + (rev || '-') + '</div>' +
        '</div>';

        const kids = g && Array.isArray(g.platforms) ? g.platforms.slice() : [];
        kids.sort(function(a, b) {
          let primary = 0;
          if (by === 'device') primary = cmpNullableText((a && a.platform) ? String(a.platform) : '', (b && b.platform) ? String(b.platform) : '', dir);
          else primary = cmpNullableNumber(metric(a, by), metric(b, by), dir);
          return primary ||
            cmpNullableNumber(metric(a, 'rev'), metric(b, 'rev'), 'desc') ||
            cmpNullableNumber(metric(a, 'orders'), metric(b, 'orders'), 'desc') ||
            cmpNullableNumber(metric(a, 'sessions'), metric(b, 'sessions'), 'desc') ||
            cmpNullableText((a && a.platform) ? String(a.platform) : '', (b && b.platform) ? String(b.platform) : '', 'asc');
        });

        kids.forEach(function(c) {
          const platform = c && c.platform != null ? String(c.platform).trim().toLowerCase() : 'other';
          const clabel = platform || 'other';
          const ccr = (c && typeof c.conversion_pct === 'number') ? pct(c.conversion_pct) : '-';
          const corders = (c && typeof c.orders === 'number') ? formatSessions(c.orders) : '-';
          const csessions = (c && typeof c.sessions === 'number') ? formatSessions(c.sessions) : '-';
          const crev = (c && typeof c.revenue_gbp === 'number') ? formatRevenueTableHtml(c.revenue_gbp) : '-';
          const cvpv = metric(c, 'vpv') != null ? formatRevenue(metric(c, 'vpv')) : '\u2014';
          html += '<div class="grid-row traffic-type-child devices-child' + (open ? '' : ' is-hidden') + '" role="row" data-parent="' + escapeHtml(dKey) + '">' +
            '<div class="grid-cell" role="cell"><span style="display:inline-flex;align-items:center;gap:8px">' + trafficTypePlatformIcon(platform) + '<span>' + escapeHtml(clabel) + '</span></span></div>' +
            '<div class="grid-cell" role="cell">' + escapeHtml(csessions || '-') + '</div>' +
            '<div class="grid-cell" role="cell">' + escapeHtml(corders || '-') + '</div>' +
            '<div class="grid-cell" role="cell">' + escapeHtml(ccr || '-') + '</div>' +
            '<div class="grid-cell" role="cell">' + cvpv + '</div>' +
            '<div class="grid-cell" role="cell">' + (crev || '-') + '</div>' +
          '</div>';
        });
      });

      body.innerHTML = html;
      updateSortHeadersInContainer(document.getElementById('devices-table'), by, dir);
    }

    function renderDevicesChart(data) {
      const el = document.getElementById('devices-chart');
      if (!el) return;
      const chartKey = 'devices-chart';
      if (!isChartEnabledByUiConfig(chartKey, true)) {
        try {
          if (el.__kexoChartInstance) {
            try { el.__kexoChartInstance.destroy(); } catch (_) {}
            el.__kexoChartInstance = null;
          }
        } catch (_) {}
        el.innerHTML = '';
        return;
      }

      const rows = data && data.devices && Array.isArray(data.devices.rows) ? data.devices.rows.slice() : [];
      if (!rows.length) {
        el.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:320px;color:#6b7280;font-size:.875rem">No device data</div>';
        return;
      }

      function deviceLabel(r) {
        const k = r && r.device_type != null ? String(r.device_type).trim().toLowerCase() : '';
        return k || 'unknown';
      }
      function titleCase(s) {
        const raw = String(s || '').trim();
        if (!raw) return 'Unknown';
        return raw.slice(0, 1).toUpperCase() + raw.slice(1);
      }
      function metricValue(r, metricKey) {
        if (!r) return 0;
        if (metricKey === 'orders') return Math.max(0, Number(r.orders) || 0);
        if (metricKey === 'revenue') return Math.max(0, Number(r.revenue_gbp) || 0);
        return Math.max(0, Number(r.sessions) || 0);
      }

      const rawMode = chartModeFromUiConfig(chartKey, 'line') || 'line';
      const showEndLabels = rawMode === 'multi-line-labels';
      const mode = rawMode === 'multi-line-labels' ? 'line' : rawMode;
      const metricKey = chartPieMetricFromUiConfig(chartKey, 'sessions');
      const palette = chartColorsFromUiConfig(chartKey, ['#4b94e4', '#f59e34', '#3eb3ab', '#8b5cf6', '#ef4444', '#22c55e']);
      const isCurrency = metricKey === 'revenue';
      const seriesName = metricKey === 'orders' ? 'Orders' : (metricKey === 'revenue' ? 'Revenue' : 'Sessions');

      const items = rows
        .map(function (r) { return { label: titleCase(deviceLabel(r)), value: metricValue(r, metricKey) }; })
        .filter(function (it) { return it && it.value > 0; })
        .sort(function (a, b) { return (b.value - a.value) || String(a.label).localeCompare(String(b.label)); })
        .slice(0, 10);

      if (!items.length) {
        el.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:320px;color:#6b7280;font-size:.875rem">No device data</div>';
        return;
      }

      const categories = items.map(function (it) { return it.label; });
      const values = items.map(function (it) { return it.value; });
      const series = (String(mode).toLowerCase() === 'pie')
        ? categories.map(function (name, idx) { return { name: name, data: [values[idx]] }; })
        : [{ name: seriesName, data: values }];

      try {
        window.kexoRenderApexChart({
          chartKey: chartKey,
          containerEl: el,
          categories: categories,
          series: series,
          mode: mode,
          colors: palette,
          height: 320,
          currency: isCurrency,
          showEndLabels: showEndLabels,
          chartStyle: chartStyleFromUiConfig(chartKey),
          advancedApexOverride: chartAdvancedOverrideFromUiConfig(chartKey, mode),
        });
      } catch (_) {
        el.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:320px;color:#ef4444;font-size:.875rem">Chart rendering failed</div>';
      }
    }

    function renderDevices(data) {
      devicesCache = data || devicesCache || null;
      try { renderDevicesTables(devicesCache || {}); } catch (_) {}
      try { renderDevicesChart(devicesCache || {}); } catch (_) {}
    }

    function fetchDevicesData(options = {}) {
      const force = !!options.force;
      let url = API + '/api/devices/report?range=' + encodeURIComponent(getStatsRange());
      if (force) url += (url.indexOf('?') >= 0 ? '&' : '?') + '_=' + Date.now();
      const cacheMode = force ? 'no-store' : 'default';
      return fetchWithTimeout(url, { credentials: 'same-origin', cache: cacheMode }, 25000)
        .then(function(r) {
          if (!r.ok) throw new Error('Devices HTTP ' + r.status);
          return r.json();
        })
        .then(function(data) {
          lastDevicesFetchedAt = Date.now();
          renderDevices(data && typeof data === 'object' ? data : null);
          return data;
        })
        .catch(function(err) {
          try { if (typeof window.kexoCaptureError === 'function') window.kexoCaptureError(err, { context: 'devicesFetch', page: PAGE }); } catch (_) {}
          renderDevices(devicesCache || null);
          return null;
        });
    }

    function refreshDevices(options = {}) {
      const force = !!options.force;
      if (devicesRefreshInFlight) return devicesRefreshInFlight;
      const build = startReportBuild({ key: 'devices', title: 'Preparing devices report' });
      build.step('Loading device performance');
      devicesRefreshInFlight = fetchDevicesData({ force })
        .finally(function() {
          devicesRefreshInFlight = null;
          build.finish();
        });
      return devicesRefreshInFlight;
    }

    function browserLabel(key) {
      var k = key == null ? '' : String(key).trim().toLowerCase();
      if (!k) return 'Unknown';
      var names = {
        chrome: 'Chrome',
        safari: 'Safari',
        edge: 'Edge',
        firefox: 'Firefox',
        opera: 'Opera',
        ie: 'Internet Explorer',
        samsung: 'Samsung Internet',
        other: 'Other',
        unknown: 'Unknown',
      };
      if (names[k]) return names[k];
      return k.slice(0, 1).toUpperCase() + k.slice(1);
    }

    function browserIconKey(browserKeyRaw) {
      var k = browserKeyRaw == null ? '' : String(browserKeyRaw).trim().toLowerCase();
      if (!k) return 'type-browser-unknown';
      if (k === 'chrome') return 'type-browser-chrome';
      if (k === 'safari') return 'type-browser-safari';
      if (k === 'edge') return 'type-browser-edge';
      if (k === 'firefox') return 'type-browser-firefox';
      if (k === 'opera') return 'type-browser-opera';
      if (k === 'ie' || k === 'internet explorer') return 'type-browser-ie';
      if (k === 'samsung' || k === 'samsung internet') return 'type-browser-samsung';
      if (k === 'other') return 'type-browser-other';
      if (k === 'unknown') return 'type-browser-unknown';
      return 'type-browser-other';
    }

    function browserIconHtml(browserKeyRaw) {
      var iconKey = browserIconKey(browserKeyRaw);
      // Default glyphs come from the icon registry via data-icon-key; we provide a sensible fallback class.
      var fallback = 'fa-light fa-globe';
      if (iconKey === 'type-browser-chrome') fallback = 'fa-brands fa-chrome';
      else if (iconKey === 'type-browser-safari') fallback = 'fa-brands fa-safari';
      else if (iconKey === 'type-browser-edge') fallback = 'fa-brands fa-edge';
      else if (iconKey === 'type-browser-firefox') fallback = 'fa-brands fa-firefox-browser';
      else if (iconKey === 'type-browser-opera') fallback = 'fa-brands fa-opera';
      else if (iconKey === 'type-browser-ie') fallback = 'fa-brands fa-internet-explorer';
      else if (iconKey === 'type-browser-unknown') fallback = 'fa-light fa-circle-question';
      return '<i class="' + fallback + '" data-icon-key="' + escapeHtml(iconKey) + '" aria-hidden="true"></i>';
    }

    function renderBrowsersTables(data) {
      const body = document.getElementById('browsers-body');
      if (!body) return;

      const by = (tableSortState.browsers.by || 'rev').toString().trim().toLowerCase();
      const dir = (tableSortState.browsers.dir || 'desc').toString().trim().toLowerCase() === 'asc' ? 'asc' : 'desc';

      const rows = data && data.browsers && Array.isArray(data.browsers.rows) ? data.browsers.rows.slice() : [];
      const filtered = rows.filter(function(r) {
        const s = r && typeof r.sessions === 'number' ? r.sessions : 0;
        const o = r && typeof r.orders === 'number' ? r.orders : 0;
        return s >= 1 || o >= 1;
      });

      function rowBrowserKey(r) {
        if (!r) return 'unknown';
        const k = r.ua_browser != null ? String(r.ua_browser).trim().toLowerCase() : '';
        return k || 'unknown';
      }

      function metric(r, key) {
        if (!r) return null;
        if (key === 'browser') return browserLabel(rowBrowserKey(r));
        if (key === 'sessions') return (typeof r.sessions === 'number') ? r.sessions : null;
        if (key === 'carts') return (typeof r.carts === 'number') ? r.carts : null;
        if (key === 'orders') return (typeof r.orders === 'number') ? r.orders : null;
        if (key === 'cr') return (typeof r.cr === 'number') ? r.cr : null;
        if (key === 'vpv') return (typeof r.vpv === 'number') ? r.vpv : null;
        if (key === 'rev') return (typeof r.revenue === 'number') ? r.revenue : null;
        if (key === 'aov') return (typeof r.aov === 'number') ? r.aov : null;
        return null;
      }

      filtered.sort(function(a, b) {
        let primary = 0;
        if (by === 'browser') primary = cmpNullableText(metric(a, 'browser'), metric(b, 'browser'), dir);
        else primary = cmpNullableNumber(metric(a, by), metric(b, by), dir);
        return primary ||
          cmpNullableNumber(metric(a, 'rev'), metric(b, 'rev'), 'desc') ||
          cmpNullableNumber(metric(a, 'orders'), metric(b, 'orders'), 'desc') ||
          cmpNullableNumber(metric(a, 'sessions'), metric(b, 'sessions'), 'desc') ||
          cmpNullableText(metric(a, 'browser'), metric(b, 'browser'), 'asc');
      });

      if (!filtered.length) {
        body.innerHTML = '<div class="grid-row" role="row"><div class="grid-cell empty span-all" role="cell">No browser data yet.</div></div>';
        updateCardPagination('browsers', 1, 1);
        updateSortHeadersInContainer(document.getElementById('browsers-table'), by, dir);
        return;
      }

      const pageSize = getTableRowsPerPage('browsers-table', 'live');
      const totalPages = Math.max(1, Math.ceil(filtered.length / pageSize));
      browsersPage = clampPage(browsersPage, totalPages);
      updateCardPagination('browsers', browsersPage, totalPages);
      const pageStart = (browsersPage - 1) * pageSize;
      const pageRows = filtered.slice(pageStart, pageStart + pageSize);

      let html = '';
      pageRows.forEach(function(r) {
        const k = rowBrowserKey(r);
        const label = browserLabel(k);
        const sessions = (r && typeof r.sessions === 'number') ? formatSessions(r.sessions) : '\u2014';
        const carts = (r && typeof r.carts === 'number') ? formatSessions(r.carts) : '\u2014';
        const orders = (r && typeof r.orders === 'number') ? formatSessions(r.orders) : '\u2014';
        const cr = (r && typeof r.cr === 'number') ? pct(r.cr) : '\u2014';
        const vpv = (r && typeof r.vpv === 'number') ? formatRevenue(r.vpv) : '\u2014';
        const rev = (r && typeof r.revenue === 'number') ? formatRevenueTableHtml(r.revenue) : '\u2014';
        const aov = (r && typeof r.aov === 'number') ? formatRevenue(r.aov) : '\u2014';
        html += '<div class="grid-row" role="row">' +
          '<div class="grid-cell" role="cell"><span style="display:inline-flex;align-items:center;gap:8px"><span class="tt-browser-icon" aria-hidden="true">' + browserIconHtml(k) + '</span><span>' + escapeHtml(label) + '</span></span></div>' +
          '<div class="grid-cell" role="cell">' + escapeHtml(sessions) + '</div>' +
          '<div class="grid-cell" role="cell">' + escapeHtml(carts) + '</div>' +
          '<div class="grid-cell" role="cell">' + escapeHtml(orders) + '</div>' +
          '<div class="grid-cell" role="cell">' + escapeHtml(cr) + '</div>' +
          '<div class="grid-cell" role="cell">' + escapeHtml(vpv) + '</div>' +
          '<div class="grid-cell" role="cell">' + (rev || '\u2014') + '</div>' +
          '<div class="grid-cell" role="cell">' + escapeHtml(aov) + '</div>' +
        '</div>';
      });

      body.innerHTML = html;
      updateSortHeadersInContainer(document.getElementById('browsers-table'), by, dir);
      try { if (window.KexoIconTheme && typeof window.KexoIconTheme.refresh === 'function') window.KexoIconTheme.refresh(); } catch (_) {}
    }

    function renderBrowsersChart(data) {
      const el = document.getElementById('browsers-chart');
      if (!el) return;
      const chartKey = 'browsers-chart';
      if (!isChartEnabledByUiConfig(chartKey, true)) {
        try {
          if (el.__kexoChartInstance) {
            try { el.__kexoChartInstance.destroy(); } catch (_) {}
            el.__kexoChartInstance = null;
          }
        } catch (_) {}
        el.innerHTML = '';
        return;
      }

      const rows = data && data.browsers && Array.isArray(data.browsers.rows) ? data.browsers.rows.slice() : [];
      if (!rows.length) {
        el.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:320px;color:#6b7280;font-size:.875rem">No browser data</div>';
        return;
      }

      function metricValue(r, metricKey) {
        if (!r) return 0;
        if (metricKey === 'orders') return Math.max(0, Number(r.orders) || 0);
        if (metricKey === 'revenue') return Math.max(0, Number(r.revenue) || 0);
        return Math.max(0, Number(r.sessions) || 0);
      }

      const rawMode = chartModeFromUiConfig(chartKey, 'line') || 'line';
      const showEndLabels = rawMode === 'multi-line-labels';
      const mode = rawMode === 'multi-line-labels' ? 'line' : rawMode;
      const metricKey = chartPieMetricFromUiConfig(chartKey, 'sessions');
      const palette = chartColorsFromUiConfig(chartKey, ['#4b94e4', '#f59e34', '#3eb3ab', '#8b5cf6', '#ef4444', '#22c55e']);
      const isCurrency = metricKey === 'revenue';
      const seriesName = metricKey === 'orders' ? 'Orders' : (metricKey === 'revenue' ? 'Revenue' : 'Sessions');

      const items = rows
        .map(function (r) {
          const key = r && r.ua_browser != null ? String(r.ua_browser).trim().toLowerCase() : 'unknown';
          return { label: browserLabel(key), value: metricValue(r, metricKey) };
        })
        .filter(function (it) { return it && it.value > 0; })
        .sort(function (a, b) { return (b.value - a.value) || String(a.label).localeCompare(String(b.label)); })
        .slice(0, 10);

      if (!items.length) {
        el.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:320px;color:#6b7280;font-size:.875rem">No browser data</div>';
        return;
      }

      const categories = items.map(function (it) { return it.label; });
      const values = items.map(function (it) { return it.value; });
      const series = (String(mode).toLowerCase() === 'pie')
        ? categories.map(function (name, idx) { return { name: name, data: [values[idx]] }; })
        : [{ name: seriesName, data: values }];

      try {
        window.kexoRenderApexChart({
          chartKey: chartKey,
          containerEl: el,
          categories: categories,
          series: series,
          mode: mode,
          colors: palette,
          height: 320,
          currency: isCurrency,
          showEndLabels: showEndLabels,
          chartStyle: chartStyleFromUiConfig(chartKey),
          advancedApexOverride: chartAdvancedOverrideFromUiConfig(chartKey, mode),
        });
      } catch (_) {
        el.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:320px;color:#ef4444;font-size:.875rem">Chart rendering failed</div>';
      }
    }

    function renderBrowsers(data) {
      browsersCache = data || browsersCache || null;
      try { renderBrowsersTables(browsersCache || {}); } catch (_) {}
      try { renderBrowsersChart(browsersCache || {}); } catch (_) {}
    }

    function setBrowsersUpdated(label) {
      const el = document.getElementById('browsers-updated');
      if (!el) return;
      el.textContent = label || 'Updated \u2014';
    }

    function fetchBrowsersData(options = {}) {
      const force = !!options.force;
      let url = API + '/api/browsers/table?range=' + encodeURIComponent(getStatsRange());
      if (force) url += (url.indexOf('?') >= 0 ? '&' : '?') + '_=' + Date.now();
      const cacheMode = force ? 'no-store' : 'default';
      return fetchWithTimeout(url, { credentials: 'same-origin', cache: cacheMode }, 25000)
        .then(function(r) {
          if (!r.ok) throw new Error('Browsers HTTP ' + r.status);
          return r.json();
        })
        .then(function(payload) {
          lastBrowsersFetchedAt = Date.now();
          try { setBrowsersUpdated('Updated ' + (new Date(lastBrowsersFetchedAt)).toLocaleString('en-GB')); } catch (_) { setBrowsersUpdated('Updated'); }
          renderBrowsers(payload && typeof payload === 'object' ? { browsers: { rows: Array.isArray(payload.rows) ? payload.rows : [] }, meta: payload } : null);
          return payload;
        })
        .catch(function(err) {
          try { if (typeof window.kexoCaptureError === 'function') window.kexoCaptureError(err, { context: 'browsersFetch', page: PAGE }); } catch (_) {}
          setBrowsersUpdated('Failed to load');
          renderBrowsers(browsersCache || null);
          return null;
        });
    }

    function refreshBrowsers(options = {}) {
      const force = !!options.force;
      if (browsersRefreshInFlight) return browsersRefreshInFlight;
      const build = startReportBuild({ key: 'browsers', title: 'Preparing browsers report' });
      build.step('Loading browser performance');
      browsersRefreshInFlight = fetchBrowsersData({ force })
        .finally(function() {
          browsersRefreshInFlight = null;
          build.finish();
        });
      return browsersRefreshInFlight;
    }

    function sessionIdsEqual(a, b) {
      if (!a && !b) return true;
      if (!a || !b || a.length !== b.length) return false;
      for (var i = 0; i < a.length; i++) if (a[i].session_id !== b[i].session_id) return false;
      return true;
    }

    function shortTimeLabel(tsMs) {
      var ts = Number(tsMs);
      if (!Number.isFinite(ts)) return '';
      try {
        return new Intl.DateTimeFormat('en-GB', {
          hour: '2-digit',
          minute: '2-digit',
          hour12: false,
        }).format(new Date(ts));
      } catch (_) {
        return '';
      }
    }

    function shortDayLabel(tsMs) {
      var ts = Number(tsMs);
      if (!Number.isFinite(ts)) return '';
      try {
        return new Intl.DateTimeFormat('en-GB', {
          day: '2-digit',
          month: 'short',
        }).format(new Date(ts));
      } catch (_) {
        return '';
      }
    }

    function shortDateTimeLabel(tsMs) {
      var ts = Number(tsMs);
      if (!Number.isFinite(ts)) return '';
      try {
        return new Intl.DateTimeFormat('en-GB', {
          day: 'numeric',
          month: 'short',
          hour: '2-digit',
          minute: '2-digit',
          hour12: false,
        }).format(new Date(ts));
      } catch (_) {
        return '';
      }
    }

    function setLiveOnlineMapState(el, text, opts) {
      if (!el) return;
      var message = String(text == null ? '' : text).trim() || 'Unavailable';
      var isError = !!(opts && opts.error);
      var color = isError ? '#ef4444' : 'var(--tblr-secondary)';
      if (isError) captureChartMessage(message, 'liveOnlineMapState', { chartKey: 'live-online-chart' }, 'error');
      el.innerHTML =
        '<div style="display:flex;align-items:center;justify-content:center;height:220px;color:' + color + ';text-align:center;padding:0 18px;font-size:.875rem">' +
          escapeHtml(message) +
        '</div>';
    }

    function renderLiveOnlineMapChartFromSessions(sessionList) {
      var el = document.getElementById('live-online-chart');
      if (!el) return;
      var chartKey = 'live-online-chart';
      if (!isChartEnabledByUiConfig(chartKey, true)) {
        if (liveOnlineChart) { try { liveOnlineChart.destroy(); } catch (_) {} liveOnlineChart = null; }
        liveOnlineChartType = '';
        if (liveOnlineMapChartInstance) { try { liveOnlineMapChartInstance.destroy(); } catch (_) {} liveOnlineMapChartInstance = null; }
        clearCountriesFlowOverlay(el);
        try { el.__kexoLiveOnlineMapSig = ''; } catch (_) {}
        try { el.__kexoLiveOnlineMapMode = ''; } catch (_) {}
        try { el.__kexoLiveOnlineMapAccent = ''; } catch (_) {}
        el.innerHTML = '';
        return;
      }

      if (typeof jsVectorMap === 'undefined') {
        if (!el.__kexoJvmWaitTries) setLiveOnlineMapState(el, 'Loading map library...');
        // Avoid an unbounded retry loop if the CDN/map script is blocked (adblock/network).
        var tries = (el.__kexoJvmWaitTries || 0) + 1;
        el.__kexoJvmWaitTries = tries;
        if (tries >= 25) {
          el.__kexoJvmWaitTries = 0;
          setLiveOnlineMapState(el, 'Map library failed to load.', { error: true });
          return;
        }
        setTimeout(function() { renderLiveOnlineMapChartFromSessions(sessionList); }, 200);
        return;
      }
      try { el.__kexoJvmWaitTries = 0; } catch (_) {}

      // jsVectorMap snapshots container size at init; wait until the container is measurable.
      try {
        var rect = (el && el.getBoundingClientRect) ? el.getBoundingClientRect() : null;
        if (!rect || !(rect.width > 20) || !(rect.height > 20)) {
          var sizeTries = (el.__kexoJvmSizeWaitTries || 0) + 1;
          el.__kexoJvmSizeWaitTries = sizeTries;
          if (sizeTries <= 60) setTimeout(function() { renderLiveOnlineMapChartFromSessions(sessionList); }, 220);
          else el.__kexoJvmSizeWaitTries = 0;
          return;
        }
        el.__kexoJvmSizeWaitTries = 0;
      } catch (_) {}

      var rawMode = chartModeFromUiConfig(chartKey, 'map-flat') || 'map-flat';
      rawMode = String(rawMode || '').trim().toLowerCase();
      var isAnimated = rawMode !== 'map-flat';

      var list = Array.isArray(sessionList) ? sessionList : (Array.isArray(sessions) ? sessions : []);
      var countsByIso2 = {};
      for (var i = 0; i < list.length; i++) {
        var s = list[i];
        var isoSrc = (s && (s.country_code != null || s.cf_country != null)) ? (s.country_code || s.cf_country) : null;
        var iso = isoSrc != null ? String(isoSrc).trim().toUpperCase().slice(0, 2) : 'XX';
        if (!iso || iso === 'XX') continue;
        if (iso === 'UK') iso = 'GB';
        countsByIso2[iso] = (countsByIso2[iso] || 0) + 1;
      }
      var keys = Object.keys(countsByIso2);
      var hasNoLiveActivity = !keys.length;

      var palette = chartColorsFromUiConfig(chartKey, ['#16a34a']);
      var accent = (palette && palette[0]) ? String(palette[0]).trim() : '#16a34a';

      var sigParts = [];
      for (var k = 0; k < keys.length; k++) {
        var code = keys[k];
        sigParts.push(code + ':' + String(countsByIso2[code] || 0));
      }
      sigParts.sort();
      var sig = rawMode + '|' + accent + '|' + sigParts.join('|');
      if (liveOnlineMapChartInstance && el.__kexoLiveOnlineMapSig === sig) {
        if (!isAnimated) clearCountriesFlowOverlay(el);
        // Burst animations now run a finite number of iterations. If we're in animated mode,
        // occasionally restart the overlay (without rebuilding the map) so it still feels "live".
        if (isAnimated) {
          var lastBurstAt = 0;
          try { lastBurstAt = Number(el.__kexoLiveOnlineFlowBurstAt) || 0; } catch (_) { lastBurstAt = 0; }
          if (!lastBurstAt || (Date.now() - lastBurstAt) > 30000) {
            try { el.__kexoLiveOnlineFlowBurstAt = Date.now(); } catch (_) {}
            setTimeout(function () {
              try {
                var pseudo = keys.map(function (iso2) { return { country_code: iso2, converted: countsByIso2[iso2] || 0 }; });
                pseudo.sort(function (a, b) { return Number(b && b.converted) - Number(a && a.converted); });
                var originIso = pseudo && pseudo[0] && pseudo[0].country_code ? String(pseudo[0].country_code) : 'GB';
                var rgb2 = null;
                try { rgb2 = String(el.__kexoLiveOnlineMapPrimaryRgb || '').trim(); } catch (_) { rgb2 = ''; }
                if (!rgb2) rgb2 = '22,163,74';
                renderCountriesFlowOverlay(el, pseudo, rgb2, originIso);
              } catch (_) {}
            }, 120);
          }
        }
        return;
      }
      try { el.__kexoLiveOnlineMapSig = sig; } catch (_) {}

      // Switching chart types: clear Apex instance.
      if (liveOnlineChart) { try { liveOnlineChart.destroy(); } catch (_) {} liveOnlineChart = null; }
      liveOnlineChartType = '';

      try {
        var rootCss = getComputedStyle(document.documentElement);
        var border = (rootCss.getPropertyValue('--tblr-border-color') || '#d4dee5').trim();
        var muted = (rootCss.getPropertyValue('--tblr-secondary') || '#626976').trim();

        function rgbFromColor(c) {
          var s = String(c || '').trim();
          var m = /^#([0-9a-f]{6})$/i.exec(s);
          if (m) {
            var hex = m[1];
            var r = parseInt(hex.slice(0, 2), 16);
            var g = parseInt(hex.slice(2, 4), 16);
            var b = parseInt(hex.slice(4, 6), 16);
            return { r: r, g: g, b: b, rgb: r + ',' + g + ',' + b };
          }
          m = /^rgba?\(\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})/i.exec(s);
          if (m) {
            var rr = Math.max(0, Math.min(255, parseInt(m[1], 10) || 0));
            var gg = Math.max(0, Math.min(255, parseInt(m[2], 10) || 0));
            var bb = Math.max(0, Math.min(255, parseInt(m[3], 10) || 0));
            return { r: rr, g: gg, b: bb, rgb: rr + ',' + gg + ',' + bb };
          }
          return { r: 22, g: 163, b: 74, rgb: '22,163,74' };
        }
        var rgb = rgbFromColor(accent);
        var primaryRgb = rgb.rgb;
        try { el.__kexoLiveOnlineMapPrimaryRgb = primaryRgb; } catch (_) {}
        var regionFillByIso2 = buildMapFillScaleByIso(countsByIso2, primaryRgb, 0.24, 0.92);

        // If the map instance already exists and the chart mode/palette is unchanged,
        // update fills/overlay in-place (avoid destroy/recreate churn on every refresh).
        if (
          liveOnlineMapChartInstance &&
          el.__kexoLiveOnlineMapMode === rawMode &&
          el.__kexoLiveOnlineMapAccent === accent &&
          liveOnlineMapChartInstance.regions
        ) {
          try {
            var regionsExisting = liveOnlineMapChartInstance.regions;
            for (var codeExisting in regionFillByIso2) {
              if (regionsExisting[codeExisting] && regionsExisting[codeExisting].element && typeof regionsExisting[codeExisting].element.setStyle === 'function') {
                try { regionsExisting[codeExisting].element.setStyle('fill', regionFillByIso2[codeExisting]); } catch (_) {}
              }
            }
          } catch (_) {}
          try {
            var prevCaption = el.querySelector('.kexo-live-map-empty-caption');
            if (prevCaption && prevCaption.parentNode) prevCaption.parentNode.removeChild(prevCaption);
          } catch (_) {}
          if (hasNoLiveActivity) {
            var noActivity2 = document.createElement('div');
            noActivity2.setAttribute('class', 'kexo-live-map-empty-caption');
            noActivity2.style.cssText = 'position:absolute;left:0;right:0;bottom:12px;text-align:center;font-size:.8125rem;color:' + (muted || 'var(--tblr-secondary)') + ';pointer-events:none;';
            noActivity2.textContent = 'No live activity yet';
            if (el && el.style) el.style.position = 'relative';
            try { el.appendChild(noActivity2); } catch (_) {}
          }
          hideMapTooltipOnLeave(el);
          if (isAnimated) {
            setTimeout(function () {
              try {
                var pseudo2 = keys.map(function (iso2) { return { country_code: iso2, converted: countsByIso2[iso2] || 0 }; });
                pseudo2.sort(function (a, b) { return Number(b && b.converted) - Number(a && a.converted); });
                var originIso2 = pseudo2 && pseudo2[0] && pseudo2[0].country_code ? String(pseudo2[0].country_code) : 'GB';
                renderCountriesFlowOverlay(el, pseudo2, primaryRgb, originIso2);
              } catch (_) {}
            }, 120);
          } else {
            clearCountriesFlowOverlay(el);
          }
          try { if (typeof liveOnlineMapChartInstance.updateSize === 'function') liveOnlineMapChartInstance.updateSize(); } catch (_) {}
          return;
        }

        if (liveOnlineMapChartInstance) {
          try { liveOnlineMapChartInstance.destroy(); } catch (_) {}
          liveOnlineMapChartInstance = null;
        }
        clearCountriesFlowOverlay(el);
        el.innerHTML = '';

        liveOnlineMapChartInstance = new jsVectorMap({
          selector: '#live-online-chart',
          map: 'world',
          backgroundColor: 'transparent',
          zoomButtons: false,
          zoomOnScroll: false,
          zoomAnimate: false,
          regionStyle: {
            initial: { fill: 'rgba(' + primaryRgb + ',0.18)', stroke: border, strokeWidth: 0.7 },
            hover: { fill: 'rgba(' + primaryRgb + ',0.46)' },
            selected: { fill: 'rgba(' + primaryRgb + ',0.78)' },
          },
          onRegionTooltipShow: function(event, tooltip, code2) {
            var iso2 = (code2 || '').toString().trim().toUpperCase();
            var name = (liveOnlineMapChartInstance && typeof liveOnlineMapChartInstance.getRegionName === 'function')
              ? (liveOnlineMapChartInstance.getRegionName(iso2) || iso2)
              : iso2;
            var n = countsByIso2[iso2] || 0;
            if (!n) {
              setVectorMapTooltipContent(
                tooltip,
                '<div style="min-width:140px;font-weight:600">' + escapeHtml(name) + '</div>',
                name
              );
              return;
            }
            var sessionsText = formatSessions(n);
            setVectorMapTooltipContent(
              tooltip,
              '<div style="min-width:180px">' +
                '<div style="font-weight:600;margin-bottom:2px">' + escapeHtml(name) + '</div>' +
                '<div style="color:' + escapeHtml(muted) + ';font-size:.8125rem">Sessions (last 5m): <span style="color:inherit">' + escapeHtml(sessionsText) + '</span></div>' +
              '</div>',
              name + ' | Sessions (last 5m): ' + sessionsText
            );
          }
        });

        if (liveOnlineMapChartInstance && liveOnlineMapChartInstance.regions) {
          var regions = liveOnlineMapChartInstance.regions;
          for (var code in regionFillByIso2) {
            if (regions[code] && regions[code].element && typeof regions[code].element.setStyle === 'function') {
              try { regions[code].element.setStyle('fill', regionFillByIso2[code]); } catch (_) {}
            }
          }
        }
        hideMapTooltipOnLeave(el);
        try { el.__kexoLiveOnlineMapMode = rawMode; } catch (_) {}
        try { el.__kexoLiveOnlineMapAccent = accent; } catch (_) {}
        try { el.__kexoLiveOnlineMapPrimaryRgb = primaryRgb; } catch (_) {}

        if (hasNoLiveActivity) {
          var noActivity = document.createElement('div');
          noActivity.setAttribute('class', 'kexo-live-map-empty-caption');
          noActivity.style.cssText = 'position:absolute;left:0;right:0;bottom:12px;text-align:center;font-size:.8125rem;color:' + (muted || 'var(--tblr-secondary)') + ';pointer-events:none;';
          noActivity.textContent = 'No live activity yet';
          if (el && el.style) el.style.position = 'relative';
          try { el.appendChild(noActivity); } catch (_) {}
        }

        if (isAnimated) {
          setTimeout(function () {
            try {
              var pseudo = keys.map(function (iso2) { return { country_code: iso2, converted: countsByIso2[iso2] || 0 }; });
              pseudo.sort(function (a, b) { return Number(b && b.converted) - Number(a && a.converted); });
              var originIso = pseudo && pseudo[0] && pseudo[0].country_code ? String(pseudo[0].country_code) : 'GB';
              renderCountriesFlowOverlay(el, pseudo, primaryRgb, originIso);
            } catch (_) {}
          }, 120);
        }
      } catch (err) {
        captureChartError(err, 'liveOnlineMapRender', { chartKey: 'live-online-chart' });
        console.error('[live-online-map] render error:', err);
        setLiveOnlineMapState(el, 'Map rendering failed.', { error: true });
      }
    }

    function normalizeLiveOnlineSessionList(list) {
      var next = Array.isArray(list) ? list.slice() : [];
      if (!next.length) return [];
      var cutoff = Date.now() - ACTIVE_WINDOW_MS;
      var arrivedCutoff = Date.now() - ARRIVED_WINDOW_MS;
      next = next.filter(function(s) {
        return (s && s.last_seen != null && s.last_seen >= cutoff) &&
          (s.started_at != null && s.started_at >= arrivedCutoff);
      });
      next.sort(function(a, b) { return (b.last_seen || 0) - (a.last_seen || 0); });
      return next;
    }

    function fetchLiveOnlineMapSessions(options) {
      options = options || {};
      var force = !!options.force;
      var now = Date.now();
      var ttlMs = typeof ONLINE_COUNT_POLL_MS === 'number' ? ONLINE_COUNT_POLL_MS : 15000;
      if (!force) {
        if (lastSessionsMode === 'live' && Array.isArray(sessions) && sessions.length && lastSessionsFetchedAt && (now - lastSessionsFetchedAt) < ttlMs) {
          liveOnlineMapSessions = normalizeLiveOnlineSessionList(sessions);
          liveOnlineMapSessionsFetchedAt = lastSessionsFetchedAt || now;
          return Promise.resolve(liveOnlineMapSessions);
        }
        if (Array.isArray(liveOnlineMapSessions) && liveOnlineMapSessions.length && liveOnlineMapSessionsFetchedAt && (now - liveOnlineMapSessionsFetchedAt) < ttlMs) {
          return Promise.resolve(liveOnlineMapSessions);
        }
      }
      if (liveOnlineMapSessionsInFlight) return liveOnlineMapSessionsInFlight;
      var url = API + '/api/sessions?filter=active&_=' + Date.now();
      liveOnlineMapSessionsInFlight = fetchWithTimeout(url, { credentials: 'same-origin', cache: 'no-store' }, 15000)
        .then(function(r) { return (r && r.ok) ? r.json() : null; })
        .then(function(data) {
          var list = data && Array.isArray(data.sessions) ? data.sessions : [];
          liveOnlineMapSessions = normalizeLiveOnlineSessionList(list);
          liveOnlineMapSessionsFetchedAt = Date.now();
          return liveOnlineMapSessions;
        })
        .catch(function(err) {
          try { if (typeof window.kexoCaptureError === 'function') window.kexoCaptureError(err, { context: 'liveOnlineMapSessions', page: PAGE }); } catch (_) {}
          return Array.isArray(liveOnlineMapSessions) ? liveOnlineMapSessions : [];
        })
        .finally(function() { liveOnlineMapSessionsInFlight = null; });
      return liveOnlineMapSessionsInFlight;
    }

    function renderLiveOnlineTrendChart(payload) {
      var el = document.getElementById('live-online-chart');
      if (!el) return;
      if (typeof ApexCharts === 'undefined') {
        // Avoid an unbounded retry loop if the CDN is blocked (adblock/network).
        const tries = (el.__kexoApexWaitTries || 0) + 1;
        el.__kexoApexWaitTries = tries;
        if (tries >= 25) {
          el.__kexoApexWaitTries = 0;
          captureChartMessage('Chart library failed to load.', 'liveOnlineTrendLibraryLoad', { chartKey: 'live-online-chart', tries: tries }, 'error');
          el.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:220px;color:var(--tblr-secondary);text-align:center;padding:0 18px;font-size:.875rem">Chart library failed to load.</div>';
          return;
        }
        setTimeout(function() { renderLiveOnlineTrendChart(payload); }, 180);
        return;
      }
      try { el.__kexoApexWaitTries = 0; } catch (_) {}
      var chartKey = 'live-online-chart';
      if (!isChartEnabledByUiConfig(chartKey, true)) {
        if (liveOnlineChart) { try { liveOnlineChart.destroy(); } catch (_) {} liveOnlineChart = null; }
        liveOnlineChartType = '';
        if (liveOnlineMapChartInstance) { try { liveOnlineMapChartInstance.destroy(); } catch (_) {} liveOnlineMapChartInstance = null; }
        clearCountriesFlowOverlay(el);
        try { el.__kexoLiveOnlineMapSig = ''; } catch (_) {}
        el.innerHTML = '';
        return;
      }
      var allPoints = payload && Array.isArray(payload.points) ? payload.points.slice() : [];
      var viewport = 0;
      try {
        viewport = Math.max(window.innerWidth || 0, document.documentElement ? (document.documentElement.clientWidth || 0) : 0);
      } catch (_) {
        viewport = 0;
      }
      var compactMode = viewport > 0 && viewport <= 960;
      var points = compactMode && allPoints.length > 6 ? allPoints.slice(-6) : allPoints;
      if (!points.length) {
        el.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:220px;color:var(--tblr-secondary);font-size:.875rem">No live activity yet</div>';
        return;
      }
      var labels = points.map(function(p) { return shortTimeLabel(p && p.ts); });
      var values = points.map(function(p) {
        var n = p && p.online != null ? Number(p.online) : NaN;
        return Number.isFinite(n) ? n : 0;
      });
      var rawMode = chartModeFromUiConfig(chartKey, 'line') || 'line';
      var showEndLabels = rawMode === 'multi-line-labels';
      var chartType = rawMode === 'multi-line-labels' ? 'line' : rawMode;
      chartType = normalizeChartType(chartType, 'line');
      var palette = chartColorsFromUiConfig(chartKey, ['#16a34a']);
      var apexSeries = [{ name: 'Online now', data: values }];

      // Smooth updates: keep the chart instance and update series/options.
      if (liveOnlineChart && liveOnlineChartType === chartType) {
        try {
          var updateOpts = {
            colors: palette,
            xaxis: {
              categories: labels,
              tickPlacement: 'between',
              labels: { style: { fontSize: '11px' } },
            },
          };
          if (chartType === 'bar') {
            updateOpts.stroke = { show: false };
            updateOpts.dataLabels = { enabled: false };
            updateOpts.fill = { type: 'solid', opacity: 1 };
            updateOpts.plotOptions = { bar: { horizontal: false, columnWidth: points.length > 8 ? '58%' : '50%', borderRadius: 3 } };
            updateOpts.markers = { size: 0 };
          } else {
            updateOpts.stroke = { show: true, curve: 'smooth', width: 3, lineCap: 'round' };
            updateOpts.fill = chartType === 'area'
              ? { type: 'gradient', gradient: { shadeIntensity: 1, opacityFrom: 0.28, opacityTo: 0.08, stops: [0, 100] } }
              : { type: 'solid', opacity: 1 };
            updateOpts.plotOptions = {};
            updateOpts.markers = { size: chartType === 'line' ? 3 : 0, hover: { size: 5 } };
            updateOpts.dataLabels = (showEndLabels && chartType === 'line') ? {
              enabled: true,
              formatter: function(val, ctx) {
                try {
                  var dp = ctx && ctx.dataPointIndex != null ? Number(ctx.dataPointIndex) : -1;
                  var w = ctx && ctx.w ? ctx.w : null;
                  var last = w && w.globals && Array.isArray(w.globals.labels) ? (w.globals.labels.length - 1) : -1;
                  if (dp !== last) return '';
                } catch (_) { return ''; }
                return Number(val || 0).toLocaleString();
              },
              style: { fontSize: '10px' },
              background: { enabled: true, borderRadius: 4, padding: 3, opacity: 0.85 },
              offsetY: -3,
            } : { enabled: false };
          }
          try {
            var liveUpdateOverride = chartAdvancedOverrideFromUiConfig(chartKey, chartType);
            if (liveUpdateOverride && isPlainObject(liveUpdateOverride)) {
              updateOpts = deepMergeOptions(updateOpts, liveUpdateOverride);
            }
          } catch (_) {}
          liveOnlineChart.updateOptions(updateOpts, false, true);
          liveOnlineChart.updateSeries(apexSeries, true);
          return;
        } catch (_) {
          try { liveOnlineChart.destroy(); } catch (_) {}
          liveOnlineChart = null;
          liveOnlineChartType = '';
        }
      }

      if (liveOnlineChart) {
        try { liveOnlineChart.destroy(); } catch (_) {}
        liveOnlineChart = null;
        liveOnlineChartType = '';
      }
      el.innerHTML = '';

      var apexOpts = {
        chart: {
          type: chartType,
          height: 220,
          fontFamily: 'Inter, sans-serif',
          toolbar: { show: false },
          zoom: { enabled: false },
          animations: {
            enabled: true,
            easing: 'easeinout',
            speed: 450,
            animateGradually: { enabled: true, delay: 80 },
            dynamicAnimation: { enabled: true, speed: 450 },
          },
        },
        series: apexSeries,
        xaxis: {
          categories: labels,
          tickPlacement: 'between',
          labels: { style: { fontSize: '11px' } },
        },
        yaxis: {
          min: 0,
          forceNiceScale: true,
          tickAmount: 5,
          labels: { style: { fontSize: '11px' } },
        },
        colors: palette,
        tooltip: {
          y: { formatter: function(v) { return Number(v || 0).toLocaleString() + ' online'; } },
        },
        grid: { borderColor: '#f0f0f0', strokeDashArray: 3 },
      };

      if (chartType === 'bar') {
        apexOpts.stroke = { show: false };
        apexOpts.dataLabels = { enabled: false };
        apexOpts.fill = { type: 'solid', opacity: 1 };
        apexOpts.plotOptions = { bar: { horizontal: false, columnWidth: points.length > 8 ? '58%' : '50%', borderRadius: 3 } };
        apexOpts.markers = { size: 0 };
      } else {
        apexOpts.stroke = { show: true, curve: 'smooth', width: 3, lineCap: 'round' };
        apexOpts.fill = chartType === 'area'
          ? { type: 'gradient', gradient: { shadeIntensity: 1, opacityFrom: 0.28, opacityTo: 0.08, stops: [0, 100] } }
          : { type: 'solid', opacity: 1 };
        apexOpts.plotOptions = {};
        apexOpts.markers = { size: chartType === 'line' ? 3 : 0, hover: { size: 5 } };
        apexOpts.dataLabels = (showEndLabels && chartType === 'line') ? {
          enabled: true,
          formatter: function(val, ctx) {
            try {
              var dp = ctx && ctx.dataPointIndex != null ? Number(ctx.dataPointIndex) : -1;
              var w = ctx && ctx.w ? ctx.w : null;
              var last = w && w.globals && Array.isArray(w.globals.labels) ? (w.globals.labels.length - 1) : -1;
              if (dp !== last) return '';
            } catch (_) { return ''; }
            return Number(val || 0).toLocaleString();
          },
          style: { fontSize: '10px' },
          background: { enabled: true, borderRadius: 4, padding: 3, opacity: 0.85 },
          offsetY: -3,
        } : { enabled: false };
      }

      liveOnlineChartType = chartType;
      try {
        var liveOverride = chartAdvancedOverrideFromUiConfig(chartKey, chartType);
        if (liveOverride && isPlainObject(liveOverride)) {
          apexOpts = deepMergeOptions(apexOpts, liveOverride);
        }
      } catch (_) {}
      liveOnlineChart = new ApexCharts(el, apexOpts);
      liveOnlineChart.render();
    }

    function refreshLiveOnlineChart(options) {
      var chartKey = 'live-online-chart';
      var rawMode = chartModeFromUiConfig(chartKey, 'map-flat') || 'map-flat';
      rawMode = String(rawMode || '').trim().toLowerCase();
      if (rawMode.indexOf('map-') === 0) {
        return fetchLiveOnlineMapSessions(options || {}).then(function(list) {
          try { renderLiveOnlineMapChartFromSessions(Array.isArray(list) ? list : []); } catch (_) {}
          return list || null;
        });
      }

      // Switching away from map: clean up jsVectorMap instance + overlay.
      var el = document.getElementById('live-online-chart');
      if (liveOnlineMapChartInstance) { try { liveOnlineMapChartInstance.destroy(); } catch (_) {} liveOnlineMapChartInstance = null; }
      if (el) {
        clearCountriesFlowOverlay(el);
        try { el.__kexoLiveOnlineMapSig = ''; } catch (_) {}
      }
      return refreshLiveOnlineTrendChart(options || {});
    }

    function refreshLiveOnlineTrendChart(options) {
      var el = document.getElementById('live-online-chart');
      if (!el) return Promise.resolve(null);
      options = options || {};
      var force = !!options.force;
      var ttlMs = 30 * 1000;
      if (!force && liveOnlineChartFetchedAt && (Date.now() - liveOnlineChartFetchedAt) < ttlMs) {
        return Promise.resolve(null);
      }
      if (liveOnlineChartInFlight) return liveOnlineChartInFlight;
      var url = API + '/api/sessions/online-series?minutes=5&stepMinutes=1' + (force ? ('&_=' + Date.now()) : '');
      liveOnlineChartInFlight = fetchWithTimeout(url, { credentials: 'same-origin', cache: force ? 'no-store' : 'default' }, 15000)
        .then(function(r) { return (r && r.ok) ? r.json() : null; })
        .then(function(data) {
          liveOnlineChartFetchedAt = Date.now();
          renderLiveOnlineTrendChart(data || null);
          return data;
        })
        .catch(function() { return null; })
        .finally(function() { liveOnlineChartInFlight = null; });
      return liveOnlineChartInFlight;
    }

    function renderSessionsOverviewChart(payload, rangeKey) {
      var el = document.getElementById('sessions-overview-chart');
      if (!el) return;
      if (typeof ApexCharts === 'undefined') {
        // Avoid an unbounded retry loop if the CDN is blocked (adblock/network).
        const tries = (el.__kexoApexWaitTries || 0) + 1;
        el.__kexoApexWaitTries = tries;
        if (tries >= 25) {
          el.__kexoApexWaitTries = 0;
          captureChartMessage('Chart library failed to load.', 'sessionsOverviewLibraryLoad', { chartKey: (PAGE === 'sales' ? 'sales-overview-chart' : 'date-overview-chart'), tries: tries }, 'error');
          el.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:220px;color:var(--tblr-secondary);text-align:center;padding:0 18px;font-size:.875rem">Chart library failed to load.</div>';
          return;
        }
        setTimeout(function() { renderSessionsOverviewChart(payload, rangeKey); }, 180);
        return;
      }
      try { el.__kexoApexWaitTries = 0; } catch (_) {}
      var chartKey = PAGE === 'sales' ? 'sales-overview-chart' : 'date-overview-chart';
      if (!isChartEnabledByUiConfig(chartKey, true)) {
        if (rangeOverviewChart) { try { rangeOverviewChart.destroy(); } catch (_) {} rangeOverviewChart = null; }
        el.innerHTML = '';
        var lbl = document.getElementById('sessions-overview-bucket-label');
        if (lbl) { lbl.textContent = ''; lbl.setAttribute('aria-hidden', 'true'); }
        return;
      }
      var rows = payload && Array.isArray(payload.series) ? payload.series.slice() : [];
      if (rangeOverviewChart) {
        try { rangeOverviewChart.destroy(); } catch (_) {}
        rangeOverviewChart = null;
      }
      if (!rows.length) {
        el.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:220px;color:var(--tblr-secondary);font-size:.875rem">No data for this range</div>';
        var lbl2 = document.getElementById('sessions-overview-bucket-label');
        if (lbl2) { lbl2.textContent = ''; lbl2.setAttribute('aria-hidden', 'true'); }
        return;
      }

      var bucket = payload && payload.bucket ? String(payload.bucket) : 'day';
      var labels = rows.map(function(row) {
        var ts = row && row.ts != null ? Number(row.ts) : NaN;
        if (!Number.isFinite(ts)) return '';
        return bucket === 'hour' ? shortTimeLabel(ts) : shortDateTimeLabel(ts);
      });

      var chartCfg;
      if (PAGE === 'sales') {
        chartCfg = {
          series: [{ name: 'Revenue', data: rows.map(function(r) { return Number(r && r.revenue) || 0; }) }],
          colors: ['#0d9488'],
          yFormatter: function(v) { return formatRevenue(Number(v)) || '\u2014'; },
          tooltipFormatter: function(v) { return formatRevenue(Number(v)) || '\u2014'; },
        };
      } else {
        chartCfg = {
          series: [
            { name: 'Sessions', data: rows.map(function(r) { return Number(r && r.sessions) || 0; }) },
            { name: 'Orders', data: rows.map(function(r) { return Number(r && r.orders) || 0; }) },
          ],
          colors: ['#4b94e4', '#f59e34'],
          yFormatter: function(v) { return Number(v || 0).toLocaleString(); },
          tooltipFormatter: function(v) { return Number(v || 0).toLocaleString(); },
        };
      }
      // Apply chart mode + palette overrides from global Charts settings.
      var rawMode = chartModeFromUiConfig(chartKey, 'area') || 'area';
      var showEndLabels = rawMode === 'multi-line-labels';
      var overviewType = rawMode === 'multi-line-labels' ? 'line' : rawMode;
      overviewType = normalizeChartType(overviewType, 'area');
      chartCfg.colors = chartColorsFromUiConfig(chartKey, chartCfg.colors);
      el.innerHTML = '';
      var overviewOpts = {
        chart: {
          type: overviewType,
          height: 220,
          fontFamily: 'Inter, sans-serif',
          toolbar: { show: false },
          zoom: { enabled: false },
        },
        series: chartCfg.series,
        colors: chartCfg.colors,
        stroke: { show: true, curve: 'smooth', width: overviewType === 'bar' ? 0 : 2, lineCap: 'round' },
        fill: overviewType === 'area'
          ? { type: 'gradient', gradient: { shadeIntensity: 1, opacityFrom: 0.28, opacityTo: 0.08, stops: [0, 100] } }
          : { type: 'solid', opacity: 1 },
        plotOptions: overviewType === 'bar' ? { bar: { columnWidth: '56%', borderRadius: 3 } } : {},
        markers: { size: overviewType === 'line' ? 3 : 0, hover: { size: 5 } },
        dataLabels: (showEndLabels && overviewType === 'line') ? {
          enabled: true,
          formatter: function(val, ctx) {
            try {
              var dp = ctx && ctx.dataPointIndex != null ? Number(ctx.dataPointIndex) : -1;
              var w = ctx && ctx.w ? ctx.w : null;
              var last = w && w.globals && Array.isArray(w.globals.labels) ? (w.globals.labels.length - 1) : -1;
              if (dp !== last) return '';
            } catch (_) { return ''; }
            try { return chartCfg.tooltipFormatter(val); } catch (_) { return String(val); }
          },
          style: { fontSize: '10px' },
          background: { enabled: true, borderRadius: 4, padding: 3, opacity: 0.85 },
          offsetY: -3,
        } : { enabled: false },
        xaxis: { categories: labels, labels: { style: { fontSize: '11px' } } },
        yaxis: { min: 0, labels: { style: { fontSize: '11px' }, formatter: chartCfg.yFormatter } },
        tooltip: { y: { formatter: chartCfg.tooltipFormatter } },
        grid: { borderColor: '#f0f0f0', strokeDashArray: 3 },
      };
      try {
        var overviewOverride = chartAdvancedOverrideFromUiConfig(chartKey, overviewType);
        if (overviewOverride && isPlainObject(overviewOverride)) {
          overviewOpts = deepMergeOptions(overviewOpts, overviewOverride);
        }
      } catch (_) {}
      rangeOverviewChart = new ApexCharts(el, overviewOpts);
      var curOverviewChart = rangeOverviewChart;
      var overviewRenderPromise = null;
      try { overviewRenderPromise = curOverviewChart.render(); } catch (_) { overviewRenderPromise = null; }
      rangeOverviewChartKey = String(rangeKey || '');
      function applyChangePinsOverlay() {
        try {
          if (rangeOverviewChart !== curOverviewChart) return;
          if (typeof window === 'undefined' || typeof window.__kexoGetChangePinsRecent !== 'function') return;
          window.__kexoGetChangePinsRecent(120, false).then(function (pins) {
            try {
              if (rangeOverviewChart !== curOverviewChart) return;
              if (!pins || !Array.isArray(pins) || !pins.length) return;
              if (!labels || !labels.length) return;
              var idx = new Map();
              for (var i = 0; i < labels.length; i++) {
                var key = labels[i] != null ? String(labels[i]) : '';
                if (!key) continue;
                if (!idx.has(key)) idx.set(key, i);
              }
              var ann = [];
              for (var j = 0; j < pins.length; j++) {
                var p = pins[j] || {};
                var ts = p.event_ts != null ? Number(p.event_ts) : NaN;
                if (!Number.isFinite(ts)) continue;
                var cand = bucket === 'hour' ? shortTimeLabel(ts) : shortDateTimeLabel(ts);
                if (!cand) continue;
                if (!idx.has(cand)) continue;
                var text = p.title != null ? String(p.title).trim() : '';
                if (text.length > 22) text = text.slice(0, 21) + '…';
                if (!text) text = 'Pin';
                ann.push({
                  x: cand,
                  borderColor: 'rgba(15,23,42,0.35)',
                  label: {
                    text: text,
                    borderColor: 'rgba(15,23,42,0.55)',
                    style: { background: 'rgba(15,23,42,0.75)', color: '#fff', fontSize: '10px', fontWeight: 500 },
                    offsetY: -6,
                  },
                });
              }
              if (!ann.length) return;
              try { curOverviewChart.updateOptions({ annotations: { xaxis: ann } }, false, true); } catch (_) {}
            } catch (_) {}
          });
        } catch (_) {}
      }
      if (overviewRenderPromise && typeof overviewRenderPromise.then === 'function') {
        overviewRenderPromise.then(function () { try { setTimeout(applyChangePinsOverlay, 0); } catch (_) {} }).catch(function () {});
      } else {
        try { setTimeout(applyChangePinsOverlay, 0); } catch (_) {}
      }
      var labelEl = document.getElementById('sessions-overview-bucket-label');
      if (labelEl && PAGE === 'sales') {
        var bucketLabel = bucket === 'hour' ? 'By hour' : bucket === 'month' ? 'By month' : 'By day';
        labelEl.textContent = bucketLabel;
        labelEl.removeAttribute('aria-hidden');
      } else if (labelEl) {
        labelEl.textContent = '';
        labelEl.setAttribute('aria-hidden', 'true');
      }
    }

    function refreshSessionsOverviewChart(options) {
      var el = document.getElementById('sessions-overview-chart');
      if (!el) return Promise.resolve(null);
      options = options || {};
      var force = !!options.force;
      var rangeKey = getStatsRange();
      var cacheKey = (PAGE || 'page') + '|' + rangeKey;
      if (!force && rangeOverviewChart && rangeOverviewChartKey === cacheKey) return Promise.resolve(null);
      if (rangeOverviewChartInFlight) return rangeOverviewChartInFlight;
      var url = API + '/api/dashboard-series?range=' + encodeURIComponent(rangeKey) + (force ? ('&force=1&_=' + Date.now()) : '');
      rangeOverviewChartInFlight = fetchWithTimeout(url, { credentials: 'same-origin', cache: force ? 'no-store' : 'default' }, 20000)
        .then(function(r) { return (r && r.ok) ? r.json() : null; })
        .then(function(data) {
          renderSessionsOverviewChart(data || null, cacheKey);
          return data;
        })
        .catch(function() { return null; })
        .finally(function() { rangeOverviewChartInFlight = null; });
      return rangeOverviewChartInFlight;
    }

    function refreshSessionPageCharts(options) {
      if (document.getElementById('live-online-chart')) return refreshLiveOnlineChart(options || {});
      if (document.getElementById('sessions-overview-chart')) return refreshSessionsOverviewChart(options || {});
      return Promise.resolve(null);
    }
    try { window.refreshLiveOnlineChart = refreshLiveOnlineChart; } catch (_) {}

    function setAbandonedCartsChartTitle(totalGbp) {
      var titleEl = document.getElementById('abandoned-carts-chart-title');
      if (!titleEl) return;
      var n = totalGbp != null ? Number(totalGbp) : NaN;
      if (!Number.isFinite(n)) {
        titleEl.textContent = '\u00A3\u2014';
        return;
      }
      titleEl.textContent = formatRevenue(n) || '\u00A3\u2014';
    }

    function renderAbandonedCartsChart(data, cacheKey) {
      var el = document.getElementById('abandoned-carts-chart');
      if (!el) return;
      var chartKey = 'abandoned-carts-chart';
      if (!isChartEnabledByUiConfig(chartKey, true)) {
        try {
          if (el.__kexoChartInstance) {
            try { el.__kexoChartInstance.destroy(); } catch (_) {}
            el.__kexoChartInstance = null;
          }
        } catch (_) {}
        el.innerHTML = '';
        abandonedCartsChart = null;
        abandonedCartsChartKey = String(cacheKey || '');
        setAbandonedCartsChartTitle(null);
        return;
      }

      var series = data && Array.isArray(data.series) ? data.series : [];
      var bucket = (data && data.bucket === 'day') ? 'day' : 'hour';
      var categories = series.map(function(p) { return bucket === 'day' ? shortDayLabel(p && p.ts) : shortTimeLabel(p && p.ts); });
      var nums = series.map(function(p) {
        var n = p && p.abandoned != null ? Number(p.abandoned) : 0;
        return Number.isFinite(n) ? Math.max(0, Math.trunc(n)) : 0;
      });

      var rawMode = chartModeFromUiConfig(chartKey, 'line') || 'line';
      var showEndLabels = rawMode === 'multi-line-labels';
      var mode = rawMode === 'multi-line-labels' ? 'line' : rawMode;
      var palette = chartColorsFromUiConfig(chartKey, ['#ef4444', '#f59e34']);
      var cartColor = palette[0] || '#ef4444';
      var checkoutColor = palette[1] || '#f59e34';
      var isCheckout = normalizeAbandonedMode(abandonedMode) === 'checkout';
      var colors = [isCheckout ? checkoutColor : cartColor];

      try {
        abandonedCartsChart = window.kexoRenderApexChart({
          chartKey: chartKey,
          containerEl: el,
          categories: categories,
          series: [{ name: abandonedModeDisplayLabel(abandonedMode), data: nums }],
          mode: mode,
          colors: colors,
          height: 280,
          showEndLabels: showEndLabels,
          chartStyle: chartStyleFromUiConfig(chartKey),
          advancedApexOverride: chartAdvancedOverrideFromUiConfig(chartKey, mode),
        });
      } catch (_) {}

      abandonedCartsChartKey = String(cacheKey || '');
      setAbandonedCartsChartTitle(data && data.totalAbandonedGbp != null ? Number(data.totalAbandonedGbp) : null);
    }

    function abandonedCartsSeriesCachePut(cacheKey, data) {
      var k = String(cacheKey || '');
      if (!k) return;
      if (data == null) return;
      abandonedCartsSeriesCache[k] = data;
      var idx = abandonedCartsSeriesCacheOrder.indexOf(k);
      if (idx >= 0) abandonedCartsSeriesCacheOrder.splice(idx, 1);
      abandonedCartsSeriesCacheOrder.push(k);
      while (abandonedCartsSeriesCacheOrder.length > ABANDONED_CARTS_SERIES_CACHE_MAX) {
        var drop = abandonedCartsSeriesCacheOrder.shift();
        if (drop) {
          try { delete abandonedCartsSeriesCache[drop]; } catch (_) { abandonedCartsSeriesCache[drop] = null; }
        }
      }
    }

    function prefetchAbandonedCartsSeries(rangeKey, mode) {
      try {
        if (PAGE !== 'abandoned-carts') return null;
        var rk = String(rangeKey || '').trim().toLowerCase();
        if (!rk) return null;
        var m = normalizeAbandonedMode(mode);
        var cacheKey = rk + '|' + m;
        if (abandonedCartsSeriesCache && abandonedCartsSeriesCache[cacheKey]) return null;
        if (abandonedCartsSeriesPrefetchInFlight && abandonedCartsSeriesPrefetchInFlight[cacheKey]) return abandonedCartsSeriesPrefetchInFlight[cacheKey];

        var url =
          API + '/api/abandoned-carts/series?range=' + encodeURIComponent(rk) +
          '&timezone=' + encodeURIComponent(tz) +
          '&mode=' + encodeURIComponent(m) +
          '&_=' + Date.now();

        abandonedCartsSeriesPrefetchInFlight[cacheKey] = fetchWithTimeout(url, { credentials: 'same-origin', cache: 'no-store' }, 20000)
          .then(function(r) { return (r && r.ok) ? r.json() : null; })
          .then(function(data) {
            if (data != null) abandonedCartsSeriesCachePut(cacheKey, data);
            return data;
          })
          .catch(function() { return null; })
          .finally(function() {
            try { delete abandonedCartsSeriesPrefetchInFlight[cacheKey]; } catch (_) { abandonedCartsSeriesPrefetchInFlight[cacheKey] = null; }
          });

        return abandonedCartsSeriesPrefetchInFlight[cacheKey];
      } catch (_) {
        return null;
      }
    }

    function refreshAbandonedCartsChart(options) {
      var el = document.getElementById('abandoned-carts-chart');
      if (!el) return Promise.resolve(null);
      options = options || {};
      var force = !!options.force;
      var rangeKey = normalizeRangeKeyForApi(dateRange);
      var modeKey = String(normalizeAbandonedMode(abandonedMode));
      var cacheKey = rangeKey + '|' + modeKey;
      if (!force && abandonedCartsChartKey === cacheKey && abandonedCartsChart) return Promise.resolve(null);
      if (!force && abandonedCartsSeriesCache && abandonedCartsSeriesCache[cacheKey]) {
        try { renderAbandonedCartsChart(abandonedCartsSeriesCache[cacheKey], cacheKey); } catch (_) {}
        try { prefetchAbandonedCartsSeries(rangeKey, modeKey === 'checkout' ? 'cart' : 'checkout'); } catch (_) {}
        return Promise.resolve(abandonedCartsSeriesCache[cacheKey]);
      }
      if (abandonedCartsChartInFlight && abandonedCartsChartInFlightKey === cacheKey) return abandonedCartsChartInFlight;

      var url =
        API + '/api/abandoned-carts/series?range=' + encodeURIComponent(rangeKey) +
        '&timezone=' + encodeURIComponent(tz) +
        '&mode=' + encodeURIComponent(modeKey) +
        '&_=' + Date.now();

      var reqSeq = ++abandonedCartsChartReqSeq;
      abandonedCartsChartInFlightKey = cacheKey;
      var p = fetchWithTimeout(url, { credentials: 'same-origin', cache: 'no-store' }, 20000)
        .then(function(r) { return (r && r.ok) ? r.json() : null; })
        .then(function(data) {
          if (reqSeq !== abandonedCartsChartReqSeq) return null;
          renderAbandonedCartsChart(data || null, cacheKey);
          if (data != null) abandonedCartsSeriesCachePut(cacheKey, data);
          try { prefetchAbandonedCartsSeries(rangeKey, modeKey === 'checkout' ? 'cart' : 'checkout'); } catch (_) {}
          return data;
        })
        .catch(function() { return null; })
        .finally(function() {
          if (abandonedCartsChartInFlight === p) {
            abandonedCartsChartInFlightKey = '';
            abandonedCartsChartInFlight = null;
          }
        });

      abandonedCartsChartInFlight = p;
      return p;
    }

    function clearGridTableBodyMessageState(tbody) {
      if (!tbody || !tbody.closest) return;
      var table = tbody.closest('.grid-table');
      if (!table) return;
      table.classList.remove('kexo-grid-empty-state-active');
      try {
        var block = table.querySelector('.kexo-grid-empty-state');
        if (block && block.parentNode) block.parentNode.removeChild(block);
      } catch (_) {}
    }

    function setGridTableBodyMessage(tbody, message, options) {
      if (!tbody) return;
      var msg = String(message == null ? '' : message).trim() || '\u2014';
      var opts = options && typeof options === 'object' ? options : {};
      var useBlock = !!opts.useBlock;
      clearGridTableBodyMessageState(tbody);
      if (useBlock && tbody.closest) {
        var table = tbody.closest('.grid-table');
        if (table) {
          tbody.innerHTML = '';
          table.classList.add('kexo-grid-empty-state-active');
          var emptyBlock = document.createElement('div');
          emptyBlock.className = 'kexo-grid-empty-state';
          emptyBlock.textContent = msg;
          table.appendChild(emptyBlock);
          return;
        }
      }
      tbody.innerHTML = '<div class="grid-row" role="row"><div class="grid-cell empty span-all" role="cell">' + escapeHtml(msg) + '</div></div>';
    }

    function renderAbandonedCartsTopCountries(payload) {
      var tbody = document.getElementById('abandoned-carts-countries-body');
      if (!tbody) return;
      var rows = payload && Array.isArray(payload.rows) ? payload.rows : [];
      if (!rows.length) {
        setGridTableBodyMessage(tbody, 'No data', { useBlock: true });
        return;
      }
      clearGridTableBodyMessageState(tbody);
      tbody.innerHTML = rows.slice(0, 5).map(function(r) {
        var code = (r && r.country != null ? String(r.country) : 'XX').toUpperCase().slice(0, 2);
        var label = countryLabel(code);
        var abandoned = r && r.abandoned != null ? Math.max(0, Math.trunc(Number(r.abandoned) || 0)) : 0;
        var checkout = r && r.checkout_sessions != null ? Math.max(0, Math.trunc(Number(r.checkout_sessions) || 0)) : 0;
        var pctVal = (r && r.abandoned_pct != null) ? pct(Number(r.abandoned_pct)) : '\u2014';
        var valueGbp = (r && r.abandoned_value_gbp != null) ? Number(r.abandoned_value_gbp) : null;
        var value = (valueGbp != null && Number.isFinite(valueGbp)) ? formatRevenueTableHtml(valueGbp) : '\u2014';
        var flag = flagImg(code, label);
        var labelHtml = '<span class="country-label">' + escapeHtml(label) + '</span>';
        return '<div class="grid-row" role="row">' +
          '<div class="grid-cell" role="cell"><span class="country-cell">' + flag + labelHtml + '</span></div>' +
          '<div class="grid-cell" role="cell">' + escapeHtml(formatSessions(abandoned)) + '</div>' +
          '<div class="grid-cell" role="cell">' + escapeHtml(formatSessions(checkout)) + '</div>' +
          '<div class="grid-cell" role="cell">' + escapeHtml(pctVal) + '</div>' +
          '<div class="grid-cell" role="cell">' + value + '</div>' +
        '</div>';
      }).join('');
    }

    function renderAbandonedCartsTopCountryProducts(payload) {
      var tbody = document.getElementById('abandoned-carts-country-products-body');
      if (!tbody) return;
      var rows = payload && Array.isArray(payload.rows) ? payload.rows : [];
      if (!rows.length) {
        setGridTableBodyMessage(tbody, 'No data', { useBlock: true });
        return;
      }
      clearGridTableBodyMessageState(tbody);
      tbody.innerHTML = rows.slice(0, 5).map(function(r) {
        var iso = (r && r.country != null ? String(r.country) : 'XX').toUpperCase().slice(0, 2);
        var label = countryLabel(iso);
        var productTitle = (r && r.product_title != null) ? String(r.product_title).trim() : '\u2014';
        var productHandle = (r && r.product_handle != null) ? String(r.product_handle).trim().toLowerCase() : '';
        var mainBase = getMainBaseUrl();
        var productUrl = (mainBase && productHandle) ? (mainBase + '/products/' + encodeURIComponent(productHandle)) : '#';

        var abandoned = r && r.abandoned != null ? Math.max(0, Math.trunc(Number(r.abandoned) || 0)) : 0;
        var checkout = r && r.checkout_sessions != null ? Math.max(0, Math.trunc(Number(r.checkout_sessions) || 0)) : 0;
        var pctVal = (r && r.abandoned_pct != null) ? pct(Number(r.abandoned_pct)) : '\u2014';
        var valueGbp = (r && r.abandoned_value_gbp != null) ? Number(r.abandoned_value_gbp) : null;
        var value = (valueGbp != null && Number.isFinite(valueGbp)) ? formatRevenueTableHtml(valueGbp) : '\u2014';
        var flag = flagImg(iso, label);

        var canOpen = !!productHandle;
        var titleLink = canOpen
          ? '<a class="kexo-product-link js-product-modal-link" href="' + escapeHtml(productUrl) + '" target="_blank" rel="noopener"' +
              (productHandle ? (' data-product-handle="' + escapeHtml(productHandle) + '"') : '') +
              (productTitle ? (' data-product-title="' + escapeHtml(productTitle) + '"') : '') +
            '>' + escapeHtml(productTitle) + '</a>'
          : escapeHtml(productTitle);

        var labelHtml =
          '<span class="country-product-stack">' +
            '<span class="country-label">' + escapeHtml(label) + '</span>' +
            '<span class="country-product-label">' + titleLink + '</span>' +
          '</span>';

        return '<div class="grid-row" role="row">' +
          '<div class="grid-cell" role="cell"><span class="country-cell">' + flag + labelHtml + '</span></div>' +
          '<div class="grid-cell" role="cell">' + escapeHtml(formatSessions(abandoned)) + '</div>' +
          '<div class="grid-cell" role="cell">' + escapeHtml(formatSessions(checkout)) + '</div>' +
          '<div class="grid-cell" role="cell">' + escapeHtml(pctVal) + '</div>' +
          '<div class="grid-cell" role="cell">' + value + '</div>' +
        '</div>';
      }).join('');
    }

    function refreshAbandonedCartsTopTables(options) {
      if (PAGE !== 'abandoned-carts') return Promise.resolve(null);
      options = options || {};
      var force = !!options.force;
      var rangeKey = normalizeRangeKeyForApi(dateRange);
      var cacheKey = rangeKey + '|' + String(normalizeAbandonedMode(abandonedMode));
      if (!force && abandonedCartsTopCacheKey === cacheKey && abandonedCartsTopCountriesCache && abandonedCartsTopCountryProductsCache) {
        renderAbandonedCartsTopCountries(abandonedCartsTopCountriesCache);
        renderAbandonedCartsTopCountryProducts(abandonedCartsTopCountryProductsCache);
        return Promise.resolve(null);
      }
      if (abandonedCartsTopInFlight) return abandonedCartsTopInFlight;

      var countriesBody = document.getElementById('abandoned-carts-countries-body');
      var productsBody = document.getElementById('abandoned-carts-country-products-body');
      setGridTableBodyMessage(countriesBody, 'Loading\u2026');
      setGridTableBodyMessage(productsBody, 'Loading\u2026');

      var qs =
        'range=' + encodeURIComponent(rangeKey) +
        '&timezone=' + encodeURIComponent(tz) +
        '&mode=' + encodeURIComponent(normalizeAbandonedMode(abandonedMode)) +
        '&limit=5&_=' + Date.now();

      var urlCountries = API + '/api/abandoned-carts/top-countries?' + qs;
      var urlCountryProducts = API + '/api/abandoned-carts/top-country-products?' + qs;

      abandonedCartsTopInFlight = Promise.all([
        fetchWithTimeout(urlCountries, { credentials: 'same-origin', cache: 'no-store' }, 20000).then(function(r) { return (r && r.ok) ? r.json() : null; }).catch(function() { return null; }),
        fetchWithTimeout(urlCountryProducts, { credentials: 'same-origin', cache: 'no-store' }, 20000).then(function(r) { return (r && r.ok) ? r.json() : null; }).catch(function() { return null; }),
      ])
        .then(function(arr) {
          var a = arr && arr[0] ? arr[0] : { rows: [] };
          var b = arr && arr[1] ? arr[1] : { rows: [] };
          abandonedCartsTopCacheKey = cacheKey;
          abandonedCartsTopCountriesCache = a;
          abandonedCartsTopCountryProductsCache = b;
          renderAbandonedCartsTopCountries(a);
          renderAbandonedCartsTopCountryProducts(b);
          return { countries: a, countryProducts: b };
        })
        .finally(function() { abandonedCartsTopInFlight = null; });

      return abandonedCartsTopInFlight;
    }

    function refreshAbandonedCarts(options) {
      if (PAGE !== 'abandoned-carts') return Promise.resolve(null);
      options = options || {};
      syncAbandonedModeUi();
      return Promise.all([
        refreshAbandonedCartsChart(options),
        refreshAbandonedCartsTopTables(options),
        fetchSessions(),
      ]);
    }

    function fetchSessions() {
      if (liveRefreshInFlight) return liveRefreshInFlight;
      var isLive = dateRange === 'live';
      var build = startReportBuild({
        key: 'sessions',
        overlayId: 'sessions-loading-overlay',
        title: isLive ? 'Preparing live sessions' : 'Preparing sessions table',
      });
      build.step(isLive ? 'Loading active visitors' : 'Loading selected date range');
      var url;
      if (isLive) {
        url = API + '/api/sessions?filter=active&_=' + Date.now();
      } else {
        var limit = rowsPerPage;
        var offset = (currentPage - 1) * rowsPerPage;
        if (PAGE === 'abandoned-carts') {
          url = API + '/api/abandoned-carts/sessions?range=' + encodeURIComponent(normalizeRangeKeyForApi(dateRange)) + '&limit=' + limit + '&offset=' + offset + '&timezone=' + encodeURIComponent(tz) + '&mode=' + encodeURIComponent(normalizeAbandonedMode(abandonedMode)) + '&_=' + Date.now();
        } else {
          url = API + '/api/sessions?range=' + encodeURIComponent(normalizeRangeKeyForApi(dateRange)) + '&limit=' + limit + '&offset=' + offset + '&timezone=' + encodeURIComponent(tz) + '&_=' + Date.now();
        }
      }
      var SESSIONS_FETCH_TIMEOUT_MS = 15000;
      if (_fetchAbortControllers.sessions) { try { _fetchAbortControllers.sessions.abort(); } catch (_) {} }
      var ac = typeof AbortController !== 'undefined' ? new AbortController() : null;
      _fetchAbortControllers.sessions = ac;
      var sessionsTimeoutId = null;
      if (ac && SESSIONS_FETCH_TIMEOUT_MS > 0) {
        sessionsTimeoutId = setTimeout(function() {
          try { ac.abort(); } catch (_) {}
        }, SESSIONS_FETCH_TIMEOUT_MS);
      }
      var sessionsFetchStart = typeof performance !== 'undefined' && performance.now ? performance.now() : Date.now();
      liveRefreshInFlight = fetch(url, { credentials: 'same-origin', cache: 'no-store', signal: ac ? ac.signal : undefined })
        .then(function(r) {
          if (!r.ok) {
            build.step('Could not load sessions');
            sessionsLoadError = r.status === 502 ? 'Server error (502). Try again or refresh.' : 'Server error (' + r.status + ').';
            sessions = [];
            sessionsTotal = null;
            renderTable();
            return null;
          }
          return r.json();
        })
        .then(function(data) {
          if (data == null) return null;
          sessionsLoadError = null;
          build.step('Analyzing session activity');
          if (isLive) {
            sessionsTotal = null;
            var next = data.sessions || [];
            var cutoff = Date.now() - ACTIVE_WINDOW_MS;
            var arrivedCutoff = Date.now() - ARRIVED_WINDOW_MS;
            next = next.filter(function(s) {
              return (s.last_seen != null && s.last_seen >= cutoff) &&
                (s.started_at != null && s.started_at >= arrivedCutoff);
            });
            next.sort(function(a, b) { return (b.last_seen || 0) - (a.last_seen || 0); });
            var listChanged = !sessionIdsEqual(sessions, next);
            sessions = next;
            if (listChanged) currentPage = 1;
          } else {
            sessions = data.sessions || [];
            sessionsTotal = typeof data.total === 'number' ? data.total : sessions.length;
          }
          lastSessionsMode = isLive ? 'live' : 'range';
          lastSessionsFetchedAt = Date.now();
          if (isLive) nextLiveAt = Date.now() + LIVE_REFRESH_MS;
          else if (dateRange === 'today' || dateRange === 'sales' || dateRange === '1h') nextRangeAt = Date.now() + RANGE_REFRESH_MS;
          lastUpdateTime = new Date();
          updateServerTimeDisplay();
          build.step('Building sessions table');
          renderTable();
          updateKpis();
          try { refreshSessionPageCharts({ force: isLive }); } catch (_) {}
          return sessions;
        })
        .catch(function(err) {
          try {
            window.__kexoPerfMetrics = window.__kexoPerfMetrics || {};
            if (err && err.name === 'AbortError') window.__kexoPerfMetrics.sessionsFetchTimeoutCount = (window.__kexoPerfMetrics.sessionsFetchTimeoutCount || 0) + 1;
          } catch (_) {}
          if (err && err.name === 'AbortError') return null;
          try { if (typeof window.kexoCaptureError === 'function') window.kexoCaptureError(err, { context: 'sessionsFetch', page: PAGE }); } catch (_) {}
          build.step('Could not load sessions');
          sessionsLoadError = 'Could not load sessions. Check connection or refresh.';
          sessions = [];
          sessionsTotal = null;
          currentPage = 1;
          renderTable();
          return null;
        })
        .finally(function() {
          try {
            if (typeof performance !== 'undefined' && performance.now && sessionsFetchStart != null) {
              window.__kexoPerfMetrics = window.__kexoPerfMetrics || {};
              window.__kexoPerfMetrics.lastSessionsFetchMs = Math.round((performance.now() - sessionsFetchStart) * 100) / 100;
            }
          } catch (_) {}
          if (sessionsTimeoutId != null) { clearTimeout(sessionsTimeoutId); sessionsTimeoutId = null; }
          liveRefreshInFlight = null;
          if (_fetchAbortControllers.sessions === ac) _fetchAbortControllers.sessions = null;
          build.finish();
        });
      return liveRefreshInFlight;
    }

    function scheduleOnlineCountPoll(ms) {
      // Don't poll while hidden; resume on visibility.
      bindOnlineCountVisibilityGate();
      if (onlineCountPollTimer) {
        try { clearTimeout(onlineCountPollTimer); } catch (_) {}
        onlineCountPollTimer = null;
      }
      if (onlineCountAuthBlocked) return;
      var delay = (typeof ms === 'number' && isFinite(ms) && ms >= 0) ? ms : ONLINE_COUNT_POLL_MS;
      if (!isDocVisible()) {
        onlineCountPollPendingMs = delay;
        return;
      }
      onlineCountPollTimer = setTimeout(function() {
        onlineCountPollTimer = null;
        if (!isDocVisible()) {
          onlineCountPollPendingMs = ONLINE_COUNT_POLL_MS;
          return;
        }
        try { updateKpis(); } catch (_) {}
      }, delay);
    }

    function fetchOnlineCount() {
      bindOnlineCountVisibilityGate();
      if (!isDocVisible()) {
        onlineCountPollPendingMs = 0;
        return;
      }
      if (onlineCountInFlight || onlineCountAuthBlocked) return;
      onlineCountInFlight = true;
      if (_fetchAbortControllers.onlineCount) { try { _fetchAbortControllers.onlineCount.abort(); } catch (_) {} }
      var ac = typeof AbortController !== 'undefined' ? new AbortController() : null;
      _fetchAbortControllers.onlineCount = ac;
      fetch(API + '/api/sessions?filter=active&countOnly=1&_=' + Date.now(), { credentials: 'same-origin', cache: 'no-store', signal: ac ? ac.signal : undefined })
        .then(function(r) {
          if (!r || !r.ok) {
            if (r && r.status === 401) onlineCountAuthBlocked = true;
            return null;
          }
          return r.json();
        })
        .then(function(data) {
          if (data != null && typeof data.count === 'number') {
            lastOnlineCount = data.count;
            onlineCountLastFetchedAt = Date.now();
          }
        })
        .catch(function(err) {
          try { if (typeof window.kexoCaptureError === 'function') window.kexoCaptureError(err, { context: 'onlineCountFetch', page: PAGE }); } catch (_) {}
        })
        .then(function() {
          onlineCountInFlight = false;
          if (_fetchAbortControllers.onlineCount === ac) _fetchAbortControllers.onlineCount = null;
          if (onlineCountAuthBlocked) {
            if (onlineCountPollTimer) {
              try { clearTimeout(onlineCountPollTimer); } catch (_) {}
              onlineCountPollTimer = null;
            }
          } else {
            var nextMs = onlineCountLastFetchedAt ? ONLINE_COUNT_POLL_MS : ONLINE_COUNT_RETRY_MS;
            scheduleOnlineCountPoll(nextMs);
          }
          updateKpis();
        });
    }

    function updateKpis() {
      bindOnlineCountVisibilityGate();
      if (!isDocVisible()) return;
      const el = document.getElementById('online-count');
      const spinner = document.getElementById('online-count-spinner');
      const iconEl = document.getElementById('kexo-online-icon');
      const liveNowCountEl = document.getElementById('live-online-now-count');
      if (!el && !liveNowCountEl) return;
      function showLiveNowCount(n) {
        if (!liveNowCountEl) return;
        var safe = Number.isFinite(Number(n)) ? Math.max(0, Math.trunc(Number(n))) : 0;
        liveNowCountEl.textContent = String(safe);
      }
      function showSpinner() {
        if (spinner) { spinner.classList.remove('is-hidden'); }
        if (el) el.classList.add('is-hidden');
        if (iconEl) { iconEl.classList.add('kexo-online-icon--offline'); iconEl.classList.remove('kexo-online-icon--online'); }
      }
      function showCount(n) {
        if (spinner) { spinner.classList.add('is-hidden'); }
        if (el) {
          el.classList.remove('is-hidden');
          el.textContent = String(n);
        }
        if (iconEl) {
          iconEl.classList.remove('kexo-online-icon--offline', 'kexo-online-icon--online');
          iconEl.classList.add(n > 0 ? 'kexo-online-icon--online' : 'kexo-online-icon--offline');
        }
        showLiveNowCount(n);
      }
      if (activeMainTab === 'spy' && dateRange === 'live') {
        if (lastSessionsMode !== 'live') {
          showSpinner();
          fetchSessions();
          return;
        }
        const active = sessions.filter(s => s.last_seen >= Date.now() - ACTIVE_WINDOW_MS).length;
        showCount(active);
        return;
      }
      // Online is real people online right now; show count regardless of date range (Today, Yesterday, etc.)
      if (onlineCountAuthBlocked) {
        // Session/auth is no longer valid (401). Stop auto-polling to avoid API spam.
        showCount(lastOnlineCount != null ? lastOnlineCount : 0);
        return;
      }
      var onlineCountIsFresh = onlineCountLastFetchedAt > 0 && (Date.now() - onlineCountLastFetchedAt) < ONLINE_COUNT_POLL_MS;
      if (lastOnlineCount != null) {
        showCount(lastOnlineCount);
        if (!onlineCountIsFresh) fetchOnlineCount();
      } else {
        showSpinner();
        fetchOnlineCount();
      }
    }

    // Visibility gate for online count polling (avoids timer bursts on tab resume).
    var onlineCountPollPendingMs = null;
    var onlineCountVisibilityBound = false;
    function isDocVisible() {
      try { return !document || !document.visibilityState || document.visibilityState === 'visible'; } catch (_) { return true; }
    }
    function pauseOnlineCountPolling() {
      if (onlineCountPollTimer) {
        try { clearTimeout(onlineCountPollTimer); } catch (_) {}
        onlineCountPollTimer = null;
      }
      try { if (_fetchAbortControllers && _fetchAbortControllers.onlineCount) _fetchAbortControllers.onlineCount.abort(); } catch (_) {}
    }
    function bindOnlineCountVisibilityGate() {
      if (onlineCountVisibilityBound) return;
      onlineCountVisibilityBound = true;
      try {
        document.addEventListener('visibilitychange', function() {
          if (!isDocVisible()) {
            onlineCountPollPendingMs = ONLINE_COUNT_POLL_MS;
            pauseOnlineCountPolling();
            return;
          }
          var pending = onlineCountPollPendingMs;
          onlineCountPollPendingMs = null;
          if (onlineCountAuthBlocked) return;
          scheduleOnlineCountPoll(typeof pending === 'number' ? pending : 0);
        });
      } catch (_) {}
      try {
        window.addEventListener('pageshow', function(ev) {
          if (ev && ev.persisted) {
            if (onlineCountAuthBlocked) return;
            scheduleOnlineCountPoll(0);
          }
        });
      } catch (_) {}
    }

    function cfSection(title, value) {
      const v = value != null && String(value).trim() !== '' ? String(value).trim() : null;
      return '<div class="cf-row"><strong>' + escapeHtml(title) + ':</strong> ' + (v ? escapeHtml(v) : '\u2014') + '</div>';
    }

    function formatBrowserLabel(session) {
      const s = session || {};
      const key = s.ua_browser != null ? String(s.ua_browser).trim().toLowerCase() : '';
      const vRaw = s.ua_browser_version != null ? String(s.ua_browser_version).trim() : '';
      const version = vRaw && vRaw.length > 16 ? vRaw.slice(0, 16) : vRaw;
      if (!key) return null;
      const names = {
        chrome: 'Chrome',
        safari: 'Safari',
        edge: 'Edge',
        firefox: 'Firefox',
        opera: 'Opera',
        ie: 'Internet Explorer',
        samsung: 'Samsung Internet',
        other: 'Other',
      };
      const name = names[key] || (key ? (key.charAt(0).toUpperCase() + key.slice(1)) : '');
      if (!name) return null;
      return version ? (name + ' ' + version) : name;
    }

    function buildSidePanelCf(session) {
      const s = session || {};
      const blocks = [
        ['Country & Device', cfSection('Country', s.cf_country || s.country_code) + cfSection('Device', s.device) + cfSection('Browser', formatBrowserLabel(s))],
        ['Referrer / Entry', cfSection('Referrer', s.referrer) + cfSection('Entry URL', s.entry_url)],
        ['City', cfSection('City', s.cf_city || s.city || null)]
      ];
      return blocks.map(function (b) { return '<div class="side-panel-cf-block"><div class="side-panel-cf-subtitle">' + escapeHtml(b[0]) + '</div>' + b[1] + '</div>'; }).join('');
    }

    function ensureSidePanelBackdrop() {
      var panel = document.getElementById('side-panel');
      if (!panel) return null;
      var backdrop = document.getElementById('side-panel-backdrop');
      if (!backdrop) {
        backdrop = document.createElement('div');
        backdrop.id = 'side-panel-backdrop';
        backdrop.className = 'side-panel-backdrop is-hidden';
        document.body.appendChild(backdrop);
      }
      if (!backdrop.dataset.bound) {
        backdrop.addEventListener('click', function () { closeSidePanel(); });
        backdrop.dataset.bound = '1';
      }
      return backdrop;
    }

    function closeSidePanel() {
      var panel = document.getElementById('side-panel');
      if (panel) panel.classList.add('is-hidden');
      var backdrop = document.getElementById('side-panel-backdrop');
      if (backdrop) backdrop.classList.add('is-hidden');
      document.body.classList.remove('side-panel-open');
    }

    function sideLookupHref(q) {
      var qq = q != null ? String(q).trim() : '';
      if (!qq) return '/tools/click-order-lookup';
      try {
        var shop = getShopParam() || shopForSalesFallback || '';
        var p = new URLSearchParams();
        if (shop) p.set('shop', shop);
        p.set('q', qq);
        return '/tools/click-order-lookup?' + p.toString();
      } catch (_) {
        return '/tools/click-order-lookup?q=' + encodeURIComponent(qq);
      }
    }

    function buildSideLookupIdsHtml(resolved, sessionId, options) {
      var r = resolved && typeof resolved === 'object' ? resolved : {};
      var sid = sessionId != null ? String(sessionId) : '';
      var opts = options && typeof options === 'object' ? options : {};
      var loading = !!opts.loading;
      var out = '';

      function addRow(label, value) {
        var v = value != null ? String(value).trim() : '';
        if (!v) return;
        out += '' +
          '<div class="side-panel-detail-row side-panel-lookup-id-row">' +
            '<span class="side-panel-label">' + escapeHtml(label) + '</span>' +
            '<span class="side-panel-value"><code>' + escapeHtml(v) + '</code>' +
              '<button type="button" class="btn btn-sm btn-outline-secondary ms-2 side-panel-copy-btn" data-side-copy="' + escapeHtml(v) + '">Copy</button>' +
            '</span>' +
          '</div>';
      }

      var clickId = sid || (r.session_id != null ? String(r.session_id) : '');
      var openQ = clickId || (r.order_id != null ? String(r.order_id) : '') || (r.checkout_token != null ? String(r.checkout_token) : '') || '';
      var href = sideLookupHref(openQ);
      out = '' +
        '<div class="side-panel-detail-row side-panel-lookup-open-row">' +
          '<span class="side-panel-label">Lookup</span>' +
          '<span class="side-panel-value">' +
            '<a href="' + escapeHtml(href) + '" target="_blank" rel="noopener">Open in Lookup</a>' +
            (loading ? '<span class="muted ms-2">Loading IDs\u2026</span>' : '') +
          '</span>' +
        '</div>';

      addRow('Click ID', clickId);
      addRow('Shopify order ID', r.order_id);
      addRow('Checkout token', r.checkout_token);
      addRow('Kexo order key', r.purchase_key);
      addRow('Visitor', r.visitor_id);
      return out;
    }

    function copyTextToClipboard(text) {
      var value = String(text == null ? '' : text);
      if (!value) return Promise.resolve(false);
      try {
        if (navigator && navigator.clipboard && typeof navigator.clipboard.writeText === 'function') {
          return navigator.clipboard.writeText(value).then(function () { return true; }).catch(function () { return false; });
        }
      } catch (_) {}
      try {
        var ta = document.createElement('textarea');
        ta.value = value;
        ta.setAttribute('readonly', 'readonly');
        ta.style.position = 'fixed';
        ta.style.top = '-9999px';
        ta.style.left = '-9999px';
        document.body.appendChild(ta);
        ta.select();
        ta.setSelectionRange(0, ta.value.length);
        var ok = document.execCommand('copy');
        document.body.removeChild(ta);
        return Promise.resolve(!!ok);
      } catch (_) {
        return Promise.resolve(false);
      }
    }

    // Shared Click & Order Lookup renderer (Tools page + side drawer).
    var clickOrderLookupUiReady = false;
    function ensureClickOrderLookupUi() {
      if (clickOrderLookupUiReady) return;
      clickOrderLookupUiReady = true;

      function esc(v) { return escapeHtml(v == null ? '' : String(v)); }
      function safeJsonPre(obj) { try { return JSON.stringify(obj, null, 2); } catch (_) { return String(obj); } }

      function copyLinkHtml(value) {
        var v = value != null ? String(value).trim() : '';
        if (!v) return '';
        return ' <a href="#" class="kexo-copy-link" data-kexo-copy="' + esc(v) + '">Copy</a>';
      }

      function ensureCopyLinksBound() {
        try {
          var root = document && document.documentElement ? document.documentElement : null;
          if (root && root.getAttribute('data-kexo-copy-links') === '1') return;
          if (root) root.setAttribute('data-kexo-copy-links', '1');
          document.addEventListener('click', function (e) {
            var target = e && e.target ? e.target : null;
            var a = target && target.closest ? target.closest('a.kexo-copy-link[data-kexo-copy]') : null;
            if (!a) return;
            try { e.preventDefault(); } catch (_) {}
            var txt = a.getAttribute('data-kexo-copy') || '';
            if (!txt) return;
            copyTextToClipboard(txt).then(function (ok) {
              var prev = a.getAttribute('data-kexo-copy-prev') || (a.textContent || 'Copy');
              try { a.setAttribute('data-kexo-copy-prev', prev); } catch (_) {}
              try { a.textContent = ok ? 'Copied' : 'Copy'; } catch (_) {}
              setTimeout(function () {
                try { a.textContent = prev; } catch (_) {}
              }, 900);
            });
          }, true);
        } catch (_) {}
      }

      function pickFraudEvalFromBundle(bundle) {
        var b = bundle && typeof bundle === 'object' ? bundle : null;
        if (!b || b.ok !== true || b.available !== true) return null;
        var pref = (b.session && b.session.evaluation) ? b.session
          : (b.purchase && b.purchase.evaluation) ? b.purchase
          : (b.order && b.order.evaluation) ? b.order
          : null;
        if (!pref || !pref.evaluation) return null;
        var ev = pref.evaluation || {};
        var an = pref.analysis || {};
        var score = ev.score != null ? Number(ev.score) : 0;
        if (!Number.isFinite(score)) score = 0;
        score = Math.max(0, Math.min(100, Math.trunc(score)));
        var risk = an && an.risk_level ? String(an.risk_level).trim() : '';
        if (!risk) risk = score >= (b.threshold != null ? Number(b.threshold) : 70) ? 'Medium' : 'Low';
        return {
          score: score,
          risk_level: risk || 'Unknown',
          triggered: !!ev.triggered,
          threshold: (b.threshold != null && Number.isFinite(Number(b.threshold))) ? Number(b.threshold) : null,
          summary: an && an.summary ? String(an.summary) : '',
          key_reasons: an && Array.isArray(an.key_reasons) ? an.key_reasons : [],
          flags: Array.isArray(ev.flags) ? ev.flags : [],
          evidence: (ev.evidence && typeof ev.evidence === 'object') ? ev.evidence : {},
        };
      }

      function gaugeToneFromRisk(riskLevel) {
        var r = String(riskLevel || '').trim().toLowerCase();
        if (r === 'high') return 'high';
        if (r === 'medium') return 'medium';
        if (r === 'low') return 'low';
        return 'unknown';
      }

      function renderFraudGaugeHtml(info, options) {
        var i = info && typeof info === 'object' ? info : null;
        var score = i && i.score != null ? Math.max(0, Math.min(100, Math.trunc(Number(i.score) || 0))) : 0;
        var triggered = !!(i && i.triggered === true);
        var label = (options && options.label) ? String(options.label) : 'Fraud Meter';
        var pct = String(score) + '%';
        var safety = Math.max(0, Math.min(100, 100 - score)); // 0 fraud => 100% safe
        var riskLabel = (safety <= 49) ? 'High' : (safety <= 75) ? 'Medium' : 'Low';
        var barClass = (safety <= 49) ? 'bg-danger' : (safety <= 75) ? 'bg-warning' : 'bg-success';
        var iconTone = (safety <= 49) ? 'high' : (safety <= 75) ? 'medium' : 'low';
        var statusIcon = (riskLabel === 'Low' && !triggered)
          ? (
              '<i class="fa-light fa-circle-check kexo-fraud-meter-status-icon is-ok"' +
                ' data-icon-key="table-icon-compliance-check" aria-hidden="true"></i>'
            )
          : (
              '<i class="fa-light fa-triangle-exclamation kexo-fraud-meter-status-icon is-warn tone-' + esc(iconTone) + '"' +
                ' data-icon-key="table-icon-compliance-warning" aria-hidden="true"></i>'
            );
        var aria = riskLabel + ' (' + pct + ' fraud score, ' + String(safety) + '% safe)';
        return '' +
          '<div class="kexo-kpi-chip kexo-fraud-meter-chip" data-kexo-fraud-meter="1" aria-label="' + esc(aria) + '">' +
            '<div class="subheader kexo-kpi-chip-label">' + esc(label) + '</div>' +
            '<div class="d-flex align-items-baseline">' +
              '<div class="h3 mb-0 me-2 kexo-kpi-chip-value">' + statusIcon + '<span class="kexo-fraud-meter-status-label">' + esc(riskLabel) + '</span></div>' +
              '<div class="me-auto">' +
                '<span class="kexo-kpi-chip-delta d-inline-flex align-items-center lh-1 is-flat">' + esc(pct) + '</span>' +
              '</div>' +
            '</div>' +
            '<div class="progress progress-sm kexo-kpi-chip-progress" role="progressbar" aria-valuenow="' + esc(String(safety)) + '" aria-valuemin="0" aria-valuemax="100">' +
              '<div class="progress-bar ' + esc(barClass) + '" style="width:' + esc(String(safety)) + '%"></div>' +
            '</div>' +
          '</div>';
      }

      function animateFraudGauges(root) {
        var scope = root && root.querySelectorAll ? root : document;
        var nodes = Array.from(scope.querySelectorAll('[data-kexo-gauge="1"]'));
        nodes.forEach(function (wrap) {
          try {
            if (!wrap || wrap.getAttribute('data-kexo-gauge-animated') === '1') return;
            wrap.setAttribute('data-kexo-gauge-animated', '1');
            var score = Number(wrap.getAttribute('data-score') || '0');
            if (!Number.isFinite(score)) score = 0;
            score = Math.max(0, Math.min(100, Math.trunc(score)));
            var path = wrap.querySelector('.kexo-fraud-gauge-progress');
            if (!path || !path.getTotalLength) return;
            var len = path.getTotalLength();
            path.style.strokeDasharray = String(len);
            path.style.strokeDashoffset = String(len);
            path.getBoundingClientRect(); // force layout
            var target = len * (1 - (score / 100));
            path.style.transition = 'stroke-dashoffset 900ms ease-out';
            requestAnimationFrame(function () { path.style.strokeDashoffset = String(target); });
          } catch (_) {}
        });
      }

      function renderIdsHtml(resolved, mode) {
        var r = resolved && typeof resolved === 'object' ? resolved : {};
        var rows = [
          { k: 'Kexo Click ID (session)', v: r.session_id, copy: true },
          { k: 'Shopify order ID', v: r.order_id, copy: true },
          { k: 'Checkout token', v: r.checkout_token, copy: true },
          { k: 'Kexo order key', v: r.purchase_key, copy: true },
          { k: 'Visitor ID', v: r.visitor_id, copy: false },
        ].filter(function (x) { return x && x.v != null && String(x.v).trim() !== ''; });
        if (!rows.length) return '<div class="text-muted">\u2014</div>';

        if (mode === 'drawer') {
          return rows.map(function (row) {
            var v = String(row.v);
            return '' +
              '<div class="side-panel-detail-row">' +
                '<span class="side-panel-label">' + esc(row.k) + '</span>' +
                '<span class="side-panel-value"><code>' + esc(v) + '</code>' + (row.copy ? copyLinkHtml(v) : '') + '</span>' +
              '</div>';
          }).join('');
        }

        var body = rows.map(function (row) {
          var v = String(row.v);
          return '<tr><th style="width:180px">' + esc(row.k) + '</th><td><code>' + esc(v) + '</code>' + (row.copy ? copyLinkHtml(v) : '') + '</td></tr>';
        }).join('');
        return '<div class="table-responsive"><table class="table table-sm table-vcenter mb-0"><tbody>' + body + '</tbody></table></div>';
      }

      function renderActivityHtml(events, mode) {
        var list = Array.isArray(events) ? events : [];
        if (!list.length) return '<div class="text-muted">No activity.</div>';
        var filtered = list.filter(function (e) { return e && e.type !== 'heartbeat'; }).slice().reverse(); // newest-first
        var items = filtered.slice(0, 30).map(function (e) {
          var path = (e.path || '').trim();
          if (!path && e.product_handle) path = '/products/' + (e.product_handle || '');
          if (path && !path.startsWith('/')) path = '/' + path;
          var pathLabel = path || (e.product_handle || '');
          var text = (formatTs(e.ts) || '\u2014') + ' ' + esc(e.type) + ' ' + esc(pathLabel) + (e.qty_delta != null ? (' \u2014 ' + esc(e.qty_delta)) : '');
          return '<li><span>' + text + '</span></li>';
        }).join('');
        return '<ul class="side-panel-events kexo-lookup-events">' + items + '</ul>';
      }

      function renderFraudHtml(fraudBundle, mode) {
        var b = fraudBundle && typeof fraudBundle === 'object' ? fraudBundle : null;
        if (!b) return '<div class="text-muted">Fraud scoring unavailable.</div>';
        if (b.ok !== true || b.available !== true) {
          if (b.available === false) return '<div class="text-muted">Fraud system unavailable.</div>';
          return '<div class="text-muted">Fraud data unavailable.</div>';
        }

        var picked = pickFraudEvalFromBundle(b);
        if (!picked) return '<div class="text-muted">No fraud evaluation yet.</div>';

        var gauge = renderFraudGaugeHtml(picked, { label: 'Fraud Meter' });
        var reasons = Array.isArray(picked.key_reasons) ? picked.key_reasons : [];
        var flags = Array.isArray(picked.flags) ? picked.flags : [];
        var reasonsHtml = reasons.length
          ? ('<ul class="kexo-fraud-reasons">' + reasons.slice(0, 6).map(function (r) { return '<li>' + esc(String(r)) + '</li>'; }).join('') + '</ul>')
          : '';
        var flagsHtml = flags.length
          ? ('<div class="kexo-fraud-flags">' + flags.slice(0, 10).map(function (f) { return '<span class="badge bg-azure-lt me-1 mb-1">' + esc(String(f)) + '</span>'; }).join('') + '</div>')
          : '<div class="text-muted">No flags recorded.</div>';
        var evidenceJson = safeJsonPre(picked.evidence || {});
        var evidenceDetails = '' +
          '<details class="kexo-fraud-evidence-details">' +
            '<summary class="text-muted">Show evidence snapshot</summary>' +
            '<pre class="mt-2 mb-0 kexo-fraud-evidence-pre" style="white-space:pre-wrap">' + esc(evidenceJson || '{}') + '</pre>' +
          '</details>';

        if (mode === 'drawer') {
          return '' +
            gauge +
            '<div class="side-panel-detail-row"><span class="side-panel-label">Summary</span><span class="side-panel-value">' + esc(picked.summary || '\u2014') + '</span></div>' +
            (reasonsHtml ? ('<div class="kexo-fraud-reasons-wrap">' + reasonsHtml + '</div>') : '') +
            '<div class="mt-2">' + flagsHtml + '</div>' +
            '<div class="mt-2">' + evidenceDetails + '</div>';
        }

        return '' +
          gauge +
          '<div class="mt-2">' +
            '<div class="text-muted small">Summary</div>' +
            '<div>' + esc(picked.summary || '\u2014') + '</div>' +
            (reasonsHtml ? ('<div class="mt-2">' + reasonsHtml + '</div>') : '') +
            '<div class="mt-2">' + flagsHtml + '</div>' +
            '<div class="mt-2">' + evidenceDetails + '</div>' +
          '</div>';
      }

      function renderLookupHtml(payload, options) {
        var mode = options && options.mode ? String(options.mode) : 'page';
        var ok = !!(payload && payload.ok);
        if (!ok) {
          var err = payload && payload.error ? String(payload.error) : 'Lookup failed.';
          return (mode === 'drawer')
            ? ('<div class="side-panel-detail-row"><span class="side-panel-value muted">' + esc(err) + '</span></div>')
            : ('<div class="alert alert-danger mb-0">' + esc(err) + '</div>');
        }

        var resolved = payload.resolved && typeof payload.resolved === 'object' ? payload.resolved : {};
        var events = Array.isArray(payload.events) ? payload.events : [];
        var session = payload.session && typeof payload.session === 'object' ? payload.session : null;
        var purchases = Array.isArray(payload.purchases) ? payload.purchases : [];
        var attribution = payload.attribution && typeof payload.attribution === 'object' ? payload.attribution : null;
        var fraud = payload.fraud && typeof payload.fraud === 'object' ? payload.fraud : null;

        function section(title, inner) {
          return '' +
            '<div class="card mt-3">' +
              '<div class="card-header"><h3 class="card-title">' + esc(title) + '</h3></div>' +
              '<div class="card-body">' + (inner || '') + '</div>' +
            '</div>';
        }

        if (mode === 'drawer') {
          // Provide a direct link to the full tool page.
          var q = (resolved && resolved.session_id) ? String(resolved.session_id) : (payload && payload.q ? String(payload.q) : '');
          var href = sideLookupHref(q);
          var openLink = '' +
            '<div class="side-panel-detail-row">' +
              '<span class="side-panel-label">Lookup</span>' +
              '<span class="side-panel-value"><a href="' + esc(href) + '" target="_blank" rel="noopener">Open in Lookup</a></span>' +
            '</div>';

          var idsHtml = renderIdsHtml(resolved, 'drawer');
          var sessionMini = '';
          try {
            if (session && typeof session === 'object') {
              var started = formatTs(session.started_at) || '\u2014';
              var seen = formatTs(session.last_seen) || '\u2014';
              var cartQty = (session.cart_qty != null) ? String(session.cart_qty) : '0';
              sessionMini = '' +
                '<div class="side-panel-detail-row"><span class="side-panel-label">Started</span><span class="side-panel-value">' + esc(started) + '</span></div>' +
                '<div class="side-panel-detail-row"><span class="side-panel-label">Seen</span><span class="side-panel-value">' + esc(seen) + '</span></div>' +
                '<div class="side-panel-detail-row"><span class="side-panel-label">Cart qty</span><span class="side-panel-value">' + esc(cartQty) + '</span></div>';
              if (session.has_purchased) {
                var sale = formatMoney(session.order_total, session.order_currency) || '\u2014';
                sessionMini += '<div class="side-panel-detail-row"><span class="side-panel-label">Sale</span><span class="side-panel-value">' + esc(sale) + (session.purchased_at ? (' <span class="text-muted">(' + esc(formatTs(session.purchased_at) || '') + ')</span>') : '') + '</span></div>';
              }
            }
          } catch (_) { sessionMini = ''; }
          var fraudHtml = renderFraudHtml(fraud, 'drawer');
          var attribDetails = attribution
            ? (
                '<details class="kexo-lookup-attribution-details">' +
                  '<summary class="text-muted">Show attribution</summary>' +
                  '<pre class="mt-2 mb-0" style="white-space:pre-wrap">' + esc(safeJsonPre(attribution)) + '</pre>' +
                '</details>'
              )
            : '<div class="text-muted">No attribution row.</div>';

          return '' +
            '<div class="kexo-lookup-drawer-root">' +
              '<div class="kexo-lookup-drawer-block">' + openLink + idsHtml + sessionMini + '</div>' +
              '<div class="kexo-lookup-drawer-block">' + fraudHtml + '</div>' +
              '<div class="kexo-lookup-drawer-block">' + attribDetails + '</div>' +
            '</div>';
        }

        var html = '';
        html += section('Resolved IDs', renderIdsHtml(resolved, 'page'));
        html += section('Activity', renderActivityHtml(events, 'page'));
        if (session) {
          var utm = [session.utm_source, session.utm_medium, session.utm_campaign, session.utm_content].filter(Boolean).join(' / ');
          var attrib = [session.attribution_channel, session.attribution_source, session.attribution_variant].filter(Boolean).join(' / ');
          if (session.attribution_confidence) attrib = attrib ? (attrib + ' (' + session.attribution_confidence + ')') : String(session.attribution_confidence);
          var sRows = [
            { k: 'Started', v: formatTs(session.started_at) || '\u2014' },
            { k: 'Last seen', v: formatTs(session.last_seen) || '\u2014' },
            { k: 'Country', v: session.country_code || '\u2014' },
            { k: 'Device', v: session.device || '\u2014' },
            { k: 'UA device/platform', v: ((session.ua_device_type || '') + ' / ' + (session.ua_platform || '') + (session.ua_model ? (' / ' + session.ua_model) : '')).trim() || '\u2014' },
            { k: 'Attribution', v: attrib || '\u2014' },
            { k: 'Entry URL', v: session.entry_url || '\u2014' },
            { k: 'Referrer', v: session.referrer || '\u2014' },
            { k: 'UTM', v: utm || '\u2014' },
          ];
          var body = sRows.map(function (r) {
            return '<tr><th style="width:180px">' + esc(r.k) + '</th><td><code>' + esc(r.v) + '</code></td></tr>';
          }).join('');
          html += section('Session', '<div class="table-responsive"><table class="table table-sm table-vcenter mb-0"><tbody>' + body + '</tbody></table></div>');
        }
        if (purchases && purchases.length) {
          var pHtml = purchases.slice(0, 5).map(function (p) {
            if (!p || typeof p !== 'object') return '';
            var rows = [
              { k: 'Purchase key', v: p.purchase_key || '\u2014' },
              { k: 'Purchased at', v: formatTs(p.purchased_at) || '\u2014' },
              { k: 'Order ID', v: p.order_id || '\u2014' },
              { k: 'Checkout token', v: p.checkout_token || '\u2014' },
              { k: 'Total', v: (p.order_total != null ? String(p.order_total) : '\u2014') + (p.order_currency ? (' ' + p.order_currency) : '') },
            ];
            var body = rows.map(function (r) {
              return '<tr><th style="width:180px">' + esc(r.k) + '</th><td><code>' + esc(r.v) + '</code></td></tr>';
            }).join('');
            return '<div class="mb-3"><div class="table-responsive"><table class="table table-sm table-vcenter mb-0"><tbody>' + body + '</tbody></table></div></div>';
          }).join('');
          html += section('Purchases', pHtml);
        }
        html += section('Fraud', renderFraudHtml(fraud, 'page'));
        if (attribution) {
          html += section('Attribution', '<details><summary class="text-muted">Show attribution payload</summary><pre class="mt-2 mb-0" style="white-space:pre-wrap">' + esc(safeJsonPre(attribution)) + '</pre></details>');
        }
        return html;
      }

      function renderInto(el, payload, options) {
        if (!el) return;
        ensureCopyLinksBound();
        el.innerHTML = renderLookupHtml(payload, options || {}) || '';
        try { animateFraudGauges(el); } catch (_) {}
      }

      try {
        window.KexoClickOrderLookupUI = {
          renderInto: renderInto,
          buildHtml: renderLookupHtml,
          animateGauges: animateFraudGauges,
        };
      } catch (_) {}

      ensureCopyLinksBound();
    }
    try { ensureClickOrderLookupUi(); } catch (_) {}

    function openSidePanel(sessionId) {
      const panel = document.getElementById('side-panel');
      if (!panel) return;
      try { selectedSessionId = sessionId; } catch (_) {}
      const backdrop = ensureSidePanelBackdrop();
      panel.classList.remove('is-hidden');
      if (backdrop) backdrop.classList.remove('is-hidden');
      document.body.classList.add('side-panel-open');
      document.getElementById('side-events').innerHTML = '<li class="muted">Loading\u2026</li>';
      document.getElementById('side-meta').innerHTML = '<div class="side-panel-detail-row"><span class="side-panel-value muted">Loading\u2026</span></div>';
      const sideSourceEl = document.getElementById('side-source');
      if (sideSourceEl) sideSourceEl.innerHTML = '';
      const rowIconsEl = document.getElementById('side-row-icons');
      if (rowIconsEl) rowIconsEl.innerHTML = '';
      document.getElementById('side-cf').innerHTML = '';

      function ensureSidePanelSummarySection() {
        try {
          var existing = document.getElementById('side-summary');
          if (existing) return existing;
          var header = panel.querySelector('.side-panel-header');
          if (!header || !header.parentNode) return null;
          var wrap = document.createElement('section');
          wrap.className = 'side-panel-section side-panel-summary';
          wrap.innerHTML =
            '<div class="side-panel-summary-grid" id="side-summary"></div>';
          header.parentNode.insertBefore(wrap, header.nextSibling);
          return wrap.querySelector('#side-summary');
        } catch (_) {
          return null;
        }
      }

      function minimizeSidePanelSections() {
        try {
          panel.querySelectorAll('.side-panel-section:not(.side-panel-summary)').forEach(function (sec) {
            sec.classList.add('is-minimized');
            var title = sec.querySelector('.side-panel-section-title');
            if (title) title.setAttribute('aria-expanded', 'false');
          });
        } catch (_) {}
      }

      function wireSidePanelSectionToggles() {
        try {
          if (panel.getAttribute('data-side-toggles-wired') === '1') return;
          panel.setAttribute('data-side-toggles-wired', '1');
          panel.addEventListener('click', function (e) {
            var t = e && e.target ? e.target : null;
            var title = t && t.closest ? t.closest('.side-panel-section-title') : null;
            if (!title) return;
            var sec = title.closest('.side-panel-section');
            if (!sec || sec.classList.contains('side-panel-summary')) return;
            e.preventDefault();
            sec.classList.toggle('is-minimized');
            title.setAttribute('aria-expanded', sec.classList.contains('is-minimized') ? 'false' : 'true');
          });
        } catch (_) {}
      }

      wireSidePanelSectionToggles();
      minimizeSidePanelSections();

      var summaryEl = ensureSidePanelSummarySection();
      if (summaryEl) summaryEl.innerHTML = '<div class="side-panel-detail-row"><span class="side-panel-value muted">Loading…</span></div>';
      (function fetchLookupBundle() {
        var shop = '';
        try { shop = getShopParam() || shopForSalesFallback || ''; } catch (_) { shop = ''; }
        var url = API + '/api/tools/click-order-lookup?q=' + encodeURIComponent(String(sessionId || ''));
        if (shop) url += '&shop=' + encodeURIComponent(shop);
        url += '&_=' + Date.now();
        fetch(url, { credentials: 'same-origin', cache: 'no-store' })
          .then(function (r) { return r && r.ok ? r.json() : null; })
          .then(function (payload) {
            if (selectedSessionId !== sessionId) return;
            if (!payload || payload.ok !== true) {
              document.getElementById('side-events').innerHTML = '<li class="muted">Unavailable.</li>';
              document.getElementById('side-meta').innerHTML = '<div class="side-panel-detail-row"><span class="side-panel-value muted">Unavailable.</span></div>';
              return;
            }

            var session = payload.session && typeof payload.session === 'object' ? payload.session : {};
            var events = Array.isArray(payload.events) ? payload.events : [];

            try {
              if (rowIconsEl) {
                var cc = (session && (session.country_code || session.cf_country)) ? String(session.country_code || session.cf_country) : 'XX';
                var ccUp = cc ? cc.trim().toUpperCase() : 'XX';
                var flag = flagImg(ccUp, ccUp);

                var channelLabel = '';
                try {
                  var variantKey = session && (session.attribution_variant ?? session.attributionVariant);
                  var channelKey = session && (session.attribution_channel ?? session.attributionChannel);
                  var sourceKey = session && (session.attribution_source ?? session.attributionSource);

                  function titleizeAttrib(v) {
                    var s = (v || '').trim().toLowerCase();
                    if (!s) return '';
                    if (s === 'google_ads') return 'Google Ads';
                    if (s === 'google_organic') return 'Google';
                    if (s === 'bing_ads') return 'Bing Ads';
                    if (s === 'bing_organic') return 'Bing';
                    if (s === 'meta_ads') return 'Meta Ads';
                    if (s === 'meta_organic') return 'Meta';
                    if (s === 'paid_search') return 'Paid search';
                    if (s === 'organic_search') return 'Organic search';
                    if (s === 'paid_social') return 'Paid social';
                    if (s === 'organic_social') return 'Organic social';
                    if (s === 'email') return 'Email';
                    if (s === 'sms') return 'SMS';
                    if (s === 'direct') return 'Direct';
                    if (s === 'affiliate') return 'Affiliate';
                    if (s === 'other') return 'Other';
                    return s.replace(/_/g, ' ').replace(/\b\w/g, function(m) { return m.toUpperCase(); });
                  }

                  if (variantKey) {
                    var head = String(variantKey).trim().toLowerCase().split(':')[0] || '';
                    channelLabel = titleizeAttrib(head);
                  }
                  if (!channelLabel && channelKey) channelLabel = titleizeAttrib(String(channelKey));
                  if (!channelLabel && sourceKey) channelLabel = titleizeAttrib(String(sourceKey));
                } catch (_) { channelLabel = ''; }

                var deviceLabel = '';
                try {
                  var info = deviceInfoForSession(session);
                  function titleize(v) {
                    var s = (v || '').trim().toLowerCase();
                    if (!s) return '';
                    if (s === 'ios') return 'iOS';
                    if (s === 'mac') return 'Mac';
                    if (s === 'android') return 'Android';
                    if (s === 'windows') return 'Windows';
                    if (s === 'chromeos') return 'Chrome OS';
                    if (s === 'linux') return 'Linux';
                    if (s === 'desktop') return 'Desktop';
                    if (s === 'mobile') return 'Mobile';
                    if (s === 'tablet') return 'Tablet';
                    if (s === 'iphone') return 'iPhone';
                    if (s === 'ipad') return 'iPad';
                    if (s === 'other') return 'Other';
                    if (s === 'unknown') return 'Unknown';
                    return s;
                  }
                  var parts2 = [];
                  if (info.platform && info.platform !== 'unknown') parts2.push(titleize(info.platform));
                  if (info.model) parts2.push(titleize(info.model));
                  if (info.deviceType && info.deviceType !== 'unknown') parts2.push(titleize(info.deviceType));
                  deviceLabel = parts2.length ? parts2.join(' - ') : '';
                } catch (_) { deviceLabel = ''; }

                // Previously we showed "Other - iOS - iPhone - Mobile" under the header.
                // That summary now lives in the dedicated Session block.
                rowIconsEl.innerHTML = '';
              }
            } catch (_) {}

            // Summary block (always open)
            try {
              var sumEl = document.getElementById('side-summary');
              if (sumEl) {
                var cc = (session && (session.country_code || session.cf_country)) ? String(session.country_code || session.cf_country) : 'XX';
                var ccUp = cc ? cc.trim().toUpperCase() : 'XX';
                var countryFlag = flagImg(ccUp, ccUp);
                var srcText = '';
                try { srcText = sourceDetailForPanel(session) || ''; } catch (_) { srcText = ''; }
                var info = null;
                try { info = deviceInfoForSession(session); } catch (_) { info = null; }
                var firstSeen = '';
                var lastSeen = '';
                try { firstSeen = arrivedAgo(session && session.started_at); } catch (_) { firstSeen = ''; }
                try { lastSeen = arrivedAgo(session && session.last_seen); } catch (_) { lastSeen = ''; }
                var visits = 1;
                try {
                  var rc = session && session.returning_count != null ? Number(session.returning_count) : 0;
                  visits = (Number.isFinite(rc) ? rc : 0) + 1;
                } catch (_) { visits = 1; }
                var deviceLine = '';
                try {
                  function tcase(v) {
                    var s = (v || '').trim().toLowerCase();
                    if (!s) return '';
                    if (s === 'ios') return 'iOS';
                    if (s === 'mac') return 'Mac';
                    if (s === 'android') return 'Android';
                    if (s === 'windows') return 'Windows';
                    if (s === 'chromeos') return 'Chrome OS';
                    if (s === 'linux') return 'Linux';
                    if (s === 'desktop') return 'Desktop';
                    if (s === 'mobile') return 'Mobile';
                    if (s === 'tablet') return 'Tablet';
                    if (s === 'iphone') return 'iPhone';
                    if (s === 'ipad') return 'iPad';
                    if (s === 'other') return 'Other';
                    if (s === 'unknown') return 'Unknown';
                    return s;
                  }
                  var parts = [];
                  if (info && info.platform && info.platform !== 'unknown') parts.push(tcase(info.platform));
                  if (info && info.model) parts.push(tcase(info.model));
                  if (info && info.deviceType && info.deviceType !== 'unknown') parts.push(tcase(info.deviceType));
                  deviceLine = parts.length ? parts.join(' - ') : '—';
                } catch (_) { deviceLine = '—'; }

                var srcIcon = '';
                try { if (typeof sourceCell === 'function') srcIcon = sourceCell(session) || ''; } catch (_) { srcIcon = ''; }
                sumEl.innerHTML =
                  '<div class="side-panel-detail-row"><span class="side-panel-label">Country</span><span class="side-panel-value">' + countryFlag + '</span></div>' +
                  '<div class="side-panel-detail-row"><span class="side-panel-label">Source</span><span class="side-panel-value">' + (srcIcon || '<span class="muted">—</span>') + '</span></div>' +
                  '<div class="side-panel-detail-row"><span class="side-panel-label">Device</span><span class="side-panel-value">' + escapeHtml(deviceLine || '—') + '</span></div>' +
                  '<div class="side-panel-detail-row"><span class="side-panel-label">First seen</span><span class="side-panel-value">' + escapeHtml(firstSeen || '—') + '</span></div>' +
                  '<div class="side-panel-detail-row"><span class="side-panel-label">Last seen</span><span class="side-panel-value">' + escapeHtml(lastSeen || '—') + '</span></div>' +
                  '<div class="side-panel-detail-row"><span class="side-panel-label">Total visits</span><span class="side-panel-value">' + escapeHtml(String(visits)) + '</span></div>';
              }
            } catch (_) {}

            // Activity (newest-first), with og thumbs (same UX as legacy drawer).
            try {
              var mainBase = getMainBaseUrl();
              var eventList = events.filter(function (e) { return e && e.type !== 'heartbeat'; }).slice().reverse();
              var eventsHtml = eventList.map(function (e) {
                var path = (e.path || '').trim();
                if (!path && e.product_handle) path = '/products/' + (e.product_handle || '');
                if (path && !path.startsWith('/')) path = '/' + path;
                var pathLabel = path || (e.product_handle || '');
                var fullUrl = mainBase && path ? mainBase + path : '';
                var thumb = fullUrl ? '<img class="landing-thumb" src="' + (API || '') + '/api/og-thumb?url=' + encodeURIComponent(fullUrl) + '&width=100' + '" alt="" onerror="this.classList.add(\'is-hidden\')">' : '';
                var text = formatTs(e.ts) + ' ' + escapeHtml(e.type) + ' ' + escapeHtml(pathLabel) + (e.qty_delta != null ? ' \u0394' + e.qty_delta : '');
                return '<li>' + thumb + '<span>' + text + '</span></li>';
              }).join('');
              document.getElementById('side-events').innerHTML = eventsHtml || '<li class="muted">No events</li>';
            } catch (_) {
              document.getElementById('side-events').innerHTML = '<li class="muted">No events</li>';
            }

            // Details (single source of truth): render lookup bundle in drawer mode.
            try {
              var metaEl = document.getElementById('side-meta');
              if (metaEl && window.KexoClickOrderLookupUI && typeof window.KexoClickOrderLookupUI.renderInto === 'function') {
                window.KexoClickOrderLookupUI.renderInto(metaEl, payload, { mode: 'drawer' });
              } else if (metaEl) {
                metaEl.innerHTML = '<div class="side-panel-detail-row"><span class="side-panel-value muted">Lookup UI unavailable.</span></div>';
              }
            } catch (_) {}

            try {
              if (sideSourceEl) {
                var srcText = sourceDetailForPanel(session);
                var entryUrl = session && session.entry_url != null ? String(session.entry_url).trim() : '';
                var fullUrl = '';
                try { fullUrl = buildFullEntryUrlForCopy(session) || ''; } catch (_) { fullUrl = ''; }
                var copyUrl = fullUrl || entryUrl;
                var html = '<div class="side-panel-source-text">' + escapeHtml(String(srcText || '\u2014')).replace(/\n/g, '<br>') + '</div>';
                if (copyUrl) {
                  html += '<div class="side-panel-source-actions"><a href="#" class="kexo-copy-link" data-kexo-copy="' + escapeHtml(copyUrl) + '">Copy URL</a></div>';
                }
                sideSourceEl.innerHTML = html;
              }
            } catch (_) {}
            try { document.getElementById('side-cf').innerHTML = buildSidePanelCf(session); } catch (_) {}
          })
          .catch(function () {
            document.getElementById('side-events').innerHTML = '<li class="muted">Failed to load.</li>';
            document.getElementById('side-meta').innerHTML = '<div class="side-panel-detail-row"><span class="side-panel-value muted">Failed to load.</span></div>';
          });
      })();
    }

    const sideCloseBtn = document.getElementById('side-close');
    if (sideCloseBtn) sideCloseBtn.addEventListener('click', closeSidePanel);
    document.addEventListener('keydown', function (e) {
      if (!e || e.key !== 'Escape') return;
      var panel = document.getElementById('side-panel');
      if (panel && !panel.classList.contains('is-hidden')) closeSidePanel();
    });

    // Session table pagination (live/sales/date) ??? delegated
    (function initSessionTablePagination() {
      var wrap = document.getElementById('table-pagination');
      if (!wrap) return;
      wrap.addEventListener('click', function(e) {
        var link = e.target.closest('a[data-page]');
        if (!link) return;
        e.preventDefault();
        if (link.closest('.page-item.disabled') || link.closest('.page-item.active')) return;
        var pg = parseInt(link.dataset.page, 10);
        if (!pg || pg < 1) return;
        currentPage = pg;
        if (sessionsTotal != null) fetchSessions(); else renderTable();
      });
    })();

    setupSortableHeaders();
    setupBestSellersSort();
    setupAllTableSorts();

    // Card-table pagination ??? event delegation on containers
    (function initTopTablePagination() {
      function bindDelegate(prefix, goToPage) {
        var wrap = document.getElementById(prefix + '-pagination');
        if (!wrap) return;
        wrap.addEventListener('click', function(e) {
          var link = e.target.closest('a[data-page]');
          if (!link) return;
          e.preventDefault();
          if (link.closest('.page-item.disabled') || link.closest('.page-item.active')) return;
          var pg = parseInt(link.dataset.page, 10);
          if (!pg || pg < 1) return;
          goToPage(pg);
        });
      }
      bindDelegate('country', function(pg) { countryPage = pg; renderCountry(statsCache); });
      bindDelegate('best-geo-products', function(pg) { bestGeoProductsPage = pg; renderBestGeoProducts(statsCache); });
      bindDelegate('best-sellers', function(pg) { bestSellersPage = pg; fetchBestSellers(); });
      bindDelegate('best-variants', function(pg) { bestVariantsPage = pg; fetchBestVariants(); });
      bindDelegate('attribution', function(pg) { attributionPage = pg; renderAttributionTables(attributionCache || {}); });
      bindDelegate('devices', function(pg) { devicesPage = pg; renderDevicesTables(devicesCache || {}); });
      bindDelegate('browsers', function(pg) { browsersPage = pg; renderBrowsersTables(browsersCache || {}); });
      bindDelegate('dash-top-products', function(pg) { dashTopProductsPage = pg; rerenderDashboardFromCache(); });
      bindDelegate('dash-top-countries', function(pg) { dashTopCountriesPage = pg; rerenderDashboardFromCache(); });
      bindDelegate('dash-trending', function(pg) { dashTrendingPage = pg; rerenderDashboardFromCache(); });
      bindDelegate('breakdown-aov', function(pg) { breakdownAovPage = pg; renderAov(statsCache); });
      bindDelegate('breakdown-title', function(pg) { breakdownTitlePage = pg; renderBreakdownTitles(leaderboardCache); });
      bindDelegate('breakdown-finish', function(pg) { breakdownFinishPage = pg; renderBreakdownFinishes(finishesCache); });
      bindDelegate('breakdown-length', function(pg) { breakdownLengthPage = pg; renderBreakdownLengths(lengthsCache); });
      bindDelegate('breakdown-chainstyle', function(pg) { breakdownChainStylePage = pg; renderBreakdownChainStyles(chainStylesCache); });
    })();

    (function initRowsPerPageSelect() {
      // Rows-per-page UI is intentionally hidden; keep page size fixed at default.
      const sel = document.getElementById('rows-per-page-select');
      if (sel) sel.value = String(rowsPerPage);
    })();

    function getConfigStatusUrl(options = {}) {
      var url = API + '/api/config-status';
      try {
        var shop = getShopParam();
        if (!shop && typeof shopForSalesFallback === 'string' && shopForSalesFallback) shop = shopForSalesFallback;
        if (shop) url += (url.indexOf('?') >= 0 ? '&' : '?') + 'shop=' + encodeURIComponent(shop);
      } catch (_) {}
      try {
        var rangeSel = document.getElementById('diagnostics-overview-range');
        if (rangeSel && rangeSel.value) {
          var rk = normalizeRangeKeyForApi(String(rangeSel.value || '').trim().toLowerCase());
          if (rk) url += (url.indexOf('?') >= 0 ? '&' : '?') + 'range=' + encodeURIComponent(rk);
        }
      } catch (_) {}
      if (options && options.force) {
        url += (url.indexOf('?') >= 0 ? '&' : '?') + '_=' + Date.now();
      }
      return url;
    }

    function getReconcileSalesUrl(options = {}) {
      var url = API + '/api/reconcile-sales?range=7d';
      try {
        var shop = getShopParam();
        if (!shop && typeof shopForSalesFallback === 'string' && shopForSalesFallback) shop = shopForSalesFallback;
        if (shop) url += (url.indexOf('?') >= 0 ? '&' : '?') + 'shop=' + encodeURIComponent(shop);
      } catch (_) {}
      if (options && options.force) {
        url += (url.indexOf('?') >= 0 ? '&' : '?') + '_=' + Date.now();
      }
      return url;
    }

    function setDiagnosticsActionMsg(text, ok) {
      var el = document.getElementById('config-action-msg');
      if (!el) return;
      el.textContent = text || '';
      el.className = 'form-hint ' + (ok ? 'text-success' : 'text-danger');
    }

    function edgeBlocksButtonHtml(count, rangeKey) {
      var label = '\u2014';
      try {
        if (count != null && typeof fmtSessions === 'function') label = fmtSessions(count);
        else if (count != null) label = String(count);
      } catch (_) { label = count != null ? String(count) : '\u2014'; }
      var rk = (rangeKey && String(rangeKey).trim().toLowerCase() === '7d') ? '7d' : '24h';
      return (
        '<button type="button" class="btn btn-link p-0 kexo-edge-blocks-open-btn" data-edge-blocks-range="' +
        escapeHtml(rk) +
        '" disabled aria-disabled="true" title="Admin only">' +
        escapeHtml(label) +
        '</button>'
      );
    }

    function reconcileSalesTruth(options = {}) {
      const btn = document.getElementById('config-reconcile-btn');
      if (btn) {
        btn.classList.add('spinning');
        btn.disabled = true;
      }
      setDiagnosticsActionMsg('Reconciling Shopify truth (7d)\u2026', true);
      const p = fetch(getReconcileSalesUrl({ force: true }), {
        method: 'POST',
        credentials: 'same-origin',
        cache: 'no-store',
      })
        .then(function(r) { return r.json(); })
        .then(function(payload) {
          try { refreshConfigStatus({ force: true, preserveView: true }); } catch (_) {}
          try { refreshAttribution({ force: true }); } catch (_) {}
          try { refreshDevices({ force: true }); } catch (_) {}
          try { refreshBrowsers({ force: true }); } catch (_) {}
          var details = payload && payload.result ? payload.result : null;
          var fetched = details && typeof details.fetched === 'number' ? details.fetched : null;
          var inserted = details && typeof details.inserted === 'number' ? details.inserted : null;
          var updated = details && typeof details.updated === 'number' ? details.updated : null;
          var linked = details && typeof details.evidenceLinked === 'number' ? details.evidenceLinked : null;
          var bits = [];
          if (fetched != null) bits.push('fetched ' + String(fetched));
          if (inserted != null) bits.push('inserted ' + String(inserted));
          if (updated != null) bits.push('updated ' + String(updated));
          if (linked != null) bits.push('linked ' + String(linked));
          setDiagnosticsActionMsg(bits.length ? ('Reconcile done: ' + bits.join(', ')) : 'Reconcile done.', true);
        })
        .catch(function(err) {
          setDiagnosticsActionMsg('Reconcile failed: ' + (err && err.message ? String(err.message).slice(0, 120) : 'request_failed'), false);
        })
        .finally(() => {
          if (btn) {
            btn.classList.remove('spinning');
            btn.disabled = false;
          }
        });
      return p;
    }

    var activeDiagTabKey = 'sales';

    function isConfigModalOpen() { return false; }

    function refreshConfigStatus(options = {}) {
      if (configStatusRefreshInFlight && !options.force) return configStatusRefreshInFlight;
      const refreshBtn = document.getElementById('config-refresh-btn');
      const configStatusEl = document.getElementById('diagnostics-content');
      const compareModalEl = document.getElementById('kpi-compare-modal');
      const compareRefreshBtn = document.getElementById('kpi-compare-refresh-btn');
      const compareStatusEl = document.getElementById('kpi-compare-status');
      const compareUpdatedEl = document.getElementById('kpi-compare-updated');
      const compareKickerEl = document.getElementById('kpi-compare-kicker');
      const compareOpen = !!(compareModalEl && compareModalEl.classList.contains('open'));
      let diagnosticsStepEl = null;
      let compareStepEl = null;
      const preserveView = !!(options && options.preserveView);
      const modalCardEl = null;
      const prevModalScrollTop = (preserveView && modalCardEl) ? (modalCardEl.scrollTop || 0) : 0;
      if (configStatusEl && !preserveView) {
        configStatusEl.innerHTML =
          '<div class="d-flex align-items-center gap-2 text-secondary">' +
            '<div class="spinner-border spinner-border-sm text-primary" role="status" aria-hidden="true"></div>' +
            '<div>Loading diagnostics\u2026</div>' +
          '</div>' +
          '<div id="settings-diagnostics-loading-step" class="text-secondary small mt-2">\u2014</div>';
        diagnosticsStepEl = configStatusEl.querySelector('#settings-diagnostics-loading-step');
        if (diagnosticsStepEl) diagnosticsStepEl.textContent = 'Connecting to diagnostics services';
      }
      if (compareOpen && compareStatusEl) {
        compareStatusEl.innerHTML = '<div class="kpi-compare-loading"><div class="report-build-wrap"><div class="spinner-border text-primary" role="status"></div><div class="report-build-title">building KPI comparison</div><div class="report-build-step">\u2026</div></div></div>';
        compareStepEl = compareStatusEl.querySelector('.report-build-step');
        if (compareStepEl) compareStepEl.textContent = 'Loading KPI sources';
      }

      if (refreshBtn) refreshBtn.classList.add('spinning');
      if (compareOpen && compareRefreshBtn) compareRefreshBtn.classList.add('spinning');
      const p = fetch(getConfigStatusUrl({ force: !!options.force }), { credentials: 'same-origin', cache: 'no-store' })
        .then(function(r) {
          if (!r.ok) throw new Error('Config status ' + r.status);
          return r.json();
        })
        .then(c => {
          if (diagnosticsStepEl) diagnosticsStepEl.textContent = 'Analyzing diagnostics payload';
          if (compareStepEl) compareStepEl.textContent = 'Comparing KPI values';
          function code(value) { return '<code>' + escapeHtml(value == null ? '' : String(value)) + '</code>'; }
          function pill(text, tone) {
            const t = (tone === 'bad' || tone === 'warn') ? tone : 'ok';
            return '<span class="diag-pill ' + t + '">' + escapeHtml(String(text || '')) + '</span>';
          }
          function kv(label, valueHtml) {
            return '<div class="diag-kv"><div class="k">' + escapeHtml(label) + '</div><div class="v">' + valueHtml + '</div></div>';
          }
          function icon(name, cls, iconKey) {
            const map = {
              shield: 'fa-light fa-shield-halved',
              columns: 'fa-light fa-table-columns',
              list: 'fa-light fa-list',
              bag: 'fa-light fa-bag-shopping',
              activity: 'fa-light fa-wave-square',
              bar: 'fa-light fa-chart-column',
              server: 'fa-light fa-server',
              key: 'fa-light fa-key',
              link: 'fa-light fa-link',
              chev: 'fa-light fa-chevron-down'
            };
            const fa = map[name] || 'fa-light fa-circle';
            const extra = cls ? (' ' + cls) : '';
            var keyAttr = iconKey ? (' data-icon-key="' + escapeHtml(String(iconKey)) + '"') : '';
            return '<i class="' + fa + extra + '"' + keyAttr + ' aria-hidden="true"></i>';
          }
          function fmtSessions(n) { return (typeof n === 'number' && isFinite(n)) ? escapeHtml(formatSessions(n)) : '\u2014'; }
          function fmtRevenue(n) { return (typeof n === 'number' && isFinite(n)) ? escapeHtml(formatRevenue(n)) : '\u2014'; }
          function fmtTsMaybe(ms) { return (typeof ms === 'number' && isFinite(ms)) ? escapeHtml(formatTs(ms)) : '\u2014'; }
          function fmtPct(p) {
            if (typeof p !== 'number' || !isFinite(p)) return '\u2014';
            const s = (Math.round(p * 100) / 100).toFixed(2).replace(/\.?0+$/, '');
            return escapeHtml(s + '%');
          }
          function fmtSigned(n, fmtAbsFn, unitSuffix) {
            if (typeof n !== 'number' || !isFinite(n)) return '\u2014';
            const sign = n > 0 ? '+' : (n < 0 ? '-' : '');
            const abs = Math.abs(n);
            const core = fmtAbsFn ? fmtAbsFn(abs) : String(abs);
            return escapeHtml(sign + core + (unitSuffix || ''));
          }

          const app = c && c.app ? c.app : {};
          const shopify = c && c.shopify ? c.shopify : {};
          const db = c && c.db ? c.db : {};
          const ingest = c && c.ingest ? c.ingest : {};
          const reporting = c && c.reporting ? c.reporting : {};
          const traffic = c && c.traffic ? c.traffic : {};
          const sales = c && c.sales ? c.sales : {};
          const truth = sales && sales.truth ? sales.truth : {};
          const truthToday = truth && truth.today ? truth.today : {};
          const health = truth && truth.health ? truth.health : {};
          const evidenceToday = sales && sales.evidence && sales.evidence.today ? sales.evidence.today : {};
          const driftOrders = sales && sales.drift && typeof sales.drift.orders === 'number' ? sales.drift.orders : null;
          const pixelDerivedToday = sales && sales.pixel && sales.pixel.today ? sales.pixel.today : {};
          const pixelDerivedOrders = (typeof pixelDerivedToday.orderCount === 'number') ? pixelDerivedToday.orderCount : null;
          const pixelDerivedRevenue = (typeof pixelDerivedToday.revenueGbp === 'number') ? pixelDerivedToday.revenueGbp : null;
          const driftPixelOrders = sales && sales.drift && typeof sales.drift.pixelVsTruthOrders === 'number' ? sales.drift.pixelVsTruthOrders : null;
          const driftPixelRevenue = sales && sales.drift && typeof sales.drift.pixelVsTruthRevenueGbp === 'number' ? sales.drift.pixelVsTruthRevenueGbp : null;
          const missingEvidenceToday = sales && sales.missingEvidence && sales.missingEvidence.today ? sales.missingEvidence.today : {};
          const missingEvidenceCount = (missingEvidenceToday && typeof missingEvidenceToday.missingOrderCount === 'number')
            ? missingEvidenceToday.missingOrderCount
            : null;
          const missingEvidenceSample = (missingEvidenceToday && Array.isArray(missingEvidenceToday.missingOrdersSample))
            ? missingEvidenceToday.missingOrdersSample
            : [];
          const missingEvidenceNote = (missingEvidenceToday && typeof missingEvidenceToday.note === 'string')
            ? missingEvidenceToday.note
            : '';
          const pixel = c && c.pixel ? c.pixel : {};
          const appSettings = c && c.settings ? c.settings : {};
          const trackerDefinitions = c && c.trackerDefinitions ? c.trackerDefinitions : null;
          const pixelSessionMode = (appSettings && appSettings.pixelSessionMode != null)
            ? String(appSettings.pixelSessionMode).trim().toLowerCase()
            : 'legacy';
          const sharedSessionFixEnabled = pixelSessionMode === 'shared_ttl';

          const truthOrders = (typeof truthToday.orderCount === 'number') ? truthToday.orderCount : null;
          const truthRevenue = (typeof truthToday.revenueGbp === 'number') ? truthToday.revenueGbp : null;
          const truthCheckoutOrders = (typeof truthToday.checkoutOrderCount === 'number') ? truthToday.checkoutOrderCount : null;
          const truthCheckoutRevenue = (typeof truthToday.checkoutRevenueGbp === 'number') ? truthToday.checkoutRevenueGbp : null;
          const truthReturningCustomers = (typeof truthToday.returningCustomerCount === 'number') ? truthToday.returningCustomerCount : null;
          const truthReturningRevenue = (typeof truthToday.returningRevenueGbp === 'number') ? truthToday.returningRevenueGbp : null;
          const evTotal = (typeof evidenceToday.checkoutCompleted === 'number') ? evidenceToday.checkoutCompleted : null;
          const evSessions = (typeof evidenceToday.checkoutCompletedSessions === 'number') ? evidenceToday.checkoutCompletedSessions : null;
          const evLinked = (typeof evidenceToday.linked === 'number') ? evidenceToday.linked : null;
          const evUnlinked = (typeof evidenceToday.unlinked === 'number') ? evidenceToday.unlinked : null;
          const staleSec = (health && typeof health.staleMs === 'number') ? Math.round(health.staleMs / 1000) : null;

          const SHOPIFY_LOGO_URL = 'https://cdn.shopify.com/s/files/1/0847/7261/8587/files/shopify.png?v=1770259752';
          const KEXO_LOGO_URL = '/assets/logos/new/kexo.webp';

          const shopifySessionsToday = (traffic && typeof traffic.shopifySessionsToday === 'number') ? traffic.shopifySessionsToday : null;
          const shopifyConversionRateToday = (traffic && typeof traffic.shopifyConversionRateToday === 'number') ? traffic.shopifyConversionRateToday : null;
          const shopifyConversionRateNote = (traffic && typeof traffic.shopifyConversionRateTodayNote === 'string') ? traffic.shopifyConversionRateTodayNote : '';
          const kexoSessionsToday = (traffic && traffic.today && typeof traffic.today.humanSessions === 'number') ? traffic.today.humanSessions :
            (traffic && traffic.today && typeof traffic.today.sessionsReachedApp === 'number') ? traffic.today.sessionsReachedApp : null;
          const botsBlockedToday = (traffic && traffic.today && typeof traffic.today.botsBlockedAtEdge === 'number') ? traffic.today.botsBlockedAtEdge : null;
          const botsBlockedUpdatedAt = (traffic && traffic.today && typeof traffic.today.botsBlockedAtEdgeUpdatedAt === 'number') ? traffic.today.botsBlockedAtEdgeUpdatedAt : null;

          const overview = (c && c.overview && typeof c.overview === 'object') ? c.overview : null;
          const overviewRangeKey = (overview && typeof overview.rangeKey === 'string')
            ? String(overview.rangeKey).trim().toLowerCase()
            : 'today';
          function overviewRangeLabel(key) {
            const k = key ? String(key).trim().toLowerCase() : '';
            if (k === 'yesterday') return 'yesterday';
            if (k === '7d') return 'last 7 days';
            if (k === '14d') return 'last 14 days';
            if (k === '30d') return 'last 30 days';
            return 'today';
          }
          const overviewLabel = overviewRangeLabel(overviewRangeKey);
          const overviewTruthOrders = (overview && typeof overview.truthOrders === 'number') ? overview.truthOrders : truthOrders;
          const overviewTruthRevenue = (overview && typeof overview.truthRevenueGbp === 'number') ? overview.truthRevenueGbp : truthRevenue;
          const overviewShopifySessions = (overview && typeof overview.shopifySessions === 'number') ? overview.shopifySessions : shopifySessionsToday;
          const overviewKexoSessions = (overview && typeof overview.kexoSessionsHuman === 'number') ? overview.kexoSessionsHuman : kexoSessionsToday;
          const overviewBotsBlocked = (overview && typeof overview.botsBlockedAtEdge === 'number') ? overview.botsBlockedAtEdge : botsBlockedToday;

          // Conversion rate used across Kexo tables: truth orders / sessions.
          // Prefer checkout-token truth orders (online-store proxy) when available.
          const convertedOrdersForCr = (truthCheckoutOrders != null ? truthCheckoutOrders : truthOrders);
          const shopifyCr = (shopifyConversionRateToday != null)
            ? shopifyConversionRateToday
            : ((convertedOrdersForCr != null && shopifySessionsToday != null && shopifySessionsToday > 0)
              ? (convertedOrdersForCr / shopifySessionsToday) * 100
              : null);
          const kexoCr = (convertedOrdersForCr != null && kexoSessionsToday != null && kexoSessionsToday > 0) ? (convertedOrdersForCr / kexoSessionsToday) * 100 : null;
          const shopifyCrSource = (shopifyConversionRateToday != null)
            ? 'traffic.shopifyConversionRateToday (ShopifyQL conversion_rate)'
            : 'computed: truth orders / Shopify sessions (fallback)';

          const overviewShopifyCr = (overview && typeof overview.shopifyCr === 'number') ? overview.shopifyCr : shopifyCr;
          const overviewKexoCr = (overview && typeof overview.kexoCr === 'number') ? overview.kexoCr : kexoCr;
          const overviewShopifyCrSource = (overview && typeof overview.shopifyCrSource === 'string') ? String(overview.shopifyCrSource) : shopifyCrSource;
          const overviewShopifySessionsNote = (overview && typeof overview.shopifySessionsNote === 'string') ? String(overview.shopifySessionsNote) : '';

          const driftPixelCheckoutOrders = (truthCheckoutOrders != null && pixelDerivedOrders != null) ? (pixelDerivedOrders - truthCheckoutOrders) : null;
          const driftPixelCheckoutRevenue = (truthCheckoutRevenue != null && pixelDerivedRevenue != null)
            ? (Math.round((pixelDerivedRevenue - truthCheckoutRevenue) * 100) / 100)
            : null;
          const driftEvidenceCheckoutOrders = (truthCheckoutOrders != null && evTotal != null) ? (evTotal - truthCheckoutOrders) : null;

          const sessionsDiff = (shopifySessionsToday != null && kexoSessionsToday != null) ? (shopifySessionsToday - kexoSessionsToday) : null;
          const crDiff = (shopifyCr != null && kexoCr != null) ? (shopifyCr - kexoCr) : null;

          const storedScopesStr = (shopify && shopify.storedScopes) ? String(shopify.storedScopes) : '';
          const serverScopesStr = (shopify && shopify.serverScopes) ? String(shopify.serverScopes) : '';
          const storedScopes = storedScopesStr ? storedScopesStr.split(',').map(s => s.trim()).filter(Boolean) : [];
          const serverScopes = serverScopesStr ? serverScopesStr.split(',').map(s => s.trim()).filter(Boolean) : [];
          const missingScopes = (storedScopes.length && serverScopes.length) ? serverScopes.filter(s => storedScopes.indexOf(s) === -1) : [];

          const pixelIngestUrl = (pixel && pixel.ingestUrl != null) ? String(pixel.ingestUrl) : '';
          const expectedIngestUrl = (ingest && ingest.effectiveIngestUrl != null) ? String(ingest.effectiveIngestUrl) : '';
          const ingestUrlMatch = (pixelIngestUrl && expectedIngestUrl) ? (pixelIngestUrl === expectedIngestUrl) : null;

          function diffCell(text, cls) {
            const c = cls ? (' ' + cls) : '';
            return '<span class="' + c.trim() + '">' + escapeHtml(text) + '</span>';
          }

          function renderTrackerDefinitions(defs) {
            if (!defs || !Array.isArray(defs.tables)) {
              return '<div class="dm-def-note">No tracker definitions available from server.</div>';
            }

            function pill2(text, tone) {
              const t = (tone === 'bad' || tone === 'warn') ? tone : 'ok';
              return '<span class="dm-pill dm-pill-' + t + '">' + escapeHtml(String(text || '')) + '</span>';
            }
            function code2(value) {
              return '<code class="dm-code">' + escapeHtml(value == null ? '' : String(value)) + '</code>';
            }
            function line2(label, valueHtml) {
              return (
                '<div class="dm-row-kv">' +
                  '<div class="dm-k">' + escapeHtml(label) + '</div>' +
                  '<div class="dm-v">' + (valueHtml || '\u2014') + '</div>' +
                '</div>'
              );
            }
            function sectionTitle2(text) {
              return '<div class="dm-def-section-title">' + escapeHtml(text) + '</div>';
            }

            const ver = (defs.version != null) ? String(defs.version) : '';
            const last = (defs.lastUpdated != null) ? String(defs.lastUpdated) : '';
            const note = defs.note ? String(defs.note) : '';
            const defsTables = Array.isArray(defs.tables) ? defs.tables : [];

            const byPage = {};
            for (const d of defsTables) {
              const p = (d && d.page) ? String(d.page) : 'Other';
              if (!byPage[p]) byPage[p] = [];
              byPage[p].push(d);
            }

            const preferredOrder = ['Home', 'Overview', 'Countries', 'Products', 'Acquisition', 'Diagnostics', 'Other'];
            const pages = Object.keys(byPage || {});
            pages.sort(function(a, b) {
              const ia = preferredOrder.indexOf(a);
              const ib = preferredOrder.indexOf(b);
              if (ia === -1 && ib === -1) return String(a).localeCompare(String(b));
              if (ia === -1) return 1;
              if (ib === -1) return -1;
              return ia - ib;
            });

            let out = '';
            out += '<div class="dm-def-root">';
            const metaBits = [];
            if (ver) metaBits.push('v' + ver);
            if (last) metaBits.push('Last updated ' + last);
            if (metaBits.length) out += '<div class="dm-def-meta">' + escapeHtml(metaBits.join(' ?? ')) + '</div>';
            if (note) out += '<div class="dm-def-note">' + escapeHtml(note) + '</div>';

            if (!pages.length) {
              out += '<div class="dm-def-note">No definitions found.</div>';
              out += '</div>';
              return out;
            }

            for (const page of pages) {
              const list = Array.isArray(byPage[page]) ? byPage[page].slice() : [];
              list.sort(function(a, b) { return String((a && a.name) || '').localeCompare(String((b && b.name) || '')); });

              out += '<div class="dm-def-page-box">';
              out +=   '<div class="dm-def-page-title">' + escapeHtml(page) + '</div>';

              for (const d of list) {
                const id = (d && d.id) ? String(d.id) : '';
                const name = (d && d.name) ? String(d.name) : (id || 'Unnamed');
                const endpoint = (d && d.endpoint) ? d.endpoint : {};
                const method = endpoint && endpoint.method ? String(endpoint.method) : '';
                const path = endpoint && endpoint.path ? String(endpoint.path) : '';
                const params = (endpoint && Array.isArray(endpoint.params)) ? endpoint.params : [];
                const uiIds = (d && d.ui && Array.isArray(d.ui.elementIds)) ? d.ui.elementIds : [];
                const uiMissing = uiIds.filter(function(x) { return x && !document.getElementById(String(x)); });

                const checks = (d && d.checks) ? d.checks : {};
                const activeMissingTables = (checks && Array.isArray(checks.activeDbTablesMissing)) ? checks.activeDbTablesMissing : null;
                const missingTables = activeMissingTables != null
                  ? activeMissingTables
                  : ((checks && Array.isArray(checks.dbTablesMissing)) ? checks.dbTablesMissing : []);
                const dbOk = (missingTables.length === 0);
                const tokenOk = (checks && checks.shopifyTokenOk === true) || !(d && d.requires && d.requires.shopifyToken);
                const uiOk = (uiMissing.length === 0);
                const overallOk = dbOk && tokenOk && uiOk;

                const summaryBits = [];
                if (method && path) summaryBits.push(method + ' ' + path);
                if (params.length) summaryBits.push('params: ' + params.join(', '));
                if (!summaryBits.length && id) summaryBits.push(id);

                const chips = [];
                chips.push(overallOk ? pill2('OK', 'ok') : pill2('Check', (missingTables.length ? 'bad' : 'warn')));
                if (uiIds.length) chips.push(uiOk ? pill2('UI OK', 'ok') : pill2('UI missing', 'warn'));
                if (missingTables.length) chips.push(pill2('DB missing', 'bad'));
                if (d && d.requires && d.requires.shopifyToken) chips.push(tokenOk ? pill2('Token OK', 'ok') : pill2('Token missing', 'bad'));

                out += '<details class="dm-def-details">';
                out +=   '<summary>';
                out +=     '<div style="min-width:0;">';
                out +=       '<div class="dm-def-details-name">' + escapeHtml(name) + '</div>';
                out +=       '<div class="dm-def-details-sub">' + escapeHtml(summaryBits.join(' ?? ')) + '</div>';
                out +=     '</div>';
                out +=     '<div class="dm-def-details-chips">' + chips.join('') + '</div>';
                out +=   '</summary>';

                out +=   '<div class="dm-def-details-body">';
                if (id) out += line2('Id', code2(id));
                if (method && path) out += line2('Endpoint', code2(method + ' ' + path));
                if (params.length) out += line2('Params', code2(params.join(', ')));
                if (uiIds.length) out += line2('UI elementIds', code2(uiIds.join(', ')));
                if (uiMissing.length) out += line2('UI missing', code2(uiMissing.join(', ')));
                if (missingTables.length) out += line2('DB tables missing', code2(missingTables.join(', ')));
                if (d && d.requires && d.requires.shopifyToken) out += line2('Shopify token', tokenOk ? pill2('OK', 'ok') : pill2('Missing', 'bad'));

                const respects = (d && d.respectsReporting) ? d.respectsReporting : {};
                const rOrders = !!(respects && respects.ordersSource);
                const rSessions = !!(respects && respects.sessionsSource);
                const respectsBits = [];
                respectsBits.push('ordersSource ' + (rOrders ? 'YES' : 'NO'));
                respectsBits.push('sessionsSource ' + (rSessions ? 'YES' : 'NO'));
                const nowBits = [];
                if (rOrders && reporting && reporting.ordersSource) nowBits.push('ordersSource=' + reporting.ordersSource);
                if (rSessions && reporting && reporting.sessionsSource) nowBits.push('sessionsSource=' + reporting.sessionsSource);
                out += line2('Respects reporting', code2(respectsBits.join(' ?? ') + (nowBits.length ? (' ?? now ' + nowBits.join(', ')) : '')));

                const sources = (d && Array.isArray(d.sources)) ? d.sources : [];
                if (sources.length) {
                  out += sectionTitle2('Sources');
                  out += '<ul class="dm-def-list">';
                  for (const s of sources) {
                    const kind = (s && s.kind) ? String(s.kind) : 'source';
                    const st = (s && Array.isArray(s.tables)) ? s.tables : [];
                    const note2 = (s && s.note) ? String(s.note) : '';
                    let line = '<strong>' + escapeHtml(kind) + '</strong>';
                    if (st.length) line += ' ?? ' + escapeHtml(st.join(', '));
                    if (note2) line += ' \u2014 ' + escapeHtml(note2);
                    out += '<li>' + line + '</li>';
                  }
                  out += '</ul>';
                }

                const columns = (d && Array.isArray(d.columns)) ? d.columns : [];
                if (columns.length) {
                  out += sectionTitle2('Columns + math');
                  out += '<ul class="dm-def-list">';
                  for (const col of columns) {
                    const cn = (col && col.name) ? String(col.name) : 'Column';
                    const cv = (col && col.value != null) ? String(col.value) : '';
                    const cf = (col && col.formula != null) ? String(col.formula) : '';
                    let line = '<strong>' + escapeHtml(cn) + '</strong>';
                    if (cv) line += ' ?? ' + escapeHtml(cv);
                    if (cf) line += ' ?? <code class="dm-code">' + escapeHtml(cf) + '</code>';
                    out += '<li>' + line + '</li>';
                  }
                  out += '</ul>';
                }

                const math = (d && Array.isArray(d.math)) ? d.math : [];
                if (math.length) {
                  out += sectionTitle2('Notes');
                  out += '<ul class="dm-def-list">';
                  for (const m of math) {
                    const mn = (m && m.name) ? String(m.name) : 'Note';
                    const mv = (m && m.value != null) ? String(m.value) : '';
                    out += '<li><strong>' + escapeHtml(mn) + '</strong>' + (mv ? (' ?? ' + escapeHtml(mv)) : '') + '</li>';
                  }
                  out += '</ul>';
                }

                out +=   '</div>';
                out += '</details>';
              }

              out += '</div>';
            }

            out += '</div>';
            return out;
          }

          // --- New flattened, top-tab Diagnostics UI (inline-styled) ---
          const shopifyOrderRate = shopifyCr;
          const kexoOrderRate = kexoCr;
          const orderRateDiff = (shopifyOrderRate != null && kexoOrderRate != null) ? (shopifyOrderRate - kexoOrderRate) : null;

          const evidenceExpected = (truthCheckoutOrders != null ? truthCheckoutOrders : truthOrders);

          function pillInline(text, tone) {
            const t = (tone === 'bad' || tone === 'warn') ? tone : 'ok';
            return '<span class="dm-pill dm-pill-' + t + '">' + escapeHtml(String(text || '')) + '</span>';
          }
          function codeInline(value) {
            return '<code class="dm-code">' + escapeHtml(value == null ? '' : String(value)) + '</code>';
          }
          function card(title, bodyHtml) {
            const h = title ? ('<div class="dm-card-title">' + escapeHtml(title) + '</div>') : '';
            return '<div class="dm-card">' + h + (bodyHtml || '') + '</div>';
          }
          function brandHeader(name, iconUrl, subtitle, accentRgb) {
            const sub = subtitle ? ('<div class="dm-brand-sub">' + escapeHtml(subtitle) + '</div>') : '';
            return (
              '<div class="dm-brand-header">' +
                '<div class="dm-brand-header-inner">' +
                  '<img src="' + escapeHtml(String(iconUrl || '')) + '" alt="' + escapeHtml(String(name || '')) + '" class="dm-brand-icon" />' +
                  '<div style="min-width:0;line-height:1.1;">' +
                    '<div class="dm-brand-name">' + escapeHtml(String(name || '')) + '</div>' +
                    sub +
                  '</div>' +
                '</div>' +
              '</div>'
            );
          }
          function brandIconTiny(name, iconUrl, accentRgb) {
            return '<img src="' + escapeHtml(String(iconUrl || '')) + '" alt="' + escapeHtml(String(name || '')) + '" class="dm-brand-icon" />';
          }
          function metric(label, valueHtml) {
            return (
              '<div class="dm-metric">' +
                '<div class="dm-metric-label">' + escapeHtml(label) + '</div>' +
                '<div class="dm-metric-value">' + (valueHtml || '\u2014') + '</div>' +
              '</div>'
            );
          }
          function rowKV(label, valueHtml, noteHtml) {
            return (
              '<div class="dm-row-kv">' +
                '<div class="dm-k">' + escapeHtml(label) + '</div>' +
                '<div class="dm-v">' + (valueHtml || '\u2014') + '</div>' +
              '</div>' +
              (noteHtml ? ('<div class="dm-row-kv-note">' + noteHtml + '</div>') : '')
            );
          }
          function diffSpan(n, fmtAbsFn, unitSuffix) {
            if (typeof n !== 'number' || !isFinite(n)) return '\u2014';
            const abs = Math.abs(n);
            const sign = n > 0 ? '+' : (n < 0 ? '-' : '');
            const core = fmtAbsFn ? fmtAbsFn(abs) : String(abs);
            const tone = Math.abs(n) < 0.0001 ? 'ok' : 'warn';
            const text = sign + core + (unitSuffix || '');
            return pillInline(text, tone);
          }


          const headerMetaBits = [];
          if (shopify && shopify.shop) headerMetaBits.push('Shop ' + codeInline(shopify.shop));
          if (c && c.timeZone) headerMetaBits.push('TZ ' + codeInline(String(c.timeZone)));
          headerMetaBits.push('Updated ' + codeInline(formatTs(c && c.now ? c.now : Date.now())));

          const aiCopyGeneratedAt = new Date().toISOString();
          let aiCopyText = '';
          let aiPayloadData = null;
          try {
            const convertedSessionsSource = (evSessions != null)
              ? 'sales.evidence.today.checkoutCompletedSessions'
              : (truthCheckoutOrders != null ? 'sales.truth.today.checkoutOrderCount (fallback)' : (truthOrders != null ? 'sales.truth.today.orderCount (fallback)' : 'unknown'));
            const aiPayload = {
              kind: 'kexo_diagnostics_v2',
              generatedAt: aiCopyGeneratedAt,
              diagnosticsSchemaVersion: (c && c.diagnostics && c.diagnostics.schemaVersion != null) ? c.diagnostics.schemaVersion : null,
              page: {
                href: (typeof window !== 'undefined' && window.location) ? window.location.href : '',
              },
              browser: {
                userAgent: (typeof navigator !== 'undefined' && navigator.userAgent) ? navigator.userAgent : '',
                language: (typeof navigator !== 'undefined' && navigator.language) ? navigator.language : '',
              },
              aiNotes: [
                'Truth = Shopify Orders API cache (orders_shopify). This is authoritative.',
                'Evidence = Web Pixel checkout_completed events (purchase_events). Evidence < Truth usually means missing pixel events (consent/adblock/checkout surface) or non-storefront orders.',
                'Kexo derived = purchases built from evidence; if derived matches evidence, drift is upstream of purchases.',
                'Inspect rawConfigStatus.sales.missingEvidence.today.missingOrdersSample for a sample of truth orders missing evidence.',
              ],
              computed: {
                sessions: {
                  shopifyToday: shopifySessionsToday,
                  kexoHumanToday: kexoSessionsToday,
                  diff: sessionsDiff,
                },
                conversions: {
                  definition: 'Shopify CR% uses ShopifyQL conversion_rate; Kexo CR% uses truth orders / sessions * 100',
                  shopifyCrSource,
                  convertedSessionsSource,
                  shopifyCrPct: shopifyCr,
                  kexoCrPct: kexoCr,
                  crDiffPctPoints: crDiff,
                  ordersPerSessionPct: {
                    shopify: shopifyOrderRate,
                    kexo: kexoOrderRate,
                    diffPctPoints: orderRateDiff,
                  },
                },
                truth: {
                  ordersPaidToday: truthOrders,
                  revenueGbpToday: truthRevenue,
                  checkoutTokenOrdersPaidToday: truthCheckoutOrders,
                  checkoutTokenRevenueGbpToday: truthCheckoutRevenue,
                },
                pixelDerived: {
                  ordersToday: pixelDerivedOrders,
                  revenueGbpToday: pixelDerivedRevenue,
                },
                evidence: {
                  checkoutCompletedEventsToday: evTotal,
                  checkoutCompletedSessionsToday: evSessions,
                  linkedEventsToday: evLinked,
                  unlinkedEventsToday: evUnlinked,
                },
                drift: {
                  pixelVsTruthOrders: driftPixelOrders,
                  pixelVsTruthRevenueGbp: driftPixelRevenue,
                  evidenceVsCheckoutTokenOrders: driftEvidenceCheckoutOrders,
                },
                salesEvidence: {
                  evidenceCoveragePct: (truthCheckoutOrders != null && truthCheckoutOrders > 0 && evTotal != null) ? ((evTotal / truthCheckoutOrders) * 100) : null,
                  missingEvidenceOrderCount: missingEvidenceCount,
                  missingEvidenceSample: (missingEvidenceSample && missingEvidenceSample.length) ? missingEvidenceSample.slice(0, 25) : [],
                },
                pixel: {
                  shopifyWebPixelOk: (pixel && typeof pixel.ok === 'boolean') ? pixel.ok : null,
                  shopifyWebPixelInstalled: (pixel && typeof pixel.installed === 'boolean') ? pixel.installed : null,
                  pixelIngestUrl,
                  expectedIngestUrl,
                  ingestUrlMatch,
                },
                settings: {
                  pixelSessionMode,
                  sharedSessionFixEnabled,
                  chartsUiSummary: (c && c.settings && c.settings.chartsUiSummary) ? c.settings.chartsUiSummary : null,
                  kpiUiSummary: (c && c.settings && c.settings.kpiUiSummary) ? c.settings.kpiUiSummary : null,
                },
              },
              rawConfigStatus: c,
            };
            aiPayloadData = aiPayload;
            aiCopyText =
              'Kexo diagnostics (paste this for AI)\n' +
              'Generated: ' + aiCopyGeneratedAt + '\n' +
              (shopify && shopify.shop ? ('Shop: ' + shopify.shop + '\n') : '') +
              '\n```json\n' + JSON.stringify(aiPayload, null, 2) + '\n```\n';
          } catch (err) {
            aiCopyText = 'Kexo diagnostics (AI)\nGenerated: ' + aiCopyGeneratedAt + '\nError building payload: ' + (err && err.message ? String(err.message) : String(err)) + '\n';
          }

          const copyIcon = '<i class="fa-light fa-copy" data-icon-key="diag-copy" aria-hidden="true"></i>';

          // Settings ??? Diagnostics (Tabler accordion, no tabs/custom dm-* classes)
          function badgeLt(text, tone) {
            var cls = 'bg-secondary-lt';
            if (tone === 'ok') cls = 'bg-success-lt';
            else if (tone === 'warn') cls = 'bg-warning-lt';
            else if (tone === 'bad') cls = 'bg-danger-lt';
            return '<span class="badge ' + cls + '">' + escapeHtml(String(text || '')) + '</span>';
          }
          function cardSm(titleHtml, bodyHtml) {
            return (
              '<div class="card card-sm">' +
                '<div class="card-header"><h4 class="card-title mb-0">' + titleHtml + '</h4></div>' +
                '<div class="card-body">' + (bodyHtml || '') + '</div>' +
              '</div>'
            );
          }
          function kvTable(rows) {
            if (typeof buildKexoSettingsTable !== 'function') {
              var body = (rows || []).map(function(r) {
                return '<tr><td class="text-secondary">' + escapeHtml(r[0] || '') + '</td><td class="text-end">' + (r[1] != null ? String(r[1]) : '\u2014') + '</td></tr>';
              }).join('');
              return '<div class="table-responsive"><table class="table table-sm table-vcenter mb-0"><tbody>' + body + '</tbody></table></div>';
            }
            var def = (window.KEXO_APP_MODAL_TABLE_DEFS && window.KEXO_APP_MODAL_TABLE_DEFS['diagnostics-kv-table']) || {};
            return buildKexoSettingsTable({
              tableClass: 'table table-sm table-vcenter mb-0',
              columns: (def.columns || []).length ? def.columns : [
                { header: 'Metric', headerClass: 'text-secondary' },
                { header: 'Value', headerClass: 'text-end' }
              ],
              bodyHtml: (rows || []).map(function(r) {
                return '<tr><td class="text-secondary">' + escapeHtml(r[0] || '') + '</td><td class="text-end">' + (r[1] != null ? String(r[1]) : '\u2014') + '</td></tr>';
              }).join('')
            });
          }
          function accordionItem(key, title, bodyHtml) {
            var safeKey = String(key || '').replace(/[^a-z0-9_-]+/gi, '');
            var headingId = 'settings-diagnostics-heading-' + safeKey;
            var collapseId = 'settings-diagnostics-collapse-' + safeKey;
            return (
              '<div class="accordion-item">' +
                '<h2 class="accordion-header" id="' + escapeHtml(headingId) + '">' +
                  '<button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#' + escapeHtml(collapseId) + '" aria-expanded="false" aria-controls="' + escapeHtml(collapseId) + '">' +
                    '<span class="kexo-settings-accordion-chevron"><i class="fa-regular fa-chevron-down" aria-hidden="true"></i></span>' +
                    '<span class="fw-semibold">' + escapeHtml(title || '') + '</span>' +
                  '</button>' +
                '</h2>' +
                '<div id="' + escapeHtml(collapseId) + '" class="accordion-collapse collapse" aria-labelledby="' + escapeHtml(headingId) + '" data-bs-parent="#settings-diagnostics-accordion">' +
                  '<div class="accordion-body">' + (bodyHtml || '') + '</div>' +
                '</div>' +
              '</div>'
            );
          }

          var overviewBody = '';
          overviewBody += '<div class="row g-3">';
          overviewBody +=   '<div class="col-12 col-xl-6">' + cardSm(
            '<span class="d-flex align-items-center gap-2"><img src="' + escapeHtml(SHOPIFY_LOGO_URL) + '" width="20" height="20" alt="" aria-hidden="true" decoding="async" /><span>Shopify</span></span>',
            kvTable([
              ['Sessions (' + overviewLabel + ')', fmtSessions(overviewShopifySessions)],
              ['CR% (' + overviewLabel + ')', fmtPct(overviewShopifyCr)],
              ['Orders (paid, ' + overviewLabel + ')', overviewTruthOrders != null ? escapeHtml(String(overviewTruthOrders)) : '\u2014'],
              ['Revenue (paid, ' + overviewLabel + ')', fmtRevenue(overviewTruthRevenue)],
            ])
          ) + '</div>';
          overviewBody +=   '<div class="col-12 col-xl-6">' + cardSm(
            '<span class="d-flex align-items-center gap-2"><img src="' + escapeHtml(KEXO_LOGO_URL) + '" width="20" height="20" alt="" aria-hidden="true" decoding="async" /><span>Kexo</span></span>',
            kvTable([
              ['Sessions (human, ' + overviewLabel + ')', fmtSessions(overviewKexoSessions)],
              ['CR% (truth, ' + overviewLabel + ')', fmtPct(overviewKexoCr)],
              ['Bots blocked (' + overviewLabel + ')', overviewBotsBlocked != null ? edgeBlocksButtonHtml(overviewBotsBlocked, '24h') : '\u2014'],
              ['Orders (paid, ' + overviewLabel + ')', overviewTruthOrders != null ? escapeHtml(String(overviewTruthOrders)) : '\u2014'],
              ['Revenue (paid, ' + overviewLabel + ')', fmtRevenue(overviewTruthRevenue)],
            ])
          ) + '</div>';
          overviewBody += '</div>';
          if (overviewShopifyCrSource) {
            overviewBody += '<div class="text-secondary small mt-3">Shopify CR source: ' + escapeHtml(overviewShopifyCrSource) + '</div>';
          }
          if (overviewShopifySessionsNote) {
            overviewBody += '<div class="text-secondary small mt-2">' + escapeHtml(overviewShopifySessionsNote) + '</div>';
          } else if (shopifyConversionRateNote) {
            overviewBody += '<div class="text-secondary small mt-2">' + escapeHtml(shopifyConversionRateNote) + '</div>';
          }

          var salesBody = '';
          var lastReconcile = truth && truth.lastReconcile ? truth.lastReconcile : null;
          var reconcileBits = [];
          if (lastReconcile && typeof lastReconcile.fetched === 'number') reconcileBits.push('fetched ' + String(lastReconcile.fetched));
          if (lastReconcile && typeof lastReconcile.inserted === 'number') reconcileBits.push('inserted ' + String(lastReconcile.inserted));
          if (lastReconcile && typeof lastReconcile.updated === 'number') reconcileBits.push('updated ' + String(lastReconcile.updated));
          if (lastReconcile && typeof lastReconcile.evidenceLinked === 'number') reconcileBits.push('linked ' + String(lastReconcile.evidenceLinked));
          var denomForCoverage = (truthCheckoutOrders != null ? truthCheckoutOrders : truthOrders);
          var missingOrders = (typeof missingEvidenceCount === 'number')
            ? missingEvidenceCount
            : ((denomForCoverage != null && evTotal != null) ? Math.max(0, denomForCoverage - evTotal) : null);
          salesBody += '<div class="row g-3">';
          salesBody +=   '<div class="col-12 col-xl-6">' + cardSm('Truth (paid)', kvTable([
            ['Orders', truthOrders != null ? escapeHtml(String(truthOrders)) : '\u2014'],
            ['Revenue', fmtRevenue(truthRevenue)],
            ['Checkout-token orders', truthCheckoutOrders != null ? escapeHtml(String(truthCheckoutOrders)) : '\u2014'],
            ['Checkout-token revenue', truthCheckoutRevenue != null ? fmtRevenue(truthCheckoutRevenue) : '\u2014'],
            ['Returning customers', truthReturningCustomers != null ? escapeHtml(String(truthReturningCustomers)) : '\u2014'],
            ['Returning revenue', truthReturningRevenue != null ? fmtRevenue(truthReturningRevenue) : '\u2014'],
          ])) + '</div>';
          salesBody +=   '<div class="col-12 col-xl-6">' + cardSm('Evidence + Pixel', kvTable([
            ['Evidence events (today)', evTotal != null ? escapeHtml(String(evTotal)) : '\u2014'],
            ['Converted sessions (today)', evSessions != null ? escapeHtml(String(evSessions)) : '\u2014'],
            ['Linked / unlinked', (evLinked != null && evUnlinked != null) ? (escapeHtml(String(evLinked)) + ' / ' + escapeHtml(String(evUnlinked))) : '\u2014'],
            ['Pixel derived orders', pixelDerivedOrders != null ? escapeHtml(String(pixelDerivedOrders)) : '\u2014'],
            ['Pixel derived revenue', pixelDerivedRevenue != null ? fmtRevenue(pixelDerivedRevenue) : '\u2014'],
          ])) + '</div>';
          salesBody +=   '<div class="col-12">' + cardSm('Drift + reconcile', kvTable([
            ['Pixel vs checkout-token (orders)', driftPixelCheckoutOrders == null ? '\u2014' : escapeHtml(String(driftPixelCheckoutOrders >= 0 ? '+' : '') + String(driftPixelCheckoutOrders))],
            ['Pixel vs checkout-token (revenue)', driftPixelCheckoutRevenue == null ? '\u2014' : escapeHtml('\u00a3' + String(driftPixelCheckoutRevenue >= 0 ? '+' : '') + String(driftPixelCheckoutRevenue))],
            ['Evidence vs checkout-token (orders)', driftEvidenceCheckoutOrders == null ? '\u2014' : escapeHtml(String(driftEvidenceCheckoutOrders >= 0 ? '+' : '') + String(driftEvidenceCheckoutOrders))],
            ['Missing evidence (count)', missingOrders == null ? '\u2014' : badgeLt(String(missingOrders), missingOrders === 0 ? 'ok' : (missingOrders <= 3 ? 'warn' : 'bad'))],
            ['Last reconcile', (lastReconcile && typeof lastReconcile.ts === 'number')
              ? (escapeHtml(formatTs(lastReconcile.ts)) + (reconcileBits.length ? (' \u00b7 ' + escapeHtml(reconcileBits.join(', '))) : ''))
              : '\u2014'],
          ])) + '</div>';
          salesBody += '</div>';
          if (missingEvidenceNote) {
            salesBody += '<div class="text-secondary small mt-3">' + escapeHtml(missingEvidenceNote) + '</div>';
          }
          if (missingEvidenceSample && missingEvidenceSample.length) {
            function missingLineSimple(o) {
              if (!o || typeof o !== 'object') return '';
              var bits = [];
              var on = o.order_name != null ? String(o.order_name).trim() : '';
              var oid = o.order_id != null ? String(o.order_id).trim() : '';
              var ca = (o.created_at != null && isFinite(Number(o.created_at))) ? Number(o.created_at) : null;
              var src = o.source_name != null ? String(o.source_name).trim() : '';
              if (on) bits.push(on);
              if (oid) bits.push('id ' + oid);
              if (ca != null) bits.push(formatTs(ca));
              if (src) bits.push('source=' + src);
              return bits.length ? bits.join(' \u00b7 ') : '';
            }
            var lines = missingEvidenceSample.slice(0, 20).map(missingLineSimple).filter(Boolean);
            if (lines.length) {
              salesBody += '<details class="mt-3">';
              salesBody +=   '<summary class="text-secondary">Missing evidence orders (sample ' + escapeHtml(String(missingEvidenceSample.length)) + ')</summary>';
              salesBody +=   '<div class="mt-2">';
              salesBody +=     lines.map(function(t) { return '<div class="text-secondary small">' + escapeHtml(t) + '</div>'; }).join('');
              salesBody +=   '</div>';
              salesBody += '</details>';
            }
          }

          var acquisitionBody = '';
          acquisitionBody += '<div class="row g-3">';
          acquisitionBody +=   '<div class="col-12 col-xl-6">' + cardSm('Sessions (today)', kvTable([
            ['Reached app', (traffic && traffic.today && typeof traffic.today.sessionsReachedApp === 'number') ? escapeHtml(formatSessions(traffic.today.sessionsReachedApp)) : '\u2014'],
            ['Human sessions', (traffic && traffic.today && typeof traffic.today.humanSessions === 'number') ? escapeHtml(formatSessions(traffic.today.humanSessions)) : '\u2014'],
            ['Bot sessions tagged', (traffic && traffic.today && typeof traffic.today.botSessionsTagged === 'number') ? escapeHtml(formatSessions(traffic.today.botSessionsTagged)) : '\u2014'],
            ['Total sessions est.', (traffic && traffic.today && typeof traffic.today.totalTrafficEst === 'number') ? escapeHtml(formatSessions(traffic.today.totalTrafficEst)) : '\u2014'],
          ])) + '</div>';
          acquisitionBody +=   '<div class="col-12 col-xl-6">' + cardSm('Shopify vs ours', kvTable([
            ['Shopify sessions (today)', shopifySessionsToday != null ? escapeHtml(formatSessions(shopifySessionsToday)) : '\u2014'],
            ['Shopify CR% (today)', fmtPct(shopifyCr)],
            ['Ours CR% (truth, today)', fmtPct(kexoCr)],
          ])) + '</div>';
          acquisitionBody += '</div>';

          var pixelBody = '';
          var installedBadge = (pixel && pixel.installed === true) ? badgeLt('Installed', 'ok') : ((pixel && pixel.installed === false) ? badgeLt('Not installed', 'bad') : badgeLt('\u2014', 'warn'));
          pixelBody += '<div class="row g-3">';
          pixelBody +=   '<div class="col-12 col-xl-6">' + cardSm('Pixel (Shopify)', kvTable([
            ['Installed', installedBadge],
            ['Pixel ingestUrl', pixelIngestUrl ? code(pixelIngestUrl) : '\u2014'],
            ['Expected ingestUrl', expectedIngestUrl ? code(expectedIngestUrl) : '\u2014'],
            ['IngestUrl match', ingestUrlMatch == null ? '\u2014' : (ingestUrlMatch ? badgeLt('Match', 'ok') : badgeLt('Mismatch', 'bad'))],
          ])) + '</div>';
          pixelBody +=   '<div class="col-12 col-xl-6">' + cardSm('Session mode', (
            '<div class="form-check form-switch mb-2">' +
              '<input class="form-check-input" type="checkbox" id="pixel-session-mode-toggle"' + (sharedSessionFixEnabled ? ' checked' : '') + ' />' +
              '<label class="form-check-label" for="pixel-session-mode-toggle">Share session across tabs (30m inactivity)</label>' +
            '</div>' +
            '<div class="text-secondary small">Auto-saves. ON shares one session across tabs (30m inactivity) to reduce inflated session counts. OFF uses legacy per-tab sessions.</div>' +
            '<div id="pixel-session-mode-msg" class="form-hint mt-2"></div>'
          )) + '</div>';
          pixelBody += '</div>';

          var shopifyBody = '';
          shopifyBody += '<div class="row g-3">';
          shopifyBody +=   '<div class="col-12 col-xl-6">' + cardSm('Auth + scopes', kvTable([
            ['Shop', shopify && shopify.shop ? code(shopify.shop) : badgeLt('Missing', 'bad')],
            ['Token stored', shopify && shopify.hasToken ? badgeLt('Yes', 'ok') : badgeLt('No', 'bad')],
            ['Stored scopes', storedScopesStr ? code(storedScopesStr) : '\u2014'],
            ['Required scopes', serverScopesStr ? code(serverScopesStr) : '\u2014'],
            ['Missing scopes', missingScopes.length ? code(missingScopes.join(', ')) : badgeLt('None', 'ok')],
          ])) + '</div>';
          shopifyBody +=   '<div class="col-12 col-xl-6">' + cardSm('Truth sync health', kvTable([
            ['Sync age', staleSec != null ? code(String(staleSec) + 's') : '\u2014'],
            ['Last sync', (health && health.lastSuccessAt) ? code(formatTs(health.lastSuccessAt)) : '\u2014'],
            ['Last error', (health && health.lastError) ? code(String(health.lastError).slice(0, 220)) : '\u2014'],
            ['Last order', (typeof truthToday.lastOrderCreatedAt === 'number') ? code(formatTs(truthToday.lastOrderCreatedAt)) : '\u2014'],
          ])) + '</div>';
          shopifyBody += '</div>';

          var googleAdsBody = '';
          try {
            var ads = c && c.ads ? c.ads : {};
            var adsStatus = ads && ads.status ? ads.status : null;
            var providers = (adsStatus && Array.isArray(adsStatus.providers)) ? adsStatus.providers : [];
            var g = providers.find(function(p) { return p && String(p.key || '').toLowerCase() === 'google_ads'; }) || null;
            var connected = g && g.connected === true;
            var configured = g && g.configured === true;
            var customerId = (g && g.customerId) ? String(g.customerId) : '';
            var loginCustomerId = (g && g.loginCustomerId) ? String(g.loginCustomerId) : '';
            var hasRefreshToken = g && g.hasRefreshToken === true;
            var hasDeveloperToken = g && g.hasDeveloperToken === true;
            var hasAdsDb = g && g.adsDb === true;
            var apiVer = (ads && typeof ads.googleAdsApiVersion === 'string') ? ads.googleAdsApiVersion : '';
            var oauthEnabled = ads && ads.googleAdsOAuthEnabled === true;
            var connectUrl = '/api/ads/google/connect?redirect=' + encodeURIComponent('/settings?tab=integrations');
            googleAdsBody += '<div class="row g-3">';
            googleAdsBody +=   '<div class="col-12 col-xl-6">' + cardSm('Connection', kvTable([
              ['Configured', configured ? badgeLt('Yes', 'ok') : badgeLt('No', 'bad')],
              ['Connected (refresh_token)', connected ? badgeLt('Yes', 'ok') : badgeLt('No', 'bad')],
              ['ADS DB', hasAdsDb ? badgeLt('OK', 'ok') : badgeLt('Missing', 'bad')],
              ['Customer ID', customerId ? code(customerId) : '\u2014'],
              ['Login Customer ID', loginCustomerId ? code(loginCustomerId) : '\u2014'],
              ['Developer token', hasDeveloperToken ? badgeLt('Set', 'ok') : badgeLt('Missing', 'bad')],
              ['Refresh token', hasRefreshToken ? badgeLt('Present', 'ok') : badgeLt('Missing', 'bad')],
              ['API version hint', apiVer ? code(apiVer) : badgeLt('Auto', 'ok')],
            ])) + '</div>';
            googleAdsBody +=   '<div class="col-12 col-xl-6">' + cardSm('Actions', (
              '<div class="d-flex align-items-center gap-2 flex-wrap">' +
                (oauthEnabled ? ('<a class="btn btn-outline-primary btn-sm" href="' + escapeHtml(connectUrl) + '">' + copyIcon + ' Connect</a>') : '') +
                '<button type="button" id="ga-status-btn" class="btn btn-outline-secondary btn-sm">' + copyIcon + ' Status</button>' +
                '<button type="button" id="ga-summary-btn" class="btn btn-outline-secondary btn-sm">' + copyIcon + ' Summary</button>' +
                '<button type="button" id="ga-refresh-7d-btn" class="btn btn-outline-secondary btn-sm">' + copyIcon + ' Refresh 7d</button>' +
                '<button type="button" id="ga-refresh-month-btn" class="btn btn-outline-secondary btn-sm">' + copyIcon + ' Refresh month</button>' +
                '<span id="ga-msg" class="form-hint ms-2"></span>' +
              '</div>' +
              '<div class="text-secondary small mt-2">Refresh returns spend sync diagnostics including per-version attempts when Google Ads REST errors occur.</div>'
            )) + '</div>';
            googleAdsBody +=   '<div class="col-12">' + cardSm('Output', (
              '<pre id="ga-output" class="mb-0 small">' + escapeHtml(JSON.stringify({ ads: adsStatus }, null, 2)) + '</pre>'
            )) + '</div>';
            googleAdsBody += '</div>';
          } catch (err) {
            googleAdsBody = '<div class="alert alert-danger mb-0">Google Ads diagnostics failed to render.</div>';
          }

          var systemBody = '';
          var tablesLine = '';
          if (db && db.tables) {
            var t = db.tables;
            var bits = [];
            function add(name, ok) { bits.push(name + (ok ? ' \u2713' : ' \u2717')); }
            add('settings', !!t.settings);
            add('shop_sessions', !!t.shop_sessions);
            add('visitors', !!t.visitors);
            add('sessions', !!t.sessions);
            add('events', !!t.events);
            add('purchases', !!t.purchases);
            add('orders_shopify', !!t.orders_shopify);
            add('orders_shopify_line_items', !!t.orders_shopify_line_items);
            add('customer_order_facts', !!t.customer_order_facts);
            add('purchase_events', !!t.purchase_events);
            add('reconcile_state', !!t.reconcile_state);
            add('reconcile_snapshots', !!t.reconcile_snapshots);
            add('shopify_sessions_snapshots', !!t.shopify_sessions_snapshots);
            add('audit_log', !!t.audit_log);
            add('bot_block_counts', !!t.bot_block_counts);
            tablesLine = bits.join(' \u00b7 ');
          }
          systemBody += '<div class="row g-3">';
          systemBody +=   '<div class="col-12 col-xl-6">' + cardSm('Reporting', kvTable([
            ['Orders source', reporting && reporting.ordersSource ? code(reporting.ordersSource) : '\u2014'],
            ['Sessions source', reporting && reporting.sessionsSource ? code(reporting.sessionsSource) : '\u2014'],
          ])) + '</div>';
          systemBody +=   '<div class="col-12 col-xl-6">' + cardSm('Runtime', kvTable([
            ['App version', app && app.version ? code(app.version) : '\u2014'],
            ['DB', db && db.engine ? code(db.engine + (db.configured ? '' : ' (DB_URL not set)')) : '\u2014'],
            ['Tables', tablesLine ? code(tablesLine) : '\u2014'],
            ['Sentry', (app && typeof app.sentryConfigured === 'boolean') ? (app.sentryConfigured ? badgeLt('ON', 'ok') : badgeLt('OFF', 'bad')) : '\u2014'],
          ])) + '</div>';
          systemBody += '</div>';

          var defsBody = '';
          try {
            if (trackerDefinitions && typeof trackerDefinitions === 'object') {
              defsBody = cardSm('Tracker definitions (raw)', '<pre class="mb-0 small">' + escapeHtml(JSON.stringify(trackerDefinitions, null, 2)) + '</pre>');
            } else {
              defsBody = '<div class="text-secondary">No tracker definitions available from server.</div>';
            }
          } catch (_) {
            defsBody = '<div class="text-secondary">No tracker definitions available from server.</div>';
          }

          var advancedBody = '';
          advancedBody += '<div class="d-flex align-items-center gap-2 flex-wrap">';
          advancedBody +=   '<button type="button" id="be-copy-ai-btn" class="btn btn-outline-secondary btn-sm" title="Copy a detailed diagnostics payload for AI">' + copyIcon + ' Copy AI debug</button>';
          advancedBody +=   '<button type="button" id="be-download-ai-json-btn" class="btn btn-outline-secondary btn-sm" title="Download diagnostics JSON for AI"><i class="fa-light fa-download" aria-hidden="true"></i> Download JSON</button>';
          advancedBody +=   '<span id="be-copy-ai-msg" class="form-hint ms-2"></span>';
          advancedBody += '</div>';
          advancedBody += '<div class="text-secondary small mt-2">Generated at ' + escapeHtml(aiCopyGeneratedAt) + '.</div>';

          var html = '';
          html += '<div class="accordion settings-layout-accordion" id="settings-diagnostics-accordion">';
          html += accordionItem('overview', 'Overview', overviewBody);
          html += accordionItem('sales', 'Sales', salesBody);
          html += accordionItem('acquisition', 'Acquisition', acquisitionBody);
          html += accordionItem('pixel', 'Pixel', pixelBody);
          html += accordionItem('shopify', 'Shopify', shopifyBody);
          html += accordionItem('googleads', 'Google Ads', googleAdsBody);
          html += accordionItem('system', 'System', systemBody);
          html += accordionItem('definitions', 'Definitions', defsBody);
          html += accordionItem('advanced', 'Advanced', advancedBody);
          html += '</div>';

          var targetEl = document.getElementById('diagnostics-content');
          if (diagnosticsStepEl) diagnosticsStepEl.textContent = 'Building diagnostics panel';
          if (targetEl) targetEl.innerHTML = html;

          // Preserve scroll position when refreshing while the modal is already open.
          try {
            if (preserveView && modalCardEl) modalCardEl.scrollTop = prevModalScrollTop;
          } catch (_) {}
          try {
            const compareIsOpenNow = !!(compareModalEl && compareModalEl.classList.contains('open'));
            if (compareIsOpenNow && compareStatusEl) {
              const updatedAtMs = (c && typeof c.now === 'number' && isFinite(c.now)) ? c.now : Date.now();

              function kickerForKey(key) {
                const k = key ? String(key).trim().toLowerCase() : '';
                if (k === 'sessions') return 'Sessions';
                if (k === 'aov') return 'AOV';
                return 'Conversion rate';
              }

              const compareKey = activeKpiCompareKey ? String(activeKpiCompareKey).trim().toLowerCase() : 'conv';
              if (compareKickerEl) compareKickerEl.textContent = kickerForKey(compareKey);

              function compareMetric(label, valueHtml) {
                return (
                  '<div class="kpi-compare-metric">' +
                    '<div class="kpi-compare-metric-label">' + escapeHtml(label) + '</div>' +
                    '<div class="kpi-compare-metric-value">' + (valueHtml || '\u2014') + '</div>' +
                  '</div>'
                );
              }
              function compareBrand(name, logoUrl, sub, rightHtml) {
                const right = rightHtml ? String(rightHtml) : '';
                return (
                  '<div class="kpi-compare-brand">' +
                    '<div class="kpi-compare-brand-left">' +
                      '<img class="kpi-compare-brand-icon" src="' + escapeHtml(String(logoUrl || '')) + '" width="28" height="28" alt="" aria-hidden="true" decoding="async" />' +
                      '<div class="kpi-compare-brand-text">' +
                        '<div class="kpi-compare-brand-name">' + escapeHtml(name || '') + '</div>' +
                        '<div class="kpi-compare-brand-sub">' + escapeHtml(sub || '') + '</div>' +
                      '</div>' +
                    '</div>' +
                    (right ? ('<div class="kpi-compare-brand-right">' + right + '</div>') : '') +
                  '</div>'
                );
              }
              function inlineMetric(label, valueHtml) {
                return (
                  '<span class="kpi-compare-inline-metric">' +
                    '<span class="kpi-compare-inline-label">' + escapeHtml(label || '') + '</span>' +
                    '<span class="kpi-compare-inline-value">' + (valueHtml || '\u2014') + '</span>' +
                  '</span>'
                );
              }

              function fmtSignedCount(v) {
                if (typeof v !== 'number' || !isFinite(v)) return '';
                const sign = v > 0 ? '+' : (v < 0 ? '-' : '');
                return sign + formatSessions(Math.abs(v));
              }
              function fmtSignedMoney(v) {
                if (typeof v !== 'number' || !isFinite(v)) return '';
                const sign = v > 0 ? '+' : (v < 0 ? '-' : '');
                return sign + formatRevenue(Math.abs(v));
              }
              function fmtSignedPp(v) {
                if (typeof v !== 'number' || !isFinite(v)) return '';
                const sign = v > 0 ? '+' : (v < 0 ? '-' : '');
                const abs = Math.abs(v);
                const s = (Math.round(abs * 100) / 100).toFixed(2).replace(/\.?0+$/, '');
                return sign + s + 'pp';
              }
              function safeAov(revenue, orders) {
                if (typeof revenue !== 'number' || !isFinite(revenue)) return null;
                if (typeof orders !== 'number' || !isFinite(orders) || orders <= 0) return null;
                return revenue / orders;
              }

              const botsTaggedToday = (traffic && traffic.today && typeof traffic.today.botSessionsTagged === 'number')
                ? traffic.today.botSessionsTagged
                : null;
              const totalTrafficEstToday = (traffic && traffic.today && typeof traffic.today.totalTrafficEst === 'number')
                ? traffic.today.totalTrafficEst
                : null;
              const sessionsReachedAppToday = (traffic && traffic.today && typeof traffic.today.sessionsReachedApp === 'number')
                ? traffic.today.sessionsReachedApp
                : null;

              const truthAov = safeAov(truthRevenue, truthOrders);
              const pixelAov = safeAov(pixelDerivedRevenue, pixelDerivedOrders);

              let diffText = '';
              if (compareKey === 'sessions') {
                const d = (kexoSessionsToday != null && shopifySessionsToday != null) ? (kexoSessionsToday - shopifySessionsToday) : null;
                diffText = (d != null) ? ('?? Sessions ' + fmtSignedCount(d)) : '';
              } else if (compareKey === 'aov') {
                const d = (pixelAov != null && truthAov != null) ? (pixelAov - truthAov) : null;
                diffText = (d != null) ? ('?? AOV ' + fmtSignedMoney(d)) : '';
              } else {
                const d = (kexoCr != null && shopifyCr != null) ? (kexoCr - shopifyCr) : null;
                diffText = (d != null) ? ('?? CR ' + fmtSignedPp(d)) : '';
              }

              if (compareUpdatedEl) {
                compareUpdatedEl.textContent = 'Updated ' + formatTs(updatedAtMs) + (diffText ? (' ?? ' + diffText) : '');
              }

              const ordersHtml = (truthOrders != null) ? escapeHtml(String(truthOrders)) : '\u2014';
              const pixelOrdersHtml = (pixelDerivedOrders != null) ? escapeHtml(String(pixelDerivedOrders)) : '\u2014';
              const missingEvidenceHtml = (typeof missingEvidenceCount === 'number' && isFinite(missingEvidenceCount)) ? escapeHtml(String(missingEvidenceCount)) : '\u2014';
              const evidenceHtml = (typeof evTotal === 'number' && isFinite(evTotal)) ? escapeHtml(String(evTotal)) : '\u2014';

              let cmpHtml = '';
              cmpHtml += '<div class="kpi-compare-grid">';

              if (compareKey === 'sessions') {
                cmpHtml +=   '<div class="kpi-compare-card kpi-compare-card--simple">';
                cmpHtml +=     compareBrand('Shopify', SHOPIFY_LOGO_URL, 'ShopifyQL sessions', inlineMetric('Sessions', fmtSessions(shopifySessionsToday)));
                cmpHtml +=   '</div>';
                cmpHtml +=   '<div class="kpi-compare-card kpi-compare-card--simple">';
                cmpHtml +=     compareBrand('Kexo', KEXO_LOGO_URL, 'Human sessions', inlineMetric('Sessions', fmtSessions(kexoSessionsToday)));
                cmpHtml +=   '</div>';
              } else if (compareKey === 'aov') {
                cmpHtml +=   '<div class="kpi-compare-card kpi-compare-card--simple">';
                cmpHtml +=     compareBrand('Shopify', SHOPIFY_LOGO_URL, 'Paid truth orders', inlineMetric('AOV', fmtRevenue(truthAov)));
                cmpHtml +=   '</div>';
                cmpHtml +=   '<div class="kpi-compare-card kpi-compare-card--simple">';
                cmpHtml +=     compareBrand('Kexo', KEXO_LOGO_URL, 'Pixel purchases (deduped)', inlineMetric('AOV', fmtRevenue(pixelAov)));
                cmpHtml +=   '</div>';
              } else {
                cmpHtml +=   '<div class="kpi-compare-card">';
                cmpHtml +=     compareBrand('Shopify', SHOPIFY_LOGO_URL, 'ShopifyQL sessions ?? conversion_rate');
                cmpHtml +=     '<div class="kpi-compare-metrics">' +
                                 compareMetric('CR% (Shopify)', fmtPct(shopifyCr)) +
                                 compareMetric('Sessions (today)', fmtSessions(shopifySessionsToday)) +
                                 compareMetric('Orders (paid)', ordersHtml) +
                                 compareMetric('Revenue (paid)', fmtRevenue(truthRevenue)) +
                               '</div>';
                cmpHtml +=   '</div>';
                cmpHtml +=   '<div class="kpi-compare-card">';
                cmpHtml +=     compareBrand('Kexo', KEXO_LOGO_URL, 'Human sessions ?? bot signals');
                cmpHtml +=     '<div class="kpi-compare-metrics">' +
                                 compareMetric('CR% (truth)', fmtPct(kexoCr)) +
                                 compareMetric('Sessions (human, today)', fmtSessions(kexoSessionsToday)) +
                                 compareMetric('Bots blocked (today)', botsBlockedToday != null ? edgeBlocksButtonHtml(botsBlockedToday, '24h') : '\u2014') +
                                 compareMetric('Bot-tagged (today)', botsTaggedToday != null ? fmtSessions(botsTaggedToday) : '\u2014') +
                               '</div>';
                cmpHtml +=   '</div>';
              }

              cmpHtml += '</div>';

              if (compareStepEl) compareStepEl.textContent = 'Building comparison view';
              compareStatusEl.innerHTML = cmpHtml;
            }
          } catch (_) {}
          try {
            const btn = document.getElementById('be-copy-ai-btn');
            const downloadBtn = document.getElementById('be-download-ai-json-btn');
            const msg = document.getElementById('be-copy-ai-msg');
            function setMsg(t, ok) {
              if (!msg) return;
              msg.textContent = t || '';
              msg.classList.remove('text-success', 'text-danger');
              msg.classList.add(ok ? 'text-success' : 'text-danger');
            }
            function fallbackCopy(t) {
              const ta = document.createElement('textarea');
              ta.value = t;
              ta.setAttribute('readonly', 'readonly');
              ta.style.position = 'fixed';
              ta.style.top = '-9999px';
              ta.style.left = '-9999px';
              document.body.appendChild(ta);
              ta.select();
              ta.setSelectionRange(0, ta.value.length);
              const ok = document.execCommand('copy');
              document.body.removeChild(ta);
              return ok;
            }
            if (btn) {
              btn.onclick = function() {
                const text = aiCopyText || '';
                try {
                  if (!text) {
                    setMsg('Nothing to copy', false);
                    return;
                  }
                  setMsg('Copying\u2026', true);
                  if (navigator && navigator.clipboard && typeof navigator.clipboard.writeText === 'function') {
                    navigator.clipboard.writeText(text)
                      .then(function() { setMsg('Copied (' + text.length + ' chars)', true); })
                      .catch(function(err) {
                        const ok = fallbackCopy(text);
                        if (ok) setMsg('Copied (' + text.length + ' chars)', true);
                        else setMsg('Copy failed: ' + (err && err.message ? String(err.message) : 'error'), false);
                      });
                  } else {
                    const ok = fallbackCopy(text);
                    if (ok) setMsg('Copied (' + text.length + ' chars)', true);
                    else setMsg('Copy failed', false);
                  }
                } catch (err) {
                  setMsg('Copy failed: ' + (err && err.message ? String(err.message) : 'error'), false);
                }
              };
            }
            if (downloadBtn) {
              downloadBtn.onclick = function() {
                try {
                  if (!aiPayloadData || typeof aiPayloadData !== 'object') {
                    setMsg('No JSON payload to download', false);
                    return;
                  }
                  var shopSafe = (shopify && shopify.shop) ? String(shopify.shop).replace(/[^a-z0-9.-]+/gi, '_') : 'shop';
                  var stamp = aiCopyGeneratedAt.replace(/[:.]/g, '-');
                  var filename = 'kexo-diagnostics-' + shopSafe + '-' + stamp + '.json';
                  var json = JSON.stringify(aiPayloadData, null, 2);
                  var blob = new Blob([json], { type: 'application/json;charset=utf-8' });
                  var url = URL.createObjectURL(blob);
                  var a = document.createElement('a');
                  a.href = url;
                  a.download = filename;
                  document.body.appendChild(a);
                  a.click();
                  document.body.removeChild(a);
                  URL.revokeObjectURL(url);
                  setMsg('Downloaded ' + filename, true);
                } catch (err) {
                  setMsg('Download failed: ' + (err && err.message ? String(err.message) : 'error'), false);
                }
              };
            }
          } catch (_) {}
          try {
            function setGaMsg(t, ok) {
              const msgEl = document.getElementById('ga-msg');
              if (!msgEl) return;
              msgEl.textContent = t || '';
              msgEl.classList.remove('text-success', 'text-danger');
              msgEl.classList.add(ok ? 'text-success' : 'text-danger');
            }
            function setGaOutput(obj) {
              const outEl = document.getElementById('ga-output');
              if (!outEl) return;
              try { outEl.textContent = JSON.stringify(obj, null, 2); }
              catch (_) { outEl.textContent = String(obj || ''); }
            }
            function fetchJson(url, options) {
              return fetch(url, options || { credentials: 'same-origin', cache: 'no-store' })
                .then(function(r) {
                  return r.text().then(function(t) {
                    let j = null;
                    try { j = t ? JSON.parse(t) : null; } catch (_) {}
                    return { ok: r.ok, status: r.status, json: j, text: t };
                  });
                });
            }
            const statusBtn = document.getElementById('ga-status-btn');
            const summaryBtn = document.getElementById('ga-summary-btn');
            const refresh7dBtn = document.getElementById('ga-refresh-7d-btn');
            const refreshMonthBtn = document.getElementById('ga-refresh-month-btn');
            if (statusBtn) {
              statusBtn.onclick = function() {
                setGaMsg('Fetching status\u2026', true);
                fetchJson((API || '') + '/api/ads/status', { credentials: 'same-origin', cache: 'no-store' })
                  .then(function(r) {
                    setGaOutput({ endpoint: 'GET /api/ads/status', status: r.status, ok: r.ok, body: r.json || r.text });
                    setGaMsg(r.ok ? 'Status OK' : ('Status error ' + r.status), r.ok);
                  })
                  .catch(function(err) {
                    setGaOutput({ endpoint: 'GET /api/ads/status', error: err && err.message ? String(err.message) : 'request_failed' });
                    setGaMsg('Status request failed', false);
                  });
              };
            }
            if (summaryBtn) {
              summaryBtn.onclick = function() {
                setGaMsg('Fetching summary\u2026', true);
                fetchJson((API || '') + '/api/ads/summary?range=7d', { credentials: 'same-origin', cache: 'no-store' })
                  .then(function(r) {
                    setGaOutput({ endpoint: 'GET /api/ads/summary?range=7d', status: r.status, ok: r.ok, body: r.json || r.text });
                    setGaMsg(r.ok ? 'Summary OK' : ('Summary error ' + r.status), r.ok);
                  })
                  .catch(function(err) {
                    setGaOutput({ endpoint: 'GET /api/ads/summary?range=7d', error: err && err.message ? String(err.message) : 'request_failed' });
                    setGaMsg('Summary request failed', false);
                  });
              };
            }
            function doRefresh(rangeKey) {
              setGaMsg('Refreshing ' + rangeKey + '\u2026', true);
              fetchJson((API || '') + '/api/ads/refresh?range=' + encodeURIComponent(rangeKey), {
                method: 'POST',
                credentials: 'same-origin',
                cache: 'no-store',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ source: 'googleads' }),
              })
                .then(function(r) {
                  setGaOutput({ endpoint: 'POST /api/ads/refresh?range=' + rangeKey, status: r.status, ok: r.ok, body: r.json || r.text });
                  setGaMsg(r.ok ? ('Refresh ' + rangeKey + ' OK') : ('Refresh error ' + r.status), r.ok);
                })
                .catch(function(err) {
                  setGaOutput({ endpoint: 'POST /api/ads/refresh?range=' + rangeKey, error: err && err.message ? String(err.message) : 'request_failed' });
                  setGaMsg('Refresh request failed', false);
                });
            }
            if (refresh7dBtn) refresh7dBtn.onclick = function() { doRefresh('7d'); };
            if (refreshMonthBtn) refreshMonthBtn.onclick = function() { doRefresh('month'); };
          } catch (_) {}
          try {
            const toggle = document.getElementById('pixel-session-mode-toggle');
            const msgEl = document.getElementById('pixel-session-mode-msg');
            if (toggle) {
              toggle.onchange = function() {
                const enabled = !!toggle.checked;
                const nextMode = enabled ? 'shared_ttl' : 'legacy';
                toggle.disabled = true;
                if (msgEl) msgEl.textContent = 'Saving\u2026';
                fetch(API + '/api/settings', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  credentials: 'same-origin',
                  cache: 'no-store',
                  body: JSON.stringify({ pixelSessionMode: nextMode }),
                })
                  .then(function(r) {
                    if (r.ok) return r.json();
                    return r.json().catch(function() { return null; }).then(function(j) {
                      const msg = j && j.error ? String(j.error) : ('HTTP ' + r.status);
                      throw new Error(msg);
                    });
                  })
                  .then(function() {
                    const shop = getShopParam();
                    if (shop && /\.myshopify\.com$/i.test(shop)) {
                      if (msgEl) msgEl.textContent = 'Saved. Syncing pixel settings\u2026';
                      return fetch(API + '/api/pixel/ensure?shop=' + encodeURIComponent(shop), { credentials: 'same-origin', cache: 'no-store' })
                        .then(function(r) { return r.ok ? r.json() : null; })
                        .catch(function() { return null; });
                    }
                    return null;
                  })
                  .then(function() {
                    if (msgEl) msgEl.textContent = 'Saved. Applies on next page view.';
                  })
                  .catch(function(err) {
                    if (msgEl) {
                      msgEl.textContent = 'Save failed: ' + (err && err.message ? String(err.message).slice(0, 140) : 'error');
                    }
                  })
                  .finally(function() {
                    toggle.disabled = false;
                    // Refresh diagnostics so the UI reflects the saved setting.
                    try { refreshConfigStatus({ force: true, preserveView: true }); } catch (_) {}
                  });
              };
            }
          } catch (_) {}
          if (typeof evidenceToday !== 'undefined' && typeof evidenceToday.lastOccurredAt === 'number') {
            setLastSaleAt(evidenceToday.lastOccurredAt);
          }
          if (options && options.force) {
            setDiagnosticsActionMsg('Diagnostics refreshed at ' + formatTs(Date.now()), true);
          }
          return c;
        })
        .catch(() => {
          const errEl = document.getElementById('diagnostics-content');
          if (errEl) {
            errEl.innerHTML = '<div class="alert alert-danger mb-0">Could not load diagnostics.</div>';
          }
          try {
            const compareIsOpenNow = !!(compareModalEl && compareModalEl.classList.contains('open'));
            if (compareIsOpenNow && compareStatusEl) {
              compareStatusEl.innerHTML =
                '<div class="kpi-compare-error">' +
                  '<div class="kpi-compare-error-title">Error</div>' +
                  '<div class="kpi-compare-error-body">Could not load comparison.</div>' +
                '</div>';
              if (compareUpdatedEl) compareUpdatedEl.textContent = 'Update failed';
            }
          } catch (_) {}
          if (options && options.force) {
            setDiagnosticsActionMsg('Diagnostics refresh failed.', false);
          }
        })
        .finally(function() {
          if (refreshBtn) refreshBtn.classList.remove('spinning');
          if (compareRefreshBtn) compareRefreshBtn.classList.remove('spinning');
          if (configStatusRefreshInFlight === p) configStatusRefreshInFlight = null;
        });
      configStatusRefreshInFlight = p;
      return p;
    }
    try { window.refreshConfigStatus = refreshConfigStatus; } catch (_) {}
    try { window.initTrafficSourceMapping = function(opts) { initTrafficSourceMappingPanel(opts || {}); }; } catch (_) {}

    updateLastSaleAgo();
    hydrateLastSaleFooterFromApi({ forceNew: false });
    _intervals.push(setInterval(function() {
      if (document.visibilityState !== 'visible') return;
      try { updateLastSaleAgo(); } catch (_) {}
    }, 10000));

    (function initDiagnosticsActions() {
      const openBtn = document.getElementById('config-open-btn');
      const refreshBtn = document.getElementById('config-refresh-btn');
      const reconcileBtn = document.getElementById('config-reconcile-btn');
      const rangeSel = document.getElementById('diagnostics-overview-range');
      if (rangeSel) rangeSel.addEventListener('change', function() {
        setDiagnosticsActionMsg('Loading overview\u2026', true);
        try { refreshConfigStatus({ force: true, preserveView: true }); } catch (_) {}
      });
      if (refreshBtn) refreshBtn.addEventListener('click', function() {
        setDiagnosticsActionMsg('Refreshing diagnostics\u2026', true);
        try { refreshConfigStatus({ force: true, preserveView: true }); } catch (_) {}
      });
      if (reconcileBtn) reconcileBtn.addEventListener('click', function() { try { reconcileSalesTruth({}); } catch (_) {} });
      if (openBtn && openBtn.tagName === 'A') {
        try { openBtn.setAttribute('href', '/settings'); } catch (_) {}
      }
    })();

    (function initKpiCompareModal() {
      const modal = document.getElementById('kpi-compare-modal');
      const refreshBtn = document.getElementById('kpi-compare-refresh-btn');
      const closeBtn = document.getElementById('kpi-compare-close-btn');
      const kickerEl = document.getElementById('kpi-compare-kicker');
      if (!modal) return;

      function kickerForKey(key) {
        const k = key ? String(key).trim().toLowerCase() : '';
        if (k === 'sessions') return 'Sessions';
        if (k === 'aov') return 'AOV';
        return 'Conversion rate';
      }

      function open(key) {
        activeKpiCompareKey = key ? String(key).trim().toLowerCase() : 'conv';
        if (kickerEl) kickerEl.textContent = kickerForKey(activeKpiCompareKey);
        modal.classList.add('open');
        modal.setAttribute('aria-hidden', 'false');
        try { refreshConfigStatus({ force: true, preserveView: true }); } catch (_) {}
      }
      function close() { modal.classList.remove('open'); modal.setAttribute('aria-hidden', 'true'); }

      document.addEventListener('click', function(e) {
        const target = e && e.target ? e.target : null;
        const btn = target && target.closest ? target.closest('.kpi-compare-open-btn[data-kpi-compare]') : null;
        if (!btn) return;
        e.preventDefault();
        e.stopPropagation();
        const key = (btn.getAttribute('data-kpi-compare') || '').trim().toLowerCase();
        open(key || 'conv');
      });

      if (refreshBtn) refreshBtn.addEventListener('click', function() { try { refreshConfigStatus({ force: true, preserveView: true }); } catch (_) {} });
      if (closeBtn) closeBtn.addEventListener('click', close);
      modal.addEventListener('click', function(e) { if (e.target === modal) close(); });
      document.addEventListener('keydown', function(e) {
        if (e.key !== 'Escape') return;
        if (!modal.classList.contains('open')) return;
        close();
      });
    })();

    (function initEdgeBlocksModal() {
      const BTN_SEL = '.kexo-edge-blocks-open-btn';
      const MODAL_ID = 'edge-blocks-modal';
      const RANGE_ID = 'edge-blocks-range-select';
      const REFRESH_ID = 'edge-blocks-refresh-btn';

      let modalEl = null;
      let modalApi = null;
      let abort = null;
      let activeRange = '24h';
      let activeReason = '';
      let activeCountry = '';
      let activeAsn = '';
      let activeQ = '';

      function isAdmin() {
        try {
          if (typeof window.__kexoGetEffectiveViewer === 'function') {
            const v = window.__kexoGetEffectiveViewer();
            return !!(v && v.isAdmin);
          }
        } catch (_) {}
        try { return !!window.__kexoEffectiveIsAdmin || !!window.__kexoIsMasterUser; } catch (_) { return false; }
      }

      function enableButtons() {
        try {
          const ok = isAdmin();
          const list = document.querySelectorAll ? document.querySelectorAll(BTN_SEL) : [];
          (list || []).forEach(function(btn) {
            if (!btn) return;
            try { btn.disabled = !ok; } catch (_) {}
            try { btn.setAttribute('aria-disabled', ok ? 'false' : 'true'); } catch (_) {}
            try { btn.title = ok ? 'Open edge blocks' : 'Admin only'; } catch (_) {}
          });
        } catch (_) {}
      }

      function safeJson(url, signal) {
        return fetch(url, { credentials: 'same-origin', cache: 'no-store', signal: signal }).then(function(r) { return r.json(); });
      }

      function esc(v) { try { return escapeHtml(String(v == null ? '' : v)); } catch (_) { return ''; } }

      function formatWhen(ts) {
        const n = ts != null ? Number(ts) : NaN;
        if (!Number.isFinite(n)) return '\u2014';
        try { if (typeof formatTs === 'function') return formatTs(n); } catch (_) {}
        try { return new Date(n).toLocaleString('en-GB'); } catch (_) { return String(n); }
      }

      function normaliseRange(v) {
        const k = v ? String(v).trim().toLowerCase() : '';
        return k === '7d' ? '7d' : '24h';
      }

      function sinceForRange(rangeKey) {
        const now = Date.now();
        return rangeKey === '7d' ? (now - 7 * 24 * 60 * 60 * 1000) : (now - 24 * 60 * 60 * 1000);
      }

      function cleanupInflight() {
        try { if (abort) abort.abort(); } catch (_) {}
        abort = null;
      }

      function ensureModal() {
        if (modalEl) return;
        modalEl = document.getElementById(MODAL_ID);
        if (!modalEl) {
          modalEl = document.createElement('div');
          modalEl.id = MODAL_ID;
          modalEl.className = 'modal modal-blur fade';
          modalEl.tabIndex = -1;
          modalEl.setAttribute('aria-hidden', 'true');
          modalEl.innerHTML =
            '<div class="modal-dialog modal-xl modal-dialog-centered" role="dialog">' +
              '<div class="modal-content">' +
                '<div class="modal-header">' +
                  '<div class="d-flex align-items-center gap-3">' +
                    '<h5 class="modal-title mb-0">Edge blocks</h5>' +
                    '<select class="form-select form-select-sm" id="' + esc(RANGE_ID) + '" aria-label="Range">' +
                      '<option value="24h">24h</option>' +
                      '<option value="7d">7d</option>' +
                    '</select>' +
                  '</div>' +
                  '<div class="d-flex align-items-center gap-2">' +
                    '<button type="button" class="btn btn-icon btn-ghost-secondary" id="' + esc(REFRESH_ID) + '" aria-label="Refresh edge blocks" title="Refresh">' +
                      '<i class="fa-light fa-rotate-right" aria-hidden="true"></i>' +
                      '<span>Refresh</span>' +
                    '</button>' +
                    '<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>' +
                  '</div>' +
                '</div>' +
                '<div class="modal-body">' +
                  '<div class="text-secondary small mb-2" id="edge-blocks-updated">\u2014</div>' +
                  '<div class="row g-3 mb-3" id="edge-blocks-cards">' +
                    '<div class="col-12 col-md-4"><div class="card card-sm"><div class="card-body"><div class="text-secondary">Total blocked</div><div class="h1 mb-0" id="edge-blocks-total">\u2014</div></div></div></div>' +
                    '<div class="col-12 col-md-4"><div class="card card-sm"><div class="card-body"><div class="text-secondary">Bots dropped</div><div class="h1 mb-0" id="edge-blocks-bots">\u2014</div></div></div></div>' +
                    '<div class="col-12 col-md-4"><div class="card card-sm"><div class="card-body"><div class="text-secondary">Junk dropped</div><div class="h1 mb-0" id="edge-blocks-junk">\u2014</div></div></div></div>' +
                  '</div>' +
                  '<ul class="nav nav-tabs" role="tablist">' +
                    '<li class="nav-item" role="presentation"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#edge-blocks-summary-tab" type="button" role="tab">Summary</button></li>' +
                    '<li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#edge-blocks-events-tab" type="button" role="tab">Recent events</button></li>' +
                  '</ul>' +
                  '<div class="tab-content pt-3">' +
                    '<div class="tab-pane fade show active" id="edge-blocks-summary-tab" role="tabpanel">' +
                      '<div class="row g-3">' +
                        '<div class="col-12 col-lg-6"><div class="card"><div class="card-header"><h3 class="card-title">By reason</h3></div><div class="table-responsive"><table class="table table-sm table-vcenter card-table"><thead><tr><th>Reason</th><th class="text-end">Count</th></tr></thead><tbody id="edge-blocks-by-reason"></tbody></table></div></div></div>' +
                        '<div class="col-12 col-lg-6"><div class="card"><div class="card-header"><h3 class="card-title">By country</h3></div><div class="table-responsive"><table class="table table-sm table-vcenter card-table"><thead><tr><th>Country</th><th class="text-end">Count</th></tr></thead><tbody id="edge-blocks-by-country"></tbody></table></div></div></div>' +
                        '<div class="col-12 col-lg-6"><div class="card"><div class="card-header"><h3 class="card-title">By ASN</h3></div><div class="table-responsive"><table class="table table-sm table-vcenter card-table"><thead><tr><th>ASN</th><th class="text-end">Count</th></tr></thead><tbody id="edge-blocks-by-asn"></tbody></table></div></div></div>' +
                        '<div class="col-12 col-lg-6"><div class="card"><div class="card-header"><h3 class="card-title">By verified bot category</h3></div><div class="table-responsive"><table class="table table-sm table-vcenter card-table"><thead><tr><th>Category</th><th class="text-end">Count</th></tr></thead><tbody id="edge-blocks-by-botcat"></tbody></table></div></div></div>' +
                      '</div>' +
                    '</div>' +
                    '<div class="tab-pane fade" id="edge-blocks-events-tab" role="tabpanel">' +
                      '<div class="row g-2 align-items-end mb-2">' +
                        '<div class="col-12 col-md-3"><label class="form-label">Reason</label><input class="form-control" id="edge-blocks-filter-reason" placeholder="e.g. bot" /></div>' +
                        '<div class="col-12 col-md-2"><label class="form-label">Country</label><input class="form-control" id="edge-blocks-filter-country" placeholder="GB" /></div>' +
                        '<div class="col-12 col-md-2"><label class="form-label">ASN</label><input class="form-control" id="edge-blocks-filter-asn" placeholder="e.g. 12345" /></div>' +
                        '<div class="col-12 col-md-5"><label class="form-label">Search</label><input class="form-control" id="edge-blocks-filter-q" placeholder="UA, origin, referer, path\u2026" /></div>' +
                      '</div>' +
                      '<div class="table-responsive">' +
                        '<table class="table table-sm table-vcenter">' +
                          '<thead><tr><th>Time</th><th>Reason</th><th>Result</th><th>Country</th><th>ASN</th><th>UA</th><th>Origin</th><th>Ray</th></tr></thead>' +
                          '<tbody id="edge-blocks-events-body"></tbody>' +
                        '</table>' +
                      '</div>' +
                      '<div class="text-secondary small mt-2" id="edge-blocks-events-meta">\u2014</div>' +
                    '</div>' +
                  '</div>' +
                '</div>' +
                '<div class="modal-footer">' +
                  '<button type="button" class="btn btn-primary" data-bs-dismiss="modal">Close</button>' +
                '</div>' +
              '</div>' +
            '</div>';
          document.body.appendChild(modalEl);
        }

        try {
          if (window.bootstrap && window.bootstrap.Modal) {
            modalApi = window.bootstrap.Modal.getOrCreateInstance(modalEl, { backdrop: true, keyboard: true, focus: true });
            modalEl.addEventListener('hidden.bs.modal', function() { cleanupInflight(); });
          }
        } catch (_) {}

        const rangeSel = document.getElementById(RANGE_ID);
        if (rangeSel) {
          rangeSel.addEventListener('change', function() {
            activeRange = normaliseRange(rangeSel.value);
            refresh();
          });
        }
        const refreshBtn = document.getElementById(REFRESH_ID);
        if (refreshBtn) refreshBtn.addEventListener('click', function() { refresh(); });

        function bindInput(id, apply) {
          const el = document.getElementById(id);
          if (!el) return;
          el.addEventListener('input', function() { apply(el.value); });
        }
        bindInput('edge-blocks-filter-reason', function(v) { activeReason = (v || '').trim(); });
        bindInput('edge-blocks-filter-country', function(v) { activeCountry = (v || '').trim(); });
        bindInput('edge-blocks-filter-asn', function(v) { activeAsn = (v || '').trim(); });
        bindInput('edge-blocks-filter-q', function(v) { activeQ = (v || '').trim(); });
        ['edge-blocks-filter-reason', 'edge-blocks-filter-country', 'edge-blocks-filter-asn', 'edge-blocks-filter-q'].forEach(function(id) {
          const el = document.getElementById(id);
          if (!el) return;
          el.addEventListener('keydown', function(e) { if (e && e.key === 'Enter') refresh(); });
        });
      }

      function setText(id, text) {
        const el = document.getElementById(id);
        if (el) el.textContent = text;
      }

      function renderCounts(tbodyId, rows, keyName) {
        const body = document.getElementById(tbodyId);
        if (!body) return;
        const list = Array.isArray(rows) ? rows : [];
        if (!list.length) {
          body.innerHTML = '<tr><td class="text-secondary" colspan="2">\u2014</td></tr>';
          return;
        }
        body.innerHTML = list.slice(0, 50).map(function(r) {
          const k = r && r[keyName] != null ? String(r[keyName]) : '';
          const n = r && r.count != null ? Number(r.count) : 0;
          return '<tr><td>' + esc(k) + '</td><td class="text-end">' + esc((Number.isFinite(n) ? n : 0)) + '</td></tr>';
        }).join('');
      }

      function renderEvents(rows) {
        const body = document.getElementById('edge-blocks-events-body');
        if (!body) return;
        const list = Array.isArray(rows) ? rows : [];
        if (!list.length) {
          body.innerHTML = '<tr><td class="text-secondary" colspan="8">\u2014</td></tr>';
          return;
        }
        body.innerHTML = list.slice(0, 200).map(function(r) {
          const ua = r && r.ua != null ? String(r.ua) : '';
          const origin = r && r.origin != null ? String(r.origin) : '';
          return (
            '<tr>' +
              '<td class="text-secondary">' + esc(formatWhen(r.created_at)) + '</td>' +
              '<td>' + esc(r.blocked_reason || '') + '</td>' +
              '<td class="text-secondary">' + esc(r.edge_result || '') + '</td>' +
              '<td>' + esc(r.country || '') + '</td>' +
              '<td class="text-secondary">' + esc(r.asn || '') + '</td>' +
              '<td class="text-secondary" title="' + esc(ua) + '">' + esc(ua.length > 38 ? (ua.slice(0, 38) + '\u2026') : ua) + '</td>' +
              '<td class="text-secondary" title="' + esc(origin) + '">' + esc(origin.length > 28 ? (origin.slice(0, 28) + '\u2026') : origin) + '</td>' +
              '<td class="text-secondary">' + esc(r.ray_id || '') + '</td>' +
            '</tr>'
          );
        }).join('');
      }

      function setLoading() {
        setText('edge-blocks-updated', 'Loading\u2026');
        setText('edge-blocks-total', '\u2014');
        setText('edge-blocks-bots', '\u2014');
        setText('edge-blocks-junk', '\u2014');
        renderCounts('edge-blocks-by-reason', [], 'blocked_reason');
        renderCounts('edge-blocks-by-country', [], 'country');
        renderCounts('edge-blocks-by-asn', [], 'asn');
        renderCounts('edge-blocks-by-botcat', [], 'verified_bot_category');
        renderEvents([]);
        setText('edge-blocks-events-meta', '\u2014');
      }

      function refresh() {
        if (!modalEl) return;
        cleanupInflight();
        abort = new AbortController();
        const signal = abort.signal;
        const rk = normaliseRange(activeRange);
        const since = sinceForRange(rk);
        const summaryUrl = API + '/api/edge-blocked/summary?range=' + encodeURIComponent(rk);
        let eventsUrl = API + '/api/edge-blocked/events?limit=200&since=' + encodeURIComponent(String(since));
        if (activeReason) eventsUrl += '&blocked_reason=' + encodeURIComponent(activeReason);
        if (activeCountry) eventsUrl += '&country=' + encodeURIComponent(activeCountry);
        if (activeAsn) eventsUrl += '&asn=' + encodeURIComponent(activeAsn);
        if (activeQ) eventsUrl += '&q=' + encodeURIComponent(activeQ);

        setLoading();
        Promise.all([safeJson(summaryUrl, signal), safeJson(eventsUrl, signal)])
          .then(function(parts) {
            const summary = parts && parts[0] ? parts[0] : null;
            const events = parts && parts[1] ? parts[1] : null;
            if (!summary || summary.ok !== true) throw new Error('Failed to load summary');
            if (!events || events.ok !== true) throw new Error('Failed to load events');

            const t = summary.totals || {};
            setText('edge-blocks-total', t.blocked != null ? String(t.blocked) : '\u2014');
            setText('edge-blocks-bots', t.bots != null ? String(t.bots) : '\u2014');
            setText('edge-blocks-junk', t.junk != null ? String(t.junk) : '\u2014');
            setText('edge-blocks-updated', 'Updated ' + formatWhen(Date.now()) + ' \u00b7 Range ' + rk);

            renderCounts('edge-blocks-by-reason', summary.by_reason, 'blocked_reason');
            renderCounts('edge-blocks-by-country', summary.by_country, 'country');
            renderCounts('edge-blocks-by-asn', summary.by_asn, 'asn');
            renderCounts('edge-blocks-by-botcat', summary.by_verified_bot_category, 'verified_bot_category');

            renderEvents(events.events || []);
            setText('edge-blocks-events-meta', 'Showing ' + String((events.events || []).length) + ' events since ' + formatWhen(events.since));
          })
          .catch(function(err) {
            if (signal && signal.aborted) return;
            setText('edge-blocks-updated', 'Failed to load edge blocks: ' + (err && err.message ? String(err.message) : 'error'));
          });
      }

      function open(rangeKey) {
        ensureModal();
        enableButtons();
        if (!isAdmin()) return;
        activeRange = normaliseRange(rangeKey);
        const rangeSel = document.getElementById(RANGE_ID);
        if (rangeSel) rangeSel.value = activeRange;
        try { if (modalApi && typeof modalApi.show === 'function') modalApi.show(); } catch (_) {}
        refresh();
      }

      document.addEventListener('click', function(e) {
        const target = e && e.target ? e.target : null;
        const btn = target && target.closest ? target.closest(BTN_SEL) : null;
        if (!btn) return;
        e.preventDefault();
        e.stopPropagation();
        if (btn.disabled) return;
        const rk = btn.getAttribute('data-edge-blocks-range') || '24h';
        open(rk);
      });

      try { window.addEventListener('kexo:viewer-changed', function() { enableButtons(); }); } catch (_) {}
      enableButtons();
    })();

    (function initTrafficTypeTree() {
      const body = document.getElementById('traffic-types-body');
      if (!body) return;
      body.addEventListener('click', function(e) {
        const target = e && e.target ? e.target : null;
        const btn = target && target.closest ? target.closest('.traffic-type-toggle') : null;
        if (!btn) return;
        e.preventDefault();
        e.stopPropagation();
        const device = (btn.getAttribute('data-device') || '').trim().toLowerCase();
        if (!device) return;
        if (!trafficTypeExpanded || typeof trafficTypeExpanded !== 'object') {
          // First click: snapshot current groups as all-open, then toggle the clicked one
          trafficTypeExpanded = {};
          document.querySelectorAll('.traffic-type-parent[data-device]').forEach(function(row) {
            var d = (row.getAttribute('data-device') || '').trim().toLowerCase();
            if (d) trafficTypeExpanded[d] = true;
          });
        }
        const nextOpen = !trafficTypeExpanded[device];
        trafficTypeExpanded[device] = nextOpen;
        btn.setAttribute('aria-expanded', nextOpen ? 'true' : 'false');
        body.querySelectorAll('.grid-row.traffic-type-child[data-parent="' + device + '"]').forEach(function(tr) {
          tr.classList.toggle('is-hidden', !nextOpen);
        });
      });
    })();

      (function initDevicesTree() {
        const body = document.getElementById('devices-body');
        if (!body) return;
        body.addEventListener('click', function(e) {
          const target = e && e.target ? e.target : null;
          const btn = target && target.closest ? target.closest('.devices-toggle[data-device-type]') : null;
          if (!btn) return;
          e.preventDefault();
          e.stopPropagation();
          const deviceType = (btn.getAttribute('data-device-type') || '').trim().toLowerCase();
          if (!deviceType) return;
          if (!devicesExpanded || typeof devicesExpanded !== 'object') {
            devicesExpanded = {};
            body.querySelectorAll('.devices-parent[data-device-type]').forEach(function(row) {
              var d = (row.getAttribute('data-device-type') || '').trim().toLowerCase();
              if (d) devicesExpanded[d] = true;
            });
          }
          const nextOpen = !devicesExpanded[deviceType];
          devicesExpanded[deviceType] = nextOpen;
          btn.setAttribute('aria-expanded', nextOpen ? 'true' : 'false');
          body.querySelectorAll('.grid-row.devices-child[data-parent="' + deviceType + '"]').forEach(function(tr) {
            tr.classList.toggle('is-hidden', !nextOpen);
          });
        });
      })();

      (function initAttributionTree() {
        const body = document.getElementById('attribution-body');
        if (!body) return;
        body.addEventListener('click', function(e) {
          const target = e && e.target ? e.target : null;
          const channelBtn = target && target.closest ? target.closest('.attribution-channel-toggle[data-channel]') : null;
          if (channelBtn) {
            e.preventDefault();
            e.stopPropagation();
            const chKey = (channelBtn.getAttribute('data-channel') || '').trim().toLowerCase();
            if (!chKey) return;
            if (!attributionExpandedChannels || typeof attributionExpandedChannels !== 'object') {
              attributionExpandedChannels = {};
              body.querySelectorAll('.attribution-channel-parent[data-channel]').forEach(function(row) {
                var k = (row.getAttribute('data-channel') || '').trim().toLowerCase();
                if (k) attributionExpandedChannels[k] = true;
              });
            }
            const nextOpen = !attributionExpandedChannels[chKey];
            attributionExpandedChannels[chKey] = nextOpen;
            channelBtn.setAttribute('aria-expanded', nextOpen ? 'true' : 'false');
            body.querySelectorAll('.grid-row.attribution-source-row[data-parent="' + chKey + '"]').forEach(function(tr) {
              tr.classList.toggle('is-hidden', !nextOpen);
            });
            body.querySelectorAll('.grid-row.attribution-variant-row[data-channel="' + chKey + '"]').forEach(function(tr) {
              if (!nextOpen) {
                tr.classList.add('is-hidden');
                return;
              }
              const src = (tr.getAttribute('data-source') || '').trim().toLowerCase();
              const k = chKey + '|' + (src || 'other');
              let srcOpen = true;
              if (attributionExpandedSources && typeof attributionExpandedSources === 'object' && Object.prototype.hasOwnProperty.call(attributionExpandedSources, k)) {
                srcOpen = !!attributionExpandedSources[k];
              }
              tr.classList.toggle('is-hidden', !srcOpen);
            });
            return;
          }

          const sourceBtn = target && target.closest ? target.closest('.attribution-source-toggle[data-channel][data-source]') : null;
          if (!sourceBtn) return;
          e.preventDefault();
          e.stopPropagation();
          const ch = (sourceBtn.getAttribute('data-channel') || '').trim().toLowerCase();
          const src = (sourceBtn.getAttribute('data-source') || '').trim().toLowerCase();
          if (!ch || !src) return;
          if (!attributionExpandedSources || typeof attributionExpandedSources !== 'object') {
            attributionExpandedSources = {};
            body.querySelectorAll('.attribution-source-row[data-channel][data-source]').forEach(function(row) {
              var c = (row.getAttribute('data-channel') || '').trim().toLowerCase();
              var s = (row.getAttribute('data-source') || '').trim().toLowerCase();
              if (c && s) attributionExpandedSources[c + '|' + s] = true;
            });
          }
          const key = ch + '|' + src;
          const nextOpen = !attributionExpandedSources[key];
          attributionExpandedSources[key] = nextOpen;
          sourceBtn.setAttribute('aria-expanded', nextOpen ? 'true' : 'false');
          const channelOpen = !(attributionExpandedChannels && typeof attributionExpandedChannels === 'object' && Object.prototype.hasOwnProperty.call(attributionExpandedChannels, ch)) || !!attributionExpandedChannels[ch];
          body.querySelectorAll('.grid-row.attribution-variant-row[data-parent="' + key + '"]').forEach(function(tr) {
            tr.classList.toggle('is-hidden', !(channelOpen && nextOpen));
          });
        });
      })();

    (function initTopBar() {
      try { saleMuted = sessionStorage.getItem(SALE_MUTED_KEY) === 'true'; } catch (_) { saleMuted = false; }
      try { saleAudio = new Audio(); } catch (_) { saleAudio = null; }
      if (saleAudio) {
        try { saleAudio.preload = 'auto'; } catch (_) {}
        try {
          window.__kexoApplySaleSoundOverride = function(url) {
            try { window.__kexoSaleSoundOverrideUrl = (url && String(url).trim()) || ''; } catch (_) {}
            if (typeof setSaleAudioSrc === 'function') {
              setSaleAudioSrc(typeof getCashRegisterMp3Url === 'function' ? getCashRegisterMp3Url() : (API || '') + '/assets/cash-register.mp3');
            }
          };
          window.__kexoPreviewSaleSound = function(url) {
            if (!saleAudio) return Promise.reject(new Error('Sale audio unavailable'));
            var nextUrl = url != null ? String(url).trim() : '';
            if (!nextUrl) {
              nextUrl = (typeof getCashRegisterMp3Url === 'function')
                ? getCashRegisterMp3Url()
                : ((API || '') + '/assets/cash-register.mp3');
            }
            var prevSrc = '';
            try { prevSrc = String(saleAudio.currentSrc || saleAudio.src || '').trim(); } catch (_) { prevSrc = ''; }
            if (nextUrl) {
              try { setSaleAudioSrc(nextUrl); } catch (_) {}
            }
            try { primeSaleAudio(); } catch (_) {}
            try { saleAudio.muted = false; } catch (_) {}
            try { saleAudio.currentTime = 0; } catch (_) {}
            var played = null;
            try {
              played = saleAudio.play();
            } catch (err) {
              if (prevSrc && nextUrl && prevSrc !== nextUrl) {
                try { setSaleAudioSrc(prevSrc); } catch (_) {}
              }
              return Promise.reject(err);
            }
            function restoreSrc() {
              if (prevSrc && nextUrl && prevSrc !== nextUrl) {
                try { setSaleAudioSrc(prevSrc); } catch (_) {}
              }
            }
            if (played && typeof played.finally === 'function') {
              return played.finally(restoreSrc);
            }
            restoreSrc();
            return Promise.resolve();
          };
        } catch (_) {}
        try { setSaleAudioSrc(typeof getCashRegisterMp3Url === 'function' ? getCashRegisterMp3Url() : (API || '') + '/assets/cash-register.mp3'); } catch (_) {}
        // Prime/unlock audio on the first user interaction so sale sounds can play later.
        (function primeOnFirstGesture() {
          function prime() { try { primeSaleAudio(); } catch (_) {} }
          document.addEventListener('pointerdown', prime, { once: true, capture: true });
          document.addEventListener('touchstart', prime, { once: true, capture: true });
          document.addEventListener('keydown', prime, { once: true, capture: true });
          document.addEventListener('click', prime, { once: true, capture: true });
        })();
      }
      function syncFooterAudioMute(muted) {
        document.querySelectorAll('.footer-audio-btn, .footer-settings-audio').forEach(function(btn) {
          btn.classList.toggle('muted', muted);
          var iconOn = btn.querySelector('.sound-icon-on');
          var iconOff = btn.querySelector('.sound-icon-off');
          if (iconOn) iconOn.classList.toggle('is-hidden', muted);
          if (iconOff) iconOff.classList.toggle('is-hidden', !muted);
        });
      }
      const muteBtn = document.getElementById('audio-mute-btn');
      const iconOn = muteBtn && muteBtn.querySelector('.sound-icon-on');
      const iconOff = muteBtn && muteBtn.querySelector('.sound-icon-off');
      if (muteBtn) {
        if (iconOn) iconOn.classList.toggle('is-hidden', saleMuted);
        if (iconOff) iconOff.classList.toggle('is-hidden', !saleMuted);
        muteBtn.classList.toggle('muted', saleMuted);
        syncFooterAudioMute(saleMuted);
        muteBtn.addEventListener('click', function() {
          saleMuted = !saleMuted;
          try { sessionStorage.setItem(SALE_MUTED_KEY, String(saleMuted)); } catch (_) {}
          if (iconOn) iconOn.classList.toggle('is-hidden', saleMuted);
          if (iconOff) iconOff.classList.toggle('is-hidden', !saleMuted);
          muteBtn.classList.toggle('muted', saleMuted);
          syncFooterAudioMute(saleMuted);
          if (!saleMuted) {
            // User gesture: unlock audio so future sale sounds work.
            try { primeSaleAudio(); } catch (_) {}
          }
        });
      }
      try {
        window.addEventListener('kexo:sale-sound-updated', function(e) {
          var url = (e && e.detail && e.detail.url) ? String(e.detail.url).trim() : '';
          if (typeof window.__kexoApplySaleSoundOverride === 'function') {
            window.__kexoApplySaleSoundOverride(url || null);
          }
        });
      } catch (_) {}
      // Test sale sound: add ?cha=ching to the URL. Plays once when sound is on; if autoplay blocked, plays on first click.
      (function testChaChing() {
        if (new URLSearchParams(window.location.search).get('cha') !== 'ching' || !saleAudio) return;
        function playTest() {
          if (saleMuted) return;
          saleAudio.currentTime = 0;
          saleAudio.play().catch(function() {});
        }
        playTest();
        document.body.addEventListener('click', function once() {
          document.body.removeEventListener('click', once);
          playTest();
        }, { once: true });
      })();
      const dateSelect = document.getElementById('global-date-select');
      if (dateSelect) {
        mountDesktopDatePickerIntoPageHeader();
        try {
          const syncHeaderDatePlacement = function() { mountDesktopDatePickerIntoPageHeader(); };
          window.addEventListener('resize', syncHeaderDatePlacement, { passive: true });
          window.addEventListener('orientationchange', syncHeaderDatePlacement);
          window.addEventListener('pageshow', syncHeaderDatePlacement);
        } catch (_) {}
        syncDateSelectOptions();
        applyRangeAvailable({ today: true, yesterday: true });
        updateLiveViewTitle();
        updateRowsPerPageVisibility();
        dateSelect.addEventListener('change', function() {
          const next = String(this.value || '').trim().toLowerCase();
          try {
            const opt = this.querySelector('option[value="' + next + '"]');
            if (opt && opt.disabled) {
              this.value = 'today';
              return;
            }
          } catch (_) {}
          if (next === 'custom') {
            openCustomDateModal();
            // Revert the select so "Custom" can be selected again.
            syncDateSelectOptions();
            return;
          }
          // Handle standard date ranges
          if (next === 'today' || next === 'yesterday' || next === '7days' || next === '14days' || next === '30days') {
            dateRange = next;
            applyDateRangeChange({ showTimeframeOverlay: true, source: 'header' });
            return;
          }
          // Defensive: allow selecting an applied range key if present.
          if (isCustomRangeKey(next)) {
            dateRange = next;
            applyDateRangeChange({ showTimeframeOverlay: true, source: 'header' });
          }
        });
        initCustomDateModal();
        initHeaderDateMenu();
        try { ensureUiSettingsLoaded({ apply: true }); } catch (_) {}
      }
      (function initTableTitleTabs() {
        const tabsWrap = document.getElementById('table-title-tabs');
        if (!tabsWrap) return;
        function setRangeFromTab(range) {
          dateRange = range;
          if (dateRange === 'sales' || dateRange === '1h') {
            const sel = document.getElementById('global-date-select');
            if (sel) sel.value = 'today';
          }
          lastOnlineCount = null;
          countryPage = 1;
          updateLiveViewTitle();
          updateRowsPerPageVisibility();
          refreshKpis({ force: true });
          updateKpis();
          fetchSessions();
          updateNextUpdateUi();
        }
        document.querySelectorAll('#table-title-tabs button[data-range]').forEach(function(btn) {
          btn.addEventListener('click', function() { setRangeFromTab(btn.getAttribute('data-range')); });
        });
      })();
      (function initMainTabs() {
        const TAB_KEY = 'kexo-main-tab';
        const VALID_TABS = ['dashboard', 'spy', 'sales', 'date', 'snapshot', 'stats', 'products', 'attribution', 'devices', 'ads', 'tools'];
        const TAB_LABELS = { dashboard: 'Overview', spy: 'Live View', sales: 'Recent Sales', date: 'Table View', snapshot: 'Snapshot', stats: 'Countries', products: 'Products', variants: 'Variants', attribution: 'Attribution', devices: 'Devices', ads: 'Google Ads', tools: 'Tools' };
        const HASH_TO_TAB = { dashboard: 'dashboard', 'live-view': 'spy', sales: 'sales', date: 'date', countries: 'stats', products: 'products', channels: 'attribution', type: 'devices', attribution: 'attribution', devices: 'devices', ads: 'ads', 'compare-conversion-rate': 'tools', 'change-pins': 'tools' };
        const TAB_TO_HASH = { dashboard: 'dashboard', spy: 'live-view', sales: 'sales', date: 'date', stats: 'countries', products: 'products', attribution: 'attribution', devices: 'devices', ads: 'ads', tools: 'compare-conversion-rate' };
        const tabDashboard = document.getElementById('nav-tab-dashboard');
        const tabSpy = document.getElementById('nav-tab-spy');
        const tabStats = document.getElementById('nav-tab-stats');
        const tabSnapshot = document.getElementById('nav-tab-snapshot');
        const tabProducts = document.getElementById('nav-tab-products');
        const tabVariants = document.getElementById('nav-tab-variants');
        const tabAds = document.getElementById('nav-tab-ads');
        const tabSales = document.getElementById('nav-tab-sales');
        const tabDate = document.getElementById('nav-tab-date');
        const tabTools = document.getElementById('nav-tab-tools');
        const panelDashboard = document.getElementById('tab-panel-dashboard');
        const panelSpy = document.getElementById('tab-panel-spy');
        const panelStats = document.getElementById('tab-panel-stats');
        const panelSnapshot = document.getElementById('tab-panel-snapshot');
        const panelProducts = document.getElementById('tab-panel-products');
        const panelAds = document.getElementById('tab-panel-ads');
        const pageTitleEl = document.getElementById('page-title');
        const navLinks = document.querySelectorAll('[data-nav]');

        // Ads tab: lazy-load /ads.js only when Ads is opened.
        let adsLoading = null;
        let adsLoaded = false;
        function ensureAdsLoaded() {
          if (adsLoaded) return Promise.resolve(true);
          if (adsLoading) return adsLoading;
          adsLoading = new Promise(function(resolve) {
            const existing = document.querySelector('script[data-ads-js="1"]');
            if (existing) {
              // If the script tag exists but hasn't executed yet (defer + slow network),
              // wait for it so Ads can initialize immediately instead of staying blank.
              try {
                if (window.__adsInit || window.__adsRefresh) {
                  adsLoaded = true;
                  resolve(true);
                  return;
                }
              } catch (_) {}

              const onLoad = function() {
                adsLoaded = true;
                resolve(true);
              };
              const onError = function() {
                resolve(false);
              };
              try {
                existing.addEventListener('load', onLoad, { once: true });
                existing.addEventListener('error', onError, { once: true });
              } catch (_) {}

              // Edge: if it already loaded before listeners attached, resolve on next tick.
              setTimeout(function() {
                try {
                  if (window.__adsInit || window.__adsRefresh) {
                    adsLoaded = true;
                    resolve(true);
                  }
                } catch (_) {}
              }, 0);
              return;
            }
            const s = document.createElement('script');
            s.src = '/ads.js';
            s.async = true;
            s.defer = true;
            s.setAttribute('data-ads-js', '1');
            s.onload = function() {
              adsLoaded = true;
              resolve(true);
            };
            s.onerror = function() {
              resolve(false);
            };
            document.head.appendChild(s);
          }).finally(function() {
            adsLoading = null;
          });
          return adsLoading;
        }

        function tabFromHash() {
          var h = location.hash ? location.hash.replace(/^#/, '').toLowerCase() : '';
          return HASH_TO_TAB[h] || null;
        }

        var hashUpdateInProgress = false;
        function setHash(tab) {
          if (PAGE) return;
          var h = TAB_TO_HASH[tab] || 'dashboard';
          if (location.hash === '#' + h) return;
          hashUpdateInProgress = true;
          try { history.replaceState(null, '', '#' + h); } catch (_) {}
          hashUpdateInProgress = false;
        }

        var TAB_TO_NAV = { spy: 'live', snapshot: 'snapshot', stats: 'countries' };
        var NAV_TO_ICON_KEY = {
          overview: 'nav-item-overview',
          dashboard: 'nav-item-overview',
          live: 'nav-item-live',
          sales: 'nav-item-sales',
          date: 'nav-item-table',
          snapshot: 'nav-item-overview',
          countries: 'nav-item-countries',
          products: 'nav-item-products',
          variants: 'nav-item-variants',
          'abandoned-carts': 'nav-item-sales',
          channels: 'nav-item-channels',
          type: 'nav-item-type',
          attribution: 'nav-item-attribution',
          devices: 'nav-item-type',
          ads: 'nav-item-ads',
          tools: 'nav-item-tools',
          'click-order-lookup': 'nav-item-tools',
          'compare-conversion-rate': 'nav-item-tools',
          'shipping-cr': 'nav-item-tools',
          'change-pins': 'nav-item-tools'
        };
        function syncPageHeaderCategoryIcon() {
          // Inject the active top-menu category icon into the page header (next to pretitle/title),
          // using the same icon + accent as the active dropdown toggle.
          try {
            var pretitle = document.querySelector('.page-header .page-pretitle');
            if (!pretitle) return;
            // Remove previous injected icon(s) (legacy placed as sibling; current placed inside pretitle).
            try {
              pretitle.querySelectorAll('.kexo-page-header-category-icon').forEach(function(el) { try { el.remove(); } catch (_) {} });
            } catch (_) {}
            try {
              var parent = pretitle.parentElement;
              if (parent) {
                parent.querySelectorAll(':scope > .kexo-page-header-category-icon').forEach(function(el) { try { el.remove(); } catch (_) {} });
              }
            } catch (_) {}

            var navList = document.querySelector('.kexo-desktop-nav-list');
            if (!navList) return;

            // Top-level active category (Dashboard/Insights/Traffic/Integrations/Tools)
            var activeCat = navList.querySelector(':scope > .nav-item.dropdown.active');
            if (!activeCat) return;

            var toggle = activeCat.querySelector(':scope > .nav-link.dropdown-toggle');
            if (!toggle) return;

            var iconSrc = toggle.querySelector('.kexo-nav-svg');
            if (!iconSrc) return;

            var icon = iconSrc.cloneNode(true);
            // Avoid nav spacing helpers (they use !important and fight our header layout).
            try { icon.classList.remove('me-1', 'me-2'); } catch (_) {}
            icon.classList.add('kexo-page-header-category-icon');
            icon.setAttribute('aria-hidden', 'true');

            // Apply the same accent index as the active top-level nav item.
            var idx = 0;
            try {
              var kids = Array.prototype.slice.call(navList.children || []);
              idx = kids.indexOf(activeCat) + 1;
            } catch (_) { idx = 0; }
            if (idx >= 1 && idx <= 5) {
              icon.classList.add('kexo-accent-' + String(idx));
            }

            // Ensure the header icon matches the EXACT computed color from the menu icon,
            // even if accents are altered by theme/scripts (no drift).
            var computedColor = '';
            try {
              computedColor = (window.getComputedStyle && iconSrc) ? window.getComputedStyle(iconSrc).color : '';
              computedColor = String(computedColor || '').trim();
              if (computedColor) icon.style.color = computedColor;
            } catch (_) {}

            pretitle.insertBefore(icon, pretitle.firstChild || null);

            // Inject the current page icon into the page title (desktop only via CSS).
            // Use data-icon-key so fontawesome-icons.js applies theme (same as menu icons).
            try {
              var dropdownMenu = activeCat.querySelector('.dropdown-menu');
              var activeLink = dropdownMenu ? dropdownMenu.querySelector('a.dropdown-item[aria-current="page"]') : null;
              var navKey = activeLink ? (activeLink.getAttribute('data-nav') || '').trim().toLowerCase() : '';
              var iconKey = navKey ? (NAV_TO_ICON_KEY[navKey] || null) : null;
              var title = document.querySelector('.page-header .kexo-page-header-title-col .page-title');
              if (title && iconKey) {
                title.querySelectorAll('.kexo-page-header-title-icon').forEach(function(el) { try { el.remove(); } catch (_) {} });
                title.querySelectorAll('.kexo-page-title-mobile-sep').forEach(function(el) { try { el.remove(); } catch (_) {} });
                var pageIcon = document.createElement('i');
                pageIcon.className = 'fa-jelly fa-circle kexo-page-header-title-icon';
                pageIcon.setAttribute('aria-hidden', 'true');
                pageIcon.setAttribute('data-icon-key', iconKey);
                if (idx >= 1 && idx <= 5) pageIcon.classList.add('kexo-accent-' + String(idx));
                if (computedColor) pageIcon.style.color = computedColor;
                title.insertBefore(pageIcon, title.firstChild || null);

                // Mobile-only: Attribution title gets a subtle separator arrow.
                try {
                  var isAttribution = (document && document.body && document.body.getAttribute)
                    ? (String(document.body.getAttribute('data-page') || '').trim().toLowerCase() === 'attribution')
                    : false;
                  if (isAttribution) {
                    var sep = document.createElement('i');
                    sep.className = 'fa-solid fa-arrow-turn-down-right kexo-page-title-mobile-sep';
                    sep.setAttribute('aria-hidden', 'true');
                    sep.setAttribute('data-icon-key', 'page-title-separator');
                    title.insertBefore(sep, pageIcon.nextSibling || null);
                  }
                } catch (_) {}
                try {
                  if (typeof window.KexoIconTheme === 'object' && typeof window.KexoIconTheme.applyElement === 'function') {
                    window.KexoIconTheme.applyElement(pageIcon);
                  }
                } catch (_) {}
                try {
                  if (typeof window.KexoIconTheme === 'object' && typeof window.KexoIconTheme.applyElement === 'function') {
                    var justSep = title.querySelector('.kexo-page-title-mobile-sep');
                    if (justSep) window.KexoIconTheme.applyElement(justSep);
                  }
                } catch (_) {}
              }
            } catch (_) {}

            // Expose accent for connector lines (very light tint of same shade).
            try {
              var row = pretitle.closest('.row.align-items-center');
              if (row && computedColor) row.style.setProperty('--kexo-page-header-accent', computedColor);
            } catch (_) {}
          } catch (_) {}
        }
        function updateNavSelection(tab) {
          var navKey = TAB_TO_NAV[tab] || tab;
          navLinks.forEach(function(link) {
            var isActive = link.getAttribute('data-nav') === navKey;
            link.setAttribute('aria-current', isActive ? 'page' : 'false');
            var parentItem = link.closest('.nav-item');
            if (parentItem) {
              if (isActive) parentItem.classList.add('active');
              else {
                var menu = parentItem.querySelector('.dropdown-menu');
                var hasCurrent = menu && menu.querySelector('.dropdown-item[aria-current="page"]');
                if (!hasCurrent) parentItem.classList.remove('active');
              }
            }
            link.classList.remove('active');
          });
          if (tabDashboard) tabDashboard.setAttribute('aria-selected', tab === 'dashboard' ? 'true' : 'false');
          if (tabSpy) tabSpy.setAttribute('aria-selected', tab === 'spy' ? 'true' : 'false');
          if (tabSnapshot) tabSnapshot.setAttribute('aria-selected', tab === 'snapshot' ? 'true' : 'false');
          if (tabStats) tabStats.setAttribute('aria-selected', tab === 'stats' ? 'true' : 'false');
          if (tabProducts) tabProducts.setAttribute('aria-selected', tab === 'products' ? 'true' : 'false');
          if (tabVariants) tabVariants.setAttribute('aria-selected', tab === 'variants' ? 'true' : 'false');
          if (tabAds) tabAds.setAttribute('aria-selected', tab === 'ads' ? 'true' : 'false');
          if (tabSales) tabSales.setAttribute('aria-selected', tab === 'sales' ? 'true' : 'false');
          if (tabDate) tabDate.setAttribute('aria-selected', tab === 'date' ? 'true' : 'false');
          if (tabTools) tabTools.setAttribute('aria-selected', tab === 'tools' ? 'true' : 'false');
          // Dashboard dropdown ??? highlight parent li.nav-item when a child page is active
          var isDashboardChild = (tab === 'dashboard' || tab === 'spy' || tab === 'sales' || tab === 'date');
          var dashboardToggle = document.querySelector('.nav-item.dropdown .dropdown-toggle[href="#navbar-dashboard-menu"]');
          var dashboardDropdownItem = dashboardToggle ? dashboardToggle.closest('.nav-item') : null;
          if (dashboardToggle) {
            dashboardToggle.setAttribute('aria-current', isDashboardChild ? 'page' : 'false');
          }
          if (dashboardDropdownItem) {
            if (isDashboardChild) dashboardDropdownItem.classList.add('active');
            else dashboardDropdownItem.classList.remove('active');
          }
          // Insights dropdown (Snapshot + Countries + Products + Variants)
          var isInsightsChild = (tab === 'snapshot' || tab === 'stats' || tab === 'products' || tab === 'variants' || tab === 'abandoned-carts');
          var insightsToggle = document.querySelector('.nav-item.dropdown .dropdown-toggle[href="#navbar-insights-menu"]');
          var insightsDropdownItem = insightsToggle ? insightsToggle.closest('.nav-item') : null;
          if (insightsToggle) {
            insightsToggle.setAttribute('aria-current', isInsightsChild ? 'page' : 'false');
          }
          if (insightsDropdownItem) {
            if (isInsightsChild) insightsDropdownItem.classList.add('active');
            else insightsDropdownItem.classList.remove('active');
          }
          // Acquisition dropdown
          var isAcquisitionChild = (tab === 'attribution' || tab === 'devices');
          var acquisitionToggle = document.querySelector('.nav-item.dropdown .dropdown-toggle[href="#navbar-acquisition-menu"]');
          var acquisitionDropdownItem = acquisitionToggle ? acquisitionToggle.closest('.nav-item') : null;
          if (acquisitionToggle) {
            acquisitionToggle.setAttribute('aria-current', isAcquisitionChild ? 'page' : 'false');
          }
          if (acquisitionDropdownItem) {
            if (isAcquisitionChild) acquisitionDropdownItem.classList.add('active');
            else acquisitionDropdownItem.classList.remove('active');
          }

          // Integrations dropdown
          var isIntegrationsChild = (tab === 'ads');
          var integrationsToggle = document.querySelector('.nav-item.dropdown .dropdown-toggle[href="#navbar-integrations-menu"]');
          var integrationsDropdownItem = integrationsToggle ? integrationsToggle.closest('.nav-item') : null;
          if (integrationsToggle) {
            integrationsToggle.setAttribute('aria-current', isIntegrationsChild ? 'page' : 'false');
          }
          if (integrationsDropdownItem) {
            if (isIntegrationsChild) integrationsDropdownItem.classList.add('active');
            else integrationsDropdownItem.classList.remove('active');
          }

          // Tools dropdown (include tool sub-pages so Tools is highlighted on /tools/* pages)
          var isToolsChild = (tab === 'tools' || tab === 'compare-conversion-rate' || tab === 'shipping-cr' || tab === 'click-order-lookup' || tab === 'change-pins');
          var toolsToggle = document.querySelector('.nav-item.dropdown .dropdown-toggle[href="#navbar-tools-menu"]');
          var toolsDropdownItem = toolsToggle ? toolsToggle.closest('.nav-item') : null;
          if (toolsToggle) {
            toolsToggle.setAttribute('aria-current', isToolsChild ? 'page' : 'false');
          }
          if (toolsDropdownItem) {
            if (isToolsChild) toolsDropdownItem.classList.add('active');
            else toolsDropdownItem.classList.remove('active');
          }

          // Keep the page header icon in sync with the active top-level dropdown.
          syncPageHeaderCategoryIcon();
        }

        function runTabWork(tab) {
          // Keep condensed KPI strip fitted to available width.
          try { scheduleCondensedKpiOverflowUpdate(); } catch (_) {}
          // Keep the global date selector visible on ALL pages (including Tools) for consistent header UX.
          var showDateSel = true;
          var globalDateSel = document.getElementById('global-date-select');
          if (globalDateSel) globalDateSel.style.display = showDateSel ? '' : 'none';

          syncDateSelectOptions();
          updateNextUpdateUi();

          function ensureKpis() {
            var rangeKey = '';
            try { rangeKey = getStatsRange(); } catch (_) { rangeKey = ''; }
            var cacheMatchesRange = !!(rangeKey && kpiCache && kpiCacheRange === rangeKey);
            var trusted = cacheMatchesRange && kpiCacheSource === 'kpis';
            var staleKpis = !trusted || !lastKpisFetchedAt || (Date.now() - lastKpisFetchedAt) > KPI_REFRESH_MS;
            if (staleKpis) {
              refreshKpis({ force: false });
            } else {
              renderLiveKpis(getKpiData());
              try { refreshKpiExtrasSoft(); } catch (_) {}
              try { fetchCondensedSeries(); } catch (_) {}
            }
          }

          if (tab === 'tools') {
            ensureKpis();
            return;
          }
          if (tab === 'snapshot') {
            ensureKpis();
            return;
          }
          if (tab === 'dashboard') {
            try { if (typeof window.refreshDashboard === 'function') window.refreshDashboard({ force: false }); } catch (_) {}
            refreshKpis({ force: false }).then(function(data) {
              if (data) renderDashboardKpisFromApi(data);
            });
          } else if (tab === 'stats') {
            refreshStats({ force: false });
            ensureKpis();
          } else if (tab === 'products') {
            refreshProducts({ force: false });
            ensureKpis();
          } else if (tab === 'variants') {
            try { if (typeof window.__refreshVariantsInsights === 'function') window.__refreshVariantsInsights({ force: false }); } catch (_) {}
            ensureKpis();
          } else if (tab === 'abandoned-carts') {
            try { refreshAbandonedCarts({ force: false }); } catch (_) { fetchSessions(); }
            ensureKpis();
          } else if (tab === 'attribution') {
            refreshAttribution({ force: false });
            ensureKpis();
          } else if (tab === 'devices') {
            refreshDevices({ force: false });
            ensureKpis();
          } else if (tab === 'browsers') {
            refreshBrowsers({ force: false });
            ensureKpis();
          } else if (tab === 'ads') {
            ensureKpis();
            ensureAdsLoaded().then(function(ok) {
              if (!ok) return;
              // IMPORTANT: if `/ads.js` is already present as a deferred script tag (e.g. on `/integrations/google-ads` page),
              // the promise can resolve before the script executes (microtask checkpoint after this script),
              // leaving Ads blank until another event triggers a refresh. Defer one macrotask so Ads JS has run.
              setTimeout(function() {
                try {
                  if (window.__adsInit) window.__adsInit();
                  else if (window.__adsRefresh) window.__adsRefresh({ force: false });
                } catch (_) {}
              }, 0);
            });
          } else {
            var sessionStaleMs = dateRange === 'live' ? LIVE_REFRESH_MS : (dateRange === 'today' || dateRange === 'sales' || dateRange === '1h' ? RANGE_REFRESH_MS : LIVE_REFRESH_MS);
            var staleSessions = !lastSessionsFetchedAt || (Date.now() - lastSessionsFetchedAt) > sessionStaleMs;
            if (staleSessions) fetchSessions();
            ensureKpis();
          }
        }

        function setTab(tab) {
          var isDashboard = tab === 'dashboard';
          var isSpy = tab === 'spy';
          var isStats = tab === 'stats';
          var isProducts = tab === 'products';
          var isAds = tab === 'ads';
          activeMainTab = tab;
          setHash(tab);

          if (pageTitleEl && !PAGE) {
            pageTitleEl.textContent = TAB_LABELS[tab] || 'Overview';
          }

          updateNavSelection(tab);
          if (panelDashboard) panelDashboard.classList.toggle('active', isDashboard);
          var isSales = tab === 'sales';
          var isDate = tab === 'date';
          var isSnapshot = tab === 'snapshot';
          if (panelSpy) panelSpy.classList.toggle('active', isSpy || isSales || isDate);
          if (panelSnapshot) panelSnapshot.classList.toggle('active', isSnapshot);
          if (panelStats) panelStats.classList.toggle('active', isStats);
          if (panelProducts) panelProducts.classList.toggle('active', isProducts);
          if (panelAds) panelAds.classList.toggle('active', isAds);

          try { sessionStorage.setItem(TAB_KEY, tab); } catch (_) {}
          runTabWork(tab);
          // Ensure navbar live visitors status updates immediately on navigation.
          try { updateKpis(); } catch (_) {}
        }

        try { window.setTab = setTab; } catch (_) {}

        if (PAGE) {
          var pageTab = PAGE === 'live' ? 'spy'
            : PAGE === 'snapshot' ? 'snapshot'
            : PAGE === 'countries' ? 'stats'
            : PAGE === 'sales' ? 'sales'
            : PAGE === 'date' ? 'date'
            : PAGE === 'channels' ? 'attribution'
            : PAGE === 'type' ? 'devices'
            : PAGE === 'attribution' ? 'attribution'
            : PAGE === 'devices' ? 'devices'
            : PAGE === 'browsers' ? 'browsers'
            : (PAGE === 'compare-conversion-rate' || PAGE === 'shipping-cr' || PAGE === 'click-order-lookup' || PAGE === 'change-pins') ? PAGE
            : PAGE;
          setTab(pageTab);
          return;
        }

        // Hash-based routing: hash overrides sessionStorage
        var initialTab = 'dashboard';
        var hashTab = tabFromHash();
        if (hashTab && VALID_TABS.indexOf(hashTab) !== -1) {
          initialTab = hashTab;
        } else {
          try {
            var saved = sessionStorage.getItem(TAB_KEY);
            if (saved && VALID_TABS.indexOf(saved) !== -1) initialTab = saved;
          } catch (_) {}
        }
        setTab(initialTab);

        window.addEventListener('hashchange', function() {
          if (hashUpdateInProgress) return;
          var t = tabFromHash();
          if (t && VALID_TABS.indexOf(t) !== -1 && t !== activeMainTab) setTab(t);
        });

        if (tabDashboard) tabDashboard.addEventListener('click', function() { setTab('dashboard'); });
        if (tabSpy) tabSpy.addEventListener('click', function() { setTab('spy'); });
        if (tabStats) tabStats.addEventListener('click', function() { setTab('stats'); });
        if (tabProducts) tabProducts.addEventListener('click', function() { setTab('products'); });
        if (tabAds) tabAds.addEventListener('click', function() { setTab('ads'); });
        if (tabTools) tabTools.addEventListener('click', function() { setTab('tools'); });
      })();
      (function initTopNavMobileBehavior() {
        const navLeft = document.querySelector('.kexo-desktop-nav-left');
        if (!navLeft) return;

        function isMobileViewport() {
          try {
            if (typeof window.matchMedia === 'function') return window.matchMedia('(max-width: 991.98px)').matches;
          } catch (_) {}
          return (window.innerWidth || 0) < 992;
        }

        function syncDropdownOverflowState() {
          if (!isMobileViewport()) {
            navLeft.classList.remove('is-dropdown-open');
            return;
          }
          const hasOpenMenu = !!navLeft.querySelector('.dropdown-menu.show');
          navLeft.classList.toggle('is-dropdown-open', hasOpenMenu);
        }

        function resetNavStartPosition() {
          if (!isMobileViewport()) return;
          try { navLeft.scrollLeft = 0; } catch (_) {}
        }

        function updateMobileNavDropdownTop() {
          if (!isMobileViewport()) return;
          const nav = document.querySelector('.kexo-desktop-nav');
          if (!nav) return;
          const rect = nav.getBoundingClientRect();
          document.documentElement.style.setProperty('--kexo-mobile-nav-dropdown-top', (rect.bottom - 4) + 'px');
        }

        function closeOpenNavDropdowns() {
          if (!isMobileViewport()) return;
          navLeft.querySelectorAll('.dropdown-menu.show').forEach(function (menu) {
            const toggle = menu.closest('.dropdown') && menu.closest('.dropdown').querySelector('[data-bs-toggle="dropdown"]');
            if (toggle && typeof bootstrap !== 'undefined' && bootstrap.Dropdown) {
              try {
                const instance = bootstrap.Dropdown.getOrCreateInstance(toggle);
                if (instance) instance.hide();
              } catch (_) {}
            }
          });
        }

        navLeft.querySelectorAll('.dropdown').forEach(function (dropdownEl) {
          dropdownEl.addEventListener('shown.bs.dropdown', function () {
            if (!isMobileViewport()) return;
            updateMobileNavDropdownTop();
          });
        });

        navLeft.addEventListener('show.bs.dropdown', function() {
          if (!isMobileViewport()) return;
          navLeft.classList.add('is-dropdown-open');
        });

        navLeft.addEventListener('hide.bs.dropdown', function() {
          if (!isMobileViewport()) return;
          setTimeout(syncDropdownOverflowState, 0);
        });

        window.addEventListener('resize', function() {
          syncDropdownOverflowState();
          updateMobileNavDropdownTop();
        }, { passive: true });
        window.addEventListener('scroll', function() {
          closeOpenNavDropdowns();
        }, { passive: false });
        window.addEventListener('orientationchange', function() {
          resetNavStartPosition();
          syncDropdownOverflowState();
          updateMobileNavDropdownTop();
        });
        window.addEventListener('pageshow', function() {
          resetNavStartPosition();
          syncDropdownOverflowState();
        });

        resetNavStartPosition();
        syncDropdownOverflowState();
        updateMobileNavDropdownTop();
      })();
      (function initNavDropdownAccent() {
        var navList = document.querySelector('.kexo-desktop-nav-list');
        if (!navList) return;
        var styleEl = document.getElementById('kexo-nav-dropdown-accent');
        if (!styleEl) {
          styleEl = document.createElement('style');
          styleEl.id = 'kexo-nav-dropdown-accent';
          styleEl.textContent = [
            '.kexo-desktop-nav-list .nav-item.dropdown.kexo-dropdown-open .nav-link {',
            '  --tblr-dropdown-bg: var(--kexo-accent, var(--tblr-primary, #3eb3ab)) !important;',
            '  background: var(--kexo-accent, var(--tblr-primary, #3eb3ab)) !important;',
            '  background-color: var(--kexo-accent, var(--tblr-primary, #3eb3ab)) !important;',
            '  color: #fff !important;',
            '  border-radius: 4px 4px 0 0;',
            '}',
            '.kexo-desktop-nav-list .nav-item.dropdown.kexo-dropdown-open .dropdown-menu {',
            '  --tblr-dropdown-bg: var(--kexo-accent, var(--tblr-primary, #3eb3ab)) !important;',
            '  background: var(--kexo-accent, var(--tblr-primary, #3eb3ab)) !important;',
            '  background-color: var(--kexo-accent, var(--tblr-primary, #3eb3ab)) !important;',
            '  color: #fff !important;',
            '  border-radius: 0 0 4px 4px;',
            '}',
            '.kexo-desktop-nav-list .nav-item.dropdown.kexo-dropdown-open .nav-link > .kexo-nav-svg,',
            '.kexo-desktop-nav-list .nav-item.dropdown.kexo-dropdown-open .nav-link > i[class*="fa-"] {',
            '  opacity: 1 !important;',
            '  color: #fff !important;',
            '}',
            '/* Override active accent icon when dropdown open (focused) ??? icon back to white */',
            '.kexo-desktop-nav-list .nav-item.dropdown.kexo-dropdown-open.active .nav-link > .kexo-nav-svg,',
            '.kexo-desktop-nav-list .nav-item.dropdown.kexo-dropdown-open.active .nav-link > i[class*="fa-"] {',
            '  color: #fff !important;',
            '}',
            '.kexo-desktop-nav-list .nav-item.dropdown.kexo-dropdown-open .dropdown-item,',
            '.kexo-desktop-nav-list .nav-item.dropdown.kexo-dropdown-open .dropdown-item .kexo-nav-svg,',
            '.kexo-desktop-nav-list .nav-item.dropdown.kexo-dropdown-open .dropdown-item .kexo-nav-dropdown-item-icon {',
            '  color: #fff !important;',
            '}'
          ].join('\n');
          document.head.appendChild(styleEl);
        }
        navList.addEventListener('show.bs.dropdown', function(e) {
          var navItem = (e.target && e.target.closest) ? e.target.closest('.nav-item.dropdown') : null;
          if (navItem) navItem.classList.add('kexo-dropdown-open');
        });
        navList.addEventListener('hide.bs.dropdown', function(e) {
          var navItem = (e.target && e.target.closest) ? e.target.closest('.nav-item.dropdown') : null;
          if (navItem) navItem.classList.remove('kexo-dropdown-open');
        });
      })();
      (function initStripDropdownAlign() {
        function positionStripDropdown(menu) {
          if (!menu || !menu.classList.contains('kexo-strip-dropdown-align')) return;
          const nav = document.querySelector('.kexo-desktop-nav-container');
          const strip = document.querySelector('.kexo-desktop-top-strip');
          if (!nav || !strip) return;
          const navRect = nav.getBoundingClientRect();
          const stripRect = strip.getBoundingClientRect();
          menu.style.setProperty('position', 'fixed');
          menu.style.setProperty('left', navRect.left + 'px');
          menu.style.setProperty('top', (stripRect.bottom + 5) + 'px');
          menu.style.setProperty('right', 'auto');
        }
        function onStripDropdownShown(e) {
          const menu = e.target.querySelector('.dropdown-menu.kexo-strip-dropdown-align');
          if (!menu) return;
          positionStripDropdown(menu);
          requestAnimationFrame(function() { positionStripDropdown(menu); });
        }
        document.querySelectorAll('.kexo-desktop-top-strip .dropdown').forEach(function(dd) {
          dd.addEventListener('shown.bs.dropdown', onStripDropdownShown);
        });
        window.addEventListener('resize', function() {
          document.querySelectorAll('.dropdown-menu.kexo-strip-dropdown-align.show').forEach(positionStripDropdown);
        }, { passive: true });
      })();
      (function initRefreshBtn() {
        const btn = document.getElementById('refresh-btn');
        if (btn) {
          btn.addEventListener('click', function() {
            if (updateAvailable) {
              try { window.location.reload(); } catch (_) { try { window.location.href = window.location.href; } catch (_) {} }
              return;
            }
            btn.classList.add('refresh-spinning');
            setTimeout(function() { btn.classList.remove('refresh-spinning'); }, 600);
            // Silent refresh: never cover the page with the overlay loader while refreshing.
            // (Use the subtle date-range spinner + the refresh button spin only.)
            kexoWithSilentOverlay(function() {
              if (activeMainTab === 'dashboard') {
                try { if (typeof window.refreshDashboard === 'function') window.refreshDashboard({ force: true, silent: true }); } catch (_) {}
              } else if (activeMainTab === 'stats') {
                try { refreshStats({ force: true }); } catch (_) {}
              } else if (activeMainTab === 'products') {
                try { refreshProducts({ force: true }); } catch (_) {}
              } else if (activeMainTab === 'variants') {
                try { if (typeof window.__refreshVariantsInsights === 'function') window.__refreshVariantsInsights({ force: true }); } catch (_) {}
              } else if (activeMainTab === 'abandoned-carts') {
                try { refreshAbandonedCarts({ force: true }); } catch (_) { try { fetchSessions(); } catch (_) {} }
              } else if (activeMainTab === 'attribution') {
                try { refreshAttribution({ force: true }); } catch (_) {}
              } else if (activeMainTab === 'devices') {
                try { refreshDevices({ force: true }); } catch (_) {}
              } else if (activeMainTab === 'ads') {
                try { if (window.__adsRefresh) window.__adsRefresh({ force: true }); } catch (_) {}
              } else {
                try { fetchSessions(); } catch (_) {}
              }
              try { refreshKpis({ force: true }); } catch (_) {}
            });
          });
        }
      })();
      updateServerTimeDisplay();
      updateNextUpdateUi();
      _intervals.push(setInterval(function() {
        if (document.visibilityState !== 'visible') return;
        updateServerTimeDisplay();
        updateNextUpdateUi();
      }, 1000));
    })();

    (function setupStatsCardScrollHideHeader() {
      function onScroll(wrapId, cardId) {
        const wrap = document.getElementById(wrapId);
        const card = document.getElementById(cardId);
        if (!wrap || !card) return;
        function update() {
          card.classList.toggle('scrolled', wrap.scrollTop > 0);
        }
        wrap.addEventListener('scroll', update);
        update();
      }
      onScroll('country-table-wrap', 'stats-country');
      onScroll('best-sellers-wrap', 'stats-best-sellers');
      onScroll('best-variants-wrap', 'stats-best-variants');
    })();

    function liveSalesAutoPollEnabled() {
      return PAGE === 'live' || PAGE === 'sales';
    }

    function liveSalesCanAutoApply() {
      if (!liveSalesAutoPollEnabled()) return false;
      if (document.visibilityState !== 'visible') return false;
      // Pause while interacting (sorting/paging). New data will be queued and applied on demand.
      try { if (typeof currentPage === 'number' && currentPage !== 1) return false; } catch (_) {}
      try {
        const sb = sortBy != null ? String(sortBy) : '';
        const sd = sortDir != null ? String(sortDir) : '';
        const isDefaultSort = (sb === 'last_seen' && sd === 'desc');
        if (sb && !isDefaultSort) return false;
      } catch (_) {}
      return true;
    }

    function liveSalesPollUrl() {
      if (PAGE === 'live') {
        return API + '/api/sessions?filter=active&_=' + Date.now();
      }
      // Sales page: always poll the "top page" so new rows are detected even if user is paging.
      var limit = rowsPerPage;
      var offset = 0;
      return API + '/api/sessions?range=' + encodeURIComponent(normalizeRangeKeyForApi('sales')) + '&limit=' + limit + '&offset=' + offset + '&timezone=' + encodeURIComponent(tz) + '&_=' + Date.now();
    }

    function setLiveSalesNextAt(ts) {
      var n = typeof ts === 'number' && isFinite(ts) ? ts : (Date.now() + LIVE_SALES_POLL_MS);
      if (PAGE === 'live') nextLiveAt = n;
      else nextRangeAt = n;
      updateNextUpdateUi();
    }

    function scheduleLiveSalesPoll(ms) {
      if (!liveSalesAutoPollEnabled()) return;
      if (liveSalesPollTimer) { try { clearTimeout(liveSalesPollTimer); } catch (_) {} liveSalesPollTimer = null; }
      var delay = (typeof ms === 'number' && isFinite(ms) && ms >= 0) ? ms : LIVE_SALES_POLL_MS;
      setLiveSalesNextAt(Date.now() + delay);
      liveSalesPollTimer = setTimeout(function() { try { runLiveSalesPoll(); } catch (_) {} }, delay);
    }

    function applyLiveSalesPayload(data) {
      if (!data) return;
      if (PAGE === 'live') {
        sessionsTotal = null;
        var next = data.sessions || [];
        var cutoff = Date.now() - ACTIVE_WINDOW_MS;
        var arrivedCutoff = Date.now() - ARRIVED_WINDOW_MS;
        next = next.filter(function(s) {
          return (s.last_seen != null && s.last_seen >= cutoff) &&
            (s.started_at != null && s.started_at >= arrivedCutoff);
        });
        next.sort(function(a, b) { return (b.last_seen || 0) - (a.last_seen || 0); });
        sessions = next;
        lastSessionsMode = 'live';
        lastSessionsFetchedAt = Date.now();
        lastUpdateTime = new Date();
        updateServerTimeDisplay();
        renderTable();
        updateKpis();
        try { refreshSessionPageCharts({ force: false }); } catch (_) {}
        return;
      }

      // Sales (range mode)
      sessions = data.sessions || [];
      sessionsTotal = typeof data.total === 'number' ? data.total : sessions.length;
      lastSessionsMode = 'range';
      lastSessionsFetchedAt = Date.now();
      lastUpdateTime = new Date();
      updateServerTimeDisplay();
      renderTable();
      updateKpis();
      try { refreshSessionPageCharts({ force: false }); } catch (_) {}
    }

    function applyLiveSalesPending() {
      if (!liveSalesPendingPayload) return false;
      const payload = liveSalesPendingPayload;
      liveSalesPendingPayload = null;
      liveSalesPendingAt = 0;
      // Newest rows are at the top; jump to page 1 so the update is visible.
      try { currentPage = 1; } catch (_) {}
      try { applyLiveSalesPayload(payload); } catch (_) {}
      try { updateNextUpdateUi(); } catch (_) {}
      return true;
    }

    function runLiveSalesPoll() {
      if (!liveSalesAutoPollEnabled()) return;
      // Always reschedule first so we don't stop polling if something throws.
      scheduleLiveSalesPoll(LIVE_SALES_POLL_MS);
      if (document.visibilityState !== 'visible') return;
      if (liveSalesPollInFlight) return;
      var url = liveSalesPollUrl();
      liveSalesPollInFlight = fetch(url, { credentials: 'same-origin', cache: 'no-store' })
        .then(function(r) { return (r && r.ok) ? r.json() : null; })
        .then(function(data) {
          if (!data) return;
          if (liveSalesPendingPayload || !liveSalesCanAutoApply()) {
            liveSalesPendingPayload = data;
            liveSalesPendingAt = Date.now();
            try { updateNextUpdateUi(); } catch (_) {}
            return;
          }
          liveSalesPendingPayload = null;
          liveSalesPendingAt = 0;
          applyLiveSalesPayload(data);
        })
        .catch(function() {})
        .finally(function() { liveSalesPollInFlight = null; });
    }

    (function initLiveSalesPoller() {
      if (!liveSalesAutoPollEnabled()) return;
      // Defer the first poll slightly so initial page load fetch/render completes first.
      scheduleLiveSalesPoll(LIVE_SALES_POLL_MS);
    })();

    function onLiveAutoRefreshTick() {
      if (activeMainTab !== 'spy') return;
      if (dateRange !== 'live') return;
      if (document.visibilityState !== 'visible') return;
      fetchSessions();
    }

    function onRangeAutoRefreshTick() {
      if (activeMainTab !== 'spy') return;
      if (dateRange !== 'today' && dateRange !== 'sales' && dateRange !== '1h') return;
      if (document.visibilityState !== 'visible') return;
      if (Date.now() < nextRangeAt) return;
      fetchSessions();
    }

    function onStatsAutoRefreshTick() {
      if (activeMainTab !== 'stats') return;
      if (getStatsRange() !== 'today') return;
      if (document.visibilityState !== 'visible') return;
      refreshStats({ force: false });
    }

    function onKpisAutoRefreshTick() {
      if (document.visibilityState !== 'visible') return;
      if (activeMainTab === 'dashboard' || activeMainTab === 'tools') return;
      refreshKpis({ force: false });
    }

    function onProductsAutoRefreshTick() {
      if (activeMainTab !== 'products') return;
      if (getStatsRange() !== 'today') return;
      if (document.visibilityState !== 'visible') return;
      refreshProducts({ force: false });
    }

    var _tickTimeIntervalId = null;
    function ensureTickTimeInterval() {
      if (_tickTimeIntervalId) return _tickTimeIntervalId;
      _tickTimeIntervalId = setInterval(function() {
        if (document.visibilityState !== 'visible') return;
        try { tickTimeOnSite(); } catch (_) {}
      }, 30000);
      _intervals.push(_tickTimeIntervalId);
      return _tickTimeIntervalId;
    }

    // Background polling is intentionally disabled across the site (manual refresh only),
    // except for /dashboard/live and /dashboard/sales (which use a dedicated 10s poller).
    ensureTickTimeInterval();

    // ?????? Tab resume + deploy drift guard ???????????????????????????????????????????????????????????????????????????????????????????????????????????????
    // In Safari/iOS (and some embed contexts) long-idle tabs can resume with a "white page"
    // or broken JS/CSS if a deploy happened while the tab was backgrounded. We expose an
    // assetVersion signal via /api/version; if it changes while hidden, hard-reload on resume.
    var _bootVersionSig = null;
    var _lastHiddenAt = 0;
    var _versionCheckInFlight = null;
    var RESUME_RELOAD_IDLE_MS = 10 * 60 * 1000;

    function fetchVersionSig() {
      if (_versionCheckInFlight) return _versionCheckInFlight;
      _versionCheckInFlight = fetch(API + '/api/version', { credentials: 'same-origin', cache: 'no-store' })
        .then(function(r) { return r && r.ok ? r.json() : null; })
        .then(function(data) {
          _versionCheckInFlight = null;
          if (!data) return null;
          var av = data.assetVersion != null ? String(data.assetVersion) : '';
          var pv = data.version != null ? String(data.version) : '';
          var sig = (av || pv) ? (av + '|' + pv) : '';
          return sig && sig.trim() ? sig : null;
        })
        .catch(function() { _versionCheckInFlight = null; return null; });
      return _versionCheckInFlight;
    }

    try {
      fetchVersionSig().then(function(sig) { if (sig) _bootVersionSig = sig; });
    } catch (_) {}

    function onBecameVisible() {
      updateServerTimeDisplay();
      updateNextUpdateUi();
    }

    // On mobile, post-login redirect can restore the dashboard from bfcache; DOMContentLoaded
    // does not fire again, so data fetches never run. Refresh when page is shown from bfcache.
    // Also restart SSE and pollers (runCleanup on pagehide closes them).
    function reinitLiveStreamsAndPollers() {
      try { initEventSource(); } catch (_) {}
      ensureTickTimeInterval();
      try { if (typeof scheduleLiveSalesPoll === 'function') scheduleLiveSalesPoll(LIVE_SALES_POLL_MS); } catch (_) {}
      try { if (typeof window.__kexoInitStickyDocObserver === 'function') window.__kexoInitStickyDocObserver(); } catch (_) {}
      try { if (typeof window.__kexoInitGridDocObserver === 'function') window.__kexoInitGridDocObserver(); } catch (_) {}
    }
    window.addEventListener('pageshow', function(ev) {
      if (!ev.persisted) return;
      reinitLiveStreamsAndPollers();
      kexoWithSilentOverlay(function() {
        if (PAGE === 'dashboard') {
          try {
            if (window.dashboardController && typeof window.dashboardController.onVisibleResume === 'function') window.dashboardController.onVisibleResume('pageshow');
            else if (typeof window.refreshDashboard === 'function') window.refreshDashboard({ force: true, silent: true });
          } catch (_) {}
        }
        try { refreshKpis({ force: true }); } catch (_) {}
      });
    });

    var VISIBILITY_REFRESH_MIN_IDLE_MS = 30 * 1000; // Skip full refresh if tab was hidden < 30s (avoids lag on brief tab switch)
    document.addEventListener('visibilitychange', function() {
      if (document.visibilityState !== 'visible') {
        _lastHiddenAt = Date.now();
        try { window.__kexoLastHiddenAt = _lastHiddenAt; } catch (_) {}
        return;
      }

      var idleMs = _lastHiddenAt ? (Date.now() - _lastHiddenAt) : 0;
      // Skip refresh for brief hides (< 30s) to avoid CPU/memory spike when returning to tab.
      if (idleMs < VISIBILITY_REFRESH_MIN_IDLE_MS) {
        return onBecameVisible();
      }
      // Dashboard has its own visibility listener (dashboardController); delegate to avoid duplicate refresh.
      // When on dashboard, dashboardController handles refresh + KPIs. When on other pages, refresh KPIs only.
      if (idleMs < 2 * 60 * 1000 && PAGE === 'dashboard') {
        kexoWithSilentOverlay(function() {
          try {
            if (window.dashboardController && typeof window.dashboardController.onVisibleResume === 'function') window.dashboardController.onVisibleResume('visibility');
            else {
              if (typeof window.refreshDashboard === 'function') window.refreshDashboard({ force: true, silent: true });
              try { refreshKpis({ force: true }); } catch (_) {}
            }
          } catch (_) {}
        });
      } else if (idleMs < 2 * 60 * 1000 && PAGE !== 'dashboard') {
        kexoWithSilentOverlay(function() {
          try { refreshKpis({ force: true }); } catch (_) {}
        });
      }
      if (idleMs < RESUME_RELOAD_IDLE_MS) return onBecameVisible();

      fetchVersionSig()
        .then(function(sig) {
          if (_bootVersionSig && sig && sig !== _bootVersionSig) {
            try { setUpdateAvailable(true, { reason: 'New deploy detected.' }); } catch (_) {}
            try { _bootVersionSig = sig; } catch (_) {}
            return onBecameVisible();
          }
          if (!_bootVersionSig && sig) _bootVersionSig = sig;
          onBecameVisible();
        })
        .catch(function() {
          onBecameVisible();
        });
    });

    var _newSaleRefreshTimer = null;
    function scheduleNewSaleDashboardRefresh() {
      if (_newSaleRefreshTimer) return;
      _newSaleRefreshTimer = setTimeout(function () {
        _newSaleRefreshTimer = null;
        try { if (typeof refreshKpis === 'function') refreshKpis({ force: true }); } catch (_) {}
        try {
          if (PAGE === 'dashboard' || activeMainTab === 'dashboard') {
            if (typeof window.refreshDashboard === 'function') window.refreshDashboard({ force: true, silent: true, reason: 'new-sale' });
          }
        } catch (_) {}
      }, 280);
    }

    function initEventSource() {
      if (_eventSource) { try { _eventSource.close(); } catch (_) {} }
      var es = new EventSource(API + '/api/stream');
      _eventSource = es;
      es.onerror = function() {
        // Browser auto-reconnects on transient errors; if the connection is
        // permanently closed (readyState === CLOSED), retry after a delay.
        if (es.readyState === EventSource.CLOSED) {
          try { es.close(); } catch (_) {}
          setTimeout(function() { if (_eventSource === es) initEventSource(); }, 5000);
        }
      };

      function maybePatchActiveSaleToastAmount(session) {
        // If the toast is currently showing for this session, patch the amount when order_total arrives.
        try {
          const sid = session && session.session_id != null ? String(session.session_id) : '';
          if (!sid || !saleToastActive || !saleToastSessionId || String(saleToastSessionId) !== sid) return;
          const cc = session && session.country_code ? String(session.country_code).toUpperCase().slice(0, 2) : 'XX';
          const productTitle = (session && session.last_product_handle) ? titleCaseFromHandle(String(session.last_product_handle)) : '';
          const curTitle = document.getElementById('sale-toast-product') ? String(document.getElementById('sale-toast-product').textContent || '') : '';
          let amountGbp = null;
          if (session && session.order_total != null) {
            const n = typeof session.order_total === 'number' ? session.order_total : parseFloat(String(session.order_total));
            if (Number.isFinite(n)) amountGbp = n;
          }
          if (amountGbp != null && Number.isFinite(amountGbp)) {
            setSaleToastContent({ countryCode: cc || 'XX', productTitle: (productTitle || curTitle || '\u2014'), amountGbp });
          }
        } catch (_) {}
      }

      function maybeTriggerSaleToastFromSse(session) {
        try {
          if (!session || !session.has_purchased) return;
          const purchasedAt = session.purchased_at != null ? toMs(session.purchased_at) : null;
          if (purchasedAt == null) return;
          const cur = lastSaleAt == null ? null : toMs(lastSaleAt);
          // If we don't have a baseline yet: only skip if the sale is old (likely stale catch-up).
          // If the sale is recent (within 2 min), treat it as new and fire toast + sound.
          if (cur == null) {
            setLastSaleAt(purchasedAt);
            const ageMs = Date.now() - purchasedAt;
            if (ageMs > 2 * 60 * 1000) return; // older than 2 min: skip (stale)
            triggerSaleToast({ origin: 'sse', session: session, playSound: true });
            scheduleNewSaleDashboardRefresh();
            return;
          }
          if (purchasedAt <= cur) { setLastSaleAt(purchasedAt); return; }
          setLastSaleAt(purchasedAt);
          triggerSaleToast({ origin: 'sse', session: session, playSound: true });
          scheduleNewSaleDashboardRefresh();
        } catch (_) {}
      }

      es.onmessage = function(e) {
        try {
          var msg = JSON.parse(e.data);
          if (msg.type === 'session_update' && msg.session) {
            const session = msg.session;
            // Keep footer "Last sale" correct and show the banner globally.
            if (session && session.has_purchased && session.purchased_at != null) {
              maybeTriggerSaleToastFromSse(session);
              maybePatchActiveSaleToastAmount(session);
              try { upsertLatestSaleRow(session); } catch (_) {}
            }
          }
        } catch (_) {}
      };
    }
    initEventSource();

    // ?????? Cleanup on page unload (centralized via registerCleanup in core) ??????
    registerCleanup(function() {
      _intervals.forEach(function(id) { clearInterval(id); });
      _intervals.length = 0;
      _tickTimeIntervalId = null;
      if (liveSalesPollTimer) { try { clearTimeout(liveSalesPollTimer); } catch (_) {} liveSalesPollTimer = null; }
      if (_newSaleRefreshTimer) { try { clearTimeout(_newSaleRefreshTimer); } catch (_) {} _newSaleRefreshTimer = null; }
      if (_eventSource) { try { _eventSource.close(); } catch (_) {} _eventSource = null; }
      if (_condensedStripResizeObserver) {
        try { _condensedStripResizeObserver.disconnect(); } catch (_) {}
        _condensedStripResizeObserver = null;
      }
      try {
        document.querySelectorAll('.table-scroll-wrap, .country-table-wrap, .grid-table, .table-responsive').forEach(function(wrap) {
          try { if (wrap && wrap._dragScrollObserver && typeof wrap._dragScrollObserver.disconnect === 'function') wrap._dragScrollObserver.disconnect(); } catch (_) {}
          try { if (wrap && wrap._stickyResizeObserver && typeof wrap._stickyResizeObserver.disconnect === 'function') wrap._stickyResizeObserver.disconnect(); } catch (_) {}
          try { if (wrap && wrap._stickyResizeMutationObserver && typeof wrap._stickyResizeMutationObserver.disconnect === 'function') wrap._stickyResizeMutationObserver.disconnect(); } catch (_) {}
        });
      } catch (_) {}
      Object.keys(_fetchAbortControllers).forEach(function(k) {
        try { _fetchAbortControllers[k].abort(); } catch (_) {}
      });
    });

    // ?????? Dashboard tab logic ??????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
    (function initDashboard() {
      var dashLoading = false;
      var dashLastRangeKey = null;
      var dashLastDayYmd = null;
      var dashCompareSeriesCache = null;
      var dashCompareRangeKey = null;
      var dashCompareFetchedAt = 0;
      var dashCompareSeriesInFlight = null;
      var dashPayloadSignature = '';
      var dashCharts = {};
      var dashSparkCharts = {};
      var dashController = null;
      var overviewMiniResizeObserver = null;
      var overviewMiniResizeScheduled = false;
      var overviewMiniSizeSignature = '';
      var overviewMiniCache = null;
      var overviewMiniFetchedAt = 0;
      var overviewMiniInFlight = null;
      var overviewMiniCacheShopKey = '';
      var overviewMiniPayloadSignature = '';
      var overviewMiniResizeTimer = null;
      var overviewHeightSyncObserver = null;
      var overviewHeightSyncTimer = null;
      var overviewHeightSyncObservedElements = [];
      var overviewMiniResizeObservedElements = [];
      var OVERVIEW_MINI_CACHE_MS = 2 * 60 * 1000;
      var OVERVIEW_MINI_FORCE_REFRESH_MS = 5 * 60 * 1000;
      var OVERVIEW_CARD_RANGE_LS_PREFIX = 'kexo:overview-card-range:v1:';
      var OVERVIEW_CARD_DEFAULT_RANGE = '7d';
      var overviewCardCache = {}; // chartId -> { rangeKey, fetchedAt, payload }
      var overviewCardInFlight = {}; // chartId -> Promise
      var overviewCardPayloadSignature = {}; // chartId -> string
      var overviewLazyObserver = null;
      var overviewLazyPending = {};
      var overviewLazyVisible = {};
      var overviewCardUiBound = false;
      var OVERVIEW_LAZY_CHART_IDS = {
        'dash-chart-attribution-30d': true,
        'dash-chart-overview-30d': true
      };
      function cssColorToRgbTriplet(value, fallback) {
        var raw = value == null ? '' : String(value).trim();
        if (!raw) return fallback;
        var hex = raw.replace(/^#/, '');
        if (/^[0-9a-f]{6}$/i.test(hex)) {
          var r = parseInt(hex.slice(0, 2), 16);
          var g = parseInt(hex.slice(2, 4), 16);
          var b = parseInt(hex.slice(4, 6), 16);
          return r + ',' + g + ',' + b;
        }
        var m = raw.replace(/\s+/g, '').match(/^rgba?\((\d+),(\d+),(\d+)(?:,([0-9.]+))?\)$/i);
        if (m) {
          var rr = Math.max(0, Math.min(255, parseInt(m[1], 10) || 0));
          var gg = Math.max(0, Math.min(255, parseInt(m[2], 10) || 0));
          var bb = Math.max(0, Math.min(255, parseInt(m[3], 10) || 0));
          return rr + ',' + gg + ',' + bb;
        }
        return fallback;
      }
      var _rootStylesDash = getComputedStyle(document.documentElement);
      var _primaryRgbDash = _rootStylesDash.getPropertyValue('--tblr-primary-rgb').trim() || '32,107,196';
      var _accentRgbDash = cssColorToRgbTriplet(_rootStylesDash.getPropertyValue('--kexo-accent-1').trim(), _primaryRgbDash);
      var DASH_ACCENT = 'rgb(' + _primaryRgbDash + ')';
      var DASH_ACCENT_LIGHT = 'rgba(' + _primaryRgbDash + ',0.12)';
      var WIDGET_RING_AND_BAR = 'rgba(' + _accentRgbDash + ',0.2)';
      var DASH_ORANGE = '#f59e0b';
      var DASH_ORANGE_LIGHT = 'rgba(245,158,11,0.10)';
      var DASH_BLUE = '#3b82f6';
      var DASH_BLUE_LIGHT = 'rgba(59,130,246,0.10)';
      var DASH_PURPLE = '#8b5cf6';
      var DASH_PURPLE_LIGHT = 'rgba(139,92,246,0.10)';

      var OVERVIEW_WIDGETS_UI_CFG_LS_KEY = 'kexo:overview_widgets_ui_config:v1';
      var OVERVIEW_WIDGET_KEYS = ['finishes', 'devices', 'browsers', 'abandoned', 'attribution', 'payment_methods'];
      var OVERVIEW_WIDGET_TITLES = {
        finishes: 'Finishes',
        devices: 'Devices',
        browsers: 'Browsers',
        abandoned: 'Abandoned Carts',
        attribution: 'Attribution',
        payment_methods: 'Payment Methods',
      };
      var OVERVIEW_WIDGET_SUPPORTS = {
        finishes: { revenue: true, clicks: true, ctr: true },
        devices: { revenue: true, clicks: true, ctr: true },
        browsers: { revenue: true, clicks: true, ctr: true },
        abandoned: { revenue: true, clicks: true, ctr: false },
        attribution: { revenue: true, clicks: true, ctr: true },
        payment_methods: { revenue: true, clicks: true, ctr: true },
      };

      var dashWidgetsBound = false;
      var dashWidgetCache = {}; // cacheKey -> { fetchedAt, sig, data }
      var dashWidgetInFlight = {}; // cacheKey -> Promise
      var dashWidgetLastRenderSig = {}; // mountId -> sig
      var DASH_WIDGET_CACHE_TTL_MS = 2 * 60 * 1000;
      var dashWidgetsRefreshTimer = null;
      var dashWidgetsPendingOpts = null;

      var ovwUiCfgLocal = null;
      var ovwSaveTimer = null;
      var ovwSaveInFlight = null;
      var ovwSaveQueuedCfg = null;
      var ovwModalBackdrop = null;
      var ovwSettingsKey = '';

      function fmtGbp(n) {
        var v = (typeof n === 'number') ? n : Number(n);
        if (!isFinite(v)) return '\u2014';
        if (typeof formatRevenue0 === 'function') return formatRevenue0(v) || '\u2014';
        try { return '\u00A3' + Math.round(v).toLocaleString('en-GB'); } catch (_) { return '\u00A3' + String(Math.round(v)); }
      }
      function fmtNum(n) { return n != null ? n.toLocaleString() : '\u2014'; }
      function shortDate(ymd) {
        var parts = ymd.split('-');
        var d = parseInt(parts[2], 10);
        var months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
        var m = months[parseInt(parts[1], 10) - 1] || '';
        return d + ' ' + m;
      }
      function shortHourLabel(key) {
        if (!key) return '';
        var s = String(key);
        var idx = s.indexOf(' ');
        if (idx >= 0) return s.slice(idx + 1);
        return s;
      }

      function fastPayloadHash(input) {
        var str = (input == null ? '' : String(input));
        var hash = 5381;
        for (var i = 0; i < str.length; i++) {
          hash = ((hash << 5) + hash) ^ str.charCodeAt(i);
        }
        return String(hash >>> 0);
      }

      function dashboardPayloadSignature(data, rangeKey) {
        var safeData = data && typeof data === 'object' ? data : {};
        var sigPayload = {
          range: String(rangeKey || ''),
          labels: Array.isArray(safeData.labels) ? safeData.labels : [],
          revenue: Array.isArray(safeData.revenue) ? safeData.revenue : [],
          sessions: Array.isArray(safeData.sessions) ? safeData.sessions : [],
          orders: Array.isArray(safeData.orders) ? safeData.orders : [],
          topProducts: Array.isArray(safeData.topProducts) ? safeData.topProducts : [],
          topCountries: Array.isArray(safeData.topCountries) ? safeData.topCountries : [],
          trendingUp: Array.isArray(safeData.trendingUp) ? safeData.trendingUp : [],
          trendingDown: Array.isArray(safeData.trendingDown) ? safeData.trendingDown : []
        };
        try {
          return fastPayloadHash(JSON.stringify(sigPayload) || '');
        } catch (_) {
          return fastPayloadHash(String(Date.now()));
        }
      }

      function sanitizeChartConfig(labels, datasets) {
        var srcLabels = Array.isArray(labels) ? labels : [];
        var srcDatasets = Array.isArray(datasets) ? datasets : [];
        var normalized = srcDatasets.map(function(ds) {
          var next = Object.assign({}, ds || {});
          next.data = Array.isArray(next.data) ? next.data.slice() : [];
          return next;
        });
        var maxLen = srcLabels.length;
        normalized.forEach(function(ds) {
          if (Array.isArray(ds.data) && ds.data.length > maxLen) maxLen = ds.data.length;
        });
        var outLabels = srcLabels.slice(0, maxLen).map(function(lbl, idx) {
          var text = lbl == null ? '' : String(lbl).trim();
          return text || String(idx + 1);
        });
        while (outLabels.length < maxLen) outLabels.push(String(outLabels.length + 1));
        var seen = Object.create(null);
        outLabels = outLabels.map(function(lbl) {
          var base = String(lbl || '').trim() || '—';
          var key = base.toLowerCase();
          seen[key] = (seen[key] || 0) + 1;
          return seen[key] > 1 ? (base + ' (' + String(seen[key]) + ')') : base;
        });
        normalized.forEach(function(ds) {
          if (!Array.isArray(ds.data)) ds.data = [];
          if (ds.data.length > maxLen) ds.data = ds.data.slice(0, maxLen);
          while (ds.data.length < maxLen) ds.data.push(0);
        });
        return { labels: outLabels, datasets: normalized };
      }

      function validateChartType(chartId, requestedMode, fallbackMode) {
        var fallback = String(fallbackMode || 'area').trim().toLowerCase() || 'area';
        var req = String(requestedMode || '').trim().toLowerCase();
        if (!req) req = fallback;
        try {
          if (typeof window.kexoChartMeta === 'function') {
            var meta = window.kexoChartMeta(chartId);
            var allowed = meta && Array.isArray(meta.modes) ? meta.modes.map(function(m) { return String(m).trim().toLowerCase(); }) : [];
            if (allowed.length && allowed.indexOf(req) < 0) {
              if (allowed.indexOf(fallback) >= 0) return fallback;
              if (meta && meta.defaultMode) return String(meta.defaultMode).trim().toLowerCase();
              return allowed[0];
            }
          }
        } catch (_) {}
        return req;
      }

      function formatOverviewBucketLabel(rawLabel, granularity) {
        var key = rawLabel == null ? '' : String(rawLabel).trim();
        var g = String(granularity || '').trim().toLowerCase();
        if (!key) return '';
        if (g === 'hour') {
          if (key.indexOf(' ') >= 0) return shortHourLabel(key);
          return key;
        }
        if (g === 'week') {
          if (/^\d{4}-\d{2}-\d{2}$/.test(key)) return 'Wk ' + shortDate(key);
          return key;
        }
        if (/^\d{4}-\d{2}-\d{2}$/.test(key)) return shortDate(key);
        return key;
      }

      function normalizeOverviewCardRangeKey(raw, fallback) {
        var fb = (fallback == null ? '' : String(fallback)).trim().toLowerCase() || OVERVIEW_CARD_DEFAULT_RANGE;
        var s = (raw == null ? '' : String(raw)).trim().toLowerCase();
        if (!s) return fb;
        if (s === '7days') s = '7d';
        if (s === 'today' || s === 'yesterday' || s === '7d') return s;
        if (/^r:\d{4}-\d{2}-\d{2}:\d{4}-\d{2}-\d{2}$/.test(s)) return s;
        if (/^d:\d{4}-\d{2}-\d{2}$/.test(s)) return s;
        return fb;
      }

      function overviewCardRangeStorageKey(chartId) {
        var id = (chartId == null ? '' : String(chartId)).trim().toLowerCase();
        return OVERVIEW_CARD_RANGE_LS_PREFIX + id;
      }

      function getOverviewCardRange(chartId, fallback) {
        var fb = normalizeOverviewCardRangeKey(fallback, OVERVIEW_CARD_DEFAULT_RANGE);
        var raw = '';
        try { raw = localStorage.getItem(overviewCardRangeStorageKey(chartId)) || ''; } catch (_) { raw = ''; }
        return normalizeOverviewCardRangeKey(raw, fb);
      }

      function setOverviewCardRange(chartId, rangeKey) {
        var id = (chartId == null ? '' : String(chartId)).trim().toLowerCase();
        if (!id) return;
        var rk = normalizeOverviewCardRangeKey(rangeKey, OVERVIEW_CARD_DEFAULT_RANGE);
        try { localStorage.setItem(overviewCardRangeStorageKey(id), String(rk)); } catch (_) {}
      }

      function formatYmdDayMonth(ymd) {
        var s = (ymd == null ? '' : String(ymd)).trim();
        if (!/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
        var m = parseInt(s.slice(5, 7), 10);
        var d = parseInt(s.slice(8, 10), 10);
        if (!Number.isFinite(m) || !Number.isFinite(d)) return s;
        return String(d) + '/' + String(m);
      }

      function formatRangeKeyDayMonth(rangeKey) {
        var rk = normalizeOverviewCardRangeKey(rangeKey, '');
        if (!rk) return '';
        if (rk === 'today') return 'Today';
        if (rk === 'yesterday') return 'Yesterday';
        if (rk === '7d') return '7 Days';
        if (/^d:\d{4}-\d{2}-\d{2}$/.test(rk)) return formatYmdDayMonth(rk.slice(2));
        var m = rk.match(/^r:(\d{4}-\d{2}-\d{2}):(\d{4}-\d{2}-\d{2})$/);
        if (m && m[1] && m[2]) {
          var a = formatYmdDayMonth(m[1]);
          var b = formatYmdDayMonth(m[2]);
          if (a && b) return a + ' – ' + b;
        }
        return '7 Days';
      }

      function overviewCardRevenueSubtitle(rangeKey) {
        var rk = normalizeOverviewCardRangeKey(rangeKey, OVERVIEW_CARD_DEFAULT_RANGE);
        if (rk === '7d') return '7 Day Revenue';
        var label = formatRangeKeyDayMonth(rk);
        if (!label) return 'Revenue';
        return label + ' Revenue';
      }

      function overviewCardWrap(chartId) {
        try { return document.querySelector('[data-kexo-chart-key="' + String(chartId || '') + '"]'); } catch (_) { return null; }
      }

      function syncOverviewCardRangeUi(chartId) {
        var rk = getOverviewCardRange(chartId, OVERVIEW_CARD_DEFAULT_RANGE);
        var wrap = overviewCardWrap(chartId);
        if (wrap) {
          var btn = wrap.querySelector('.kexo-overview-range-input');
          if (btn) btn.textContent = formatRangeKeyDayMonth(rk);
        }
        try {
          var sub = document.querySelector('[data-overview-subtitle][data-chart-id="' + String(chartId || '') + '"]');
          if (sub) sub.textContent = overviewCardRevenueSubtitle(rk);
        } catch (_) {}
      }

      function syncAllOverviewCardRangeUi() {
        try { overviewMiniChartIds().forEach(function (id) { syncOverviewCardRangeUi(id); }); } catch (_) {}
      }
      function ymdInAdminTzFromMs(ms) {
        var n = Number(ms);
        if (!Number.isFinite(n)) return null;
        try {
          return new Intl.DateTimeFormat('en-CA', { timeZone: tz, year: 'numeric', month: '2-digit', day: '2-digit' }).format(new Date(n));
        } catch (_) {
          try {
            return new Intl.DateTimeFormat('en-CA', { year: 'numeric', month: '2-digit', day: '2-digit' }).format(new Date(n));
          } catch (_) {
            return null;
          }
        }
      }
      function compareRangeKeyFromKpiPayload(kpiObj) {
        var cmp = kpiObj && kpiObj.compare && kpiObj.compare.range ? kpiObj.compare.range : null;
        var startMs = cmp && cmp.start != null ? Number(cmp.start) : NaN;
        var endMs = cmp && cmp.end != null ? Number(cmp.end) : NaN;
        if (!Number.isFinite(startMs) || !Number.isFinite(endMs) || !(endMs > startMs)) return null;
        var startYmd = ymdInAdminTzFromMs(startMs);
        var endYmd = ymdInAdminTzFromMs(Math.max(startMs, endMs - 1));
        if (!startYmd || !endYmd) return null;
        if (startYmd === endYmd) return 'd:' + startYmd;
        return 'r:' + startYmd + ':' + endYmd;
      }
      function ensureDashboardCompareSeries(kpiObj) {
        var compareRangeKey = compareRangeKeyFromKpiPayload(kpiObj);
        if (!compareRangeKey) return Promise.resolve(null);
        var cmp = kpiObj && kpiObj.compare && kpiObj.compare.range ? kpiObj.compare.range : null;
        var endMs = cmp && cmp.end != null ? Number(cmp.end) : NaN;
        var endMsRounded = Number.isFinite(endMs) ? (Math.floor(endMs / (60 * 1000)) * (60 * 1000)) : null;
        var cacheKey = endMsRounded != null ? (compareRangeKey + '|endMs:' + String(endMsRounded)) : compareRangeKey;
        var fresh = dashCompareRangeKey === cacheKey &&
          Array.isArray(dashCompareSeriesCache) &&
          dashCompareSeriesCache.length >= 2 &&
          dashCompareFetchedAt &&
          (Date.now() - dashCompareFetchedAt) < KPI_CACHE_TTL_MS;
        if (fresh) return Promise.resolve(dashCompareSeriesCache);
        if (dashCompareSeriesInFlight && dashCompareRangeKey === cacheKey) return dashCompareSeriesInFlight;
        dashCompareRangeKey = cacheKey;
        var url = API + '/api/dashboard-series?range=' + encodeURIComponent(compareRangeKey);
        if (endMsRounded != null) url += '&endMs=' + encodeURIComponent(String(endMsRounded));
        dashCompareSeriesInFlight = fetchWithTimeout(url, { credentials: 'same-origin', cache: 'default' }, 20000)
          .then(function(r) { return (r && r.ok) ? r.json() : null; })
          .then(function(data) {
            var s = data && Array.isArray(data.series) ? data.series : null;
            if (s && s.length >= 2) {
              dashCompareSeriesCache = s;
              dashCompareFetchedAt = Date.now();
              return s;
            }
            return null;
          })
          .catch(function() { return null; })
          .finally(function() { dashCompareSeriesInFlight = null; });
        return dashCompareSeriesInFlight;
      }

      function waitForApexCharts(cb, retries) {
        if (typeof ApexCharts !== 'undefined') { cb(); return; }
        if (!retries) retries = 0;
        if (retries >= 15) {
          // This bundle is loaded on non-dashboard pages too (e.g. Settings). Only capture this
          // when the dashboard is actually present to avoid noise.
          var shouldCapture = false;
          try {
            shouldCapture = !!(
              (typeof PAGE !== 'undefined' && PAGE === 'dashboard') ||
              (typeof document !== 'undefined' && document && (
                document.getElementById('tab-panel-dashboard') ||
                document.getElementById('dash-chart-overview-30d')
              ))
            );
          } catch (_) { shouldCapture = false; }
          if (shouldCapture) captureChartMessage('ApexCharts failed to load after retries', 'dashboardApexLoad', { retries: retries }, 'error');
          return;
        }
        setTimeout(function() { waitForApexCharts(cb, retries + 1); }, 200);
      }

      var dashChartConfigs = {};

      function truncatePinTitle(s) {
        var v = s == null ? '' : String(s).trim();
        if (!v) return '';
        return v.length > 26 ? (v.slice(0, 25) + '…') : v;
      }

      function buildPinAnnotationsForCategories(categoryLabels, pins) {
        var labels = Array.isArray(categoryLabels) ? categoryLabels : [];
        var list = Array.isArray(pins) ? pins : [];
        if (!labels.length || !list.length) return [];
        var idx = new Map();
        for (var i = 0; i < labels.length; i++) {
          var key = labels[i] != null ? String(labels[i]) : '';
          if (!key) continue;
          if (!idx.has(key)) idx.set(key, i);
        }
        var out = [];
        for (var j = 0; j < list.length; j++) {
          var p = list[j] || {};
          var ymd = p.event_ymd ? String(p.event_ymd) : '';
          if (!ymd) continue;
          var cands = [];
          cands.push(ymd);
          try { cands.push(shortDate(ymd)); } catch (_) {}
          var matchedLabel = null;
          for (var k = 0; k < cands.length; k++) {
            var c = cands[k];
            if (!c) continue;
            if (idx.has(c)) { matchedLabel = c; break; }
          }
          if (!matchedLabel) continue;
          var text = truncatePinTitle(p.title || '') || 'Pin';
          out.push({
            x: matchedLabel,
            borderColor: 'rgba(15,23,42,0.35)',
            strokeDashArray: 0,
            label: {
              text: text,
              borderColor: 'rgba(15,23,42,0.55)',
              style: {
                background: 'rgba(15,23,42,0.75)',
                color: '#ffffff',
                fontSize: '10px',
                fontWeight: 500,
              },
              offsetY: -6,
            },
          });
        }
        return out;
      }

      function applyChangePinsOverlayToChart(chartId, chart, categoryLabels) {
        if (!chart || !categoryLabels || !categoryLabels.length) return;
        if (typeof window === 'undefined') return;
        var cached = null;
        try {
          cached = (typeof window.__kexoReadChangePinsRecentCache === 'function') ? window.__kexoReadChangePinsRecentCache() : null;
        } catch (_) {}
        var ann = buildPinAnnotationsForCategories(categoryLabels, cached);
        if (ann && ann.length) {
          try {
            if (dashCharts && dashCharts[chartId] !== chart) return;
            chart.updateOptions({ annotations: { xaxis: ann, yaxis: [], points: [], texts: [], images: [] } }, false, true);
          } catch (_) {}
          return;
        }
        try {
          if (typeof window.__kexoGetChangePinsRecent !== 'function') return;
          window.__kexoGetChangePinsRecent(120, false).then(function (pins) {
            if (!pins) return;
            var nextAnn = buildPinAnnotationsForCategories(categoryLabels, pins);
            if (!nextAnn || !nextAnn.length) return;
            try {
              if (dashCharts && dashCharts[chartId] !== chart) return;
              chart.updateOptions({ annotations: { xaxis: nextAnn, yaxis: [], points: [], texts: [], images: [] } }, false, true);
            } catch (_) {}
          });
        } catch (_) {}
      }

      function upsertDashboardApexChart(chartId, chartEl, apexOpts, afterRender) {
        if (!chartEl || !apexOpts || typeof ApexCharts === 'undefined') return null;
        var existing = dashCharts && dashCharts[chartId] ? dashCharts[chartId] : null;
        var series = Array.isArray(apexOpts.series) ? apexOpts.series : [];
        if (existing && typeof existing.updateOptions === 'function' && typeof existing.updateSeries === 'function') {
          try {
            var optsNoSeries = Object.assign({}, apexOpts);
            delete optsNoSeries.series;
            existing.updateOptions(optsNoSeries, false, true, false);
            existing.updateSeries(series, false);
            if (typeof afterRender === 'function') {
              setTimeout(function() {
                try { afterRender(existing); } catch (_) {}
              }, 0);
            }
            return existing;
          } catch (updateErr) {
            try { existing.destroy(); } catch (_) {}
            try { delete dashCharts[chartId]; } catch (_) {}
            captureChartError(updateErr, 'dashboardChartUpdate', { chartId: chartId });
          }
        }
        chartEl.innerHTML = '';
        var chart = new ApexCharts(chartEl, apexOpts);
        dashCharts[chartId] = chart;
        var rendered = null;
        try { rendered = chart.render(); } catch (_) { rendered = null; }
        if (rendered && typeof rendered.then === 'function') {
          rendered.then(function() {
            if (typeof afterRender === 'function') afterRender(chart);
          }).catch(function() {});
        } else if (typeof afterRender === 'function') {
          setTimeout(function() { afterRender(chart); }, 0);
        }
        return chart;
      }

      function makeChart(chartId, labels, datasets, opts) {
        if (typeof ApexCharts === 'undefined') {
          waitForApexCharts(function() { makeChart(chartId, labels, datasets, opts); });
          return null;
        }
        if (!chartId) return null;
        var el = document.getElementById(chartId);
        if (!el) { console.warn('[dashboard] chart element not found:', chartId); return null; }

        var chartScope = (opts && opts.chartScope) ? String(opts.chartScope) : ('dashboard-' + chartId);
        var defaultType = (opts && opts.chartType) || 'area';
        var requestedMode = chartModeFromUiConfig(chartId, defaultType) || defaultType;
        requestedMode = validateChartType(chartId, requestedMode, defaultType);
        var showEndLabels = requestedMode === 'multi-line-labels';
        var stacked = requestedMode === 'stacked-area' || requestedMode === 'stacked-bar';
        var chartType = requestedMode === 'multi-line-labels' ? 'line' : requestedMode === 'stacked-area' ? 'area' : requestedMode === 'stacked-bar' ? 'bar' : requestedMode === 'combo' ? 'area' : requestedMode;
        chartType = normalizeChartType(chartType, normalizeChartType(defaultType, 'area'));

        if (!isChartEnabledByUiConfig(chartId, true)) {
          try { if (dashCharts[chartId]) dashCharts[chartId].destroy(); } catch (_) {}
          dashCharts[chartId] = null;
          el.innerHTML = '';
          return null;
        }

        var normalized = sanitizeChartConfig(labels, datasets);
        labels = normalized.labels;
        datasets = normalized.datasets;

        try {
          var uiColors = chartColorsFromUiConfig(chartId, []);
          if (uiColors && uiColors.length && Array.isArray(datasets)) {
            datasets = datasets.map(function(ds, idx) {
              if (!ds || typeof ds !== 'object') return ds;
              var next = Object.assign({}, ds);
              var c = uiColors[idx];
              if (c) {
                // Keep profit series sign-aware when the UI config doesn't include a dedicated negative colour.
                if (!(String(chartId || '') === 'dash-chart-overview-30d' && idx === 2 && uiColors.length < 4)) {
                  next.borderColor = c;
                }
              }
              return next;
            });
          }
          // Overview chart supports separate "Profit (negative)" color (uiColors[3]).
          if (String(chartId || '') === 'dash-chart-overview-30d' && uiColors && uiColors.length >= 4 && Array.isArray(datasets) && datasets.length >= 3) {
            var profitDs = datasets[2];
            var profitData = profitDs && Array.isArray(profitDs.data) ? profitDs.data : [];
            var hasPos = false;
            var hasNeg = false;
            var latest = null;
            for (var i = 0; i < profitData.length; i++) {
              var n = Number(profitData[i]);
              if (!Number.isFinite(n)) continue;
              latest = n;
              if (n > 0) hasPos = true;
              if (n < 0) hasNeg = true;
            }
            var useNeg = Number.isFinite(latest) ? (latest < 0 || (!hasPos && hasNeg)) : false;
            var profitColor = useNeg ? uiColors[3] : uiColors[2];
            function hexToRgba(hex, a) {
              var h = (hex == null ? '' : String(hex)).trim().replace(/^#/, '');
              if (h.length !== 6) return null;
              var r = parseInt(h.slice(0, 2), 16);
              var g = parseInt(h.slice(2, 4), 16);
              var b = parseInt(h.slice(4, 6), 16);
              var alpha = (typeof a === 'number' && isFinite(a)) ? Math.max(0, Math.min(1, a)) : 0.14;
              if (!isFinite(r) || !isFinite(g) || !isFinite(b)) return null;
              return 'rgba(' + r + ',' + g + ',' + b + ',' + alpha + ')';
            }
            datasets = datasets.map(function(ds, idx) {
              if (!ds || typeof ds !== 'object') return ds;
              if (idx !== 2) return ds;
              var next = Object.assign({}, ds);
              if (profitColor) next.borderColor = profitColor;
              var bg = profitColor ? hexToRgba(profitColor, 0.14) : null;
              if (bg) next.backgroundColor = bg;
              return next;
            });
          }
        } catch (_) {}

        dashChartConfigs[chartId] = { labels: labels, datasets: datasets, opts: Object.assign({}, opts || {}, { chartType: chartType, chartScope: chartScope }) };

        var uiStyle = (typeof chartStyleFromUiConfig === 'function') ? chartStyleFromUiConfig(chartId) : null;
        var horizontal = !(opts && opts.horizontal === false);
        var fillOpacityVal = (uiStyle && Number.isFinite(Number(uiStyle.fillOpacity))) ? Math.max(0, Math.min(1, Number(uiStyle.fillOpacity))) : null;
        var areaOpacityFrom = (opts && typeof opts.areaOpacityFrom === 'number' && isFinite(opts.areaOpacityFrom)) ? opts.areaOpacityFrom : 0.15;
        var areaOpacityTo = (opts && typeof opts.areaOpacityTo === 'number' && isFinite(opts.areaOpacityTo)) ? opts.areaOpacityTo : 0.02;
        var chartHeight = (opts && Number.isFinite(Number(opts.height))) ? Number(opts.height) : 200;
        if (!Number.isFinite(chartHeight) || chartHeight < 80) chartHeight = 200;
        try {
          if (typeof chartSizePercentFromUiConfig === 'function') {
            var pct = chartSizePercentFromUiConfig(chartId, 100);
            if (Number.isFinite(pct) && pct > 0 && pct !== 100) {
              chartHeight = Math.round(chartHeight * (pct / 100));
              if (chartHeight < 80) chartHeight = 80;
            }
          }
        } catch (_) {}

        try {
          if (Array.isArray(labels) && labels.length === 1) labels = [labels[0], labels[0]];
          if (Array.isArray(datasets)) {
            datasets.forEach(function(ds) {
              if (!ds || !Array.isArray(ds.data)) return;
              if (ds.data.length === 1) ds.data = [ds.data[0], ds.data[0]];
            });
          }
        } catch (_) {}

        try {
          var apexSeries = datasets.map(function(ds) {
            var safeData = Array.isArray(ds && ds.data) ? ds.data.map(function(v) {
              var n = (typeof v === 'number') ? v : Number(v);
              return isFinite(n) ? n : 0;
            }) : [];
            return { name: ds.label, data: safeData };
          });
          var colors = datasets.map(function(ds) { return ds.borderColor || DASH_ACCENT; });
          var yMaxOverride = null;
          var yMinOverride = 0;
          try {
            var maxV = null;
            var minV = null;
            apexSeries.forEach(function(s) {
              (s.data || []).forEach(function(v) {
                var n = (typeof v === 'number') ? v : Number(v);
                if (!isFinite(n)) return;
                if (maxV == null || n > maxV) maxV = n;
                if (minV == null || n < minV) minV = n;
              });
            });
            if (maxV == null) maxV = 0;
            if (maxV <= 0) yMaxOverride = 1;
            else yMaxOverride = maxV + Math.max(1e-6, Math.abs(maxV) * 0.12);
            if (minV != null && minV < 0) yMinOverride = minV - Math.max(1e-6, Math.abs(minV) * 0.12);
          } catch (_) {}
          var yFmt = (opts && opts.pct) ? function(v) { return v != null ? Number(v).toFixed(1) + '%' : '\u2014'; }
            : (opts && opts.currency) ? function(v) {
              if (v == null) return '\u2014';
              var n = Number(v);
              if (!isFinite(n)) return '\u2014';
              if (typeof formatRevenue0 === 'function') return formatRevenue0(n) || '\u2014';
              try { return '\u00A3' + Math.round(n).toLocaleString('en-GB'); } catch (_) { return '\u00A3' + String(Math.round(n)); }
            }
            : function(v) { return v != null ? Number(v).toLocaleString() : '\u2014'; };
          var legendPos = (opts && opts.legendPosition != null) ? String(opts.legendPosition).trim().toLowerCase() : 'top';
          if (legendPos !== 'top' && legendPos !== 'bottom' && legendPos !== 'left' && legendPos !== 'right') legendPos = 'top';
          var customTooltip = (opts && typeof opts.tooltipCustom === 'function') ? opts.tooltipCustom : null;
          var tooltipShared = (opts && typeof opts.tooltipShared === 'boolean') ? !!opts.tooltipShared : (apexSeries.length > 1);
          var tooltipIntersect = (opts && typeof opts.tooltipIntersect === 'boolean') ? !!opts.tooltipIntersect : false;
          var tooltipFollowCursor = (opts && typeof opts.tooltipFollowCursor === 'boolean') ? !!opts.tooltipFollowCursor : false;
          var tooltipConfig = {
            enabled: true,
            // For dense charts (especially the Overview Revenue/Cost/Profit), avoid requiring a direct point intersect.
            intersect: tooltipIntersect,
            shared: tooltipShared,
            followCursor: tooltipFollowCursor,
            y: { formatter: yFmt }
          };
          if (customTooltip) tooltipConfig.custom = customTooltip;

          var baseOpacity = fillOpacityVal != null ? fillOpacityVal : 1;
          var areaFrom = fillOpacityVal != null ? fillOpacityVal * areaOpacityFrom : areaOpacityFrom;
          var areaTo = fillOpacityVal != null ? fillOpacityVal * areaOpacityTo : areaOpacityTo;
          var fillConfig = chartType === 'line' ? { type: 'solid', opacity: baseOpacity }
            : chartType === 'bar' ? { type: 'solid', opacity: baseOpacity }
            : { type: 'gradient', gradient: { shadeIntensity: 1, opacityFrom: areaFrom, opacityTo: areaTo, stops: [0, 100] } };
          var animationsEnabled = !!(uiStyle && uiStyle.animations === true);

          var markerSize = (opts && Number.isFinite(Number(opts.markerSize)))
            ? Math.max(0, Number(opts.markerSize))
            : (chartType === 'line' ? 3 : 0);
          var dataLabelsMode = uiStyle && uiStyle.dataLabels != null ? String(uiStyle.dataLabels).trim().toLowerCase() : '';
          var uiStrokeWidth = (uiStyle && Number.isFinite(Number(uiStyle.strokeWidth))) ? Number(uiStyle.strokeWidth) : null;
          var uiBarColumnWidth = (uiStyle && Number.isFinite(Number(uiStyle.barColumnWidth))) ? Number(uiStyle.barColumnWidth) : null;
          var uiGridDash = (uiStyle && Number.isFinite(Number(uiStyle.gridDash))) ? Number(uiStyle.gridDash) : null;
          if (uiStrokeWidth != null) uiStrokeWidth = Math.max(0.5, Math.min(6, uiStrokeWidth));
          if (uiBarColumnWidth != null) uiBarColumnWidth = Math.max(20, Math.min(95, uiBarColumnWidth));
          if (uiGridDash != null) uiGridDash = Math.max(0, Math.min(8, Math.round(uiGridDash)));
          var strokeWidth = chartType === 'bar' ? 0 : (uiStrokeWidth != null ? uiStrokeWidth : 2);
          var barColWidth = uiBarColumnWidth != null ? (String(uiBarColumnWidth) + '%') : (stacked ? '80%' : '60%');
          var gridDashVal = uiGridDash != null ? uiGridDash : 3;
          var gridShow = gridDashVal > 0;
          var apexOpts = {
            chart: {
              type: chartType,
              height: chartHeight,
              fontFamily: 'Inter, sans-serif',
              toolbar: { show: false },
              animations: { enabled: animationsEnabled, easing: 'easeinout', speed: 300 },
              zoom: { enabled: false }
            },
            series: apexSeries,
            colors: colors,
            stroke: { show: true, width: strokeWidth, curve: 'smooth', lineCap: 'round' },
            fill: fillConfig,
            plotOptions: chartType === 'bar' ? { bar: { columnWidth: barColWidth, borderRadius: 3, stacked: stacked } } : (chartType === 'area' && stacked ? { area: { stacked: true } } : {}),
            xaxis: {
              categories: labels || [],
              labels: { style: { fontSize: '10px', cssClass: 'apexcharts-xaxis-label' }, rotate: 0, hideOverlappingLabels: true },
              axisBorder: { show: false },
              axisTicks: { show: false }
            },
            yaxis: {
              labels: { style: { fontSize: '11px', cssClass: 'apexcharts-yaxis-label' }, formatter: yFmt },
              min: yMinOverride,
              max: yMaxOverride,
              forceNiceScale: true
            },
            grid: { show: gridShow, borderColor: '#f0f0f0', strokeDashArray: gridShow ? gridDashVal : 0 },
            tooltip: tooltipConfig,
            legend: { show: apexSeries.length > 1, position: legendPos, fontSize: '11px' },
            dataLabels: (showEndLabels && chartType === 'line') ? {
              enabled: true,
              formatter: function(val, ctx) {
                try {
                  var dp = ctx && ctx.dataPointIndex != null ? Number(ctx.dataPointIndex) : -1;
                  var w = ctx && ctx.w ? ctx.w : null;
                  var last = w && w.globals && Array.isArray(w.globals.labels) ? (w.globals.labels.length - 1) : -1;
                  if (dp !== last) return '';
                } catch (_) { return ''; }
                try { return yFmt(val); } catch (_) { return String(val); }
              },
              style: { fontSize: '10px' },
              background: { enabled: true, borderRadius: 4, padding: 3, opacity: 0.85 },
              offsetY: -3
            } : (dataLabelsMode === 'on') ? {
              enabled: true,
              formatter: function(val) { try { return yFmt(val); } catch (_) { return String(val); } },
              style: { fontSize: '10px' },
              background: { enabled: true, borderRadius: 4, padding: 3, opacity: 0.78 }
            } : { enabled: false },
            markers: { size: markerSize, hover: { size: 5 } },
            noData: { text: 'No data available', style: { fontSize: '13px', color: '#626976' } }
          };
          try {
            if (el && el.setAttribute) el.setAttribute('data-kexo-grid', gridShow ? 'show' : 'hide');
          } catch (_) {}
          if (stacked) {
            apexOpts.chart.stacked = true;
            apexOpts.chart.stackType = 'normal';
          }
          try {
            var chartOverride = chartAdvancedOverrideFromUiConfig(chartId, chartType);
            if (chartOverride && isPlainObject(chartOverride) && Object.keys(chartOverride).length) {
              apexOpts = deepMergeOptions(apexOpts, chartOverride);
            }
          } catch (_) {}
          if (opts && opts.forceTooltip === true) {
            apexOpts.tooltip = Object.assign({}, apexOpts.tooltip || {}, {
              enabled: true,
              shared: true,
              intersect: false,
              followCursor: true
            });
          }

          return upsertDashboardApexChart(chartId, el, apexOpts, function(chart) {
            try { applyChangePinsOverlayToChart(chartId, chart, labels || []); } catch (_) {}
          });
        } catch (err) {
          captureChartError(err, 'dashboardChartRender', { chartId: chartId });
          return null;
        }
      }

      function destroyDashChart(chartId) {
        try {
          if (dashCharts && dashCharts[chartId] && typeof dashCharts[chartId].destroy === 'function') {
            dashCharts[chartId].destroy();
          }
        } catch (_) {}
        try { delete dashCharts[chartId]; } catch (_) {}
      }

      function normalizeOverviewMetric(v) {
        var n = (typeof v === 'number') ? v : Number(v);
        return Number.isFinite(n) ? n : 0;
      }

      var OVERVIEW_HEADER_GAP_PX = 8;
      var OVERVIEW_HEADER_FALLBACK_PX = 52;
      var OVERVIEW_MINI_FOOTER_FALLBACK_PX = 32;
      var OVERVIEW_MINI_EXTRA_BUFFER_PX = 10;
      function resolveOverviewChartHeight(chartEl, fallback, min, max) {
        var fb = Number(fallback);
        if (!Number.isFinite(fb) || fb <= 0) fb = 220;
        var lo = Number(min);
        if (!Number.isFinite(lo) || lo <= 0) lo = 120;
        var hi = Number(max);
        if (!Number.isFinite(hi) || hi <= 0) hi = 720;
        var h = 0;
        try {
          if (chartEl) {
            var ch = chartEl.clientHeight;
            if (Number.isFinite(ch) && ch > 0) h = ch;
            var rect = chartEl.getBoundingClientRect ? chartEl.getBoundingClientRect() : null;
            if (rect && Number.isFinite(rect.height) && rect.height > 0) h = rect.height;
            if (chartEl.parentElement) {
              var parent = chartEl.parentElement;
              var ph = parent.clientHeight;
              if (Number.isFinite(ph) && ph > 0) h = ph;
              var pRect = parent.getBoundingClientRect ? parent.getBoundingClientRect() : null;
              if (pRect && Number.isFinite(pRect.height) && pRect.height > 0) h = pRect.height;
              var card = parent.closest ? parent.closest('.kexo-overview-mini-card, .kexo-overview-main-card') : null;
              if (card && card.getBoundingClientRect) {
                var cardH = card.getBoundingClientRect().height;
                var isMini = false;
                try { isMini = !!(card.classList && card.classList.contains('kexo-overview-mini-card')); } catch (_) { isMini = false; }
                var headEl = card.querySelector ? card.querySelector('.kexo-overview-card-head') : null;
                var headerPx = OVERVIEW_HEADER_FALLBACK_PX;
                if (headEl && headEl.getBoundingClientRect) {
                  var headRect = headEl.getBoundingClientRect();
                  if (Number.isFinite(headRect.height) && headRect.height > 0) headerPx = headRect.height + OVERVIEW_HEADER_GAP_PX;
                }
                var totalsEl = card.querySelector ? card.querySelector('.kexo-overview-running-totals') : null;
                if (totalsEl && totalsEl.getBoundingClientRect && !(headEl && headEl.contains && headEl.contains(totalsEl))) {
                  var totalsRect = totalsEl.getBoundingClientRect();
                  if (Number.isFinite(totalsRect.height) && totalsRect.height > 0) {
                    headerPx += totalsRect.height + OVERVIEW_HEADER_GAP_PX;
                  }
                }
                if (isMini) {
                  try {
                    var lid = chartEl && chartEl.id ? String(chartEl.id) : '';
                    var footerPx = 0;
                    var legendEl = lid && card.querySelector ? card.querySelector('[data-overview-legend="' + lid + '"]') : null;
                    if (legendEl && legendEl.getBoundingClientRect) {
                      var legendRect = legendEl.getBoundingClientRect();
                      if (legendRect && Number.isFinite(legendRect.height) && legendRect.height > 0) {
                        footerPx += legendRect.height + OVERVIEW_HEADER_GAP_PX;
                      } else {
                        footerPx += OVERVIEW_MINI_FOOTER_FALLBACK_PX;
                      }
                    } else if (legendEl) {
                      footerPx += OVERVIEW_MINI_FOOTER_FALLBACK_PX;
                    }
                    var iconRowEl = card.querySelector ? card.querySelector('.dash-attribution-icon-row') : null;
                    if (iconRowEl && iconRowEl.getBoundingClientRect) {
                      var iconRect = iconRowEl.getBoundingClientRect();
                      if (iconRect && Number.isFinite(iconRect.height) && iconRect.height > 0) {
                        footerPx += iconRect.height + OVERVIEW_HEADER_GAP_PX;
                      }
                    }
                    if (footerPx > 0) headerPx += footerPx;
                  } catch (_) {}
                  headerPx += OVERVIEW_MINI_EXTRA_BUFFER_PX;
                }
                var minBuffer = Math.max(OVERVIEW_HEADER_FALLBACK_PX, headerPx);
                if (Number.isFinite(cardH) && cardH > minBuffer) {
                  var avail = cardH - headerPx;
                  if (avail > lo) h = avail;
                }
              }
            }
          }
        } catch (_) {}
        if (!Number.isFinite(h) || h <= 0) h = fb;
        h = Math.max(lo, Math.min(hi, h));
        var out = Math.round(h);
        return out;
      }

      function scaleHeightForChartSizePercent(chartId, height, min, max) {
        var h = Number(height);
        if (!Number.isFinite(h) || h <= 0) return height;
        try {
          if (typeof chartSizePercentFromUiConfig === 'function') {
            var pct = chartSizePercentFromUiConfig(chartId, 100);
            if (Number.isFinite(pct) && pct > 0 && pct !== 100) {
              h = Math.round(h * (pct / 100));
            }
          }
        } catch (_) {}
        if (Number.isFinite(min) && h < min) h = min;
        if (Number.isFinite(max) && h > max) h = max;
        return Math.round(h);
      }

      function overviewMiniChartIds() {
        return ['dash-chart-finishes-30d', 'dash-chart-devices-30d', 'dash-chart-attribution-30d', 'dash-chart-overview-30d'];
      }

      function clearOverviewHeightSyncStyles() {
        try {
          document.querySelectorAll('.kexo-overview-mini-row .kexo-overview-mini-card').forEach(function(card) {
            if (!card || !card.style) return;
            card.style.height = '';
            card.style.minHeight = '';
            card.style.maxHeight = '';
          });
        } catch (_) {}
        try {
          var mainCard = document.querySelector('[data-kexo-chart-key="dash-chart-overview-30d"] .kexo-overview-main-card');
          if (mainCard && mainCard.style) {
            mainCard.style.height = '';
            mainCard.style.minHeight = '';
          }
        } catch (_) {}
      }

      function syncOverviewHeightGrid() {
        var topGrid = document.getElementById('dash-kpi-grid');
        var midGrid = document.getElementById('dash-kpi-grid-mid');
        if (!topGrid) return;
        var desktop = false;
        try { desktop = !!(window && window.matchMedia && window.matchMedia('(min-width: 1200px)').matches); } catch (_) { desktop = false; }
        if (!desktop) {
          clearOverviewHeightSyncStyles();
          return;
        }
        var topHeight = 0;
        try {
          var topRect = topGrid.getBoundingClientRect ? topGrid.getBoundingClientRect() : null;
          if (topRect && Number.isFinite(topRect.height) && topRect.height > 0) topHeight = Math.max(0, Math.round(topRect.height) - 16);
        } catch (_) {}
        var midHeight = 0;
        try {
          if (midGrid && midGrid.getBoundingClientRect) {
            var midRect = midGrid.getBoundingClientRect();
            if (midRect && Number.isFinite(midRect.height) && midRect.height > 0) midHeight = Math.max(0, Math.round(midRect.height) - 16);
          }
        } catch (_) {}
        var miniHeight = midHeight > 0 ? midHeight : topHeight;
        if (miniHeight > 0) {
          try {
            document.querySelectorAll('.kexo-overview-mini-row .kexo-overview-mini-card').forEach(function(card) {
              if (!card || !card.style) return;
              card.style.height = String(miniHeight) + 'px';
              card.style.minHeight = String(miniHeight) + 'px';
              card.style.maxHeight = String(miniHeight) + 'px';
            });
          } catch (_) {}
        }
        var mainHeight = topHeight > 0 ? topHeight : midHeight;
        if (mainHeight > 0) {
          try {
            var mainCard = document.querySelector('[data-kexo-chart-key="dash-chart-overview-30d"] .kexo-overview-main-card');
            if (mainCard && mainCard.style) {
              mainCard.style.height = String(mainHeight) + 'px';
              mainCard.style.minHeight = String(mainHeight) + 'px';
            }
          } catch (_) {}
        }
        if (mainHeight > 0 || miniHeight > 0) {
          try {
            overviewMiniChartIds().forEach(function(chartId) {
              var chart = dashCharts && dashCharts[chartId];
              if (!chart || typeof chart.updateOptions !== 'function') return;
              var chartEl = document.getElementById(chartId);
              if (!chartEl) return;
              var h = resolveOverviewChartHeight(chartEl, 180, 120, 440);
              h = scaleHeightForChartSizePercent(chartId, h, 120, 440);
              if (h > 0) chart.updateOptions({ chart: { height: h } }, false, false, false);
            });
          } catch (_) {}
        }
      }

      function scheduleOverviewHeightSync() {
        if (overviewHeightSyncTimer) {
          try { clearTimeout(overviewHeightSyncTimer); } catch (_) {}
        }
        overviewHeightSyncTimer = setTimeout(function() {
          overviewHeightSyncTimer = null;
          var raf = typeof requestAnimationFrame === 'function' ? requestAnimationFrame : function(f) { f(); };
          raf(function() {
            syncOverviewHeightGrid();
          });
          // Do not re-render charts here (ResizeObserver feedback loop).
        }, 80);
      }

      function ensureOverviewHeightSyncObserver() {
        if (overviewHeightSyncObserver || typeof ResizeObserver === 'undefined') return;
        overviewHeightSyncObserver = new ResizeObserver(function() {
          if (document.visibilityState === 'hidden') return;
          scheduleOverviewHeightSync();
        });
        try {
          var topGrid = document.getElementById('dash-kpi-grid');
          var midGrid = document.getElementById('dash-kpi-grid-mid');
          overviewHeightSyncObservedElements = [];
          if (topGrid) { overviewHeightSyncObserver.observe(topGrid); overviewHeightSyncObservedElements.push(topGrid); }
          if (midGrid) { overviewHeightSyncObserver.observe(midGrid); overviewHeightSyncObservedElements.push(midGrid); }
        } catch (_) {}
        try {
          window.addEventListener('resize', scheduleOverviewHeightSync);
        } catch (_) {}
      }
      function pauseOverviewResizeObservers() {
        try {
          if (overviewHeightSyncObserver && typeof overviewHeightSyncObserver.disconnect === 'function') overviewHeightSyncObserver.disconnect();
          if (overviewMiniResizeObserver && typeof overviewMiniResizeObserver.disconnect === 'function') overviewMiniResizeObserver.disconnect();
        } catch (_) {}
      }
      function resumeOverviewResizeObservers() {
        try {
          if (overviewHeightSyncObserver && overviewHeightSyncObservedElements.length) {
            overviewHeightSyncObservedElements.forEach(function(el) { if (el && el.isConnected) overviewHeightSyncObserver.observe(el); });
          }
          if (overviewMiniResizeObserver && overviewMiniResizeObservedElements.length) {
            overviewMiniResizeObservedElements.forEach(function(el) { if (el && el.isConnected) overviewMiniResizeObserver.observe(el); });
          }
        } catch (_) {}
      }

      function setOverviewMiniCardValue(id, text) {
        var target = document.getElementById(id);
        if (!target) return;
        target.textContent = text != null && String(text).trim() ? String(text) : '\u2014';
      }

      function setOverviewMiniDelta(prefix, cur, prev, opts) {
        var o = opts && typeof opts === 'object' ? opts : {};
        var invert = !!o.invert;
        var wrap = document.getElementById(prefix + '-delta');
        var textEl = document.getElementById(prefix + '-delta-text');
        if (!wrap || !textEl) return;

        var c = (typeof cur === 'number') ? cur : Number(cur);
        var p = (typeof prev === 'number') ? prev : Number(prev);
        if (!Number.isFinite(c) || !Number.isFinite(p) || Math.abs(p) < 1e-9) {
          wrap.classList.add('is-hidden');
          wrap.classList.remove('is-up', 'is-down', 'is-flat');
          wrap.setAttribute('data-dir', 'none');
          textEl.textContent = '\u2014';
          return;
        }

        var ratio = (c - p) / Math.abs(p);
        if (invert) ratio = -ratio;
        var rounded = Math.round(ratio * 1000) / 10; // 1dp
        var sign = rounded > 0 ? '+' : '';
        var text = sign + rounded.toFixed(1) + '%';

        var dir = 'flat';
        if (rounded > 0.05) dir = 'up';
        else if (rounded < -0.05) dir = 'down';

        wrap.classList.remove('is-hidden');
        wrap.classList.remove('is-up', 'is-down', 'is-flat');
        if (dir === 'up') wrap.classList.add('is-up');
        else if (dir === 'down') wrap.classList.add('is-down');
        else wrap.classList.add('is-flat');
        wrap.setAttribute('data-dir', dir);
        textEl.textContent = text;
      }

      function renderOverviewMiniCardStats(context) {
        var ctx = context && typeof context === 'object' ? context : {};
        function moneyText(value) {
          if (typeof formatRevenue0 === 'function') return formatRevenue0(normalizeOverviewMetric(value)) || '\u2014';
          return fmtGbp(normalizeOverviewMetric(value));
        }

        // Revenue cards should use a single truth total for the period (not “top N” sums),
        // otherwise the headline number won’t reconcile with the rest of the dashboard.
        var revNow = normalizeOverviewMetric(ctx.revenueNow);
        var revPrev = normalizeOverviewMetric(ctx.revenuePrev);
        var attrRevNow = normalizeOverviewMetric(ctx.attributionRevenueNow);
        var attrRevPrev = normalizeOverviewMetric(ctx.attributionRevenuePrev);

        setOverviewMiniCardValue('dash-mini-finishes-value', moneyText(revNow));
        setOverviewMiniCardValue('dash-mini-countries-value', moneyText(revNow));
        setOverviewMiniCardValue('dash-mini-attribution-value', moneyText(attrRevNow));

        setOverviewMiniDelta('dash-mini-finishes', revNow, revPrev);
        setOverviewMiniDelta('dash-mini-countries', revNow, revPrev);
        setOverviewMiniDelta('dash-mini-attribution', attrRevNow, attrRevPrev);
      }

      function quantizeOverviewMiniSize(value) {
        var n = Number(value);
        if (!Number.isFinite(n) || n <= 0) return 0;
        // Bucket to 16px to avoid ResizeObserver feedback loops and micro-resize rerenders.
        return Math.round(n / 16) * 16;
      }

      function overviewMiniPayloadSig(payload) {
        try { return JSON.stringify(payload || null) || ''; } catch (_) { return ''; }
      }

      function overviewMiniStyleSig() {
        try {
          if (typeof chartStyleFromUiConfig !== 'function') return '';
          function miniChartCfg(key, fallbackMode, fallbackColors) {
            return {
              enabled: (typeof isChartEnabledByUiConfig === 'function') ? isChartEnabledByUiConfig(key, true) : true,
              mode: (typeof chartModeFromUiConfig === 'function') ? chartModeFromUiConfig(key, fallbackMode) : fallbackMode,
              colors: (typeof chartColorsFromUiConfig === 'function') ? chartColorsFromUiConfig(key, fallbackColors || []) : (fallbackColors || []),
              style: chartStyleFromUiConfig(key) || {},
            };
          }
          return JSON.stringify({
            finishes: miniChartCfg('dash-chart-finishes-30d', 'radialbar', ['#f59e34']),
            devices: miniChartCfg('dash-chart-devices-30d', 'bar-horizontal', ['#4b94e4']),
            attribution: miniChartCfg('dash-chart-attribution-30d', 'donut', ['#4b94e4']),
            overview: miniChartCfg('dash-chart-overview-30d', 'bar', ['#3eb3ab', '#ef4444']),
          }) || '';
        } catch (_) {
          return '';
        }
      }

      function computeOverviewMiniSizeSignature() {
        var ids = overviewMiniChartIds();
        return ids.map(function(id) {
          var el = document.getElementById(id);
          if (!el || !el.getBoundingClientRect) return id + ':0x0';
          var r = el.getBoundingClientRect();
          var w = quantizeOverviewMiniSize(r.width);
          // Deliberately ignore height here. Height can be content-driven (SVG rendering) and
          // cause ResizeObserver feedback loops. Width changes are the meaningful signal for
          // re-rendering these charts.
          return id + ':' + w;
        }).join('|');
      }

      function scheduleOverviewMiniResizeRender() {
        if (overviewMiniResizeScheduled) return;
        overviewMiniResizeScheduled = true;
        if (overviewMiniResizeTimer) {
          try { clearTimeout(overviewMiniResizeTimer); } catch (_) {}
          overviewMiniResizeTimer = null;
        }
        overviewMiniResizeTimer = setTimeout(function() {
          overviewMiniResizeTimer = null;
          overviewMiniResizeScheduled = false;
          if (!overviewCardCache || !Object.keys(overviewCardCache).length) return;
          var sig = computeOverviewMiniSizeSignature();
          if (sig && sig === overviewMiniSizeSignature) return;
          overviewMiniSizeSignature = sig;
          rerenderOverviewCardsFromCache({ reason: 'resize' });
        }, 500);
      }

      function ensureOverviewMiniResizeObserver() {
        if (overviewMiniResizeObserver || typeof ResizeObserver === 'undefined') return;
        ensureOverviewHeightSyncObserver();
        overviewMiniResizeObserver = new ResizeObserver(function() {
          if (document.visibilityState === 'hidden') return;
          scheduleOverviewMiniResizeRender();
        });
        overviewMiniResizeObservedElements = [];
        overviewMiniChartIds().forEach(function(id) {
          var el = document.getElementById(id);
          if (el) { overviewMiniResizeObserver.observe(el); overviewMiniResizeObservedElements.push(el); }
        });
      }

      registerCleanup(function() {
        try {
          if (overviewMiniResizeObserver && typeof overviewMiniResizeObserver.disconnect === 'function') {
            overviewMiniResizeObserver.disconnect();
          }
        } catch (_) {}
        try {
          if (overviewMiniResizeTimer) clearTimeout(overviewMiniResizeTimer);
        } catch (_) {}
        try {
          if (overviewHeightSyncObserver && typeof overviewHeightSyncObserver.disconnect === 'function') {
            overviewHeightSyncObserver.disconnect();
          }
        } catch (_) {}
        try {
          if (overviewLazyObserver && typeof overviewLazyObserver.disconnect === 'function') {
            overviewLazyObserver.disconnect();
          }
        } catch (_) {}
        try {
          if (overviewHeightSyncTimer) clearTimeout(overviewHeightSyncTimer);
        } catch (_) {}
        try {
          window.removeEventListener('resize', scheduleOverviewHeightSync);
        } catch (_) {}
        overviewMiniResizeTimer = null;
        overviewMiniResizeObserver = null;
        overviewHeightSyncObserver = null;
        overviewHeightSyncTimer = null;
        overviewMiniResizeScheduled = false;
        overviewMiniSizeSignature = '';
        overviewMiniCacheShopKey = '';
        overviewMiniPayloadSignature = '';
        dashPayloadSignature = '';
        overviewMiniCache = null;
        overviewMiniFetchedAt = 0;
        overviewMiniInFlight = null;
        overviewCardCache = {};
        overviewCardInFlight = {};
        overviewCardPayloadSignature = {};
        overviewLazyObserver = null;
        overviewLazyPending = {};
        overviewLazyVisible = {};
        clearOverviewHeightSyncStyles();
        try {
          Object.keys(dashSparkCharts || {}).forEach(function (id) {
            var chart = dashSparkCharts[id];
            if (chart && typeof chart.destroy === 'function') chart.destroy();
          });
        } catch (_) {}
        dashSparkCharts = {};
        try {
          overviewMiniChartIds().forEach(function (chartId) {
            destroyDashChart(chartId);
          });
        } catch (_) {}
      });

      function renderOverviewChartEmpty(chartId, text) {
        var chartEl = document.getElementById(chartId);
        if (!chartEl) return;
        if (!isChartEnabledByUiConfig(chartId)) {
          destroyDashChart(chartId);
          chartEl.innerHTML = '';
          if (String(chartId || '') === 'dash-chart-overview-30d') {
            setOverviewSalesRunningTotals(null, null, null);
            setOverviewCostBreakdownTooltip(null);
          }
          return;
        }
        destroyDashChart(chartId);
        chartEl.innerHTML = '<div class="kexo-overview-chart-empty">' + escapeHtml(text || 'No data available') + '</div>';
        if (String(chartId || '') === 'dash-chart-overview-30d') {
          setOverviewSalesRunningTotals(null, null, null);
          setOverviewCostBreakdownTooltip(null);
        }
      }

      function renderOverviewChartLoading(chartId, text) {
        var chartEl = document.getElementById(chartId);
        if (!chartEl) return;
        if (!isChartEnabledByUiConfig(chartId)) {
          destroyDashChart(chartId);
          chartEl.innerHTML = '';
          if (String(chartId || '') === 'dash-chart-overview-30d') {
            setOverviewSalesRunningTotals(null, null, null);
            setOverviewCostBreakdownTooltip(null);
          }
          return;
        }
        destroyDashChart(chartId);
        chartEl.innerHTML = '<div class="kexo-overview-chart-empty is-loading"><span class="kpi-mini-spinner" aria-hidden="true"></span><span>' + escapeHtml(text || 'Loading...') + '</span></div>';
        if (String(chartId || '') === 'dash-chart-overview-30d') {
          setOverviewSalesRunningTotals(null, null, null);
          setOverviewCostBreakdownTooltip(null);
        }
      }

      function showOverviewMiniLoadingState() {
        setOverviewMiniCardValue('dash-mini-finishes-value', '\u2014');
        setOverviewMiniCardValue('dash-mini-countries-value', '\u2014');
        setOverviewMiniCardValue('dash-mini-attribution-value', '\u2014');
        renderOverviewChartLoading('dash-chart-finishes-30d', 'Loading finishes...');
        renderOverviewChartLoading('dash-chart-devices-30d', 'Loading devices...');
        renderOverviewChartLoading('dash-chart-attribution-30d', 'Loading attribution...');
        renderOverviewChartLoading('dash-chart-overview-30d', 'Loading 7 day overview...');
      }

      function countryCodeToFlagEmoji(rawCode) {
        var code = rawCode == null ? '' : String(rawCode).trim().toUpperCase();
        if (code === 'UK') code = 'GB';
        if (!/^[A-Z]{2}$/.test(code)) return '';
        var A = 0x1f1e6;
        return String.fromCodePoint(A + (code.charCodeAt(0) - 65), A + (code.charCodeAt(1) - 65));
      }
      function countryCodeToFlagHtml(rawCode) {
        var code = rawCode == null ? '' : String(rawCode).trim().toUpperCase().slice(0, 2);
        if (code === 'UK') code = 'GB';
        if (!/^[A-Z]{2}$/.test(code)) {
          return '<span class="kexo-flag-fallback" aria-hidden="true" style="display:inline-flex;align-items:center;margin-right:4px;opacity:.8"><i class="fa-light fa-globe"></i></span>';
        }
        var raw = code.toLowerCase();
        return '<span class="flag flag-xs flag-country-' + escapeHtml(raw) + '" style="vertical-align:middle;margin-right:4px;" aria-hidden="true"></span>';
      }

      function countryCodeFromRow(row) {
        if (!row || typeof row !== 'object') return '';
        var preferred = row.country_code != null ? String(row.country_code) : '';
        var fallback = row.country != null ? String(row.country) : '';
        var cc = (preferred || fallback).trim().toUpperCase().slice(0, 2);
        if (cc === 'UK') cc = 'GB';
        return /^[A-Z]{2}$/.test(cc) ? cc : '';
      }

      function renderOverviewPieChart(chartId, labels, values, opts) {
        var chartEl = document.getElementById(chartId);
        if (!chartEl || typeof ApexCharts === 'undefined') return;
        if (!isChartEnabledByUiConfig(chartId)) {
          destroyDashChart(chartId);
          chartEl.innerHTML = '';
          return;
        }
        var safeLabels = [];
        var safeValues = [];
        var srcLabels = Array.isArray(labels) ? labels : [];
        var srcValues = Array.isArray(values) ? values : [];
        for (var i = 0; i < srcLabels.length; i++) {
          var label = srcLabels[i] != null ? String(srcLabels[i]).trim() : '';
          var n = normalizeOverviewMetric(srcValues[i]);
          if (!label || n <= 0) continue;
          safeLabels.push(label);
          safeValues.push(n);
        }
        safeLabels = sanitizeChartConfig(safeLabels, [{ label: 'Value', data: safeValues }]).labels;
        if (!safeValues.length) {
          renderOverviewChartLoading(chartId, 'Loading chart...');
          return;
        }
        var uiStyle = (typeof chartStyleFromUiConfig === 'function') ? chartStyleFromUiConfig(chartId) : null;
        if (!uiStyle || typeof uiStyle !== 'object') uiStyle = {};
        var fallbackColors = (opts && Array.isArray(opts.colors) && opts.colors.length)
          ? opts.colors
          : [DASH_ACCENT, DASH_BLUE, DASH_ORANGE, DASH_PURPLE, '#ef4444'];
        var colors = chartColorsFromUiConfig(chartId, fallbackColors);
        var valueFormatter = (opts && typeof opts.valueFormatter === 'function')
          ? opts.valueFormatter
          : function(v) { return fmtGbp(normalizeOverviewMetric(v)) || '\u2014'; };
        var donut = (opts && typeof opts.donut === 'boolean')
          ? !!opts.donut
          : !!uiStyle.pieDonut;
        var chartType = donut ? 'donut' : 'pie';
        var pieLabelPosition = (opts && opts.pieLabelPosition != null)
          ? String(opts.pieLabelPosition).trim().toLowerCase()
          : String(uiStyle.pieLabelPosition || 'auto').trim().toLowerCase();
        if (pieLabelPosition !== 'outside' && pieLabelPosition !== 'inside' && pieLabelPosition !== 'auto') pieLabelPosition = 'auto';
        var pieLabelContent = (opts && opts.pieLabelContent != null)
          ? String(opts.pieLabelContent).trim().toLowerCase()
          : String(uiStyle.pieLabelContent || 'percent').trim().toLowerCase();
        if (pieLabelContent !== 'label' && pieLabelContent !== 'label_percent' && pieLabelContent !== 'percent') pieLabelContent = 'percent';
        var pieLabelOffset = Number((opts && opts.pieLabelOffset != null) ? opts.pieLabelOffset : uiStyle.pieLabelOffset);
        if (!Number.isFinite(pieLabelOffset)) pieLabelOffset = 16;
        pieLabelOffset = Math.round(Math.max(-40, Math.min(40, pieLabelOffset)));
        if (pieLabelPosition === 'outside') pieLabelOffset = Math.max(6, pieLabelOffset);
        if (pieLabelPosition === 'inside') pieLabelOffset = Math.min(0, pieLabelOffset);
        var pieStartAngle = Number(opts && opts.pieStartAngle != null ? opts.pieStartAngle : NaN);
        var pieEndAngle = Number(opts && opts.pieEndAngle != null ? opts.pieEndAngle : NaN);
        var showLegend = (opts && typeof opts.showLegend === 'boolean')
          ? !!opts.showLegend
          : (pieLabelPosition !== 'outside');
        var labelFormatter = (opts && typeof opts.labelFormatter === 'function') ? opts.labelFormatter : null;
        var countryCodesForPie = (opts && Array.isArray(opts.countryCodes) && opts.countryCodes.length === safeLabels.length) ? opts.countryCodes : null;
        var dataLabelsEnabled = (opts && opts.dataLabels === false)
          ? false
          : (uiStyle.dataLabels !== 'off');
        var chartHeight = resolveOverviewChartHeight(
          chartEl,
          (opts && Number.isFinite(Number(opts.height))) ? Number(opts.height) : 180,
          120,
          440
        );
        try {
          if (typeof chartSizePercentFromUiConfig === 'function') {
            var pct = chartSizePercentFromUiConfig(chartId, 100);
            if (Number.isFinite(pct) && pct > 0 && pct !== 100) {
              chartHeight = Math.round(chartHeight * (pct / 100));
              if (chartHeight < 120) chartHeight = 120;
              if (chartHeight > 440) chartHeight = 440;
            }
          }
        } catch (_) {}
        var apexOpts = {
          chart: {
            type: chartType,
            height: chartHeight,
            fontFamily: 'Inter, sans-serif',
            toolbar: { show: !!(uiStyle && uiStyle.toolbar === true) },
            animations: { enabled: uiStyle.animations === true, easing: 'easeinout', speed: 280 },
            zoom: { enabled: false }
          },
          series: safeValues,
          labels: safeLabels,
          colors: colors,
          legend: { show: showLegend, position: 'bottom', fontSize: '11px' },
          fill: { opacity: (uiStyle && Number.isFinite(Number(uiStyle.fillOpacity))) ? Math.max(0, Math.min(1, Number(uiStyle.fillOpacity))) : 1 },
          stroke: { show: true, width: 1, colors: ['#fff'] },
          dataLabels: {
            enabled: dataLabelsEnabled,
            formatter: function(val, ctx) {
              var pct = normalizeOverviewMetric(val);
              var idx = ctx && Number.isFinite(ctx.seriesIndex) ? ctx.seriesIndex : -1;
              var seriesLabel = (idx >= 0 && idx < safeLabels.length) ? safeLabels[idx] : '';
              if (countryCodesForPie && idx >= 0 && idx < countryCodesForPie.length) {
                var flag = (typeof countryCodeToFlagEmoji === 'function') ? countryCodeToFlagEmoji(countryCodesForPie[idx]) : '';
                var pctText = pct ? pct.toFixed(0) + '%' : '';
                if (pieLabelContent === 'label') return flag || seriesLabel || pctText;
                if (pieLabelContent === 'label_percent') return (flag ? flag + ' ' : '') + (pctText || seriesLabel);
                return (flag ? flag + ' ' : '') + pctText;
              }
              if (labelFormatter) {
                var custom = labelFormatter(pct, seriesLabel, idx, safeValues[idx]);
                if (custom != null) return String(custom);
              }
              var pctText = pct ? pct.toFixed(0) + '%' : '';
              if (pieLabelContent === 'label') return seriesLabel || pctText;
              if (pieLabelContent === 'label_percent') {
                if (seriesLabel && pctText) return seriesLabel + ' ' + pctText;
                return seriesLabel || pctText;
              }
              return pctText;
            },
            style: {
              fontSize: '11px',
              fontWeight: 500,
              colors: pieLabelPosition !== 'inside' ? ['#000'] : undefined
            },
            dropShadow: { enabled: false }
          },
          plotOptions: { pie: { dataLabels: { offset: pieLabelOffset, minAngleToShowLabel: 8 }, expandOnClick: false } },
          tooltip: { enabled: true, y: { formatter: valueFormatter } },
          noData: { text: 'No data available', style: { fontSize: '13px', color: '#626976' } }
        };
        if (Number.isFinite(pieStartAngle)) apexOpts.plotOptions.pie.startAngle = pieStartAngle;
        if (Number.isFinite(pieEndAngle)) apexOpts.plotOptions.pie.endAngle = pieEndAngle;
        if (chartType === 'donut') {
          var donutSize = Number(uiStyle.pieDonutSize);
          if (!Number.isFinite(donutSize)) donutSize = 66;
          donutSize = Math.round(Math.max(30, Math.min(90, donutSize)));
          apexOpts.plotOptions.pie.donut = { size: donutSize + '%' };
        }
        try {
          var chartOverride = chartAdvancedOverrideFromUiConfig(chartId, 'pie');
          if (chartOverride && isPlainObject(chartOverride) && Object.keys(chartOverride).length) {
            apexOpts = deepMergeOptions(apexOpts, chartOverride);
          }
        } catch (_) {}
        try {
          var afterRender = (opts && typeof opts.afterRender === 'function') ? opts.afterRender : null;
          upsertDashboardApexChart(
            chartId,
            chartEl,
            apexOpts,
            afterRender
              ? function(chart) {
                try { afterRender(chart, { chartEl: chartEl, labels: safeLabels, values: safeValues, chartType: chartType }); } catch (_) {}
              }
              : null
          );
        } catch (err) {
          captureChartError(err, 'dashboardPieChartRender', { chartId: chartId });
          console.error('[dashboard] pie chart render error:', chartId, err);
        }
      }

      function renderOverviewFinishesRadialBar(chartId, labels, values, opts) {
        var chartEl = document.getElementById(chartId);
        if (!chartEl || typeof ApexCharts === 'undefined') return;
        if (!isChartEnabledByUiConfig(chartId)) {
          destroyDashChart(chartId);
          chartEl.innerHTML = '';
          return;
        }
        var total = 0;
        for (var i = 0; i < values.length; i++) total += normalizeOverviewMetric(values[i]);
        var series = [];
        for (var j = 0; j < values.length; j++) {
          var v = normalizeOverviewMetric(values[j]);
          series.push(total > 0 ? (v / total) * 100 : 0);
        }
        labels = sanitizeChartConfig(labels, [{ label: 'Share', data: series }]).labels;
        var fallbackColors = (opts && Array.isArray(opts.colors) && opts.colors.length) ? opts.colors : ['#f59e34', '#94a3b8', '#8b5cf6', '#4b94e4', '#3eb3ab'];
        var colors = (typeof chartColorsFromUiConfig === 'function') ? chartColorsFromUiConfig(chartId, fallbackColors) : fallbackColors;
        var chartHeight = resolveOverviewChartHeight(chartEl, (opts && Number.isFinite(Number(opts.height))) ? Number(opts.height) : 180, 120, 440);
        chartHeight = scaleHeightForChartSizePercent(chartId, chartHeight, 120, 440);
        var uiStyle = (typeof chartStyleFromUiConfig === 'function') ? chartStyleFromUiConfig(chartId) : null;
        var labelsRef = labels;
        var valuesRef = values;
        var defaultIdx = 0;
        try {
          var bestRev = -Infinity;
          for (var k = 0; k < valuesRef.length; k++) {
            var rv = normalizeOverviewMetric(valuesRef[k]);
            if (rv > bestRev) { bestRev = rv; defaultIdx = k; }
          }
        } catch (_) { defaultIdx = 0; }
        try {
          chartEl.__kexoFinishesRadialCenter = {
            enabled: !(uiStyle && uiStyle.radialCenterLabel === false),
            defaultIdx: defaultIdx,
            labels: labelsRef,
            values: valuesRef,
          };
        } catch (_) {}
        function syncFinishesRadialCenterLabel(selectedIdx) {
          var st = null;
          try { st = chartEl && chartEl.__kexoFinishesRadialCenter ? chartEl.__kexoFinishesRadialCenter : null; } catch (_) { st = null; }
          if (!chartEl || !st || st.enabled !== true) {
            try {
              var existing = chartEl ? chartEl.querySelector('.kexo-radial-center-label-wrap') : null;
              if (existing) existing.remove();
            } catch (_) {}
            return;
          }
          var idx = Number.isFinite(Number(selectedIdx)) ? Number(selectedIdx) : st.defaultIdx;
          if (idx < 0 || idx >= st.labels.length) idx = st.defaultIdx;
          var name = (idx >= 0 && idx < st.labels.length) ? st.labels[idx] : '';
          var rev = (idx >= 0 && idx < st.values.length) ? st.values[idx] : 0;
          var revStr = fmtGbp(normalizeOverviewMetric(rev)) || '\u2014';
          try { if (chartEl && chartEl.style) chartEl.style.position = 'relative'; } catch (_) {}
          var el = null;
          try { el = chartEl.querySelector('.kexo-radial-center-label-wrap'); } catch (_) { el = null; }
          if (!el) {
            el = document.createElement('div');
            el.className = 'kexo-radial-center-label-wrap';
            el.setAttribute('aria-hidden', 'true');
            chartEl.appendChild(el);
          }
          el.innerHTML = '<div class="kexo-radial-center-label">' + escapeHtml(name || '') + '</div>' +
            '<div class="kexo-radial-center-value">' + escapeHtml(revStr) + '</div>';
        }
        var apexOpts = {
          chart: {
            type: 'radialBar',
            height: chartHeight,
            fontFamily: 'Inter, sans-serif',
            toolbar: { show: !!(uiStyle && uiStyle.toolbar === true) },
            animations: { enabled: !!(uiStyle && uiStyle.animations === true), easing: 'easeinout', speed: 280 },
            events: {
              mounted: function() { try { syncFinishesRadialCenterLabel(defaultIdx); } catch (_) {} },
              updated: function() { try { syncFinishesRadialCenterLabel(defaultIdx); } catch (_) {} },
              dataPointMouseEnter: function(event, chartCtx, config) {
                try {
                  var idx = config && Number.isFinite(Number(config.seriesIndex)) ? Number(config.seriesIndex) : -1;
                  if (idx >= 0) syncFinishesRadialCenterLabel(idx);
                } catch (_) {}
              },
              dataPointMouseLeave: function() { try { syncFinishesRadialCenterLabel(defaultIdx); } catch (_) {} }
            }
          },
          plotOptions: {
            radialBar: {
              startAngle: -135,
              endAngle: 135,
              hollow: { size: '58%' },
              track: { background: 'rgba(0,0,0,0.06)' },
              dataLabels: {
                name: { show: false },
                value: { show: false },
                total: { show: false },
              }
            }
          },
          series: series,
          labels: labels,
          colors: colors,
          legend: { show: !!(opts && opts.showLegend), position: 'bottom', fontSize: '11px', labels: { colors: undefined } },
          fill: { opacity: (uiStyle && Number.isFinite(Number(uiStyle.fillOpacity))) ? Math.max(0, Math.min(1, Number(uiStyle.fillOpacity))) : 1 },
          tooltip: {
            enabled: true,
            custom: function(ctx) {
              var idx = ctx && Number.isFinite(ctx.seriesIndex) ? ctx.seriesIndex : -1;
              var name = (idx >= 0 && idx < labelsRef.length) ? labelsRef[idx] : '';
              var rev = (idx >= 0 && idx < valuesRef.length) ? valuesRef[idx] : 0;
              var pct = (ctx && Array.isArray(ctx.series) && idx >= 0 && idx < ctx.series.length) ? Number(ctx.series[idx]) : null;
              var pctStr = (pct != null && Number.isFinite(pct)) ? pct.toFixed(1) + '%' : '\u2014';
              try { if (idx >= 0) syncFinishesRadialCenterLabel(idx); } catch (_) {}
              return '<div class="kexo-tooltip-card p-2"><div class="fw-semibold">' + escapeHtml(name || '') + '</div><div>Revenue: ' + escapeHtml(fmtGbp(normalizeOverviewMetric(rev)) || '\u2014') + '</div><div>Share: ' + escapeHtml(pctStr) + '</div></div>';
            }
          },
          states: { normal: { filter: { type: 'none', value: 0 } }, hover: { filter: { type: 'none', value: 0 } }, active: { filter: { type: 'none', value: 0 } } },
          noData: { text: 'No data available', style: { fontSize: '13px', color: '#626976' } }
        };
        try {
          var chartOverride = (typeof chartAdvancedOverrideFromUiConfig === 'function') ? chartAdvancedOverrideFromUiConfig(chartId, 'radialbar') : null;
          if (chartOverride && isPlainObject(chartOverride) && Object.keys(chartOverride).length) {
            apexOpts = deepMergeOptions(apexOpts, chartOverride);
          }
        } catch (_) {}
        try {
          upsertDashboardApexChart(chartId, chartEl, apexOpts, function() {
            try { syncFinishesRadialCenterLabel(defaultIdx); } catch (_) {}
          });
          try {
            if (chartEl && !chartEl.__kexoRadialCenterLeaveBound) {
              chartEl.__kexoRadialCenterLeaveBound = true;
              chartEl.addEventListener('mouseleave', function () {
                try {
                  var st = chartEl && chartEl.__kexoFinishesRadialCenter ? chartEl.__kexoFinishesRadialCenter : null;
                  var idx = st && Number.isFinite(Number(st.defaultIdx)) ? Number(st.defaultIdx) : 0;
                  syncFinishesRadialCenterLabel(idx);
                } catch (_) {}
              });
            }
          } catch (_) {}
        } catch (err) {
          captureChartError(err, 'dashboardRadialBarRender', { chartId: chartId });
          console.error('[dashboard] radialBar chart render error:', chartId, err);
        }
      }

      function renderOverviewFinishesBarChart(chartId, labels, values, opts) {
        var chartEl = document.getElementById(chartId);
        if (!chartEl || typeof ApexCharts === 'undefined') return;
        if (!isChartEnabledByUiConfig(chartId)) {
          destroyDashChart(chartId);
          chartEl.innerHTML = '';
          return;
        }
        var fallbackColors = (opts && Array.isArray(opts.colors) && opts.colors.length) ? opts.colors : ['#f59e34', '#94a3b8', '#8b5cf6', '#4b94e4', '#3eb3ab'];
        var colors = (typeof chartColorsFromUiConfig === 'function') ? chartColorsFromUiConfig(chartId, fallbackColors) : fallbackColors;
        var chartHeight = resolveOverviewChartHeight(chartEl, (opts && Number.isFinite(Number(opts.height))) ? Number(opts.height) : 180, 120, 440);
        chartHeight = scaleHeightForChartSizePercent(chartId, chartHeight, 120, 440);
        var uiStyle = (typeof chartStyleFromUiConfig === 'function') ? chartStyleFromUiConfig(chartId) : null;
        var horizontal = opts && opts.horizontal !== false;
        var apexOpts = {
          chart: { type: 'bar', height: chartHeight, fontFamily: 'Inter, sans-serif', toolbar: { show: false }, animations: { enabled: !!(uiStyle && uiStyle.animations === true) } },
          plotOptions: { bar: { horizontal: horizontal, borderRadius: 0, distributed: true, barHeight: horizontal ? '60%' : '70%' } },
          series: [{ name: 'Revenue', data: values.map(function(v) { return normalizeOverviewMetric(v); }) }],
          xaxis: { categories: labels, labels: { show: horizontal ? false : true } },
          yaxis: horizontal ? { labels: { show: true, style: { fontSize: '12px', fontWeight: 500, colors: '#090f17' } } } : { labels: { show: false } },
          grid: { padding: { bottom: 12, left: 12, right: 8, top: 4 } },
          colors: colors,
          legend: { show: false },
          dataLabels: { enabled: false },
          fill: { opacity: (uiStyle && Number.isFinite(Number(uiStyle.fillOpacity))) ? Math.max(0, Math.min(1, Number(uiStyle.fillOpacity))) : 1 },
          tooltip: { enabled: true, y: { formatter: function(v) { return fmtGbp(normalizeOverviewMetric(v)) || '\u2014'; } } },
          noData: { text: 'No data available', style: { fontSize: '13px', color: '#626976' } }
        };
        try {
          var chartOverride = (typeof chartAdvancedOverrideFromUiConfig === 'function') ? chartAdvancedOverrideFromUiConfig(chartId, 'bar') : null;
          if (chartOverride && isPlainObject(chartOverride) && Object.keys(chartOverride).length) apexOpts = deepMergeOptions(apexOpts, chartOverride);
        } catch (_) {}
        if (horizontal) {
          apexOpts.xaxis = apexOpts.xaxis || {};
          apexOpts.xaxis.labels = apexOpts.xaxis.labels || {};
          apexOpts.xaxis.labels.show = false;
        }
        try {
          upsertDashboardApexChart(chartId, chartEl, apexOpts);
        } catch (err) {
          captureChartError(err, 'dashboardFinishesBarRender', { chartId: chartId });
        }
      }

      function renderOverviewCountriesHorizontalBar(chartId, rows, opts) {
        var chartEl = document.getElementById(chartId);
        if (!chartEl || typeof ApexCharts === 'undefined') return;
        if (!isChartEnabledByUiConfig(chartId)) {
          destroyDashChart(chartId);
          chartEl.innerHTML = '';
          return;
        }
        var uiStyle = (typeof chartStyleFromUiConfig === 'function') ? chartStyleFromUiConfig(chartId) : null;
        var categories = [];
        var values = [];
        var names = [];
        var countryCodes = [];
        var crPcts = [];
        var showFlags = !!(uiStyle && uiStyle.pieCountryFlags);
        var horizontal = opts && opts.horizontal !== false;
        rows.forEach(function(row) {
          var cc = countryCodeFromRow(row);
          if (!cc) {
            var raw = row && row.country != null ? String(row.country).trim() : '';
            cc = raw ? raw.toUpperCase().slice(0, 2) : '';
            if (cc === 'UK') cc = 'GB';
            if (!/^[A-Z]{2}$/.test(cc)) return;
          }
          var emoji = showFlags ? countryCodeToFlagEmoji(cc) : '';
          var name = (typeof countryLabelFull === 'function') ? countryLabelFull(cc) : cc;
          var rev = normalizeOverviewMetric(row && row.revenue);
          if (horizontal) {
            categories.push(showFlags && emoji ? (emoji + ' ' + name) : name);
          } else {
            categories.push(name || cc);
          }
          values.push(rev);
          names.push(name || cc);
          countryCodes.push(cc);
          crPcts.push(row && row.cr != null ? Number(row.cr) : null);
        });
        if (!categories.length || !values.length) {
          renderOverviewChartEmpty(chartId, 'No country data');
          try {
            var legendEl = chartEl.parentElement ? chartEl.parentElement.querySelector('[data-overview-legend="' + chartId + '"]') : null;
            if (legendEl) legendEl.innerHTML = '';
          } catch (_) {}
          return;
        }
        var fallbackColors = (opts && Array.isArray(opts.colors) && opts.colors.length) ? opts.colors : ['#4b94e4', '#3eb3ab', '#f59e34', '#8b5cf6', '#ef4444'];
        var colors = (typeof chartColorsFromUiConfig === 'function') ? chartColorsFromUiConfig(chartId, fallbackColors) : fallbackColors;
        var chartHeight = resolveOverviewChartHeight(chartEl, (opts && Number.isFinite(Number(opts.height))) ? Number(opts.height) : 180, 120, 440);
        var namesRef = names;
        var valuesRef = values;
        var crPctsRef = crPcts;
        var countryCodesRef = countryCodes;
        var showFlagsRef = showFlags;
        var dataLabelsConfig = false;
        if (!horizontal && showFlags && countryCodesRef.length) {
          dataLabelsConfig = {
            enabled: true,
            formatter: function (_val, opts) {
              var idx = opts && opts.dataPointIndex != null ? opts.dataPointIndex : -1;
              if (idx < 0 || idx >= countryCodesRef.length) return '';
              return countryCodeToFlagEmoji(countryCodesRef[idx]) || '';
            },
            style: { fontSize: '14px', fontWeight: 500 },
            offsetY: -4
          };
        }
        var apexOpts = {
          chart: { type: 'bar', height: chartHeight, fontFamily: 'Inter, sans-serif', toolbar: { show: false }, animations: { enabled: !!(uiStyle && uiStyle.animations === true) } },
          plotOptions: { bar: { horizontal: horizontal, borderRadius: 0, distributed: true, barHeight: horizontal ? '60%' : '70%', dataLabels: { hideOverflowingLabels: false } } },
          series: [{ name: 'Revenue', data: values }],
          xaxis: { categories: categories, labels: { show: horizontal ? false : true } },
          yaxis: horizontal ? { labels: { show: true, style: { fontSize: '12px', fontWeight: 500, colors: '#090f17' } } } : { labels: { show: false } },
          grid: { padding: { bottom: 12, left: 12, right: 8, top: 4 } },
          colors: colors,
          legend: { show: false },
          dataLabels: dataLabelsConfig || { enabled: false },
          fill: { opacity: (uiStyle && Number.isFinite(Number(uiStyle.fillOpacity))) ? Math.max(0, Math.min(1, Number(uiStyle.fillOpacity))) : 1, type: 'solid' },
          stroke: { show: false, width: 0 },
          states: { normal: { filter: { type: 'none', value: 0 } }, hover: { filter: { type: 'none', value: 0 } }, active: { filter: { type: 'none', value: 0 } } },
          tooltip: {
            enabled: true,
            custom: function(opts) {
              var idx = opts && opts.dataPointIndex != null ? opts.dataPointIndex : -1;
              var name = (idx >= 0 && idx < namesRef.length) ? namesRef[idx] : '';
              var rev = (idx >= 0 && idx < valuesRef.length) ? valuesRef[idx] : 0;
              var cr = (idx >= 0 && idx < crPctsRef.length) ? crPctsRef[idx] : null;
              var crStr = cr != null && Number.isFinite(cr) ? cr.toFixed(1) + '%' : '\u2014';
              var flagHtml = (showFlagsRef && idx >= 0 && idx < countryCodesRef.length) ? countryCodeToFlagHtml(countryCodesRef[idx]) : '';
              return '<div class="kexo-tooltip-card p-2"><div class="fw-semibold">' + (flagHtml || '') + escapeHtml(name || '') + '</div><div>Revenue: ' + escapeHtml(fmtGbp(rev) || '\u2014') + '</div><div>Conversion: ' + escapeHtml(crStr) + '</div></div>';
            }
          },
          noData: { text: 'No data available', style: { fontSize: '13px', color: '#626976' } }
        };
        try {
          var chartOverride = (typeof chartAdvancedOverrideFromUiConfig === 'function') ? chartAdvancedOverrideFromUiConfig(chartId, 'bar') : null;
          if (chartOverride && isPlainObject(chartOverride) && Object.keys(chartOverride).length) apexOpts = deepMergeOptions(apexOpts, chartOverride);
        } catch (_) {}
        if (horizontal) {
          apexOpts.xaxis = apexOpts.xaxis || {};
          apexOpts.xaxis.labels = apexOpts.xaxis.labels || {};
          apexOpts.xaxis.labels.show = false;
        }
        try {
          upsertDashboardApexChart(chartId, chartEl, apexOpts);
          var legendEl = chartEl.parentElement ? chartEl.parentElement.querySelector('[data-overview-legend="' + chartId + '"]') : null;
          if (legendEl) {
            // Strict layout: bar charts show flags on axis labels (horizontal) or as data labels (vertical),
            // not in the bottom legend.
            legendEl.innerHTML = '';
            legendEl.className = 'kexo-overview-mini-legend kexo-overview-countries-legend';
          }
        } catch (err) {
          captureChartError(err, 'dashboardCountriesBarRender', { chartId: chartId });
        }
      }

      function platformLabelForKey(platformKey) {
        var p = (platformKey || '').trim().toLowerCase();
        if (p === 'ios') return 'iOS';
        if (p === 'android') return 'Android';
        if (p === 'windows') return 'Windows';
        if (p === 'mac') return 'Mac';
        if (p === 'linux') return 'Linux';
        return p || 'Other';
      }

      function platformIconHtmlForKey(platformKey, label) {
        var p = (platformKey || '').trim().toLowerCase();
        var key = 'type-platform-unknown';
        var cls = 'fa-light fa-circle-question';
        if (p === 'ios') { key = 'type-platform-ios'; cls = 'fa-light fa-apple'; }
        else if (p === 'mac') { key = 'type-platform-mac'; cls = 'fa-light fa-apple'; }
        else if (p === 'android') { key = 'type-platform-android'; cls = 'fa-light fa-android'; }
        else if (p === 'windows') { key = 'type-platform-windows'; cls = 'fa-light fa-windows'; }
        else if (p === 'linux') { key = 'type-platform-linux'; cls = 'fa-light fa-linux'; }
        return '<i class="' + escapeHtml(cls) + '" data-icon-key="' + escapeHtml(key) + '" aria-hidden="true"' +
          (label ? (' title="' + escapeHtml(label) + '"') : '') + '></i>';
      }

      function clearOverviewDevicesYIcons(chartId) {
        var chartEl = document.getElementById(chartId);
        if (!chartEl || !chartEl.parentElement || !chartEl.parentElement.querySelector) return;
        var col = null;
        try { col = chartEl.parentElement.querySelector('[data-overview-yicons="' + chartId + '"]'); } catch (_) { col = null; }
        if (col) col.innerHTML = '';
      }

      function setOverviewDevicesYIcons(chartId, platforms) {
        var chartEl = document.getElementById(chartId);
        if (!chartEl || !chartEl.parentElement || !chartEl.parentElement.querySelector) return;
        var col = null;
        try { col = chartEl.parentElement.querySelector('[data-overview-yicons="' + chartId + '"]'); } catch (_) { col = null; }
        if (!col) return;
        var list = Array.isArray(platforms) ? platforms : [];
        if (!list.length) {
          col.innerHTML = '';
          return;
        }
        try { col.style.setProperty('--dash-devices-row-count', String(list.length)); } catch (_) {}
        col.innerHTML = list.map(function(r) {
          var platform = r && r.platform != null ? String(r.platform).trim().toLowerCase() : '';
          var label = r && r.label != null ? String(r.label).trim() : platformLabelForKey(platform);
          return '<div class="dash-devices-icon-cell" title="' + escapeHtml(label) + '" aria-label="' + escapeHtml(label) + '">' +
            platformIconHtmlForKey(platform, label) +
            '<span class="dash-devices-icon-label">' + escapeHtml(label) + '</span>' +
          '</div>';
        }).join('');
      }

      function renderOverviewDevicesHorizontalBar(chartId, platforms, opts) {
        var chartEl = document.getElementById(chartId);
        if (!chartEl || typeof ApexCharts === 'undefined') return;
        if (!isChartEnabledByUiConfig(chartId)) {
          destroyDashChart(chartId);
          chartEl.innerHTML = '';
          clearOverviewDevicesYIcons(chartId);
          return;
        }

        var rows = Array.isArray(platforms) ? platforms : [];
        var labels = [];
        var values = [];
        var orders = [];
        var revenues = [];
        var platformKeys = [];
        var renderedRows = [];
        rows.forEach(function(r) {
          if (!r || typeof r !== 'object') return;
          var p = r.platform != null ? String(r.platform).trim().toLowerCase() : '';
          var label = r.label != null ? String(r.label).trim() : platformLabelForKey(p);
          var sessions = normalizeOverviewMetric(r.sessions);
          if (!label || sessions <= 0) return;
          var s = Math.max(0, Math.round(sessions));
          var o = Math.max(0, Math.round(normalizeOverviewMetric(r.orders)));
          var rev = normalizeOverviewMetric(r.revenue_gbp);
          labels.push(label);
          values.push(s);
          orders.push(o);
          revenues.push(rev);
          platformKeys.push(p);
          renderedRows.push({ platform: p, label: label, sessions: s, orders: o, revenue_gbp: rev });
        });

        if (!labels.length || !values.length) {
          renderOverviewChartEmpty(chartId, 'No device data');
          clearOverviewDevicesYIcons(chartId);
          return;
        }

        var fallbackColors = (opts && Array.isArray(opts.colors) && opts.colors.length) ? opts.colors : ['#4b94e4', '#3eb3ab', '#f59e34', '#8b5cf6', '#ef4444'];
        var colors = (typeof chartColorsFromUiConfig === 'function') ? chartColorsFromUiConfig(chartId, fallbackColors) : fallbackColors;
        var chartHeight = resolveOverviewChartHeight(chartEl, (opts && Number.isFinite(Number(opts.height))) ? Number(opts.height) : 180, 120, 440);
        try {
          if (typeof chartSizePercentFromUiConfig === 'function') {
            var pct = chartSizePercentFromUiConfig(chartId, 100);
            if (Number.isFinite(pct) && pct > 0 && pct !== 100) {
              chartHeight = Math.round(chartHeight * (pct / 100));
              if (chartHeight < 120) chartHeight = 120;
              if (chartHeight > 440) chartHeight = 440;
            }
          }
        } catch (_) {}
        var uiStyle = (typeof chartStyleFromUiConfig === 'function') ? chartStyleFromUiConfig(chartId) : null;

        var labelsRef = labels;
        var valuesRef = values;
        var ordersRef = orders;
        var revenuesRef = revenues;
        var platformRef = platformKeys;

        var horizontal = !!(opts && opts.horizontal);
        var plotOptions = { bar: { horizontal: horizontal, borderRadius: 0, distributed: true, dataLabels: { hideOverflowingLabels: false } } };
        if (horizontal) plotOptions.bar.barHeight = '54%';
        else plotOptions.bar.columnWidth = '55%';
        var apexOpts = {
          chart: { type: 'bar', height: chartHeight, offsetY: -4, fontFamily: 'Inter, sans-serif', toolbar: { show: false }, animations: { enabled: !!(uiStyle && uiStyle.animations === true) } },
          plotOptions: plotOptions,
          series: [{ name: 'Sessions', data: values }],
          xaxis: { categories: labels, labels: { show: !horizontal } },
          yaxis: { labels: { show: false } },
          grid: { show: false, padding: { bottom: 10, left: 6, right: 8, top: 0 } },
          colors: colors,
          legend: { show: false },
          dataLabels: { enabled: false },
          fill: { opacity: (uiStyle && Number.isFinite(Number(uiStyle.fillOpacity))) ? Math.max(0, Math.min(1, Number(uiStyle.fillOpacity))) : 1, type: 'solid' },
          stroke: { show: false, width: 0 },
          states: { normal: { filter: { type: 'none', value: 0 } }, hover: { filter: { type: 'none', value: 0 } }, active: { filter: { type: 'none', value: 0 } } },
          tooltip: {
            enabled: true,
            custom: function(tip) {
              var idx = tip && tip.dataPointIndex != null ? tip.dataPointIndex : -1;
              var name = (idx >= 0 && idx < labelsRef.length) ? labelsRef[idx] : '';
              var sess = (idx >= 0 && idx < valuesRef.length) ? valuesRef[idx] : 0;
              var ord = (idx >= 0 && idx < ordersRef.length) ? ordersRef[idx] : 0;
              var rev = (idx >= 0 && idx < revenuesRef.length) ? revenuesRef[idx] : 0;
              var pKey = (idx >= 0 && idx < platformRef.length) ? platformRef[idx] : '';
              var crStr = (sess > 0) ? ((ord / sess) * 100).toFixed(1) + '%' : '\u2014';
              var iconHtml = platformIconHtmlForKey(pKey, name);
              return '<div class="kexo-tooltip-card p-2">' +
                '<div class="fw-semibold d-flex align-items-center gap-2">' + iconHtml + escapeHtml(name || '') + '</div>' +
                '<div>Sessions: ' + escapeHtml(fmtNum(sess)) + '</div>' +
                '<div>Orders: ' + escapeHtml(fmtNum(ord)) + '</div>' +
                '<div>Conversion: ' + escapeHtml(crStr) + '</div>' +
                '<div>Revenue: ' + escapeHtml(fmtGbp(normalizeOverviewMetric(rev)) || '\u2014') + '</div>' +
              '</div>';
            }
          },
          noData: { text: 'No data available', style: { fontSize: '13px', color: '#626976' } }
        };

        try {
          var chartOverride = (typeof chartAdvancedOverrideFromUiConfig === 'function') ? chartAdvancedOverrideFromUiConfig(chartId, 'bar-horizontal') : null;
          if (chartOverride && isPlainObject(chartOverride) && Object.keys(chartOverride).length) apexOpts = deepMergeOptions(apexOpts, chartOverride);
        } catch (_) {}

        try {
          upsertDashboardApexChart(chartId, chartEl, apexOpts);
          if (horizontal) setOverviewDevicesYIcons(chartId, renderedRows);
          else clearOverviewDevicesYIcons(chartId);
          try {
            var legendEl = chartEl.parentElement && chartEl.parentElement.parentElement && chartEl.parentElement.parentElement.querySelector
              ? chartEl.parentElement.parentElement.querySelector('[data-overview-legend="' + chartId + '"]')
              : null;
            if (legendEl) legendEl.innerHTML = '';
          } catch (_) {}
        } catch (err) {
          captureChartError(err, 'dashboardDevicesBarRender', { chartId: chartId });
          clearOverviewDevicesYIcons(chartId);
        }
      }

      function attributionIconSpecToHtml(specRaw, labelRaw) {
        var spec = specRaw != null ? String(specRaw).trim() : '';
        var label = labelRaw != null ? String(labelRaw).trim() : '';
        if (!spec) return '';
        if (/^<svg[\s>]/i.test(spec)) return '<span class="source-icons" title="' + escapeHtml(label) + '" aria-hidden="true">' + spec + '</span>';
        if (/^(https?:\/\/|\/\/|\/)/i.test(spec)) return '<span class="source-icons"><img src="' + escapeHtml(spec) + '" alt="' + escapeHtml(label) + '" class="source-icon-img" width="20" height="20" title="' + escapeHtml(label) + '"></span>';
        return '<span class="source-icons"><i class="' + escapeHtml(spec) + '" title="' + escapeHtml(label) + '" aria-hidden="true"></i></span>';
      }

      function renderOverviewAttributionDistributedBar(chartId, sources, opts) {
        var chartEl = document.getElementById(chartId);
        if (!chartEl || typeof ApexCharts === 'undefined') return;
        if (!isChartEnabledByUiConfig(chartId)) {
          destroyDashChart(chartId);
          chartEl.innerHTML = '';
          removeAttributionIconRow(chartEl);
          return;
        }
        var labels = [];
        var values = [];
        var crPcts = [];
        var iconSpecs = [];
        sources.forEach(function(s) {
          var label = (s && s.label != null) ? String(s.label).trim() : '';
          var rev = normalizeOverviewMetric(s && s.revenue_gbp != null ? s.revenue_gbp : s.revenue);
          labels.push(label || '—');
          values.push(rev);
          crPcts.push(s && s.conversion_pct != null ? Number(s.conversion_pct) : null);
          iconSpecs.push(s && s.icon_spec != null ? String(s.icon_spec).trim() : '');
        });
        if (!labels.length || !values.length) {
          renderOverviewChartEmpty(chartId, 'No attribution data');
          removeAttributionIconRow(chartEl);
          return;
        }
        removeAttributionIconRow(chartEl);
        var fallbackColors = (opts && Array.isArray(opts.colors) && opts.colors.length) ? opts.colors : ['#4b94e4', '#3eb3ab', '#f59e34', '#8b5cf6', '#ef4444'];
        var colors = (typeof chartColorsFromUiConfig === 'function') ? chartColorsFromUiConfig(chartId, fallbackColors) : fallbackColors;
        var chartHeight = resolveOverviewChartHeight(chartEl, (opts && Number.isFinite(Number(opts.height))) ? Number(opts.height) : 180, 120, 440);
        try {
          if (typeof chartSizePercentFromUiConfig === 'function') {
            var pct = chartSizePercentFromUiConfig(chartId, 100);
            if (Number.isFinite(pct) && pct > 0 && pct !== 100) {
              chartHeight = Math.round(chartHeight * (pct / 100));
              if (chartHeight < 120) chartHeight = 120;
              if (chartHeight > 440) chartHeight = 440;
            }
          }
        } catch (_) {}
        var uiStyle = (typeof chartStyleFromUiConfig === 'function') ? chartStyleFromUiConfig(chartId) : null;
        var labelsRef = labels;
        var valuesRef = values;
        var crPctsRef = crPcts;
        var horizontal = !!(opts && opts.horizontal);
        var apexOpts = {
          chart: { type: 'bar', height: chartHeight, fontFamily: 'Inter, sans-serif', toolbar: { show: false }, animations: { enabled: !!(uiStyle && uiStyle.animations === true) } },
          plotOptions: { bar: { borderRadius: 0, distributed: true, barHeight: horizontal ? '60%' : '70%', horizontal: horizontal } },
          series: [{ name: 'Revenue', data: values }],
          xaxis: { categories: labels, labels: { show: false } },
          yaxis: horizontal ? { labels: { show: true, style: { fontSize: '12px', fontWeight: 500, colors: '#090f17' } } } : { labels: { show: false } },
          grid: { padding: { bottom: 12, left: 12, right: 8, top: 4 } },
          colors: colors,
          legend: { show: false },
          dataLabels: { enabled: false },
          fill: { opacity: (uiStyle && Number.isFinite(Number(uiStyle.fillOpacity))) ? Math.max(0, Math.min(1, Number(uiStyle.fillOpacity))) : 1, type: 'solid' },
          stroke: { show: false, width: 0 },
          states: { normal: { filter: { type: 'none', value: 0 } }, hover: { filter: { type: 'none', value: 0 } }, active: { filter: { type: 'none', value: 0 } } },
          tooltip: {
            enabled: true,
            custom: function(opts) {
              var idx = opts && opts.dataPointIndex != null ? opts.dataPointIndex : -1;
              var name = (idx >= 0 && idx < labelsRef.length) ? labelsRef[idx] : '';
              var rev = (idx >= 0 && idx < valuesRef.length) ? valuesRef[idx] : 0;
              var cr = (idx >= 0 && idx < crPctsRef.length) ? crPctsRef[idx] : null;
              var crStr = cr != null && Number.isFinite(cr) ? cr.toFixed(1) + '%' : '\u2014';
              return '<div class="kexo-tooltip-card p-2"><div class="fw-semibold">' + escapeHtml(name) + '</div><div>Revenue: ' + escapeHtml(fmtGbp(rev) || '\u2014') + '</div><div>Conversion: ' + escapeHtml(crStr) + '</div></div>';
            }
          },
          noData: { text: 'No data available', style: { fontSize: '13px', color: '#626976' } }
        };
        try {
          var chartOverride = (typeof chartAdvancedOverrideFromUiConfig === 'function') ? chartAdvancedOverrideFromUiConfig(chartId, 'bar') : null;
          if (chartOverride && isPlainObject(chartOverride) && Object.keys(chartOverride).length) apexOpts = deepMergeOptions(apexOpts, chartOverride);
        } catch (_) {}
        if (horizontal) {
          apexOpts.xaxis = apexOpts.xaxis || {};
          apexOpts.xaxis.labels = apexOpts.xaxis.labels || {};
          apexOpts.xaxis.labels.show = false;
        }
        try {
          upsertDashboardApexChart(chartId, chartEl, apexOpts);
          appendAttributionIconRow(chartEl, sources, attributionIconSpecToHtml);
        } catch (err) {
          captureChartError(err, 'dashboardAttributionBarRender', { chartId: chartId });
        }
      }

      function removeAttributionIconRow(chartEl) {
        if (!chartEl || !chartEl.parentNode) return;
        var sibling = chartEl.nextElementSibling;
        if (sibling && sibling.classList && sibling.classList.contains('dash-attribution-icon-row')) {
          sibling.remove();
        }
      }

      function appendAttributionIconRow(chartEl, sources, iconSpecToHtml) {
        if (!chartEl || !chartEl.parentNode || !Array.isArray(sources) || !sources.length) return;
        var row = document.createElement('div');
        row.className = 'dash-attribution-icon-row';
        sources.forEach(function(s) {
          var cell = document.createElement('div');
          cell.className = 'dash-attribution-icon-cell';
          var label = (s && s.label != null) ? String(s.label).trim() : '';
          var spec = (s && s.icon_spec != null) ? String(s.icon_spec).trim() : '';
          cell.innerHTML = spec ? iconSpecToHtml(spec, label) : ('<span class="dash-attribution-icon-fallback">' + escapeHtml(label || '—') + '</span>');
          row.appendChild(cell);
        });
        chartEl.parentNode.insertBefore(row, chartEl.nextSibling);
        try { scheduleOverviewHeightSync(); } catch (_) {}
      }

      function removeAttributionDonutIcons(chartEl) {
        if (!chartEl) return;
        try {
          var existing = chartEl.querySelector('.dash-attribution-donut-icons');
          if (existing) existing.remove();
        } catch (_) {}
      }

      function upsertAttributionDonutIcons(chartEl, sources, values) {
        if (!chartEl) return;
        removeAttributionDonutIcons(chartEl);
        var list = Array.isArray(sources) ? sources : [];
        var vals = Array.isArray(values) ? values : [];
        if (!list.length || !vals.length || list.length !== vals.length) return;
        try { if (chartEl && chartEl.style) chartEl.style.position = 'relative'; } catch (_) {}

        var svg = null;
        var pieNode = null;
        try { svg = chartEl.querySelector('svg'); } catch (_) { svg = null; }
        if (svg) {
          try {
            pieNode = svg.querySelector('.apexcharts-pie') ||
              svg.querySelector('.apexcharts-donut-series') ||
              svg.querySelector('.apexcharts-series');
          } catch (_) { pieNode = null; }
        }
        var wrapRect = null;
        var pieRect = null;
        try { wrapRect = chartEl.getBoundingClientRect(); } catch (_) { wrapRect = null; }
        try { pieRect = (pieNode && pieNode.getBoundingClientRect) ? pieNode.getBoundingClientRect() : (svg && svg.getBoundingClientRect ? svg.getBoundingClientRect() : null); } catch (_) { pieRect = null; }
        if (!wrapRect || !pieRect || !(pieRect.width > 0) || !(pieRect.height > 0)) return;

        var cx = pieRect.left + (pieRect.width / 2);
        var cy = pieRect.top + (pieRect.height / 2);
        var r = Math.min(pieRect.width, pieRect.height) / 2;
        var iconR = r + Math.max(10, Math.round(r * 0.12));

        var total = 0;
        for (var i = 0; i < vals.length; i++) total += Math.max(0, normalizeOverviewMetric(vals[i]));
        if (!(total > 0)) return;

        var overlay = document.createElement('div');
        overlay.className = 'dash-attribution-donut-icons';
        overlay.setAttribute('aria-hidden', 'true');

        var angle = -90;
        for (var j = 0; j < list.length; j++) {
          var v = Math.max(0, normalizeOverviewMetric(vals[j]));
          if (!(v > 0)) continue;
          var span = (v / total) * 360;
          var mid = angle + (span / 2);
          angle += span;
          var rad = (mid * Math.PI) / 180;
          var x = cx + (iconR * Math.cos(rad));
          var y = cy + (iconR * Math.sin(rad));
          var left = x - wrapRect.left;
          var top = y - wrapRect.top;
          if (!Number.isFinite(left) || !Number.isFinite(top)) continue;

          var src = list[j] || {};
          var label = src.label != null ? String(src.label).trim() : '';
          var spec = src.icon_spec != null ? String(src.icon_spec).trim() : '';
          var cell = document.createElement('div');
          cell.className = 'dash-attribution-donut-icon';
          cell.style.left = left + 'px';
          cell.style.top = top + 'px';
          cell.innerHTML = spec ? attributionIconSpecToHtml(spec, label) : ('<span class="dash-attribution-icon-fallback">' + escapeHtml(label || '—') + '</span>');
          overlay.appendChild(cell);
        }

        chartEl.appendChild(overlay);
      }

      function renderOverviewAttributionChart(attributionPayload) {
        var chartId = 'dash-chart-attribution-30d';
        var rows = attributionPayload && attributionPayload.attribution && Array.isArray(attributionPayload.attribution.rows)
          ? attributionPayload.attribution.rows
          : [];
        var mode = (typeof chartModeFromUiConfig === 'function') ? String(chartModeFromUiConfig(chartId, 'donut') || 'donut').trim().toLowerCase() : 'donut';
        mode = validateChartType(chartId, mode, 'donut');

        var chartEl = document.getElementById(chartId);
        removeAttributionIconRow(chartEl);
        removeAttributionDonutIcons(chartEl);

        var uiStyle = (typeof chartStyleFromUiConfig === 'function') ? chartStyleFromUiConfig(chartId) : null;
        var showIcons = !!(uiStyle && uiStyle.icons === true);

        function normText(v) {
          var s = v == null ? '' : String(v);
          return s.replace(/\s+/g, ' ').trim();
        }
        function isOtherLabel(v) {
          var s = normText(v).toLowerCase();
          return s === 'other' || s === 'unknown' || s === '(other)' || s === '(unknown)' || s === 'n/a' || s === 'na';
        }
        function titleCaseWords(v) {
          var s = normText(v);
          if (!s) return '';
          if (/^(sms|seo|ppc|roas)$/i.test(s)) return s.toUpperCase();
          return s.split(' ').map(function(w) {
            if (!w) return '';
            return w.charAt(0).toUpperCase() + w.slice(1).toLowerCase();
          }).join(' ');
        }
        function labelFromKey(keyRaw, fallbackLabel) {
          var key = normText(keyRaw).toLowerCase();
          var fb = normText(fallbackLabel);
          if (!key) return fb || 'Other';
          if (key.indexOf('google') >= 0 && key.indexOf('ads') >= 0) return 'Google Ads';
          if (key.indexOf('organic') >= 0) return 'Organic';
          if (key.indexOf('direct') >= 0) return 'Direct';
          if (key.indexOf('email') >= 0 || key.indexOf('klaviyo') >= 0) return 'Email';
          if (key.indexOf('affiliate') >= 0) return 'Affiliates';
          if (key.indexOf('referral') >= 0) return 'Referral';
          if (key.indexOf('sms') >= 0) return 'SMS';
          if (key.indexOf('tiktok') >= 0) return 'TikTok';
          if (key.indexOf('facebook') >= 0 || key.indexOf('meta') >= 0) return 'Meta';
          if (key.indexOf('instagram') >= 0) return 'Instagram';
          if (key.indexOf('pinterest') >= 0) return 'Pinterest';
          if (key.indexOf('snap') >= 0) return 'Snapchat';
          if (key.indexOf('bing') >= 0) return 'Bing';
          if (key.indexOf('other') >= 0 || key.indexOf('unknown') >= 0) return 'Other';
          var human = titleCaseWords(key.replace(/[_-]+/g, ' '));
          return human || fb || 'Other';
        }
        function fallbackIconSpecForLabel(labelRaw) {
          var s = normText(labelRaw).toLowerCase();
          if (!s || s === 'other') return 'fa-light fa-ellipsis';
          if (s.indexOf('google') >= 0) return 'fa-brands fa-google';
          if (s.indexOf('meta') >= 0 || s.indexOf('facebook') >= 0) return 'fa-brands fa-facebook';
          if (s.indexOf('instagram') >= 0) return 'fa-brands fa-instagram';
          if (s.indexOf('tiktok') >= 0) return 'fa-brands fa-tiktok';
          if (s.indexOf('email') >= 0) return 'fa-light fa-envelope';
          if (s.indexOf('direct') >= 0) return 'fa-light fa-arrow-right-to-bracket';
          if (s.indexOf('organic') >= 0) return 'fa-light fa-seedling';
          if (s.indexOf('affiliate') >= 0) return 'fa-light fa-handshake';
          if (s.indexOf('referral') >= 0) return 'fa-light fa-link';
          if (s.indexOf('sms') >= 0) return 'fa-light fa-message-sms';
          return 'fa-light fa-globe';
        }

        var byKey = {};
        rows.forEach(function(ch) {
          if (!ch || !Array.isArray(ch.sources)) return;
          (ch.sources || []).forEach(function(src) {
            if (!src) return;
            var rev = normalizeOverviewMetric(src.revenue_gbp != null ? src.revenue_gbp : src.revenue);
            if (!(rev > 0)) return;
            var rawLabel = normText(src.label != null ? src.label : '');
            var rawKey = normText(src.source_key != null ? src.source_key : '');
            var label = rawLabel && !isOtherLabel(rawLabel) ? rawLabel : labelFromKey(rawKey, rawLabel);
            if (isOtherLabel(label)) label = 'Other';
            if (!label) label = 'Other';
            var k = label.toLowerCase();
            if (k === 'other' || isOtherLabel(k)) k = 'other';
            var iconSpec = normText(src.icon_spec != null ? src.icon_spec : '');
            if (!iconSpec) iconSpec = '';
            if (!byKey[k]) byKey[k] = { key: k, label: label, icon_spec: iconSpec, revenue_gbp: 0 };
            byKey[k].revenue_gbp += rev;
            if (!byKey[k].icon_spec && iconSpec) byKey[k].icon_spec = iconSpec;
          });
        });

        var groups = Object.keys(byKey).map(function(k) { return byKey[k]; }).filter(Boolean);
        groups.forEach(function(g) {
          if (!g) return;
          if (g.key === 'other') g.label = 'Other';
          if (!g.icon_spec && showIcons) g.icon_spec = fallbackIconSpecForLabel(g.label);
        });
        groups.sort(function(a, b) { return (b.revenue_gbp || 0) - (a.revenue_gbp || 0); });

        var other = null;
        for (var oi = 0; oi < groups.length; oi++) {
          if (groups[oi] && groups[oi].key === 'other') { other = groups[oi]; break; }
        }
        var main = groups.filter(function(g) { return g && g.key !== 'other'; });
        var keep = main.slice(0, 4);
        var remainder = main.slice(4);
        if (remainder.length) {
          if (!other) other = { key: 'other', label: 'Other', icon_spec: showIcons ? fallbackIconSpecForLabel('Other') : '', revenue_gbp: 0 };
          remainder.forEach(function(g) { other.revenue_gbp += (g && g.revenue_gbp) ? g.revenue_gbp : 0; });
        }
        if (other && (other.revenue_gbp || 0) > 0) keep.push(other);
        var finalSources = keep.filter(function(g) { return g && (g.revenue_gbp || 0) > 0; }).slice(0, 5);

        if (!finalSources.length) {
          renderOverviewChartEmpty(chartId, 'No attribution data');
          try {
            var legendHost = document.querySelector('[data-overview-legend="' + chartId + '"]');
            if (legendHost) legendHost.innerHTML = '';
          } catch (_) {}
          return;
        }
        var labels = finalSources.map(function(s) { return s && s.label ? String(s.label) : ''; });
        var values = finalSources.map(function(s) { return s && s.revenue_gbp ? s.revenue_gbp : 0; });
        var crPcts = finalSources.map(function(s) { return (s && Number.isFinite(Number(s.conversion_pct))) ? Number(s.conversion_pct) : null; });
        var fallbackColors = ['#4b94e4', '#3eb3ab', '#f59e34', '#8b5cf6', '#ef4444'];
        var colors = (typeof chartColorsFromUiConfig === 'function') ? chartColorsFromUiConfig(chartId, fallbackColors) : fallbackColors;
        try {
          var legendHost2 = document.querySelector('[data-overview-legend="' + chartId + '"]');
          if (legendHost2) {
            legendHost2.innerHTML = finalSources.map(function(s) {
              var lbl = s && s.label ? String(s.label) : '';
              var spec = s && s.icon_spec ? String(s.icon_spec) : '';
              var icon = (showIcons && spec) ? attributionIconSpecToHtml(spec, lbl) : '';
              return '<span class="kexo-overview-mini-legend-item">' + icon + '<span class="kexo-overview-legend-label">' + escapeHtml(lbl || 'Other') + '</span></span>';
            }).join('');
          }
        } catch (_) {}
        if (mode === 'bar-horizontal' || mode === 'bar' || mode === 'bar-distributed') {
          renderOverviewAttributionDistributedBar(chartId, finalSources, {
            colors: colors,
            height: 180,
            horizontal: mode === 'bar-horizontal'
          });
        } else if (mode === 'line' || mode === 'area' || mode === 'multi-line-labels') {
          var labelsRef = labels;
          var valuesRef = values;
          var crPctsRef = crPcts;
          makeChart(chartId, labels, [{
            label: 'Revenue',
            data: values,
            borderColor: (colors && colors[0]) || DASH_ACCENT,
            backgroundColor: (colors && colors[0]) ? (colors[0] + '33') : DASH_ACCENT_LIGHT,
            fill: mode === 'area',
            borderWidth: 2
          }], {
            currency: true,
            chartType: mode,
            height: 180,
            tooltipCustom: function(tip) {
              var idx = tip && tip.dataPointIndex != null ? tip.dataPointIndex : -1;
              var name = (idx >= 0 && idx < labelsRef.length) ? labelsRef[idx] : '';
              var rev = (idx >= 0 && idx < valuesRef.length) ? valuesRef[idx] : 0;
              var cr = (idx >= 0 && idx < crPctsRef.length) ? crPctsRef[idx] : null;
              var crStr = cr != null && Number.isFinite(cr) ? cr.toFixed(1) + '%' : '\u2014';
              return '<div class="kexo-tooltip-card p-2"><div class="fw-semibold">' + escapeHtml(name || '') + '</div><div>Revenue: ' + escapeHtml(fmtGbp(rev) || '\u2014') + '</div><div>Conversion: ' + escapeHtml(crStr) + '</div></div>';
            }
          });
        } else if (mode === 'radialbar') {
          renderOverviewFinishesRadialBar(chartId, labels, values, { colors: colors, height: 180, showLegend: false });
        } else {
          renderOverviewPieChart(chartId, labels, values, {
            colors: colors,
            valueFormatter: function(v) { return fmtGbp(normalizeOverviewMetric(v)) || '\u2014'; },
            height: 180,
            dataLabels: false,
            showLegend: false,
            donut: mode === 'donut',
            pieStartAngle: -90,
            pieEndAngle: 270,
            pieCustomScale: 0.70,
            afterRender: null
          });
        }
        try { scheduleOverviewHeightSync(); } catch (_) {}
      }

      function setOverviewSalesRunningTotals(revenueTotal, costTotal, profitTotal) {
        function setValue(id, value) {
          var el = document.getElementById(id);
          if (!el) return;
          var n = Number(value);
          if (!Number.isFinite(n)) {
            el.textContent = '\u2014';
            return;
          }
          el.textContent = fmtGbp(Math.round(n * 100) / 100);
        }
        setValue('dash-overview-total-revenue', revenueTotal);
        setValue('dash-overview-total-cost', costTotal);
        setValue('dash-overview-total-profit', profitTotal);
        try {
          var profitEl = document.getElementById('dash-overview-total-profit');
          var profitWrap = profitEl && profitEl.closest ? profitEl.closest('.kexo-overview-running-total.is-profit') : null;
          var p = Number(profitTotal);
          if (profitWrap && profitWrap.classList) profitWrap.classList.toggle('is-negative', Number.isFinite(p) && p < 0);

          // If snapshot totals aren't available yet, fall back to the KPI text so the header isn't misleading.
          if (!Number.isFinite(p) && profitEl) {
            var kpiProfit = document.getElementById('dash-kpi-profit');
            var txt = kpiProfit ? String(kpiProfit.textContent || '').trim() : '';
            if (txt && txt !== '\u2014') profitEl.textContent = txt;
          }
        } catch (_) {}
      }

      function setOverviewCostBreakdownTooltip(snapshotPayload) {
        var iconEl = document.getElementById('dash-overview-cost-breakdown-icon');
        var costEl = document.getElementById('dash-overview-total-cost');
        var Popover = window.bootstrap && window.bootstrap.Popover;
        function disposePopover(el) {
          if (!el || !Popover) return;
          try {
            var existing = Popover.getInstance(el);
            if (existing) { existing.hide(); existing.dispose(); }
          } catch (_) {}
        }
        function upsertPopover(el, contentHtml) {
          if (!el || !Popover) return;
          try {
            disposePopover(el);
            if (!contentHtml) return;
            var pop = new Popover(el, {
              trigger: 'hover focus',
              placement: 'bottom',
              html: true,
              container: document.body,
              customClass: 'kexo-cost-breakdown-popover',
              content: contentHtml
            });
            // Ensure screen-readers have an accessible name even if markup uses aria-hidden elsewhere.
            try {
              if (!el.getAttribute('aria-label')) el.setAttribute('aria-label', 'Cost breakdown');
            } catch (_) {}
            return pop;
          } catch (_) { return null; }
        }
        if (iconEl && iconEl.style) iconEl.style.display = 'none';
        disposePopover(iconEl);
        disposePopover(costEl);
        try { if (iconEl) iconEl.removeAttribute('title'); } catch (_) {}
        try { if (costEl) costEl.removeAttribute('title'); } catch (_) {}
        if (!snapshotPayload) return;
        var fin = snapshotPayload && snapshotPayload.financial && typeof snapshotPayload.financial === 'object' ? snapshotPayload.financial : null;
        var breakdown = fin && Array.isArray(fin.costBreakdownNow) ? fin.costBreakdownNow : null;
        if (!breakdown || !breakdown.length) return;
        var lines = [];
        var sum = 0;
        breakdown.forEach(function(row) {
          if (!row || typeof row !== 'object') return;
          var label = row.label != null ? String(row.label).trim() : '';
          var amt = row.amountGbp != null ? Number(row.amountGbp) : Number(row.amount);
          if (!label) return;
          if (!Number.isFinite(amt)) amt = 0;
          sum += amt;
          lines.push({ label: label, amount: Math.round(amt * 100) / 100 });
        });
        if (!lines.length) return;
        var total = Math.round(sum * 100) / 100;
        var html = '<strong>Cost breakdown</strong><br>'
          + lines.map(function(r) {
            return escapeHtml(r.label) + ': ' + escapeHtml(fmtGbp(r.amount));
          }).join('<br>')
          + '<br><strong>Total: ' + escapeHtml(fmtGbp(total)) + '</strong>';
        upsertPopover(iconEl, html);
        upsertPopover(costEl, html);
        if (iconEl && iconEl.style) iconEl.style.display = '';
      }

      function renderOverviewRevenueCostChart(snapshotPayload) {
        var chartId = 'dash-chart-overview-30d';
        if (!isChartEnabledByUiConfig(chartId)) {
          destroyDashChart(chartId);
          var hiddenEl = document.getElementById(chartId);
          if (hiddenEl) hiddenEl.innerHTML = '';
          setOverviewSalesRunningTotals(null, null, null);
          setOverviewCostBreakdownTooltip(null);
          return;
        }
        if (!snapshotPayload) {
          setOverviewSalesRunningTotals(null, null, null);
          setOverviewCostBreakdownTooltip(null);
          renderOverviewChartLoading(chartId, 'Loading sales overview…');
          return;
        }
        var current = snapshotPayload && snapshotPayload.seriesComparison && snapshotPayload.seriesComparison.current
          ? snapshotPayload.seriesComparison.current
          : null;
        var granularity = snapshotPayload && snapshotPayload.seriesComparison && snapshotPayload.seriesComparison.granularity
          ? String(snapshotPayload.seriesComparison.granularity).trim().toLowerCase()
          : 'day';
        var labelsYmd = current && Array.isArray(current.labelsYmd) ? current.labelsYmd : [];
        var revenueGbp = current && Array.isArray(current.revenueGbp) ? current.revenueGbp : [];
        var costGbp = current && Array.isArray(current.costGbp) ? current.costGbp : [];
        var len = Math.max(labelsYmd.length, revenueGbp.length, costGbp.length);
        if (!len) {
          setOverviewSalesRunningTotals(null, null, null);
          setOverviewCostBreakdownTooltip(snapshotPayload);
          renderOverviewChartEmpty(chartId, 'No sales overview data');
          return;
        }
        var labels = [];
        var revenue = [];
        var cost = [];
        var profit = [];
        var revenueTotal = 0;
        var costTotal = 0;
        var profitTotal = 0;
        for (var i = 0; i < len; i++) {
          var ymd = labelsYmd[i] != null ? String(labelsYmd[i]) : '';
          labels.push(ymd ? formatOverviewBucketLabel(ymd, granularity) : String(i + 1));
          var revRaw = normalizeOverviewMetric(revenueGbp[i]);
          var cstRaw = normalizeOverviewMetric(costGbp[i]);
          if (!Number.isFinite(revRaw)) revRaw = 0;
          if (!Number.isFinite(cstRaw)) cstRaw = 0;
          var rev = Math.round(revRaw * 100) / 100;
          var cst = Math.round(cstRaw * 100) / 100;
          var pft = Math.round((rev - cst) * 100) / 100;
          revenue.push(rev);
          cost.push(cst);
          profit.push(pft);
          revenueTotal += rev;
          costTotal += cst;
          profitTotal += pft;
        }
        revenueTotal = Math.round(revenueTotal * 100) / 100;
        costTotal = Math.round(costTotal * 100) / 100;
        profitTotal = Math.round((revenueTotal - costTotal) * 100) / 100;

        // Bucket mode: all buckets vs latest bucket only.
        try {
          var uiStyle = (typeof chartStyleFromUiConfig === 'function') ? chartStyleFromUiConfig(chartId) : null;
        var scope = uiStyle && uiStyle.timeseriesScope != null ? String(uiStyle.timeseriesScope).trim().toLowerCase()
          : (uiStyle && uiStyle.bucketMode != null ? String(uiStyle.bucketMode).trim().toLowerCase() : 'full'); // backward compat
        if (scope === 'latest') {
            var last = labels.length ? (labels.length - 1) : -1;
            if (last >= 0) {
              revenueTotal = Number.isFinite(Number(revenue[last])) ? Number(revenue[last]) : 0;
              costTotal = Number.isFinite(Number(cost[last])) ? Number(cost[last]) : 0;
              profitTotal = Number.isFinite(Number(profit[last])) ? Number(profit[last]) : Math.round((revenueTotal - costTotal) * 100) / 100;
              labels = [labels[last]];
              revenue = [revenueTotal];
              cost = [costTotal];
              profit = [profitTotal];
            }
          }
        } catch (_) {}
        setOverviewSalesRunningTotals(revenueTotal, costTotal, profitTotal);
        setOverviewCostBreakdownTooltip(snapshotPayload);
        var chartEl = document.getElementById(chartId);
        var chartHeight = resolveOverviewChartHeight(chartEl, 260, 140, 760);
        var overviewMode = (typeof chartModeFromUiConfig === 'function') ? chartModeFromUiConfig(chartId, 'area') : 'area';
        overviewMode = validateChartType(chartId, overviewMode, 'area');
        var overviewChartType = (overviewMode === 'multi-line-labels') ? 'line' : (overviewMode === 'stacked-area' || overviewMode === 'stacked-bar' || overviewMode === 'combo') ? overviewMode : (overviewMode || 'area');
        var profitColor = '#22c55e';
        var profitBg = 'rgba(34,197,94,0.14)';
        try {
          var hasPositive = profit && profit.some(function (v) { var n = Number(v); return Number.isFinite(n) && n > 0; });
          var hasNegative = profit && profit.some(function (v) { var n = Number(v); return Number.isFinite(n) && n < 0; });
          var latestProfit = (profit && profit.length) ? Number(profit[profit.length - 1]) : null;
          if (Number.isFinite(latestProfit)) {
            if (latestProfit < 0 || (!hasPositive && hasNegative)) {
              profitColor = '#d63939';
              profitBg = 'rgba(214,57,57,0.14)';
            }
          }
        } catch (_) {}
        makeChart(chartId, labels, [{
          label: 'Revenue',
          data: revenue,
          borderColor: DASH_ACCENT,
          backgroundColor: DASH_ACCENT_LIGHT,
          fill: true,
          borderWidth: 2
        }, {
          label: 'Cost',
          data: cost,
          borderColor: '#ef4444',
          backgroundColor: 'rgba(239,68,68,0.14)',
          fill: true,
          borderWidth: 2
        }, {
          label: 'Profit',
          data: profit,
          borderColor: profitColor,
          backgroundColor: profitBg,
          fill: true,
          borderWidth: 2
        }], {
          currency: true,
          chartType: overviewChartType,
          height: chartHeight,
          legendPosition: 'bottom',
          forceTooltip: true,
          tooltipShared: true,
          tooltipIntersect: false,
          tooltipFollowCursor: true,
          markerSize: 3
        });
      }

      function fetchOverviewJson(url, force, timeoutMs) {
        return fetchWithTimeout(url, { credentials: 'same-origin', cache: force ? 'no-store' : 'default' }, timeoutMs || 25000)
          .then(function(r) {
            if (!r) throw new Error('No response');
            if (!r.ok) throw new Error('Request failed (' + String(r.status || '') + ')');
            return r.json();
          });
      }

      function renderOverviewMiniLegend(chartId, labels, colors) {
        var id = (chartId == null ? '' : String(chartId)).trim();
        if (!id) return;
        var host = null;
        try { host = document.querySelector('[data-overview-legend="' + id + '"]'); } catch (_) { host = null; }
        if (!host) return;
        var list = Array.isArray(labels) ? labels : [];
        if (!list.length) {
          host.innerHTML = '';
          try { scheduleOverviewHeightSync(); } catch (_) {}
          return;
        }
        var cols = Array.isArray(colors) ? colors : [];
        var html = '';
        for (var i = 0; i < list.length; i++) {
          var lbl = list[i] != null ? String(list[i]).trim() : '';
          if (!lbl) continue;
          var c = cols[i] != null ? String(cols[i]) : '';
          html += '<span class="kexo-overview-mini-legend-item">'
            + '<span class="kexo-overview-mini-legend-swatch" style="background:' + escapeHtml(c || '#94a3b8') + '"></span>'
            + escapeHtml(lbl)
            + '</span>';
        }
        host.innerHTML = html;
        try { scheduleOverviewHeightSync(); } catch (_) {}
      }

      function overviewCardStyleSigFor(chartId) {
        try {
          if (typeof chartStyleFromUiConfig !== 'function') return '';
          var key = String(chartId || '');
          return JSON.stringify({
            enabled: (typeof isChartEnabledByUiConfig === 'function') ? isChartEnabledByUiConfig(key, true) : true,
            mode: (typeof chartModeFromUiConfig === 'function') ? chartModeFromUiConfig(key, '') : '',
            colors: (typeof chartColorsFromUiConfig === 'function') ? chartColorsFromUiConfig(key, []) : [],
            style: chartStyleFromUiConfig(key) || {},
          }) || '';
        } catch (_) { return ''; }
      }

      function ensureOverviewLazyObserver() {
        if (overviewLazyObserver || typeof IntersectionObserver === 'undefined') return;
        overviewLazyObserver = new IntersectionObserver(function(entries) {
          entries.forEach(function(entry) {
            if (!entry || !entry.target || !entry.target.id) return;
            var chartId = String(entry.target.id);
            overviewLazyVisible[chartId] = !!entry.isIntersecting;
            if (!entry.isIntersecting) return;
            var pending = overviewLazyPending && overviewLazyPending[chartId] ? overviewLazyPending[chartId] : null;
            if (!pending) return;
            try { delete overviewLazyPending[chartId]; } catch (_) {}
            var run = function() {
              try {
                renderOverviewCardById(chartId, pending.payload, Object.assign({}, pending.options || {}, { forceRender: true, reason: 'lazy-visible' }));
              } catch (_) {}
            };
            if (typeof requestIdleCallback === 'function') requestIdleCallback(run, { timeout: 1200 });
            else setTimeout(run, 0);
          });
        }, { root: null, rootMargin: '120px 0px', threshold: 0.1 });
      }

      function shouldLazyRenderOverviewChart(chartId) {
        return !!(OVERVIEW_LAZY_CHART_IDS && OVERVIEW_LAZY_CHART_IDS[chartId]);
      }

      function observeOverviewChartIfLazy(chartId) {
        if (!shouldLazyRenderOverviewChart(chartId)) return;
        ensureOverviewLazyObserver();
        if (!overviewLazyObserver) return;
        try {
          var el = document.getElementById(chartId);
          if (el) overviewLazyObserver.observe(el);
        } catch (_) {}
      }

      function isOverviewChartVisible(chartId) {
        if (!shouldLazyRenderOverviewChart(chartId)) return true;
        if (overviewLazyVisible[chartId] != null) return !!overviewLazyVisible[chartId];
        try {
          var el = document.getElementById(chartId);
          if (!el || !el.getBoundingClientRect) return false;
          var rect = el.getBoundingClientRect();
          var h = (window && window.innerHeight) ? window.innerHeight : 0;
          return rect.bottom > 0 && rect.top < h;
        } catch (_) {
          return false;
        }
      }

      function renderOverviewCardById(chartId, payload, options) {
        var opts = options && typeof options === 'object' ? options : {};
        var reason = opts.reason != null ? String(opts.reason) : '';
        var rk = opts.rangeKey != null ? normalizeOverviewCardRangeKey(opts.rangeKey, OVERVIEW_CARD_DEFAULT_RANGE) : getOverviewCardRange(chartId, OVERVIEW_CARD_DEFAULT_RANGE);
        observeOverviewChartIfLazy(chartId);
        if (!opts.forceRender && shouldLazyRenderOverviewChart(chartId) && !isOverviewChartVisible(chartId)) {
          overviewLazyPending[chartId] = { payload: payload, options: { rangeKey: rk } };
          return;
        }

        // NOTE: Avoid JSON stringifying the full /api/dashboard-series payload. Build a small sig from rendered data.
        var styleSig = overviewCardStyleSigFor(chartId);
        var payloadSig = '';
        var doRender = null;

        if (chartId === 'dash-chart-finishes-30d') {
          var finishesRows = payload && Array.isArray(payload.finishes) ? payload.finishes : (payload && payload.finishes && Array.isArray(payload.finishes.finishes) ? payload.finishes.finishes : []);
          var finishPairs = [];
          (finishesRows || []).forEach(function(row) {
            if (!row || typeof row !== 'object') return;
            var label = '';
            if (row.label != null && String(row.label).trim()) label = String(row.label).trim();
            else if (row.finish != null && String(row.finish).trim()) label = String(row.finish).trim();
            else if (row.key != null && String(row.key).trim()) label = String(row.key).trim().replace(/_/g, ' ');
            var val = normalizeOverviewMetric(row.revenueGbp != null ? row.revenueGbp : row.revenue);
            if (!label || val <= 0) return;
            finishPairs.push({ label: label, value: val });
          });
          finishPairs.sort(function(a, b) { return (b.value || 0) - (a.value || 0); });
          var topFinishes = finishPairs.slice(0, 5);
          var finishLabels = topFinishes.map(function(p) { return p.label; });
          var finishValues = topFinishes.map(function(p) { return p.value; });
          var fallbackColors = ['#f59e34', '#94a3b8', '#8b5cf6', '#4b94e4', '#3eb3ab'];
          var colors = (typeof chartColorsFromUiConfig === 'function') ? chartColorsFromUiConfig(chartId, fallbackColors) : fallbackColors;
          payloadSig = JSON.stringify({ labels: finishLabels, values: finishValues, rk: rk }) || '';
          doRender = function() {
            var finishesOpts = {
              colors: colors,
              valueFormatter: function(v) { return fmtGbp(normalizeOverviewMetric(v)) || '\u2014'; },
              height: 180
            };
            var finishesMode = (typeof chartModeFromUiConfig === 'function') ? String(chartModeFromUiConfig(chartId, 'radialbar') || 'radialbar').trim().toLowerCase() : 'radialbar';
            finishesMode = validateChartType(chartId, finishesMode, 'radialbar');
            if (!finishLabels.length || !finishValues.length) {
              renderOverviewChartEmpty(chartId, 'No finishes data');
              renderOverviewMiniLegend(chartId, [], []);
            } else if (finishesMode === 'radialbar') {
              renderOverviewFinishesRadialBar(chartId, finishLabels, finishValues, finishesOpts);
              renderOverviewMiniLegend(chartId, finishLabels, colors);
            } else if (finishesMode === 'bar' || finishesMode === 'bar-horizontal' || finishesMode === 'bar-distributed') {
              renderOverviewFinishesBarChart(chartId, finishLabels, finishValues, Object.assign({}, finishesOpts, { horizontal: finishesMode === 'bar-horizontal' }));
              renderOverviewMiniLegend(chartId, [], []);
            } else if (finishesMode === 'area' || finishesMode === 'line' || finishesMode === 'multi-line-labels') {
              makeChart(chartId, finishLabels, [{ label: 'Revenue', data: finishValues, borderColor: (colors && colors[0]) || DASH_ACCENT, backgroundColor: (colors && colors[0]) ? (colors[0] + '33') : DASH_ACCENT_LIGHT, fill: finishesMode === 'area', borderWidth: 2 }], { currency: true, chartType: finishesMode, height: 180 });
              renderOverviewMiniLegend(chartId, finishLabels, colors);
            } else {
              renderOverviewPieChart(chartId, finishLabels, finishValues, {
                colors: colors,
                valueFormatter: finishesOpts.valueFormatter,
                height: finishesOpts.height,
                donut: finishesMode === 'donut'
              });
              renderOverviewMiniLegend(chartId, finishLabels, colors);
            }
          };
        } else if (chartId === 'dash-chart-devices-30d') {
          var deviceRows = payload && payload.devices && Array.isArray(payload.devices.rows) ? payload.devices.rows : [];
          var agg = {
            ios: { sessions: 0, orders: 0, revenue: 0 },
            android: { sessions: 0, orders: 0, revenue: 0 },
            windows: { sessions: 0, orders: 0, revenue: 0 },
            mac: { sessions: 0, orders: 0, revenue: 0 },
            linux: { sessions: 0, orders: 0, revenue: 0 },
          };
          (deviceRows || []).forEach(function(d) {
            if (!d || !Array.isArray(d.platforms)) return;
            (d.platforms || []).forEach(function(p) {
              var key = p && p.platform != null ? String(p.platform).trim().toLowerCase() : '';
              if (!key || !agg[key]) return;
              agg[key].sessions += normalizeOverviewMetric(p.sessions);
              agg[key].orders += normalizeOverviewMetric(p.orders);
              agg[key].revenue += normalizeOverviewMetric(p.revenue_gbp);
            });
          });
          var orderKeys = ['ios', 'android', 'windows', 'mac', 'linux'];
          var platforms = [];
          orderKeys.forEach(function(k) {
            var a = agg[k];
            if (!a) return;
            var s = Math.max(0, Math.round(normalizeOverviewMetric(a.sessions)));
            var o = Math.max(0, Math.round(normalizeOverviewMetric(a.orders)));
            var r = Math.round(normalizeOverviewMetric(a.revenue) * 100) / 100;
            if (!(s > 0 || o > 0 || r > 0)) return;
            platforms.push({ platform: k, label: platformLabelForKey(k), sessions: s, orders: o, revenue_gbp: r });
          });
          payloadSig = JSON.stringify(platforms.map(function(r) {
            return [String(r.platform || ''), normalizeOverviewMetric(r.sessions), normalizeOverviewMetric(r.orders), normalizeOverviewMetric(r.revenue_gbp)];
          }).concat([rk])) || '';
          doRender = function() {
            var fallbackColors2 = ['#4b94e4', '#3eb3ab', '#f59e34', '#8b5cf6', '#ef4444'];
            var devicesColors = (typeof chartColorsFromUiConfig === 'function') ? chartColorsFromUiConfig(chartId, fallbackColors2) : fallbackColors2;
            var devicesOpts = { colors: devicesColors, height: 180 };
            try {
              var legendEl = document.getElementById(chartId) && document.getElementById(chartId).parentElement
                ? document.getElementById(chartId).parentElement.parentElement.querySelector('[data-overview-legend="' + chartId + '"]')
                : null;
              if (legendEl) legendEl.innerHTML = '';
            } catch (_) {}
            if (!platforms.length) {
              renderOverviewChartEmpty(chartId, 'No device data');
              clearOverviewDevicesYIcons(chartId);
              return;
            }
            var devicesMode = (typeof chartModeFromUiConfig === 'function')
              ? String(chartModeFromUiConfig(chartId, 'bar-horizontal') || 'bar-horizontal').trim().toLowerCase()
              : 'bar-horizontal';
            devicesMode = validateChartType(chartId, devicesMode, 'bar-horizontal');
            if (devicesMode === 'bar-horizontal' || devicesMode === 'bar' || devicesMode === 'bar-distributed') {
              renderOverviewDevicesHorizontalBar(chartId, platforms, Object.assign({}, devicesOpts, { horizontal: devicesMode === 'bar-horizontal' }));
            } else if (devicesMode === 'line' || devicesMode === 'area' || devicesMode === 'multi-line-labels') {
              var labels = platforms.map(function(p) { return p && p.label ? String(p.label) : ''; });
              var values = platforms.map(function(p) { return p && Number.isFinite(Number(p.sessions)) ? Number(p.sessions) : 0; });
              var orders = platforms.map(function(p) { return p && Number.isFinite(Number(p.orders)) ? Number(p.orders) : 0; });
              var revenues = platforms.map(function(p) { return p && Number.isFinite(Number(p.revenue_gbp)) ? Number(p.revenue_gbp) : 0; });
              var keys = platforms.map(function(p) { return p && p.platform != null ? String(p.platform) : ''; });
              makeChart(chartId, labels, [{
                label: 'Sessions',
                data: values,
                borderColor: (devicesColors && devicesColors[0]) || DASH_BLUE,
                backgroundColor: (devicesColors && devicesColors[0]) ? (devicesColors[0] + '33') : DASH_BLUE_LIGHT,
                fill: devicesMode === 'area',
                borderWidth: 2
              }], {
                chartType: devicesMode,
                height: 180,
                tooltipCustom: function(tip) {
                  var idx = tip && tip.dataPointIndex != null ? tip.dataPointIndex : -1;
                  var name = (idx >= 0 && idx < labels.length) ? labels[idx] : '';
                  var sess = (idx >= 0 && idx < values.length) ? values[idx] : 0;
                  var ord = (idx >= 0 && idx < orders.length) ? orders[idx] : 0;
                  var rev = (idx >= 0 && idx < revenues.length) ? revenues[idx] : 0;
                  var pKey = (idx >= 0 && idx < keys.length) ? keys[idx] : '';
                  var crStr = (sess > 0) ? ((ord / sess) * 100).toFixed(1) + '%' : '\u2014';
                  var iconHtml = platformIconHtmlForKey(pKey, name);
                  return '<div class="kexo-tooltip-card p-2">' +
                    '<div class="fw-semibold d-flex align-items-center gap-2">' + iconHtml + escapeHtml(name || '') + '</div>' +
                    '<div>Sessions: ' + escapeHtml(fmtNum(sess)) + '</div>' +
                    '<div>Orders: ' + escapeHtml(fmtNum(ord)) + '</div>' +
                    '<div>Conversion: ' + escapeHtml(crStr) + '</div>' +
                    '<div>Revenue: ' + escapeHtml(fmtGbp(normalizeOverviewMetric(rev)) || '\u2014') + '</div>' +
                  '</div>';
                }
              });
              clearOverviewDevicesYIcons(chartId);
            } else {
              renderOverviewDevicesHorizontalBar(chartId, platforms, Object.assign({}, devicesOpts, { horizontal: true }));
            }
          };
        } else if (chartId === 'dash-chart-attribution-30d') {
          try {
            var rows = payload && payload.attribution && Array.isArray(payload.attribution.rows) ? payload.attribution.rows : (payload && payload.attribution && payload.attribution.attribution && Array.isArray(payload.attribution.attribution.rows) ? payload.attribution.attribution.rows : []);
            payloadSig = JSON.stringify({ rk: rk, n: rows && rows.length ? rows.length : 0 }) || '';
          } catch (_) { payloadSig = String(rk); }
          doRender = function() { renderOverviewAttributionChart(payload); };
        } else if (chartId === 'dash-chart-overview-30d') {
          try {
            var cur = payload && payload.seriesComparison && payload.seriesComparison.current ? payload.seriesComparison.current : null;
            var labelsYmd = cur && Array.isArray(cur.labelsYmd) ? cur.labelsYmd : [];
            payloadSig = JSON.stringify({ rk: rk, labels: labelsYmd }) || '';
          } catch (_) { payloadSig = String(rk); }
          doRender = function() { renderOverviewRevenueCostChart(payload); };
        } else {
          return;
        }

        var sig = payloadSig + '|style:' + styleSig;
        if (reason !== 'resize' && !opts.forceRender && sig && overviewCardPayloadSignature[chartId] && sig === overviewCardPayloadSignature[chartId]) {
          return;
        }
        overviewCardPayloadSignature[chartId] = sig;
        if (typeof doRender === 'function') doRender();
        scheduleOverviewHeightSync();
      }

      function rerenderOverviewCardsFromCache(options) {
        var opts = options && typeof options === 'object' ? options : {};
        var reason = opts.reason != null ? String(opts.reason) : 'rerender';
        try {
          overviewMiniChartIds().forEach(function (id) {
            var entry = overviewCardCache && overviewCardCache[id] ? overviewCardCache[id] : null;
            if (!entry || !entry.payload) return;
            renderOverviewCardById(id, entry.payload, { reason: reason, rangeKey: entry.rangeKey, forceRender: true });
          });
        } catch (_) {}
        scheduleOverviewHeightSync();
      }

      function renderOverviewMiniCharts(payload, options) {
        var opts = options && typeof options === 'object' ? options : {};
        var reason = opts.reason != null ? String(opts.reason) : '';
        var payloadSigBase = opts.payloadSignature != null ? String(opts.payloadSignature) : overviewMiniPayloadSig(payload);
        var payloadSig = payloadSigBase + '|style:' + overviewMiniStyleSig();
        if (reason !== 'resize' && !opts.forceRender && payloadSig && overviewMiniPayloadSignature && payloadSig === overviewMiniPayloadSignature) {
          return;
        }
        var finishesRows = payload && payload.finishes && Array.isArray(payload.finishes.finishes) ? payload.finishes.finishes : [];
        var finishPairs = [];
        finishesRows.forEach(function(row) {
          if (!row || typeof row !== 'object') return;
          var label = '';
          if (row.label != null && String(row.label).trim()) label = String(row.label).trim();
          else if (row.finish != null && String(row.finish).trim()) label = String(row.finish).trim();
          else if (row.key != null && String(row.key).trim()) label = String(row.key).trim().replace(/_/g, ' ');
          var val = normalizeOverviewMetric(row.revenueGbp != null ? row.revenueGbp : row.revenue);
          if (!label || val <= 0) return;
          finishPairs.push({ label: label, value: val });
        });
        finishPairs.sort(function(a, b) { return (b.value || 0) - (a.value || 0); });
        var topFinishes = finishPairs.slice(0, 5);
        var finishLabels = topFinishes.map(function(p) { return p.label; });
        var finishValues = topFinishes.map(function(p) { return p.value; });
        var finishesChartId = 'dash-chart-finishes-30d';
        var finishesOpts = {
          colors: ['#f59e34', '#94a3b8', '#8b5cf6', '#4b94e4', '#3eb3ab'],
          valueFormatter: function(v) { return fmtGbp(normalizeOverviewMetric(v)) || '\u2014'; },
          height: 180
        };
        var finishesMode = (typeof chartModeFromUiConfig === 'function') ? String(chartModeFromUiConfig(finishesChartId, 'radialbar') || 'radialbar').trim().toLowerCase() : 'radialbar';
        if (!finishLabels.length || !finishValues.length) {
          renderOverviewChartEmpty(finishesChartId, 'No finishes data');
        } else if (finishesMode === 'radialbar') {
          renderOverviewFinishesRadialBar(finishesChartId, finishLabels, finishValues, finishesOpts);
        } else if (finishesMode === 'bar-horizontal' || finishesMode === 'bar' || finishesMode === 'bar-distributed') {
          renderOverviewFinishesBarChart(finishesChartId, finishLabels, finishValues, Object.assign({}, finishesOpts, { horizontal: finishesMode === 'bar-horizontal' }));
        } else if (finishesMode === 'line' || finishesMode === 'area' || finishesMode === 'multi-line-labels') {
          makeChart(finishesChartId, finishLabels, [{
            label: 'Revenue',
            data: finishValues,
            borderColor: (finishesOpts.colors && finishesOpts.colors[0]) || DASH_ACCENT,
            backgroundColor: (finishesOpts.colors && finishesOpts.colors[0]) ? (finishesOpts.colors[0] + '33') : DASH_ACCENT_LIGHT,
            fill: finishesMode === 'area',
            borderWidth: 2
          }], { currency: true, chartType: finishesMode, height: finishesOpts.height });
        } else {
          renderOverviewPieChart(finishesChartId, finishLabels, finishValues, {
            colors: finishesOpts.colors,
            valueFormatter: finishesOpts.valueFormatter,
            height: finishesOpts.height,
            donut: finishesMode === 'donut'
          });
        }

        var countriesRows = payload && payload.countries && Array.isArray(payload.countries.topCountries) ? payload.countries.topCountries : [];
        var topCountries = countriesRows.filter(function(row) {
          if (!row || typeof row !== 'object') return false;
          var cc = countryCodeFromRow(row) || (row.country != null ? String(row.country).trim().toUpperCase().slice(0, 2) : '');
          var val = normalizeOverviewMetric(row.revenue);
          return (cc || row.revenue != null) && val > 0;
        }).slice(0, 5);
        var countriesChartId = 'dash-chart-countries-30d';
        var countriesMode = (typeof chartModeFromUiConfig === 'function') ? String(chartModeFromUiConfig(countriesChartId, 'bar-horizontal') || 'bar-horizontal').trim().toLowerCase() : 'bar-horizontal';
        var allowedCountriesModes = ['bar-horizontal', 'bar', 'bar-distributed', 'pie', 'donut', 'radialbar', 'line', 'area', 'multi-line-labels'];
        if (allowedCountriesModes.indexOf(countriesMode) < 0) countriesMode = 'bar-horizontal';
        var fallbackCountriesColors = ['#4b94e4', '#3eb3ab', '#f59e34', '#8b5cf6', '#ef4444'];
        var countriesColors = (typeof chartColorsFromUiConfig === 'function') ? chartColorsFromUiConfig(countriesChartId, fallbackCountriesColors) : fallbackCountriesColors;
        var countriesOpts = { colors: countriesColors, height: 180 };
        try {
          var legendEl = document.getElementById(countriesChartId) && document.getElementById(countriesChartId).parentElement
            ? document.getElementById(countriesChartId).parentElement.querySelector('[data-overview-legend="' + countriesChartId + '"]')
            : null;
          if (legendEl) legendEl.innerHTML = '';
        } catch (_) {}
        if (countriesMode === 'bar-horizontal' || countriesMode === 'bar' || countriesMode === 'bar-distributed') {
          renderOverviewCountriesHorizontalBar(countriesChartId, topCountries, Object.assign({}, countriesOpts, { horizontal: countriesMode === 'bar-horizontal' }));
        } else if (countriesMode === 'radialbar') {
          var rbLabels = [];
          var rbValues = [];
          topCountries.forEach(function(row) {
            var cc = countryCodeFromRow(row) || '';
            if (!cc) {
              var raw = row && row.country != null ? String(row.country).trim() : '';
              cc = raw ? raw.toUpperCase().slice(0, 2) : '';
              if (cc === 'UK') cc = 'GB';
              if (!/^[A-Z]{2}$/.test(cc)) cc = '';
            }
            var name = cc ? ((typeof countryLabelFull === 'function') ? countryLabelFull(cc) : cc) : '';
            var val = normalizeOverviewMetric(row && row.revenue);
            rbLabels.push(name || cc || (row && row.country != null ? String(row.country).trim() : ''));
            rbValues.push(val);
          });
          renderOverviewFinishesRadialBar(countriesChartId, rbLabels, rbValues, countriesOpts);
        } else if (countriesMode === 'line' || countriesMode === 'area' || countriesMode === 'multi-line-labels') {
          var lineLabels = [];
          var lineValues = [];
          topCountries.forEach(function(row) {
            var cc = countryCodeFromRow(row) || '';
            if (!cc) {
              var raw = row && row.country != null ? String(row.country).trim() : '';
              cc = raw ? raw.toUpperCase().slice(0, 2) : '';
              if (cc === 'UK') cc = 'GB';
              if (!/^[A-Z]{2}$/.test(cc)) cc = '';
            }
            var name = cc ? ((typeof countryLabelFull === 'function') ? countryLabelFull(cc) : cc) : '';
            var val = normalizeOverviewMetric(row && row.revenue);
            lineLabels.push(name || cc || (row && row.country != null ? String(row.country).trim() : ''));
            lineValues.push(val);
          });
          makeChart(countriesChartId, lineLabels, [{
            label: 'Revenue',
            data: lineValues,
            borderColor: (countriesColors && countriesColors[0]) || DASH_ACCENT,
            backgroundColor: (countriesColors && countriesColors[0]) ? (countriesColors[0] + '33') : DASH_ACCENT_LIGHT,
            fill: countriesMode === 'area',
            borderWidth: 2
          }], { currency: true, chartType: countriesMode, height: countriesOpts.height });
        } else {
          var countryLabels = [];
          var countryValues = [];
          var countriesUiStyle = (typeof chartStyleFromUiConfig === 'function') ? chartStyleFromUiConfig(countriesChartId) : null;
          var showFlags = !!(countriesUiStyle && countriesUiStyle.pieCountryFlags);
          var countryCodesForMini = [];
          topCountries.forEach(function(row) {
            var cc = countryCodeFromRow(row);
            if (!cc) {
              var raw = row.country != null ? String(row.country).trim() : '';
              cc = raw ? raw.toUpperCase().slice(0, 2) : '';
              if (cc === 'UK') cc = 'GB';
              if (!/^[A-Z]{2}$/.test(cc)) cc = '';
            }
            var name = cc ? ((typeof countryLabelFull === 'function') ? countryLabelFull(cc) : cc) : '';
            var val = normalizeOverviewMetric(row.revenue);
            countryLabels.push(name || cc || (row.country != null ? String(row.country).trim() : ''));
            countryValues.push(val);
            countryCodesForMini.push(cc || '');
          });
          renderOverviewPieChart(countriesChartId, countryLabels, countryValues, {
            colors: countriesOpts.colors,
            valueFormatter: function(v) { return fmtGbp(normalizeOverviewMetric(v)) || '\u2014'; },
            height: countriesOpts.height,
            donut: countriesMode === 'donut',
            countryCodes: showFlags ? countryCodesForMini : null
          });
        }
        var attributionRows = payload && payload.attribution && payload.attribution.attribution && Array.isArray(payload.attribution.attribution.rows)
          ? payload.attribution.attribution.rows
          : [];
        var attributionRevenueNow = 0;
        attributionRows.forEach(function(row) {
          if (!row || typeof row !== 'object') return;
          var rev = row.revenue_gbp != null ? normalizeOverviewMetric(row.revenue_gbp) : 0;
          attributionRevenueNow += rev;
        });

        var attributionPrevRows = payload && payload.attributionPrev && payload.attributionPrev.attribution && Array.isArray(payload.attributionPrev.attribution.rows)
          ? payload.attributionPrev.attribution.rows
          : [];
        var attributionRevenuePrev = 0;
        attributionPrevRows.forEach(function(row) {
          if (!row || typeof row !== 'object') return;
          var rev = row.revenue_gbp != null ? normalizeOverviewMetric(row.revenue_gbp) : 0;
          attributionRevenuePrev += rev;
        });

        var snapshotRevenueNow = payload && payload.snapshot && payload.snapshot.financial && payload.snapshot.financial.revenue
          ? normalizeOverviewMetric(payload.snapshot.financial.revenue.value)
          : 0;
        var snapshotRevenuePrev = payload && payload.snapshot && payload.snapshot.financial && payload.snapshot.financial.revenue
          ? normalizeOverviewMetric(payload.snapshot.financial.revenue.previous)
          : 0;
        if (snapshotRevenueNow <= 0 && payload && payload.countries && payload.countries.summary && payload.countries.summary.revenue != null) {
          snapshotRevenueNow = normalizeOverviewMetric(payload.countries.summary.revenue);
        }
        renderOverviewMiniCardStats({
          revenueNow: snapshotRevenueNow,
          revenuePrev: snapshotRevenuePrev,
          attributionRevenueNow: attributionRevenueNow,
          attributionRevenuePrev: attributionRevenuePrev,
        });

        renderOverviewAttributionChart(payload ? payload.attribution : null);

        renderOverviewRevenueCostChart(payload ? payload.snapshot : null);
        scheduleOverviewHeightSync();
        overviewMiniSizeSignature = computeOverviewMiniSizeSignature();
        overviewMiniPayloadSignature = payloadSig;
      }

      function safeYmdAddDays(ymd, deltaDays) {
        var d = (typeof deltaDays === 'number' && Number.isFinite(deltaDays)) ? deltaDays : Number(deltaDays);
        if (!Number.isFinite(d) || !ymd) return null;
        try { if (typeof ymdAddDays === 'function') return ymdAddDays(ymd, d); } catch (_) {}
        var m = String(ymd).match(/^(\d{4})-(\d{2})-(\d{2})$/);
        if (!m) return null;
        try {
          var dt = new Date(Date.UTC(parseInt(m[1], 10), parseInt(m[2], 10) - 1, parseInt(m[3], 10)));
          dt.setUTCDate(dt.getUTCDate() + d);
          return dt.toISOString().slice(0, 10);
        } catch (_) {
          return null;
        }
      }

      function buildBusinessSnapshotUrlForOverviewRange(rangeKey, force, stamp) {
        var rk = normalizeOverviewCardRangeKey(rangeKey, OVERVIEW_CARD_DEFAULT_RANGE);
        var url = API + '/api/business-snapshot?mode=range';
        var isSingleDay = rk === 'today' || rk === 'yesterday' || /^d:\d{4}-\d{2}-\d{2}$/.test(rk);
        if (rk === '7d') {
          url += '&preset=last_7_days';
        } else {
          var since = null;
          var until = null;
          if (rk === 'today') {
            since = (typeof ymdNowInTz === 'function') ? ymdNowInTz() : null;
            until = since;
          } else if (rk === 'yesterday') {
            var y = (typeof ymdNowInTz === 'function') ? ymdNowInTz() : null;
            var yd = y ? safeYmdAddDays(y, -1) : null;
            since = yd;
            until = yd;
          } else if (/^d:\d{4}-\d{2}-\d{2}$/.test(rk)) {
            since = rk.slice(2);
            until = rk.slice(2);
          } else {
            var m = rk.match(/^r:(\d{4}-\d{2}-\d{2}):(\d{4}-\d{2}-\d{2})$/);
            if (m && m[1] && m[2]) {
              since = m[1];
              until = m[2];
              if (m[1] === m[2]) isSingleDay = true;
            }
          }
          if (since && until) url += '&preset=custom&since=' + encodeURIComponent(String(since)) + '&until=' + encodeURIComponent(String(until));
          else url += '&preset=last_7_days';
        }
        if (isSingleDay) url += '&granularity=hour';
        if (force) url += '&force=1&_=' + encodeURIComponent(String(stamp || Date.now()));
        return url;
      }

      function buildOverviewCardFetchUrl(chartId, rangeKey, force, stamp, shop) {
        var id = (chartId == null ? '' : String(chartId)).trim();
        var rk = normalizeOverviewCardRangeKey(rangeKey, OVERVIEW_CARD_DEFAULT_RANGE);
        if (id === 'dash-chart-overview-30d') return buildBusinessSnapshotUrlForOverviewRange(rk, force, stamp);
        var url = '';
        if (id === 'dash-chart-finishes-30d') {
          url = API + '/api/shopify-finishes?range=' + encodeURIComponent(rk);
          if (shop) url += '&shop=' + encodeURIComponent(String(shop));
        } else if (id === 'dash-chart-devices-30d') {
          url = API + '/api/devices/report?range=' + encodeURIComponent(rk);
        } else if (id === 'dash-chart-attribution-30d') {
          url = API + '/api/attribution/report?range=' + encodeURIComponent(rk);
        } else {
          return null;
        }
        if (force) url += '&force=1&_=' + encodeURIComponent(String(stamp || Date.now()));
        return url;
      }

      function fetchOverviewCardData(chartId, options) {
        var opts = options && typeof options === 'object' ? options : {};
        var force = !!opts.force;
        var renderIfFresh = !!opts.renderIfFresh;
        var id = (chartId == null ? '' : String(chartId)).trim();
        if (!id) return Promise.resolve(null);

        var rk = normalizeOverviewCardRangeKey(opts.rangeKey != null ? opts.rangeKey : (typeof dashRangeKeyFromDateRange === 'function' ? dashRangeKeyFromDateRange() : OVERVIEW_CARD_DEFAULT_RANGE), OVERVIEW_CARD_DEFAULT_RANGE);

        var shop = (id === 'dash-chart-finishes-30d') ? getShopForSales() : null;
        var shopKey = shop || '__no_shop__';
        var entry = overviewCardCache && overviewCardCache[id] ? overviewCardCache[id] : null;
        var fresh = !force &&
          entry &&
          entry.payload &&
          entry.fetchedAt &&
          (Date.now() - entry.fetchedAt) < OVERVIEW_MINI_CACHE_MS &&
          entry.rangeKey === rk &&
          (id !== 'dash-chart-finishes-30d' || entry.shopKey === shopKey);

        if (fresh) {
          if (renderIfFresh) {
            try { renderOverviewCardById(id, entry.payload, { reason: 'fresh-cache', rangeKey: rk }); } catch (_) {}
          }
          return Promise.resolve(entry.payload);
        }

        if (overviewCardInFlight[id] && !force) return overviewCardInFlight[id];

        if (!entry || !entry.payload) {
          renderOverviewChartLoading(id, id === 'dash-chart-overview-30d' ? 'Loading revenue & cost…' : 'Loading…');
        }

        var stamp = Date.now();
        var url = buildOverviewCardFetchUrl(id, rk, force, stamp, shop);
        if (!url) return Promise.resolve(null);
        var timeoutMs = (id === 'dash-chart-overview-30d') ? 30000 : 25000;

        overviewCardInFlight[id] = fetchOverviewJson(url, force, timeoutMs)
          .then(function(data) {
            if (!data) return null;
            overviewCardCache[id] = { rangeKey: rk, fetchedAt: Date.now(), payload: data, shopKey: shopKey };
            try { renderOverviewCardById(id, data, { reason: force ? 'force-fetch' : 'fetch', rangeKey: rk, forceRender: true }); } catch (_) {}
            overviewMiniFetchedAt = Date.now();
            return data;
          })
          .catch(function(err) {
            try { if (typeof window.kexoCaptureError === 'function') window.kexoCaptureError(err, { context: 'dashboardOverviewCard', chartId: id, page: PAGE }); } catch (_) {}
            var cached = overviewCardCache && overviewCardCache[id] ? overviewCardCache[id] : null;
            if (cached && cached.payload && cached.rangeKey === rk) {
              try { renderOverviewCardById(id, cached.payload, { reason: 'error-cache', rangeKey: rk, forceRender: true }); } catch (_) {}
              return cached.payload;
            }
            try { renderOverviewChartEmpty(id, 'Failed to load'); } catch (_) {}
            return null;
          })
          .finally(function() {
            overviewCardInFlight[id] = null;
          });

        return overviewCardInFlight[id];
      }

      function openOverviewCardCustomRange(chartId) {
        var id = (chartId == null ? '' : String(chartId)).trim();
        if (!id) return;
        if (typeof window.__kexoOpenCustomDateModalFor !== 'function') return;
        var currentRk = getOverviewCardRange(id, OVERVIEW_CARD_DEFAULT_RANGE);
        var prefill = (/^(r:|d:)/.test(currentRk)) ? currentRk : null;
        try {
          window.__kexoOpenCustomDateModalFor({
            prefillRangeKey: prefill,
            onApply: function(res) {
              var next = res && res.rangeKey != null ? String(res.rangeKey) : '';
              next = normalizeOverviewCardRangeKey(next, OVERVIEW_CARD_DEFAULT_RANGE);
              setOverviewCardRange(id, next);
              syncOverviewCardRangeUi(id);
              fetchOverviewCardData(id, { force: true, rangeKey: next, renderIfFresh: true });
            }
          });
        } catch (_) {}
      }

      function bindOverviewCardUiOnce() {
        if (overviewCardUiBound) return;
        overviewCardUiBound = true;
        try {
          document.addEventListener('click', function(e) {
            var t = e && e.target ? e.target : null;
            if (!t || !t.closest) return;

            var rangeBtn = t.closest('[data-overview-range][data-overview-chart]');
            if (rangeBtn) {
              e.preventDefault();
              var chartId = String(rangeBtn.getAttribute('data-overview-chart') || '').trim();
              var rangeKey = String(rangeBtn.getAttribute('data-overview-range') || '').trim().toLowerCase();
              if (!chartId || !rangeKey) return;
              if (rangeKey === 'custom') {
                openOverviewCardCustomRange(chartId);
                return;
              }
              var next = normalizeOverviewCardRangeKey(rangeKey, OVERVIEW_CARD_DEFAULT_RANGE);
              setOverviewCardRange(chartId, next);
              syncOverviewCardRangeUi(chartId);
              fetchOverviewCardData(chartId, { force: true, rangeKey: next, renderIfFresh: true });
              return;
            }

            var settingsBtn = t.closest('.kexo-overview-chart-settings-btn[data-kexo-chart-settings-key]');
            if (settingsBtn) {
              e.preventDefault();
              e.stopPropagation();
              var chartKey = String(settingsBtn.getAttribute('data-kexo-chart-settings-key') || '').trim();
              if (!chartKey) return;
              var cardTitle = '';
              try {
                var wrap = overviewCardWrap(chartKey);
                var titleEl = wrap ? wrap.querySelector('.subheader') : null;
                cardTitle = titleEl && titleEl.textContent ? String(titleEl.textContent).trim() : '';
              } catch (_) {}
              try {
                if (window.KexoChartSettingsBuilder && typeof window.KexoChartSettingsBuilder.openModal === 'function') {
                  window.KexoChartSettingsBuilder.openModal({ chartKey: chartKey, cardTitle: cardTitle || chartKey });
                  return;
                }
                if (window.KexoLayoutShortcuts && typeof window.KexoLayoutShortcuts.openChartModal === 'function') {
                  window.KexoLayoutShortcuts.openChartModal({ chartKey: chartKey, cardTitle: cardTitle || chartKey });
                }
              } catch (_) {}
              return;
            }
          });
        } catch (_) {}
      }

      function fetchOverviewMiniData(options) {
        if (typeof window.__applyDashboardKpiUiConfig === 'function') {
          try { window.__applyDashboardKpiUiConfig(); } catch (_) {}
        }
        ensureOverviewMiniResizeObserver();
        ensureOverviewHeightSyncObserver();
        try { syncOverviewHeightGrid(); } catch (_) {}
        scheduleOverviewHeightSync();
        bindOverviewCardUiOnce();
        syncAllOverviewCardRangeUi();

        var opts = options && typeof options === 'object' ? options : {};
        var force = !!opts.force;
        var renderIfFresh = !!opts.renderIfFresh;

        var ids = overviewMiniChartIds();
        if (!overviewMiniPayloadSignature && (!overviewCardCache || !Object.keys(overviewCardCache).length)) {
          ids.forEach(function(id) {
            renderOverviewChartLoading(id, id === 'dash-chart-overview-30d' ? 'Loading revenue & cost…' : 'Loading…');
          });
        }

        overviewMiniInFlight = Promise.all(ids.map(function(id) {
          return fetchOverviewCardData(id, { force: force, renderIfFresh: renderIfFresh });
        })).then(function() {
          overviewMiniFetchedAt = Date.now();
          overviewMiniPayloadSignature = 'cards:' + ids.map(function(id) {
            var entry = overviewCardCache && overviewCardCache[id] ? overviewCardCache[id] : null;
            return id + ':' + (entry && entry.rangeKey ? entry.rangeKey : '');
          }).join('|');
          overviewMiniSizeSignature = computeOverviewMiniSizeSignature();
          return overviewCardCache;
        }).finally(function() {
          overviewMiniInFlight = null;
        });

        return overviewMiniInFlight;
      }

      function renderDashboard(data) {
        if (!data) return;
        var allSeries = data.series || [];
        var series = allSeries;
        var chartSeries = allSeries;

        var el = function(id) { return document.getElementById(id); };
        // Recompute summary from current period only
        function sumField(arr, field) { var t = 0; for (var i = 0; i < arr.length; i++) t += (arr[i][field] || 0); return t; }
        function avgField(arr, field) { if (!arr.length) return 0; return sumField(arr, field) / arr.length; }

        var s = data.summary || {};
        var curRevenue = sumField(series, 'revenue');
        var curOrders = sumField(series, 'orders');
        var curSessions = sumField(series, 'sessions');
        var curConvRate = avgField(series, 'convRate');
        var curAov = avgField(series, 'aov');
        var curBounceRate = avgField(series, 'bounceRate');
        var curAdSpend = sumField(series, 'adSpend');
        // KPI card values are set by renderDashboardKpisFromApi() using /api/kpis

        // Sparklines in KPI cards.
        var sparklineSeries = getSparklineSeries(chartSeries);
        if (chartSeries.length < 2 && (!sparklineHistorySeriesCache || sparklineHistorySeriesCache.length < 2)) {
          ensureSparklineHistorySeries().then(function(historySeries) {
            if (!historySeries || historySeries.length < 2) return;
            if (dashCache && dashLastRangeKey === dashRangeKeyFromDateRange()) {
              try { renderDashboard(dashCache); } catch (_) {}
            } else {
              try { renderCondensedSparklines(historySeries); } catch (_) {}
            }
          }).catch(function() {});
        }
        function hexToRgba(hex, alpha) {
          if (!hex || typeof hex !== 'string') return 'rgba(0,0,0,0.5)';
          var raw = hex.trim();
          var a = typeof alpha === 'number' && Number.isFinite(alpha) ? Math.max(0, Math.min(1, alpha)) : null;
          if (/^rgba?\(/i.test(raw)) {
            var m = raw.replace(/\s+/g, '').match(/^rgba?\((\d+),(\d+),(\d+)(?:,([0-9.]+))?\)$/i);
            if (m) {
              var rr = Math.max(0, Math.min(255, parseInt(m[1], 10) || 0));
              var gg = Math.max(0, Math.min(255, parseInt(m[2], 10) || 0));
              var bb = Math.max(0, Math.min(255, parseInt(m[3], 10) || 0));
              var baseA = m[4] != null ? Math.max(0, Math.min(1, parseFloat(m[4]) || 0)) : 1;
              var outA = a != null ? a : baseA;
              return 'rgba(' + rr + ',' + gg + ',' + bb + ',' + outA + ')';
            }
          }
          var h = raw.replace(/^#/, '');
          if (h.length !== 6) return 'rgba(0,0,0,0.5)';
          var r = parseInt(h.slice(0, 2), 16);
          var g = parseInt(h.slice(2, 4), 16);
          var b = parseInt(h.slice(4, 6), 16);
          var out = a != null ? a : 0.5;
          return 'rgba(' + r + ',' + g + ',' + b + ',' + out + ')';
        }
        // sparkBaseline: 'zero' = include 0 baseline (revenue, sessions, orders, aov, cogs, etc.);
        // 'percent' = clamp [0,100] (conversion, bounce); 'symmetric' = include 0 and allow negative (returns).
        function renderSparkline(elId, dataArr, color, compareDataArr, sparkBaseline) {
          var sparkEl = el(elId);
          if (!sparkEl || typeof ApexCharts === 'undefined') return;
          if (dataArr.length < 2) dataArr = dataArr.length === 1 ? [dataArr[0], dataArr[0]] : [0, 0];
          var dashBundle = getChartsKpiBundle('dashboardCards');
          var sparkCfg = dashBundle.sparkline || defaultChartsKpiSparklineConfig('dashboardCards');
          var sparkMode = String(sparkCfg.mode || 'line').toLowerCase();
          if (sparkMode !== 'line' && sparkMode !== 'area' && sparkMode !== 'bar') sparkMode = 'line';
          var sparkCurve = String(sparkCfg.curve || 'straight').toLowerCase();
          if (sparkCurve !== 'smooth' && sparkCurve !== 'straight' && sparkCurve !== 'stepline') sparkCurve = 'straight';
          if (sparkMode === 'bar') sparkCurve = 'straight';
          var sparkHeight = Number(sparkCfg.height);
          if (!Number.isFinite(sparkHeight)) sparkHeight = 50;
          var sparkStrokeWidth = Number(sparkCfg.strokeWidth);
          if (!Number.isFinite(sparkStrokeWidth)) sparkStrokeWidth = 2.55;
          var showCompare = sparkCfg.showCompare !== false;
          var baseline = (sparkBaseline === 'percent' || sparkBaseline === 'symmetric') ? sparkBaseline : 'zero';

          var nums = dataArr.map(function(v) {
            var n = (typeof v === 'number') ? v : Number(v);
            return isFinite(n) ? n : 0;
          });
          if (baseline === 'percent') {
            nums = nums.map(function(n) { return Math.max(0, Math.min(100, n)); });
          }
          var compareNums = Array.isArray(compareDataArr) ? compareDataArr.map(function(v) {
            var n = (typeof v === 'number') ? v : Number(v);
            return isFinite(n) ? n : 0;
          }) : null;
          if (baseline === 'percent' && compareNums) {
            compareNums = compareNums.map(function(n) { return Math.max(0, Math.min(100, n)); });
          }
          if (compareNums && compareNums.length < 2) {
            compareNums = compareNums.length === 1 ? [compareNums[0], compareNums[0]] : null;
          }
          if (!showCompare) compareNums = null;
          if (compareNums && compareNums.length !== nums.length) {
            if (compareNums.length > nums.length) compareNums = compareNums.slice(0, nums.length);
            while (compareNums.length < nums.length) compareNums.push(compareNums[compareNums.length - 1] || 0);
          }
          var allNums = compareNums && compareNums.length ? nums.concat(compareNums) : nums.slice();
          var minVal = allNums[0];
          var maxVal = allNums[0];
          for (var i = 1; i < allNums.length; i++) {
            if (allNums[i] < minVal) minVal = allNums[i];
            if (allNums[i] > maxVal) maxVal = allNums[i];
          }
          if (!isFinite(minVal)) minVal = 0;
          if (!isFinite(maxVal)) maxVal = 0;

          // Flat/near-flat series can render as visually empty at 40px height.
          // Keep a truly zero series flat/neutral; only bump non-zero flat lines.
          var span = Math.abs(maxVal - minVal);
          var allZero = span < 1e-9 && allNums.every(function(v) { return Math.abs(v) < 1e-9; });
          if (span < 1e-9 && !allZero) {
            var bump = (maxVal === 0) ? 1 : Math.max(0.01, Math.abs(maxVal) * 0.02);
            nums[nums.length - 1] = nums[nums.length - 1] + bump;
            minVal = Math.min(minVal, nums[nums.length - 1]);
            maxVal = Math.max(maxVal, nums[nums.length - 1]);
            span = Math.abs(maxVal - minVal);
          }
          var yMin = -1;
          var yMax = 1;
          if (baseline === 'percent') {
            yMin = 0;
            yMax = 100;
          } else if (!allZero) {
            var pad = Math.max(1e-6, span * 0.12);
            yMin = minVal - pad;
            yMax = maxVal + pad;
            // Include zero baseline for non-negative KPIs (zero) or show zero line for symmetric (returns).
            if (baseline === 'zero') {
              yMin = Math.min(yMin, 0);
              if (maxVal <= 0) yMax = 0 + pad;
            } else if (baseline === 'symmetric') {
              if (minVal < 0 && maxVal > 0) {
                var absMax = Math.max(Math.abs(minVal), Math.abs(maxVal)) + pad;
                yMin = -absMax;
                yMax = absMax;
              } else {
                yMin = Math.min(yMin, 0);
                if (maxVal <= 0) yMax = 0 + pad;
              }
            }
          }

          var hasCompare = !!(compareNums && compareNums.length >= 2);
          var series = [{ name: 'Current', data: nums }];
          var chartType = sparkMode;
          // If the spark mode is `area` and we render a compare series, force the compare to be a line
          // so it reads as a dashed reference (not a filled area).
          if (sparkMode === 'area' && hasCompare) {
            chartType = 'line';
            series[0].type = 'area';
          }
          var colors = [color];
          var strokeWidths = [sparkMode === 'bar' ? 0 : sparkStrokeWidth];
          var dashArray = [0];
          if (hasCompare) {
            var compareSeries = { name: 'Compare', data: compareNums };
            if (sparkMode === 'area') compareSeries.type = 'line';
            series.push(compareSeries);
            var usePrimary = sparkCfg.compareUsePrimaryColor !== false;
            var opacityPct = Number(sparkCfg.compareOpacity);
            if (!Number.isFinite(opacityPct)) opacityPct = 50;
            opacityPct = Math.max(0, Math.min(100, opacityPct));
            var compareColor = usePrimary ? hexToRgba(color, opacityPct / 100) : (chartsKpiCompareLineColor('dashboardCards') || '#cccccc');
            colors.push(compareColor);
            strokeWidths.push(sparkMode === 'bar' ? 0 : Math.max(1, sparkStrokeWidth - 0.5));
            dashArray.push(usePrimary ? 0 : 4);
          }
          var apexOpts = {
            chart: { type: chartType, height: sparkHeight, sparkline: { enabled: true }, animations: { enabled: false } },
            series: series,
            stroke: { show: true, width: strokeWidths, curve: sparkCurve, lineCap: 'butt', dashArray: dashArray },
            fill: sparkMode === 'area'
              ? { type: 'gradient', gradient: { shadeIntensity: 1, opacityFrom: 0.26, opacityTo: 0.04, stops: [0, 100] } }
              : { type: 'solid', opacity: 1 },
            colors: colors,
            yaxis: { min: yMin, max: yMax },
            markers: { size: 0 },
            plotOptions: sparkMode === 'bar' ? { bar: { columnWidth: '55%', borderRadius: 2 } } : {},
            grid: { padding: { top: 0, right: 2, bottom: 0, left: 2 } },
            tooltip: { enabled: true },
            // ApexCharts 4.x can crash when `annotations` is explicitly set to `undefined`.
            // Always provide an annotations object with empty arrays.
            annotations: (function () {
              var a = { xaxis: [], yaxis: [], points: [], texts: [], images: [] };
              if ((baseline === 'zero' || baseline === 'symmetric') && yMin <= 0 && yMax >= 0) {
                a.yaxis.push({ y: 0, strokeDashArray: 2, borderColor: 'rgba(0,0,0,0.15)', borderWidth: 1, opacity: 0.9 });
              }
              return a;
            })()
          };
          try {
            var override = sparkCfg.advancedApexOverride;
            if (isPlainObject(override) && Object.keys(override).length) {
              apexOpts = deepMergeOptions(apexOpts, override);
            }
          } catch (_) {}
          try {
            // Ensure annotations arrays are always present (ApexCharts 4.x can crash otherwise),
            // especially after advancedApexOverride merges.
            var ann = apexOpts.annotations;
            if (!ann || typeof ann !== 'object') ann = (apexOpts.annotations = {});
            if (!Array.isArray(ann.xaxis)) ann.xaxis = [];
            if (!Array.isArray(ann.yaxis)) ann.yaxis = [];
            if (!Array.isArray(ann.points)) ann.points = [];
            if (!Array.isArray(ann.texts)) ann.texts = [];
            if (!Array.isArray(ann.images)) ann.images = [];
          } catch (_) {}
          var existing = dashSparkCharts[elId];
          if (existing && typeof existing.updateOptions === 'function' && typeof existing.updateSeries === 'function') {
            try {
              existing.updateOptions(apexOpts, false, false, false);
              existing.updateSeries(series, false);
              return;
            } catch (_) {
              try { existing.destroy(); } catch (_) {}
              try { delete dashSparkCharts[elId]; } catch (_) {}
            }
          }
          sparkEl.innerHTML = '';
          var chart = new ApexCharts(sparkEl, apexOpts);
          chart.render();
          dashSparkCharts[elId] = chart;
        }
        function sparkToneColor(dataArr) {
          var GREEN = chartsKpiToneColor('dashboardCards', 'up');
          var RED = chartsKpiToneColor('dashboardCards', 'down');
          var NEUTRAL = chartsKpiToneColor('dashboardCards', 'flat');
          var vals = (dataArr || []).map(function(v) {
            var n = (typeof v === 'number') ? v : Number(v);
            return isFinite(n) ? n : null;
          }).filter(function(v) { return v != null; });
          if (vals.length < 2) return NEUTRAL;
          var last = vals[vals.length - 1];
          var prev = vals[vals.length - 2];
          if (Math.abs(last - prev) < 1e-9) return NEUTRAL;
          return last > prev ? GREEN : RED;
        }
        function sparkToneFromCompare(current, baseline, invert, fallbackDataArr) {
          var GREEN = chartsKpiToneColor('dashboardCards', 'up');
          var RED = chartsKpiToneColor('dashboardCards', 'down');
          var NEUTRAL = chartsKpiToneColor('dashboardCards', 'flat');
          var cur = (typeof current === 'number' && Number.isFinite(current)) ? current : null;
          var base = (typeof baseline === 'number' && Number.isFinite(baseline)) ? baseline : null;
          if (cur == null || base == null) return NEUTRAL;
          var delta = cur - base;
          if (invert) delta = -delta;
          if (Math.abs(delta) < 1e-9) return NEUTRAL;
          var denom = Math.abs(base);
          if (denom > 1e-9) {
            var ratio = delta / denom;
            if (Math.abs(ratio) <= KPI_STABLE_RATIO) return NEUTRAL;
          }
          return delta >= 0 ? GREEN : RED;
        }
        function numFromRangeMap(dataObj, keyName, rangeKey) {
          var map = dataObj && dataObj[keyName] ? dataObj[keyName] : null;
          var v = map && typeof map[rangeKey] === 'number' ? map[rangeKey] : null;
          return (typeof v === 'number' && Number.isFinite(v)) ? v : null;
        }
        function sessionsFromBreakdownMap(dataObj, rangeKey) {
          var br = dataObj && dataObj.trafficBreakdown ? dataObj.trafficBreakdown : null;
          var r = br && br[rangeKey] ? br[rangeKey] : null;
          var v = r && typeof r.human_sessions === 'number' ? r.human_sessions : null;
          return (typeof v === 'number' && Number.isFinite(v)) ? v : null;
        }
        var kpiDataForTone = null;
        try { kpiDataForTone = getKpiData(); } catch (_) { kpiDataForTone = null; }
        var kpiRangeForTone = null;
        try { kpiRangeForTone = getStatsRange(); } catch (_) { kpiRangeForTone = null; }
        var compareTone = kpiDataForTone && kpiDataForTone.compare ? kpiDataForTone.compare : null;
        var currentRevenueTone = numFromRangeMap(kpiDataForTone, 'sales', kpiRangeForTone);
        var currentProfitTone = numFromRangeMap(kpiDataForTone, 'profit', kpiRangeForTone);
        var currentOrdersTone = numFromRangeMap(kpiDataForTone, 'convertedCount', kpiRangeForTone);
        var currentSessionsTone = sessionsFromBreakdownMap(kpiDataForTone, kpiRangeForTone);
        var currentConvTone = numFromRangeMap(kpiDataForTone, 'conversion', kpiRangeForTone);
        var currentVpvTone = numFromRangeMap(kpiDataForTone, 'vpv', kpiRangeForTone);
        var currentReturningTone = numFromRangeMap(kpiDataForTone, 'returningCustomerCount', kpiRangeForTone);
        var currentAovTone = numFromRangeMap(kpiDataForTone, 'aov', kpiRangeForTone);
        var currentBounceTone = numFromRangeMap(kpiDataForTone, 'bounce', kpiRangeForTone);
        var currentRoasTone = numFromRangeMap(kpiDataForTone, 'roas', kpiRangeForTone);
        var profitKpiAllowed = !!(kpiDataForTone && kpiDataForTone.profitKpiAllowed === true);
        var compareRevenueTone = compareTone && typeof compareTone.sales === 'number' ? compareTone.sales : null;
        var compareProfitTone = compareTone && typeof compareTone.profit === 'number' ? compareTone.profit : null;
        var compareOrdersTone = compareTone && typeof compareTone.convertedCount === 'number' ? compareTone.convertedCount : null;
        var compareSessionsTone = (compareTone && compareTone.trafficBreakdown && typeof compareTone.trafficBreakdown.human_sessions === 'number')
          ? compareTone.trafficBreakdown.human_sessions
          : null;
        var compareConvTone = compareTone && typeof compareTone.conversion === 'number' ? compareTone.conversion : null;
        var compareVpvTone = compareTone && typeof compareTone.vpv === 'number' ? compareTone.vpv : null;
        var compareReturningTone = compareTone && typeof compareTone.returningCustomerCount === 'number' ? compareTone.returningCustomerCount : null;
        var compareAovTone = compareTone && typeof compareTone.aov === 'number' ? compareTone.aov : null;
        var compareBounceTone = compareTone && typeof compareTone.bounce === 'number' ? compareTone.bounce : null;
        var compareRoasTone = compareTone && typeof compareTone.roas === 'number' ? compareTone.roas : null;
        var extrasTone = (kpiExpandedExtrasRange === kpiRangeForTone) ? (kpiExpandedExtrasCache || null) : null;
        var currentItemsTone = extrasTone && typeof extrasTone.itemsSold === 'number' ? extrasTone.itemsSold : null;
        var compareItemsTone = extrasTone && extrasTone.compare && typeof extrasTone.compare.itemsSold === 'number' ? extrasTone.compare.itemsSold : null;
        var currentFulfilledTone = extrasTone && typeof extrasTone.ordersFulfilled === 'number' ? extrasTone.ordersFulfilled : null;
        var compareFulfilledTone = extrasTone && extrasTone.compare && typeof extrasTone.compare.ordersFulfilled === 'number' ? extrasTone.compare.ordersFulfilled : null;
        var currentReturnsTone = extrasTone && typeof extrasTone.returns === 'number' ? extrasTone.returns : null;
        var compareReturnsTone = extrasTone && extrasTone.compare && typeof extrasTone.compare.returns === 'number' ? extrasTone.compare.returns : null;
        var currentCogsTone = extrasTone && typeof extrasTone.cogs === 'number' ? extrasTone.cogs : null;
        var compareCogsTone = extrasTone && extrasTone.compare && typeof extrasTone.compare.cogs === 'number' ? extrasTone.compare.cogs : null;
        // KPI card sparklines should reflect the real per-bucket series returned by `/api/dashboard-series`.
        // Do NOT rescale the series to end at the headline KPI totals; that flattens yesterday/day-before views.
        function sparkSeriesFromCompare(_current, _baseline, fallbackDataArr) {
          if (!Array.isArray(fallbackDataArr)) return [];
          return fallbackDataArr.map(function(v) {
            var n = (typeof v === 'number') ? v : Number(v);
            return Number.isFinite(n) ? n : 0;
          });
        }
        function formatSparklineTimeLabel(key) {
          var timePart = key.indexOf(' ') >= 0 ? shortHourLabel(key) : key;
          if (!timePart) return timePart;
          var m = /^0?(\d{1,2}):(\d{2})$/.exec(String(timePart).trim());
          if (m) return (parseInt(m[1], 10)) + ':' + m[2];
          return timePart;
        }
        function renderDashboardKpiSparkBucketLabels(series) {
          try {
            if (!Array.isArray(series) || !series.length) return;
            var labels = series.map(function(d, idx) {
              var key = d && d.date != null ? String(d.date) : '';
              if (!key) return String(idx + 1);
              if (/^\d{4}-\d{2}-\d{2}$/.test(key)) return shortDate(key);
              if (key.indexOf(' ') >= 0) return formatSparklineTimeLabel(key);
              return key;
            });
            var maxLabels = 6;
            var visibleIndices = new Set();
            if (labels.length <= maxLabels) {
              labels.forEach(function(_, i) { visibleIndices.add(i); });
            } else {
              for (var i = 0; i < maxLabels; i++) {
                var idx = i === 0 ? 0 : i === maxLabels - 1 ? labels.length - 1 : Math.round((i / (maxLabels - 1)) * (labels.length - 1));
                visibleIndices.add(idx);
              }
            }
            function ensureRow(bodyEl) {
              if (!bodyEl || !bodyEl.querySelector) return;
              var wrap = bodyEl.querySelector('.dash-kpi-sparkline-wrap');
              if (!wrap) return;
              var row = wrap.querySelector('.dash-kpi-sparkline-labels');
              if (!row) {
                row = document.createElement('div');
                row.className = 'dash-kpi-sparkline-labels';
                wrap.appendChild(row);
              }
              row.innerHTML = labels.map(function(t, i) {
                var hidden = visibleIndices.has(i) ? '' : ' is-hidden';
                return '<span class="dash-kpi-sparkline-label' + hidden + '">' + escapeHtml(t) + '</span>';
              }).join('');
            }
            document.querySelectorAll('#dash-kpi-grid .card-body, #dash-kpi-grid-mid .card-body, #dash-kpi-grid-lower .card-body').forEach(function(bodyEl) {
              if (!bodyEl || !bodyEl.querySelector) return;
              if (!bodyEl.querySelector('.dash-kpi-sparkline-wrap')) return;
              ensureRow(bodyEl);
            });
          } catch (_) {}
        }
        var revenueHistorySpark = sparklineSeries.map(function(d) { return d.revenue; });
        var sessionsHistorySpark = sparklineSeries.map(function(d) { return d.sessions; });
        var ordersHistorySpark = sparklineSeries.map(function(d) { return d.orders; });
        var returningHistorySpark = sparklineSeries.map(function(d) { return d.returningCustomerOrders || 0; });
        var convHistorySpark = sparklineSeries.map(function(d) { return d.convRate; });
        var vpvHistorySpark = sparklineSeries.map(function(d) {
          var r = d && typeof d.revenue === 'number' ? d.revenue : null;
          var s = d && typeof d.sessions === 'number' ? d.sessions : null;
          return (s != null && s > 0 && r != null) ? (r / s) : null;
        });
        var aovHistorySpark = sparklineSeries.map(function(d) { return d.aov; });
        var bounceHistorySpark = sparklineSeries.map(function(d) { return d.bounceRate; });
        var itemsHistorySpark = sparklineSeries.map(function(d) { return d.units || 0; });
        var roasHistorySpark = sparklineSeries.map(function(d) {
          var spend = d && typeof d.adSpend === 'number' ? d.adSpend : 0;
          var rev = d && typeof d.revenue === 'number' ? d.revenue : 0;
          return (spend > 0) ? (rev / spend) : 0;
        });
        var profitHistorySpark = (profitKpiAllowed && kpiDataForTone && Array.isArray(kpiDataForTone.profitSparkline))
          ? kpiDataForTone.profitSparkline
          : null;
        var revenueSpark = sparkSeriesFromCompare(currentRevenueTone, compareRevenueTone, revenueHistorySpark);
        var sessionsSpark = sparkSeriesFromCompare(currentSessionsTone, compareSessionsTone, sessionsHistorySpark);
        var ordersSpark = sparkSeriesFromCompare(currentOrdersTone, compareOrdersTone, ordersHistorySpark);
        var returningSpark = sparkSeriesFromCompare(currentReturningTone, compareReturningTone, returningHistorySpark);
        var convSpark = sparkSeriesFromCompare(currentConvTone, compareConvTone, convHistorySpark);
        var vpvSpark = sparkSeriesFromCompare(currentVpvTone, compareVpvTone, vpvHistorySpark);
        var aovSpark = sparkSeriesFromCompare(currentAovTone, compareAovTone, aovHistorySpark);
        var bounceSpark = sparkSeriesFromCompare(currentBounceTone, compareBounceTone, bounceHistorySpark);
        var itemsSpark = sparkSeriesFromCompare(currentItemsTone, compareItemsTone, itemsHistorySpark);
        var roasSpark = sparkSeriesFromCompare(currentRoasTone, compareRoasTone, roasHistorySpark);
        var profitSpark = profitKpiAllowed ? sparkSeriesFromCompare(currentProfitTone, compareProfitTone, profitHistorySpark) : [];
        function alignCompareToPrimary(compareArr, primaryLen) {
          if (!Array.isArray(compareArr) || compareArr.length < 2) return null;
          var arr = compareArr.map(function(v) {
            var n = (typeof v === 'number') ? v : Number(v);
            return Number.isFinite(n) ? n : 0;
          });
          if (arr.length === primaryLen) return arr;
          if (arr.length > primaryLen) return arr.slice(0, primaryLen);
          var last = arr.length ? (arr[arr.length - 1] || 0) : 0;
          while (arr.length < primaryLen) arr.push(last);
          return arr;
        }
        function compareFromCache(cache, primaryLen, extract) {
          if (!cache || !Array.isArray(cache) || cache.length < 2) return null;
          var extracted = cache.map(extract);
          return alignCompareToPrimary(extracted, primaryLen);
        }
        var primaryLen = revenueSpark.length;
        if (profitSpark && profitSpark.length >= 2 && profitSpark.length !== primaryLen) {
          var alignedProfitSpark = alignCompareToPrimary(profitSpark, primaryLen);
          if (alignedProfitSpark) profitSpark = alignedProfitSpark;
        }
        ensureDashboardCompareSeries(getKpiData()).then(function(compareSeries) {
          var cmp = compareSeries;
          var revenueSparkCompare = compareFromCache(cmp, primaryLen, function(d) { return d.revenue || 0; });
          var sessionsSparkCompare = compareFromCache(cmp, primaryLen, function(d) { return d.sessions || 0; });
          var ordersSparkCompare = compareFromCache(cmp, primaryLen, function(d) { return d.orders || 0; });
          var returningSparkCompare = compareFromCache(cmp, primaryLen, function(d) { return d.returningCustomerOrders || 0; });
          var convSparkCompare = compareFromCache(cmp, primaryLen, function(d) { return d.convRate != null ? d.convRate : 0; });
          var vpvSparkCompare = compareFromCache(cmp, primaryLen, function(d) {
            var r = d && typeof d.revenue === 'number' ? d.revenue : null;
            var s = d && typeof d.sessions === 'number' ? d.sessions : null;
            return (s != null && s > 0 && r != null) ? (r / s) : 0;
          });
          var aovSparkCompare = compareFromCache(cmp, primaryLen, function(d) { return d.aov != null ? d.aov : 0; });
          var bounceSparkCompare = compareFromCache(cmp, primaryLen, function(d) { return d.bounceRate != null ? d.bounceRate : 0; });
          var roasSparkCompare = null;
          if (cmp && cmp.length >= 2) {
            var roasExtracted = cmp.map(function(d) {
              var spend = d && typeof d.adSpend === 'number' ? d.adSpend : 0;
              var rev = d && typeof d.revenue === 'number' ? d.revenue : 0;
              return (spend > 0) ? (rev / spend) : 0;
            });
            roasSparkCompare = alignCompareToPrimary(roasExtracted, primaryLen);
          }
          var itemsSparkCompare = compareFromCache(cmp, primaryLen, function(d) { return d.units || 0; });
          var profitSparkCompare = null;
          try {
            var profitCmpRaw = (profitKpiAllowed && kpiDataForTone && Array.isArray(kpiDataForTone.profitSparklineCompare))
              ? kpiDataForTone.profitSparklineCompare
              : null;
            profitSparkCompare = profitCmpRaw ? alignCompareToPrimary(profitCmpRaw, primaryLen) : null;
          } catch (_) { profitSparkCompare = null; }
          renderSparkline('dash-revenue-sparkline', revenueSpark, sparkToneFromCompare(currentRevenueTone, compareRevenueTone, false, revenueSpark), revenueSparkCompare, 'zero');
          renderSparkline('dash-sessions-sparkline', sessionsSpark, sparkToneFromCompare(currentSessionsTone, compareSessionsTone, false, sessionsSpark), sessionsSparkCompare, 'zero');
          renderSparkline('dash-orders-sparkline', ordersSpark, sparkToneFromCompare(currentOrdersTone, compareOrdersTone, false, ordersSpark), ordersSparkCompare, 'zero');
          renderSparkline('dash-returning-sparkline', returningSpark, sparkToneFromCompare(currentReturningTone, compareReturningTone, false, returningSpark), returningSparkCompare, 'zero');
          renderSparkline('dash-conv-sparkline', convSpark, sparkToneFromCompare(currentConvTone, compareConvTone, false, convSpark), convSparkCompare, 'percent');
          renderSparkline('dash-vpv-sparkline', vpvSpark, sparkToneFromCompare(currentVpvTone, compareVpvTone, false, vpvSpark), vpvSparkCompare, 'zero');
          renderSparkline('dash-aov-sparkline', aovSpark, sparkToneFromCompare(currentAovTone, compareAovTone, false, aovSpark), aovSparkCompare, 'zero');
          renderSparkline('dash-bounce-sparkline', bounceSpark, sparkToneFromCompare(currentBounceTone, compareBounceTone, true, bounceSpark), bounceSparkCompare, 'percent');
          renderSparkline('dash-roas-sparkline', roasSpark, sparkToneFromCompare(currentRoasTone, compareRoasTone, false, roasSpark), roasSparkCompare, 'zero');
          if (profitKpiAllowed && profitSpark && profitSpark.length) {
            renderSparkline('dash-profit-sparkline', profitSpark, sparkToneFromCompare(currentProfitTone, compareProfitTone, false, profitSpark), profitSparkCompare, 'symmetric');
          } else {
            var ps = el('dash-profit-sparkline');
            if (ps) ps.innerHTML = '';
          }
          renderSparkline('dash-items-sparkline', itemsSpark, DASHBOARD_NEUTRAL_TONE_HEX, itemsSparkCompare, 'zero');
          renderDashboardKpiSparkBucketLabels(sparklineSeries);
          // COGS / Fulfilled / Returns sparklines come from `/api/kpis-expanded-extra` (bucketed per range).
          try {
            var extraSpark = extrasTone && extrasTone.spark && typeof extrasTone.spark === 'object' ? extrasTone.spark : null;
            var extraCmpSpark = extrasTone && extrasTone.compare && extrasTone.compare.spark && typeof extrasTone.compare.spark === 'object'
              ? extrasTone.compare.spark
              : null;

            var cogsArr = extraSpark && Array.isArray(extraSpark.cogs) ? extraSpark.cogs : null;
            var fulfilledArr = extraSpark && Array.isArray(extraSpark.fulfilled) ? extraSpark.fulfilled : null;
            var returnsArr = extraSpark && Array.isArray(extraSpark.returns) ? extraSpark.returns : null;
            var cogsCmpArr = extraCmpSpark && Array.isArray(extraCmpSpark.cogs) ? extraCmpSpark.cogs : null;
            var fulfilledCmpArr = extraCmpSpark && Array.isArray(extraCmpSpark.fulfilled) ? extraCmpSpark.fulfilled : null;
            var returnsCmpArr = extraCmpSpark && Array.isArray(extraCmpSpark.returns) ? extraCmpSpark.returns : null;

            if (cogsArr && cogsArr.length) renderSparkline('dash-cogs-sparkline', cogsArr, DASHBOARD_NEUTRAL_TONE_HEX, cogsCmpArr, 'zero');
            else { var cs = el('dash-cogs-sparkline'); if (cs) cs.innerHTML = ''; }

            if (fulfilledArr && fulfilledArr.length) renderSparkline('dash-fulfilled-sparkline', fulfilledArr, DASHBOARD_NEUTRAL_TONE_HEX, fulfilledCmpArr, 'zero');
            else { var fs = el('dash-fulfilled-sparkline'); if (fs) fs.innerHTML = ''; }

            if (returnsArr && returnsArr.length) renderSparkline('dash-returns-sparkline', returnsArr, DASHBOARD_NEUTRAL_TONE_HEX, returnsCmpArr, 'symmetric');
            else { var rs = el('dash-returns-sparkline'); if (rs) rs.innerHTML = ''; }
          } catch (_) {}
          try { if (typeof renderCondensedSparklines === 'function') renderCondensedSparklines(sparklineSeries); } catch (_) {}
        });

        var prodBody = el('dash-top-products-body');
        if (prodBody) {
          var products = data.topProducts || [];
          var prodPageSize = getTableRowsPerPage('dash-top-products', 'dashboard');
          var prodPages = Math.max(1, Math.ceil(products.length / prodPageSize));
          dashTopProductsPage = clampPage(dashTopProductsPage, prodPages);
          updateCardPagination('dash-top-products', dashTopProductsPage, prodPages);
          var prodStart = (dashTopProductsPage - 1) * prodPageSize;
          var productsPageRows = products.slice(prodStart, prodStart + prodPageSize);
          var prodTotal = productsPageRows.reduce(function (acc, p) { return acc + (Number(p && p.revenue) || 0); }, 0) || 0;
          var mainBase = getMainBaseUrl && getMainBaseUrl();
          var prodRows = productsPageRows.map(function (p) {
            var rev = Number(p && p.revenue) || 0;
            var pct = prodTotal > 0 ? (rev / prodTotal) * 100 : 0;
            var crVal = (p && typeof p.cr === 'number' && isFinite(p.cr)) ? p.cr : null;
            var label = p && p.title ? String(p.title) : 'Unknown';
            var handle = (p && p.handle) ? String(p.handle).trim().toLowerCase() : '';
            var productId = (p && p.product_id) ? String(p.product_id).replace(/^gid:\/\/shopify\/Product\//i, '').trim() : '';
            var productUrl = (mainBase && handle) ? (mainBase + '/products/' + encodeURIComponent(handle)) : '#';
            return {
              label: label,
              thumbUrl: p && p.thumb_url ? String(p.thumb_url) : null,
              valueGbp: rev,
              cr: crVal,
              pct: pct,
              productHandle: handle || null,
              productId: productId && /^\d+$/.test(productId) ? productId : null,
              productTitle: label,
              productUrl: productUrl
            };
          });
          renderDashTopList('dash-top-products-body', prodRows, { accentCss: 'background: #3eb3ab;' });
        }

        var countryBody = el('dash-top-countries-body');
        if (countryBody) {
          var countries = data.topCountries || [];
          var countryPageSize = getTableRowsPerPage('dash-top-countries', 'dashboard');
          var countryPages = Math.max(1, Math.ceil(countries.length / countryPageSize));
          dashTopCountriesPage = clampPage(dashTopCountriesPage, countryPages);
          updateCardPagination('dash-top-countries', dashTopCountriesPage, countryPages);
          var countryStart = (dashTopCountriesPage - 1) * countryPageSize;
          var countriesPageRows = countries.slice(countryStart, countryStart + countryPageSize);
          var countryTotal = countriesPageRows.reduce(function (acc, c) { return acc + (Number(c && c.revenue) || 0); }, 0) || 0;
          var countryRows = countriesPageRows.map(function (c) {
            var cc = ((c && (c.country_code || c.country)) || 'XX').toUpperCase();
            if (cc === 'UK') cc = 'GB';
            var name = (typeof countryLabelFull === 'function') ? countryLabelFull(cc) : cc;
            var rev = Number(c && c.revenue) || 0;
            var pct = countryTotal > 0 ? (rev / countryTotal) * 100 : 0;
            var crVal = (c && typeof c.cr === 'number' && isFinite(c.cr)) ? c.cr : null;
            var flagEl = (typeof flagImg === 'function') ? flagImg(cc, name) : '';
            return {
              label: name,
              iconHtml: '<span class="kexo-dash-top-flag-wrap">' + flagEl + '</span>',
              valueGbp: rev,
              cr: crVal,
              pct: pct
            };
          });
          renderDashTopList('dash-top-countries-body', countryRows, { accentCss: 'background: #3eb3ab;' });
        }

        function fmtSignedGbp(v) {
          var d = normalizeZeroNumber(v, 0.005);
          if (d == null) d = 0;
          var abs = Math.abs(d);
          var s = fmtGbp(abs);
          if (d > 0) return '+' + s;
          if (d < 0) return '-' + s;
          return s;
        }
        function renderTrendingTable(tableId, items, isUp) {
          var bodyEl = el(tableId + '-body');
          if (bodyEl) {
            var rows = Array.isArray(items) ? items : [];
            var pageSize = getTableRowsPerPage(tableId, 'dashboard');
            var pages = Math.max(1, Math.ceil(rows.length / pageSize));
            if (tableId === 'dash-trending') dashTrendingPage = clampPage(dashTrendingPage, pages);
            var page = (tableId === 'dash-trending') ? dashTrendingPage : 1;
            updateCardPagination(tableId, page, pages);
            var pageStart = (page - 1) * pageSize;
            var pageRows = rows.slice(pageStart, pageStart + pageSize);
            var totalAbs = pageRows.reduce(function (acc, p) { return acc + Math.abs(Number(p && p.deltaRevenue) || 0); }, 0) || 0;
            var mainBaseTr = getMainBaseUrl && getMainBaseUrl();
            var listRows = pageRows.map(function (p) {
              var d = (p && typeof p.deltaRevenue === 'number' && isFinite(p.deltaRevenue)) ? p.deltaRevenue : 0;
              var absD = Math.abs(d);
              var pct = totalAbs > 0 ? (absD / totalAbs) * 100 : 0;
              var crVal = (p && typeof p.cr === 'number' && isFinite(p.cr)) ? p.cr : null;
              var label = p && p.title ? String(p.title) : 'Unknown';
              var handle = (p && p.handle) ? String(p.handle).trim().toLowerCase() : '';
              var productId = (p && p.product_id) ? String(p.product_id).replace(/^gid:\/\/shopify\/Product\//i, '').trim() : '';
              var productUrl = (mainBaseTr && handle) ? (mainBaseTr + '/products/' + encodeURIComponent(handle)) : '#';
              var valueDisplay = fmtSignedGbp(d);
              var valueClass = d < 0 ? 'text-red' : 'text-green';
              return {
                label: label,
                thumbUrl: p && p.thumb_url ? String(p.thumb_url) : null,
                valueDisplay: valueDisplay,
                valueClass: valueClass,
                valueGbp: d,
                cr: crVal,
                pct: pct,
                productHandle: handle || null,
                productId: productId && /^\d+$/.test(productId) ? productId : null,
                productTitle: label,
                productUrl: productUrl
              };
            });
            var accentCss = isUp ? 'background: #3eb3ab;' : 'background: var(--chip-abandoned);';
            renderDashTopList(tableId + '-body', listRows, { accentCss: accentCss });
            return;
          }
          var t = el(tableId);
          var tbody = t ? t.querySelector('tbody') : null;
          if (!tbody) return;
          var rows = Array.isArray(items) ? items : [];
          var pagePrefix = tableId;
          var pageSize = getTableRowsPerPage(tableId, 'dashboard');
          var pages = Math.max(1, Math.ceil(rows.length / pageSize));
          if (tableId === 'dash-trending') dashTrendingPage = clampPage(dashTrendingPage, pages);
          var page = (tableId === 'dash-trending') ? dashTrendingPage : 1;
          updateCardPagination(pagePrefix, page, pages);
          var pageStart = (page - 1) * pageSize;
          var pageRows = rows.slice(pageStart, pageStart + pageSize);
          if (!rows.length) {
            tbody.innerHTML = '<tr><td colspan="5" class="dash-empty">No data</td></tr>';
            return;
          }
          function deltaText(r) {
            var d = r && typeof r.deltaRevenue === 'number' && isFinite(r.deltaRevenue) ? r.deltaRevenue : 0;
            var cls = d >= 0 ? 'text-green' : 'text-red';
            return '<span class="dash-trend-delta ' + cls + '">' + fmtSignedGbp(d) + '</span>';
          }
          function deltaOrdersText(r) {
            var d = r && typeof r.deltaOrders === 'number' && isFinite(r.deltaOrders) ? r.deltaOrders : 0;
            var sign = d >= 0 ? '+' : '';
            var cls = d >= 0 ? 'text-green' : 'text-red';
            return '<span class="dash-trend-delta ' + cls + '">' + sign + String(d) + '</span>';
          }
          var mainBase = getMainBaseUrl();
          tbody.innerHTML = pageRows.map(function(p) {
            var title = p && p.title ? String(p.title) : 'Unknown';
            var handle = (p && p.handle) ? String(p.handle).trim().toLowerCase() : '';
            var productId = (p && p.product_id) ? String(p.product_id).replace(/^gid:\/\/shopify\/Product\//i, '').trim() : '';
            var productUrl = (mainBase && handle) ? (mainBase + '/products/' + encodeURIComponent(handle)) : '#';
            var canOpen = handle || (productId && /^\d+$/.test(productId));
            var titleHtml = canOpen
              ? (
                  '<a class="kexo-product-link js-product-modal-link" href="' + escapeHtml(productUrl) + '" target="_blank" rel="noopener"' +
                    (handle ? (' data-product-handle="' + escapeHtml(handle) + '"') : '') +
                    (productId && /^\d+$/.test(productId) ? (' data-product-id="' + escapeHtml(productId) + '"') : '') +
                    (title ? (' data-product-title="' + escapeHtml(title) + '"') : '') +
                  '>' + escapeHtml(title) + '</a>'
                )
              : escapeHtml(title);
            var revCell = '<div>' + deltaText(p) + '</div>';
            var ordCell = '<div>' + deltaOrdersText(p) + '</div>';
            var crCell = fmtPct(p && (typeof p.cr === 'number' ? p.cr : null));
            var vpvVal = (p && typeof p.vpv === 'number' && isFinite(p.vpv)) ? p.vpv : null;
            var vpvCell = vpvVal != null ? fmtGbp(vpvVal) : '\u2014';
            return '<tr><td><span class="product-cell">' + titleHtml + '</span></td><td class="text-end">' + revCell + '</td><td class="text-end">' + ordCell + '</td><td class="text-end kexo-nowrap">' + crCell + '</td><td class="text-end kexo-nowrap">' + vpvCell + '</td></tr>';
          }).join('');
        }

        var trendingItems = (dashTrendingMode === 'up') ? (data.trendingUp || []) : (data.trendingDown || []);
        renderTrendingTable('dash-trending', trendingItems, dashTrendingMode === 'up');
        syncTrendingCardTitleAndChevron();
        try {
          if (typeof window.__kexoRunStickyColumnResize === 'function') window.__kexoRunStickyColumnResize();
        } catch (_) {}
      }

      var _kexoScoreCache = null;
      var _kexoScoreRangeKey = '';
      var dashTrendingMode = 'up';

      function syncTrendingCardTitleAndChevron() {
        var titleEl = document.getElementById('dash-trending-title');
        var toggleEl = document.getElementById('dash-trending-toggle');
        var iconEl = document.getElementById('dash-trending-chevron-icon');
        if (titleEl) titleEl.textContent = dashTrendingMode === 'up' ? 'Up' : 'Down';
        if (toggleEl) toggleEl.setAttribute('aria-label', dashTrendingMode === 'up' ? 'Switch to Trending Down' : 'Switch to Trending Up');
        if (iconEl) {
          iconEl.className = (dashTrendingMode === 'up' ? 'fa-light fa-chevron-down' : 'fa-light fa-chevron-up') + ' kexo-trending-chevron';
        }
      }

      function isElementVisiblyRendered(el) {
        if (!el) return false;
        try {
          var cs = window.getComputedStyle ? window.getComputedStyle(el) : null;
          if (cs && (cs.display === 'none' || cs.visibility === 'hidden')) return false;
        } catch (_) {}
        return true;
      }

      function isKexoScoreEnabledByConfig() {
        return true;
      }

      function shouldFetchKexoScore() {
        if (!isKexoScoreEnabledByConfig()) return false;
        var headerBtn = document.getElementById('header-kexo-score-wrap');
        var dashCard = document.getElementById('dash-kpi-kexo-score-card');
        if (!headerBtn && !dashCard) return false;
        if (!isElementVisiblyRendered(headerBtn) && !isElementVisiblyRendered(dashCard)) return false;
        return true;
      }

      function fetchKexoScore(rangeKey) {
        rangeKey = (rangeKey == null ? '' : String(rangeKey)).trim().toLowerCase();
        if (!rangeKey) rangeKey = 'today';
        if (!shouldFetchKexoScore()) return Promise.resolve(null);
        var url = API + '/api/kexo-score?range=' + encodeURIComponent(rangeKey);
        return fetchWithTimeout(url, { credentials: 'same-origin', cache: 'default' }, 15000)
          .then(function(r) { return (r && r.ok) ? r.json() : null; })
          .then(function(scoreData) {
            if (scoreData && shouldFetchKexoScore()) {
              _kexoScoreCache = scoreData;
              _kexoScoreRangeKey = rangeKey;
              renderKexoScore(scoreData);
            }
            return scoreData;
          })
          .catch(function() { return null; });
      }

      function formatKexoScoreNumber(rawScore) {
        var n = Number(rawScore);
        if (!Number.isFinite(n)) return '\u2014';
        n = Math.max(0, Math.min(100, n));
        var rounded = Math.round(n * 10) / 10;
        if (rounded >= 100) return '100';
        var intRounded = Math.round(rounded);
        if (Math.abs(rounded - intRounded) < 1e-9) return String(intRounded);
        return rounded.toFixed(1).replace(/\.0$/, '');
      }

      var KEXO_RING_R = 16;
      var KEXO_RING_CIRCUMFERENCE = 2 * Math.PI * KEXO_RING_R;
      var KEXO_RING_GAP = 2;
      var KEXO_RING_SEGMENT = (KEXO_RING_CIRCUMFERENCE - 5 * KEXO_RING_GAP) / 5;
      var KEXO_RING_SEGMENT_AND_GAP = KEXO_RING_SEGMENT + KEXO_RING_GAP;
      var KEXO_RING_START_OFFSET = 0.75 * KEXO_RING_CIRCUMFERENCE;

      var KEXO_RING_COLOR_ORDER = [
          'var(--kexo-accent-5, #ef4444)',
          'var(--kexo-accent-4, #8b5cf6)',
          'var(--kexo-accent-3, #f59e34)',
          'var(--kexo-accent-1, #4b94e4)',
          'var(--kexo-accent-2, #3eb3ab)'
        ];
      function applyKexoScoreRingSvg(svg, rawScore) {
        if (!svg || svg.tagName !== 'svg') return;
        var score = Number(rawScore);
        if (!Number.isFinite(score)) score = 0;
        score = Math.max(0, Math.min(100, score));
        var trackCircle = svg.querySelector('.kexo-score-ring-track');
        if (trackCircle) {
          var trackDash = KEXO_RING_SEGMENT.toFixed(2) + ' ' + KEXO_RING_GAP.toFixed(2);
          trackCircle.setAttribute('stroke-dasharray', trackDash + ' ' + trackDash + ' ' + trackDash + ' ' + trackDash + ' ' + trackDash);
          trackCircle.setAttribute('stroke-dashoffset', (-KEXO_RING_START_OFFSET).toFixed(2));
        }
        var totalFill = (score / 100) * (5 * KEXO_RING_SEGMENT);
        var fullRed = score === 0;
        var fullGreen = score === 100;
        for (var i = 0; i < 5; i += 1) {
          var segStart = KEXO_RING_START_OFFSET + i * KEXO_RING_SEGMENT_AND_GAP;
          // Fill length advances across segments only (gaps are always unfilled).
          var fillStart = i * KEXO_RING_SEGMENT;
          var filled = fullRed ? KEXO_RING_SEGMENT : (fullGreen ? KEXO_RING_SEGMENT : Math.max(0, Math.min(KEXO_RING_SEGMENT, totalFill - fillStart)));
          var fillCircle = svg.querySelector('.kexo-score-ring-fill--' + (i + 1));
          if (fillCircle) {
            // IMPORTANT: keep dasharray sum bounded to circumference so large dashoffsets
            // don't land in an effectively infinite gap (which can hide segments).
            var gap = Math.max(0, KEXO_RING_CIRCUMFERENCE - filled);
            fillCircle.setAttribute('stroke-dasharray', filled.toFixed(2) + ' ' + gap.toFixed(2));
            fillCircle.setAttribute('stroke-dashoffset', (-segStart).toFixed(2));
            if (fullRed) fillCircle.style.stroke = 'var(--kexo-accent-5, #ef4444)';
            else if (fullGreen) fillCircle.style.stroke = 'var(--kexo-accent-2, #3eb3ab)';
            else fillCircle.style.stroke = KEXO_RING_COLOR_ORDER[i];
          }
        }
      }

      function buildHeaderKexoScoreRingBg(rawScore) {
        var score = Number(rawScore);
        if (!Number.isFinite(score)) score = 0;
        score = Math.max(0, Math.min(100, score));

        if (score === 0) return 'conic-gradient(from -90deg, var(--kexo-accent-5, #ef4444) 0deg 360deg)';
        if (score === 100) return 'conic-gradient(from -90deg, var(--kexo-accent-2, #3eb3ab) 0deg 360deg)';

        var colors = [
          'var(--kexo-accent-5, #ef4444)',
          'var(--kexo-accent-4, #8b5cf6)',
          'var(--kexo-accent-3, #f59e34)',
          'var(--kexo-accent-1, #4b94e4)',
          'var(--kexo-accent-2, #3eb3ab)'
        ];
        var track = 'var(--kexo-score-track)';
        var segDeg = 360 / colors.length;
        var gapDeg = 4;
        var halfGap = gapDeg / 2;
        var fillDeg = score * 3.6;
        var stops = [];

        for (var i = 0; i < colors.length; i += 1) {
          var segStart = i * segDeg;
          var segEnd = segStart + segDeg;
          var segFillStart = segStart + halfGap;
          var segFillEnd = segEnd - halfGap;
          var paintedEnd = Math.min(fillDeg, segFillEnd);

          stops.push('transparent ' + segStart.toFixed(2) + 'deg ' + segFillStart.toFixed(2) + 'deg');

          if (paintedEnd <= segFillStart) {
            stops.push(track + ' ' + segFillStart.toFixed(2) + 'deg ' + segFillEnd.toFixed(2) + 'deg');
          } else if (paintedEnd >= segFillEnd) {
            stops.push(colors[i] + ' ' + segFillStart.toFixed(2) + 'deg ' + segFillEnd.toFixed(2) + 'deg');
          } else {
            stops.push(colors[i] + ' ' + segFillStart.toFixed(2) + 'deg ' + paintedEnd.toFixed(2) + 'deg');
            stops.push(track + ' ' + paintedEnd.toFixed(2) + 'deg ' + segFillEnd.toFixed(2) + 'deg');
          }

          stops.push('transparent ' + segFillEnd.toFixed(2) + 'deg ' + segEnd.toFixed(2) + 'deg');
        }

        return 'conic-gradient(from -90deg, ' + stops.join(', ') + ')';
      }

      function renderKexoScore(scoreData) {
        var dashNum = document.getElementById('dash-kpi-kexo-score');
        var dashRing = document.getElementById('dash-kpi-kexo-score-ring');
        var headerNum = document.getElementById('header-kexo-score');
        var headerRing = document.getElementById('header-kexo-score-ring');
        var score = null;
        if (scoreData && typeof scoreData.score === 'number' && Number.isFinite(scoreData.score)) {
          score = Math.max(0, Math.min(100, Number(scoreData.score)));
        }
        var empty = score == null;
        var dashText = empty ? '\u2014' : formatKexoScoreNumber(score);
        var headerText = empty ? '\u2014' : String(Math.round(score));
        var pct = empty ? '0' : String(score);
        if (dashNum) {
          if (empty) dashNum.innerHTML = '<span class="kpi-mini-spinner" aria-hidden="true"></span>';
          else dashNum.textContent = dashText;
        }
        if (dashRing) {
          dashRing.style.setProperty('--kexo-score-pct', pct);
          dashRing.setAttribute('data-score', pct);
          if (dashRing.tagName === 'svg') {
            applyKexoScoreRingSvg(dashRing, score);
          }
        }
        if (headerNum) { headerNum.textContent = headerText; }
        if (headerRing) {
          if (headerRing.tagName === 'svg') {
            applyKexoScoreRingSvg(headerRing, score);
          } else {
            headerRing.style.setProperty('--kexo-score-pct', pct);
            headerRing.style.background = buildHeaderKexoScoreRingBg(score);
          }
        }
        applyKexoScoreModalSummary(scoreData);
        renderKexoScoreOverviewBreakdown(scoreData);
      }

      function renderKexoScoreOverviewBreakdown(scoreData) {
        var container = document.getElementById('dash-kpi-kexo-score-breakdown');
        if (!container) return;
        function fmtComponentValue(key, raw) {
          if (raw == null) return '\u2014';
          var n = Number(raw);
          if (!Number.isFinite(n)) return '\u2014';
          var k = String(key || '').trim().toLowerCase();
          if (k === 'revenue') return (typeof formatRevenue0 === 'function') ? formatRevenue0(n) : ('\u00a3' + n.toFixed(0));
          if (k === 'orders' || k === 'itemsordered' || k === 'items_ordered') return Math.round(n).toLocaleString();
          if (k === 'conversion') return (typeof pct === 'function') ? pct(n) : (n.toFixed(1) + '%');
          if (k === 'roas') return n.toFixed(2) + 'x';
          return Math.round(n * 10) / 10;
        }
        function fmtComponentDeltaPct(rawCur, rawPrev) {
          var cur = Number(rawCur);
          var prev = Number(rawPrev);
          if (!Number.isFinite(cur) || !Number.isFinite(prev)) return '';
          if (Math.abs(prev) < 1e-9) return '';
          var delta = ((cur - prev) / Math.abs(prev)) * 100;
          var rounded = Math.round(delta * 10) / 10;
          var sign = rounded > 0 ? '+' : '';
          return sign + rounded.toFixed(1) + '%';
        }
        function normalizeScoreMetricKey(rawKey) {
          var k = String(rawKey || '').trim().toLowerCase();
          if (k === 'itemsordered' || k === 'items_ordered') return 'itemsOrdered';
          return k;
        }
        var KEXO_SCORE_STABLE_RATIO = 0.05;
        function kexoScoreDeltaBar(cur, prev) {
          var c = typeof cur === 'number' && Number.isFinite(cur) ? cur : null;
          var p = typeof prev === 'number' && Number.isFinite(prev) ? prev : null;
          if (c == null && p == null) return { widthPct: 0, barClass: 'bg-secondary', barLabel: '\u2014' };
          var isNew = c != null && (p == null || Math.abs(p) < 1e-9) && c !== 0;
          var denom = p != null && Math.abs(p) >= 1e-9 ? Math.abs(p) : 1e-9;
          var rawDelta = (c != null && p != null) ? (c - p) / denom : 0;
          var isUp = isNew || rawDelta > KEXO_SCORE_STABLE_RATIO;
          var isDown = !isNew && rawDelta < -KEXO_SCORE_STABLE_RATIO;
          var isFlat = !isUp && !isDown;
          var widthPct = isNew ? 100 : Math.max(6, Math.min(100, Math.round(Math.abs(rawDelta) * 100)));
          var barClass = isUp ? 'bg-success' : (isDown ? 'bg-danger' : 'bg-secondary');
          var barLabel = isNew ? 'new' : (isFlat ? '0%' : (rawDelta > 0 ? '+' : '') + (Math.round(rawDelta * 1000) / 10) + '%');
          return { widthPct: widthPct, barClass: barClass, barLabel: barLabel };
        }
        if (!scoreData || !Array.isArray(scoreData.components) || scoreData.components.length === 0) {
          container.innerHTML = '<div class="kexo-score-breakdown-empty text-muted small">No score data</div>';
          return;
        }
        var metricOrder = ['revenue', 'orders', 'itemsOrdered', 'conversion', 'roas'];
        var rankByKey = {};
        metricOrder.forEach(function(key, idx) { rankByKey[key] = idx; });
        var rows = scoreData.components.filter(function(c) {
          return Object.prototype.hasOwnProperty.call(rankByKey, normalizeScoreMetricKey(c && c.key));
        }).sort(function(a, b) {
          var aRank = rankByKey[normalizeScoreMetricKey(a && a.key)];
          var bRank = rankByKey[normalizeScoreMetricKey(b && b.key)];
          return aRank - bRank;
        });
        var html = rows.map(function(c) {
          var label = (c.label && String(c.label).trim()) ? String(c.label) : (c.key || '');
          var deltaBar = kexoScoreDeltaBar(c.value, c.previous);
          var valueStr = fmtComponentValue(c.key, c.value);
          var deltaStr = fmtComponentDeltaPct(c.value, c.previous);
          var detail = deltaStr ? (String(valueStr) + ' | ' + String(deltaStr) + ' vs prev') : String(valueStr);
          return '<div class="kexo-score-breakdown-row mb-2">' +
            '<div class="kexo-score-breakdown-head mb-1">' +
              '<span class="kexo-score-breakdown-label">' + escapeHtml(label) + '</span>' +
              '<span class="kexo-score-breakdown-value">' + escapeHtml(detail) + '</span>' +
            '</div>' +
            '<div class="progress">' +
              '<div class="progress-bar ' + deltaBar.barClass + '" role="progressbar" style="width:' + deltaBar.widthPct + '%" aria-valuenow="' + deltaBar.widthPct + '" aria-valuemin="0" aria-valuemax="100">' + deltaBar.barLabel + '</div>' +
            '</div>' +
          '</div>';
        }).join('');
        container.innerHTML = html;
      }

      function applyKexoScoreModalSummary(scoreData) {
        var modalScoreNum = document.getElementById('kexo-score-modal-score');
        var modalRing = document.getElementById('kexo-score-modal-ring');
        if (!modalScoreNum && !modalRing) return;
        var score = null;
        if (scoreData && typeof scoreData.score === 'number' && Number.isFinite(scoreData.score)) {
          score = Math.max(0, Math.min(100, Number(scoreData.score)));
        }
        var empty = score == null;
        var precise = empty ? '\u2014' : formatKexoScoreNumber(score);
        var pct = empty ? '0' : String(score);
        if (modalScoreNum) modalScoreNum.textContent = precise;
        if (modalRing) {
          if (modalRing.tagName === 'svg') {
            applyKexoScoreRingSvg(modalRing, score);
          } else {
            modalRing.style.setProperty('--kexo-score-pct', pct);
            modalRing.style.background = buildHeaderKexoScoreRingBg(score);
          }
        }
      }

      function disposeKexoScorePopovers(scope) {
        if (!scope || !scope.querySelectorAll) return;
        var Popover = window.bootstrap && window.bootstrap.Popover;
        if (!Popover) return;
        var nodes = Array.from(scope.querySelectorAll('[data-kexo-score-popover="1"]'));
        nodes.forEach(function(node) {
          try {
            var existing = Popover.getInstance(node);
            if (existing) { existing.hide(); existing.dispose(); }
          } catch (_) {}
        });
        try {
          Array.from(scope.querySelectorAll('.popover')).forEach(function(p) { try { p.remove(); } catch (_) {} });
        } catch (_) {}
      }

      function initKexoScorePopovers(scope) {
        if (!scope || !scope.querySelectorAll) return;
        var Popover = window.bootstrap && window.bootstrap.Popover;
        if (!Popover) return;
        var nodes = Array.from(scope.querySelectorAll('[data-kexo-score-popover="1"]'));
        nodes.forEach(function(node) {
          try {
            // If Bootstrap auto-initialized this node from data-bs-toggle before our code runs,
            // reconfigure once so we always have a header (title) and a scoped container.
            if (node.getAttribute('data-kexo-score-popover-configured') !== '1') {
              try {
                var existing = Popover.getInstance(node);
                if (existing) existing.dispose();
              } catch (_) {}
            }
            var popover = Popover.getOrCreateInstance(node, {
              trigger: node.getAttribute('data-bs-trigger') || 'click',
              placement: node.getAttribute('data-bs-placement') || 'bottom',
              html: false,
              container: scope,
              customClass: 'kexo-score-popover',
              title: 'Kexo Score',
            });
            if (node.getAttribute('data-kexo-score-popover-configured') !== '1') {
              node.setAttribute('data-kexo-score-popover-configured', '1');
            }
            if (node.getAttribute('data-kexo-score-popover-bound') !== '1') {
              node.setAttribute('data-kexo-score-popover-bound', '1');
              node.addEventListener('shown.bs.popover', function onShown() {
                var tip = popover && typeof popover.getTipElement === 'function'
                  ? popover.getTipElement()
                  : (node.getAttribute('aria-describedby') ? document.getElementById(node.getAttribute('aria-describedby')) : scope.querySelector('.popover.show'));
                if (!tip || !tip.querySelector) return;
                if (tip.querySelector('.kexo-score-popover-close')) return;
                var header = tip.querySelector('.popover-header');
                if (!header) return;
                var closeBtn = document.createElement('button');
                closeBtn.type = 'button';
                closeBtn.className = 'btn-close btn-close-sm kexo-score-popover-close position-absolute top-0 end-0 m-2';
                closeBtn.setAttribute('aria-label', 'Close');
                header.appendChild(closeBtn);
              });
            }
          } catch (_) {}
        });
        if (scope.getAttribute('data-kexo-score-popover-scope-bound') !== '1') {
          scope.setAttribute('data-kexo-score-popover-scope-bound', '1');
          var closeHandler = function(e) {
            if (!e.target || !e.target.closest || !e.target.closest('.kexo-score-popover-close')) return;
            var allTriggers = document.querySelectorAll('[data-kexo-score-popover="1"]');
            allTriggers.forEach(function(n) {
              try {
                var inst = Popover.getInstance(n);
                if (inst) inst.hide();
              } catch (_) {}
            });
          };
          scope.addEventListener('click', closeHandler);
          document.addEventListener('click', closeHandler);
        }
      }

      function openKexoScoreModal() {
        var modal = document.getElementById('kexo-score-modal');
        var body = document.getElementById('kexo-score-modal-body');
        if (!modal || !body) return;

        function fmtComponentValue(key, raw) {
          if (raw == null) return '\u2014';
          var n = Number(raw);
          if (!Number.isFinite(n)) return '\u2014';
          var k = String(key || '').trim().toLowerCase();
          if (k === 'revenue') return (typeof formatRevenue0 === 'function') ? formatRevenue0(n) : ('\u00a3' + n.toFixed(0));
          if (k === 'orders' || k === 'itemsordered' || k === 'items_ordered') return Math.round(n).toLocaleString();
          if (k === 'conversion') return (typeof pct === 'function') ? pct(n) : (n.toFixed(1) + '%');
          if (k === 'roas') return n.toFixed(2) + 'x';
          return Math.round(n * 10) / 10;
        }

        function fmtComponentDeltaPct(rawCur, rawPrev) {
          var cur = Number(rawCur);
          var prev = Number(rawPrev);
          if (!Number.isFinite(cur) || !Number.isFinite(prev)) return '';
          if (Math.abs(prev) < 1e-9) return '';
          var delta = ((cur - prev) / Math.abs(prev)) * 100;
          var rounded = Math.round(delta * 10) / 10;
          var sign = rounded > 0 ? '+' : '';
          return sign + rounded.toFixed(1) + '%';
        }

        function normalizeScoreMetricKey(rawKey) {
          var k = String(rawKey || '').trim().toLowerCase();
          if (k === 'itemsordered' || k === 'items_ordered') return 'itemsOrdered';
          return k;
        }

        var KEXO_SCORE_STABLE_RATIO_MODAL = 0.05;
        function kexoScoreDeltaBarModal(cur, prev) {
          var c = typeof cur === 'number' && Number.isFinite(cur) ? cur : null;
          var p = typeof prev === 'number' && Number.isFinite(prev) ? prev : null;
          if (c == null && p == null) return { widthPct: 0, barClass: 'bg-secondary', barLabel: '\u2014' };
          var isNew = c != null && (p == null || Math.abs(p) < 1e-9) && c !== 0;
          var denom = p != null && Math.abs(p) >= 1e-9 ? Math.abs(p) : 1e-9;
          var rawDelta = (c != null && p != null) ? (c - p) / denom : 0;
          var isUp = isNew || rawDelta > KEXO_SCORE_STABLE_RATIO_MODAL;
          var isDown = !isNew && rawDelta < -KEXO_SCORE_STABLE_RATIO_MODAL;
          var isFlat = !isUp && !isDown;
          var widthPct = isNew ? 100 : Math.max(6, Math.min(100, Math.round(Math.abs(rawDelta) * 100)));
          var barClass = isUp ? 'bg-success' : (isDown ? 'bg-danger' : 'bg-secondary');
          var barLabel = isNew ? 'new' : (isFlat ? '0%' : (rawDelta > 0 ? '+' : '') + (Math.round(rawDelta * 1000) / 10) + '%');
          return { widthPct: widthPct, barClass: barClass, barLabel: barLabel };
        }

        function animateKexoScoreBreakdownBars(scope) {
          if (!scope || !scope.querySelectorAll) return;
          var bars = Array.from(scope.querySelectorAll('.kexo-score-breakdown-row .progress-bar[data-target-pct]'));
          if (!bars.length) return;
          var reduceMotion = false;
          try { reduceMotion = !!(window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches); } catch (_) {}
          bars.forEach(function(bar, idx) {
            var target = Number(bar.getAttribute('data-target-pct') || '0');
            if (!Number.isFinite(target)) target = 0;
            target = Math.max(0, Math.min(100, target));
            if (reduceMotion) {
              bar.style.transition = 'none';
              bar.style.width = target + '%';
              return;
            }
            bar.style.transition = 'none';
            bar.style.width = '0%';
            bar.offsetWidth;
            requestAnimationFrame(function() {
              requestAnimationFrame(function() {
                bar.style.transition = 'width 720ms cubic-bezier(.22,.61,.36,1)';
                bar.style.transitionDelay = String(Math.min(idx * 45, 270)) + 'ms';
                bar.style.width = target + '%';
              });
            });
          });
        }

        var data = _kexoScoreCache;
        applyKexoScoreModalSummary(data);
        var rangeKey = (typeof dashRangeKeyFromDateRange === 'function') ? dashRangeKeyFromDateRange() : (dashLastRangeKey || 'today');
        var summaryHtml = '<div class="kexo-score-summary-loading text-muted">Loading summary…</div>';
        var breakdownHtml;
        if (!data || !Array.isArray(data.components) || data.components.length === 0) {
          breakdownHtml = '<div class="kexo-score-breakdown-empty text-muted">No score data. Select a date range and refresh.</div>';
        } else {
          var metricOrder = ['revenue', 'orders', 'itemsOrdered', 'conversion', 'roas'];
          var rankByKey = {};
          metricOrder.forEach(function(key, idx) { rankByKey[key] = idx; });
          var rows = data.components.filter(function(c) {
            return Object.prototype.hasOwnProperty.call(rankByKey, normalizeScoreMetricKey(c && c.key));
          }).sort(function(a, b) {
            var aRank = rankByKey[normalizeScoreMetricKey(a && a.key)];
            var bRank = rankByKey[normalizeScoreMetricKey(b && b.key)];
            return aRank - bRank;
          });
          breakdownHtml = rows.map(function(c) {
            var label = (c.label && String(c.label).trim()) ? String(c.label) : (c.key || '');
            var deltaBar = kexoScoreDeltaBarModal(c.value, c.previous);
            var valueStr = fmtComponentValue(c.key, c.value);
            var deltaStr = fmtComponentDeltaPct(c.value, c.previous);
            var detail = deltaStr ? (String(valueStr) + ' | ' + String(deltaStr) + ' vs previous') : String(valueStr);
            return '<div class="kexo-score-breakdown-row mb-3">' +
              '<div class="kexo-score-breakdown-head mb-1">' +
                '<span class="kexo-score-breakdown-label">' + escapeHtml(label) + '</span>' +
                '<span class="kexo-score-breakdown-value">' + escapeHtml(detail) + '</span>' +
              '</div>' +
              '<div class="progress">' +
                '<div class="progress-bar ' + deltaBar.barClass + '" role="progressbar" style="width:0%" data-target-pct="' + deltaBar.widthPct.toFixed(1) + '" aria-valuenow="' + deltaBar.widthPct + '" aria-valuemin="0" aria-valuemax="100">' + deltaBar.barLabel + '</div>' +
              '</div>' +
            '</div>';
          }).join('');
        }
        body.innerHTML =
          '<div id="kexo-score-summary-section" class="kexo-score-summary-card mb-3 is-hidden" role="region" aria-label="Kexo Score summary">' +
            '<div class="kexo-score-summary-card-header d-flex align-items-center justify-content-between mb-2">' +
              '<span class="fw-medium">Summary</span>' +
              '<button type="button" class="btn btn-icon btn-ghost-secondary kexo-score-summary-close" aria-label="Close summary"><i class="fa-light fa-xmark" aria-hidden="true"></i></button>' +
            '</div>' +
            '<div id="kexo-score-summary-wrap">' + summaryHtml + '</div>' +
          '</div>' +
          '<div id="kexo-score-breakdown">' + breakdownHtml + '</div>';
        (function initSummaryCloseAndReset() {
          var section = document.getElementById('kexo-score-summary-section');
          var closeBtn = section && section.querySelector('.kexo-score-summary-close');
          var showBtn = document.getElementById('kexo-score-show-summary-btn');
          if (closeBtn && section) {
            closeBtn.addEventListener('click', function() {
              section.classList.add('is-hidden');
              if (showBtn) showBtn.classList.remove('is-hidden');
            });
          }
          if (showBtn) showBtn.classList.remove('is-hidden');
        })();
        (function fetchAndRenderSummary(force) {
          var wrap = document.getElementById('kexo-score-summary-wrap');
          if (!wrap) return;
          if (!force) wrap.innerHTML = '<div class="kexo-score-summary-loading text-muted">Loading summary…</div>';
          var url = (typeof API !== 'undefined' ? API : '') + '/api/kexo-score-summary?range=' + encodeURIComponent(rangeKey) + (force ? '&force=1&_=' + Date.now() : '');
          fetchWithTimeout(url, { credentials: 'same-origin' }, 15000)
            .then(function(r) { return (r && r.ok) ? r.json() : null; })
            .then(function(payload) {
              if (!wrap) return;
              if (!payload || payload.ok === false) {
                wrap.innerHTML = '<p class="kexo-score-summary-text text-muted">Summary unavailable.</p>';
                return;
              }
              var summary = (payload.summary && String(payload.summary).trim()) ? escapeHtml(payload.summary) : '';
              var drivers = Array.isArray(payload.key_drivers) ? payload.key_drivers : [];
              var rec = (payload.recommendation && String(payload.recommendation).trim()) ? escapeHtml(payload.recommendation) : '';
              var parts = [];
              if (summary) parts.push('<p class="kexo-score-summary-text">' + summary + '</p>');
              if (drivers.length) {
                parts.push('<ul class="kexo-score-summary-drivers">' + drivers.map(function(d) {
                  var s = String(d).trim();
                  var idx = s.indexOf(': ');
                  if (idx > 0) {
                    var label = s.slice(0, idx + 1);
                    var rest = s.slice(idx + 2);
                    return '<li><span class="kexo-score-driver-label">' + escapeHtml(label) + '</span> ' + escapeHtml(rest) + '</li>';
                  }
                  return '<li>' + escapeHtml(s) + '</li>';
                }).join('') + '</ul>');
              }
              if (rec) parts.push('<p class="kexo-score-summary-recommendation">' + rec + '</p>');
              if (parts.length === 0) parts.push('<p class="kexo-score-summary-text text-muted">No summary for this range.</p>');
              wrap.innerHTML = parts.join('');
            })
            .catch(function() {
              if (wrap) wrap.innerHTML = '<p class="kexo-score-summary-text text-muted">Summary unavailable.</p>';
            });
        })();
        var breakdownEl = document.getElementById('kexo-score-breakdown');
        disposeKexoScorePopovers(modal);
        initKexoScorePopovers(modal);
        modal.classList.remove('is-hidden');
        modal.setAttribute('aria-hidden', 'false');
        requestAnimationFrame(function() { animateKexoScoreBreakdownBars(breakdownEl); });
      }

      function closeKexoScoreModal() {
        var modal = document.getElementById('kexo-score-modal');
        if (!modal) return;
        disposeKexoScorePopovers(modal);
        disposeKexoScorePopovers(document);
        modal.classList.add('is-hidden');
        modal.setAttribute('aria-hidden', 'true');
      }

      (function initKexoScoreModalInDashboard() {
        var headerBtn = document.getElementById('header-kexo-score-wrap');
        var closeBtn = document.getElementById('kexo-score-modal-close-btn');
        var modalEl = document.getElementById('kexo-score-modal');
        function openOnClick(e) {
          e.preventDefault();
          openKexoScoreModal();
        }
        if (headerBtn) {
          headerBtn.addEventListener('click', openOnClick);
          headerBtn.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); openKexoScoreModal(); }
          });
        }
        if (closeBtn) closeBtn.addEventListener('click', closeKexoScoreModal);
        var showSummaryBtn = document.getElementById('kexo-score-show-summary-btn');
        if (showSummaryBtn) {
          showSummaryBtn.addEventListener('click', function() {
            var section = document.getElementById('kexo-score-summary-section');
            if (section) { section.classList.remove('is-hidden'); showSummaryBtn.classList.add('is-hidden'); }
          });
        }
        if (modalEl) modalEl.addEventListener('click', function(e) { if (e.target === modalEl) closeKexoScoreModal(); });
        document.addEventListener('keydown', function(e) {
          if (e.key !== 'Escape') return;
          if (!modalEl || modalEl.classList.contains('is-hidden')) return;
          if (modalEl.getAttribute('aria-hidden') === 'true') return;
          closeKexoScoreModal();
        });
      })();

      (function initTrendingChevron() {
        var toggleEl = document.getElementById('dash-trending-toggle');
        if (!toggleEl) return;
        if (typeof syncTrendingCardTitleAndChevron === 'function') syncTrendingCardTitleAndChevron();
        function doToggle(e) {
          e.preventDefault();
          e.stopPropagation();
          dashTrendingMode = dashTrendingMode === 'up' ? 'down' : 'up';
          syncTrendingCardTitleAndChevron();
          if (dashCache && typeof rerenderDashboardFromCache === 'function') {
            rerenderDashboardFromCache();
          }
        }
        toggleEl.addEventListener('click', doToggle);
        toggleEl.addEventListener('keydown', function(e) {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            doToggle(e);
          }
        });
      })();

      function fetchDashboardData(rangeKey, force, opts) {
        if (dashLoading && !force) return;
        rangeKey = (rangeKey == null ? '' : String(rangeKey)).trim().toLowerCase();
        if (!rangeKey) rangeKey = 'today';
        dashLoading = true;
        var silent = !!(opts && opts.silent);
        var reason = opts && opts.reason != null ? String(opts.reason) : '';
        var build = silent ? { step: function() {}, finish: function() {} } : startReportBuild({
          key: 'dashboard',
          title: 'Preparing dashboard overview',
          initialStep: 'Loading dashboard data',
        });
        var buildFinishTimeout = null;
        if (!silent && typeof build.finish === 'function') {
          buildFinishTimeout = setTimeout(function() {
            buildFinishTimeout = null;
            dashLoading = false;
            try { build.finish(); } catch (_) {}
          }, 35000);
        }
        var url = API + '/api/dashboard-series?range=' + encodeURIComponent(rangeKey) + (force ? ('&force=1&_=' + Date.now()) : '');
        var forceMini = !!force;
        if (silent && forceMini && String(reason || '').trim().toLowerCase() !== 'new-sale') {
          var miniAgeMs = overviewMiniFetchedAt ? (Date.now() - overviewMiniFetchedAt) : Number.POSITIVE_INFINITY;
          forceMini = miniAgeMs > OVERVIEW_MINI_FORCE_REFRESH_MS;
        }
        fetchKexoScore(rangeKey);
        try { if (typeof window.__applyDashboardKpiUiConfig === 'function') window.__applyDashboardKpiUiConfig(); } catch (_) {}
        ensureOverviewHeightSyncObserver();
        try { syncOverviewHeightGrid(); } catch (_) {}
        scheduleOverviewHeightSync();
        bindOverviewCardUiOnce();
        syncAllOverviewCardRangeUi();
        if (document.getElementById('live-online-chart') && typeof window.refreshLiveOnlineChart === 'function') {
          try { window.refreshLiveOnlineChart({ force: false }); } catch (_) {}
        }
        fetchWithTimeout(url, { credentials: 'same-origin', cache: force ? 'no-store' : 'default' }, 30000)
          .then(function(r) { return (r && r.ok) ? r.json() : null; })
          .then(function(data) {
            dashLoading = false;
            if (data) {
              var nextSig = dashboardPayloadSignature(data, rangeKey);
              var shouldRender = !!force || !(dashPayloadSignature && nextSig && nextSig === dashPayloadSignature);
              dashCache = data;
              dashLastRangeKey = rangeKey;
              dashPayloadSignature = nextSig;
              if (shouldRender || (opts && opts.rerender)) {
                build.step('Rendering dashboard panels');
                renderDashboard(data);
              }
            }
            var deferSecondary = function() {
              fetchOverviewCardData('dash-chart-overview-30d', { force: forceMini });
              requestDashboardWidgetsRefresh({ force: forceMini, rangeKey: rangeKey });
            };
            if (typeof requestAnimationFrame === 'function') requestAnimationFrame(function() { requestAnimationFrame(deferSecondary); });
            else setTimeout(deferSecondary, 0);
          })
          .catch(function(err) {
            try { if (typeof window.kexoCaptureError === 'function') window.kexoCaptureError(err, { context: 'dashboardSeries', page: PAGE }); } catch (_) {}
            dashLoading = false;
            build.step('Dashboard data unavailable');
            console.error('[dashboard] fetch error:', err);
          })
          .finally(function() {
            if (buildFinishTimeout != null) {
              try { clearTimeout(buildFinishTimeout); } catch (_) {}
              buildFinishTimeout = null;
            }
            try { build.finish(); } catch (_) {}
          });
      }

      function dashRangeKeyFromDateRange() {
        // Use the same normalized API range key as KPIs/stats so Dashboard charts/tables match the header selection.
        var rk = (typeof getStatsRange === 'function') ? getStatsRange() : ((typeof dateRange === 'string') ? dateRange : 'today');
        rk = (rk == null ? '' : String(rk)).trim().toLowerCase();
        if (!rk) rk = 'today';
        return rk;
      }

      function fmtGbp2(n) {
        var v = (typeof n === 'number') ? n : Number(n);
        if (!Number.isFinite(v)) return '\u2014';
        if (typeof formatRevenue2 === 'function') return formatRevenue2(v) || '\u2014';
        try {
          return new Intl.NumberFormat('en-GB', { style: 'currency', currency: 'GBP', minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(v);
        } catch (_) {
          return '\u00A3' + (Math.round(v * 100) / 100).toFixed(2);
        }
      }

      function widgetPresent() {
        try { return !!document.getElementById('dash-overview-widgets-grid'); } catch (_) { return false; }
      }

      function defaultOverviewWidgetsUiConfigV1() {
        var widgets = {};
        OVERVIEW_WIDGET_KEYS.forEach(function (key) {
          widgets[key] = { sortBy: 'revenue', color: '' };
        });
        widgets.finishes = Object.assign({}, widgets.finishes, { groupBy: 'finishes' });
        return { v: 1, order: OVERVIEW_WIDGET_KEYS.slice(), widgets: widgets };
      }

      function normalizeOverviewWidgetsUiConfigV1(raw) {
        var parsed = null;
        try {
          if (raw && typeof raw === 'object') parsed = raw;
          else if (typeof raw === 'string' && raw) parsed = JSON.parse(raw);
        } catch (_) { parsed = null; }
        var out = defaultOverviewWidgetsUiConfigV1();
        if (!parsed || typeof parsed !== 'object') return out;
        if (Number(parsed.v) !== 1) return out;

        try {
          if (Array.isArray(parsed.order)) {
            var seen = {};
            var next = [];
            parsed.order.forEach(function (k) {
              var key = (k == null ? '' : String(k)).trim().toLowerCase();
              if (!key) return;
              if (OVERVIEW_WIDGET_KEYS.indexOf(key) < 0) return;
              if (seen[key]) return;
              seen[key] = true;
              next.push(key);
            });
            if (next.length === OVERVIEW_WIDGET_KEYS.length) out.order = next;
          }
        } catch (_) {}

        try {
          var w = parsed.widgets && typeof parsed.widgets === 'object' ? parsed.widgets : null;
          if (w) {
            OVERVIEW_WIDGET_KEYS.forEach(function (key) {
              var row = w[key] && typeof w[key] === 'object' ? w[key] : null;
              if (!row) return;
              if (row.sortBy != null) {
                var sb = String(row.sortBy || '').trim().toLowerCase();
                if (sb === 'revenue' || sb === 'clicks' || sb === 'ctr') out.widgets[key].sortBy = sb;
              }
              if (Object.prototype.hasOwnProperty.call(row, 'color')) {
                out.widgets[key].color = cssValueFromOverride(row.color) || '';
              }
              if (key === 'finishes' && row.groupBy != null) {
                var gb = String(row.groupBy || '').trim().toLowerCase();
                if (gb) out.widgets.finishes.groupBy = gb;
              }
            });
          }
        } catch (_) {}

        return out;
      }

      function readOverviewWidgetsUiConfigV1() {
        if (ovwUiCfgLocal) return ovwUiCfgLocal;
        var fallback = defaultOverviewWidgetsUiConfigV1();
        try {
          var raw = localStorage.getItem(OVERVIEW_WIDGETS_UI_CFG_LS_KEY);
          if (!raw) return (ovwUiCfgLocal = fallback);
          return (ovwUiCfgLocal = normalizeOverviewWidgetsUiConfigV1(raw));
        } catch (_) {
          return (ovwUiCfgLocal = fallback);
        }
      }

      function cssValueFromOverride(raw) {
        var v = raw == null ? '' : String(raw).trim();
        if (!v) return '';
        if (v.length > 80) return '';
        if (/[;\r\n{}]/.test(v)) return '';
        if (/^var\(--[a-zA-Z0-9._-]+\)$/.test(v)) return v;
        if (/^#([0-9a-f]{3}|[0-9a-f]{6}|[0-9a-f]{8})$/i.test(v)) return v;
        if (/^(rgb|hsl)a?\(/i.test(v)) return v;
        if (v.toLowerCase() === 'currentcolor') return 'currentColor';
        if (v.toLowerCase() === 'transparent') return 'transparent';
        if (/^[a-z-]+$/i.test(v)) return v;
        return '';
      }

      function widgetSupportsSortBy(widgetKey, sortBy) {
        var key = String(widgetKey || '').trim().toLowerCase();
        var sb = String(sortBy || '').trim().toLowerCase();
        var row = OVERVIEW_WIDGET_SUPPORTS && OVERVIEW_WIDGET_SUPPORTS[key] ? OVERVIEW_WIDGET_SUPPORTS[key] : null;
        if (!row) return sb === 'revenue';
        if (sb === 'clicks') return row.clicks === true;
        if (sb === 'ctr') return row.ctr === true;
        return row.revenue !== false;
      }

      function applyOverviewWidgetsLayoutAndColors(cfg) {
        var grid = document.getElementById('dash-overview-widgets-grid');
        if (!grid) return;
        var normalized = normalizeOverviewWidgetsUiConfigV1(cfg || readOverviewWidgetsUiConfigV1());
        var order = Array.isArray(normalized.order) ? normalized.order.slice() : OVERVIEW_WIDGET_KEYS.slice();
        // Layout: reorder columns.
        order.forEach(function (key) {
          var col = grid.querySelector('[data-kexo-overview-widget-col="' + key + '"]');
          if (col) grid.appendChild(col);
        });
        // Colours: position-based unless overridden.
        order.forEach(function (key, idx) {
          var col = grid.querySelector('[data-kexo-overview-widget-col="' + key + '"]');
          if (!col) return;
          var card = col.querySelector('[data-kexo-overview-widget="' + key + '"]');
          if (!card || !card.style || !card.style.setProperty) return;
          var w = normalized.widgets && normalized.widgets[key] ? normalized.widgets[key] : null;
          var override = w && w.color ? String(w.color) : '';
          var accentIdx = (idx % 5) + 1;
          var css = override ? override : ('var(--kexo-accent-' + accentIdx + ')');
          card.style.setProperty('--kexo-accent', css);
          card.setAttribute('data-kexo-overview-widget-position', String(idx + 1));
        });
      }

      function upsertOverviewWidgetsUiConfig(nextCfg) {
        var merged = normalizeOverviewWidgetsUiConfigV1(nextCfg || {});
        ovwUiCfgLocal = merged;
        try { localStorage.setItem(OVERVIEW_WIDGETS_UI_CFG_LS_KEY, JSON.stringify(merged)); } catch (_) {}
        try {
          document.dispatchEvent(new CustomEvent('kexo:overviewWidgetsUiConfigUpdated', { detail: { cfg: merged } }));
        } catch (_) {}
        return merged;
      }

      function postOverviewWidgetsUiConfig(cfg) {
        var base = (typeof API === 'string') ? API : '';
        var payload = { overviewWidgetsUiConfig: normalizeOverviewWidgetsUiConfigV1(cfg || readOverviewWidgetsUiConfigV1()) };
        return fetchWithTimeout(base + '/api/settings', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'same-origin',
          body: JSON.stringify(payload),
          keepalive: true,
        }, 25000).then(function (r) {
          if (!r) return { ok: false };
          return r.json().catch(function () { return { ok: r.ok }; });
        });
      }

      function scheduleSaveOverviewWidgetsUiConfig(cfg) {
        ovwSaveQueuedCfg = cfg || ovwSaveQueuedCfg;
        if (ovwSaveTimer) clearTimeout(ovwSaveTimer);
        ovwSaveTimer = setTimeout(function () {
          ovwSaveTimer = null;
          if (ovwSaveInFlight) return;
          var next = ovwSaveQueuedCfg;
          if (!next) return;
          ovwSaveQueuedCfg = null;
          ovwSaveInFlight = postOverviewWidgetsUiConfig(next)
            .catch(function () {})
            .finally(function () {
              ovwSaveInFlight = null;
              if (ovwSaveQueuedCfg) {
                // Flush any changes that landed while in-flight.
                scheduleSaveOverviewWidgetsUiConfig(ovwSaveQueuedCfg);
              }
            });
        }, 600);
      }

      function setOvwModalMsg(text, ok) {
        var el = document.getElementById('kexo-ovw-modal-msg');
        if (!el) return;
        el.textContent = text || '';
        if (ok === true) el.className = 'form-hint text-success';
        else if (ok === false) el.className = 'form-hint text-danger';
        else el.className = 'form-hint text-secondary';
      }

      function closeOvwModal() {
        var modalEl = document.getElementById('kexo-ovw-settings-modal');
        if (!modalEl) return;
        try {
          if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
            bootstrap.Modal.getOrCreateInstance(modalEl).hide();
            return;
          }
        } catch (_) {}
        modalEl.classList.remove('show');
        modalEl.style.display = 'none';
        modalEl.setAttribute('aria-hidden', 'true');
        try {
          document.body.classList.remove('modal-open');
          if (ovwModalBackdrop && ovwModalBackdrop.parentNode) ovwModalBackdrop.parentNode.removeChild(ovwModalBackdrop);
          ovwModalBackdrop = null;
        } catch (_) {}
      }

      function showOvwModal() {
        var modalEl = document.getElementById('kexo-ovw-settings-modal');
        if (!modalEl) return;
        try {
          if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
            bootstrap.Modal.getOrCreateInstance(modalEl).show();
            return;
          }
        } catch (_) {}
        modalEl.classList.add('show');
        modalEl.style.display = 'block';
        modalEl.setAttribute('aria-hidden', 'false');
        try {
          document.body.classList.add('modal-open');
          if (!ovwModalBackdrop || !ovwModalBackdrop.parentNode) {
            ovwModalBackdrop = document.createElement('div');
            ovwModalBackdrop.className = 'modal-backdrop fade show';
            ovwModalBackdrop.addEventListener('click', function () { closeOvwModal(); });
            document.body.appendChild(ovwModalBackdrop);
          }
        } catch (_) {}
      }

      function ensureOvwModal() {
        var existing = document.getElementById('kexo-ovw-settings-modal');
        if (existing) return existing;
        var wrap = document.createElement('div');
        wrap.innerHTML =
          '<div class="modal modal-blur" id="kexo-ovw-settings-modal" tabindex="-1" aria-hidden="true">' +
            '<div class="modal-dialog modal-md modal-dialog-centered" role="dialog" aria-modal="true" aria-label="Widget settings">' +
              '<div class="modal-content">' +
                '<div class="modal-header">' +
                  '<h5 class="modal-title" id="kexo-ovw-modal-title">Widget settings</h5>' +
                  '<button type="button" class="btn-close" data-kexo-ovw-modal-close aria-label="Close"></button>' +
                '</div>' +
                '<div class="modal-body">' +
                  '<input type="hidden" id="kexo-ovw-widget-key" />' +
                  '<div class="row g-3">' +
                    '<div class="col-12">' +
                      '<label class="form-label">Sort by</label>' +
                      '<select class="form-select" id="kexo-ovw-sort-by">' +
                        '<option value="revenue">Revenue</option>' +
                        '<option value="clicks">Clicks</option>' +
                        '<option value="ctr">CTR</option>' +
                      '</select>' +
                      '<div class="form-hint" id="kexo-ovw-sort-hint"></div>' +
                    '</div>' +
                    '<div class="col-12">' +
                      '<label class="form-label">Colour</label>' +
                      '<select class="form-select" id="kexo-ovw-color">' +
                        '<option value="">Default (auto)</option>' +
                        '<option value="var(--kexo-accent-1)">Kexo accent 1</option>' +
                        '<option value="var(--kexo-accent-2)">Kexo accent 2</option>' +
                        '<option value="var(--kexo-accent-3)">Kexo accent 3</option>' +
                        '<option value="var(--kexo-accent-4)">Kexo accent 4</option>' +
                        '<option value="var(--kexo-accent-5)">Kexo accent 5</option>' +
                        '<option value="var(--tblr-primary)">Tabler primary</option>' +
                        '<option value="var(--tblr-success)">Tabler success</option>' +
                        '<option value="var(--tblr-warning)">Tabler warning</option>' +
                        '<option value="var(--tblr-danger)">Tabler danger</option>' +
                        '<option value="custom">Custom…</option>' +
                      '</select>' +
                      '<input type="text" class="form-control mt-2" id="kexo-ovw-color-custom" placeholder="#RRGGBB or var(--my-var)" maxlength="80" />' +
                    '</div>' +
                    '<div class="col-12">' +
                      '<label class="form-label">Order</label>' +
                      '<select class="form-select" id="kexo-ovw-order"></select>' +
                    '</div>' +
                    '<div class="col-12 is-hidden" id="kexo-ovw-finishes-groupby-wrap">' +
                      '<label class="form-label">Group by</label>' +
                      '<select class="form-select" id="kexo-ovw-finishes-groupby"></select>' +
                      '<div class="form-hint" id="kexo-ovw-finishes-groupby-hint"></div>' +
                    '</div>' +
                  '</div>' +
                  '<div class="d-flex align-items-center justify-content-between gap-2 mt-3">' +
                    '<button type="button" class="btn btn-outline-secondary" id="kexo-ovw-reset">Reset to default</button>' +
                    '<span id="kexo-ovw-modal-msg" class="form-hint text-secondary"></span>' +
                  '</div>' +
                '</div>' +
              '</div>' +
            '</div>' +
          '</div>';
        var modalEl = wrap.firstChild;
        document.body.appendChild(modalEl);

        function applyFromUi() {
          var key = (document.getElementById('kexo-ovw-widget-key') || {}).value || '';
          if (!key) return;
          var cfg = readOverviewWidgetsUiConfigV1();
          var next = JSON.parse(JSON.stringify(cfg || defaultOverviewWidgetsUiConfigV1()));

          var sortEl = document.getElementById('kexo-ovw-sort-by');
          var sortBy = sortEl ? String(sortEl.value || 'revenue').trim().toLowerCase() : 'revenue';
          if (!widgetSupportsSortBy(key, sortBy)) sortBy = 'revenue';
          next.widgets[key] = Object.assign({}, next.widgets[key] || {}, { sortBy: sortBy });

          var colorEl = document.getElementById('kexo-ovw-color');
          var customEl = document.getElementById('kexo-ovw-color-custom');
          var colorVal = colorEl ? String(colorEl.value || '') : '';
          var color = '';
          if (colorVal === 'custom') color = cssValueFromOverride(customEl ? customEl.value : '') || '';
          else color = cssValueFromOverride(colorVal) || '';
          next.widgets[key] = Object.assign({}, next.widgets[key] || {}, { color: color });

          var orderEl = document.getElementById('kexo-ovw-order');
          var pos = orderEl ? parseInt(orderEl.value, 10) : 0;
          if (!Number.isFinite(pos) || pos < 1) pos = 1;
          pos = Math.min(OVERVIEW_WIDGET_KEYS.length, Math.max(1, pos));
          var order = Array.isArray(next.order) ? next.order.slice() : OVERVIEW_WIDGET_KEYS.slice();
          var curIdx = order.indexOf(key);
          if (curIdx >= 0) order.splice(curIdx, 1);
          order.splice(pos - 1, 0, key);
          next.order = order;

          if (key === 'finishes') {
            var gbEl = document.getElementById('kexo-ovw-finishes-groupby');
            var gb = gbEl ? String(gbEl.value || 'finishes').trim().toLowerCase() : 'finishes';
            next.widgets.finishes = Object.assign({}, next.widgets.finishes || {}, { groupBy: gb || 'finishes' });
          }

          next = normalizeOverviewWidgetsUiConfigV1(next);
          upsertOverviewWidgetsUiConfig(next);
          applyOverviewWidgetsLayoutAndColors(next);
          scheduleSaveOverviewWidgetsUiConfig(next);
          requestDashboardWidgetsRefresh({ force: false, rangeKey: dashRangeKeyFromDateRange() });
          setOvwModalMsg('Saved.', true);
        }

        modalEl.addEventListener('click', function (e) {
          var t = e && e.target ? e.target : null;
          if (!t || !t.closest) return;
          if (t.closest('[data-kexo-ovw-modal-close]')) {
            e.preventDefault();
            closeOvwModal();
            return;
          }
          if (t.closest('#kexo-ovw-reset')) {
            e.preventDefault();
            var key = (document.getElementById('kexo-ovw-widget-key') || {}).value || '';
            if (!key) return;
            var cfg = readOverviewWidgetsUiConfigV1();
            var next = JSON.parse(JSON.stringify(cfg || defaultOverviewWidgetsUiConfigV1()));
            if (next.widgets && next.widgets[key]) next.widgets[key].color = '';
            if (next.widgets && next.widgets[key]) next.widgets[key].sortBy = 'revenue';
            if (key === 'finishes') next.widgets.finishes.groupBy = 'finishes';
            next = normalizeOverviewWidgetsUiConfigV1(next);
            upsertOverviewWidgetsUiConfig(next);
            applyOverviewWidgetsLayoutAndColors(next);
            scheduleSaveOverviewWidgetsUiConfig(next);
            requestDashboardWidgetsRefresh({ force: false, rangeKey: dashRangeKeyFromDateRange() });
            openOvwSettings(key);
            setOvwModalMsg('Reset.', true);
          }
        });
        ['change', 'input'].forEach(function (evt) {
          modalEl.addEventListener(evt, function (e) {
            var t = e && e.target ? e.target : null;
            if (!t) return;
            if (t.id === 'kexo-ovw-sort-by' || t.id === 'kexo-ovw-color' || t.id === 'kexo-ovw-color-custom' || t.id === 'kexo-ovw-order' || t.id === 'kexo-ovw-finishes-groupby') {
              applyFromUi();
            }
          });
        });
        return modalEl;
      }

      function openOvwSettings(widgetKeyOrBtn) {
        var key = '';
        if (typeof widgetKeyOrBtn === 'string') key = widgetKeyOrBtn;
        else {
          try {
            var btn = widgetKeyOrBtn;
            var card = btn && btn.closest ? btn.closest('[data-kexo-overview-widget]') : null;
            key = card ? String(card.getAttribute('data-kexo-overview-widget') || '') : '';
          } catch (_) { key = ''; }
        }
        key = String(key || '').trim().toLowerCase();
        if (OVERVIEW_WIDGET_KEYS.indexOf(key) < 0) return;
        ovwSettingsKey = key;
        var modalEl = ensureOvwModal();
        var cfg = readOverviewWidgetsUiConfigV1();
        cfg = normalizeOverviewWidgetsUiConfigV1(cfg);
        var title = document.getElementById('kexo-ovw-modal-title');
        if (title) title.textContent = (OVERVIEW_WIDGET_TITLES[key] || 'Widget') + ' settings';
        var keyEl = document.getElementById('kexo-ovw-widget-key');
        if (keyEl) keyEl.value = key;
        var sortEl = document.getElementById('kexo-ovw-sort-by');
        var hintEl = document.getElementById('kexo-ovw-sort-hint');
        var sortBy = cfg.widgets && cfg.widgets[key] && cfg.widgets[key].sortBy ? String(cfg.widgets[key].sortBy) : 'revenue';
        if (sortEl) {
          Array.prototype.forEach.call(sortEl.options || [], function (opt) {
            if (!opt || !opt.value) return;
            var supported = widgetSupportsSortBy(key, opt.value);
            opt.disabled = !supported;
          });
          if (!widgetSupportsSortBy(key, sortBy)) sortBy = 'revenue';
          sortEl.value = sortBy;
          if (hintEl) hintEl.textContent = widgetSupportsSortBy(key, 'ctr') ? '' : 'CTR is not available for this widget.';
        }
        var wrapGb = document.getElementById('kexo-ovw-finishes-groupby-wrap');
        if (wrapGb) wrapGb.classList.toggle('is-hidden', key !== 'finishes');
        if (key === 'finishes') {
          var gbEl = document.getElementById('kexo-ovw-finishes-groupby');
          var gbHint = document.getElementById('kexo-ovw-finishes-groupby-hint');
          var selected = (cfg.widgets && cfg.widgets.finishes && cfg.widgets.finishes.groupBy) ? String(cfg.widgets.finishes.groupBy) : 'finishes';
          if (gbEl) {
            gbEl.innerHTML = '<option value="finishes">Finishes</option>';
            gbEl.value = selected || 'finishes';
          }
          if (gbHint) gbHint.textContent = 'Loading tables…';
          (function () {
            var rk = dashRangeKeyFromDateRange();
            getOvwFinishesTablesMeta(rk, false).then(function (tables) {
              if (!gbEl) return;
              var list = Array.isArray(tables) ? tables : [];
              if (!list.length) {
                if (gbHint) gbHint.textContent = '';
                return;
              }
              var html = '';
              list.forEach(function (t) {
                if (!t) return;
                var id = t.id != null ? String(t.id) : '';
                var name = t.name != null ? String(t.name) : id;
                if (!id) return;
                html += '<option value="' + escapeHtml(id) + '">' + escapeHtml(name || id) + '</option>';
              });
              if (!html) html = '<option value="finishes">Finishes</option>';
              gbEl.innerHTML = html;
              var next = (selected || 'finishes');
              var found = false;
              try {
                Array.prototype.forEach.call(gbEl.options || [], function (opt) {
                  if (opt && String(opt.value) === String(next)) found = true;
                });
              } catch (_) { found = false; }
              if (!found) next = String(list[0] && list[0].id ? list[0].id : 'finishes');
              gbEl.value = next;
              if (gbHint) gbHint.textContent = '';
            }).catch(function () {
              if (gbHint) gbHint.textContent = '';
            });
          })();
        }
        var orderEl = document.getElementById('kexo-ovw-order');
        if (orderEl) {
          var order = Array.isArray(cfg.order) ? cfg.order : OVERVIEW_WIDGET_KEYS.slice();
          var curPos = Math.max(1, order.indexOf(key) + 1);
          var html = '';
          for (var i = 1; i <= OVERVIEW_WIDGET_KEYS.length; i++) {
            html += '<option value="' + i + '">' + i + '</option>';
          }
          orderEl.innerHTML = html;
          orderEl.value = String(curPos);
        }
        var colorEl = document.getElementById('kexo-ovw-color');
        var customEl = document.getElementById('kexo-ovw-color-custom');
        var c = cfg.widgets && cfg.widgets[key] && cfg.widgets[key].color ? String(cfg.widgets[key].color) : '';
        if (colorEl) {
          colorEl.value = c && (Array.prototype.some.call(colorEl.options || [], function (opt) { return opt && opt.value === c; })) ? c : '';
          if (c && colorEl.value !== c) colorEl.value = 'custom';
        }
        if (customEl) customEl.value = (c && (colorEl && colorEl.value === 'custom')) ? c : '';
        setOvwModalMsg('', null);
        void modalEl;
        showOvwModal();
      }

      function bindDashWidgetsOnce() {
        if (dashWidgetsBound) return;
        dashWidgetsBound = true;
        try { applyOverviewWidgetsLayoutAndColors(readOverviewWidgetsUiConfigV1()); } catch (_) {}
        try {
          document.addEventListener('click', function (e) {
            var t = e && e.target ? e.target : null;
            if (!t || !t.closest) return;
            var btn = t.closest('[data-kexo-overview-widget-settings]');
            if (!btn) return;
            e.preventDefault();
            e.stopPropagation();
            openOvwSettings(btn);
          });
        } catch (_) {}
        try {
          document.addEventListener('keydown', function (e) {
            if (!e || e.key !== 'Escape') return;
            closeOvwModal();
          });
        } catch (_) {}
        try {
          document.addEventListener('kexo:overviewWidgetsUiConfigUpdated', function () {
            try { applyOverviewWidgetsLayoutAndColors(readOverviewWidgetsUiConfigV1()); } catch (_) {}
            try { requestDashboardWidgetsRefresh({ force: false, rangeKey: dashRangeKeyFromDateRange() }); } catch (_) {}
          });
        } catch (_) {}
        try {
          document.addEventListener('kexo:cssVarOverridesUpdated', function () {
            try { applyOverviewWidgetsLayoutAndColors(readOverviewWidgetsUiConfigV1()); } catch (_) {}
            try { requestDashboardWidgetsRefresh({ force: false, rangeKey: dashRangeKeyFromDateRange() }); } catch (_) {}
          });
        } catch (_) {}
      }

      function setWidgetEmpty(mountId, msg) {
        var el = document.getElementById(mountId);
        if (!el) return;
        el.innerHTML = '<div class="kexo-widget-empty">' + escapeHtml(msg || 'No data') + '</div>';
      }

      function widgetSig(data) {
        try { return fastPayloadHash(JSON.stringify(data || null) || ''); } catch (_) { return fastPayloadHash(String(Date.now())); }
      }

      function fetchWidgetJson(cacheKey, url, force, timeoutMs) {
        var key = String(cacheKey || '').trim();
        if (!key || !url) return Promise.resolve(null);
        var now = Date.now();
        var entry = dashWidgetCache && dashWidgetCache[key] ? dashWidgetCache[key] : null;
        var fresh = !force && entry && entry.data && entry.fetchedAt && (now - entry.fetchedAt) < DASH_WIDGET_CACHE_TTL_MS;
        if (fresh) return Promise.resolve(entry.data);
        if (dashWidgetInFlight[key] && !force) return dashWidgetInFlight[key];
        dashWidgetInFlight[key] = fetchWithTimeout(url, { credentials: 'same-origin', cache: force ? 'no-store' : 'default' }, timeoutMs || 25000)
          .then(function(r) { return (r && r.ok) ? r.json() : null; })
          .then(function(data) {
            if (!data) return null;
            dashWidgetCache[key] = { fetchedAt: Date.now(), sig: widgetSig(data), data: data };
            return data;
          })
          .catch(function() { return entry && entry.data ? entry.data : null; })
          .finally(function() { dashWidgetInFlight[key] = null; });
        return dashWidgetInFlight[key];
      }

      function getOvwFinishesTablesMeta(rangeKey, force) {
        var rk = (rangeKey != null ? String(rangeKey) : dashRangeKeyFromDateRange());
        rk = (rk == null ? '' : String(rk)).trim().toLowerCase() || 'today';
        var shop = null;
        try { shop = getShopForSales(); } catch (_) { shop = null; }
        var shopKey = shop ? String(shop) : '';
        var base = (typeof API === 'string') ? API : '';
        var url = base + '/api/insights-variants?range=' + encodeURIComponent(rk) +
          (shopKey ? ('&shop=' + encodeURIComponent(shopKey)) : '') +
          (force ? ('&force=1&_=' + Date.now()) : '');
        var cacheKey = 'finishes|' + rk + '|' + shopKey;
        return fetchWidgetJson(cacheKey, url, !!force, 30000).then(function (data) {
          var payload = (data && data.ok && data.payload) ? data.payload : data;
          var tables = payload && Array.isArray(payload.tables) ? payload.tables : (Array.isArray(data && data.tables) ? data.tables : []);
          var out = [];
          (tables || []).forEach(function (t) {
            if (!t) return;
            var id = t.id != null ? String(t.id).trim() : '';
            if (!id) return;
            var name = t.name != null ? String(t.name) : id;
            out.push({ id: id, name: name || id });
          });
          return out;
        }).catch(function () {
          return [];
        });
      }

      function renderDashTopList(mountId, rows, options) {
        var host = document.getElementById(mountId);
        if (!host) return;
        var list = Array.isArray(rows) ? rows : [];
        var opts = (options && typeof options === 'object') ? options : {};
        var accentCss = opts.accentCss ? String(opts.accentCss) : '';
        if (!list.length) {
          host.innerHTML = '<div class="kexo-dash-top-list-wrap"><div class="kexo-widget-empty">No data</div></div>';
          return;
        }
        var html = '<ul class="kexo-dash-top-list">';
        list.forEach(function (r) {
          if (!r) return;
          var label = r.label != null ? String(r.label) : '—';
          var valueGbp = r.valueGbp != null ? Number(r.valueGbp) : (r.value != null ? Number(r.value) : 0);
          var pct = r.pct != null ? Number(r.pct) : 0;
          var cr = r.cr != null && Number.isFinite(Number(r.cr)) ? Number(r.cr) : null;
          if (!Number.isFinite(valueGbp)) valueGbp = 0;
          if (!Number.isFinite(pct)) pct = 0;
          pct = Math.max(0, Math.min(100, pct));
          var crText = cr != null ? (typeof fmtPct === 'function' ? fmtPct(cr) : (Math.round(cr * 10) / 10) + '%') + ' CR' : '—';
          var valueText = (r.valueDisplay != null && String(r.valueDisplay) !== '') ? String(r.valueDisplay) : (typeof fmtGbp === 'function' ? fmtGbp(valueGbp) : String(valueGbp));
          var valueClass = (r.valueClass != null && String(r.valueClass)) ? (' ' + String(r.valueClass).trim()) : '';
          var iconHtml = r.iconHtml != null ? String(r.iconHtml) : '';
          if (r.thumbUrl) {
            var thumbImg = '<img src="' + escapeHtml(String(r.thumbUrl)) + '" alt="" width="40" height="40" class="kexo-dash-top-thumb" loading="lazy">';
            var canOpen = (r.productHandle && String(r.productHandle)) || (r.productId && String(r.productId));
            var productUrl = (r.productUrl != null && String(r.productUrl) !== '' && String(r.productUrl) !== '#') ? String(r.productUrl) : '#';
            if (canOpen) {
              iconHtml = '<a class="kexo-product-link kexo-dash-top-thumb-link js-product-modal-link" href="' + escapeHtml(productUrl) + '" target="_blank" rel="noopener"' +
                (r.productHandle ? (' data-product-handle="' + escapeHtml(String(r.productHandle)) + '"') : '') +
                (r.productId ? (' data-product-id="' + escapeHtml(String(r.productId)) + '"') : '') +
                (r.productTitle != null ? (' data-product-title="' + escapeHtml(String(r.productTitle)) + '"') : '') +
                '>' + thumbImg + '</a>';
            } else {
              iconHtml = thumbImg;
            }
          }
          if (!iconHtml) iconHtml = '<span class="kexo-dash-top-row-icon-placeholder" aria-hidden="true"></span>';
          html += '<li class="kexo-dash-top-row" title="' + escapeHtml(label) + '">' +
            '<span class="kexo-dash-top-row-icon" aria-hidden="true">' + iconHtml + '</span>' +
            '<span class="kexo-dash-top-row-label">' + escapeHtml(label) + '</span>' +
            '<span class="kexo-dash-top-row-cr">' + escapeHtml(crText) + '</span>' +
            '<span class="kexo-dash-top-row-value' + valueClass + '">' + escapeHtml(valueText) + '</span>' +
            '<div class="kexo-dash-top-row-bar"><span style="' + (accentCss ? escapeHtml(accentCss) : '') + '" data-kexo-bar-fill="' + escapeHtml(String(pct)) + '"></span></div>' +
          '</li>';
        });
        html += '</ul>';
        host.innerHTML = '<div class="kexo-dash-top-list-wrap">' + html + '</div>';
        animateWidgetFills(host);
      }

      function animateWidgetFills(root) {
        if (!root || !root.querySelectorAll) return;
        try {
          var fills = root.querySelectorAll('[data-kexo-bar-fill]');
          if (!fills || !fills.length) return;
          requestAnimationFrame(function () {
            Array.prototype.forEach.call(fills, function (el) {
              var pct = Number(el.getAttribute('data-kexo-bar-fill') || 0);
              if (!Number.isFinite(pct)) pct = 0;
              pct = Math.max(0, Math.min(100, pct));
              if (el.classList.contains('kexo-widget-vbar-fill')) el.style.height = pct + '%';
              else el.style.width = pct + '%';
            });
          });
        } catch (_) {}
      }

      function renderWidgetList(mountId, rows, accentCss) {
        var host = document.getElementById(mountId);
        if (!host) return;
        var list = Array.isArray(rows) ? rows : [];
        if (!list.length) { setWidgetEmpty(mountId, 'No data'); return; }
        var html = '<ul class="kexo-widget-list">';
        list.forEach(function (r) {
          if (!r) return;
          var label = r.label != null ? String(r.label) : '';
          var value = r.valueGbp != null ? Number(r.valueGbp) : Number(r.value);
          var pct = r.pct != null ? Number(r.pct) : 0;
          var placeholder = !!(r && r.placeholder === true);
          if (!Number.isFinite(value)) value = 0;
          if (!Number.isFinite(pct)) pct = 0;
          pct = Math.max(0, Math.min(100, pct));
          var icon = r.iconHtml != null ? String(r.iconHtml) : '';
          var tip = placeholder
            ? ((label ? (label + '\n') : '') + 'No data yet')
            : ((label ? (label + '\n') : '') + 'Revenue: ' + fmtGbp2(value) + '\nShare: ' + (Math.round(pct * 10) / 10).toFixed(1) + '%');
          var valueText = placeholder ? '\u2014' : fmtGbp2(value);
          html += '<li class="kexo-widget-row" title="' + escapeHtml(tip) + '">' +
            '<span class="kexo-widget-row-icon" aria-hidden="true">' + icon + '</span>' +
            '<span class="kexo-widget-row-label">' + escapeHtml(label || '—') + '</span>' +
            '<span class="kexo-widget-row-value">' + escapeHtml(valueText) + '</span>' +
            '<div class="kexo-widget-row-bar"><span style="' + (accentCss ? escapeHtml(accentCss) : '') + '"' +
              (placeholder ? ' data-kexo-placeholder="1"' : '') +
              ' data-kexo-bar-fill="' + escapeHtml(String(pct)) + '"></span></div>' +
          '</li>';
        });
        html += '</ul>';
        host.innerHTML = html;
        animateWidgetFills(host);
      }

      function renderWidgetVbars(mountId, rows, accentCss) {
        var host = document.getElementById(mountId);
        if (!host) return;
        var list = Array.isArray(rows) ? rows : [];
        if (!list.length) { setWidgetEmpty(mountId, 'No data'); return; }
        var html = '<div class="kexo-widget-vbars"><div class="kexo-widget-vbars-grid">';
        list.forEach(function (r) {
          if (!r) return;
          var label = r.label != null ? String(r.label) : '';
          var value = r.valueGbp != null ? Number(r.valueGbp) : Number(r.value);
          var pct = r.pct != null ? Number(r.pct) : 0;
          var icon = r.iconHtml != null ? String(r.iconHtml) : '';
          var placeholder = !!(r && r.placeholder === true);
          if (!Number.isFinite(value)) value = 0;
          if (!Number.isFinite(pct)) pct = 0;
          pct = Math.max(0, Math.min(100, pct));
          var tip = placeholder
            ? ((label ? (label + '\n') : '') + 'No data yet')
            : ((label ? (label + '\n') : '') + 'Value: ' + fmtGbp2(value) + '\nShare: ' + (Math.round(pct * 10) / 10).toFixed(1) + '%');
          html += '<div class="kexo-widget-vbar" title="' + escapeHtml(tip) + '">' +
            '<div class="kexo-widget-vbar-col"><div class="kexo-widget-vbar-fill" style="' + (accentCss ? escapeHtml(accentCss) : '') + '"' +
              (placeholder ? ' data-kexo-placeholder="1"' : '') +
              ' data-kexo-bar-fill="' + escapeHtml(String(pct)) + '"></div></div>' +
            '<div class="kexo-widget-vbar-label">' +
              (icon ? ('<span class="kexo-widget-vbar-icon" aria-hidden="true">' + icon + '</span>') : '') +
              '<span class="kexo-widget-vbar-text">' + escapeHtml(label || '—') + '</span>' +
            '</div>' +
          '</div>';
        });
        html += '</div></div>';
        host.innerHTML = html;
        animateWidgetFills(host);
      }

      function animateWidgetRadials(root) {
        if (!root || !root.querySelectorAll) return;
        try {
          var nodes = root.querySelectorAll('[data-kexo-radial-pct][data-kexo-radial-circ]');
          if (!nodes || !nodes.length) return;
          requestAnimationFrame(function () {
            Array.prototype.forEach.call(nodes, function (el) {
              var pct = Number(el.getAttribute('data-kexo-radial-pct') || 0);
              var circ = Number(el.getAttribute('data-kexo-radial-circ') || 0);
              if (!Number.isFinite(pct)) pct = 0;
              if (!Number.isFinite(circ) || circ <= 0) return;
              pct = Math.max(0, Math.min(100, pct));
              var off = circ * (1 - (pct / 100));
              el.style.strokeDashoffset = String(off);
            });
          });
        } catch (_) {}
      }

      function sortRowsByValueDesc(rows) {
        var list = Array.isArray(rows) ? rows.slice() : [];
        list.sort(function (a, b) {
          var av = a && (a.valueGbp != null ? Number(a.valueGbp) : Number(a.value));
          var bv = b && (b.valueGbp != null ? Number(b.valueGbp) : Number(b.value));
          if (!Number.isFinite(av)) av = 0;
          if (!Number.isFinite(bv)) bv = 0;
          return bv - av;
        });
        return list;
      }

      function withSharePct(rows, limit) {
        var list = sortRowsByValueDesc(rows);
        var top = list.slice(0, Math.max(0, Number(limit) || 0));
        var total = top.reduce(function (acc, r) {
          var v = r && (r.valueGbp != null ? Number(r.valueGbp) : Number(r.value));
          if (!Number.isFinite(v)) v = 0;
          return acc + v;
        }, 0) || 0;
        return top.map(function (r) {
          var v = r && (r.valueGbp != null ? Number(r.valueGbp) : Number(r.value));
          if (!Number.isFinite(v)) v = 0;
          var pct = total > 0 ? (v / total) * 100 : 0;
          var out = Object.assign({}, r, { valueGbp: (r && r.valueGbp != null) ? v : undefined, value: (r && r.valueGbp != null) ? undefined : v, pct: pct });
          return out;
        });
      }

      function makePlaceholderRowsFromYesterday(yesterdayRows, limit) {
        var yTop = sortRowsByValueDesc(yesterdayRows).slice(0, Math.max(0, Number(limit) || 0));
        return yTop.map(function (r) {
          return {
            label: r && r.label != null ? String(r.label) : '—',
            iconHtml: r && r.iconHtml != null ? String(r.iconHtml) : '',
            valueGbp: 0,
            pct: 0,
            placeholder: true,
          };
        });
      }

      function mergeCurrentWithPlaceholders(currentRows, placeholderRows, limit) {
        var lim = Math.max(0, Number(limit) || 0);
        var cur = Array.isArray(currentRows) ? currentRows.slice(0, lim) : [];
        var ph = Array.isArray(placeholderRows) ? placeholderRows : [];
        var out = cur.slice();
        for (var i = out.length; i < lim; i++) {
          out.push(ph[i] || { label: '—', iconHtml: '', valueGbp: 0, pct: 0, placeholder: true });
        }
        return out.slice(0, lim);
      }

      function renderWidgetRadialAndVbars(mountId, topRow, barRows, opts) {
        var host = document.getElementById(mountId);
        if (!host) return;
        if (!topRow) { setWidgetEmpty(mountId, 'No data'); return; }
        var options = (opts && typeof opts === 'object') ? opts : {};
        var accentCss = options.accentCss ? String(options.accentCss) : '';
        var ringStrokeCss = options.ringStroke ? String(options.ringStroke) : 'var(--kexo-accent-1, #4b94e4)';
        var placeholder = !!(topRow && topRow.placeholder === true);
        var pct = topRow.pct != null ? Number(topRow.pct) : 0;
        if (!Number.isFinite(pct)) pct = 0;
        pct = Math.max(0, Math.min(100, pct));
        var label = topRow.label != null ? String(topRow.label) : '';
        var value = topRow.valueGbp != null ? Number(topRow.valueGbp) : Number(topRow.value);
        if (!Number.isFinite(value)) value = 0;
        var icon = topRow.iconHtml != null ? String(topRow.iconHtml) : '';

        var size = 180;
        var r = 72;
        var strokeW = 12;
        var cx = Math.round(size / 2);
        var cy = Math.round(size / 2);
        var circ = Math.round(2 * Math.PI * r * 1000) / 1000;
        var tip = placeholder
          ? ((label ? (label + '\n') : '') + 'No data yet')
          : ((label ? (label + '\n') : '') + 'Value: ' + fmtGbp2(value) + '\nShare: ' + (Math.round(pct * 10) / 10).toFixed(1) + '%');

        var radialStroke = placeholder ? 'rgba(15,23,42,0.20)' : ringStrokeCss;
        var valText = placeholder ? '\u2014' : fmtGbp2(value);
        var pctText = placeholder ? '\u2014' : (String(Math.round(pct)) + '%');

        var topHtml =
          '<div class="kexo-widget-radial-centered d-flex flex-column align-items-center text-center">' +
            '<div class="position-relative flex-shrink-0 kexo-widget-radial-wrap" style="width:' + size + 'px;height:' + size + 'px" title="' + escapeHtml(tip) + '">' +
              '<svg width="' + size + '" height="' + size + '" viewBox="0 0 ' + size + ' ' + size + '" aria-hidden="true">' +
                '<circle cx="' + cx + '" cy="' + cy + '" r="' + r + '" fill="none" stroke="rgba(15,23,42,0.10)" stroke-width="' + strokeW + '"></circle>' +
                '<circle cx="' + cx + '" cy="' + cy + '" r="' + r + '" fill="none" stroke="' + escapeHtml(radialStroke) + '" stroke-width="' + strokeW + '" stroke-linecap="round"' +
                  ' style="transform: rotate(-90deg); transform-origin: ' + cx + 'px ' + cy + 'px; transition: stroke-dashoffset 520ms cubic-bezier(.2,.9,.2,1);"' +
                  ' stroke-dasharray="' + escapeHtml(String(circ)) + '" stroke-dashoffset="' + escapeHtml(String(circ)) + '"' +
                  ' data-kexo-radial-pct="' + escapeHtml(String(placeholder ? 0 : pct)) + '" data-kexo-radial-circ="' + escapeHtml(String(circ)) + '"' +
                '></circle>' +
              '</svg>' +
              '<div class="position-absolute top-50 start-50 translate-middle text-center kexo-widget-radial-inner">' +
                (icon ? '<div class="kexo-widget-radial-icon mb-1">' + icon + '</div>' : '') +
                '<div class="fw-bold kexo-widget-radial-pct">' + escapeHtml(pctText) + '</div>' +
                '<div class="text-muted small kexo-widget-radial-revenue">' + escapeHtml(valText) + '</div>' +
              '</div>' +
            '</div>' +
            '<div class="fw-semibold text-truncate mt-2 kexo-widget-radial-label" style="max-width:100%" title="' + escapeHtml(label) + '">' + escapeHtml(label || '—') + '</div>' +
          '</div>';

        host.innerHTML = topHtml + '<div class="mt-3" id="' + escapeHtml(mountId + '-list') + '"></div>';
        var listRows = Array.isArray(barRows) ? barRows.slice(1, 4) : [];
        renderWidgetList(mountId + '-list', listRows, accentCss);
        animateWidgetRadials(host);
        var card = host.closest('.kexo-widget-card[data-kexo-widget]');
        if (card && Array.isArray(barRows)) {
          var revenue = barRows.reduce(function (acc, r) { return acc + (Number(r && r.valueGbp) || 0); }, 0) || 0;
          var sessions = options.sessions != null ? Number(options.sessions) : 0;
          var conversion = options.conversionPct != null ? Number(options.conversionPct) : 0;
          if (!Number.isFinite(sessions)) sessions = 0;
          if (!Number.isFinite(conversion)) conversion = 0;
          card.setAttribute('data-kexo-widget-revenue', String(revenue));
          card.setAttribute('data-kexo-widget-sessions', String(sessions));
          card.setAttribute('data-kexo-widget-conversion', String(conversion));
        }
      }

      function polarToCartesian(cx, cy, r, angleDeg) {
        var a = (angleDeg - 90) * Math.PI / 180.0;
        return { x: cx + (r * Math.cos(a)), y: cy + (r * Math.sin(a)) };
      }

      function donutSegmentPath(cx, cy, rOuter, rInner, startAngle, endAngle) {
        var startOuter = polarToCartesian(cx, cy, rOuter, endAngle);
        var endOuter = polarToCartesian(cx, cy, rOuter, startAngle);
        var startInner = polarToCartesian(cx, cy, rInner, startAngle);
        var endInner = polarToCartesian(cx, cy, rInner, endAngle);
        var large = (endAngle - startAngle) <= 180 ? '0' : '1';
        return [
          'M', startOuter.x, startOuter.y,
          'A', rOuter, rOuter, 0, large, 0, endOuter.x, endOuter.y,
          'L', startInner.x, startInner.y,
          'A', rInner, rInner, 0, large, 1, endInner.x, endInner.y,
          'Z'
        ].join(' ');
      }

      function renderWidgetDonutWithLegend(mountId, rows) {
        var host = document.getElementById(mountId);
        if (!host) return;
        var list = Array.isArray(rows) ? rows : [];
        if (!list.length) { setWidgetEmpty(mountId, 'No data'); return; }
        var total = list.reduce(function (acc, r) { return acc + (Number(r && r.valueGbp) || 0); }, 0) || 0;
        var colors = ['#4b94e4', '#3eb3ab', '#f59e0b', '#8b5cf6', '#e4644b'];
        var cx = 60, cy = 60, rOuter = 46, rInner = 30;
        var angle = 0;
        var svg = '<svg width="120" height="120" viewBox="0 0 120 120" aria-hidden="true">';
        list.forEach(function (r, idx) {
          var v = Number(r && r.valueGbp) || 0;
          var pct = total > 0 ? (v / total) : 0;
          var delta = pct * 360;
          var start = angle;
          var end = angle + delta;
          angle = end;
          if (delta <= 0) return;
          var d = donutSegmentPath(cx, cy, rOuter, rInner, start, end);
          var label = r && r.label != null ? String(r.label) : '—';
          var tip = label + '\nRevenue: ' + fmtGbp2(v) + '\nShare: ' + (Math.round(pct * 1000) / 10).toFixed(1) + '%';
          svg += '<path d="' + escapeHtml(d) + '" fill="' + escapeHtml(colors[idx % colors.length]) + '">' +
            '<title>' + escapeHtml(tip) + '</title>' +
          '</path>';
        });
        svg += '<circle cx="' + cx + '" cy="' + cy + '" r="' + rInner + '" fill="var(--tblr-card-bg, #ffffff)"></circle>';
        svg += '<text x="' + cx + '" y="' + (cy - 2) + '" text-anchor="middle" font-size="12" font-weight="700" fill="#0f172a">' + escapeHtml(fmtGbp2(total)) + '</text>';
        svg += '<text x="' + cx + '" y="' + (cy + 14) + '" text-anchor="middle" font-size="10" fill="rgba(15,23,42,0.6)">total</text>';
        svg += '</svg>';

        var legend = '<ul class="kexo-widget-list" style="margin-top:0.25rem">';
        list.forEach(function (r, idx) {
          var label = r && r.label != null ? String(r.label) : '—';
          var v = Number(r && r.valueGbp) || 0;
          legend += '<li class="kexo-widget-row">' +
            '<span class="kexo-widget-row-icon" aria-hidden="true"><span style="display:inline-block;width:10px;height:10px;border-radius:999px;background:' + escapeHtml(colors[idx % colors.length]) + '"></span></span>' +
            '<span class="kexo-widget-row-label">' + escapeHtml(label) + '</span>' +
            '<span class="kexo-widget-row-value">' + escapeHtml(fmtGbp2(v)) + '</span>' +
          '</li>';
        });
        legend += '</ul>';

        host.innerHTML = '<div class="d-flex flex-column align-items-center">' + svg + '</div>' + legend;
      }

      function requestDashboardWidgetsRefresh(opts) {
        if (!widgetPresent()) return;
        bindDashWidgetsOnce();
        try { applyOverviewWidgetsLayoutAndColors(readOverviewWidgetsUiConfigV1()); } catch (_) {}
        var next = opts && typeof opts === 'object' ? Object.assign({}, opts) : {};
        dashWidgetsPendingOpts = dashWidgetsPendingOpts ? Object.assign(dashWidgetsPendingOpts, next) : next;
        if (dashWidgetsRefreshTimer) return;
        dashWidgetsRefreshTimer = setTimeout(function () {
          dashWidgetsRefreshTimer = null;
          var pending = dashWidgetsPendingOpts || {};
          dashWidgetsPendingOpts = null;
          refreshDashboardWidgetsNow(pending);
        }, 160);
      }

      function refreshDashboardWidgetsNow(opts) {
        if (!widgetPresent()) return;
        bindDashWidgetsOnce();
        var options = opts && typeof opts === 'object' ? opts : {};
        var force = !!options.force;
        var rk = options.rangeKey != null ? String(options.rangeKey) : dashRangeKeyFromDateRange();
        rk = (rk == null ? '' : String(rk)).trim().toLowerCase() || 'today';
        var cfg = normalizeOverviewWidgetsUiConfigV1(readOverviewWidgetsUiConfigV1());
        try { applyOverviewWidgetsLayoutAndColors(cfg); } catch (_) {}

        var shop = null;
        try { shop = getShopForSales(); } catch (_) { shop = null; }
        var shopKey = shop ? String(shop) : '';
        var base = (typeof API === 'string') ? API : '';

        var urls = {
          finishes: base + '/api/insights-variants?range=' + encodeURIComponent(rk) + (shopKey ? ('&shop=' + encodeURIComponent(shopKey)) : '') + (force ? ('&force=1&_=' + Date.now()) : ''),
          devices: base + '/api/devices/report?range=' + encodeURIComponent(rk) + (force ? ('&force=1&_=' + Date.now()) : ''),
          browsers: base + '/api/browsers/table?range=' + encodeURIComponent(rk) + (force ? ('&force=1&_=' + Date.now()) : ''),
          attribution: base + '/api/attribution/report?range=' + encodeURIComponent(rk) + (force ? ('&force=1&_=' + Date.now()) : ''),
          payment_methods: base + '/api/payment-methods/report?range=' + encodeURIComponent(rk) + (force ? ('&force=1&_=' + Date.now()) : ''),
          abandoned: base + '/api/abandoned-carts/top-countries?range=' + encodeURIComponent(rk) + (force ? ('&force=1&_=' + Date.now()) : ''),
        };

        var TOP_N = 4;

        function resolveRootCssVar(name, fallback) {
          try {
            var v = getComputedStyle(document.documentElement).getPropertyValue(String(name || '')).trim();
            return v || (fallback || '');
          } catch (_) {
            return fallback || '';
          }
        }

        function resolveCssColor(spec) {
          var v = spec == null ? '' : String(spec).trim();
          if (!v) return '';
          var m = v.match(/^var\((--[a-zA-Z0-9._-]+)\)$/);
          if (m) return resolveRootCssVar(m[1], '') || '';
          return v;
        }

        function accentForWidget(widgetKey) {
          var key = String(widgetKey || '').trim().toLowerCase();
          var card = null;
          try { card = document.querySelector('[data-kexo-overview-widget="' + key + '"]'); } catch (_) { card = null; }
          var css = '';
          try { css = card && card.style ? String(card.style.getPropertyValue('--kexo-accent') || '').trim() : ''; } catch (_) { css = ''; }
          if (!css) {
            var idx = (cfg && Array.isArray(cfg.order)) ? cfg.order.indexOf(key) : -1;
            var accentIdx = ((idx >= 0 ? idx : 0) % 5) + 1;
            css = 'var(--kexo-accent-' + accentIdx + ')';
          }
          return resolveCssColor(css) || resolveRootCssVar('--kexo-accent-1', '#4b94e4') || '#4b94e4';
        }

        function browserIconHtmlForKey(rawKey, label) {
          var k = (rawKey == null ? '' : String(rawKey)).trim().toLowerCase();
          var titleAttr = label ? (' title="' + escapeHtml(label) + '"') : '';
          if (!k) return '<i class="fa-light fa-globe" aria-hidden="true"' + titleAttr + '></i>';
          if (k.indexOf('chrome') >= 0 && k.indexOf('chromium') < 0) return '<i class="fa-brands fa-chrome" data-icon-key="type-browser-chrome" aria-hidden="true"' + titleAttr + '></i>';
          if (k.indexOf('safari') >= 0 && k.indexOf('chrome') < 0) return '<i class="fa-brands fa-safari" data-icon-key="type-browser-safari" aria-hidden="true"' + titleAttr + '></i>';
          if (k.indexOf('edge') >= 0) return '<i class="fa-brands fa-edge" data-icon-key="type-browser-edge" aria-hidden="true"' + titleAttr + '></i>';
          if (k.indexOf('firefox') >= 0) return '<i class="fa-brands fa-firefox-browser" data-icon-key="type-browser-firefox" aria-hidden="true"' + titleAttr + '></i>';
          if (k.indexOf('opera') >= 0) return '<i class="fa-brands fa-opera" data-icon-key="type-browser-opera" aria-hidden="true"' + titleAttr + '></i>';
          return '<i class="fa-light fa-globe" data-icon-key="type-browser-other" aria-hidden="true"' + titleAttr + '></i>';
        }

        function metricValue(row, metric) {
          if (!row) return 0;
          if (metric === 'clicks') return Number(row.clicks) || 0;
          if (metric === 'ctr') return Number(row.ctr) || 0;
          return Number(row.revenue) || 0;
        }

        function fmtMetric(metric, row) {
          if (!row) return '\u2014';
          if (metric === 'clicks') {
            var c = Number(row.clicks) || 0;
            return fmtNum(c);
          }
          if (metric === 'ctr') {
            var p = row.ctr != null ? Number(row.ctr) : null;
            if (!Number.isFinite(p)) return '\u2014';
            return (Math.round(p * 10) / 10).toFixed(1) + '%';
          }
          return fmtGbp2(Number(row.revenue) || 0);
        }

        function sortTop(rows, metric, limit) {
          var list = Array.isArray(rows) ? rows.slice() : [];
          list.sort(function (a, b) {
            return metricValue(b, metric) - metricValue(a, metric);
          });
          return list.slice(0, Math.max(0, Number(limit) || 0));
        }

        function stripSvgDimensions(html) {
          if (typeof html !== 'string' || !html) return html;
          return html.replace(/<svg(\s[^>]*?)>/gi, function (match, attrs) {
            var a = attrs
              .replace(/\s+width\s*=\s*["'][^"']*["']/gi, '')
              .replace(/\s+height\s*=\s*["'][^"']*["']/gi, '');
            return '<svg' + a + '>';
          });
        }

        var LIST_ROW_COUNT = 3;
        function renderList(widgetKey, rows, sortBy, shareBaseRows) {
          var mountId = 'dash-ovw-' + widgetKey + '-list';
          var host = document.getElementById(mountId);
          if (!host) return;
          var list = Array.isArray(rows) ? rows : [];
          var metric = sortBy === 'clicks' ? 'clicks' : (sortBy === 'ctr' ? 'ctr' : 'revenue');
          var shareBase = Array.isArray(shareBaseRows) ? shareBaseRows : list;
          var total = metric === 'ctr'
            ? 0
            : (shareBase.reduce(function (acc, r) { return acc + metricValue(r, metric); }, 0) || 0);
          var html = '<ul class="kexo-widget-list">';
          var i;
          for (i = 0; i < list.length; i++) {
            var r = list[i];
            var label = r && r.label != null ? String(r.label) : '—';
            var icon = r && r.iconHtml ? stripSvgDimensions(String(r.iconHtml)) : '<span class="kexo-dash-top-row-icon-placeholder" aria-hidden="true"></span>';
            var valText = fmtMetric(metric, r);
            var seriesVal = metricValue(r, metric);
            var pct = metric === 'ctr'
              ? (Number.isFinite(Number(seriesVal)) ? Number(seriesVal) : 0)
              : (total > 0 ? (seriesVal / total) * 100 : 0);
            if (!Number.isFinite(pct)) pct = 0;
            pct = Math.max(0, Math.min(100, pct));
            html += '<li class="kexo-widget-row" title="' + escapeHtml(label) + '">' +
              '<span class="kexo-widget-row-icon" aria-hidden="true">' + icon + '</span>' +
              '<span class="kexo-widget-row-label">' + escapeHtml(label) + '</span>' +
              '<span class="kexo-widget-row-value">' + escapeHtml(valText) + '</span>' +
              '<div class="kexo-widget-row-bar"><span data-kexo-bar-fill="' + escapeHtml(String(pct)) + '"></span></div>' +
            '</li>';
          }
          for (i = list.length; i < LIST_ROW_COUNT; i++) {
            html += '<li class="kexo-widget-row kexo-widget-row--skeleton" aria-hidden="true">' +
              '<span class="kexo-widget-row-icon"><span class="kexo-dash-top-row-icon-placeholder"></span></span>' +
              '<span class="kexo-widget-row-label kexo-widget-row-skeleton-text"></span>' +
              '<span class="kexo-widget-row-value kexo-widget-row-skeleton-text"></span>' +
              '<div class="kexo-widget-row-bar kexo-widget-row-bar--skeleton"><span></span></div>' +
            '</li>';
          }
          html += '</ul>';
          host.innerHTML = html;
          animateWidgetFills(host);
        }

        function renderChart(widgetKey, rows, sortBy) {
          var chartId = 'dash-ovw-' + widgetKey + '-chart';
          var chartEl = document.getElementById(chartId);
          if (!chartEl) return;
          try {
            if (dashCharts && dashCharts[chartId] && typeof dashCharts[chartId].destroy === 'function') {
              dashCharts[chartId].destroy();
              dashCharts[chartId] = null;
            }
          } catch (_) {}
          var list = Array.isArray(rows) ? rows : [];
          if (!list.length) { chartEl.innerHTML = ''; return; }
          var metric = sortBy === 'clicks' ? 'clicks' : (sortBy === 'ctr' ? 'ctr' : 'revenue');
          var top = list[0] || null;
          if (!top) { chartEl.innerHTML = ''; return; }
          var pct = 0;
          if (metric === 'ctr') {
            pct = Number(top.ctr);
            if (!Number.isFinite(pct)) pct = 0;
            pct = Math.max(0, Math.min(100, pct));
          } else {
            var total = list.reduce(function (acc, r) { return acc + Math.max(0, metricValue(r, metric)); }, 0) || 0;
            var topVal = Math.max(0, metricValue(top, metric));
            pct = total > 0 ? (topVal / total) * 100 : 0;
            if (!Number.isFinite(pct)) pct = 0;
            pct = Math.max(0, Math.min(100, pct));
          }
          var icon = top && top.iconHtml ? stripSvgDimensions(String(top.iconHtml)) : '';
          var labelText = top && top.label != null ? String(top.label) : '—';
          var valueText = fmtMetric(metric, top);
          var shareText = metric === 'ctr' ? 'CTR' : (String(Math.round(pct)) + '% share');
          var tip = labelText + '\n' + valueText + '\n' + (metric === 'ctr' ? ('CTR: ' + valueText) : ('Share: ' + (Math.round(pct * 10) / 10).toFixed(1) + '%'));
          var size = 111;
          var r = 41;
          var strokeW = 8;
          var cx = size / 2;
          var cy = size / 2;
          var circ = Math.round(2 * Math.PI * r * 1000) / 1000;
          var dashOffset = Math.round((circ - (pct / 100) * circ) * 1000) / 1000;
          chartEl.innerHTML =
            '<div class="kexo-ovw-ring-row" title="' + escapeHtml(tip) + '">' +
              '<div class="kexo-ovw-ring-wrap kexo-ovw-ring-wrap--small">' +
                '<div class="kexo-ovw-ring">' +
                  '<svg width="' + size + '" height="' + size + '" viewBox="0 0 ' + size + ' ' + size + '" aria-hidden="true">' +
                    '<circle cx="' + cx + '" cy="' + cy + '" r="' + r + '" fill="none" stroke="rgba(15,23,42,0.10)" stroke-width="' + strokeW + '"></circle>' +
                    '<circle cx="' + cx + '" cy="' + cy + '" r="' + r + '" fill="none" stroke="var(--kexo-accent, var(--kexo-accent-1, #4b94e4))" stroke-width="' + strokeW + '" stroke-linecap="round"' +
                      ' style="transform: rotate(-90deg); transform-origin: ' + cx + 'px ' + cy + 'px; transition: stroke-dashoffset 520ms cubic-bezier(.2,.9,.2,1);"' +
                      ' stroke-dasharray="' + escapeHtml(String(circ)) + '" stroke-dashoffset="' + escapeHtml(String(dashOffset)) + '"' +
                      ' data-kexo-radial-pct="' + escapeHtml(String(pct)) + '" data-kexo-radial-circ="' + escapeHtml(String(circ)) + '"' +
                    '></circle>' +
                  '</svg>' +
                  '<div class="kexo-ovw-ring-center kexo-ovw-ring-center--icon-only">' +
                    (icon ? ('<div class="kexo-ovw-ring-icon" aria-hidden="true">' + icon + '</div>') : '') +
                  '</div>' +
                '</div>' +
              '</div>' +
              '<div class="kexo-ovw-ring-right">' +
                '<div class="kexo-ovw-ring-right-name">' + escapeHtml(labelText) + '</div>' +
                '<div class="kexo-ovw-ring-right-value">' + escapeHtml(valueText) + '</div>' +
                '<div class="kexo-ovw-ring-right-pct">' + escapeHtml(shareText) + '</div>' +
              '</div>' +
            '</div>';
          animateWidgetRadials(chartEl);
        }

        function extractRows(widgetKey, data) {
          var key = String(widgetKey || '').trim().toLowerCase();
          var payload = (data && data.ok && data.payload) ? data.payload : data;
          if (!payload || typeof payload !== 'object') return [];
          if (key === 'finishes') {
            var tables = Array.isArray(payload.tables) ? payload.tables : [];
            var tableId = cfg && cfg.widgets && cfg.widgets.finishes && cfg.widgets.finishes.groupBy ? String(cfg.widgets.finishes.groupBy) : '';
            tableId = tableId.trim().toLowerCase();
            var table = (tableId ? tables.find(function (t) { return t && String(t.id || '').trim().toLowerCase() === tableId; }) : null) || tables[0] || null;
            var rows = table && Array.isArray(table.rows) ? table.rows : [];
            return rows.map(function (r) {
              var label = r && (r.variant || r.key) ? String(r.variant || r.key) : '—';
              return {
                label: label,
                revenue: Number(r && (r.revenue_gbp != null ? r.revenue_gbp : r.revenue)) || 0,
                clicks: Number(r && r.sessions) || 0,
                ctr: (r && r.cr != null) ? Number(r.cr) : null,
                iconHtml: '<i class="fa-light fa-gem" aria-hidden="true"></i>',
              };
            });
          }
          if (key === 'devices') {
            var devRows = payload.devices && Array.isArray(payload.devices.rows) ? payload.devices.rows : [];
            var platformAgg = {};
            devRows.forEach(function (r) {
              var platforms = r && Array.isArray(r.platforms) ? r.platforms : [];
              platforms.forEach(function (p) {
                var plat = p && p.platform != null ? String(p.platform).trim().toLowerCase() : '';
                if (!plat) return;
                var cur = platformAgg[plat] || { sessions: 0, orders: 0, revenueGbp: 0 };
                cur.sessions += Number(p && p.sessions) || 0;
                cur.orders += Number(p && p.orders) || 0;
                cur.revenueGbp += Number(p && (p.revenue_gbp != null ? p.revenue_gbp : p.revenue)) || 0;
                platformAgg[plat] = cur;
              });
            });
            var platKeys = Object.keys(platformAgg).sort(function (a, b) {
              return (platformAgg[b].sessions || 0) - (platformAgg[a].sessions || 0);
            });
            return platKeys.map(function (plat) {
              var agg = platformAgg[plat];
              var label = plat ? (plat.charAt(0).toUpperCase() + plat.slice(1)) : '—';
              var icon = plat === 'android' ? 'fa-brands fa-android' : plat === 'ios' ? 'fa-brands fa-apple' : plat === 'windows' ? 'fa-brands fa-windows' : plat === 'macos' || plat === 'mac' ? 'fa-brands fa-apple' : plat === 'linux' ? 'fa-brands fa-linux' : plat === 'other' ? 'fa-light fa-desktop' : 'fa-light fa-mobile-screen';
              var ctr = (agg.sessions > 0 && agg.orders != null) ? ((agg.orders / agg.sessions) * 100) : null;
              return {
                label: label,
                revenue: Math.round((Number(agg.revenueGbp) || 0) * 100) / 100,
                clicks: Number(agg.sessions) || 0,
                ctr: Number.isFinite(ctr) ? Math.round(ctr * 10) / 10 : null,
                iconHtml: '<i class="' + escapeHtml(icon) + '" aria-hidden="true"></i>',
              };
            });
          }
          if (key === 'browsers') {
            var brRows = Array.isArray(payload.rows) ? payload.rows : [];
            return brRows.map(function (r) {
              var label = r && r.ua_browser != null ? String(r.ua_browser) : '—';
              return {
                label: label,
                revenue: Number(r && r.revenue) || 0,
                clicks: Number(r && r.sessions) || 0,
                ctr: (r && r.cr != null) ? Number(r.cr) : null,
                iconHtml: browserIconHtmlForKey(label, label),
              };
            });
          }
          if (key === 'abandoned') {
            var abRows = Array.isArray(payload.rows) ? payload.rows : [];
            return abRows.map(function (r) {
              var cc = r && r.country != null ? String(r.country) : '—';
              cc = String(cc || '').trim().toUpperCase().slice(0, 2) || '—';
              var iconHtml = cc && /^[A-Z]{2}$/.test(cc) ? countryCodeToFlagHtml(cc) : '<i class="fa-light fa-globe" aria-hidden="true"></i>';
              return {
                label: cc,
                revenue: Number(r && r.abandoned_value_gbp) || 0,
                clicks: Number(r && r.checkout_sessions) || 0,
                ctr: null,
                iconHtml: iconHtml,
              };
            });
          }
          if (key === 'attribution') {
            var chans = payload.attribution && Array.isArray(payload.attribution.rows) ? payload.attribution.rows : [];
            var agg = {};
            chans.forEach(function (ch) {
              var sources = ch && Array.isArray(ch.sources) ? ch.sources : [];
              sources.forEach(function (s) {
                var k = s && (s.source_key || s.label) ? String(s.source_key || s.label) : '';
                if (!k) return;
                var cur = agg[k] || { label: '', iconSpec: '', sessions: 0, orders: 0, revenue: 0 };
                cur.label = cur.label || (s && s.label != null ? String(s.label) : k);
                cur.iconSpec = cur.iconSpec || (s && s.icon_spec != null ? String(s.icon_spec) : '');
                cur.sessions += Number(s && s.sessions) || 0;
                cur.orders += Number(s && s.orders) || 0;
                cur.revenue += Number(s && s.revenue_gbp) || 0;
                agg[k] = cur;
              });
            });
            return Object.keys(agg).map(function (k) {
              var a = agg[k];
              var iconHtml = a.iconSpec ? attributionIconSpecToHtml(a.iconSpec, a.label) : '<i class="fa-light fa-share-nodes" aria-hidden="true"></i>';
              var ctr = a.sessions > 0 ? Math.round((a.orders / a.sessions) * 1000) / 10 : null;
              return { label: a.label || k, revenue: a.revenue || 0, clicks: a.sessions || 0, ctr: ctr, iconHtml: iconHtml };
            });
          }
          if (key === 'payment_methods') {
            var payRows = Array.isArray(payload.rows) ? payload.rows : [];
            return payRows.map(function (r) {
              var label = r && r.label != null ? String(r.label) : '—';
              var key2 = r && r.key != null ? String(r.key).trim().toLowerCase() : 'other';
              var iconSrc = r && r.iconSrc ? String(r.iconSrc) : '';
              var iconAlt = r && r.iconAlt ? String(r.iconAlt) : label;
              var iconHtml = iconSrc
                ? ('<img src="' + escapeHtml(iconSrc) + '" alt="' + escapeHtml(iconAlt) + '" width="18" height="18" data-icon-key="payment-method-' + escapeHtml(key2 || 'other') + '">')
                : '<i class="fa-light fa-credit-card" data-icon-key="payment-method-' + escapeHtml(key2 || 'other') + '" aria-hidden="true"></i>';
              return {
                label: label,
                revenue: Number(r && (r.revenue != null ? r.revenue : r.revenue_gbp)) || 0,
                clicks: Number(r && r.sessions) || 0,
                ctr: (r && r.cr != null) ? Number(r.cr) : null,
                iconHtml: iconHtml,
              };
            });
          }
          return [];
        }

        function renderWidget(widgetKey, data) {
          var key = String(widgetKey || '').trim().toLowerCase();
          var sortBy = cfg && cfg.widgets && cfg.widgets[key] && cfg.widgets[key].sortBy ? String(cfg.widgets[key].sortBy) : 'revenue';
          sortBy = String(sortBy || '').trim().toLowerCase();
          if (!widgetSupportsSortBy(key, sortBy)) sortBy = 'revenue';
          var rows = extractRows(key, data);
          var top = sortTop(rows, sortBy, TOP_N);
          if (key === 'finishes') {
            var payload = (data && data.ok && data.payload) ? data.payload : data;
            var tables = Array.isArray(payload && payload.tables) ? payload.tables : [];
            var gb = cfg && cfg.widgets && cfg.widgets.finishes && cfg.widgets.finishes.groupBy ? String(cfg.widgets.finishes.groupBy).trim().toLowerCase() : 'finishes';
            var table = (gb ? tables.find(function (t) { return t && String(t.id || '').trim().toLowerCase() === gb; }) : null) || tables[0] || null;
            var titleText = table && table.name ? String(table.name) : 'Finishes';
            var titleEl = document.querySelector('[data-kexo-overview-widget="finishes"] .kexo-widget-title');
            if (titleEl) titleEl.textContent = titleText;
          }
          if (!top || !top.length) {
            try { document.getElementById('dash-ovw-' + key + '-chart').innerHTML = ''; } catch (_) {}
            try { document.getElementById('dash-ovw-' + key + '-list').innerHTML = '<div class="kexo-widget-empty">No data</div>'; } catch (_) {}
            return;
          }
          var sig = widgetSig({
            key: key,
            rk: rk,
            sortBy: sortBy,
            pos: (cfg && Array.isArray(cfg.order)) ? cfg.order.indexOf(key) : -1,
            color: (cfg && cfg.widgets && cfg.widgets[key] && cfg.widgets[key].color) ? String(cfg.widgets[key].color) : '',
            accent: accentForWidget(key),
            rows: top
          });
          var listMountId = 'dash-ovw-' + key + '-list';
          if (!force && dashWidgetLastRenderSig[listMountId] && dashWidgetLastRenderSig[listMountId] === sig) return;
          dashWidgetLastRenderSig[listMountId] = sig;
          renderChart(key, top, sortBy);
          if (top.length <= 1) {
            try { document.getElementById('dash-ovw-' + key + '-list').innerHTML = ''; } catch (_) {}
            return;
          }
          renderList(key, top.slice(1), sortBy, top);
        }

        var order = cfg && Array.isArray(cfg.order) ? cfg.order.slice() : OVERVIEW_WIDGET_KEYS.slice();
        var tasks = order.map(function (key) {
          var url = urls[key];
          if (!url) return Promise.resolve(null);
          var cacheKey = key + '|' + rk + ((key === 'finishes') ? ('|' + shopKey) : '');
          var timeout = key === 'finishes' ? 30000 : 25000;
          return fetchWidgetJson(cacheKey, url, force, timeout).then(function (data) {
            try { renderWidget(key, data); } catch (_) {}
          });
        });

        // Older environments may not support Promise.allSettled.
        return Promise.all(tasks.map(function (p) {
          return Promise.resolve(p).then(function (v) { return { status: 'fulfilled', value: v }; }, function (err) { return { status: 'rejected', reason: err }; });
        })).then(function () {});
      }

      window.refreshDashboard = function(opts) {
        var force = opts && opts.force;
        var silent = !!(opts && opts.silent);
        var rerender = !!(opts && opts.rerender);
        var reason = opts && opts.reason != null ? String(opts.reason) : '';
        var rk = dashRangeKeyFromDateRange();
        try {
          var curYmd = (typeof ymdNowInTz === 'function') ? ymdNowInTz() : null;
          if (curYmd && dashLastDayYmd && dashLastDayYmd !== curYmd) {
            dashCache = null;
            dashLastRangeKey = null;
            dashPayloadSignature = '';
            force = true;
          }
          if (curYmd) dashLastDayYmd = curYmd;
        } catch (_) {}
        if (!force && dashCache && dashLastRangeKey === rk) {
          if (rerender) renderDashboard(dashCache);
          fetchOverviewCardData('dash-chart-overview-30d', { force: false, renderIfFresh: true });
          requestDashboardWidgetsRefresh({ force: false, rangeKey: rk });
          return;
        }
        fetchDashboardData(rk, force, { silent: silent, rerender: rerender, reason: reason });
      };

      function createDashboardController() {
        var pollTimer = null;
        var visibilityBound = false;
        var pageShowBound = false;
        var lastResumeAt = 0;
        var POLL_MS = 120000;
        function isDashboardActive() {
          try {
            var p = document.getElementById('tab-panel-dashboard');
            if (!p) return PAGE === 'dashboard';
            return p.classList.contains('active') || PAGE === 'dashboard';
          } catch (_) {
            return PAGE === 'dashboard';
          }
        }
        function isVisible() {
          try {
            return !document || !document.visibilityState || document.visibilityState === 'visible';
          } catch (_) {
            return true;
          }
        }
        function isDynamicRange() {
          var rk = dashRangeKeyFromDateRange();
          return rk === 'today' || rk === '1h';
        }
        function stopPolling() {
          if (pollTimer) {
            try { clearInterval(pollTimer); } catch (_) {}
            pollTimer = null;
          }
        }
        function pollTick() {
          if (!isVisible()) return;
          if (!isDashboardActive()) return;
          if (!isDynamicRange()) return;
          if (dashLoading) return;
          try { if (typeof window.refreshDashboard === 'function') window.refreshDashboard({ force: true, silent: true }); } catch (_) {}
        }
        function startPolling() {
          stopPolling();
          if (!isVisible()) return;
          pollTimer = setInterval(pollTick, POLL_MS);
        }
        var VISIBILITY_REFRESH_MIN_IDLE_MS = 30 * 1000; // Skip full refresh if tab was hidden < 30s
        function refreshOnceAndResume(reason) {
          var now = Date.now();
          if (now - lastResumeAt < 1000) return;
          var lastHidden = (typeof window.__kexoLastHiddenAt === 'number') ? window.__kexoLastHiddenAt : 0;
          var idleMs = lastHidden ? (now - lastHidden) : 0;
          if (idleMs > 0 && idleMs < VISIBILITY_REFRESH_MIN_IDLE_MS) {
            startPolling();
            return;
          }
          lastResumeAt = now;
          try { if (typeof window.refreshDashboard === 'function') window.refreshDashboard({ force: true, silent: true, reason: reason || 'resume' }); } catch (_) {}
          try { if (typeof refreshKpis === 'function') refreshKpis({ force: true }); } catch (_) {}
          startPolling();
        }
        function onVisibilityChange() {
          if (!isVisible()) {
            stopPolling();
            try { window.__kexoLastHiddenAt = Date.now(); } catch (_) {}
            try { if (typeof pauseOverviewResizeObservers === 'function') pauseOverviewResizeObservers(); } catch (_) {}
            return;
          }
          try { if (typeof resumeOverviewResizeObservers === 'function') resumeOverviewResizeObservers(); } catch (_) {}
          refreshOnceAndResume('visibility');
        }
        function onPageShow(ev) {
          if (ev && ev.persisted) refreshOnceAndResume('pageshow');
        }
        function init() {
          startPolling();
          if (!visibilityBound) {
            document.addEventListener('visibilitychange', onVisibilityChange);
            visibilityBound = true;
          }
          if (!pageShowBound) {
            window.addEventListener('pageshow', onPageShow);
            pageShowBound = true;
          }
        }
        function destroy() {
          stopPolling();
          if (visibilityBound) {
            try { document.removeEventListener('visibilitychange', onVisibilityChange); } catch (_) {}
            visibilityBound = false;
          }
          if (pageShowBound) {
            try { window.removeEventListener('pageshow', onPageShow); } catch (_) {}
            pageShowBound = false;
          }
        }
        return {
          init: init,
          destroy: destroy,
          startPolling: startPolling,
          stopPolling: stopPolling,
          onVisibleResume: refreshOnceAndResume,
          pollNow: pollTick
        };
      }

      window.refreshKexoScore = function() {
        return fetchKexoScore(dashRangeKeyFromDateRange());
      };
      if (document.getElementById('header-kexo-score-wrap')) {
        fetchKexoScore(dashRangeKeyFromDateRange());
      }

      // Initial fetch: refreshDashboard is defined after setTab('dashboard') runs,
      // so the initial setTab call can't trigger it. Kick it off now if dashboard is active.
      var dashPanel = document.getElementById('tab-panel-dashboard');
      if (dashPanel && (dashPanel.classList.contains('active') || PAGE === 'dashboard')) {
        fetchDashboardData(dashRangeKeyFromDateRange(), false);
      }
      try {
        if (window.dashboardController && typeof window.dashboardController.destroy === 'function') {
          window.dashboardController.destroy();
        }
      } catch (_) {}
      dashController = createDashboardController();
      try { window.dashboardController = dashController; } catch (_) {}
      try { dashController.init(); } catch (_) {}

      // When Profit Rules are saved via the dashboard Cost Settings modal,
      // refresh the 7d overview snapshot payload (cost/revenue series depend on profit rule fingerprint).
      try {
        window.addEventListener('kexo:profitRulesUpdated', function () {
          try { fetchOverviewCardData('dash-chart-overview-30d', { force: true, renderIfFresh: true }); } catch (_) {}
          try { requestDashboardWidgetsRefresh({ force: true, rangeKey: dashRangeKeyFromDateRange() }); } catch (_) {}
        });
      } catch (_) {}

      // Failsafe: on some post-login flows (mobile app switching, bfcache restores),
      // the first dashboard fetch can be skipped or run while hidden. If we still have
      // no cache shortly after load, trigger ONE silent refresh.
      if (PAGE === 'dashboard') {
        setTimeout(function() {
          try {
            if (dashCache) return;
            if (dashLoading) return;
            var p = document.getElementById('tab-panel-dashboard');
            if (!p) return;
            if (!(p.classList.contains('active') || PAGE === 'dashboard')) return;
            if (typeof window.refreshDashboard === 'function') window.refreshDashboard({ force: true, silent: true });
          } catch (_) {}
        }, 1200);
      }

      registerCleanup(function() {
        try {
          if (dashController && typeof dashController.destroy === 'function') dashController.destroy();
        } catch (_) {}
      });
    })();

    // ?????? User avatar: fetch /api/me and populate ????????????????????????????????????????????????????????????????????????
    (function initUserAvatar() {
      try {
        var avatarEl = document.getElementById('user-avatar');
        var emailEl = document.getElementById('user-email');
        // We still fetch /api/me even if avatar elements are missing, so we can gate master-only UI.
        fetch('/api/me', { credentials: 'same-origin' })
          .then(function(r) { return r.json(); })
          .then(function(d) {
            var isMaster = !!(d && d.isMaster);
            try { window.__kexoMe = d || null; } catch (_) {}
            try { window.__kexoIsMasterUser = isMaster; } catch (_) {}
            try { window.dispatchEvent(new CustomEvent('kexo:me-loaded', { detail: { isMaster: isMaster, email: d && d.email ? String(d.email) : '' } })); } catch (_) {}
            try { if (typeof window.__kexoApplyEffectiveViewer === 'function') window.__kexoApplyEffectiveViewer(); } catch (_) {}
            if (!d || !d.email) return;
            if (avatarEl && d.initial) avatarEl.textContent = d.initial;
            if (emailEl) emailEl.textContent = d.email;
          })
          .catch(function() {
            try { window.__kexoMe = null; } catch (_) {}
            try { window.__kexoIsMasterUser = false; } catch (_) {}
            try { window.dispatchEvent(new CustomEvent('kexo:me-loaded', { detail: { isMaster: false, email: '' } })); } catch (_) {}
            try { if (typeof window.__kexoApplyEffectiveViewer === 'function') window.__kexoApplyEffectiveViewer(); } catch (_) {}
          });
      } catch (_) {}
    })();

    // ?????? Online badge: populate website name from store config ????????????????????????????????????
    (function initOnlineBadgeWebsite() {
      try {
        var el = document.getElementById('kexo-online-website');
        if (!el) return;
        fetch('/api/store-base-url', { credentials: 'same-origin' })
          .then(function(r) { return r.json(); })
          .then(function(d) {
            var domain = (d && d.shopDisplayDomain) ? String(d.shopDisplayDomain).trim() : '';
            el.textContent = domain || '\u2014';
            el.title = domain || '';
          })
          .catch(function() {});
      } catch (_) {}
    })();

    // ?????? Footer action buttons ??????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
    (function initFooterActions() {
      function proxyClick(footerSel, headerId) {
        document.querySelectorAll(footerSel).forEach(function(btn) {
          btn.addEventListener('click', function() {
            var h = document.getElementById(headerId);
            if (h) h.click();
          });
        });
      }
      function doCacheReload() {
        var url = window.location.pathname + (window.location.search || '');
        url += (url.indexOf('?') >= 0 ? '&' : '?') + '_=' + Date.now();
        if (window.location.hash) url += window.location.hash;
        window.location.href = url;
      }
      document.querySelectorAll('.footer-settings-cache-reload, .footer-cache-reload-btn').forEach(function (btn) {
        btn.addEventListener('click', doCacheReload);
      });
      var backToTop = document.getElementById('back-to-top-btn');
      if (backToTop) {
        backToTop.addEventListener('click', function() {
          function scrollToTop() {
            try { window.scrollTo({ top: 0, behavior: 'smooth' }); } catch (_) { window.scrollTo(0, 0); }
            if (document.documentElement) document.documentElement.scrollTop = 0;
            if (document.body) document.body.scrollTop = 0;
            try { window.scrollTo(0, 0); } catch (_) {}
            if (window.parent !== window) {
              try { window.parent.scrollTo({ top: 0, behavior: 'smooth' }); } catch (_) {}
              try { window.parent.scrollTo(0, 0); } catch (_) {}
            }
          }
          scrollToTop();
          requestAnimationFrame(scrollToTop);
        });
      }
    })();

    // ?????? Footer diagnostics strip (status tags from config-status) ?????????????????????
    (function initFooterDiagnostics() {
      var wrap = document.getElementById('kexo-footer-diagnostics');
      var tagsEl = document.getElementById('kexo-footer-diagnostics-tags');
      if (!wrap || !tagsEl) return;
      var active = false;
      var token = 0;
      function stop() {
        token += 1;
        active = false;
        try { wrap.style.display = 'none'; } catch (_) {}
        try { tagsEl.innerHTML = ''; } catch (_) {}
      }
      function render() {
        if (active) return;
        active = true;
        var myToken = (token += 1);
        var url = API + '/api/config-status';
        try {
          var shop = (typeof getShopParam === 'function' ? getShopParam() : null) || (typeof shopForSalesFallback === 'string' && shopForSalesFallback ? shopForSalesFallback : null);
          if (shop) url += (url.indexOf('?') >= 0 ? '&' : '?') + 'shop=' + encodeURIComponent(shop);
        } catch (_) {}
        fetch(url, { credentials: 'same-origin', cache: 'no-store' })
          .then(function(r) { return r.ok ? r.json() : null; })
          .then(function(c) {
            if (myToken !== token) return;
            if (!c) return;
            var items = [];
            var px = c.pixel;
            var ads = c.ads && c.ads.status ? c.ads.status : null;
            var gaProvider = ads && Array.isArray(ads.providers) ? ads.providers.find(function(p) { return p && String(p.key || '').toLowerCase() === 'google_ads'; }) : null;
            var gaConnected = !!(gaProvider && gaProvider.connected);
            items.push({ key: 'pixel', label: 'Kexo Pixel', status: (px && px.installed === true) ? 'Online' : 'Offline', ok: !!(px && px.installed === true) });
            items.push({ key: 'google_ads', label: 'Google Ads', status: gaConnected ? 'Connected' : 'Offline', ok: gaConnected });
            var html = '';
            items.forEach(function(it) {
              var statusCls = it.ok ? 'kexo-status-indicator--online' : 'kexo-status-indicator--offline';
              var esc = function(s) { return String(s || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;'); };
              html += '<div class="kexo-footer-diagnostics-tag">';
              html += '<a href="/settings?tab=admin&adminTab=diagnostics" class="kexo-footer-diagnostics-tag-link" title="' + esc(it.label) + ' ' + esc(it.status) + ' \u2014 click for diagnostics">';
              html += '<span class="kexo-footer-diagnostics-label">' + esc(it.label) + '</span>';
              html += '</a>';
              html += '<span class="kexo-footer-diagnostics-status">';
              html += '<span class="kexo-status-indicator ' + statusCls + '" aria-hidden="true"></span>' + esc(it.status);
              html += '</span>';
              html += '</div>';
            });
            tagsEl.innerHTML = html;
            wrap.style.display = 'block';
          })
          .catch(function() {});
      }

      function applyFromViewer(viewer) {
        var isAdmin = !!(viewer && (viewer.isAdmin === true || viewer.isMaster === true));
        if (!isAdmin) return stop();
        render();
      }

      try {
        if (typeof window.__kexoGetEffectiveViewer === 'function') {
          applyFromViewer(window.__kexoGetEffectiveViewer());
        }
      } catch (_) {}

      window.addEventListener('kexo:viewer-changed', function(ev) {
        try { applyFromViewer(ev && ev.detail ? ev.detail : null); } catch (_) {}
      });
    })();

    // ?????? Shared Product Insights modal ?????????????????????????????????????????????????????????????????????????????????????????????????????????
    (function initProductInsightsModal() {
      if (window.__productInsightsModalInit) return;
      window.__productInsightsModalInit = true;

      var modalEl = null;
      var currentMode = 'product'; // product | page
      var currentHandle = null;
      var currentProductId = null;
      var currentTitle = null;
      var currentProductUrl = null;
      var currentPageUrl = null;
      var currentLandingKind = null; // entry | exit (when opened from sessions table)
      var currentRangeKey = 'today'; // modal-local range; default Today regardless of page range
      var lastPayload = null;
      var backdropEl = null;
      var charts = { revenue: null, activity: null };
      var apexLoading = false;
      var apexWaiters = [];

      function isModifiedClick(e) {
        if (!e) return false;
        if (e.defaultPrevented) return true;
        if (e.button != null && e.button !== 0) return true; // only left click
        return !!(e.metaKey || e.ctrlKey || e.shiftKey || e.altKey);
      }

      function normalizeHandle(h) {
        if (!h) return '';
        return String(h).trim().toLowerCase().slice(0, 128);
      }

      function parseHandleFromHref(href) {
        if (!href) return '';
        try {
          var u = new URL(String(href), window.location.origin);
          var p = String(u.pathname || '');
          var m = p.match(/^\/products\/([^/?#]+)/i);
          if (m && m[1]) return normalizeHandle(decodeURIComponent(m[1]));
        } catch (_) {}
        var raw = String(href);
        var m2 = raw.match(/\/products\/([^/?#]+)/i);
        return m2 && m2[1] ? normalizeHandle(m2[1]) : '';
      }

      function ensureApexCharts(cb) {
        if (typeof ApexCharts !== 'undefined') { cb(); return; }
        apexWaiters.push(cb);
        if (apexLoading) return;
        apexLoading = true;
        try {
          var s = document.createElement('script');
          s.src = 'https://cdn.jsdelivr.net/npm/apexcharts@4.7.0/dist/apexcharts.min.js';
          s.defer = true;
          s.onload = function() {
            apexLoading = false;
            var q = apexWaiters.slice();
            apexWaiters = [];
            q.forEach(function(fn) { try { fn(); } catch (_) {} });
          };
          s.onerror = function() { apexLoading = false; apexWaiters = []; };
          document.head.appendChild(s);
        } catch (_) {
          apexLoading = false;
          apexWaiters = [];
        }
      }

      function destroyCharts() {
        try { if (charts.revenue) charts.revenue.destroy(); } catch (_) {}
        try { if (charts.activity) charts.activity.destroy(); } catch (_) {}
        charts.revenue = null;
        charts.activity = null;
      }

      function ensureDom() {
        if (modalEl) return modalEl;
        modalEl = document.getElementById('product-insights-modal');
        if (modalEl) return modalEl;

        var wrap = document.createElement('div');
        wrap.className = 'modal modal-blur fade';
        wrap.id = 'product-insights-modal';
        wrap.tabIndex = -1;
        wrap.setAttribute('aria-hidden', 'true');
        wrap.style.display = 'none';
        wrap.innerHTML =
          '<div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable" role="dialog">' +
            '<div class="modal-content">' +
              '<div class="modal-header p-4">' +
                '<h5 class="modal-title" id="product-insights-title">Product</h5>' +
                '<div class="ms-auto d-flex align-items-center gap-2">' +
                  '<select class="form-select form-select-sm" id="product-insights-range" aria-label="Date range">' +
                    '<option value="today" selected>Today</option>' +
                    '<option value="yesterday">Yesterday</option>' +
                    '<option value="3d">Last 3 days</option>' +
                    '<option value="7d">Last 7 days</option>' +
                    '<option value="14d">Last 14 days</option>' +
                    '<option value="30d">Last 30 days</option>' +
                  '</select>' +
                  '<button type="button" class="btn-close" id="product-insights-close" aria-label="Close"></button>' +
                '</div>' +
              '</div>' +
              '<div class="modal-body">' +
                '<div id="product-insights-status" class="text-muted">Loading\u2026</div>' +
                '<div id="product-insights-body" style="display:none">' +
                  '<div class="row g-3">' +
                    '<div class="col-12 col-lg-5" id="product-insights-col-left">' +
                      '<div class="card">' +
                        '<div class="card-body">' +
                          '<div class="kexo-product-gallery">' +
                            '<div class="product-insights-main-img-wrap">' +
                              '<img id="product-insights-main-img" class="img-fluid" alt="">' +
                            '</div>' +
                            '<div class="product-insights-thumbs-bar" aria-label="Product images">' +
                              '<button type="button" class="btn btn-icon btn-ghost-secondary product-insights-thumb-arrow" id="product-insights-thumbs-left" aria-label="Scroll thumbnails left" style="display:none">' +
                                '<i class="fa-light fa-chevron-left" aria-hidden="true"></i>' +
                              '</button>' +
                              '<div class="product-insights-thumbs-strip" id="product-insights-thumbs"></div>' +
                              '<button type="button" class="btn btn-icon btn-ghost-secondary product-insights-thumb-arrow" id="product-insights-thumbs-right" aria-label="Scroll thumbnails right" style="display:none">' +
                                '<i class="fa-light fa-chevron-right" aria-hidden="true"></i>' +
                              '</button>' +
                            '</div>' +
                          '</div>' +
                        '</div>' +
                      '</div>' +
                      '<div class="card mt-3 kexo-card-collapsed" data-collapse-id="product-insights-revenue">' +
                        '<div class="card-header"><h3 class="card-title">Revenue</h3></div>' +
                        '<div class="card-body"><div id="product-insights-chart-revenue" class="dash-chart-wrap" style="min-height:240px"></div></div>' +
                      '</div>' +
                      '<div class="card mt-3 kexo-card-collapsed" data-collapse-id="product-insights-demand">' +
                        '<div class="card-header"><h3 class="card-title">Demand signals</h3></div>' +
                        '<div class="card-body"><div id="product-insights-chart-activity" class="dash-chart-wrap" style="min-height:240px"></div></div>' +
                      '</div>' +
                    '</div>' +
                    '<div class="col-12 col-lg-7" id="product-insights-col-right">' +
                      '<div class="card" data-no-card-collapse="1">' +
                        '<div class="card-header"><h3 class="card-title" id="product-insights-details-title">Product details</h3></div>' +
                        '<div>' + (typeof buildKexoNativeTable === 'function' ? buildKexoNativeTable({
                          tableId: 'product-insights-metrics-table-wrap',
                          bodyId: 'product-insights-metrics-table',
                          tableClass: 'table table-vcenter card-table table-sm kexo-product-insights-metrics',
                          columns: (window.KEXO_APP_MODAL_TABLE_DEFS && window.KEXO_APP_MODAL_TABLE_DEFS['product-insights-metrics-table'] && window.KEXO_APP_MODAL_TABLE_DEFS['product-insights-metrics-table'].columns) || [
                            { header: 'Metric', headerClass: '' },
                            { header: 'Value', headerClass: 'text-end' }
                          ]
                        }) : '<div class="table-responsive"><table class="table table-vcenter card-table table-sm kexo-product-insights-metrics"><thead><tr><th>Metric</th><th class="text-end">Value</th></tr></thead><tbody id="product-insights-metrics-table"></tbody></table></div>') + '</div>' +
                      '</div>' +
                      '<div class="card mt-3" data-no-card-collapse="1" id="product-insights-top-countries-card" style="display:none">' +
                        '<div class="card-header"><h3 class="card-title">Top countries</h3></div>' +
                        '<div class="card-body">' +
                          '<div id="product-insights-top-countries" class="d-grid gap-2"></div>' +
                        '</div>' +
                      '</div>' +
                    '</div>' +
                  '</div>' +
                '</div>' +
              '</div>' +
              '<div class="modal-footer d-flex align-items-center justify-content-end gap-2 p-4">' +
                '<a class="btn btn-primary" id="product-insights-open-admin" href="#" target="_blank" rel="noopener" style="display:none">Edit on Shopify</a>' +
                '<a class="btn btn-secondary" id="product-insights-open-store" href="#" target="_blank" rel="noopener">View on Website</a>' +
              '</div>' +
            '</div>' +
          '</div>';

        document.body.appendChild(wrap);
        modalEl = wrap;

        var closeBtn = document.getElementById('product-insights-close');
        if (closeBtn) closeBtn.addEventListener('click', function() { close(); });
        modalEl.addEventListener('click', function(e) { if (e && e.target === modalEl) close(); });
        document.addEventListener('keydown', function(e) {
          if (!modalEl || !modalEl.classList.contains('show')) return;
          var key = e && (e.key || e.code) ? String(e.key || e.code) : '';
          if (key === 'Escape') close();
        });

        var sel = document.getElementById('product-insights-range');
        if (sel) {
          sel.addEventListener('change', function() {
            var v = sel.value || 'today';
            currentRangeKey = v;
            load();
          });
        }

        var thumbsLeft = document.getElementById('product-insights-thumbs-left');
        if (thumbsLeft) {
          thumbsLeft.addEventListener('click', function(e) {
            e.preventDefault();
            scrollThumbStrip(-1);
          });
        }
        var thumbsRight = document.getElementById('product-insights-thumbs-right');
        if (thumbsRight) {
          thumbsRight.addEventListener('click', function(e) {
            e.preventDefault();
            scrollThumbStrip(1);
          });
        }
        var thumbsStrip = document.getElementById('product-insights-thumbs');
        if (thumbsStrip) {
          thumbsStrip.addEventListener('scroll', function() {
            syncThumbStripArrows();
          }, { passive: true });
        }
        try {
          window.addEventListener('resize', function() { syncThumbStripArrows(); syncMainImageBalance(); });
        } catch (_) {}

        // When collapsed chart cards are expanded, render charts at the right size.
        modalEl.addEventListener('click', function(e) {
          var btn = e && e.target && e.target.closest ? e.target.closest('.kexo-card-collapse-toggle') : null;
          if (!btn) return;
          setTimeout(function() {
            try { syncMainImageBalance(); } catch (_) {}
            try { if (lastPayload) renderCharts(lastPayload); } catch (_) {}
          }, 160);
        });

        return modalEl;
      }

      function ensureBackdrop() {
        if (backdropEl && backdropEl.parentNode) return;
        var el = document.createElement('div');
        el.className = 'modal-backdrop fade show product-insights-backdrop';
        document.body.appendChild(el);
        backdropEl = el;
      }

      function removeBackdrop() {
        if (backdropEl && backdropEl.parentNode) {
          backdropEl.parentNode.removeChild(backdropEl);
        }
        backdropEl = null;
      }

      function show() {
        ensureDom();
        ensureBackdrop();
        modalEl.style.display = 'block';
        modalEl.classList.add('show');
        modalEl.setAttribute('aria-hidden', 'false');
        document.body.classList.add('modal-open');
      }

      function close() {
        if (!modalEl) return;
        modalEl.style.display = 'none';
        modalEl.classList.remove('show');
        modalEl.setAttribute('aria-hidden', 'true');
        document.body.classList.remove('modal-open');
        removeBackdrop();
        destroyCharts();
        currentMode = 'product';
        currentHandle = null;
        currentProductId = null;
        currentTitle = null;
        currentProductUrl = null;
        currentPageUrl = null;
        currentLandingKind = null;
      }

      function setStatus(msg) {
        var s = document.getElementById('product-insights-status');
        var b = document.getElementById('product-insights-body');
        if (s) s.textContent = msg || '';
        if (b) b.style.display = 'none';
        if (s) s.style.display = msg ? 'block' : 'none';
      }

      function fmtNum(n) {
        var x = (typeof n === 'number') ? n : Number(n);
        if (!isFinite(x)) return '\u2014';
        try { return x.toLocaleString('en-GB'); } catch (_) { return String(Math.round(x)); }
      }

      function labelForTs(ts, isHourly) {
        try {
          var d = new Date(Number(ts));
          if (isHourly) return d.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
          return d.toLocaleDateString('en-GB', { day: '2-digit', month: 'short' });
        } catch (_) {
          return '';
        }
      }

      function renderCharts(payload) {
        if (!payload || !payload.series || !payload.series.points) return;
        var points = payload.series.points || [];
        var isHourly = !!(payload.series && payload.series.isHourly);
        var labels = points.map(function(p) { return labelForTs(p.ts, isHourly); });
        var rev = points.map(function(p) { return (p && p.revenueGbp) ? Number(p.revenueGbp) : 0; });
        var ord = points.map(function(p) { return (p && p.orders) ? Number(p.orders) : 0; });
        var clicks = points.map(function(p) { return (p && p.clicks) ? Number(p.clicks) : 0; });
        var views = points.map(function(p) { return (p && p.views) ? Number(p.views) : 0; });
        var atc = points.map(function(p) { return (p && p.addToCart) ? Number(p.addToCart) : 0; });

        ensureApexCharts(function() {
          var revEl = document.getElementById('product-insights-chart-revenue');
          var actEl = document.getElementById('product-insights-chart-activity');
          if ((!revEl && !actEl) || typeof ApexCharts === 'undefined') return;

          function isVisible(el) {
            if (!el) return false;
            if ((el.clientWidth || 0) < 30) return false;
            if (!el.offsetParent) return false;
            return true;
          }

          var canRev = isVisible(revEl);
          var canAct = isVisible(actEl);
          if (!canRev && !canAct) {
            // Charts are inside collapsed cards (hidden). We'll re-render when expanded.
            destroyCharts();
            return;
          }

          destroyCharts();

          // Revenue chart (GBP + Orders)
          if (canRev) {
            charts.revenue = new ApexCharts(revEl, {
              chart: { type: 'area', height: 240, toolbar: { show: false }, fontFamily: 'Inter, sans-serif' },
              series: [
                { name: 'Revenue', data: rev },
                { name: 'Conversions', data: ord },
              ],
              colors: ['#0d9488', '#3b82f6'],
              stroke: { show: true, width: 2, curve: 'smooth', lineCap: 'round' },
              fill: { type: 'gradient', gradient: { shadeIntensity: 1, opacityFrom: 0.16, opacityTo: 0.04, stops: [0, 100] } },
              dataLabels: { enabled: false },
              xaxis: { categories: labels, labels: { style: { fontSize: '10px' } } },
              yaxis: [
                { labels: { style: { fontSize: '11px' }, formatter: function(v) { return fmtMoneyGbp(v).replace('.00', ''); } } },
                { opposite: true, labels: { style: { fontSize: '11px' }, formatter: function(v) { return fmtNum(v); } } },
              ],
              tooltip: { y: { formatter: function(v, o) { return o && o.seriesIndex === 0 ? fmtMoneyGbp(v) : fmtNum(v); } } },
              grid: { borderColor: '#f1f1f1', strokeDashArray: 3 },
              legend: { position: 'top', fontSize: '11px' },
            });
            revEl.innerHTML = '';
            charts.revenue.render();
          }

          // Activity chart (Clicks / Views / Add to cart)
          if (canAct) {
            charts.activity = new ApexCharts(actEl, {
              chart: { type: 'line', height: 240, toolbar: { show: false }, fontFamily: 'Inter, sans-serif' },
              series: [
                { name: 'Clicks', data: clicks },
                { name: 'Views (pixel)', data: views },
                { name: 'Add to cart', data: atc },
              ],
              colors: ['#6366f1', '#f59e0b', '#ef4444'],
              stroke: { show: true, width: 2, curve: 'smooth', lineCap: 'round' },
              markers: { size: 2, hover: { size: 5 } },
              dataLabels: { enabled: false },
              xaxis: { categories: labels, labels: { style: { fontSize: '10px' } } },
              yaxis: { labels: { style: { fontSize: '11px' }, formatter: function(v) { return fmtNum(v); } }, min: 0 },
              tooltip: { y: { formatter: function(v) { return fmtNum(v); } } },
              grid: { borderColor: '#f1f1f1', strokeDashArray: 3 },
              legend: { position: 'top', fontSize: '11px' },
            });
            actEl.innerHTML = '';
            charts.activity.render();
          }
        });
      }

      function rangeLabelForKey(rangeKey) {
        var rk = (rangeKey == null ? '' : String(rangeKey)).trim().toLowerCase();
        if (!rk) rk = 'today';
        try {
          if (typeof isCustomRangeKey === 'function' && isCustomRangeKey(rk)) {
            var r = ymdRangeFromRangeKey(rk);
            if (r && r.startYmd && r.endYmd) return formatYmdRangeLabel(r.startYmd, r.endYmd) || 'Selected dates';
          }
          if (typeof isCustomDayRangeKey === 'function' && isCustomDayRangeKey(rk)) {
            var ymd = ymdFromDayKey(rk);
            if (ymd) return formatYmdLabel(ymd) || 'Selected day';
          }
        } catch (_) {}
        try { return getRangeDisplayLabel(rk); } catch (_) {}
        return rk;
      }

      function globalRangeKeyOrToday() {
        try {
          var rk = getStatsRange();
          rk = (rk == null ? '' : String(rk)).trim().toLowerCase();
          return rk || 'today';
        } catch (_) {
          return 'today';
        }
      }

      function syncRangeSelect(key) {
        ensureDom();
        var sel = document.getElementById('product-insights-range');
        if (!sel) return;
        var k = (key == null ? '' : String(key)).trim().toLowerCase();
        if (!k) k = 'today';
        try {
          Array.from(sel.querySelectorAll('option[data-dynamic="1"]')).forEach(function(o) { o.remove(); });
        } catch (_) {}
        var found = false;
        try {
          for (var i = 0; i < sel.options.length; i++) {
            var ov = (sel.options[i] && sel.options[i].value != null) ? String(sel.options[i].value).trim().toLowerCase() : '';
            if (ov === k) { found = true; break; }
          }
        } catch (_) {}
        if (!found) {
          try {
            var opt = document.createElement('option');
            opt.value = k;
            opt.textContent = rangeLabelForKey(k) || k;
            opt.setAttribute('data-dynamic', '1');
            sel.appendChild(opt);
          } catch (_) {}
        }
        try { sel.value = k; } catch (_) {}
      }

      function syncThumbStripArrows() {
        ensureDom();
        var strip = document.getElementById('product-insights-thumbs');
        var leftBtn = document.getElementById('product-insights-thumbs-left');
        var rightBtn = document.getElementById('product-insights-thumbs-right');
        if (!strip || !leftBtn || !rightBtn) return;
        var max = Math.max(0, (strip.scrollWidth || 0) - (strip.clientWidth || 0));
        var hasOverflow = max > 6;
        leftBtn.style.display = hasOverflow ? 'inline-flex' : 'none';
        rightBtn.style.display = hasOverflow ? 'inline-flex' : 'none';
        leftBtn.disabled = !hasOverflow || (strip.scrollLeft || 0) <= 1;
        rightBtn.disabled = !hasOverflow || (strip.scrollLeft || 0) >= (max - 1);
      }

      function isDesktopModalLayout() {
        try { return !!(window.matchMedia && window.matchMedia('(min-width: 992px)').matches); } catch (_) { return false; }
      }

      function isVisibleEl(el) {
        if (!el) return false;
        if (!el.offsetParent) return false;
        if ((el.clientWidth || 0) < 8 || (el.clientHeight || 0) < 8) return false;
        return true;
      }

      function unionHeightOfCards(cards) {
        var top = null;
        var bottom = null;
        (cards || []).forEach(function(card) {
          if (!card || !card.getBoundingClientRect) return;
          if (!isVisibleEl(card)) return;
          var r = card.getBoundingClientRect();
          if (top == null || r.top < top) top = r.top;
          if (bottom == null || r.bottom > bottom) bottom = r.bottom;
        });
        if (top == null || bottom == null) return 0;
        return Math.max(0, bottom - top);
      }

      function syncMainImageBalance() {
        ensureDom();
        var wrap = modalEl ? modalEl.querySelector('.product-insights-main-img-wrap') : null;
        if (!wrap) return;

        if (!isDesktopModalLayout()) {
          wrap.style.height = '';
          return;
        }

        var colLeft = document.getElementById('product-insights-col-left');
        var colRight = document.getElementById('product-insights-col-right');
        if (!colLeft || !colRight) {
          wrap.style.height = '';
          return;
        }

        // If charts are expanded, let the gallery be its natural size (square).
        var revCard = colLeft.querySelector('[data-collapse-id="product-insights-revenue"]');
        var demCard = colLeft.querySelector('[data-collapse-id="product-insights-demand"]');
        var hasExpandedCharts =
          (revCard && !revCard.classList.contains('kexo-card-collapsed')) ||
          (demCard && !demCard.classList.contains('kexo-card-collapsed'));
        if (hasExpandedCharts) {
          wrap.style.height = '';
          return;
        }

        var leftCards = Array.from(colLeft.querySelectorAll(':scope > .card'));
        var rightCards = Array.from(colRight.querySelectorAll(':scope > .card'));
        if (!leftCards.length || !rightCards.length) {
          wrap.style.height = '';
          return;
        }

        var leftHeight = unionHeightOfCards(leftCards);
        var rightHeight = unionHeightOfCards(rightCards);
        if (!leftHeight || !rightHeight) {
          wrap.style.height = '';
          return;
        }

        var wrapRect = wrap.getBoundingClientRect();
        var wrapH = wrapRect.height || 0;
        var wrapW = wrapRect.width || 0;
        if (!wrapH || !wrapW) {
          wrap.style.height = '';
          return;
        }

        var fixedLeft = leftHeight - wrapH;
        if (!isFinite(fixedLeft)) fixedLeft = 0;
        var naturalSquare = wrapW; // default via aspect-ratio: 1/1

        // Target = right content height, but clamp so the image doesn't exceed a square.
        var target = rightHeight - fixedLeft;
        var minH = Math.max(220, Math.round(naturalSquare * 0.6));
        if (!isFinite(target)) target = naturalSquare;
        target = Math.max(minH, Math.min(naturalSquare, target));

        // If we're basically square, clear the override.
        if (Math.abs(target - naturalSquare) < 10) {
          wrap.style.height = '';
          return;
        }

        wrap.style.height = String(Math.round(target)) + 'px';
      }

      function urlWithWidth(rawUrl, width) {
        var raw = rawUrl != null ? String(rawUrl).trim() : '';
        if (!raw) return '';
        var w = Math.max(32, Math.floor(Number(width) || 1000));
        try {
          var u = new URL(raw, window.location.origin);
          u.searchParams.set('width', String(w));
          if (u.searchParams.has('height')) u.searchParams.delete('height');
          return u.toString();
        } catch (_) {
          if (/[?&]width=\d+/i.test(raw)) return raw.replace(/([?&]width=)(\d+)/i, '$1' + String(w));
          return raw;
        }
      }

      function setMainImg(imgEl, rawUrl, alt) {
        if (!imgEl) return;
        var u = rawUrl != null ? String(rawUrl).trim() : '';
        imgEl.alt = alt || '';
        if (!u) {
          imgEl.removeAttribute('src');
          imgEl.removeAttribute('srcset');
          imgEl.removeAttribute('sizes');
          imgEl.style.opacity = '0.35';
          return;
        }

        var widths = [360, 540, 720, 900, 1100, 1400];
        imgEl.src = urlWithWidth(u, 900) || u;
        imgEl.srcset = widths.map(function(w) {
          var uu = urlWithWidth(u, w) || u;
          return uu + ' ' + String(w) + 'w';
        }).join(', ');
        imgEl.sizes = '(min-width: 992px) 480px, 92vw';
        imgEl.style.opacity = '1';
      }

      function scrollThumbStrip(dir) {
        ensureDom();
        var strip = document.getElementById('product-insights-thumbs');
        if (!strip) return;
        var step = Math.max(120, Math.round((strip.clientWidth || 0) * 0.85));
        if (!step) step = 160;
        try {
          strip.scrollBy({ left: (dir < 0 ? -step : step), behavior: 'smooth' });
        } catch (_) {
          strip.scrollLeft = (strip.scrollLeft || 0) + (dir < 0 ? -step : step);
        }
        setTimeout(function() { syncThumbStripArrows(); }, 140);
      }

      function render(payload) {
        lastPayload = payload || null;
        var status = document.getElementById('product-insights-status');
        var body = document.getElementById('product-insights-body');
        if (status) status.style.display = 'none';
        if (body) body.style.display = 'block';

        var titleEl = document.getElementById('product-insights-title');
        var detailsTitleEl = document.getElementById('product-insights-details-title');
        var openLink = document.getElementById('product-insights-open-store');
        var adminLink = document.getElementById('product-insights-open-admin');
        var mainImg = document.getElementById('product-insights-main-img');
        var thumbsEl = document.getElementById('product-insights-thumbs');
        var topCountriesCard = document.getElementById('product-insights-top-countries-card');
        var topCountriesEl = document.getElementById('product-insights-top-countries');

        var prod = payload && payload.product ? payload.product : null;
        var metrics = payload && payload.metrics ? payload.metrics : {};
        var details = payload && payload.details ? payload.details : {};
        var isPage = payload && payload.kind === 'page';
        var page = payload && payload.page ? payload.page : null;

        var title = isPage
          ? (page && page.path ? page.path : (currentPageUrl || 'Page'))
          : ((prod && prod.title) ? String(prod.title) : (currentTitle || currentHandle || 'Product'));
        if (titleEl) titleEl.textContent = title;
        if (detailsTitleEl) detailsTitleEl.textContent = isPage ? 'Page details' : 'Product details';
        var rk = (payload && payload.rangeKey) ? String(payload.rangeKey) : currentRangeKey;
        syncRangeSelect(rk);

        if (openLink) {
          var href = isPage ? (currentPageUrl || '#') : (currentProductUrl || '#');
          openLink.href = href;
          openLink.style.display = href && href !== '#' ? 'inline-flex' : 'none';
          openLink.textContent = isPage ? 'View page' : 'View on Website';
        }
        if (adminLink) {
          var adminHref = (!isPage && payload && payload.links && payload.links.adminProductUrl)
            ? String(payload.links.adminProductUrl)
            : '';
          adminLink.href = adminHref || '#';
          adminLink.style.display = adminHref && adminHref !== '#' ? 'inline-flex' : 'none';
          adminLink.textContent = 'Edit on Shopify';
        }

        // Images
        var images = (!isPage && prod && Array.isArray(prod.images)) ? prod.images : [];
        var first = images && images[0] ? images[0] : null;
        if (mainImg) {
          if (isPage) {
            var u = currentPageUrl || (page && page.url ? String(page.url) : '');
            var src = u ? ((API || '') + '/api/og-thumb?url=' + encodeURIComponent(u) + '&width=1000') : '';
            setMainImg(mainImg, src, title);
          } else {
            setMainImg(mainImg, (first && first.url) ? String(first.url) : '', title);
          }
        }
        if (thumbsEl) {
          thumbsEl.innerHTML = isPage ? '' : (images || []).slice(0, 20).map(function(img, i) {
            var u = img && img.url ? String(img.url) : '';
            var t = img && img.thumb ? String(img.thumb) : u;
            if (!u) return '';
            return '<button type="button" class="product-insights-thumb' + (i === 0 ? ' active' : '') + '" data-img="' + escapeHtml(u) + '" aria-label="Image ' + (i + 1) + '">' +
              '<img src="' + escapeHtml(t) + '" alt="" loading="lazy">' +
            '</button>';
          }).join('');
          try { thumbsEl.scrollLeft = 0; } catch (_) {}
          syncThumbStripArrows();

          thumbsEl.querySelectorAll('[data-img]').forEach(function(a) {
            a.addEventListener('click', function(e) {
              e.preventDefault();
              var u = a.getAttribute('data-img') || '';
              if (!u || !mainImg) return;
              thumbsEl.querySelectorAll('.product-insights-thumb').forEach(function(x) { x.classList.remove('active'); });
              a.classList.add('active');
              setMainImg(mainImg, u, title);
            });
          });
        }

        // Metrics table
        var mt = document.getElementById('product-insights-metrics-table');
        if (mt) {
          function row(label, value) {
            return '<tr><td>' + escapeHtml(label) + '</td><td class="w-1 fw-bold text-end">' + escapeHtml(value) + '</td></tr>';
          }
          if (isPage) {
            var sessions = metrics && metrics.sessions != null ? fmtNum(metrics.sessions) : '\u2014';
            var pageViews = metrics && metrics.pageViews != null ? fmtNum(metrics.pageViews) : '\u2014';
            var purchasedSessions = metrics && metrics.purchasedSessions != null ? fmtNum(metrics.purchasedSessions) : '\u2014';
            var checkoutStartedSessions = metrics && metrics.checkoutStartedSessions != null ? fmtNum(metrics.checkoutStartedSessions) : '\u2014';
            var revenue2 = metrics && metrics.revenueGbp != null ? fmtMoneyGbp(metrics.revenueGbp) : '\u2014';
            var cr2 = metrics && metrics.cr != null ? fmtPct(metrics.cr) : '\u2014';
            var rps = metrics && metrics.revPerSession != null ? fmtMoneyGbp(metrics.revPerSession) : '\u2014';
            mt.innerHTML =
              row('Revenue', revenue2) +
              row('Purchased sessions', purchasedSessions) +
              row('Checkout started sessions', checkoutStartedSessions) +
              row('Sessions', sessions) +
              row('Page views', pageViews) +
              row('Purchase rate', cr2) +
              row('Revenue / Session', rps);
          } else {
            var revenue = metrics && metrics.revenueGbp != null ? fmtMoneyGbp(metrics.revenueGbp) : '\u2014';
            var units = metrics && metrics.units != null ? fmtNum(metrics.units) : '\u2014';
            var views = metrics && metrics.views != null ? fmtNum(metrics.views) : '\u2014';
            var atc = metrics && metrics.addToCart != null ? fmtNum(metrics.addToCart) : '\u2014';
            var cs = metrics && metrics.checkoutStarted != null ? fmtNum(metrics.checkoutStarted) : '\u2014';
            var atcRate = metrics && metrics.atcRate != null ? fmtPct(metrics.atcRate) : '\u2014';
            var clicks = metrics && metrics.clicks != null ? fmtNum(metrics.clicks) : '\u2014';
            var conv = metrics && metrics.orders != null ? fmtNum(metrics.orders) : '\u2014';
            var cr = metrics && metrics.cr != null ? fmtPct(metrics.cr) : '\u2014';
            var rpc = metrics && metrics.revPerClick != null ? fmtMoneyGbp(metrics.revPerClick) : '\u2014';
            var rpv = metrics && metrics.revPerView != null ? fmtMoneyGbp(metrics.revPerView) : '\u2014';
            var totalSales = details && details.totalSalesLifetime != null ? fmtNum(details.totalSalesLifetime) : '\u2014';
            var totalRev = details && details.totalRevenueLifetimeGbp != null ? fmtMoneyGbp(details.totalRevenueLifetimeGbp) : '\u2014';
            var cogs = details && details.costOfGoodsLifetimeGbp != null ? fmtMoneyGbp(details.costOfGoodsLifetimeGbp) : '\u2014';
            var stockUnits = details && details.inventoryUnits != null ? fmtNum(details.inventoryUnits) : '\u2014';
            var stockVariants = details && details.inStockVariants != null ? fmtNum(details.inStockVariants) : '\u2014';
            mt.innerHTML =
              row('Clicks', clicks) +
              row('Conversions', conv) +
              row('Conversion rate', cr) +
              row('Revenue (selected range)', revenue) +
              row('Units sold (selected range)', units) +
              row('Views (pixel)', views) +
              row('Add to cart', atc) +
              row('Checkout started', cs) +
              row('View to Cart rate', atcRate) +
              row('Revenue / Click', rpc) +
              row('Revenue / View', rpv) +
              row('In stock (units)', stockUnits) +
              row('In-stock variants', stockVariants) +
              row('Total sales (lifetime)', totalSales) +
              row('Total revenue (lifetime)', totalRev) +
              row('Cost of goods (lifetime)', cogs);
          }
        }

        if (topCountriesCard && topCountriesEl) {
          var top = (!isPage && payload && Array.isArray(payload.topCountries)) ? payload.topCountries : [];
          if (top && top.length) {
            topCountriesCard.style.display = '';
            topCountriesEl.innerHTML = top.slice(0, 5).map(function(r) {
              var iso = (r && r.country_code != null ? String(r.country_code) : 'XX').toUpperCase().slice(0, 2);
              if (iso === 'UK') iso = 'GB';
              var name = countryLabel(iso);
              var flag = flagImg(iso, name);
              var conv = (r && r.orders != null) ? (Number(r.orders) || 0) : 0;
              var rev = (r && r.revenueGbp != null) ? Number(r.revenueGbp) : null;
              var revText = (rev != null && isFinite(rev)) ? fmtMoneyGbp(rev) : '\u2014';
              return '' +
                '<div class="d-flex align-items-center justify-content-between">' +
                  '<div class="d-flex align-items-center gap-2 min-w-0">' +
                    flag +
                    '<span class="text-truncate">' + escapeHtml(name) + '</span>' +
                  '</div>' +
                  '<div class="text-end">' +
                    '<div class="fw-semibold" style="font-size:.875rem">' + escapeHtml(fmtNum(conv)) + ' conversions</div>' +
                    '<div class="text-muted small">' + escapeHtml(revText) + '</div>' +
                  '</div>' +
                '</div>';
            }).join('');
          } else {
            topCountriesCard.style.display = 'none';
            topCountriesEl.innerHTML = '';
          }
        }

        syncMainImageBalance();
        renderCharts(payload);
      }

      function load() {
        ensureDom();
        setStatus('Loading\u2026');

        var shop = null;
        try { shop = getShopParam() || shopForSalesFallback || null; } catch (_) { shop = null; }
        var url = '';
        if (currentMode === 'page') {
          if (!currentPageUrl) { setStatus('No page selected.'); return; }
          url = (API || '') + '/api/page-insights?url=' + encodeURIComponent(currentPageUrl) +
            '&kind=' + encodeURIComponent(currentLandingKind || 'entry') +
            '&range=' + encodeURIComponent(currentRangeKey || 'today') +
            '&_=' + Date.now();
        } else {
          if (!currentHandle && !currentProductId) { setStatus('No product selected.'); return; }
          var q = 'range=' + encodeURIComponent(currentRangeKey || 'today') + (shop ? ('&shop=' + encodeURIComponent(shop)) : '') + '&_=' + Date.now();
          if (currentHandle) {
            url = (API || '') + '/api/product-insights?handle=' + encodeURIComponent(currentHandle) + '&' + q;
          } else {
            url = (API || '') + '/api/product-insights?product_id=' + encodeURIComponent(currentProductId) + '&' + q;
          }
        }

        fetchWithTimeout(url, { credentials: 'same-origin', cache: 'no-store' }, 30000)
          .then(function(r) { return r && r.ok ? r.json() : null; })
          .then(function(data) {
            if (!data || !data.ok) {
              setStatus(currentMode === 'page' ? 'No data available for this page.' : 'No data available for this product.');
              return;
            }
            render(data);
          })
          .catch(function() { setStatus(currentMode === 'page' ? 'Could not load page insights.' : 'Could not load product insights.'); });
      }

      function openProduct(handleOrProductId, options) {
        options = options || {};
        var raw = String(handleOrProductId || '').trim();
        var pid = options.productId ? String(options.productId).trim() : '';
        if (!pid && /^\d+$/.test(raw)) pid = raw;
        if (!pid && /gid:\/\/shopify\/Product\/(\d+)/i.test(raw)) pid = raw.replace(/gid:\/\/shopify\/Product\/(\d+)/i, '$1');
        var h = pid ? null : normalizeHandle(handleOrProductId);
        if (!h && !pid) return;
        currentHandle = h || null;
        currentProductId = pid || null;
        currentMode = 'product';
        currentPageUrl = null;
        currentTitle = options.title ? String(options.title) : null;
        currentProductUrl = options.productUrl ? String(options.productUrl) : null;
        currentLandingKind = options.landingKind ? String(options.landingKind) : null;
        currentRangeKey = globalRangeKeyOrToday();
        ensureDom();
        syncRangeSelect(currentRangeKey);
        show();
        load();
      }

      function openPage(url, options) {
        var u = url != null ? String(url).trim() : '';
        if (!u) return;
        currentMode = 'page';
        currentPageUrl = u;
        currentHandle = null;
        currentProductId = null;
        options = options || {};
        currentTitle = options.title ? String(options.title) : null;
        currentProductUrl = null;
        currentLandingKind = options.landingKind ? String(options.landingKind) : null;
        currentRangeKey = globalRangeKeyOrToday();
        ensureDom();
        syncRangeSelect(currentRangeKey);
        show();
        load();
      }

      // Delegate clicks from product links (tables, breakdowns, etc.)
      document.addEventListener('click', function(e) {
        var a = e && e.target && e.target.closest ? e.target.closest('a.js-product-modal-link') : null;
        if (!a) return;
        if (isModifiedClick(e)) return;
        var h = normalizeHandle(a.getAttribute('data-product-handle') || '');
        if (!h) h = parseHandleFromHref(a.getAttribute('href') || '');
        var pid = (a.getAttribute('data-product-id') || '').trim();
        if (!h && !pid) return;
        e.preventDefault();
        openProduct(h || pid, {
          title: a.getAttribute('data-product-title') || '',
          productUrl: a.getAttribute('href') || '',
          productId: pid || undefined,
        });
      });

      // Expose for debugging / future use
      window.__openProductInsights = openProduct;
    })();

/**
 * Layout shortcut modals — open table or chart settings in a modal from card header gear.
 * Saves via POST /api/settings; updates localStorage and dispatches kexo:tablesUiConfigUpdated / kexo:chartsUiConfigUpdated.
 */
(function () {
  'use strict';

  var TABLES_LS_KEY = 'kexo:tables-ui-config:v1';
  var CHARTS_LS_KEY = 'kexo:charts-ui-config:v1';
  var MODAL_ID = 'kexo-layout-shortcut-modal';

  function escapeHtml(str) {
    if (str == null) return '';
    try {
      var div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    } catch (_) {
      return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
    }
  }

  function parseRowOptionsText(raw) {
    var text = raw == null ? '' : String(raw);
    var parts = text.split(/[^0-9]+/g);
    var out = [];
    var seen = {};
    parts.forEach(function (p) {
      if (!p) return;
      var n = parseInt(p, 10);
      if (!Number.isFinite(n) || n <= 0 || n > 200) return;
      if (seen[n]) return;
      seen[n] = true;
      out.push(n);
    });
    out.sort(function (a, b) { return a - b; });
    return out.slice(0, 12);
  }

  function formatRowOptionsText(list) {
    return (Array.isArray(list) ? list : []).map(function (n) { return String(n); }).join(', ');
  }

  function defaultSingleTableRow(pageKey, tableId) {
    return {
      id: tableId,
      name: tableId,
      order: 1,
      tableClass: '',
      zone: '',
      inGrid: true,
      rows: { default: 20, options: [20, 30, 40, 50] },
      sticky: { minWidth: null, maxWidth: null },
    };
  }

  function renderTableModalBody(t) {
    var name = t.name != null ? String(t.name) : (t.id || '');
    var rowOptions = t.rows && Array.isArray(t.rows.options) ? t.rows.options : [20, 30, 40, 50];
    var defaultRows = t.rows && typeof t.rows.default === 'number' ? t.rows.default : (rowOptions[0] || 20);
    if (rowOptions.indexOf(defaultRows) < 0 && rowOptions.length) defaultRows = rowOptions[0];
    var stickyMin = t.sticky && typeof t.sticky.minWidth === 'number' ? t.sticky.minWidth : null;
    var stickyMax = t.sticky && typeof t.sticky.maxWidth === 'number' ? t.sticky.maxWidth : null;
    var inGrid = t.inGrid !== false;
    var defaultOptsHtml = (rowOptions.length ? rowOptions : [defaultRows]).map(function (n) {
      return '<option value="' + String(n) + '"' + (Number(n) === Number(defaultRows) ? ' selected' : '') + '>' + String(n) + '</option>';
    }).join('');
    return (
      '<div class="row g-3">' +
        '<div class="col-12">' +
          '<label class="form-label mb-1">Display name</label>' +
          '<input type="text" class="form-control form-control-sm" data-field="name" value="' + escapeHtml(name) + '">' +
        '</div>' +
        '<div class="col-12 col-md-6">' +
          '<label class="form-label mb-1">Rows options</label>' +
          '<input type="text" class="form-control form-control-sm" data-field="rows-options" value="' + escapeHtml(formatRowOptionsText(rowOptions)) + '" placeholder="e.g. 5, 10, 15, 20">' +
          '<div class="text-muted small mt-1">Comma-separated values.</div>' +
        '</div>' +
        '<div class="col-12 col-md-6">' +
          '<label class="form-label mb-1">Default rows</label>' +
          '<select class="form-select form-select-sm" data-field="rows-default">' + defaultOptsHtml + '</select>' +
        '</div>' +
        '<div class="col-12 col-md-6">' +
          '<label class="form-label mb-1">Sticky min width (px)</label>' +
          '<input type="number" class="form-control form-control-sm" data-field="sticky-min" placeholder="auto" value="' + (stickyMin == null ? '' : escapeHtml(String(stickyMin))) + '">' +
        '</div>' +
        '<div class="col-12 col-md-6">' +
          '<label class="form-label mb-1">Sticky max width (px)</label>' +
          '<input type="number" class="form-control form-control-sm" data-field="sticky-max" placeholder="auto" value="' + (stickyMax == null ? '' : escapeHtml(String(stickyMax))) + '">' +
        '</div>' +
        '<div class="col-12">' +
          '<label class="form-check form-switch m-0">' +
            '<input class="form-check-input" type="checkbox" data-field="inGrid"' + (inGrid ? ' checked' : '') + '>' +
            '<span class="form-check-label small ms-2">Keep in grid layout</span>' +
          '</label>' +
        '</div>' +
      '</div>'
    );
  }

  function readTableModalBody(container) {
    if (!container || !container.querySelector) return null;
    var nameEl = container.querySelector('input[data-field="name"]');
    var optionsEl = container.querySelector('input[data-field="rows-options"]');
    var defaultEl = container.querySelector('select[data-field="rows-default"]');
    var stickyMinEl = container.querySelector('input[data-field="sticky-min"]');
    var stickyMaxEl = container.querySelector('input[data-field="sticky-max"]');
    var inGridEl = container.querySelector('input[data-field="inGrid"]');
    var options = parseRowOptionsText(optionsEl ? optionsEl.value : '');
    if (!options.length) options = [20];
    var defaultRows = parseInt(String(defaultEl && defaultEl.value != null ? defaultEl.value : ''), 10);
    if (!Number.isFinite(defaultRows) && options.length) defaultRows = options[0];
    function parseSticky(inp) {
      if (!inp) return null;
      var raw = String(inp.value || '').trim();
      if (!raw) return null;
      var n = parseInt(raw, 10);
      return Number.isFinite(n) ? n : null;
    }
    return {
      name: nameEl && nameEl.value != null ? String(nameEl.value).trim() : '',
      rows: { default: Number.isFinite(defaultRows) ? defaultRows : options[0], options: options },
      sticky: { minWidth: parseSticky(stickyMinEl), maxWidth: parseSticky(stickyMaxEl) },
      inGrid: !!(inGridEl && inGridEl.checked),
    };
  }

  function updateTableDefaultRowsSelect(container) {
    if (!container || !container.querySelector) return;
    var optionsInput = container.querySelector('input[data-field="rows-options"]');
    var defaultSel = container.querySelector('select[data-field="rows-default"]');
    if (!optionsInput || !defaultSel) return;
    var options = parseRowOptionsText(optionsInput.value);
    if (!options.length) options = [20];
    var cur = parseInt(String(defaultSel.value || ''), 10);
    if (!Number.isFinite(cur) || options.indexOf(cur) < 0) cur = options[0];
    defaultSel.innerHTML = options.map(function (n) {
      return '<option value="' + String(n) + '"' + (n === cur ? ' selected' : '') + '>' + String(n) + '</option>';
    }).join('');
  }

  function ensureModal() {
    var existing = document.getElementById(MODAL_ID);
    if (existing) return existing;
    var wrap = document.createElement('div');
    wrap.innerHTML = (
      '<div class="modal modal-blur" id="' + MODAL_ID + '" tabindex="-1" role="dialog" aria-labelledby="' + MODAL_ID + '-title" aria-hidden="true">' +
        '<div class="modal-dialog modal-lg modal-dialog-scrollable modal-dialog-centered" role="document">' +
          '<div class="modal-content">' +
            '<div class="modal-header">' +
              '<h5 class="modal-title" id="' + MODAL_ID + '-title">Layout settings</h5>' +
              '<button type="button" class="btn-close" aria-label="Close" data-kexo-layout-modal-close></button>' +
            '</div>' +
            '<div class="modal-body" id="' + MODAL_ID + '-body"></div>' +
            '<div class="modal-footer">' +
              '<span id="' + MODAL_ID + '-msg" class="form-hint me-auto"></span>' +
              '<button type="button" class="btn btn-secondary" data-kexo-layout-modal-close>Cancel</button>' +
              '<button type="button" class="btn btn-primary" id="' + MODAL_ID + '-save-btn">Save</button>' +
            '</div>' +
          '</div>' +
        '</div>' +
      '</div>'
    );
    var el = wrap.firstChild;
    document.body.appendChild(el);
    try { initModalClose(); } catch (_) {}
    return el;
  }

  function setMsg(text, ok) {
    var msg = document.getElementById(MODAL_ID + '-msg');
    if (msg) {
      msg.textContent = text || '';
      msg.className = 'form-hint me-auto ' + (ok === true ? 'text-success' : ok === false ? 'text-danger' : '');
    }
  }

  function closeModal() {
    var modal = document.getElementById(MODAL_ID);
    if (!modal) return;
    try {
      if (window.bootstrap && window.bootstrap.Modal) {
        var inst = window.bootstrap.Modal.getInstance(modal);
        if (inst) inst.hide();
      }
    } catch (_) {}
    modal.classList.remove('show');
    modal.style.display = '';
    document.body.classList.remove('modal-open');
    try {
      document.querySelectorAll('.modal-backdrop[data-kexo-layout-backdrop="1"]').forEach(function (b) { if (b && b.parentNode) b.parentNode.removeChild(b); });
    } catch (_) {}
  }

  function showModal() {
    var modal = ensureModal();
    modal.style.display = 'block';
    modal.classList.add('show');
    document.body.classList.add('modal-open');
    var backdrop = document.createElement('div');
    backdrop.className = 'modal-backdrop fade show';
    backdrop.setAttribute('data-kexo-layout-backdrop', '1');
    document.body.appendChild(backdrop);
    backdrop.addEventListener('click', function () { closeModal(); });
    try {
      if (window.bootstrap && window.bootstrap.Modal) {
        var inst = window.bootstrap.Modal.getOrCreateInstance(modal, { backdrop: true, keyboard: true });
        inst.show();
      }
    } catch (_) {}
  }

  function saveTablesUiConfig(cfg) {
    var api = (typeof API !== 'undefined' ? API : '') || '';
    return fetch(api + '/api/settings', {
      method: 'POST',
      credentials: 'same-origin',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ tablesUiConfig: cfg }),
    }).then(function (r) { return r.json(); }).then(function (data) {
      if (data && data.ok && data.tablesUiConfig) {
        try { (typeof safeWriteLocalStorageJson === 'function' ? safeWriteLocalStorageJson : function (k, v) { try { localStorage.setItem(k, typeof v === 'string' ? v : JSON.stringify(v)); } catch (_) {} })(TABLES_LS_KEY, data.tablesUiConfig); } catch (_) {}
        try { window.dispatchEvent(new CustomEvent('kexo:tablesUiConfigUpdated', { detail: data.tablesUiConfig })); } catch (_) {}
      }
      return data;
    });
  }

  function saveChartsUiConfig(cfg) {
    var api = (typeof API !== 'undefined' ? API : '') || '';
    return fetch(api + '/api/settings', {
      method: 'POST',
      credentials: 'same-origin',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ chartsUiConfig: cfg }),
    }).then(function (r) { return r.json(); }).then(function (data) {
      if (data && data.ok && data.chartsUiConfig) {
        try { (typeof safeWriteLocalStorageJson === 'function' ? safeWriteLocalStorageJson : function (k, v) { try { localStorage.setItem(k, typeof v === 'string' ? v : JSON.stringify(v)); } catch (_) {} })(CHARTS_LS_KEY, data.chartsUiConfig); } catch (_) {}
        try { window.dispatchEvent(new CustomEvent('kexo:chartsUiConfigUpdated', { detail: data.chartsUiConfig })); } catch (_) {}
      }
      return data;
    });
  }

  function findPageAndTableIndex(cfg, pageKey, tableId) {
    if (!cfg || cfg.v !== 1 || !Array.isArray(cfg.pages)) return { pageIndex: -1, tableIndex: -1 };
    var pk = String(pageKey || '').trim().toLowerCase();
    var tid = String(tableId || '').trim().toLowerCase();
    for (var pi = 0; pi < cfg.pages.length; pi++) {
      var p = cfg.pages[pi];
      if (!p || String(p.key || '').trim().toLowerCase() !== pk) continue;
      var tables = Array.isArray(p.tables) ? p.tables : [];
      for (var ti = 0; ti < tables.length; ti++) {
        if (tables[ti] && String(tables[ti].id || '').trim().toLowerCase() === tid) return { pageIndex: pi, tableIndex: ti };
      }
      return { pageIndex: pi, tableIndex: -1 };
    }
    return { pageIndex: -1, tableIndex: -1 };
  }

  function openTableModal(opts) {
    var pageKey = (opts && opts.pageKey != null) ? String(opts.pageKey).trim().toLowerCase() : '';
    var tableId = (opts && opts.tableId != null) ? String(opts.tableId).trim() : '';
    var cardTitle = (opts && opts.cardTitle != null) ? String(opts.cardTitle).trim() : tableId;
    if (!pageKey || !tableId) return;

    var modal = ensureModal();
    var titleEl = document.getElementById(MODAL_ID + '-title');
    var bodyEl = document.getElementById(MODAL_ID + '-body');
    var saveBtn = document.getElementById(MODAL_ID + '-save-btn');
    if (titleEl) titleEl.textContent = 'Table: ' + cardTitle;
    if (!bodyEl) return;

    setMsg('Loading…', null);
    var api = (typeof API !== 'undefined' ? API : '') || '';
    fetch(api + '/api/settings', { credentials: 'same-origin', cache: 'no-store' })
      .then(function (r) { return r.json(); })
      .then(function (data) {
        var cfg = (data && data.ok && data.tablesUiConfig) ? data.tablesUiConfig : null;
        if (!cfg || cfg.v !== 1 || !Array.isArray(cfg.pages)) {
          cfg = (typeof safeReadLocalStorageJson === 'function' ? safeReadLocalStorageJson(TABLES_LS_KEY) : null) || { v: 1, pages: [] };
        }
        var found = findPageAndTableIndex(cfg, pageKey, tableId);
        var t;
        if (found.pageIndex >= 0 && found.tableIndex >= 0) {
          t = cfg.pages[found.pageIndex].tables[found.tableIndex];
          t = { id: t.id, name: t.name, order: t.order, tableClass: t.tableClass, zone: t.zone, inGrid: t.inGrid, rows: t.rows, sticky: t.sticky };
        } else {
          t = defaultSingleTableRow(pageKey, tableId);
        }
        bodyEl.innerHTML = renderTableModalBody(t);
        bodyEl.setAttribute('data-kexo-layout-mode', 'table');
        bodyEl.setAttribute('data-kexo-layout-page-key', pageKey);
        bodyEl.setAttribute('data-kexo-layout-table-id', tableId);
        bodyEl.removeAttribute('data-kexo-layout-chart-key');
        setMsg('', null);

        bodyEl.addEventListener('input', function (e) {
          if (e.target && e.target.getAttribute('data-field') === 'rows-options') updateTableDefaultRowsSelect(bodyEl);
        });
        bodyEl.addEventListener('change', function (e) {
          if (e.target && e.target.getAttribute('data-field') === 'rows-options') updateTableDefaultRowsSelect(bodyEl);
        });

        var saveHandler = function () {
          var patch = readTableModalBody(bodyEl);
          if (!patch) return;
          setMsg('Saving…', null);
          var nextCfg = JSON.parse(JSON.stringify(cfg));
          var f = findPageAndTableIndex(nextCfg, pageKey, tableId);
          var row = { id: tableId, name: patch.name || tableId, order: 1, tableClass: t.tableClass || '', zone: t.zone || '', inGrid: patch.inGrid, rows: patch.rows, sticky: patch.sticky };
          if (f.pageIndex >= 0) {
            if (f.tableIndex >= 0) {
              row.order = nextCfg.pages[f.pageIndex].tables[f.tableIndex].order;
              nextCfg.pages[f.pageIndex].tables[f.tableIndex] = row;
            } else {
              row.order = (nextCfg.pages[f.pageIndex].tables.length + 1);
              nextCfg.pages[f.pageIndex].tables.push(row);
            }
          } else {
            nextCfg.pages.push({ key: pageKey, label: pageKey, tables: [row] });
          }
          saveTablesUiConfig(nextCfg).then(function (data) {
            if (data && data.ok) {
              try {
                var nextRows = patch && patch.rows && typeof patch.rows.default === 'number' ? patch.rows.default : null;
                if (nextRows != null) {
                  if (typeof window.setTableRowsPerPage === 'function') window.setTableRowsPerPage(tableId, nextRows, 'live');
                  if (typeof window.applyTableRowsPerPageChange === 'function') window.applyTableRowsPerPageChange(tableId, nextRows);
                }
              } catch (_) {}
              setMsg('Saved.', true);
              closeModal();
            } else {
              setMsg((data && data.error) ? String(data.error) : 'Save failed', false);
            }
          }).catch(function () { setMsg('Save failed', false); });
        };

        saveBtn.replaceWith(saveBtn.cloneNode(true));
        document.getElementById(MODAL_ID + '-save-btn').addEventListener('click', saveHandler);
        showModal();
      })
      .catch(function () {
        setMsg('Could not load settings.', false);
        var t = defaultSingleTableRow(pageKey, tableId);
        bodyEl.innerHTML = renderTableModalBody(t);
        bodyEl.setAttribute('data-kexo-layout-mode', 'table');
        bodyEl.setAttribute('data-kexo-layout-page-key', pageKey);
        bodyEl.setAttribute('data-kexo-layout-table-id', tableId);
        bodyEl.removeAttribute('data-kexo-layout-chart-key');
        var nextCfg = { v: 1, pages: [] };
        saveBtn.replaceWith(saveBtn.cloneNode(true));
        document.getElementById(MODAL_ID + '-save-btn').addEventListener('click', function () {
          var patch = readTableModalBody(bodyEl);
          if (!patch) return;
          setMsg('Saving…', null);
          var row = { id: tableId, name: patch.name || tableId, order: 1, tableClass: t.tableClass || '', zone: t.zone || '', inGrid: patch.inGrid, rows: patch.rows, sticky: patch.sticky };
          nextCfg.pages.push({ key: pageKey, label: pageKey, tables: [row] });
          saveTablesUiConfig(nextCfg).then(function (data) {
            if (data && data.ok) {
              try {
                var nextRows = patch && patch.rows && typeof patch.rows.default === 'number' ? patch.rows.default : null;
                if (nextRows != null) {
                  if (typeof window.setTableRowsPerPage === 'function') window.setTableRowsPerPage(tableId, nextRows, 'live');
                  if (typeof window.applyTableRowsPerPageChange === 'function') window.applyTableRowsPerPageChange(tableId, nextRows);
                }
              } catch (_) {}
              setMsg('Saved.', true);
              closeModal();
            } else {
              setMsg((data && data.error) ? String(data.error) : 'Save failed', false);
            }
          }).catch(function () { setMsg('Save failed', false); });
        });
        showModal();
      });
  }

  function openChartModal(opts) {
    if (window.KexoChartSettingsBuilder && typeof window.KexoChartSettingsBuilder.openModal === 'function') {
      window.KexoChartSettingsBuilder.openModal(opts);
    }
  }

  function initModalClose() {
    var modal = document.getElementById(MODAL_ID);
    if (!modal) return;
    if (modal.getAttribute('data-kexo-layout-close-wired') === '1') return;
    modal.setAttribute('data-kexo-layout-close-wired', '1');
    function close(e) {
      try { if (e && typeof e.preventDefault === 'function') e.preventDefault(); } catch (_) {}
      closeModal();
    }
    modal.querySelectorAll('[data-kexo-layout-modal-close]').forEach(function (btn) { btn.addEventListener('click', close); });
    modal.addEventListener('click', function (e) { if (e && e.target === modal) close(e); });
    if (document.documentElement.getAttribute('data-kexo-layout-esc-wired') !== '1') {
      document.documentElement.setAttribute('data-kexo-layout-esc-wired', '1');
      document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape') {
          var m = document.getElementById(MODAL_ID);
          if (m && m.classList && m.classList.contains('show')) close(e);
        }
      });
    }
  }

  try {
    window.KexoLayoutShortcuts = {
      openTableModal: openTableModal,
      openChartModal: openChartModal,
      saveTablesUiConfig: saveTablesUiConfig,
      saveChartsUiConfig: saveChartsUiConfig,
      renderTableModalBody: renderTableModalBody,
      readTableModalBody: readTableModalBody,
    };
  } catch (_) {}

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initModalClose);
  } else {
    initModalClose();
  }
})();
/**
 * Dashboard: Profit Rules modal opener (Cost Settings shortcut).
 * Reuses the same modal markup/IDs as Snapshot, but runs only on dashboard pages.
 */
(function () {
  'use strict';

  function bodyPage() {
    try { return String(document.body && document.body.getAttribute('data-page') || ''); } catch (_) { return ''; }
  }
  if (bodyPage() !== 'dashboard') return;

  function esc(str) {
    try {
      var div = document.createElement('div');
      div.textContent = str == null ? '' : String(str);
      return div.innerHTML;
    } catch (_) {
      return String(str == null ? '' : str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }
  }

  function fetchJson(url, opts) {
    return fetch(url, opts || {})
      .then(function (r) { return (r && r.ok) ? r.json() : null; })
      .catch(function () { return null; });
  }

  var state = {
    open: false,
    backdrop: null,
    rulesDraft: null,
    editingRuleId: '',
  };

  function openModal() {
    var modal = document.getElementById('profit-rules-modal');
    if (!modal) return;
    if (state.open) return;
    state.open = true;
    modal.style.display = 'block';
    modal.classList.add('show');
    modal.setAttribute('aria-hidden', 'false');
    document.body.classList.add('modal-open');
    var backdrop = document.createElement('div');
    backdrop.className = 'modal-backdrop fade show';
    backdrop.addEventListener('click', closeModal);
    document.body.appendChild(backdrop);
    state.backdrop = backdrop;
  }

  function closeModal() {
    var modal = document.getElementById('profit-rules-modal');
    if (!modal) return;
    modal.classList.remove('show');
    modal.style.display = 'none';
    modal.setAttribute('aria-hidden', 'true');
    if (state.backdrop && state.backdrop.parentNode) {
      state.backdrop.parentNode.removeChild(state.backdrop);
    }
    state.backdrop = null;
    state.open = false;
    document.body.classList.remove('modal-open');
  }

  function createRuleId() {
    return 'rule_' + Date.now().toString(36) + '_' + Math.random().toString(36).slice(2, 7);
  }

  function normalizeCountryCode(value) {
    var raw = String(value || '').trim().toUpperCase().slice(0, 2);
    if (!raw) return '';
    var cc = raw === 'UK' ? 'GB' : raw;
    if (!/^[A-Z]{2}$/.test(cc)) return '';
    return cc;
  }

  function normalizeRulesPayload(payload) {
    var src = payload && typeof payload === 'object' ? payload : {};
    var list = Array.isArray(src.rules) ? src.rules : [];
    var out = {
      enabled: !!src.enabled,
      currency: 'GBP',
      integrations: {
        includeGoogleAdsSpend: !!(src.integrations && src.integrations.includeGoogleAdsSpend === true),
        includeShopifyAppBills: false,
        includePaymentFees: !!(src.integrations && src.integrations.includePaymentFees === true),
        includeKlarnaFees: !!(src.integrations && src.integrations.includeKlarnaFees === true),
        includeShopifyTaxes: !!(src.integrations && src.integrations.includeShopifyTaxes === true),
      },
      rules: [],
    };
    for (var i = 0; i < list.length; i += 1) {
      var row = list[i] && typeof list[i] === 'object' ? list[i] : {};
      var appliesMode = row.appliesTo && row.appliesTo.mode === 'countries' ? 'countries' : 'all';
      var countries = (appliesMode === 'countries' && Array.isArray(row.appliesTo && row.appliesTo.countries))
        ? row.appliesTo.countries.map(normalizeCountryCode).filter(Boolean)
        : [];
      out.rules.push({
        id: row.id ? String(row.id) : createRuleId(),
        name: row.name ? String(row.name) : 'Expense',
        type: row.type ? String(row.type) : 'percent_revenue',
        value: Number.isFinite(Number(row.value)) ? Number(row.value) : 0,
        enabled: row.enabled !== false,
        sort: Number.isFinite(Number(row.sort)) ? Math.trunc(Number(row.sort)) : (i + 1),
        appliesTo: (appliesMode === 'countries' && countries.length)
          ? { mode: 'countries', countries: countries.slice(0, 64) }
          : { mode: 'all', countries: [] },
      });
    }
    out.rules.sort(function (a, b) { return (Number(a.sort) || 0) - (Number(b.sort) || 0); });
    return out;
  }

  function setMessage(text, isOk) {
    var el = document.getElementById('profit-rules-msg');
    if (!el) return;
    el.textContent = text || '';
    el.classList.toggle('is-hidden', !text);
    el.classList.toggle('text-success', !!isOk);
    el.classList.toggle('text-danger', isOk === false);
  }

  function sortDraft() {
    if (!state.rulesDraft || !Array.isArray(state.rulesDraft.rules)) return;
    state.rulesDraft.rules.sort(function (a, b) {
      var sa = Number(a && a.sort != null ? a.sort : 0) || 0;
      var sb = Number(b && b.sort != null ? b.sort : 0) || 0;
      if (sa !== sb) return sa - sb;
      return String(a && a.id || '').localeCompare(String(b && b.id || ''));
    });
  }

  function reindexDraft() {
    if (!state.rulesDraft || !Array.isArray(state.rulesDraft.rules)) return;
    sortDraft();
    state.rulesDraft.rules.forEach(function (rule, idx) {
      if (!rule) return;
      rule.sort = idx + 1;
    });
  }

  function getRuleById(ruleId) {
    if (!state.rulesDraft || !Array.isArray(state.rulesDraft.rules)) return null;
    return state.rulesDraft.rules.find(function (rule) { return String(rule && rule.id || '') === String(ruleId || ''); }) || null;
  }

  function ruleTypeLabel(type) {
    if (type === 'fixed_per_order') return 'Fixed per order';
    if (type === 'fixed_per_period') return 'Fixed per period';
    return 'Percent of revenue';
  }

  function ruleValueLabel(rule) {
    if (!rule) return '-';
    var value = Number(rule.value);
    if (!Number.isFinite(value)) return '-';
    if (rule.type === 'percent_revenue') return value.toFixed(2).replace(/\.00$/, '') + '%';
    return '\u00a3' + value.toFixed(2);
  }

  function renderRulesList() {
    var bodyEl = document.getElementById('profit-rules-table-body');
    if (!bodyEl) return;
    if (!state.rulesDraft || !Array.isArray(state.rulesDraft.rules) || !state.rulesDraft.rules.length) {
      bodyEl.innerHTML = '<tr><td colspan="6" class="text-muted">No rules yet.</td></tr>';
      return;
    }
    sortDraft();
    var html = '';
    state.rulesDraft.rules.forEach(function (rule, idx) {
      var countryLabel = rule && rule.appliesTo && rule.appliesTo.mode === 'countries'
        ? ((rule.appliesTo.countries || []).join(', ') || '-')
        : 'ALL';
      html += '' +
        '<tr data-rule-id="' + esc(rule.id || '') + '">' +
          '<td>' + esc(rule.name || 'Expense') + '</td>' +
          '<td>' + esc(ruleTypeLabel(rule.type)) + '</td>' +
          '<td class="text-end">' + esc(ruleValueLabel(rule)) + '</td>' +
          '<td class="text-center">' + esc(countryLabel) + '</td>' +
          '<td class="text-center">' +
            '<input type="checkbox" data-pr-action="toggle-enabled" data-rule-id="' + esc(rule.id || '') + '"' + (rule.enabled ? ' checked' : '') + ' />' +
          '</td>' +
          '<td class="text-end text-nowrap">' +
            '<button type="button" class="btn btn-sm btn-ghost-secondary" data-pr-action="move-up" data-rule-id="' + esc(rule.id || '') + '"' + (idx <= 0 ? ' disabled' : '') + '>Up</button> ' +
            '<button type="button" class="btn btn-sm btn-ghost-secondary" data-pr-action="move-down" data-rule-id="' + esc(rule.id || '') + '"' + (idx >= state.rulesDraft.rules.length - 1 ? ' disabled' : '') + '>Down</button> ' +
            '<button type="button" class="btn btn-sm btn-ghost-secondary" data-pr-action="edit" data-rule-id="' + esc(rule.id || '') + '">Edit</button> ' +
            '<button type="button" class="btn btn-sm btn-ghost-danger" data-pr-action="delete" data-rule-id="' + esc(rule.id || '') + '">Delete</button>' +
          '</td>' +
        '</tr>';
    });
    bodyEl.innerHTML = html;
  }

  function hideForm() {
    var panel = document.getElementById('profit-rules-form-wrap');
    if (panel) panel.classList.add('is-hidden');
    state.editingRuleId = '';
    var idEl = document.getElementById('profit-rule-id');
    if (idEl) idEl.value = '';
  }

  function showForm(rule) {
    var panel = document.getElementById('profit-rules-form-wrap');
    if (panel) panel.classList.remove('is-hidden');
    state.editingRuleId = rule ? String(rule.id || '') : '';
    var idEl = document.getElementById('profit-rule-id');
    var nameEl = document.getElementById('profit-rule-name');
    var typeEl = document.getElementById('profit-rule-type');
    var valueEl = document.getElementById('profit-rule-value');
    var countryEl = document.getElementById('profit-rule-country');
    var sortEl = document.getElementById('profit-rule-sort');
    var enabledEl = document.getElementById('profit-rule-enabled');
    if (idEl) idEl.value = state.editingRuleId;
    if (nameEl) nameEl.value = rule ? (rule.name || '') : '';
    if (typeEl) typeEl.value = rule ? (rule.type || 'percent_revenue') : 'percent_revenue';
    if (valueEl) valueEl.value = rule && rule.value != null ? String(Number(rule.value) || 0) : '';
    if (countryEl) countryEl.value = (rule && rule.appliesTo && rule.appliesTo.mode === 'countries')
      ? ((rule.appliesTo.countries || []).join(','))
      : '';
    if (sortEl) sortEl.value = rule && Number.isFinite(Number(rule.sort)) ? String(Math.trunc(Number(rule.sort))) : String((state.rulesDraft && state.rulesDraft.rules ? state.rulesDraft.rules.length + 1 : 1));
    if (enabledEl) enabledEl.checked = rule ? (rule.enabled !== false) : true;
  }

  function readForm() {
    var nameEl = document.getElementById('profit-rule-name');
    var typeEl = document.getElementById('profit-rule-type');
    var valueEl = document.getElementById('profit-rule-value');
    var countryEl = document.getElementById('profit-rule-country');
    var sortEl = document.getElementById('profit-rule-sort');
    var enabledEl = document.getElementById('profit-rule-enabled');
    var name = String(nameEl && nameEl.value || '').trim();
    if (!name) return { ok: false, error: 'Rule name is required.' };
    var type = String(typeEl && typeEl.value || '').trim();
    if (['percent_revenue', 'fixed_per_order', 'fixed_per_period'].indexOf(type) < 0) {
      return { ok: false, error: 'Rule type is invalid.' };
    }
    var value = Number(valueEl && valueEl.value);
    if (!Number.isFinite(value) || value < 0) return { ok: false, error: 'Value must be 0 or higher.' };
    var sort = Math.max(1, Math.trunc(Number(sortEl && sortEl.value) || 1));
    var countryRaw = String(countryEl && countryEl.value || '').trim();
    var appliesTo = { mode: 'all', countries: [] };
    if (countryRaw) {
      var countries = countryRaw.split(/[,\s]+/).map(normalizeCountryCode).filter(Boolean);
      if (!countries.length) return { ok: false, error: 'Use valid 2-letter ISO country codes.' };
      var unique = [];
      var seen = {};
      countries.forEach(function (cc) {
        if (!cc || seen[cc]) return;
        seen[cc] = true;
        unique.push(cc);
      });
      appliesTo = { mode: 'countries', countries: unique.slice(0, 64) };
    }
    return {
      ok: true,
      rule: {
        id: state.editingRuleId || createRuleId(),
        name: name.slice(0, 80),
        type: type,
        value: value,
        enabled: enabledEl ? !!enabledEl.checked : true,
        sort: sort,
        appliesTo: appliesTo,
      },
    };
  }

  function saveRuleDraft() {
    var parsed = readForm();
    if (!parsed.ok) {
      setMessage(parsed.error, false);
      return;
    }
    if (!state.rulesDraft || !Array.isArray(state.rulesDraft.rules)) {
      state.rulesDraft = normalizeRulesPayload(null);
    }
    var existing = getRuleById(parsed.rule.id);
    if (existing) {
      existing.name = parsed.rule.name;
      existing.type = parsed.rule.type;
      existing.value = parsed.rule.value;
      existing.enabled = parsed.rule.enabled;
      existing.sort = parsed.rule.sort;
      existing.appliesTo = parsed.rule.appliesTo;
    } else {
      state.rulesDraft.rules.push(parsed.rule);
    }
    reindexDraft();
    renderRulesList();
    hideForm();
    setMessage('Rule saved in draft.', true);
  }

  function setTab(tab) {
    var key = tab === 'integrations' ? 'integrations' : 'rules';
    document.querySelectorAll('[data-pr-tab]').forEach(function (btn) {
      if (!btn || !btn.classList) return;
      var v = String(btn.getAttribute('data-pr-tab') || '');
      btn.classList.toggle('active', v === key);
    });
    var rulesPane = document.getElementById('profit-rules-tab-rules');
    var integrationsPane = document.getElementById('profit-rules-tab-integrations');
    if (rulesPane) rulesPane.classList.toggle('is-hidden', key !== 'rules');
    if (integrationsPane) integrationsPane.classList.toggle('is-hidden', key !== 'integrations');
  }

  function applyDraftToUi() {
    var enabledToggle = document.getElementById('profit-rules-enabled');
    var adsToggle = document.getElementById('profit-rules-include-google-ads');
    var paymentFeesToggle = document.getElementById('profit-rules-include-payment-fees');
    var klarnaFeesToggle = document.getElementById('profit-rules-include-klarna-fees');
    var taxToggle = document.getElementById('profit-rules-include-tax');
    if (enabledToggle) enabledToggle.checked = !!(state.rulesDraft && state.rulesDraft.enabled);
    if (adsToggle) adsToggle.checked = !!(state.rulesDraft && state.rulesDraft.integrations && state.rulesDraft.integrations.includeGoogleAdsSpend);
    if (paymentFeesToggle) paymentFeesToggle.checked = !!(state.rulesDraft && state.rulesDraft.integrations && state.rulesDraft.integrations.includePaymentFees);
    if (klarnaFeesToggle) klarnaFeesToggle.checked = !!(state.rulesDraft && state.rulesDraft.integrations && state.rulesDraft.integrations.includeKlarnaFees);
    if (taxToggle) taxToggle.checked = !!(state.rulesDraft && state.rulesDraft.integrations && state.rulesDraft.integrations.includeShopifyTaxes);
  }

  function readTogglesIntoDraft() {
    if (!state.rulesDraft) state.rulesDraft = normalizeRulesPayload(null);
    var enabledToggle = document.getElementById('profit-rules-enabled');
    var adsToggle = document.getElementById('profit-rules-include-google-ads');
    var paymentFeesToggle = document.getElementById('profit-rules-include-payment-fees');
    var klarnaFeesToggle = document.getElementById('profit-rules-include-klarna-fees');
    var taxToggle = document.getElementById('profit-rules-include-tax');
    state.rulesDraft.enabled = enabledToggle ? !!enabledToggle.checked : !!state.rulesDraft.enabled;
    if (!state.rulesDraft.integrations || typeof state.rulesDraft.integrations !== 'object') {
      state.rulesDraft.integrations = { includeGoogleAdsSpend: false, includeShopifyAppBills: false, includePaymentFees: false, includeKlarnaFees: false, includeShopifyTaxes: false };
    }
    state.rulesDraft.integrations.includeGoogleAdsSpend = adsToggle ? !!adsToggle.checked : !!state.rulesDraft.integrations.includeGoogleAdsSpend;
    state.rulesDraft.integrations.includeShopifyAppBills = false;
    state.rulesDraft.integrations.includePaymentFees = paymentFeesToggle ? !!paymentFeesToggle.checked : !!state.rulesDraft.integrations.includePaymentFees;
    state.rulesDraft.integrations.includeKlarnaFees = klarnaFeesToggle ? !!klarnaFeesToggle.checked : !!state.rulesDraft.integrations.includeKlarnaFees;
    state.rulesDraft.integrations.includeShopifyTaxes = taxToggle ? !!taxToggle.checked : !!state.rulesDraft.integrations.includeShopifyTaxes;
  }

  function loadRules(force) {
    var url = (typeof API !== 'undefined' ? API : '') + '/api/settings/profit-rules';
    if (force) {
      url += (url.indexOf('?') >= 0 ? '&' : '?') + '_=' + Date.now();
    }
    return fetchJson(url).then(function (payload) {
      state.rulesDraft = normalizeRulesPayload(payload && payload.profitRules ? payload.profitRules : null);
      applyDraftToUi();
      renderRulesList();
      hideForm();
      return state.rulesDraft;
    });
  }

  function saveRules() {
    readTogglesIntoDraft();
    reindexDraft();
    setMessage('Saving...', true);
    var url = (typeof API !== 'undefined' ? API : '') + '/api/settings/profit-rules';
    return fetchJson(url, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ profitRules: state.rulesDraft }),
      credentials: 'same-origin',
    }).then(function (payload) {
      state.rulesDraft = normalizeRulesPayload(payload && payload.profitRules ? payload.profitRules : state.rulesDraft);
      applyDraftToUi();
      renderRulesList();
      hideForm();
      setMessage('Profit rules saved.', true);
      try { window.dispatchEvent(new CustomEvent('kexo:profitRulesUpdated')); } catch (_) {}
      return payload;
    }).catch(function () {
      setMessage('Failed to save profit rules.', false);
      return null;
    });
  }

  function bind() {
    var modal = document.getElementById('profit-rules-modal');
    if (!modal) return;

    var openBtn = document.getElementById('dash-cost-settings-btn');
    if (openBtn && openBtn.getAttribute('data-kexo-profit-bound') !== '1') {
      openBtn.setAttribute('data-kexo-profit-bound', '1');
      openBtn.addEventListener('click', function (e) {
        e.preventDefault();
        try {
          var url = '/settings?tab=cost-expenses&costExpensesTab=rules';
          if (typeof window !== 'undefined' && window.location && typeof window.location.assign === 'function') window.location.assign(url);
          else window.location.href = url;
        } catch (_) {}
      });
    }

    var chartBtn = document.querySelector('[data-kexo-chart-settings-key="dash-chart-overview-30d"]');
    if (chartBtn && chartBtn.getAttribute('data-kexo-chart-settings-bound') !== '1') {
      chartBtn.setAttribute('data-kexo-chart-settings-bound', '1');
      chartBtn.addEventListener('click', function (e) {
        e.preventDefault();
        e.stopPropagation();
        try {
          if (window.KexoLayoutShortcuts && typeof window.KexoLayoutShortcuts.openChartModal === 'function') {
            window.KexoLayoutShortcuts.openChartModal({ chartKey: 'dash-chart-overview-30d', cardTitle: 'Overview' });
          }
        } catch (_) {}
      });
    }

    var closeBtn = document.getElementById('profit-rules-close-btn');
    var dismissBtn = document.getElementById('profit-rules-dismiss-btn');
    var saveBtn = document.getElementById('profit-rules-save-btn');
    var addBtn = document.getElementById('profit-rules-add-btn');
    var formSaveBtn = document.getElementById('profit-rule-save-btn');
    var formCancelBtn = document.getElementById('profit-rule-cancel-btn');
    var tableBody = document.getElementById('profit-rules-table-body');

    if (closeBtn) closeBtn.addEventListener('click', closeModal);
    if (dismissBtn) dismissBtn.addEventListener('click', closeModal);
    if (saveBtn) saveBtn.addEventListener('click', saveRules);
    if (addBtn) addBtn.addEventListener('click', function () { showForm(null); });
    if (formSaveBtn) formSaveBtn.addEventListener('click', saveRuleDraft);
    if (formCancelBtn) formCancelBtn.addEventListener('click', hideForm);

    document.querySelectorAll('[data-pr-tab]').forEach(function (btn) {
      btn.addEventListener('click', function () {
        var tab = String(btn.getAttribute('data-pr-tab') || '');
        setTab(tab);
      });
    });

    if (tableBody) {
      tableBody.addEventListener('click', function (event) {
        var target = event && event.target ? event.target : null;
        if (!target || !target.getAttribute) return;
        var action = String(target.getAttribute('data-pr-action') || '');
        var ruleId = String(target.getAttribute('data-rule-id') || '');
        if (!action || !ruleId) return;
        if (!state.rulesDraft || !Array.isArray(state.rulesDraft.rules)) return;
        if (action === 'edit') {
          showForm(getRuleById(ruleId));
          return;
        }
        if (action === 'delete') {
          state.rulesDraft.rules = state.rulesDraft.rules.filter(function (rule) { return String(rule && rule.id || '') !== ruleId; });
          reindexDraft();
          renderRulesList();
          hideForm();
          return;
        }
        if (action === 'move-up' || action === 'move-down') {
          sortDraft();
          var idx = state.rulesDraft.rules.findIndex(function (rule) { return String(rule && rule.id || '') === ruleId; });
          if (idx < 0) return;
          var swapWith = action === 'move-up' ? idx - 1 : idx + 1;
          if (swapWith < 0 || swapWith >= state.rulesDraft.rules.length) return;
          var tmp = state.rulesDraft.rules[idx];
          state.rulesDraft.rules[idx] = state.rulesDraft.rules[swapWith];
          state.rulesDraft.rules[swapWith] = tmp;
          reindexDraft();
          renderRulesList();
        }
      });
      tableBody.addEventListener('change', function (event) {
        var target = event && event.target ? event.target : null;
        if (!target || !target.getAttribute) return;
        var action = String(target.getAttribute('data-pr-action') || '');
        if (action !== 'toggle-enabled') return;
        var ruleId = String(target.getAttribute('data-rule-id') || '');
        var rule = getRuleById(ruleId);
        if (!rule) return;
        rule.enabled = !!target.checked;
      });
    }

    document.addEventListener('keydown', function (event) {
      if (!state.open) return;
      var key = String(event && (event.key || event.code) || '');
      if (key === 'Escape') closeModal();
    });
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', bind);
  } else {
    bind();
  }
})();

/**
 * Unified chart settings modal — opened from chart cog. Persists via PUT /api/chart-settings/:chartKey.
 * Single-init: one document listener for cog clicks; no duplicate bindings.
 */
(function () {
  'use strict';

  var MODAL_ID = 'kexo-chart-settings-modal';
  var CHARTS_LS_KEY = 'kexo:charts-ui-config:v1';
  var API = (typeof window !== 'undefined' && window.API) ? String(window.API || '') : '';
  var lastOpen = { key: '', at: 0 };
  var inFlight = { controller: null, chartKey: '' };
  var fallbackBackdrop = null;

  function getChartMeta(key) {
    return (typeof window.kexoChartMeta === 'function' ? window.kexoChartMeta(key) : null) || { modes: ['line', 'area'], series: [], defaultMode: 'line', height: 200 };
  }

  function escapeHtml(str) {
    if (str == null) return '';
    try {
      var div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    } catch (_) {
      return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
    }
  }

  function ensureModal() {
    var existing = document.getElementById(MODAL_ID);
    if (existing) return existing;
    var wrap = document.createElement('div');
    wrap.innerHTML =
      '<div class="modal modal-blur" id="' + MODAL_ID + '" tabindex="-1" role="dialog" aria-labelledby="' + MODAL_ID + '-title" aria-hidden="true">' +
        '<div class="modal-dialog modal-dialog-centered modal-dialog-scrollable" role="document">' +
          '<div class="modal-content">' +
            '<div class="modal-header">' +
              '<h5 class="modal-title" id="' + MODAL_ID + '-title">Chart settings</h5>' +
              '<button type="button" class="btn-close" data-kexo-chart-settings-close aria-label="Close"></button>' +
            '</div>' +
            '<div class="modal-body" id="' + MODAL_ID + '-body"></div>' +
            '<div class="modal-footer">' +
              '<span id="' + MODAL_ID + '-msg" class="form-hint me-auto"></span>' +
              '<button type="button" class="btn btn-secondary" data-kexo-chart-settings-close>Cancel</button>' +
              '<button type="button" class="btn btn-primary" id="' + MODAL_ID + '-save">Save</button>' +
            '</div>' +
          '</div>' +
        '</div>' +
      '</div>';
    var el = wrap.firstChild;
    document.body.appendChild(el);
    el.querySelectorAll('[data-kexo-chart-settings-close]').forEach(function (btn) {
      btn.addEventListener('click', function () { closeModal(); });
    });
    // Ensure we always cleanup in-flight requests when the modal closes.
    try {
      if (el.getAttribute('data-kexo-chart-settings-lifecycle') !== '1') {
        el.setAttribute('data-kexo-chart-settings-lifecycle', '1');
        el.addEventListener('hidden.bs.modal', function () { abortInFlight(); });
      }
    } catch (_) {}
    return el;
  }

  function setMsg(text, ok) {
    var msg = document.getElementById(MODAL_ID + '-msg');
    if (msg) {
      msg.textContent = text || '';
      msg.className = 'form-hint me-auto ' + (ok === true ? 'text-success' : ok === false ? 'text-danger' : '');
    }
  }

  function closeModal() {
    var modal = document.getElementById(MODAL_ID);
    if (!modal) return;
    abortInFlight();
    var usedBootstrap = false;
    try {
      if (window.bootstrap && window.bootstrap.Modal) {
        var inst = window.bootstrap.Modal.getInstance(modal);
        if (inst) { inst.hide(); usedBootstrap = true; }
      }
    } catch (_) {}
    if (usedBootstrap) return;
    try { modal.style.display = 'none'; } catch (_) {}
    try { modal.classList.remove('show'); } catch (_) {}
    try { modal.setAttribute('aria-hidden', 'true'); } catch (_) {}
    try { if (document && document.body) document.body.classList.remove('modal-open'); } catch (_) {}
    try {
      if (fallbackBackdrop && fallbackBackdrop.parentNode) fallbackBackdrop.parentNode.removeChild(fallbackBackdrop);
    } catch (_) {}
    fallbackBackdrop = null;
  }

  function abortInFlight() {
    try {
      if (inFlight && inFlight.controller && typeof inFlight.controller.abort === 'function') {
        inFlight.controller.abort();
      }
    } catch (_) {}
    try { inFlight.controller = null; } catch (_) {}
    try { inFlight.chartKey = ''; } catch (_) {}
  }

  function showModal() {
    var modal = ensureModal();
    modal.classList.add('show');
    modal.setAttribute('aria-hidden', 'false');
    try {
      if (window.bootstrap && window.bootstrap.Modal) {
        window.bootstrap.Modal.getOrCreateInstance(modal, { backdrop: true, keyboard: true }).show();
        return;
      }
    } catch (_) {}
    // Fallback: display the modal without Bootstrap JS.
    try { modal.style.display = 'block'; } catch (_) {}
    try { if (document && document.body) document.body.classList.add('modal-open'); } catch (_) {}
    try {
      if (!fallbackBackdrop) {
        fallbackBackdrop = document.createElement('div');
        fallbackBackdrop.className = 'modal-backdrop fade show';
        fallbackBackdrop.addEventListener('click', function () { closeModal(); });
        document.body.appendChild(fallbackBackdrop);
      }
    } catch (_) {}
  }

  function modeOptionsHtml(modes, selected) {
    var labels = (window.KEXO_CHART_MODE_LABEL && typeof window.KEXO_CHART_MODE_LABEL === 'object') ? window.KEXO_CHART_MODE_LABEL : {};
    var sel = String(selected || '').trim().toLowerCase();
    return (modes || []).map(function (m) {
      var v = String(m || '').trim().toLowerCase();
      if (!v) return '';
      var label = labels[v] || v;
      return '<option value="' + escapeHtml(v) + '"' + (v === sel ? ' selected' : '') + '>' + escapeHtml(label) + '</option>';
    }).join('');
  }

  function writeChartsUiConfigCacheFromServer(cfg) {
    if (!cfg || cfg.v !== 1) return;
    var toStore;
    try {
      toStore = Object.assign({}, cfg, { schemaVersion: 1, updatedAt: Date.now() });
    } catch (_) {
      toStore = cfg;
    }
    try {
      (typeof safeWriteLocalStorageJson === 'function'
        ? safeWriteLocalStorageJson
        : function (k, v) { try { localStorage.setItem(k, typeof v === 'string' ? v : JSON.stringify(v)); } catch (_) {} }
      )(CHARTS_LS_KEY, toStore);
    } catch (_) {}
  }

  function openModal(opts) {
    var chartKey = (opts && opts.chartKey != null) ? String(opts.chartKey).trim().toLowerCase() : '';
    var cardTitle = (opts && opts.cardTitle != null) ? String(opts.cardTitle).trim() : chartKey;
    if (!chartKey) return;
    var now = Date.now();
    if (lastOpen.key === chartKey && (now - lastOpen.at) < 250) return;
    lastOpen.key = chartKey;
    lastOpen.at = now;

    var modal = ensureModal();
    var titleEl = document.getElementById(MODAL_ID + '-title');
    var bodyEl = document.getElementById(MODAL_ID + '-body');
    var saveBtn = document.getElementById(MODAL_ID + '-save');
    if (titleEl) titleEl.textContent = 'Chart: ' + cardTitle;
    if (!bodyEl) return;

    setMsg('Loading…', null);
    bodyEl.innerHTML = '<div class="text-muted">Loading…</div>';
    showModal();
    abortInFlight();
    try {
      inFlight.chartKey = chartKey;
      inFlight.controller = (typeof AbortController !== 'undefined') ? new AbortController() : null;
    } catch (_) {
      inFlight.controller = null;
    }
    fetch(API + '/api/chart-settings/' + encodeURIComponent(chartKey), {
      credentials: 'same-origin',
      cache: 'no-store',
      signal: inFlight.controller ? inFlight.controller.signal : undefined,
    })
      .then(function (r) {
        if (!r) return null;
        // Always try to surface a useful error in the modal instead of failing silently.
        return r.json().catch(function () {
          return { ok: false, error: 'Request failed (' + String(r.status || '') + ')' };
        });
      })
      .then(function (data) {
        if (!data || !data.ok) {
          setMsg('Failed to load settings', false);
          bodyEl.innerHTML = '<div class="text-muted">Could not load settings.</div>';
          return;
        }
        var s = data.settings || {};
        var meta = getChartMeta(chartKey);
        var modes = meta.modes || ['line', 'area'];
        var mode = String((s.mode || meta.defaultMode || 'line')).trim().toLowerCase();
        if (modes.indexOf(mode) < 0) mode = modes[0] || 'line';
        var size = Number(s.sizePercent);
        if (!Number.isFinite(size) || size < 25 || size > 100) size = 100;
        size = Math.round(size / 5) * 5;
        var animations = !(s.style && s.style.animations === false);
        var supportsIcons = !!(meta && meta.capabilities && meta.capabilities.icons === true);
        var iconsEnabled = supportsIcons ? !!(s.style && s.style.icons === true) : false;
        var supportsPieLabels = !!(modes && (modes.indexOf('pie') >= 0 || modes.indexOf('donut') >= 0));
        var pieLabelPosition = (s && s.style && s.style.pieLabelPosition != null) ? String(s.style.pieLabelPosition).trim().toLowerCase() : 'auto';
        if (pieLabelPosition !== 'auto' && pieLabelPosition !== 'inside' && pieLabelPosition !== 'outside') pieLabelPosition = 'auto';
        var pieLabelOffset = (s && s.style && Number.isFinite(Number(s.style.pieLabelOffset))) ? Math.round(Number(s.style.pieLabelOffset)) : 16;
        if (!Number.isFinite(pieLabelOffset)) pieLabelOffset = 16;
        pieLabelOffset = Math.round(Math.max(-40, Math.min(40, pieLabelOffset)));
        if (pieLabelPosition === 'outside') pieLabelOffset = Math.max(6, pieLabelOffset);
        if (pieLabelPosition === 'inside') pieLabelOffset = Math.min(0, pieLabelOffset);
        var finishesCenterLabel = !(s.style && s.style.radialCenterLabel === false);
        var isOverview = chartKey === 'dash-chart-overview-30d';
        var isFinishes = chartKey === 'dash-chart-finishes-30d';
        var colors = (s.colors && Array.isArray(s.colors)) ? s.colors : (meta.series && meta.series.length ? ['#3eb3ab', '#ef4444', '#2fb344', '#d63939'].slice(0, meta.series.length) : ['#3eb3ab']);
        var rev = (isOverview && colors[0]) ? colors[0] : '#3eb3ab';
        var cost = (isOverview && colors[1]) ? colors[1] : '#ef4444';
        var profitPos = (isOverview && colors[2]) ? colors[2] : '#2fb344';
        var profitNeg = (isOverview && colors[3]) ? colors[3] : '#d63939';
        var fillOpacityRaw = (s && s.style && Number.isFinite(Number(s.style.fillOpacity)))
          ? Math.max(0, Math.min(1, Number(s.style.fillOpacity)))
          : 0.18;
        var fillOpacityPct = Math.round(fillOpacityRaw * 100);
        var fillOpacityVisible = (String(mode || '').trim().toLowerCase() !== 'map');

        var body = '';
        body += '<div class="row g-3">';
        body += '<div class="col-12 col-md-6"><label class="form-label">Chart type</label><select class="form-select form-select-sm" data-cs-field="mode">' + modeOptionsHtml(modes, mode) + '</select></div>';
        body += '<div class="col-12 col-md-6"><label class="form-label">Size (% of container)</label><select class="form-select form-select-sm" data-cs-field="sizePercent">';
        for (var p = 25; p <= 100; p += 5) {
          body += '<option value="' + p + '"' + (p === size ? ' selected' : '') + '>' + p + '%</option>';
        }
        body += '</select></div>';
        body += '<div class="col-12"><label class="form-check form-switch m-0"><input class="form-check-input" type="checkbox" data-cs-field="animations"' + (animations ? ' checked' : '') + '><span class="form-check-label ms-2">Animations</span></label></div>';
        if (supportsIcons) {
          body += '<div class="col-12"><label class="form-check form-switch m-0"><input class="form-check-input" type="checkbox" data-cs-field="icons"' + (iconsEnabled ? ' checked' : '') + '><span class="form-check-label ms-2">Icons</span></label><div class="form-hint">Show source icons in the chart legend.</div></div>';
        }
        if (isFinishes) {
          body += '<div class="col-12' + (String(mode || '').toLowerCase() === 'radialbar' ? '' : ' d-none') + '" data-cs-mode-group="finishes-center-label">';
          body += '<label class="form-check form-switch m-0"><input class="form-check-input" type="checkbox" data-cs-field="radialCenterLabel"' + (finishesCenterLabel ? ' checked' : '') + '><span class="form-check-label ms-2">Place the highest revenue variant in the center?</span></label>';
          body += '<div class="form-hint">Only applies to the Radial Bar chart type.</div>';
          body += '</div>';
        }
        var capControls = (meta && meta.capabilities && Array.isArray(meta.capabilities.controls)) ? meta.capabilities.controls : [];
        if (capControls && capControls.length) {
          var styleObj = (s && s.style && typeof s.style === 'object') ? s.style : {};
          body += '<div class="col-12"><div class="hr-text">Chart options</div></div>';
          function hintIconHtml(txt) {
            var t = txt != null ? String(txt).trim() : '';
            if (!t) return '';
            return '<span class="text-muted small ms-1 d-inline-flex align-items-center" role="img" aria-label="' + escapeHtml(t) + '" title="' + escapeHtml(t) + '"><i class="fa-light fa-circle-info" aria-hidden="true"></i></span>';
          }
          capControls.forEach(function (c) {
            if (!c || typeof c !== 'object') return;
            var type = c.type != null ? String(c.type).trim().toLowerCase() : '';
            var field = c.field != null ? String(c.field).trim() : '';
            if (!type || !field) return;
            var label = c.label != null ? String(c.label) : field;
            var hint = c.hint != null ? String(c.hint) : '';
            var modesOnly = Array.isArray(c.modes) ? c.modes.map(function (m) { return String(m || '').trim().toLowerCase(); }).filter(Boolean) : null;
            var modeAttr = (modesOnly && modesOnly.length) ? (' data-cs-modes="' + escapeHtml(modesOnly.join(',')) + '"') : '';
            if (type === 'select') {
              var options = Array.isArray(c.options) ? c.options : [];
              var v = (styleObj && styleObj[field] != null) ? String(styleObj[field]).trim().toLowerCase() : (c.default != null ? String(c.default).trim().toLowerCase() : '');
              if (options.length && !options.some(function (o) { return o && String(o.value).trim().toLowerCase() === v; })) {
                v = String(options[0].value).trim().toLowerCase();
              }
              body += '<div class="col-12 col-md-6"' + modeAttr + '>';
              body += '<label class="form-label d-flex align-items-center gap-1">' + escapeHtml(label) + hintIconHtml(hint) + '</label>';
              body += '<select class="form-select form-select-sm" data-cs-field="' + escapeHtml(field) + '">';
              options.forEach(function (o) {
                if (!o) return;
                var ov = o.value != null ? String(o.value).trim().toLowerCase() : '';
                var ol = o.label != null ? String(o.label) : ov;
                if (!ov) return;
                body += '<option value="' + escapeHtml(ov) + '"' + (ov === v ? ' selected' : '') + '>' + escapeHtml(ol) + '</option>';
              });
              body += '</select>';
              body += '</div>';
            } else if (type === 'range') {
              var min = Number(c.min);
              var max = Number(c.max);
              var step = Number(c.step);
              var unit = c.unit != null ? String(c.unit) : '';
              if (!Number.isFinite(min)) min = 0;
              if (!Number.isFinite(max)) max = 100;
              if (!Number.isFinite(step) || step <= 0) step = 1;
              var raw = (styleObj && styleObj[field] != null) ? Number(styleObj[field]) : Number(c.default);
              if (!Number.isFinite(raw)) raw = min;
              if (raw < min) raw = min;
              if (raw > max) raw = max;
              body += '<div class="col-12 col-md-6"' + modeAttr + '>';
              body += '<label class="form-label d-flex align-items-center justify-content-between">';
              body += '<span class="d-inline-flex align-items-center gap-1">' + escapeHtml(label) + hintIconHtml(hint) + '</span>';
              body += '<span class="text-muted small" data-cs-range-value="' + escapeHtml(field) + '">' + escapeHtml(String(raw)) + (unit ? escapeHtml(unit) : '') + '</span>';
              body += '</label>';
              body += '<input type="range" class="form-range" min="' + escapeHtml(String(min)) + '" max="' + escapeHtml(String(max)) + '" step="' + escapeHtml(String(step)) + '" value="' + escapeHtml(String(raw)) + '" data-cs-field="' + escapeHtml(field) + '" data-cs-range-unit="' + escapeHtml(unit) + '">';
              body += '</div>';
            } else if (type === 'toggle') {
              var def = (typeof c.default === 'boolean') ? c.default : false;
              var stored = (styleObj && typeof styleObj[field] === 'boolean') ? styleObj[field] : def;
              var invert = !!c.invert;
              var checked = invert ? !stored : !!stored;
              body += '<div class="col-12"' + modeAttr + '>';
              body += '<label class="form-check form-switch m-0">';
              body += '<input class="form-check-input" type="checkbox" data-cs-field="' + escapeHtml(field) + '"' + (checked ? ' checked' : '') + (invert ? ' data-cs-invert="1"' : '') + '>';
              body += '<span class="form-check-label ms-2 d-inline-flex align-items-center gap-1">' + escapeHtml(label) + hintIconHtml(hint) + '</span>';
              body += '</label>';
              body += '</div>';
            }
          });
        }
        body += '<div class="col-12' + (fillOpacityVisible ? '' : ' d-none') + '" data-cs-mode-group="fill-opacity">';
        body += '<label class="form-label d-flex align-items-center justify-content-between">';
        body += '<span data-cs-fill-opacity-label>Area fill opacity</span>';
        body += '<span class="text-muted small" data-cs-fill-opacity-value>' + fillOpacityPct + '%</span>';
        body += '</label>';
        body += '<input type="range" class="form-range" min="0" max="100" step="1" value="' + fillOpacityPct + '" data-cs-field="fillOpacity">';
        body += '<div class="form-hint">Lower values make chart fills more transparent.</div>';
        body += '</div>';
        body += '<div class="col-12' + (supportsPieLabels && (mode === 'pie' || mode === 'donut') ? '' : ' d-none') + '" data-cs-mode-group="pie-labels">';
        body += '<div class="row g-2">';
        body += '<div class="col-12 col-md-6">';
        body += '<label class="form-label">Label position</label>';
        body += '<select class="form-select form-select-sm" data-cs-field="pieLabelPosition">';
        body += '<option value="auto"' + (pieLabelPosition === 'auto' ? ' selected' : '') + '>Auto</option>';
        body += '<option value="inside"' + (pieLabelPosition === 'inside' ? ' selected' : '') + '>Inside</option>';
        body += '<option value="outside"' + (pieLabelPosition === 'outside' ? ' selected' : '') + '>Outside</option>';
        body += '</select>';
        body += '<div class="form-hint">Applies to Pie / Donut chart types.</div>';
        body += '</div>';
        body += '<div class="col-12 col-md-6">';
        body += '<label class="form-label d-flex align-items-center justify-content-between">';
        body += '<span>Label offset</span>';
        body += '<span class="text-muted small" data-cs-pie-label-offset-value>' + String(pieLabelOffset) + 'px</span>';
        body += '</label>';
        body += '<input type="range" class="form-range" min="-40" max="40" step="1" value="' + String(pieLabelOffset) + '" data-cs-field="pieLabelOffset">';
        body += '<div class="form-hint">Move labels inward (negative) or outward (positive).</div>';
        body += '</div>';
        body += '</div>';
        body += '</div>';
        if (isOverview) {
          body += '<div class="col-12"><label class="form-label">Colours</label><div class="row g-2">';
          body += '<div class="col-6 col-md-3"><label class="form-label small">Revenue</label><div class="kexo-color-input"><input type="text" class="form-control form-control-sm" data-kexo-color-input data-cs-field="color-revenue" value="' + escapeHtml(rev) + '" placeholder="#3eb3ab"><span class="kexo-color-swatch" data-kexo-color-swatch aria-hidden="true"></span></div></div>';
          body += '<div class="col-6 col-md-3"><label class="form-label small">Cost</label><div class="kexo-color-input"><input type="text" class="form-control form-control-sm" data-kexo-color-input data-cs-field="color-cost" value="' + escapeHtml(cost) + '" placeholder="#ef4444"><span class="kexo-color-swatch" data-kexo-color-swatch aria-hidden="true"></span></div></div>';
          body += '<div class="col-6 col-md-3"><label class="form-label small">Profit (positive)</label><div class="kexo-color-input"><input type="text" class="form-control form-control-sm" data-kexo-color-input data-cs-field="color-profitPos" value="' + escapeHtml(profitPos) + '" placeholder="#2fb344"><span class="kexo-color-swatch" data-kexo-color-swatch aria-hidden="true"></span></div></div>';
          body += '<div class="col-6 col-md-3"><label class="form-label small">Profit (negative)</label><div class="kexo-color-input"><input type="text" class="form-control form-control-sm" data-kexo-color-input data-cs-field="color-profitNeg" value="' + escapeHtml(profitNeg) + '" placeholder="#d63939"><span class="kexo-color-swatch" data-kexo-color-swatch aria-hidden="true"></span></div></div>';
          body += '</div></div>';
        }
        body += '</div>';

        bodyEl.innerHTML = body;
        bodyEl.setAttribute('data-cs-chart-key', chartKey);
        setMsg('', null);

        function normalizeHex6(v) {
          var r = (v == null ? '' : String(v)).trim().toLowerCase();
          if (/^#[0-9a-f]{6}$/.test(r)) return r;
          if (/^[0-9a-f]{6}$/.test(r)) return '#' + r;
          return null;
        }

        function syncColorPreview(inputEl) {
          if (!inputEl) return;
          var sw = null;
          try { sw = inputEl.parentNode ? inputEl.parentNode.querySelector('[data-kexo-color-swatch]') : null; } catch (_) { sw = null; }
          if (!sw) return;
          var hexVal = normalizeHex6(inputEl.value);
          try {
            if (hexVal) {
              sw.classList.remove('is-empty');
              sw.style.setProperty('--kexo-swatch-color', hexVal);
            } else {
              sw.classList.add('is-empty');
              sw.style.removeProperty('--kexo-swatch-color');
            }
          } catch (_) {}
        }

        function bindColorPreviews() {
          try {
            var inputs = bodyEl.querySelectorAll('[data-kexo-color-input]');
            for (var i = 0; i < inputs.length; i++) {
              var el = inputs[i];
              if (!el || el.__kexoColorPreviewBound) continue;
              el.__kexoColorPreviewBound = 1;
              (function (inputEl) {
                var sync = function () { syncColorPreview(inputEl); };
                try { inputEl.addEventListener('input', sync); } catch (_) {}
                try { inputEl.addEventListener('change', sync); } catch (_) {}
                sync();
              })(el);
            }
          } catch (_) {}
        }
        bindColorPreviews();

        function modeSupportsFillOpacity(modeVal) {
          var m = String(modeVal || '').trim().toLowerCase();
          return (m !== 'map');
        }

        function fillOpacityLabelForMode(modeVal) {
          var m = String(modeVal || '').trim().toLowerCase();
          if (m === 'stacked-area') return 'Stacked area opacity';
          if (m === 'area') return 'Area fill opacity';
          if (m === 'stacked-bar') return 'Stacked bar opacity';
          if (m === 'bar') return 'Bar opacity';
          if (m === 'line' || m === 'multi-line-labels') return 'Line opacity';
          if (m === 'pie' || m === 'donut') return 'Slice opacity';
          if (m === 'radialbar') return 'Ring opacity';
          return 'Series opacity';
        }

        function bindFillOpacityControls() {
          var input = bodyEl.querySelector('[data-cs-field="fillOpacity"]');
          var valueEl = bodyEl.querySelector('[data-cs-fill-opacity-value]');
          if (!input) return;
          function sync() {
            var raw = parseInt(String(input.value || ''), 10);
            if (!Number.isFinite(raw)) raw = fillOpacityPct;
            raw = Math.max(0, Math.min(100, raw));
            try { input.value = String(raw); } catch (_) {}
            if (valueEl) valueEl.textContent = raw + '%';
          }
          try { input.addEventListener('input', sync); } catch (_) {}
          try { input.addEventListener('change', sync); } catch (_) {}
          sync();
        }

        function bindPieLabelControls() {
          var posEl = bodyEl.querySelector('[data-cs-field="pieLabelPosition"]');
          var offEl = bodyEl.querySelector('[data-cs-field="pieLabelOffset"]');
          var valueEl = bodyEl.querySelector('[data-cs-pie-label-offset-value]');
          if (!posEl || !offEl) return;
          function clampOffsetForPosition(raw, pos) {
            var n = parseInt(String(raw == null ? '' : raw), 10);
            if (!Number.isFinite(n)) n = pieLabelOffset;
            n = Math.round(Math.max(-40, Math.min(40, n)));
            var p = String(pos || '').trim().toLowerCase();
            if (p === 'outside') n = Math.max(6, n);
            if (p === 'inside') n = Math.min(0, n);
            return n;
          }
          function sync() {
            var pos = String(posEl.value || '').trim().toLowerCase();
            if (pos !== 'auto' && pos !== 'inside' && pos !== 'outside') pos = 'auto';
            try { posEl.value = pos; } catch (_) {}
            var next = clampOffsetForPosition(offEl.value, pos);
            try { offEl.value = String(next); } catch (_) {}
            if (valueEl) valueEl.textContent = String(next) + 'px';
          }
          try { posEl.addEventListener('change', sync); } catch (_) {}
          try { offEl.addEventListener('input', sync); } catch (_) {}
          try { offEl.addEventListener('change', sync); } catch (_) {}
          sync();
        }

        function bindCapabilityRangeControls() {
          try {
            var inputs = bodyEl.querySelectorAll('input[type="range"][data-cs-range-unit]');
            for (var i = 0; i < inputs.length; i++) {
              var inp = inputs[i];
              if (!inp || inp.__kexoRangeBound) continue;
              inp.__kexoRangeBound = 1;
              (function (el) {
                var field = el.getAttribute('data-cs-field') || '';
                var unit = el.getAttribute('data-cs-range-unit') || '';
                function sync() {
                  var span = bodyEl.querySelector('[data-cs-range-value="' + field + '"]');
                  if (!span) return;
                  span.textContent = String(el.value || '') + (unit ? String(unit) : '');
                }
                try { el.addEventListener('input', sync); } catch (_) {}
                try { el.addEventListener('change', sync); } catch (_) {}
                sync();
              })(inp);
            }
          } catch (_) {}
        }

        function syncModeControls(modeVal) {
          var m = String(modeVal || '').trim().toLowerCase();
          var fillWrap = bodyEl.querySelector('[data-cs-mode-group="fill-opacity"]');
          if (fillWrap) {
            if (modeSupportsFillOpacity(m)) fillWrap.classList.remove('d-none');
            else fillWrap.classList.add('d-none');
            var labelEl = fillWrap.querySelector('[data-cs-fill-opacity-label]');
            if (labelEl) labelEl.textContent = fillOpacityLabelForMode(m);
          }
          var pieWrap = bodyEl.querySelector('[data-cs-mode-group="pie-labels"]');
          if (pieWrap) {
            if (supportsPieLabels && (m === 'pie' || m === 'donut')) pieWrap.classList.remove('d-none');
            else pieWrap.classList.add('d-none');
          }
          var finishesWrap = bodyEl.querySelector('[data-cs-mode-group="finishes-center-label"]');
          if (finishesWrap) {
            if (m === 'radialbar') finishesWrap.classList.remove('d-none');
            else finishesWrap.classList.add('d-none');
          }
          try {
            var modeWraps = bodyEl.querySelectorAll('[data-cs-modes]');
            for (var i = 0; i < modeWraps.length; i++) {
              var w = modeWraps[i];
              if (!w || !w.getAttribute) continue;
              var raw = String(w.getAttribute('data-cs-modes') || '');
              var allowed = raw.split(',').map(function (x) { return String(x || '').trim().toLowerCase(); }).filter(Boolean);
              if (!allowed.length) continue;
              if (allowed.indexOf(m) >= 0) w.classList.remove('d-none');
              else w.classList.add('d-none');
            }
          } catch (_) {}
        }

        bindFillOpacityControls();
        bindPieLabelControls();
        bindCapabilityRangeControls();
        syncModeControls(mode);
        try {
          var modeSelect = bodyEl.querySelector('[data-cs-field="mode"]');
          if (modeSelect) modeSelect.addEventListener('change', function () { syncModeControls(modeSelect.value); });
        } catch (_) {}

        function readForm() {
          var modeEl = bodyEl.querySelector('[data-cs-field="mode"]');
          var sizeEl = bodyEl.querySelector('[data-cs-field="sizePercent"]');
          var animEl = bodyEl.querySelector('[data-cs-field="animations"]');
          var iconsEl = supportsIcons ? bodyEl.querySelector('[data-cs-field="icons"]') : null;
          var centerEl = isFinishes ? bodyEl.querySelector('[data-cs-field="radialCenterLabel"]') : null;
          var piePosEl = supportsPieLabels ? bodyEl.querySelector('[data-cs-field="pieLabelPosition"]') : null;
          var pieOffEl = supportsPieLabels ? bodyEl.querySelector('[data-cs-field="pieLabelOffset"]') : null;
          var styleBase = {};
          try {
            if (s && s.style && typeof s.style === 'object') styleBase = Object.assign({}, s.style);
          } catch (_) { styleBase = {}; }
          styleBase.animations = !!(animEl && animEl.checked);
          if (supportsIcons) styleBase.icons = !!(iconsEl && iconsEl.checked);
          if (isFinishes) styleBase.radialCenterLabel = !!(centerEl && centerEl.checked);
          if (piePosEl) {
            var pp = String(piePosEl.value || '').trim().toLowerCase();
            if (pp !== 'auto' && pp !== 'inside' && pp !== 'outside') pp = 'auto';
            styleBase.pieLabelPosition = pp;
          }
          if (pieOffEl) {
            var po = parseInt(String(pieOffEl.value || ''), 10);
            if (Number.isFinite(po)) {
              po = Math.round(Math.max(-40, Math.min(40, po)));
              var refPos = (styleBase && styleBase.pieLabelPosition) ? String(styleBase.pieLabelPosition).trim().toLowerCase() : 'auto';
              if (refPos === 'outside') po = Math.max(6, po);
              if (refPos === 'inside') po = Math.min(0, po);
              styleBase.pieLabelOffset = po;
            }
          }
          var fillEl = bodyEl.querySelector('[data-cs-field="fillOpacity"]');
          if (fillEl) {
            var raw = parseInt(String(fillEl.value || ''), 10);
            if (Number.isFinite(raw)) styleBase.fillOpacity = Math.max(0, Math.min(1, raw / 100));
          }
          try {
            (capControls || []).forEach(function (c) {
              if (!c || typeof c !== 'object') return;
              var type = c.type != null ? String(c.type).trim().toLowerCase() : '';
              var field = c.field != null ? String(c.field).trim() : '';
              if (!type || !field) return;
              var el = bodyEl.querySelector('[data-cs-field="' + field + '"]');
              if (!el) return;
              if (type === 'select') {
                var sv = el.value != null ? String(el.value).trim().toLowerCase() : '';
                if (sv) styleBase[field] = sv;
              } else if (type === 'range') {
                var min = Number(c.min);
                var max = Number(c.max);
                var step = Number(c.step);
                if (!Number.isFinite(min)) min = 0;
                if (!Number.isFinite(max)) max = 100;
                if (!Number.isFinite(step) || step <= 0) step = 1;
                var n = Number(el.value);
                if (!Number.isFinite(n)) n = Number(c.default);
                if (!Number.isFinite(n)) n = min;
                if (n < min) n = min;
                if (n > max) n = max;
                // Keep a stable precision for decimals (e.g. strokeWidth step=0.1).
                var decimals = (String(step).indexOf('.') >= 0) ? String(step).split('.')[1].length : 0;
                if (decimals > 0) n = Number(n.toFixed(Math.min(4, decimals)));
                else n = Math.round(n);
                styleBase[field] = n;
              } else if (type === 'toggle') {
                var checked = !!(el && el.checked);
                var invert = !!(c.invert === true) || (el.getAttribute && el.getAttribute('data-cs-invert') === '1');
                styleBase[field] = invert ? !checked : checked;
              }
            });
          } catch (_) {}
          var out = {
            key: chartKey,
            mode: (modeEl && modeEl.value) ? String(modeEl.value).trim().toLowerCase() : mode,
            sizePercent: sizeEl ? parseInt(sizeEl.value, 10) : 100,
            style: styleBase,
            colors: (s.colors && Array.isArray(s.colors)) ? s.colors.slice() : (meta.series && meta.series.length ? ['#3eb3ab', '#ef4444', '#2fb344', '#d63939'].slice(0, meta.series.length) : ['#3eb3ab']),
          };
          if (isOverview) {
            var revEl = bodyEl.querySelector('[data-cs-field="color-revenue"]');
            var costEl = bodyEl.querySelector('[data-cs-field="color-cost"]');
            var posEl = bodyEl.querySelector('[data-cs-field="color-profitPos"]');
            var negEl = bodyEl.querySelector('[data-cs-field="color-profitNeg"]');
            var hex = function (v) { var r = (v == null ? '' : String(v)).trim().toLowerCase(); return /^#[0-9a-f]{6}$/.test(r) ? r : (r.length === 6 && /^[0-9a-f]{6}$/i.test(r) ? '#' + r : null); };
            if (revEl && hex(revEl.value)) out.colors[0] = hex(revEl.value) || out.colors[0];
            if (costEl && hex(costEl.value)) out.colors[1] = hex(costEl.value) || out.colors[1];
            if (posEl && hex(posEl.value)) out.colors[2] = hex(posEl.value) || out.colors[2];
            if (negEl && hex(negEl.value)) out.colors[3] = hex(negEl.value) || out.colors[3];
          }
          return out;
        }

        if (!saveBtn) return;
        saveBtn.replaceWith(saveBtn.cloneNode(true));
        document.getElementById(MODAL_ID + '-save').addEventListener('click', function () {
          var payload = readForm();
          setMsg('Saving…', null);
          fetch(API + '/api/chart-settings/' + encodeURIComponent(chartKey), {
            method: 'PUT',
            credentials: 'same-origin',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ settings: payload }),
          })
            .then(function (r) { return r.json(); })
            .then(function (data) {
              if (data && data.ok && data.chartsUiConfig) {
                // Server response is the only source of truth post-save.
                writeChartsUiConfigCacheFromServer(data.chartsUiConfig);
                try { window.dispatchEvent(new CustomEvent('kexo:chartsUiConfigUpdated', { detail: data.chartsUiConfig })); } catch (_) {}
                setMsg('Saved.', true);
                closeModal();
              } else {
                setMsg((data && data.error) ? String(data.error) : 'Save failed', false);
              }
            })
            .catch(function () { setMsg('Save failed', false); });
        });
      })
      .catch(function () {
        // Ignore aborts (close/back) to avoid showing a spurious error.
        try {
          if (inFlight && inFlight.controller && inFlight.controller.signal && inFlight.controller.signal.aborted) return;
        } catch (_) {}
        setMsg('Could not load settings.', false);
        if (bodyEl) bodyEl.innerHTML = '<div class="text-muted">Could not load settings.</div>';
      });
  }

  if (typeof window !== 'undefined') {
    window.KexoChartSettingsBuilder = { openModal: openModal };
  }

  var bound = false;
  function initDelegation() {
    try {
      if (document && document.documentElement && document.documentElement.getAttribute('data-kexo-chart-settings-delegation') === '1') {
        bound = true;
        return;
      }
    } catch (_) {}
    if (bound) return;
    bound = true;
    try {
      if (document && document.documentElement) document.documentElement.setAttribute('data-kexo-chart-settings-delegation', '1');
    } catch (_) {}
    function safeClosest(node, selector) {
      try {
        var el = node && node.nodeType === 1 ? node : (node && node.parentElement ? node.parentElement : null);
        while (el && el !== document && el.nodeType === 1) {
          if (el.matches && el.matches(selector)) return el;
          el = el.parentElement;
        }
      } catch (_) {}
      return null;
    }
    function handleSettingsTrigger(e) {
      if (!e || !e.target) return;
      if (e.__kexoChartSettingsHandled) return;
      // Some embed contexts can interfere with "click". Pointer events are more reliable.
      try {
        if (e.type === 'pointerup') {
          var pt = String(e.pointerType || '').toLowerCase();
          if (pt === 'mouse' && e.button !== 0) return;
        }
      } catch (_) {}
      // Only trigger when clicking an actual settings control (not anywhere inside a chart card).
      var hit = safeClosest(e.target,
        '[data-kexo-chart-settings-key],' +
        '.kexo-overview-chart-settings-btn,' +
        '.kexo-builder-icon-link[data-kexo-chart-settings-key],' +
        '.kexo-builder-icon-link[aria-label="Chart settings"],' +
        '.kexo-builder-icon-link[title="Chart settings"]'
      );
      if (!hit) return;

      var chartKey = '';
      try {
        chartKey = String(hit.getAttribute('data-kexo-chart-settings-key') || '').trim();
      } catch (_) { chartKey = ''; }
      if (!chartKey) {
        try { chartKey = String(hit.getAttribute('data-kexo-chart-key') || hit.getAttribute('data-chart-key') || '').trim(); } catch (_) { chartKey = ''; }
      }
      if (!chartKey) {
        try {
          var wrap = hit.closest ? hit.closest('[data-kexo-chart-key],[data-chart-key]') : null;
          chartKey = wrap ? String(wrap.getAttribute('data-kexo-chart-key') || wrap.getAttribute('data-chart-key') || '').trim() : '';
        } catch (_) { chartKey = ''; }
      }
      if (!chartKey) return;
      e.preventDefault();
      try { e.__kexoChartSettingsHandled = true; } catch (_) {}
      try { if (typeof e.stopPropagation === 'function') e.stopPropagation(); } catch (_) {}
      var title = '';
      try {
        var card = hit.closest ? hit.closest('.card') : null;
        var titleEl = card ? card.querySelector('.card-title,.subheader') : null;
        title = titleEl && titleEl.textContent ? String(titleEl.textContent).trim() : '';
      } catch (_) { title = ''; }
      openModal({ chartKey: chartKey, cardTitle: title || chartKey });
    }
    // Capture phase so we still handle clicks even if other handlers stop propagation.
    document.addEventListener('click', handleSettingsTrigger, true);
    try { document.addEventListener('pointerup', handleSettingsTrigger, true); } catch (_) {}
  }

  // Bind immediately (safe even while DOM is still loading).
  initDelegation();
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initDelegation);
  }
})();
/**
 * Logo rotator: header/footer.
 * - Random per page load (server picks an existing variant).
 * - Single-init, no listeners beyond DOMContentLoaded.
 */
(function () {
  'use strict';

  if (typeof window === 'undefined' || typeof document === 'undefined') return;
  if (window.__kexoLogoRotatorBound) return;
  window.__kexoLogoRotatorBound = true;

  function setLogoImg(img, url) {
    if (!img || !img.getAttribute || !img.setAttribute) return;
    if (img.getAttribute('data-kexo-logo-rotated') === '1') {
      try {
        img.setAttribute('data-kexo-logo-ready', '1');
        if (img.hasAttribute && img.hasAttribute('hidden')) img.removeAttribute('hidden');
      } catch (_) {}
      return;
    }
    if (!url) return;
    try {
      if (String(img.getAttribute('src') || '') !== String(url)) img.setAttribute('src', url);
      img.setAttribute('data-kexo-logo-rotated', '1');
      img.setAttribute('data-kexo-logo-ready', '1');
      if (img.hasAttribute && img.hasAttribute('hidden')) img.removeAttribute('hidden');
    } catch (_) {}
  }

  function run() {
    // Header (desktop strip)
    var headerImg =
      document.querySelector('img[data-kexo-logo-slot="header"]') ||
      document.querySelector('.kexo-desktop-brand-link img');
    if (headerImg) setLogoImg(headerImg, '/api/header-logo');

    // Footer
    var footerImg =
      document.querySelector('img[data-kexo-logo-slot="footer"]') ||
      document.querySelector('.kexo-footer-logo img');
    if (footerImg) setLogoImg(footerImg, '/api/footer-logo');
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', run);
  } else {
    run();
  }
})();

// Insights → Payment Methods (back-compat route: /insights/payment-types)
(function () {
  'use strict';

  try {
    const page = String(PAGE || '').trim().toLowerCase();
    if (page !== 'payment-types') return;
  } catch (_) { return; }

  // Single-init guard (avoid repeated bindings in embed reloads).
  try {
    if (document && document.documentElement && document.documentElement.getAttribute('data-kexo-payment-methods-init') === '1') return;
    if (document && document.documentElement) document.documentElement.setAttribute('data-kexo-payment-methods-init', '1');
  } catch (_) {}

  function escapeHtml(value) {
    if (value == null) return '';
    try {
      const div = document.createElement('div');
      div.textContent = String(value);
      return div.innerHTML.replace(/\"/g, '&quot;').replace(/'/g, '&#39;');
    } catch (_) {
      return String(value)
        .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;').replace(/'/g, '&#39;');
    }
  }

  function fmtInt(value) {
    const n = Number(value);
    if (!Number.isFinite(n)) return '—';
    return Math.max(0, Math.trunc(n)).toLocaleString('en-GB');
  }

  function fmtMoneyGbp2(value) {
    const n = Number(value);
    if (!Number.isFinite(n)) return '—';
    try { return '£' + n.toLocaleString('en-GB', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); } catch (_) { return '£' + n.toFixed(2); }
  }

  function fmtPct1(value) {
    if (value == null) return '—';
    const n = Number(value);
    if (!Number.isFinite(n)) return '—';
    return n.toFixed(1) + '%';
  }

  function normalizeRangeKeyForApi(key) {
    const k = (key == null ? '' : String(key)).trim();
    if (!k) return 'today';
    const lc = k.toLowerCase();
    if (lc === '7days') return '7d';
    if (lc === '14days') return '14d';
    if (lc === '30days') return '30d';
    return k;
  }

  function currentRangeKey() {
    try {
      const sel = document.getElementById('global-date-select');
      if (sel && sel.value) return normalizeRangeKeyForApi(sel.value);
    } catch (_) {}
    try {
      if (typeof dateRange !== 'undefined' && dateRange) return normalizeRangeKeyForApi(dateRange);
    } catch (_) {}
    return 'today';
  }

  function setUpdated(label) {
    const el = document.getElementById('payment-methods-updated');
    if (!el) return;
    el.textContent = label || 'Updated —';
  }

  function setTableMessage(message, isError) {
    const body = document.getElementById('payment-types-body');
    if (!body) return;
    const msg = String(message || '—');
    body.innerHTML =
      '<div class="grid-row" role="row">' +
        '<div class="grid-cell empty span-all' + (isError ? ' text-danger' : '') + '" role="cell">' + escapeHtml(msg) + '</div>' +
      '</div>';
  }

  function setChartMessage(message, isError) {
    const el = document.getElementById('payment-methods-chart');
    if (!el) return;
    el.innerHTML = '<div class="' + (isError ? 'text-danger' : 'text-secondary') + '">' + escapeHtml(message || '—') + '</div>';
  }

  function renderPaymentCell(iconSrc, iconAlt, label) {
    const safeLabel = label != null ? String(label) : 'Other';
    const safeAlt = iconAlt != null ? String(iconAlt) : safeLabel;
    const img = iconSrc
      ? '<img class="kexo-payment-method-icon kexo-payment-method-icon--fill" src="' + escapeHtml(iconSrc) + '" alt="' + escapeHtml(safeAlt) + '" loading="lazy" />'
      : '<i class="fa-light fa-circle-question text-secondary kexo-payment-method-fallback-icon" aria-hidden="true"></i>';
    return '<span class="d-inline-flex align-items-center gap-2">' + img + '<span>' + escapeHtml(safeLabel) + '</span></span>';
  }

  function tablerPaymentProviderForKey(key) {
    const k = (key == null ? '' : String(key)).trim().toLowerCase();
    if (!k) return '';
    if (k === 'visa') return 'visa';
    if (k === 'mastercard') return 'mastercard';
    if (k === 'amex') return 'americanexpress';
    if (k === 'paypal') return 'paypal';
    if (k === 'klarna') return 'klarna';
    if (k === 'shop_pay') return 'shop-pay';
    if (k === 'apple_pay') return 'applepay';
    if (k === 'google_pay') return 'google-pay';
    if (k === 'discover') return 'discover';
    if (k === 'maestro') return 'maestro';
    if (k === 'diners') return 'dinersclub';
    if (k === 'unionpay') return 'unionpay';
    return '';
  }

  const CHART_KEY = 'payment-methods-chart';
  let lastPayload = null;
  let inFlight = null;
  let reqSeq = 0;

  function renderChart(payload) {
    const el = document.getElementById('payment-methods-chart');
    if (!el) return;

    const categoriesRaw = payload && Array.isArray(payload.categories) ? payload.categories : [];
    const seriesRaw = payload && Array.isArray(payload.series) ? payload.series : [];
    if (!categoriesRaw.length || !seriesRaw.length) {
      setChartMessage('No revenue data for this range.', false);
      return;
    }

    const categories = categoriesRaw.map(function (v) {
      try {
        const s = String(v || '');
        // Only apply date formatter to YYYY-MM-DD categories; hourly buckets are already formatted.
        if (/^\d{4}-\d{2}-\d{2}/.test(s) && typeof formatYmdShort === 'function') return formatYmdShort(s);
      } catch (_) {}
      return String(v || '');
    });

    const series = seriesRaw.map(function (s) {
      const name = s && s.label != null ? String(s.label) : (s && s.key != null ? String(s.key) : '—');
      const data = Array.isArray(s && s.data) ? s.data.map(function (v) { const n = Number(v); return Number.isFinite(n) ? n : 0; }) : [];
      return { name: name, data: data };
    });

    const enabled = (typeof isChartEnabledByUiConfig === 'function') ? isChartEnabledByUiConfig(CHART_KEY, true) : true;
    if (!enabled) {
      try {
        if (el.__kexoChartInstance) {
          try { el.__kexoChartInstance.destroy(); } catch (_) {}
          el.__kexoChartInstance = null;
        }
      } catch (_) {}
      el.innerHTML = '';
      return;
    }

    const rawMode = (typeof chartModeFromUiConfig === 'function') ? (chartModeFromUiConfig(CHART_KEY, 'line') || 'line') : 'line';
    const showEndLabels = rawMode === 'multi-line-labels';
    const mode = rawMode === 'multi-line-labels' ? 'line' : rawMode;
    const palette = (typeof chartColorsFromUiConfig === 'function')
      ? chartColorsFromUiConfig(CHART_KEY, ['#4b94e4', '#f59e34', '#3eb3ab', '#8b5cf6', '#ef4444', '#22c55e', '#0ea5e9', '#a3e635'])
      : ['#4b94e4', '#f59e34', '#3eb3ab', '#8b5cf6', '#ef4444', '#22c55e', '#0ea5e9', '#a3e635'];

    try {
      if (typeof window.kexoRenderApexChart === 'function') {
        window.kexoRenderApexChart({
          chartKey: CHART_KEY,
          containerEl: el,
          categories: categories,
          series: series,
          mode: mode,
          colors: palette,
          height: 320,
          showEndLabels: showEndLabels,
          currency: true,
          chartStyle: (typeof chartStyleFromUiConfig === 'function') ? chartStyleFromUiConfig(CHART_KEY) : null,
          advancedApexOverride: (typeof chartAdvancedOverrideFromUiConfig === 'function') ? chartAdvancedOverrideFromUiConfig(CHART_KEY, mode) : {},
        });
      } else {
        setChartMessage('Chart unavailable.', true);
      }
    } catch (_) {
      setChartMessage('Failed to render chart.', true);
    }
  }

  function renderTable(payload) {
    const body = document.getElementById('payment-types-body');
    if (!body) return;
    const rows = payload && Array.isArray(payload.rows) ? payload.rows : [];
    if (!rows.length) {
      setTableMessage('No payment methods for this range.', false);
      return;
    }
    body.innerHTML = rows.map(function (r) {
      const key = r && r.key != null ? String(r.key) : '';
      const label = r && r.label != null ? String(r.label) : 'Other';
      const iconSrc = r && r.iconSrc ? String(r.iconSrc) : '';
      const iconAlt = r && r.iconAlt ? String(r.iconAlt) : label;
      const payCell = '<span class="d-inline-flex align-items-center">' + escapeHtml(label) + '</span>';
      const provider = tablerPaymentProviderForKey(key);
      const iconInner = provider
        ? '<span class="payment payment-lg payment-provider-' + escapeHtml(provider) + '" aria-hidden="true"></span>'
        : (iconSrc
          ? '<img class="kexo-payment-method-icon kexo-payment-method-icon--fill" src="' + escapeHtml(iconSrc) + '" alt="' + escapeHtml(iconAlt) + '" loading="lazy" />'
          : '<i class="fa-light fa-circle-question text-secondary kexo-payment-method-fallback-icon" aria-hidden="true"></i>');
      const iconCell = '<span class="d-flex align-items-center justify-content-center w-100 h-100">' + iconInner + '</span>';
      return '' +
        '<div class="grid-row" role="row">' +
          '<div class="grid-cell" role="cell">' + payCell + '</div>' +
          '<div class="grid-cell kexo-payments-icon-col kexo-payment-method-icon-cell" role="cell">' + iconCell + '</div>' +
          '<div class="grid-cell text-center" role="cell">' + escapeHtml(fmtInt(r.sessions)) + '</div>' +
          '<div class="grid-cell text-end" role="cell">' + escapeHtml(fmtInt(r.carts)) + '</div>' +
          '<div class="grid-cell text-end" role="cell">' + escapeHtml(fmtInt(r.orders)) + '</div>' +
          '<div class="grid-cell text-end" role="cell">' + escapeHtml(fmtPct1(r.cr)) + '</div>' +
          '<div class="grid-cell text-end" role="cell">' + escapeHtml(fmtMoneyGbp2(r.vpv)) + '</div>' +
          '<div class="grid-cell text-end" role="cell">' + escapeHtml(fmtMoneyGbp2(r.revenue)) + '</div>' +
          '<div class="grid-cell text-end" role="cell">' + escapeHtml(fmtMoneyGbp2(r.aov)) + '</div>' +
        '</div>';
    }).join('');
  }

  function load(options) {
    const opts = options && typeof options === 'object' ? options : {};
    const force = !!opts.force;
    const range = currentRangeKey() || 'today';
    const seq = ++reqSeq;
    setUpdated('Updated —');
    setChartMessage('Loading…', false);
    setTableMessage('Loading…', false);

    const url = API + '/api/payment-methods/report?range=' + encodeURIComponent(String(range)) + (force ? ('&_=' + Date.now()) : '');
    const fetcher = (typeof fetchWithTimeout === 'function')
      ? fetchWithTimeout(url, { credentials: 'same-origin', cache: 'no-store' }, 20000)
      : fetch(url, { credentials: 'same-origin', cache: 'no-store' });

    inFlight = Promise.resolve(fetcher)
      .then(function (r) { return (r && r.ok) ? r.json().catch(function () { return null; }) : null; })
      .then(function (data) {
        if (seq !== reqSeq) return null;
        if (!data || !data.ok) {
          setChartMessage('Failed to load payment methods.', true);
          setTableMessage('Failed to load payment methods.', true);
          return null;
        }
        lastPayload = data;
        renderChart(data);
        renderTable(data);
        try { setUpdated('Updated ' + new Date().toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' })); } catch (_) {}
        return data;
      })
      .catch(function () {
        if (seq !== reqSeq) return null;
        setChartMessage('Failed to load payment methods.', true);
        setTableMessage('Failed to load payment methods.', true);
        return null;
      })
      .finally(function () {
        if (inFlight && seq === reqSeq) inFlight = null;
      });

    return inFlight;
  }

  function bind() {
    const sel = document.getElementById('global-date-select');
    if (sel && sel.getAttribute('data-payment-methods-bound') !== '1') {
      sel.setAttribute('data-payment-methods-bound', '1');
      sel.addEventListener('change', function () { setTimeout(function () { load({ force: true }); }, 0); });
    }

    try {
      if (window && window.addEventListener) {
        window.addEventListener('kexo:chartsUiConfigUpdated', function () {
          if (!lastPayload) return;
          try { renderChart(lastPayload); } catch (_) {}
        });
      }
    } catch (_) {}
  }

  bind();
  load({ force: false });
})();


})();
