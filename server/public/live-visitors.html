<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="robots" content="noindex, nofollow" />
  <link rel="icon" type="image/png" href="https://cdn.shopify.com/s/files/1/0847/7261/8587/files/spyview_favicon.png?v=1770086377&width=100" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <title>Liveview</title>
  <style>
    :root {
      --bg: #fafafa;
      --card: #fff;
      --text: #333;
      --muted: #333;
      --accent: #0d9488;
      --border: #e1e1e1;
      --shadow: 0 1px 3px rgba(0, 0, 0, .06);
      --radius: 3px;
      --th-bg: #f5f5f5;
      --row-hover: #f5f5f5;
      --converted-bg: #dcf0ee;
      --converted-hover: #dcf0ee;
      --returning-bg: #fff;
      --badge-new-fg: #fff;
      --badge-returning: #6366f1;
      --chip-abandoned: #dc2626;
      --side-panel-shadow: -4px 0 24px rgba(0, 0, 0, .08);
      --side-panel-sale-bg: rgba(13, 148, 136, 0.08);
      --button-hover-bg: #f5f5f5;
      --select-arrow: #333;
      /* Table consistency */
      --table-cell-padding-y: 0.6rem;
      --table-cell-padding-x: 0.75rem;
      --table-font-size: 0.875rem;
      --table-th-font-size: 0.75rem;
      --table-compact-padding-y: 0.4rem;
      --table-compact-padding-x: 0.5rem;
      --online-dot-color: #4caf50;
      --link-fg: #06133b;
      --top-bar-divider: #eee;
      --table-font-size-mobile: 0.8125rem;
    }
    * { box-sizing: border-box; }
    body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 0; min-height: 100vh; line-height: 1.5; }
    .main { padding: 1.5rem; margin: 0 auto; }
    .stats-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1.25rem; align-items: stretch; }
    .stats-card { background: var(--card); padding: 1.25rem; border-radius: var(--radius); border: 1px solid var(--border); box-shadow: var(--shadow); min-width: 0; box-sizing: border-box; }
    /* Stats tables: keep cards tall so they don't look empty while loading */
    #tab-panel-stats .stats-card { min-height: 500px; }
    #stats-country, #stats-best-sellers, #stats-worst-products, #stats-best-variants, #stats-aov { display: flex; flex-direction: column; }
    #stats-country .stats-card-header h3, #stats-best-sellers .stats-card-header h3, #stats-worst-products .stats-card-header h3, #stats-best-variants .stats-card-header h3 { margin-bottom: -30px; position: absolute; transition: opacity 0.15s ease; }
    #stats-country.scrolled .stats-card-header h3, #stats-best-sellers.scrolled .stats-card-header h3, #stats-worst-products.scrolled .stats-card-header h3, #stats-best-variants.scrolled .stats-card-header h3 { opacity: 0; pointer-events: none; }
    .stats-card h3 { margin: 0; font-size: 0.75rem; font-weight: 600; color: var(--muted); text-transform: uppercase; letter-spacing: 0.04em; }
    .stats-card-header { display: flex; align-items: center; justify-content: space-between; gap: 0.5rem; /* margin-bottom: 0.5rem; */ }
    .stats-section { display: flex; flex-direction: column; gap: 1px; }
    .stats-main { font-size: 1.5rem; font-weight: 700; color: var(--accent); letter-spacing: -0.02em; }
    .stats-breakdown { font-size: 0.8125rem; color: var(--text); display: flex; flex-wrap: wrap; gap: 0.75rem; }
    .stats-breakdown span { display: inline-block; }
    .stats-divider { height: 1px; /* background: var(--border); */ margin: 0.6rem 0; }
    .stats-select { padding: 0.35rem 0.5rem; border: 1px solid var(--border); border-radius: var(--radius); background: var(--card); color: var(--text); font-size: 0.8125rem; }
    .muted { color: var(--muted); font-size: 0.8rem; }
    .country-table-wrap { overflow-y: auto; overflow-x: hidden; flex: 1; min-height: 0; }
    .by-country-table { width: 100%; border-collapse: collapse; font-size: var(--table-font-size); table-layout: fixed; }
    .by-country-table th, .by-country-table td { padding: var(--table-compact-padding-y) 0.35rem; border-bottom: none; }
    .stats-card .by-country-table th:first-child, .stats-card .by-country-table td:first-child { padding-left: 0; margin-left: 0; min-width: 0; width: 30%; }
    .stats-card .by-country-table th:last-child, .stats-card .by-country-table td:last-child { padding-right: 0; }
    .stats-card .by-country-table th:not(:first-child), .stats-card .by-country-table td:not(:first-child) { text-align: center; white-space: nowrap; }
    .by-country-table th { font-size: 0.7rem; color: #777; font-weight: 500; text-transform: uppercase; letter-spacing: 0.03em; background: none; }
    .by-country-table tbody td:first-child { display: flex; align-items: center; gap: 0.5rem; min-width: 0; }
    .by-country-table tbody td:first-child > * { min-width: 0; }
    .by-country-table .country-label { min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .by-country-table.aov-table .country-label { overflow: visible; text-overflow: clip; white-space: normal; }
    .by-country-table .country-name { display: inline; }
    .by-country-table .country-code { display: none; }
    .by-country-table .flag-img { width: 24px; height: 18px; object-fit: cover; border-radius: var(--radius); }
    .best-sellers-table .bs-product-col { max-width: 150px; width: auto; }
    .best-sellers-table .product-cell { display: flex; align-items: center; gap: 0.5rem; min-width: 0; flex: 1; }
    .best-sellers-table .product-cell a { display: inline-block; text-decoration: none; }
    .best-sellers-table .product-cell .bs-thumb { width: 32px; height: 32px; object-fit: cover; border-radius: var(--radius); flex-shrink: 0; }
    .best-sellers-table .product-cell .bs-name { min-width: 0; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; white-space: normal; overflow-wrap: anywhere; word-break: break-word; line-height: 1.15; }
    .best-sellers-table .bs-thumb-placeholder { display: inline-block; width: 32px; height: 32px; background: var(--border); border-radius: var(--radius); }
    .best-sellers-table th.sortable { cursor: pointer; user-select: none; }
    .best-sellers-table th.sortable:hover { color: var(--accent); }
    .best-sellers-table th.th-sort-asc::after { content: ' \25b4'; font-size: 0.65em; opacity: 0.8; }
    .best-sellers-table th.th-sort-desc::after { content: ' \25be'; font-size: 0.65em; opacity: 0.8; }
    .aov-list { list-style: none; padding: 0; margin: 0; font-size: var(--table-font-size); }
    .aov-list li { padding: 0.35rem 0; border-bottom: none; display: flex; justify-content: space-between; align-items: center; gap: 0.5rem; }
    .aov-list li > span { display: flex; align-items: center; gap: 0.5rem; }
    table { width: 100%; border-collapse: collapse; background: var(--card); border-radius: var(--radius); overflow: hidden; border: 1px solid var(--border); box-shadow: var(--shadow); }
    th, td { padding: var(--table-cell-padding-y) var(--table-cell-padding-x); text-align: left; border-bottom: 1px solid var(--border); vertical-align: middle; font-size: var(--table-font-size); }
    th { background: var(--th-bg); font-size: var(--table-th-font-size); color: var(--muted); font-weight: 600; text-transform: uppercase; letter-spacing: 0.03em; }
    th:first-child, td:first-child { min-width: 80px; padding-left: var(--table-cell-padding-x); }
    tr:hover { background: inherit; }
    tr.returning { background: var(--returning-bg); }
    tr.converted { background: var(--converted-bg); }
    tr.converted:hover { background: var(--converted-bg); }
    tr.clickable { cursor: pointer; }
    .flag-cell { white-space: nowrap; }
    .arrived-cell, .last-seen-cell { font-size: 0.875rem; white-space: nowrap; }
    .flag-img { width: 24px; height: 18px; object-fit: cover; border-radius: var(--radius); margin-right: 0.25rem; vertical-align: middle; display: inline-block; }
    .last-action-cell { display: flex; align-items: center; gap: 0.5rem; }
.last-action-cell a { color: var(--link-fg); text-decoration: none; font-size: 12px; font-weight: 500; }
.last-action-cell a:hover { text-decoration: underline; }
.landing-fallback-hint { font-size: 0.75rem; color: var(--muted); font-weight: normal; }
    .thumb-card { display: inline-flex; align-items: center; justify-content: center; width: 35px; height: 35px; padding: 2px; background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); box-shadow: var(--shadow); flex-shrink: 0; box-sizing: border-box; }
    .thumb-card--sale { border: none; padding: 0; box-shadow: none; background: none; }
    .thumb-card img { width: 100%; height: 100%; object-fit: cover; border-radius: 1px; display: block; }
.table-title { font-size: 1rem; font-weight: 600; color: var(--text); margin-bottom: 0.5rem; }
    .badge { display: inline-block; padding: 0.15rem 0.4rem; border-radius: var(--radius); font-size: 0.75rem; }
    .badge.new { background: var(--accent); color: var(--badge-new-fg); }
    .badge.returning { background: var(--badge-returning); color: var(--badge-new-fg); }
    .chip { display: inline-block; padding: 0.1rem 0.35rem; border-radius: var(--radius); font-size: 0.7rem; margin-right: 0.25rem; }
    .chip.checking-out { background: var(--accent); color: var(--badge-new-fg); }
    .chip.abandoned { background: var(--chip-abandoned); color: var(--badge-new-fg); }
    .side-panel { position: fixed; top: 0; right: 0; width: 400px; max-width: 100%; height: 100%; background: var(--card); border-left: 1px solid var(--border); box-shadow: var(--side-panel-shadow); overflow-y: auto; z-index: 10; padding: 1.25rem; }
    .side-panel h3 { margin: 0 0 0.5rem; }
    .side-panel .close { float: right; cursor: pointer; font-size: 1.2rem; color: var(--muted); }
    .side-panel .meta { font-size: 0.85rem; color: var(--muted); margin: 0.5rem 0; }
    .side-panel-sale { margin: 0.75rem 0; padding: 0.75rem; background: var(--side-panel-sale-bg); border-radius: var(--radius); border-left: 3px solid var(--accent); color: var(--text); }
    .side-panel-sale strong { color: var(--accent); }
    .side-panel ul.events { list-style: none; padding: 0; margin: 0.5rem 0; font-size: 0.85rem; }
    .side-panel ul.events li { padding: 0.35rem 0; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 0.5rem; }
    .side-panel ul.events li .thumb-card { flex-shrink: 0; }
    .side-panel-source { font-size: 0.8rem; color: var(--text); word-break: break-all; white-space: pre-wrap; margin: 0.25rem 0 1rem; line-height: 1.4; }
    .empty { text-align: center; padding: 2rem; color: var(--muted); }
    .consent-debug { font-size: 0.75rem; color: var(--muted); max-width: 200px; overflow: hidden; text-overflow: ellipsis; }
.dashboard-top-bar { display: flex; align-items: center; justify-content: space-between; padding: 10px 1.5rem 0; margin: 0 auto; width: 100%; box-sizing: border-box; }
.dashboard-top-bar-left { display: flex; align-items: center; }
.dashboard-top-bar-center { display: flex; align-items: center; justify-content: center; flex: 1; min-width: 0; }
.dashboard-top-bar-center .top-bar-logo { width: 60px; height: auto; display: block; object-fit: contain; }
.next-update-timer { width: 30px; text-align: center; font-weight: 500; display: inline-block; }
.dashboard-top-bar-right { display: flex; align-items: center; gap: 5px; }
.server-time-block { font-size: 0.8125rem; color: var(--muted); white-space: nowrap; margin: 0 5px 0 0; }
.server-time-tz { font-size: 0.7rem; opacity: 0.9; margin-left: 0.2rem; }
.top-bar-divider { width: 1px; height: 1.2em; background: var(--top-bar-divider); flex-shrink: 0; }
.refresh-btn { display: inline-flex; align-items: center; justify-content: center; width: 15px; height: 15px; padding: 0; border: none; background: none; cursor: pointer; color: var(--text); }
.refresh-btn:hover { color: var(--accent); }
.refresh-btn svg { width: 15px; height: 15px; }
.refresh-btn.spinning svg { animation: refresh-spin 0.8s linear; }
@keyframes refresh-spin { to { transform: rotate(360deg); } }
.next-update-block { display: inline-flex; align-items: center; gap: 0.35rem; font-size: 0.875rem; color: var(--muted); }
.table-loading-overlay { position: absolute; inset: 0; background: rgba(255,255,255,0.7); display: flex; align-items: center; justify-content: center; border-radius: var(--radius); z-index: 2; }
.table-loading-overlay .spinner { width: 28px; height: 28px; border: 3px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: refresh-spin 0.8s linear infinite; }
.inline-spinner { width: 28px; height: 28px; border: 3px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: refresh-spin 0.8s linear infinite; display: inline-block; }
/* Tab switch: Live (main table) vs Stats (cards) */
.main-tabs { display: flex; align-items: center; gap: 0; margin-bottom: 1rem; border-bottom: 1px solid var(--border); }
.main-tabs [role="tab"] { padding: 0.5rem 1rem; font-size: 0.875rem; font-weight: 500; color: var(--muted); background: none; border: none; border-bottom: 2px solid transparent; margin-bottom: -1px; cursor: pointer; font-family: inherit; }
.main-tabs [role="tab"]:hover { color: var(--text); }
.main-tabs [role="tab"][aria-selected="true"] { color: var(--accent); border-bottom-color: var(--accent); }
.main-tab-panel { display: none; }
.main-tab-panel.active { display: block; }
.stats-row-wrap { position: relative; }
.sessions-table-wrap { position: relative; }
.live-kpi-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 0.75rem; margin-bottom: 1rem; }
.live-kpi-cell { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); padding: 0.6rem 0.75rem; text-align: center; box-shadow: var(--shadow); }
.live-kpi-cell .live-kpi-label { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.04em; color: var(--muted); font-weight: 600; margin-bottom: 0.2rem; }
.live-kpi-cell .live-kpi-value { font-size: 1.1rem; font-weight: 700; color: var(--text); }
@media (max-width: 768px) {
  .live-kpi-grid { grid-template-columns: repeat(2, 1fr); gap: 0.5rem; margin-bottom: 0.75rem; }
  .live-kpi-cell .live-kpi-value { font-size: 1rem; }
}
.live-view-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; gap: 0; }
.live-view-header .table-title { margin: 0; font-size: 14px; font-weight: 500; color: var(--text); flex-shrink: 0; display: flex; align-items: center; gap: 0.35rem; letter-spacing: -0.1px; }
.live-view-header .live-view-online { flex-shrink: 0; }
.live-view-header .next-update-block { flex-shrink: 0; }
.live-view-header .live-view-next-update-center { flex: 1; display: flex; justify-content: center; }
.live-view-online { font-size: 0.875rem; color: var(--muted); display: flex; align-items: center; gap: 0.35rem; margin-right: 10px; }
.live-view-online .online-dot { width: 10px; height: 10px; border-radius: 50%; background: var(--online-dot-color); flex-shrink: 0; }
.live-view-online strong { color: var(--accent); font-size: 17px; }
.live-view-spy-icon { display: inline-flex; align-items: center; justify-content: center; width: 15px; height: 15px; flex-shrink: 0; }
.live-view-spy-icon svg { width: 15px; height: 15px; }
.dashboard-top-bar select { padding: 0.5rem 0.75rem; border: 1px solid var(--border); border-radius: var(--radius); background: var(--card); font-size: 0.875rem; color: var(--text); appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23333' d='M6 8L2 4h8z'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 0.5rem center; padding-right: 1.75rem; }
.dashboard-top-bar select option:disabled { color: var(--muted); }
#audio-mute-btn { display: inline-flex; align-items: center; justify-content: center; width: 20px; height: 20px; padding: 0; border: none; background: none; cursor: pointer; color: var(--text); }
#audio-mute-btn:hover { color: var(--accent); }
#audio-mute-btn.muted { opacity: 0.6; color: var(--muted); }
#audio-mute-btn svg { width: 20px; height: 20px; }
.table-scroll-wrap { overflow-x: auto; -webkit-overflow-scrolling: touch; margin-bottom: 0.5rem; border-radius: var(--radius); border: 1px solid var(--border); }
.table-scroll-wrap.tight-cols { --table-cell-padding-x: 0.35rem; }
.table-scroll-wrap table { margin: 0; min-width: 720px; }
.table-scroll-wrap th, .table-scroll-wrap td { border-bottom: none; }
.table-scroll-wrap th.source-cell, .table-scroll-wrap th.cart-value-cell, .table-scroll-wrap td.source-cell, .table-scroll-wrap td.cart-value-cell { text-align: center; width: 1%; white-space: nowrap; padding-right: var(--table-cell-padding-x); }
    /* LP column width: allow natural sizing on desktop */
    .table-scroll-wrap .last-action-cell { min-width: 0; }
    .table-scroll-wrap .last-action-cell a { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 100%; }
.table-scroll-wrap .cart-value-sale { color: var(--accent); font-weight: bold; }
.table-scroll-wrap th.sortable { cursor: pointer; user-select: none; }
.table-scroll-wrap th.sortable:hover { color: var(--accent); }
.table-scroll-wrap th.th-sort-asc::after { content: ' \25b4'; font-size: 0.65em; opacity: 0.8; }
.table-scroll-wrap th.th-sort-desc::after { content: ' \25be'; font-size: 0.65em; opacity: 0.8; }
.table-pagination { display: flex; align-items: center; justify-content: center; gap: 1rem; padding: 0.5rem 0 1rem; font-size: 0.875rem; color: var(--muted); }
.table-pagination button { padding: 0.35rem 0.75rem; border: 1px solid var(--border); border-radius: var(--radius); background: var(--card); color: var(--text); cursor: pointer; font-size: 0.875rem; }
.table-pagination button:hover:not(:disabled) { border-color: var(--accent); background: var(--button-hover-bg); }
.table-pagination button:disabled { opacity: 0.5; cursor: not-allowed; }
    .card-pagination { display: none; align-items: center; justify-content: center; gap: 0.5rem; padding: 0.35rem 0 0; font-size: 0.75rem; color: var(--muted); }
    .card-pagination button { padding: 0.25rem 0.6rem; border: 1px solid var(--border); border-radius: var(--radius); background: var(--card); color: var(--text); cursor: pointer; font-size: 0.75rem; }
    .card-pagination button:hover:not(:disabled) { border-color: var(--accent); background: var(--button-hover-bg); }
    .card-pagination button:disabled { opacity: 0.5; cursor: not-allowed; }
    .card-pagination .page-label { min-width: 96px; text-align: center; }
    .source-googleads-img, .source-icon-img { width: 20px; height: 20px; vertical-align: middle; display: inline-block; }
    .source-icons { display: inline-flex; align-items: center; gap: 4px; }
    .source-icons img { width: 20px; height: 20px; }
    @media (max-width: 1800px) {
      .stats-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
      .stats-card { min-width: 0; }
      .best-sellers-table .bs-product-col { max-width: 220px; }
    }
    @media (max-width: 768px) {
      .dashboard-top-bar-center { display: none; }
      .dashboard-top-bar { padding-left: 0.75rem; padding-right: 0.75rem; }
      .main { padding: 0.75rem; }
      .stats-row { grid-template-columns: 1fr; gap: 0.75rem; margin-bottom: 1rem; }
      .stats-card { min-width: 100%; }
      .stats-card:first-child { min-width: 100%; }
      .best-sellers-table .bs-product-col { max-width: 120px; }
      /* On mobile, show ISO codes instead of country labels (top tables). */
      .by-country-table .country-name { display: none; }
      .by-country-table .country-code { display: inline; }
      .stats-main { font-size: 1.35rem; }
      .stats-breakdown { gap: 0.5rem; font-size: 0.75rem; }
      .live-view-header .table-title { font-size: 0.9375rem; }
      .table-title { font-size: 0.9375rem; margin-bottom: 0.35rem; }
      .live-view-header .next-update-block { display: none; }
      .live-view-header .live-view-next-update-center { flex: 0; }
      .table-scroll-wrap { margin-left: 0; margin-right: 0; border-radius: var(--radius); -webkit-overflow-scrolling: touch; overflow-x: auto; }
      .side-panel { width: 100%; padding: 1rem; }
      .side-panel .close { min-width: 44px; min-height: 44px; display: inline-flex; align-items: center; justify-content: center; margin: -0.5rem 0 0.5rem 0; }
      th, td { padding: var(--table-compact-padding-y) var(--table-compact-padding-x); font-size: var(--table-font-size-mobile); }
      .last-action-cell a { display: none; }
      .thumb-card { width: 32px; height: 32px; padding: 1.5px; }
    }
    @media (max-width: 480px) {
      .dashboard-top-bar { padding-left: 0.5rem; padding-right: 0.5rem; }
      .main { padding: 0.5rem; }
      .stats-card { padding: 1rem; }
    }
    .dashboard-footer { text-align: center; padding: 0.75rem 1rem; font-size: 0.8125rem; color: var(--muted); margin: 0 auto; }

    .config-btn { display: inline-flex; align-items: center; justify-content: center; width: 18px; height: 18px; padding: 0; border: 1px solid var(--border); border-radius: 999px; background: var(--card); cursor: pointer; color: var(--text); font-size: 12px; line-height: 1; }
    .config-btn:hover { border-color: var(--accent); color: var(--accent); }
    .config-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.35); display: none; align-items: center; justify-content: center; padding: 1rem; z-index: 9999; }
    .config-modal.open { display: flex; }
    .config-modal-card { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); box-shadow: var(--shadow); width: 560px; max-width: 100%; max-height: 80vh; overflow: auto; padding: 1rem; }
    .config-modal-header { display: flex; align-items: center; justify-content: space-between; gap: 0.75rem; margin-bottom: 0.75rem; }
    .config-modal-title { margin: 0; font-size: 0.75rem; font-weight: 600; color: var(--muted); text-transform: uppercase; letter-spacing: 0.04em; }
    .config-close { border: none; background: none; cursor: pointer; font-size: 1.25rem; line-height: 1; color: var(--muted); }
    .config-close:hover { color: var(--accent); }
    .config-row { font-size: 0.8125rem; color: var(--text); margin: 0.25rem 0; word-break: break-word; }
    .config-row.ok { color: #0f766e; }
    .config-row.missing { color: #b91c1c; }
  </style>
</head>
<body>
  <div class="dashboard-top-bar">
    <div class="dashboard-top-bar-left">
      <select id="global-date-select" aria-label="Date range">
        <option value="today">Today</option>
        <option value="yesterday">Yesterday</option>
        <option value="3d">Last 3 Days</option>
        <option value="7d">Last 7 Days</option>
      </select>
    </div>
    <div class="dashboard-top-bar-center">
      <img class="top-bar-logo" src="https://www.hbdjewellery.com/cdn/shop/files/HBDDarkLogo.webp?width=100" alt="HBD" width="60" height="auto" loading="lazy">
    </div>
    <div class="dashboard-top-bar-right">
      <span class="server-time-block"><span id="server-time-msg">--:--</span> <span class="server-time-tz" aria-label="UK time (GMT/BST)">UK</span></span>
      <span class="top-bar-divider" aria-hidden="true"></span>
      <button type="button" id="refresh-btn" class="refresh-btn" title="Refresh" aria-label="Refresh">
        <svg viewBox="0 0 329.028 329.028" xmlns="http://www.w3.org/2000/svg" fill="currentColor"><path d="M241.852,72.459l10.847-54.533c1.184-5.95-1.334-12.028-6.378-15.398c-5.045-3.37-11.623-3.37-16.667,0 L156.182,51.62c-0.004,0.003-0.008,0.006-0.012,0.009c-0.415,0.278-0.817,0.576-1.201,0.893c-0.219,0.181-0.418,0.377-0.625,0.568 c-0.148,0.137-0.304,0.265-0.447,0.408c-0.249,0.25-0.478,0.514-0.707,0.778c-0.088,0.101-0.183,0.196-0.268,0.299 c-0.208,0.253-0.396,0.519-0.586,0.783c-0.095,0.132-0.197,0.259-0.288,0.394c-0.155,0.232-0.292,0.473-0.433,0.712 c-0.109,0.185-0.225,0.365-0.327,0.554c-0.104,0.195-0.192,0.397-0.288,0.597c-0.118,0.245-0.24,0.487-0.344,0.739 c-0.064,0.156-0.115,0.317-0.174,0.475c-0.112,0.299-0.227,0.598-0.32,0.906c-0.042,0.137-0.069,0.276-0.106,0.414 c-0.09,0.329-0.181,0.658-0.248,0.996c-0.045,0.223-0.068,0.45-0.103,0.675c-0.038,0.252-0.088,0.501-0.113,0.758 c-0.051,0.498-0.075,0.998-0.076,1.5c0,0.004-0.001,0.009-0.001,0.013c0,0.058,0.008,0.113,0.009,0.17 c0.004,0.437,0.023,0.874,0.066,1.311c0.016,0.156,0.045,0.307,0.065,0.461c0.043,0.332,0.086,0.664,0.151,0.994 c0.042,0.212,0.102,0.418,0.152,0.627c0.064,0.264,0.124,0.529,0.204,0.791c0.077,0.256,0.173,0.503,0.264,0.753 c0.076,0.208,0.143,0.418,0.229,0.624c0.126,0.305,0.272,0.598,0.418,0.892c0.072,0.146,0.134,0.295,0.211,0.438 c0.203,0.379,0.426,0.745,0.66,1.104c0.036,0.055,0.064,0.113,0.1,0.167l0.019,0.028c0.01,0.015,0.02,0.03,0.03,0.045l49.044,73.401 c2.817,4.217,7.525,6.667,12.47,6.667c0.971,0,1.952-0.094,2.928-0.288c5.951-1.184,10.602-5.835,11.786-11.786l7.052-35.455 c23.901,20.188,39.11,50.36,39.11,84.023c0,60.636-49.331,109.968-109.967,109.968c-60.637,0-109.969-49.332-109.969-109.968 c0-40.179,21.91-77.153,57.179-96.494c7.264-3.983,9.923-13.101,5.94-20.365c-3.983-7.264-13.101-9.924-20.365-5.94 C52.424,90.871,24.546,137.924,24.546,189.06c0,77.178,62.79,139.968,139.969,139.968c77.178,0,139.967-62.79,139.967-139.968 C304.482,140.453,279.571,97.56,241.852,72.459z"/></svg>
      </button>
      <span class="top-bar-divider" aria-hidden="true"></span>
      <button type="button" id="audio-mute-btn" title="Toggle sale sound" aria-label="Toggle sale sound">
        <svg class="sound-icon-on" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M9.5 19C8.89555 19 7.01237 19 5.61714 19C4.87375 19 4.39116 18.2177 4.72361 17.5528L5.57771 15.8446C5.85542 15.2892 6 14.6774 6 14.0564C6 13.2867 6 12.1434 6 11C6 9 7 5 12 5C17 5 18 9 18 11C18 12.1434 18 13.2867 18 14.0564C18 14.6774 18.1446 15.2892 18.4223 15.8446L19.2764 17.5528C19.6088 18.2177 19.1253 19 18.382 19H14.5M9.5 19C9.5 21 10.5 22 12 22C13.5 22 14.5 21 14.5 19M9.5 19C11.0621 19 14.5 19 14.5 19"/><path d="M12 5V3"/></svg>
        <svg class="sound-icon-off" style="display:none" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M6 15C6 15 6 13 6 11C6 9 7 5 12 5C13.5723 5 14.749 5.39552 15.6235 6M9.5 19C9.5 21 10.5 22 12 22C13.5 22 14.5 21 14.5 19M9.5 19C11.0621 19 14.5 19 14.5 19M9.5 19C9.14909 19 8.36719 19 7.5 19M14.5 19H18.382C19.1253 19 19.6088 18.2177 19.2764 17.5528L18 15C18 15 18 13 18 11C18 10.3755 17.9025 9.55594 17.6161 8.72408"/><path d="M12 5V3"/><path d="M21 3L3 21"/></svg>
      </button>
      <span class="top-bar-divider" aria-hidden="true"></span>
      <button type="button" id="config-open-btn" class="config-btn" title="Config / Health" aria-label="Config / Health">i</button>
    </div>
  </div>
  <main class="main">
  <div class="main-tabs" role="tablist" aria-label="View">
    <button type="button" role="tab" id="tab-spy" aria-selected="true" aria-controls="tab-panel-spy" data-tab="spy">Live</button>
    <button type="button" role="tab" id="tab-stats" aria-selected="false" aria-controls="tab-panel-stats" data-tab="stats">Stats</button>
  </div>
  <div id="tab-panel-spy" class="main-tab-panel active" role="tabpanel" aria-labelledby="tab-spy">
  <div class="live-kpi-grid" id="live-kpi-grid" aria-label="Live view KPIs for selected date range">
    <div class="live-kpi-cell"><div class="live-kpi-label">Sales</div><div class="live-kpi-value" id="live-kpi-sales">—</div></div>
    <div class="live-kpi-cell"><div class="live-kpi-label">Sessions</div><div class="live-kpi-value" id="live-kpi-sessions">—</div></div>
    <div class="live-kpi-cell"><div class="live-kpi-label">Conv rate</div><div class="live-kpi-value" id="live-kpi-conv">—</div></div>
    <div class="live-kpi-cell"><div class="live-kpi-label">AOV</div><div class="live-kpi-value" id="live-kpi-aov">—</div></div>
    <div class="live-kpi-cell"><div class="live-kpi-label">Bounce rate</div><div class="live-kpi-value" id="live-kpi-bounce">—</div></div>
  </div>
  <div class="live-view-header">
    <h2 class="table-title" id="table-title"><span class="live-view-spy-icon" id="live-view-spy-icon" aria-hidden="true"><svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M12.0002 5C9.89024 5 7.99432 5.92747 6.49128 7.00884C4.98034 8.0959 3.78013 9.40024 3.04026 10.2985C2.21965 11.2948 2.21965 12.7052 3.04026 13.7015C3.78013 14.5998 4.98034 15.9041 6.49128 16.9912C7.99432 18.0725 9.89024 19 12.0002 19C14.1101 19 16.006 18.0725 17.5091 16.9912C19.02 15.9041 20.2202 14.5998 20.9601 13.7015C21.7807 12.7052 21.7807 11.2948 20.9601 10.2985C20.2202 9.40025 19.02 8.0959 17.5091 7.00885C16.006 5.92747 14.1101 5 12.0002 5ZM12 10C10.8954 10 10 10.8954 10 12C10 13.1046 10.8954 14 12 14C13.1046 14 14 13.1046 14 12C14 10.8954 13.1046 10 12 10ZM8 12C8 9.79086 9.79086 8 12 8C14.2091 8 16 9.79086 16 12C16 14.2091 14.2091 16 12 16C9.79086 16 8 14.2091 8 12Z" fill="currentColor"></path></svg></span><span id="table-title-text">Today</span></h2>
    <span class="next-update-block live-view-next-update-center">Next update in: <span id="next-update-msg" class="next-update-timer">-- s</span></span>
    <div class="live-view-online"><span class="online-dot"></span> Online: <strong id="online-count">0</strong></div>
  </div>
  <div class="sessions-table-wrap">
    <div class="table-loading-overlay sessions-loading-overlay" id="sessions-loading-overlay" style="display: none;"><div class="spinner"></div></div>
  <div class="table-scroll-wrap">
  <table id="sessions-table">
    <thead>
      <tr>
        <th>LP</th>
        <th class="sortable" data-sort="from" aria-sort="none" tabindex="0">GEO</th>
        <th class="source-cell sortable" data-sort="source" aria-sort="none" tabindex="0">Source</th>
        <th>Device</th>
        <th>History</th>
        <th class="sortable" data-sort="arrived" aria-sort="none" tabindex="0">Arrived</th>
        <th class="sortable" data-sort="last_seen" aria-sort="none" tabindex="0">Last Seen</th>
        <th class="cart-value-cell sortable" data-sort="cart" aria-sort="none" tabindex="0">Cart</th>
        <th class="consent-col" style="display:none">Consent (debug)</th>
      </tr>
    </thead>
    <tbody id="table-body"></tbody>
  </table>
  </div>
  <div class="table-pagination" id="table-pagination">
    <button type="button" id="pagination-prev" aria-label="Previous page">Prev</button>
    <span id="pagination-label">Page 1 of 1</span>
    <button type="button" id="pagination-next" aria-label="Next page">Next</button>
    <span class="muted">Rows</span>
    <select id="rows-per-page-select" class="stats-select" aria-label="Rows per page">
      <option value="15">15</option>
      <option value="30">30</option>
      <option value="50">50</option>
      <option value="100">100</option>
    </select>
  </div>
  </div>
  </div>
  <div id="tab-panel-stats" class="main-tab-panel" role="tabpanel" aria-labelledby="tab-stats">
  <div class="stats-row-wrap">
    <div class="table-loading-overlay stats-loading-overlay" id="stats-loading-overlay" style="display: none;"><div class="spinner"></div></div>
  <div class="stats-row">
    <div class="stats-card" id="stats-primary">
      <div class="stats-section">
        <div class="stats-card-header">
          <h3>Sales</h3>
        </div>
        <div class="stats-main" id="sales-today"></div>
        <div class="stats-breakdown">
          <span>Yesterday: <strong id="sales-yesterday"></strong></span>
        </div>
      </div>
      <div class="stats-divider"></div>
      <div class="stats-section">
        <div class="stats-card-header">
          <h3>Conversion rate</h3>
        </div>
        <div class="stats-main" id="conversion-range"></div>
        <div class="stats-breakdown">
          <span>Product Conversion Rate: <strong id="conversion-product-cr"></strong></span>
        </div>
      </div>
      <div class="stats-divider"></div>
      <div class="stats-section">
        <div class="stats-card-header">
          <h3>Sessions</h3>
        </div>
        <div class="stats-main" id="sessions-range"></div>
        <div class="stats-breakdown">
          <span>Yesterday: <strong id="sessions-yesterday"></strong></span>
        </div>
      </div>
    </div>
    <div class="stats-card" id="stats-country">
      <div class="stats-card-header">
        <h3>Country</h3>
      </div>
      <div class="country-table-wrap" id="country-table-wrap">
        <table id="country-table" class="by-country-table">
          <thead>
            <tr>
              <th></th>
              <th>CR</th>
              <th>Sales</th>
              <th>Clicks</th>
              <th>Rev</th>
            </tr>
          </thead>
          <tbody id="by-country-body">
            <tr><td colspan="5" class="empty">Loading...</td></tr>
          </tbody>
        </table>
      </div>
      <div class="card-pagination" id="country-pagination" aria-label="Country pagination">
        <button type="button" id="country-prev">Prev</button>
        <span class="page-label" id="country-label">Page 1 of 1</span>
        <button type="button" id="country-next">Next</button>
      </div>
    </div>
    <div class="stats-card" id="stats-best-sellers">
      <div class="stats-card-header">
        <h3>Best</h3>
      </div>
      <div class="country-table-wrap" id="best-sellers-wrap">
        <table id="best-sellers-table" class="by-country-table best-sellers-table">
          <thead>
            <tr>
              <th class="bs-product-col"></th>
              <th class="sortable" data-sort="orders" aria-sort="none" tabindex="0">Orders</th>
              <th class="sortable" data-sort="rev" aria-sort="descending" tabindex="0">Rev</th>
              <th>CR%</th>
            </tr>
          </thead>
          <tbody id="best-sellers-body">
            <tr><td colspan="4" class="empty">Loading...</td></tr>
          </tbody>
        </table>
      </div>
      <div class="card-pagination" id="best-sellers-pagination" aria-label="Best sellers pagination">
        <button type="button" id="best-sellers-prev">Prev</button>
        <span class="page-label" id="best-sellers-label">Page 1 of 1</span>
        <button type="button" id="best-sellers-next">Next</button>
      </div>
    </div>
    <div class="stats-card" id="stats-worst-products">
      <div class="stats-card-header">
        <h3>Worst</h3>
      </div>
      <div class="country-table-wrap" id="worst-products-wrap">
        <table id="worst-products-table" class="by-country-table best-sellers-table">
          <thead>
            <tr>
              <th class="bs-product-col"></th>
              <th>Clicks</th>
              <th>Rev</th>
              <th>CR</th>
            </tr>
          </thead>
          <tbody id="worst-products-body">
            <tr><td colspan="4" class="empty">Loading...</td></tr>
          </tbody>
        </table>
      </div>
      <div class="card-pagination" id="worst-products-pagination" aria-label="Worst products pagination">
        <button type="button" id="worst-products-prev">Prev</button>
        <span class="page-label" id="worst-products-label">Page 1 of 1</span>
        <button type="button" id="worst-products-next">Next</button>
      </div>
    </div>
    <div class="stats-card" id="stats-best-variants">
      <div class="stats-card-header">
        <h3>Variants</h3>
      </div>
      <div class="country-table-wrap" id="best-variants-wrap">
        <table id="best-variants-table" class="by-country-table best-sellers-table">
          <thead>
            <tr>
              <th class="bs-product-col"></th>
              <th>Orders</th>
              <th>Rev</th>
            </tr>
          </thead>
          <tbody id="best-variants-body">
            <tr><td colspan="3" class="empty">Loading...</td></tr>
          </tbody>
        </table>
      </div>
      <div class="card-pagination" id="best-variants-pagination" aria-label="Best variants pagination">
        <button type="button" id="best-variants-prev">Prev</button>
        <span class="page-label" id="best-variants-label">Page 1 of 1</span>
        <button type="button" id="best-variants-next">Next</button>
      </div>
    </div>
    <div class="stats-card" id="stats-aov">
      <div class="stats-card-header">
        <h3>Average Order Value</h3>
      </div>
      <div class="country-table-wrap" id="aov-list-wrap">
        <table id="aov-table" class="by-country-table aov-table">
          <thead>
            <tr>
              <th>Country</th>
              <th>Average Order Value</th>
            </tr>
          </thead>
          <tbody id="aov-by-country-body">
            <tr><td colspan="2" class="empty">Loading...</td></tr>
          </tbody>
        </table>
      </div>
      <div class="card-pagination" id="aov-pagination" aria-label="AOV pagination">
        <button type="button" id="aov-prev">Prev</button>
        <span class="page-label" id="aov-label">Page 1 of 1</span>
        <button type="button" id="aov-next">Next</button>
      </div>
    </div>
  </div>
  </div>
  </div>

  <div id="side-panel" class="side-panel" style="display:none">
    <span class="close" id="side-close">&times;</span>
    <h3>Session</h3>
    <div class="meta" id="side-meta"></div>
    <h4>Source</h4>
    <div class="side-panel-source" id="side-source"></div>
    <h4>Activity:</h4>
    <ul class="events" id="side-events"></ul>
  </div>
  </main>
  <footer class="dashboard-footer" id="dashboard-footer">Liveview v<span id="app-version">—</span></footer>

  <div class="config-modal" id="config-modal" aria-hidden="true">
    <div class="config-modal-card" role="dialog" aria-modal="true" aria-label="Config and health">
      <div class="config-modal-header">
        <h3 class="config-modal-title">Config &amp; health</h3>
        <button type="button" class="config-close" id="config-close-btn" aria-label="Close">×</button>
      </div>
      <div id="config-status"></div>
    </div>
  </div>

  <script>
    const API = '';
    const LIVE_REFRESH_MS = 60000;
    const STATS_REFRESH_MS = 15 * 60 * 1000;
    fetch(API + '/api/version').then(r => r.json()).then(d => { const el = document.getElementById('app-version'); if (el) el.textContent = d.version || '—'; }).catch(() => {});
    const SALE_MUTED_KEY = 'livevisitors-sale-muted';
    const TOP_TABLE_PAGE_SIZE = 10;
    const ROWS_PER_PAGE_KEY = 'livevisitors-rows-per-page';
    const ROWS_PER_PAGE_OPTIONS = [15, 30, 50, 100];
    function loadRowsPerPage() {
      try {
        const raw = sessionStorage.getItem(ROWS_PER_PAGE_KEY);
        const n = parseInt(String(raw), 10);
        if (ROWS_PER_PAGE_OPTIONS.indexOf(n) >= 0) return n;
      } catch (_) {}
      return 50;
    }
    let rowsPerPage = loadRowsPerPage();
    let sessions = [];
    let statsCache = {};
    let dateRange = 'today';
    let activeMainTab = 'spy';
    let nextLiveAt = 0;
    let lastSessionsFetchedAt = 0;
    let lastStatsFetchedAt = 0;
    let liveRefreshInFlight = null;
    let statsRefreshInFlight = null;
    let lastUpdateTime = null;
    let lastConvertedCountToday = 0;
    let shopifySalesToday = null;
    let shopifyOrderCountToday = null;
    let shopifySalesTodayLoaded = false; // true once we have attempted to fetch (success or failure)
    let shopifySalesTodayLoading = false;
    let bestSellersCache = null;
    let worstProductsCache = null;
    let bestVariantsCache = null;
    let countryPage = 1;
    let aovPage = 1;
    let bestSellersPage = 1;
    let worstProductsPage = 1;
    let bestVariantsPage = 1;
    let bestSellersSortBy = 'rev';
    let bestSellersSortDir = 'desc';
    let saleAudio = null;
    let saleMuted = false;
    let currentPage = 1;
    let sortBy = 'last_seen';
    let sortDir = 'desc';
    const SORT_DEFAULTS = { from: 'asc', arrived: 'desc', source: 'asc', cart: 'desc', last_seen: 'desc' };

    // Auto-configure pixel when opened from Shopify (shop in URL) so merchants don't run mutations manually
    (function ensurePixelOnce() {
      const params = new URLSearchParams(window.location.search);
      const shop = params.get('shop');
      if (shop && /\.myshopify\.com$/i.test(shop)) {
        fetch(API + '/api/pixel/ensure?shop=' + encodeURIComponent(shop), { credentials: 'same-origin' })
          .then(function (r) { return r.json(); })
          .then(function (data) {
            if (data.ok && data.action) console.log('[Live Visitors] Pixel', data.action);
          })
          .catch(function () {});
      }
    })();
    // 'active' = last 5 min so old sales drop off; 'today' = 24h (sessions stay including old sales).
    let filter = 'active';
    let selectedSessionId = null;
    let timeTick = null;
    const tz = 'Europe/London';

    function updateServerTimeDisplay() {
      const el = document.getElementById('server-time-msg');
      if (!el) return;
      var now = new Date();
      el.textContent = now.toLocaleTimeString('en-GB', { timeZone: tz, hour: '2-digit', minute: '2-digit', hour12: false });
    }

    function updateNextUpdateUi() {
      const block = document.querySelector('#tab-panel-spy .next-update-block');
      if (!block) return;
      const show = activeMainTab === 'spy' && dateRange === 'today';
      if (!show) {
        block.style.display = 'none';
        const el = document.getElementById('next-update-msg');
        if (el) el.textContent = '';
        return;
      }
      // Clear inline style so CSS (e.g. mobile) can control visibility.
      block.style.display = '';
      const el = document.getElementById('next-update-msg');
      if (!el) return;
      const target = (typeof nextLiveAt === 'number' && nextLiveAt > Date.now())
        ? nextLiveAt
        : (Date.now() + LIVE_REFRESH_MS);
      const sec = Math.max(0, Math.ceil((target - Date.now()) / 1000));
      el.textContent = sec + ' s';
    }

    function toMs(v) {
      if (v == null || v === '') return null;
      let n = typeof v === 'number' ? v : Number(v);
      if (Number.isNaN(n)) return null;
      if (n < 1e12) n *= 1000;
      return n;
    }

    function formatTs(ms) {
      const n = toMs(ms);
      if (n == null) return '\u2014';
      const d = new Date(n);
      if (Number.isNaN(d.getTime())) return '\u2014';
      return d.toLocaleString('en-GB', { timeZone: tz, dateStyle: 'short', timeStyle: 'short' });
    }

    function formatRelative(ms) {
      const n = toMs(ms);
      if (n == null) return '';
      const s = Math.floor((Date.now() - n) / 1000);
      if (s < 60) return s + 's ago';
      if (s < 3600) return Math.floor(s / 60) + 'm ago';
      return Math.floor(s / 3600) + 'h ago';
    }

    function formatDuration(startMs) {
      const n = toMs(startMs);
      if (n == null) return '';
      const s = Math.floor((Date.now() - n) / 1000);
      const m = Math.floor(s / 60);
      const h = Math.floor(m / 60);
      if (h > 0) return h + 'h ' + (m % 60) + 'm';
      if (m > 0) return m + 'm ' + (s % 60) + 's';
      return s + 's';
    }

    var countryNames = { GB: 'UK', US: 'USA', CA: 'CA', AU: 'AU', DE: 'DE', FR: 'FR', IE: 'IE', ES: 'ES', IT: 'IT', NL: 'NL', IN: 'IN', JP: 'JP', DK: 'DK', SE: 'SE', NO: 'NO', TH: 'TH', NZ: 'NZ', RO: 'RO', BE: 'BE', FI: 'FI', AE: 'UAE', XX: '\u2014' };
    var countryNamesFull = { GB: 'United Kingdom', US: 'United States', CA: 'Canada', AU: 'Australia', DE: 'Germany', FR: 'France', IE: 'Ireland', ES: 'Spain', IT: 'Italy', NL: 'Netherlands', IN: 'India', JP: 'Japan', DK: 'Denmark', SE: 'Sweden', NO: 'Norway', TH: 'Thailand', NZ: 'New Zealand', RO: 'Romania', BE: 'Belgium', FI: 'Finland', AE: 'United Arab Emirates', XX: '\u2014' };

    function countryLabel(code) {
      if (!code) return 'Unknown';
      var c = (code || 'XX').toUpperCase().slice(0, 2);
      return countryNames[c] || c;
    }

    function countryLabelFull(code) {
      if (!code) return 'Unknown';
      var c = (code || 'XX').toUpperCase().slice(0, 2);
      return countryNamesFull[c] || countryNames[c] || c;
    }

    // Add Shopify-style width param to hotlinked images.
    function hotImg(url) {
      if (typeof url !== 'string' || !/^https?:\/\//i.test(url)) return url;
      try {
        const u = new URL(url);
        u.searchParams.set('width', '100');
        return u.toString();
      } catch (_) {
        return url + (url.indexOf('?') >= 0 ? '&' : '?') + 'width=100';
      }
    }

    function flagImg(code) {
      if (!code || code === 'XX') return '<img class="flag-img" src="' + hotImg('https://flagcdn.com/w40/xx.png') + '" alt="?" loading="lazy">';
      const c = (code || 'xx').toLowerCase().slice(0, 2);
      return '<img class="flag-img" src="' + hotImg('https://flagcdn.com/w40/' + escapeHtml(c) + '.png') + '" alt="' + escapeHtml(code) + '" loading="lazy">';
    }

    function arrivedAgo(startedAt) {
      var n = toMs(startedAt);
      if (n == null) return '\u2014';
      var s = Math.floor((Date.now() - n) / 1000);
      if (s < 60) return s + ' secs ago';
      if (s < 3600) return Math.floor(s / 60) + ' mins ago';
      if (s < 86400) return Math.floor(s / 3600) + ' hrs ago';
      return Math.floor(s / 86400) + ' days ago';
    }

    var storeBaseUrlFallback = '';
    var mainBaseUrlFallback = '';
    var assetsBaseUrlFallback = '';
    var shopForSalesFallback = '';
    var storeBaseUrlLoaded = false;
    (function fetchStoreBaseUrl() {
      fetch(API + '/api/store-base-url', { credentials: 'same-origin' })
        .then(function(r) { return r.json(); })
        .then(function(d) {
          if (d) {
            if (d.baseUrl) storeBaseUrlFallback = d.baseUrl;
            if (d.mainBaseUrl) mainBaseUrlFallback = d.mainBaseUrl;
            if (d.assetsBaseUrl) assetsBaseUrlFallback = d.assetsBaseUrl;
            if (d.shopForSales) shopForSalesFallback = d.shopForSales;
            if (sessions.length) renderTable();
            if (assetsBaseUrlFallback) {
              var link = document.querySelector('link[rel="icon"]');
              if (link) link.href = assetsBaseUrlFallback + '/favicon.png?width=100';
              if (typeof saleAudio !== 'undefined' && saleAudio) saleAudio.src = assetsBaseUrlFallback + '/cash-register.mp3';
            }
            // Only fetch Shopify-derived stats tables when viewing Stats (manual / 15-min cadence).
            if (activeMainTab === 'stats' && shopForSalesFallback && dateRange === 'today' && typeof fetchShopifySales === 'function') fetchShopifySales();
            if (activeMainTab === 'stats' && shopForSalesFallback && typeof fetchBestSellers === 'function') fetchBestSellers();
            if (activeMainTab === 'stats' && shopForSalesFallback && typeof fetchBestVariants === 'function') fetchBestVariants();
          }
          storeBaseUrlLoaded = true;
          // If we were waiting for Shopify sales but no shop is configured, stop showing a placeholder.
          if (typeof renderSales === 'function') renderSales(statsCache);
        })
        .catch(function() { storeBaseUrlLoaded = true; if (typeof renderSales === 'function') renderSales(statsCache); });
    })();

    function getShopForSales() {
      var shop = getShopParam() || shopForSalesFallback || null;
      return shop && /\.myshopify\.com$/i.test(shop) ? shop : null;
    }

    function shouldWaitForShopifySalesToday() {
      if (dateRange !== 'today') return false;
      if (getShopForSales()) return true;
      // If we don't know the shop yet (direct load), wait briefly for /api/store-base-url.
      return !storeBaseUrlLoaded;
    }
    function getStoreBaseUrl() {
      var params = new URLSearchParams(window.location.search);
      var shop = params.get('shop');
      if (shop && /\.myshopify\.com$/i.test(shop)) return 'https://' + shop;
      return storeBaseUrlFallback || '';
    }
    function getMainBaseUrl() {
      if (mainBaseUrlFallback) return mainBaseUrlFallback;
      return getStoreBaseUrl();
    }
    function getAssetsBase() {
      if (assetsBaseUrlFallback) return assetsBaseUrlFallback;
      return (API || '') + '/assets';
    }

    var HICON_URL = hotImg('https://cdn.shopify.com/s/files/1/0847/7261/8587/files/hicon.webp?v=1770084894');
    var DOLLAR_URL = hotImg('https://cdn.shopify.com/s/files/1/0847/7261/8587/files/dollar.png?v=1770085223');

    function titleCaseFromHandle(handle) {
      if (typeof handle !== 'string') return null;
      let s = handle;
      try { s = decodeURIComponent(s); } catch (_) {}
      s = s.replace(/[-_]+/g, ' ').replace(/\s+/g, ' ').trim();
      if (!s) return null;
      return s.split(' ').filter(Boolean).map(function(w) {
        const lower = w.toLowerCase();
        return lower.charAt(0).toUpperCase() + lower.slice(1);
      }).join(' ');
    }

    function productTitleFromPath(path) {
      if (typeof path !== 'string') return null;
      const m = path.trim().match(/^\/products\/([^/?#]+)/i);
      if (!m) return null;
      return titleCaseFromHandle(m[1]);
    }

    function landingPageCell(s) {
      var hasFirst = (s.first_path != null && s.first_path !== '') || (s.first_product_handle != null && s.first_product_handle !== '');
      var path = (s.first_path != null && s.first_path !== '' ? s.first_path : (hasFirst ? '' : (s.last_path != null ? s.last_path : ''))).trim();
      var productHandle = s.first_product_handle != null && s.first_product_handle !== '' ? s.first_product_handle : (hasFirst ? null : (s.last_product_handle != null ? s.last_product_handle : null));
      var isFromLast = !hasFirst && (path || productHandle);
      if (path && !path.startsWith('/')) path = '/' + path;
      if (!path && productHandle) path = '/products/' + (productHandle || '');
      var pathNorm = path ? path.replace(/\/+$/, '') : '';
      var isCheckout = path && path.indexOf('/checkouts') === 0;
      var isHomeOrOrders = path === '/' || path === '/orders' || pathNorm === '/orders' || (path && path.startsWith('/orders/'));
      var isCart = path === '/cart' || pathNorm === '/cart';
      var mainBase = getMainBaseUrl();
      var fullUrl = mainBase && path ? mainBase + path : '';
      var label = '\u2014';
      var thumbSrc = '';
      // Keep the LP thumbnail stable even after purchase; do not swap to a "sale" icon.
      if (isHomeOrOrders) {
        label = path === '/' ? 'Home' : escapeHtml(path);
        thumbSrc = HICON_URL;
      } else if (isCart) {
        label = 'Cart';
        thumbSrc = HICON_URL;
      } else if (isCheckout) {
        label = 'Cart';
        thumbSrc = getAssetsBase() + '/checkout.webp';
      } else if (path) {
        // Display pretty product name for /products/<handle> paths (link stays the same).
        const prettyProduct = productTitleFromPath(path);
        label = escapeHtml(prettyProduct || path);
        if (fullUrl) thumbSrc = (API || '') + '/api/og-thumb?url=' + encodeURIComponent(fullUrl);
      }
      if (isFromLast && label !== '\u2014') label += ' <span class="landing-fallback-hint">(last)</span>';
      if (thumbSrc || fullUrl) {
        var cardClass = thumbSrc === DOLLAR_URL ? 'thumb-card thumb-card--sale' : 'thumb-card';
        var img = thumbSrc ? '<span class="' + cardClass + '"><img src="' + thumbSrc + '" alt="" onerror="this.parentElement&&(this.parentElement.style.display=\'none\')"></span>' : '';
        var link = fullUrl ? '<a href="' + escapeHtml(fullUrl) + '" target="_blank" rel="noopener">' + label + '</a>' : label;
        return '<div class="last-action-cell">' + img + ' ' + link + '</div>';
      }
      return label === '\u2014' ? label : escapeHtml(path || '');
    }

    function formatMoney(amount, currencyCode) {
      if (amount == null || typeof amount !== 'number') return '';
      const code = (currencyCode || 'GBP').toUpperCase();
      const sym = code === 'GBP' ? '\u00A3' : code === 'USD' ? '$' : code === 'EUR' ? '\u20AC' : code + ' ';
      return sym + (amount % 1 === 0 ? amount : amount.toFixed(2));
    }

    function sourceLabel(s) {
      const parts = [];
      if (s.utm_source && String(s.utm_source).trim()) parts.push('utm_source: ' + escapeHtml(String(s.utm_source).trim()));
      if (s.utm_campaign && String(s.utm_campaign).trim()) parts.push('utm_campaign: ' + escapeHtml(String(s.utm_campaign).trim()));
      if (s.utm_medium && String(s.utm_medium).trim()) parts.push('utm_medium: ' + escapeHtml(String(s.utm_medium).trim()));
      if (s.utm_content && String(s.utm_content).trim()) parts.push('utm_content: ' + escapeHtml(String(s.utm_content).trim()));
      if (s.referrer && String(s.referrer).trim()) parts.push('referrer: ' + escapeHtml(String(s.referrer).trim()));
      return parts.join(' ');
    }

    function sourceUtmString(s) {
      return [s.utm_source, s.utm_campaign, s.utm_medium, s.utm_content].filter(Boolean).join(' ').toLowerCase();
    }

    function isGoogleAdsSource(s) {
      return sourceUtmString(s).indexOf('googleads') !== -1;
    }

    /** Derive friendly source name from referrer URL host (when no UTM). Use for tooltip and to collect images. */
    function sourceReferrerFriendlyLabel(s) {
      const ref = s.referrer && String(s.referrer).trim();
      if (!ref) return null;
      try {
        const u = new URL(ref);
        const host = (u.hostname || '').toLowerCase().replace(/^www\./, '');
        if (!host) return null;
        if (host === 'account.heybigday.com') return 'HeyBigDay Account';
        if (host === 'account.hbdjewellery.com') return 'HBD Account';
        if (host === 'hbdjewellery.com' || host.endsWith('.myshopify.com')) return 'Store';
        if (host.indexOf('omnisend') !== -1) return 'Omnisend';
        if (host.indexOf('google') !== -1) return 'Google';
        if (host.indexOf('facebook') !== -1 || host.indexOf('fb.') === 0 || host === 'fb.com') return 'Facebook';
        if (host.indexOf('instagram') !== -1) return 'Instagram';
        if (host.indexOf('pinterest') !== -1) return 'Pinterest';
        if (host.indexOf('tiktok') !== -1) return 'TikTok';
        if (host.indexOf('twitter') !== -1 || host.indexOf('x.com') !== -1) return 'X (Twitter)';
        if (host.indexOf('youtube') !== -1) return 'YouTube';
        if (host.indexOf('linkedin') !== -1) return 'LinkedIn';
        if (host.indexOf('bing') !== -1) return 'Bing';
        if (host.indexOf('yahoo') !== -1) return 'Yahoo';
        if (host.indexOf('duckduckgo') !== -1) return 'DuckDuckGo';
        return host;
      } catch (_) { return null; }
    }

    function sourceFriendlyLabel(s) {
      const str = sourceUtmString(s);
      if (str) {
        if (str.indexOf('googleads') !== -1) return null;
        if (str.indexOf('google') !== -1) return 'Google';
        if (str.indexOf('bing') !== -1) return 'Bing';
        if (str.indexOf('omnisend') !== -1) return 'Omnisend';
        if (str.indexOf('chatgpt') !== -1 || str.indexOf('chat gpt') !== -1) return 'Chatgpt';
        return null;
      }
      return sourceReferrerFriendlyLabel(s);
    }

    function sourceSortKey(s) {
      if (isGoogleAdsSource(s)) return 'Google Ads';
      const friendly = sourceFriendlyLabel(s);
      if (friendly === 'Google') return 'Google';
      if (friendly) return friendly;
      if (sourceUtmString(s)) return 'Other';
      if (s.referrer && String(s.referrer).trim()) return 'Other';
      return 'Direct';
    }

    const SOURCE_GOOGLE_IMG = hotImg('https://cdn.shopify.com/s/files/1/0847/7261/8587/files/google.png?v=1770086632');
    const SOURCE_DIRECT_IMG = hotImg('https://cdn.shopify.com/s/files/1/0847/7261/8587/files/arrow-right.png?v=1770086632');
    const SOURCE_CONVERTED_BADGE_IMG = hotImg('https://cdn.shopify.com/s/files/1/0847/7261/8587/files/spyview_favicon.png?v=1770087896');
    const SOURCE_UNKNOWN_IMG = hotImg('https://cdn.shopify.com/s/files/1/0847/7261/8587/files/question.png?v=1770135816');
    const SOURCE_OMNISEND_IMG = hotImg('https://cdn.shopify.com/s/files/1/0847/7261/8587/files/omnisend.png?v=1770141052');
    const SOURCE_BING_IMG = hotImg('https://cdn.shopify.com/s/files/1/0847/7261/8587/files/bing.png?v=1770141094');
    const SOURCE_LIVEVIEW_SOURCE_IMG = hotImg('https://cdn.shopify.com/s/files/1/0847/7261/8587/files/liveview-source-logo.png?v=1770141081');

    function sourceCell(s) {
      function icon(src, alt, title, extraClass) {
        const cls = (extraClass ? (extraClass + ' ') : '') + 'source-icon-img';
        const t = title ? ' title="' + escapeHtml(String(title)) + '"' : '';
        return '<img src="' + escapeHtml(hotImg(src) || src || '') + '" alt="' + escapeHtml(alt || '') + '" class="' + cls + '" width="20" height="20"' + t + '>';
      }

      const out = [];

      // 1) UTM-derived source icon (campaign/source)
      const utmStr = sourceUtmString(s);
      let utmLabel = '';
      const hasGoogleAds = isGoogleAdsSource(s);
      if (hasGoogleAds) {
        utmLabel = 'Google Ads';
        out.push(icon(getAssetsBase() + '/adwords.png', utmLabel, utmLabel, 'source-googleads-img'));
      } else if (utmStr) {
        const friendly = sourceFriendlyLabel(s);
        utmLabel = friendly || 'Other (UTM)';
        if (friendly === 'Google') out.push(icon(SOURCE_GOOGLE_IMG, 'Google', 'Google (UTM)'));
        else if (friendly === 'Bing') out.push(icon(SOURCE_BING_IMG, 'Bing', 'Bing (UTM)'));
        else if (friendly === 'Omnisend') out.push(icon(SOURCE_OMNISEND_IMG, 'Omnisend', 'Omnisend (UTM)'));
        else out.push(icon(SOURCE_UNKNOWN_IMG, utmLabel, utmLabel));
      }

      // 2) Referrer-derived source icon (organic/social)
      const refLabel = sourceReferrerFriendlyLabel(s);
      if (refLabel && refLabel !== 'Store' && refLabel !== utmLabel) {
        if (refLabel === 'Google') {
          // Don't show a generic Google icon when Google Ads is present.
          if (!hasGoogleAds) out.push(icon(SOURCE_GOOGLE_IMG, 'Google', 'Google (Referrer)'));
        }
        else if (refLabel === 'Bing') out.push(icon(SOURCE_BING_IMG, 'Bing', 'Bing (Referrer)'));
        else if (refLabel === 'Omnisend') out.push(icon(SOURCE_OMNISEND_IMG, 'Omnisend', 'Omnisend (Referrer)'));
        else if (refLabel === 'HeyBigDay Account' || refLabel === 'HBD Account') out.push(icon(SOURCE_LIVEVIEW_SOURCE_IMG, refLabel, String(refLabel)));
        else out.push(icon(SOURCE_UNKNOWN_IMG, refLabel, String(refLabel)));
      }

      // 3) Direct fallback
      if (out.length === 0) out.push(icon(SOURCE_DIRECT_IMG, 'Direct', 'Direct'));

      // 4) Converted badge (always last)
      if (s && s.has_purchased) out.push(icon(SOURCE_CONVERTED_BADGE_IMG, 'Converted', 'Converted'));

      return '<span class="source-icons">' + out.join('') + '</span>';
    }

    function sourceDetailForPanel(s) {
      const lines = [];
      const entry = s.entry_url && String(s.entry_url).trim();
      if (entry) lines.push('Entry URL (CF referer): ' + entry);
      const ref = s.referrer && String(s.referrer).trim();
      if (ref) lines.push('Referrer: ' + ref);
      if (s.utm_source != null && String(s.utm_source).trim() !== '') lines.push('utm_source: ' + String(s.utm_source).trim());
      if (s.utm_medium != null && String(s.utm_medium).trim() !== '') lines.push('utm_medium: ' + String(s.utm_medium).trim());
      if (s.utm_campaign != null && String(s.utm_campaign).trim() !== '') lines.push('utm_campaign: ' + String(s.utm_campaign).trim());
      if (s.utm_content != null && String(s.utm_content).trim() !== '') lines.push('utm_content: ' + String(s.utm_content).trim());
      if (lines.length === 0) return '—';
      return lines.join('\n');
    }

    function renderRow(s) {
      const countryCode = s.country_code || 'XX';
      const visits = (s.returning_count != null ? s.returning_count : 0) + 1;
      const visitsLabel = visits === 1 ? '1 visit' : visits + ' visits';
      const cartValueNum = s.cart_value != null ? Number(s.cart_value) : NaN;
      const cartVal = s.has_purchased ? '' : ((s.cart_value != null && !Number.isNaN(cartValueNum))
        ? formatMoney(cartValueNum, s.cart_currency)
        : '');
      const saleVal = s.has_purchased ? formatMoney(s.order_total != null ? Number(s.order_total) : null, s.order_currency) : '';
      const cartOrSaleCell = s.has_purchased
        ? '<span class="cart-value-sale">' + escapeHtml(saleVal) + '</span>'
        : cartVal;
      const fromCell = flagImg(countryCode);
      const consentDebug = s.meta_json ? (JSON.parse(s.meta_json || '{}').customer_privacy_debug ? 'yes' : '') : '';
      return `<tr class="clickable ${s.is_returning ? 'returning' : ''} ${s.has_purchased ? 'converted' : ''}" data-session-id="${s.session_id}">
        <td>${landingPageCell(s)}</td>
        <td class="flag-cell">${fromCell}</td>
        <td class="source-cell">${sourceCell(s)}</td>
        <td>${escapeHtml(s.device || '')}</td>
        <td>${visitsLabel}</td>
        <td class="arrived-cell"><span data-started="${s.started_at}">${arrivedAgo(s.started_at)}</span></td>
        <td class="last-seen-cell"><span data-last-seen="${s.last_seen}">${arrivedAgo(s.last_seen)}</span></td>
        <td class="cart-value-cell">${cartOrSaleCell}</td>
        <td class="consent-debug consent-col" style="display:none">${escapeHtml(consentDebug)}</td>
      </tr>`;
    }

    function escapeHtml(str) {
      if (str == null) return '';
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    function cartSortValue(s) {
      if (s.has_purchased && s.order_total != null) return Number(s.order_total);
      if (s.cart_value != null) { const n = Number(s.cart_value); if (!Number.isNaN(n)) return n; }
      return -Infinity;
    }

    function getSortedSessions() {
      if (!sortBy) return sessions.slice();
      const list = sessions.slice();
      const mult = sortDir === 'asc' ? 1 : -1;
      list.sort(function (a, b) {
        var va, vb;
        if (sortBy === 'from') {
          va = (a.country_code || 'ZZ').toUpperCase();
          vb = (b.country_code || 'ZZ').toUpperCase();
          return mult * (va < vb ? -1 : va > vb ? 1 : 0);
        }
        if (sortBy === 'arrived') {
          va = toMs(a.started_at) ?? 0;
          vb = toMs(b.started_at) ?? 0;
          return mult * (va - vb);
        }
        if (sortBy === 'source') {
          va = sourceSortKey(a);
          vb = sourceSortKey(b);
          return mult * (va < vb ? -1 : va > vb ? 1 : 0);
        }
        if (sortBy === 'cart') {
          va = cartSortValue(a);
          vb = cartSortValue(b);
          return mult * (va - vb);
        }
        if (sortBy === 'last_seen') {
          va = toMs(a.last_seen) ?? 0;
          vb = toMs(b.last_seen) ?? 0;
          return mult * (va - vb);
        }
        return 0;
      });
      return list;
    }

    function renderTable() {
      const tbody = document.getElementById('table-body');
      const sorted = getSortedSessions();
      const totalPages = Math.max(1, Math.ceil(sorted.length / rowsPerPage));
      currentPage = Math.min(Math.max(1, currentPage), totalPages);
      const start = (currentPage - 1) * rowsPerPage;
      const pageSessions = sorted.slice(start, start + rowsPerPage);
      if (sorted.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="empty">No sessions in this view.</td></tr>';
      } else {
        tbody.innerHTML = pageSessions.map(renderRow).join('');
        document.querySelectorAll('#table-body tr.clickable').forEach(tr => {
          tr.addEventListener('click', () => {
            selectedSessionId = tr.dataset.sessionId;
            openSidePanel(selectedSessionId);
          });
        });
      }
      const prevBtn = document.getElementById('pagination-prev');
      const nextBtn = document.getElementById('pagination-next');
      const labelEl = document.getElementById('pagination-label');
      if (prevBtn) { prevBtn.disabled = currentPage <= 1; }
      if (nextBtn) { nextBtn.disabled = currentPage >= totalPages; }
      if (labelEl) labelEl.textContent = 'Page ' + currentPage + ' of ' + totalPages;
      updateSortHeaders();
      syncSessionsTableTightMode();
      tickTimeOnSite();
    }

    function syncSessionsTableTightMode() {
      const wrap = document.querySelector('.table-scroll-wrap');
      const table = document.getElementById('sessions-table');
      if (!wrap || !table) return;
      // "Max mode": when all columns fit, remove extra inter-column padding.
      const fits = table.scrollWidth <= wrap.clientWidth + 1;
      wrap.classList.toggle('tight-cols', !!fits);
    }

    function updateSortHeaders() {
      document.querySelectorAll('.table-scroll-wrap th.sortable').forEach(function (th) {
        var col = th.getAttribute('data-sort');
        th.classList.remove('th-sort-asc', 'th-sort-desc');
        th.setAttribute('aria-sort', sortBy === col ? (sortDir === 'asc' ? 'ascending' : 'descending') : 'none');
        if (sortBy === col) th.classList.add(sortDir === 'asc' ? 'th-sort-asc' : 'th-sort-desc');
      });
    }

    function setupSortableHeaders() {
      document.querySelectorAll('.table-scroll-wrap th.sortable').forEach(function (th) {
        th.addEventListener('click', function () {
          var col = th.getAttribute('data-sort');
          if (sortBy === col) sortDir = sortDir === 'asc' ? 'desc' : 'asc';
          else { sortBy = col; sortDir = SORT_DEFAULTS[col] || 'asc'; }
          renderTable();
        });
      });
    }

    function tickTimeOnSite() {
      document.querySelectorAll('#table-body span[data-started]').forEach(span => {
        const started = parseInt(span.getAttribute('data-started'), 10);
        span.textContent = arrivedAgo(started);
      });
      document.querySelectorAll('#table-body span[data-last-seen]').forEach(span => {
        const lastSeen = parseInt(span.getAttribute('data-last-seen'), 10);
        span.textContent = arrivedAgo(lastSeen);
      });
    }

    function pct(v) { return v != null ? v.toFixed(1) + '%' : ''; }

    function formatRevenue(num) {
      if (num == null || typeof num !== 'number') return '';
      return '\u00A3' + (num % 1 === 0 ? num : num.toFixed(2));
    }

    function getShopParam() {
      var p = new URLSearchParams(window.location.search);
      var shop = p.get('shop') || '';
      return shop && /\.myshopify\.com$/i.test(shop) ? shop : null;
    }

    function fetchShopifySales() {
      var shop = getShopForSales();
      if (!shop || dateRange !== 'today') {
        // If the store-base-url lookup is done and we still have no shop, stop waiting and fall back to DB.
        if (dateRange === 'today' && storeBaseUrlLoaded && !shop) shopifySalesTodayLoaded = true;
        shopifySalesTodayLoading = false;
        return;
      }
      if (shopifySalesTodayLoading) return;
      shopifySalesTodayLoading = true;
      fetch(API + '/api/shopify-sales?shop=' + encodeURIComponent(shop), { credentials: 'same-origin' })
        .then(function(r) { return r.ok ? r.json() : null; })
        .then(function(data) {
          shopifySalesToday = data && typeof data.salesToday === 'number' ? data.salesToday : null;
          shopifyOrderCountToday = data && typeof data.orderCountToday === 'number' ? data.orderCountToday : null;
          shopifySalesTodayLoaded = true;
          shopifySalesTodayLoading = false;
          renderSales(statsCache);
        })
        .catch(function() {
          shopifySalesToday = null;
          shopifyOrderCountToday = null;
          shopifySalesTodayLoaded = true;
          shopifySalesTodayLoading = false;
          renderSales(statsCache);
        });
    }

    function fetchBestSellers(options = {}) {
      const force = !!options.force;
      var shop = getShopParam() || shopForSalesFallback || null;
      if (!shop) {
        bestSellersCache = null;
        renderBestSellers(null);
        return Promise.resolve(null);
      }
      setTbodyLoading('best-sellers-body', 4);
      let url = API + '/api/shopify-best-sellers?shop=' + encodeURIComponent(shop) +
          '&range=' + encodeURIComponent(dateRange) +
          '&page=' + encodeURIComponent(String(bestSellersPage || 1)) +
          '&pageSize=' + encodeURIComponent(String(TOP_TABLE_PAGE_SIZE)) +
          '&sort=' + encodeURIComponent(String(bestSellersSortBy || 'rev')) +
          '&dir=' + encodeURIComponent(String(bestSellersSortDir || 'desc'));
      if (force) url += '&_=' + Date.now();
      return fetch(url, { credentials: 'same-origin', cache: force ? 'no-store' : 'default' })
        .then(function(r) { return r.ok ? r.json() : null; })
        .then(function(data) {
          bestSellersCache = data;
          renderBestSellers(data);
          return data;
        })
        .catch(function() { bestSellersCache = null; renderBestSellers(null); return null; });
    }

    function fetchWorstProducts(options = {}) {
      const force = !!options.force;
      setTbodyLoading('worst-products-body', 4);
      let url = API + '/api/worst-products?range=' + encodeURIComponent(dateRange) +
          '&page=' + encodeURIComponent(String(worstProductsPage || 1)) +
          '&pageSize=' + encodeURIComponent(String(TOP_TABLE_PAGE_SIZE));
      if (force) url += '&_=' + Date.now();
      return fetch(url, { credentials: 'same-origin', cache: force ? 'no-store' : 'default' })
        .then(function(r) { return r.ok ? r.json() : null; })
        .then(function(data) {
          worstProductsCache = data;
          renderWorstProducts(data);
          return data;
        })
        .catch(function() { worstProductsCache = null; renderWorstProducts(null); return null; });
    }

    function renderWorstProducts(data) {
      const tbody = document.getElementById('worst-products-body');
      if (!tbody) return;
      if (!data || !Array.isArray(data.worstProducts)) {
        tbody.innerHTML = '<tr><td colspan="4" class="empty">No data</td></tr>';
        updateCardPagination('worst-products', 1, 1);
        return;
      }
      const rows = data.worstProducts.slice();
      const pageSize = (data && typeof data.pageSize === 'number' && data.pageSize > 0) ? data.pageSize : TOP_TABLE_PAGE_SIZE;
      const totalCount = (data && typeof data.totalCount === 'number' && data.totalCount >= 0) ? data.totalCount : rows.length;
      const totalPages = Math.max(1, Math.ceil(totalCount / pageSize));
      worstProductsPage = clampPage((data && typeof data.page === 'number') ? data.page : worstProductsPage, totalPages);
      updateCardPagination('worst-products', worstProductsPage, totalPages);
      if (rows.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="empty">No product landings in this range</td></tr>';
        return;
      }
      tbody.innerHTML = rows.map(function(p) {
        const handle = p.handle || '';
        const mainBase = getMainBaseUrl();
        const productUrl = (mainBase && handle) ? (mainBase + '/products/' + encodeURIComponent(handle)) : '';
        const thumbSrc = productUrl ? (API || '') + '/api/og-thumb?url=' + encodeURIComponent(productUrl) : '';
        const thumbImg = thumbSrc ? '<img class="bs-thumb" src="' + thumbSrc + '" alt="" loading="lazy" onerror="this.parentElement&&(this.parentElement.style.display=\'none\')">' : '<span class="bs-thumb bs-thumb-placeholder"></span>';
        const thumb = productUrl ? '<a href="' + productUrl + '" target="_blank" rel="noopener">' + thumbImg + '</a>' : thumbImg;
        const name = '<span class="bs-name" title="' + escapeHtml(handle) + '">' + escapeHtml(handle) + '</span>';
        const conversion = p.conversion != null ? pct(p.conversion) : '\u2014';
        const clicks = formatSessions(typeof p.clicks === 'number' ? p.clicks : 0);
        const revNum = p.revenue != null ? Number(p.revenue) : NaN;
        const revenue = (!Number.isNaN(revNum) && Number.isFinite(revNum)) ? (formatRevenue(revNum) || '\u2014') : '\u2014';
        return '<tr><td class="bs-product-col"><div class="product-cell">' + thumb + ' ' + name + '</div></td><td>' + clicks + '</td><td>' + revenue + '</td><td>' + conversion + '</td></tr>';
      }).join('');
    }

    function fetchBestVariants(options = {}) {
      const force = !!options.force;
      var shop = getShopParam() || shopForSalesFallback || null;
      if (!shop) {
        bestVariantsCache = null;
        renderBestVariants(null);
        return Promise.resolve(null);
      }
      setTbodyLoading('best-variants-body', 3);
      let url = API + '/api/shopify-best-variants?shop=' + encodeURIComponent(shop) +
          '&range=' + encodeURIComponent(dateRange) +
          '&page=' + encodeURIComponent(String(bestVariantsPage || 1)) +
          '&pageSize=' + encodeURIComponent(String(TOP_TABLE_PAGE_SIZE));
      if (force) url += '&_=' + Date.now();
      return fetch(url, { credentials: 'same-origin', cache: force ? 'no-store' : 'default' })
        .then(function(r) { return r.ok ? r.json() : null; })
        .then(function(data) {
          bestVariantsCache = data;
          renderBestVariants(data);
          return data;
        })
        .catch(function() { bestVariantsCache = null; renderBestVariants(null); return null; });
    }

    function renderBestVariants(data) {
      const tbody = document.getElementById('best-variants-body');
      if (!tbody) return;
      if (!data || !Array.isArray(data.bestVariants)) {
        tbody.innerHTML = '<tr><td colspan="3" class="empty">No shop or no data</td></tr>';
        updateCardPagination('best-variants', 1, 1);
        return;
      }
      const rows = data.bestVariants.slice();
      const pageSize = (data && typeof data.pageSize === 'number' && data.pageSize > 0) ? data.pageSize : TOP_TABLE_PAGE_SIZE;
      const totalCount = (data && typeof data.totalCount === 'number' && data.totalCount >= 0) ? data.totalCount : rows.length;
      const totalPages = Math.max(1, Math.ceil(totalCount / pageSize));
      bestVariantsPage = clampPage((data && typeof data.page === 'number') ? data.page : bestVariantsPage, totalPages);
      updateCardPagination('best-variants', bestVariantsPage, totalPages);
      if (rows.length === 0) {
        tbody.innerHTML = '<tr><td colspan="3" class="empty">No orders in this range</td></tr>';
        return;
      }
      tbody.innerHTML = rows.map(function(v) {
        const variantName = (v.variant_title && String(v.variant_title).trim()) ? String(v.variant_title).trim() : 'Default';
        const productName = (v.title && String(v.title).trim()) ? String(v.title).trim() : '';
        const displayName = variantName + (productName ? (' \u2014 ' + productName) : '');
        const thumbUrl = v.thumb_url ? (hotImg(String(v.thumb_url)) || String(v.thumb_url)) : null;
        const thumbImg = thumbUrl ? '<img class="bs-thumb" src="' + escapeHtml(thumbUrl) + '" alt=\"\" loading=\"lazy\">' : '<span class="bs-thumb bs-thumb-placeholder"></span>';
        const mainBase = getMainBaseUrl();
        const productUrl = (mainBase && v.handle) ? (mainBase + '/products/' + escapeHtml(v.handle) + (v.variant_id ? ('?variant=' + encodeURIComponent(String(v.variant_id))) : '')) : '';
        const thumb = productUrl ? '<a href="' + productUrl + '" target="_blank" rel="noopener">' + thumbImg + '</a>' : thumbImg;
        const name = '<span class="bs-name" title="' + escapeHtml(displayName) + '">' + escapeHtml(displayName) + '</span>';
        const orders = String(v.orders != null ? v.orders : 0);
        const revenue = formatRevenue(v.revenue);
        return '<tr><td class="bs-product-col"><div class="product-cell">' + thumb + ' ' + name + '</div></td><td>' + orders + '</td><td>' + revenue + '</td></tr>';
      }).join('');
    }

    function renderBestSellers(data) {
      const tbody = document.getElementById('best-sellers-body');
      if (!tbody) return;
      if (!data || !Array.isArray(data.bestSellers)) {
        tbody.innerHTML = '<tr><td colspan="4" class="empty">No shop or no data</td></tr>';
        updateBestSellersSortHeaders();
        updateCardPagination('best-sellers', 1, 1);
        return;
      }
      const rows = data.bestSellers.slice();
      const pageSize = (data && typeof data.pageSize === 'number' && data.pageSize > 0) ? data.pageSize : TOP_TABLE_PAGE_SIZE;
      const totalCount = (data && typeof data.totalCount === 'number' && data.totalCount >= 0) ? data.totalCount : rows.length;
      const totalPages = Math.max(1, Math.ceil(totalCount / pageSize));
      bestSellersPage = clampPage((data && typeof data.page === 'number') ? data.page : bestSellersPage, totalPages);
      updateCardPagination('best-sellers', bestSellersPage, totalPages);
      if (rows.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="empty">No orders in this range</td></tr>';
        updateBestSellersSortHeaders();
        return;
      }
      tbody.innerHTML = rows.map(function(p) {
        const thumbUrl = p.thumb_url ? (hotImg(String(p.thumb_url)) || String(p.thumb_url)) : null;
        const thumbImg = thumbUrl ? '<img class="bs-thumb" src="' + escapeHtml(thumbUrl) + '" alt="" loading="lazy">' : '<span class="bs-thumb bs-thumb-placeholder"></span>';
        const mainBase = getMainBaseUrl();
        const productUrl = (mainBase && p.handle) ? mainBase + '/products/' + escapeHtml(p.handle) : '';
        const thumb = productUrl ? '<a href="' + productUrl + '" target="_blank" rel="noopener">' + thumbImg + '</a>' : thumbImg;
        const name = '<span class="bs-name" title="' + escapeHtml(p.title) + '">' + escapeHtml(p.title) + '</span>';
        const orders = String(p.orders != null ? p.orders : 0);
        const revenue = formatRevenue(p.revenue);
        const cr = p.cr != null ? pct(p.cr) : '\u2014';
        return '<tr><td class="bs-product-col"><div class="product-cell">' + thumb + ' ' + name + '</div></td><td>' + orders + '</td><td>' + revenue + '</td><td>' + cr + '</td></tr>';
      }).join('');
      updateBestSellersSortHeaders();
    }

    function updateBestSellersSortHeaders() {
      document.querySelectorAll('#best-sellers-wrap th.sortable').forEach(function(th) {
        var col = th.getAttribute('data-sort');
        th.classList.remove('th-sort-asc', 'th-sort-desc');
        th.setAttribute('aria-sort', bestSellersSortBy === col ? (bestSellersSortDir === 'asc' ? 'ascending' : 'descending') : 'none');
        if (bestSellersSortBy === col) th.classList.add(bestSellersSortDir === 'asc' ? 'th-sort-asc' : 'th-sort-desc');
      });
    }

    function setupBestSellersSort() {
      document.querySelectorAll('#best-sellers-wrap th.sortable').forEach(function(th) {
        th.addEventListener('click', function() {
          var col = th.getAttribute('data-sort');
          if (bestSellersSortBy === col) bestSellersSortDir = bestSellersSortDir === 'asc' ? 'desc' : 'asc';
          else { bestSellersSortBy = col; bestSellersSortDir = col === 'rev' ? 'desc' : 'asc'; }
          bestSellersPage = 1;
          updateBestSellersSortHeaders();
          fetchBestSellers();
        });
      });
    }

    function formatSessions(n) {
      if (n == null || typeof n !== 'number') return '—';
      return n.toLocaleString();
    }

    function clampPage(p, totalPages) {
      const n = typeof p === 'number' ? p : parseInt(String(p), 10);
      if (!Number.isFinite(n)) return 1;
      return Math.min(Math.max(1, n), Math.max(1, totalPages || 1));
    }

    function updateCardPagination(prefix, page, totalPages) {
      const wrap = document.getElementById(prefix + '-pagination');
      const prev = document.getElementById(prefix + '-prev');
      const next = document.getElementById(prefix + '-next');
      const label = document.getElementById(prefix + '-label');
      if (!wrap || !prev || !next || !label) return;
      const pages = Math.max(1, totalPages || 1);
      const show = pages > 1;
      wrap.style.display = show ? 'flex' : 'none';
      prev.disabled = page <= 1;
      next.disabled = page >= pages;
      label.textContent = 'Page ' + page + ' of ' + pages;
    }

    function renderSales(data) {
      const sales = data.sales || {};
      const salesTodayEl = document.getElementById('sales-today');
      const baseSales = (sales[dateRange] != null ? sales[dateRange] : 0);
      const waitingForShopify = shouldWaitForShopifySalesToday();
      if (dateRange === 'today' && waitingForShopify) {
        if (shopifySalesToday != null) {
          if (salesTodayEl) salesTodayEl.textContent = formatRevenue(shopifySalesToday);
        } else if (!shopifySalesTodayLoaded) {
          // Avoid showing a misleading DB total first; wait for Shopify once on initial load.
          if (salesTodayEl) salesTodayEl.textContent = '\u2014';
        } else {
          // Shopify unavailable; fall back to DB.
          if (salesTodayEl) salesTodayEl.textContent = formatRevenue(baseSales);
        }
      } else {
        const mainSales = (dateRange === 'today' && shopifySalesToday != null) ? shopifySalesToday : baseSales;
        if (salesTodayEl) salesTodayEl.textContent = formatRevenue(mainSales);
      }
      const salesYesterdayEl = document.getElementById('sales-yesterday');
      if (salesYesterdayEl) salesYesterdayEl.textContent = formatRevenue(sales.yesterday);
    }

    function renderConversion(data) {
      const c = data.conversion || {};
      document.getElementById('conversion-range').textContent = pct(c[dateRange]);
      const productCr = (data.productConversion || {})[dateRange];
      const productCrEl = document.getElementById('conversion-product-cr');
      if (productCrEl) productCrEl.textContent = productCr != null ? pct(productCr) : '\u2014';
    }

    function renderSessions(data) {
      const breakdown = data && data.trafficBreakdown ? data.trafficBreakdown : {};
      const forRange = breakdown[dateRange];
      const forYesterday = breakdown.yesterday;
      const main = forRange != null ? forRange.human_sessions : null;
      const yesterday = forYesterday != null ? forYesterday.human_sessions : null;
      const sessionsRangeEl = document.getElementById('sessions-range');
      const sessionsYesterdayEl = document.getElementById('sessions-yesterday');
      if (sessionsRangeEl) sessionsRangeEl.textContent = formatSessions(main);
      if (sessionsYesterdayEl) sessionsYesterdayEl.textContent = formatSessions(yesterday);
    }

    function renderAov(data) {
      const rows = (data.country || {})[dateRange] || [];
      const tbody = document.getElementById('aov-by-country-body');
      if (!tbody) return;
      const filtered = rows.filter(r => r.aov != null && r.aov > 0);
      if (filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="2" class="empty">No data</td></tr>';
        updateCardPagination('aov', 1, 1);
        return;
      }
      const totalPages = Math.max(1, Math.ceil(filtered.length / TOP_TABLE_PAGE_SIZE));
      aovPage = clampPage(aovPage, totalPages);
      updateCardPagination('aov', aovPage, totalPages);
      const start = (aovPage - 1) * TOP_TABLE_PAGE_SIZE;
      const pageRows = filtered.slice(start, start + TOP_TABLE_PAGE_SIZE);
      tbody.innerHTML = pageRows.map(r => {
        const iso = (r.country_code || 'XX').toUpperCase().slice(0, 2);
        const code = iso.toLowerCase();
        const label = countryLabelFull(iso);
        const flag = '<img class="flag-img" src="' + hotImg('https://flagcdn.com/w40/' + code + '.png') + '" alt="' + escapeHtml(label) + '" title="' + escapeHtml(label) + '" loading="lazy">';
        const labelHtml = '<span class="country-label"><span class="country-name">' + escapeHtml(label) + '</span><span class="country-code">' + escapeHtml(iso) + '</span></span>';
        return '<tr><td>' + flag + labelHtml + '</td><td>' + formatRevenue(r.aov) + '</td></tr>';
      }).join('');
    }

    function renderCountry(data) {
      const c = data.country || {};
      const rows = c[dateRange] || [];
      const tbody = document.getElementById('by-country-body');
      if (!tbody) return;
      if (rows.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="empty">No data</td></tr>';
        updateCardPagination('country', 1, 1);
        return;
      }
      const totalPages = Math.max(1, Math.ceil(rows.length / TOP_TABLE_PAGE_SIZE));
      countryPage = clampPage(countryPage, totalPages);
      updateCardPagination('country', countryPage, totalPages);
      const start = (countryPage - 1) * TOP_TABLE_PAGE_SIZE;
      const pageRows = rows.slice(start, start + TOP_TABLE_PAGE_SIZE);
      tbody.innerHTML = pageRows.map(r => {
        const code = (r.country_code || 'XX').toUpperCase().slice(0, 2);
        const ccode = (r.country_code || 'xx').toLowerCase().slice(0, 2);
        const label = countryLabel(code);
        const conversion = pct(r.conversion);
        const salesCount = r.converted != null ? Number(r.converted) : 0;
        const clicks = r.total != null ? formatSessions(r.total) : '—';
        const revenue = formatRevenue(r.revenue);
        const flag = '<img class="flag-img" src="' + hotImg('https://flagcdn.com/w40/' + ccode + '.png') + '" alt="' + escapeHtml(label) + '" title="' + escapeHtml(label) + '" loading="lazy">';
        const labelHtml = '<span class="country-label"><span class="country-name">' + escapeHtml(label) + '</span><span class="country-code">' + escapeHtml(code) + '</span></span>';
        return '<tr><td>' + flag + labelHtml + '</td><td>' + conversion + '</td><td>' + salesCount + '</td><td>' + clicks + '</td><td>' + revenue + '</td></tr>';
      }).join('');
    }

    function updateLiveViewTitle() {
      const textEl = document.getElementById('table-title-text');
      const iconEl = document.getElementById('live-view-spy-icon');
      const sel = document.getElementById('global-date-select');
      let label = null;
      if (sel) {
        const opt = sel.querySelector('option[value="' + dateRange + '"]') || sel.options[sel.selectedIndex];
        label = opt && opt.textContent ? String(opt.textContent).trim() : null;
      }
      const fallback = { today: 'Today', yesterday: 'Yesterday', '3d': 'Last 3 Days', '7d': 'Last 7 Days' };
      if (textEl) textEl.textContent = label || fallback[dateRange] || 'Today';
      if (iconEl) iconEl.style.display = 'inline-flex';
    }

    function applyRangeAvailable(available) {
      const sel = document.getElementById('global-date-select');
      if (!sel) return;
      const opts = sel.querySelectorAll('option');
      const keys = ['today', 'yesterday', '3d', '7d'];
      keys.forEach((key, i) => {
        if (opts[i]) opts[i].disabled = !available[key];
      });
      if (!available[dateRange]) {
        dateRange = 'today';
        sel.value = 'today';
      }
      updateLiveViewTitle();
    }

    function renderStats(data) {
      const prevConverted = (statsCache.convertedCount || {}).today;
      statsCache = data || {};
      const conv = statsCache.convertedCount || {};
      if (typeof conv.today === 'number' && typeof lastConvertedCountToday === 'number' && conv.today > lastConvertedCountToday && !saleMuted && saleAudio) {
        saleAudio.currentTime = 0;
        saleAudio.play().catch(function() {});
      }
      lastConvertedCountToday = typeof conv.today === 'number' ? conv.today : 0;
      if (statsCache.rangeAvailable) applyRangeAvailable(statsCache.rangeAvailable);
      renderSales(statsCache);
      renderConversion(statsCache);
      renderSessions(statsCache);
      renderAov(statsCache);
      renderCountry(statsCache);
      renderLiveKpis(statsCache);
    }

    function renderLiveKpis(data) {
      const sales = data.sales || {};
      const breakdown = data.trafficBreakdown || {};
      const conv = data.conversion || {};
      const aovMap = data.aov || {};
      const bounceMap = data.bounce || {};
      const forRange = breakdown[dateRange];
      const sessionsVal = forRange != null && typeof forRange.human_sessions === 'number' ? forRange.human_sessions : null;
      let salesVal = sales[dateRange];
      if (dateRange === 'today' && typeof shopifySalesToday === 'number') salesVal = shopifySalesToday;
      const convVal = conv[dateRange];
      const aovVal = aovMap[dateRange];
      const bounceVal = bounceMap[dateRange];
      const salesEl = document.getElementById('live-kpi-sales');
      const sessionsEl = document.getElementById('live-kpi-sessions');
      const convEl = document.getElementById('live-kpi-conv');
      const aovEl = document.getElementById('live-kpi-aov');
      const bounceEl = document.getElementById('live-kpi-bounce');
      if (salesEl) salesEl.textContent = salesVal != null ? formatRevenue(salesVal) : '\u2014';
      if (sessionsEl) sessionsEl.textContent = formatSessions(sessionsVal);
      if (convEl) convEl.textContent = convVal != null ? pct(convVal) : '\u2014';
      if (aovEl) aovEl.textContent = aovVal != null ? formatRevenue(aovVal) : '\u2014';
      if (bounceEl) bounceEl.textContent = bounceVal != null ? pct(bounceVal) : '\u2014';
    }

    function setTbodyLoading(tbodyId, colSpan, label) {
      const tbody = document.getElementById(tbodyId);
      if (!tbody) return;
      const text = (label && String(label).trim()) ? String(label).trim() : 'Loading…';
      tbody.innerHTML = '<tr><td colspan="' + String(colSpan || 1) + '" class="empty"><span class="inline-spinner" aria-label="' + escapeHtml(text) + '"></span></td></tr>';
    }

    function fetchStatsData(options = {}) {
      const force = !!options.force;
      let url = API + '/api/stats';
      if (force) url += (url.indexOf('?') >= 0 ? '&' : '?') + '_=' + Date.now();
      const cacheMode = force ? 'no-store' : 'default';
      return fetch(url, { credentials: 'same-origin', cache: cacheMode })
        .then(function(r) {
          if (!r.ok) throw new Error('Stats HTTP ' + r.status);
          return r.json();
        })
        .then(function(data) {
          lastStatsFetchedAt = Date.now();
          lastUpdateTime = new Date();
          updateServerTimeDisplay();
          renderStats(data && typeof data.country === 'object' ? data : {});
          return data;
        })
        .catch(function(err) {
          console.error(err);
          renderStats(statsCache || {});
          return null;
        });
    }

    function refreshStats(options = {}) {
      const force = !!options.force;
      if (statsRefreshInFlight) return statsRefreshInFlight;

      var overlay = document.getElementById('stats-loading-overlay');
      if (overlay) overlay.style.display = 'flex';
      setTbodyLoading('by-country-body', 5);
      setTbodyLoading('aov-by-country-body', 2);
      setTbodyLoading('best-sellers-body', 4);
      setTbodyLoading('worst-products-body', 4);
      setTbodyLoading('best-variants-body', 3);

      // Start Shopify sales fetch early so Sales doesn't flash a DB value first.
      if (dateRange === 'today') fetchShopifySales();

      const tasks = [
        fetchStatsData({ force }),
        fetchBestSellers({ force }),
        fetchWorstProducts({ force }),
        fetchBestVariants({ force }),
      ];

      statsRefreshInFlight = Promise.allSettled(tasks)
        .finally(function() {
          statsRefreshInFlight = null;
          if (overlay) overlay.style.display = 'none';
        });
      return statsRefreshInFlight;
    }

    function sessionIdsEqual(a, b) {
      if (!a && !b) return true;
      if (!a || !b || a.length !== b.length) return false;
      for (var i = 0; i < a.length; i++) if (a[i].session_id !== b[i].session_id) return false;
      return true;
    }

    function fetchSessions() {
      if (liveRefreshInFlight) return liveRefreshInFlight;
      var overlay = document.getElementById('sessions-loading-overlay');
      if (overlay) overlay.style.display = 'flex';
      liveRefreshInFlight = fetch(API + '/api/sessions?filter=' + filter + '&_=' + Date.now(), { credentials: 'same-origin', cache: 'no-store' })
        .then(r => r.json())
        .then(data => {
          var next = data.sessions || [];
          next.sort(function(a, b) { return (b.last_seen || 0) - (a.last_seen || 0); });
          var listChanged = !sessionIdsEqual(sessions, next);
          sessions = next;
          if (listChanged) currentPage = 1;
          lastSessionsFetchedAt = Date.now();
          nextLiveAt = Date.now() + LIVE_REFRESH_MS;
          lastUpdateTime = new Date();
          updateServerTimeDisplay();
          renderTable();
          updateKpis();
          return next;
        })
        .catch(() => { sessions = []; currentPage = 1; renderTable(); return null; })
        .finally(function() {
          liveRefreshInFlight = null;
          if (overlay) overlay.style.display = 'none';
        });
      return liveRefreshInFlight;
    }

    function updateKpis() {
      const active = sessions.filter(s => s.last_seen >= Date.now() - 5 * 60 * 1000).length;
      const el = document.getElementById('online-count');
      if (el) el.textContent = active;
    }

    function openSidePanel(sessionId) {
      const panel = document.getElementById('side-panel');
      panel.style.display = 'block';
      document.getElementById('side-meta').textContent = 'Loading\u2026';
      const sideSourceEl = document.getElementById('side-source');
      if (sideSourceEl) sideSourceEl.textContent = '';
      document.getElementById('side-events').innerHTML = '';
      fetch(API + '/api/sessions/' + encodeURIComponent(sessionId) + '/events?limit=20')
        .then(r => r.json())
        .then(data => {
          const session = sessions.find(s => s.session_id === sessionId) || {};
          const saleBlock = session.has_purchased
            ? '<div class="side-panel-sale"><strong>Sale</strong><br>Order: ' + escapeHtml(formatMoney(session.order_total, session.order_currency) || '\u2014') + '<br>' + (session.purchased_at ? 'Purchased: ' + formatTs(session.purchased_at) + '<br>' : '') + '</div>'
            : '';
          document.getElementById('side-meta').innerHTML = `
            Session: ${escapeHtml(sessionId)}<br>
            Visitor: ${escapeHtml(session.visitor_id || '')}<br>
            Started: ${formatTs(session.started_at)}<br>
            Last seen: ${formatTs(session.last_seen)}<br>
            Cart qty: ${session.cart_qty ?? 0}<br>
            ${saleBlock}
            Events: ${(data.events || []).length}
          `;
          if (sideSourceEl) sideSourceEl.textContent = sourceDetailForPanel(session);
          const mainBase = getMainBaseUrl();
          const eventList = (data.events || []).filter(e => e.type !== 'heartbeat').reverse();
          const events = eventList.map(e => {
            var path = (e.path || '').trim();
            if (!path && e.product_handle) path = '/products/' + (e.product_handle || '');
            if (path && !path.startsWith('/')) path = '/' + path;
            var fullUrl = mainBase && path ? mainBase + path : '';
            var thumb = fullUrl ? '<span class="thumb-card"><img src="' + (API || '') + '/api/og-thumb?url=' + encodeURIComponent(fullUrl) + '" alt="" onerror="this.parentElement&&(this.parentElement.style.display=\'none\')"></span>' : '';
            var text = formatTs(e.ts) + ' ' + escapeHtml(e.type) + ' ' + escapeHtml(e.path || '') + ' ' + (e.product_handle || '') + (e.qty_delta != null ? ' \u0394' + e.qty_delta : '');
            return '<li>' + thumb + '<span>' + text + '</span></li>';
          }).join('');
          document.getElementById('side-events').innerHTML = events || '<li>No events</li>';
        })
        .catch(() => {
          document.getElementById('side-meta').textContent = 'Failed to load.';
        });
    }

    document.getElementById('side-close').addEventListener('click', () => {
      document.getElementById('side-panel').style.display = 'none';
    });

    document.getElementById('pagination-prev').addEventListener('click', function() {
      if (currentPage > 1) { currentPage--; renderTable(); }
    });
    document.getElementById('pagination-next').addEventListener('click', function() {
      const totalPages = Math.max(1, Math.ceil(getSortedSessions().length / rowsPerPage));
      if (currentPage < totalPages) { currentPage++; renderTable(); }
    });

    setupSortableHeaders();
    setupBestSellersSort();

    (function initTopTablePagination() {
      function bind(prefix, onPrev, onNext) {
        const prev = document.getElementById(prefix + '-prev');
        const next = document.getElementById(prefix + '-next');
        if (prev) prev.addEventListener('click', function() { onPrev(); });
        if (next) next.addEventListener('click', function() { onNext(); });
      }
      bind('country',
        function() { countryPage = Math.max(1, countryPage - 1); renderCountry(statsCache); },
        function() { countryPage = countryPage + 1; renderCountry(statsCache); }
      );
      bind('aov',
        function() { aovPage = Math.max(1, aovPage - 1); renderAov(statsCache); },
        function() { aovPage = aovPage + 1; renderAov(statsCache); }
      );
      bind('best-sellers',
        function() { bestSellersPage = Math.max(1, bestSellersPage - 1); fetchBestSellers(); },
        function() { bestSellersPage = bestSellersPage + 1; fetchBestSellers(); }
      );
      bind('worst-products',
        function() { worstProductsPage = Math.max(1, worstProductsPage - 1); fetchWorstProducts(); },
        function() { worstProductsPage = worstProductsPage + 1; fetchWorstProducts(); }
      );
      bind('best-variants',
        function() { bestVariantsPage = Math.max(1, bestVariantsPage - 1); fetchBestVariants(); },
        function() { bestVariantsPage = bestVariantsPage + 1; fetchBestVariants(); }
      );
    })();

    (function initRowsPerPageSelect() {
      const sel = document.getElementById('rows-per-page-select');
      if (!sel) return;
      sel.value = String(rowsPerPage);
      sel.addEventListener('change', function() {
        const n = parseInt(String(this.value), 10);
        if (ROWS_PER_PAGE_OPTIONS.indexOf(n) < 0) return;
        rowsPerPage = n;
        try { sessionStorage.setItem(ROWS_PER_PAGE_KEY, String(n)); } catch (_) {}
        currentPage = 1;
        renderTable();
        updateKpis();
      });
    })();

    function getConfigStatusUrl() {
      var url = API + '/api/config-status';
      try {
        var shop = getShopParam();
        if (!shop && typeof shopForSalesFallback === 'string' && shopForSalesFallback) shop = shopForSalesFallback;
        if (shop) url += (url.indexOf('?') >= 0 ? '&' : '?') + 'shop=' + encodeURIComponent(shop);
      } catch (_) {}
      return url;
    }

    function refreshConfigStatus() {
      const configStatusEl = document.getElementById('config-status');
      if (configStatusEl) configStatusEl.innerHTML = '<div class="config-row">Loading…</div>';

      return fetch(getConfigStatusUrl(), { credentials: 'same-origin', cache: 'no-store' })
        .then(r => r.json())
        .then(c => {
          function statusRow(ok, label) {
            return '<div class="config-row ' + (ok ? 'ok' : 'missing') + '">' + (ok ? 'OK' : 'MISSING') + ' ' + label + '</div>';
          }
          function valueRow(label, value) {
            return '<div class="config-row">' + escapeHtml(label) + ': ' + escapeHtml(value == null ? '' : String(value)) + '</div>';
          }
          function noteRow(text) {
            return '<div class="config-row" style="font-size:0.8rem;color:var(--muted);">' + escapeHtml(text) + '</div>';
          }
          function section(title) {
            return '<div class="config-row" style="margin-top:0.75rem;"><strong>' + escapeHtml(title) + '</strong></div>';
          }

          let html = '';
          html += section('Status');
          html += statusRow(!!c.shopify?.configured, 'Shopify API');
          html += statusRow(!!c.appUrl?.configured, 'App URL');
          html += statusRow(!!c.ingestSecret?.configured, 'Ingest secret');
          html += statusRow(!!c.db?.configured, 'DB (' + (c.db?.engine || 'unknown') + ')');
          html += statusRow(!!c.sentry?.configured, 'Sentry');

          html += section('Ingest');
          html += valueRow('Ingest URL', c.ingestUrl || '');
          if (c.ingestPublicUrl) html += valueRow('Ingest Public URL', c.ingestPublicUrl);
          html += valueRow('Tracking', 'ON (always)');
          if (c.sessionRetentionDays != null) html += valueRow('Session retention (days)', c.sessionRetentionDays);

          const h = c.health || null;
          if (h) {
            html += section('Today');
            if (h.timeZone) html += noteRow('Timezone: ' + h.timeZone);
            html += noteRow('Bots blocked at edge never reach the app/DB. Tagged bots are sessions that reached the app and were classified as bot.');

            if (typeof h.sessionsToday === 'number') html += valueRow('Sessions (total)', formatSessions(h.sessionsToday));
            if (typeof h.humanToday === 'number') html += valueRow('Human sessions (used)', formatSessions(h.humanToday));
            if (typeof h.botsToday === 'number') html += valueRow('Bot sessions tagged (reached app)', formatSessions(h.botsToday));
            if (typeof h.botsBlockedAtEdge === 'number') html += valueRow('Bot ingest calls blocked at edge', formatSessions(h.botsBlockedAtEdge));

            if (typeof h.shopifySessionsToday === 'number') {
              html += valueRow('Shopify sessions (today)', formatSessions(h.shopifySessionsToday));
              if (typeof h.humanToday === 'number') {
                html += valueRow('Shopify − ours (human)', formatSessions(h.shopifySessionsToday - h.humanToday));
              }
            } else {
              html += valueRow('Shopify sessions (today)', '\u2014');
              if (h.shopifySessionsTodayNote) html += noteRow(h.shopifySessionsTodayNote);
              if (h.storedScopes) html += noteRow('Stored scopes: ' + escapeHtml(h.storedScopes));
            }

            html += section('Health (last 24h)');
            if (h.sessions) {
              if (typeof h.sessions.purchasedLast24h === 'number') html += valueRow('Sessions marked purchased', formatSessions(h.sessions.purchasedLast24h));
              if (typeof h.sessions.max_last_seen === 'number') html += valueRow('Last session seen', formatTs(h.sessions.max_last_seen));
            }
            if (h.events && typeof h.events.checkoutCompletedLast24h === 'number') html += valueRow('checkout_completed events', formatSessions(h.events.checkoutCompletedLast24h));
            if (h.purchases) {
              if (typeof h.purchases.last24h === 'number') html += valueRow('Purchases rows', formatSessions(h.purchases.last24h));
              if (typeof h.purchases.max_purchased_at === 'number') html += valueRow('Last purchase', formatTs(h.purchases.max_purchased_at));
            }
            if (h.sessions && h.events && h.purchases && typeof h.events.checkoutCompletedLast24h === 'number' && typeof h.purchases.last24h === 'number') {
              if (h.events.checkoutCompletedLast24h > 0 && h.purchases.last24h === 0) {
                html += '<div class="config-row missing">We are seeing <code>checkout_completed</code> events but not inserting purchases rows. This will make conversion look too low.</div>';
              }
            }
          }

          if (c.db && c.db.engine === 'sqlite' && !c.db.configured) {
            html += '<div class="config-row missing">SQLite is in use (DB_URL not set). On Railway this can reset on deploy/restart → yesterday stats will be low.</div>';
          }

          const configStatusEl = document.getElementById('config-status');
          if (configStatusEl) configStatusEl.innerHTML = html;

          return c;
        })
        .catch(() => {
          const configStatusEl = document.getElementById('config-status');
          if (configStatusEl) configStatusEl.innerHTML = '<div class="config-row missing">Could not load config status.</div>';
        });
    }

    refreshConfigStatus();

    (function initConfigModal() {
      const modal = document.getElementById('config-modal');
      const openBtn = document.getElementById('config-open-btn');
      const closeBtn = document.getElementById('config-close-btn');
      if (!modal) return;
      function open() {
        try { refreshConfigStatus(); } catch (_) {}
        modal.classList.add('open');
        modal.setAttribute('aria-hidden', 'false');
      }
      function close() { modal.classList.remove('open'); modal.setAttribute('aria-hidden', 'true'); }
      if (openBtn) openBtn.addEventListener('click', open);
      if (closeBtn) closeBtn.addEventListener('click', close);
      modal.addEventListener('click', function(e) { if (e.target === modal) close(); });
      document.addEventListener('keydown', function(e) { if (e.key === 'Escape') close(); });
    })();

    (function initTopBar() {
      saleMuted = sessionStorage.getItem(SALE_MUTED_KEY) === 'true';
      saleAudio = new Audio(getAssetsBase() + '/cash-register.mp3');
      const muteBtn = document.getElementById('audio-mute-btn');
      const iconOn = muteBtn && muteBtn.querySelector('.sound-icon-on');
      const iconOff = muteBtn && muteBtn.querySelector('.sound-icon-off');
      if (muteBtn) {
        if (iconOn) iconOn.style.display = saleMuted ? 'none' : 'block';
        if (iconOff) iconOff.style.display = saleMuted ? 'block' : 'none';
        muteBtn.classList.toggle('muted', saleMuted);
        muteBtn.addEventListener('click', function() {
          saleMuted = !saleMuted;
          sessionStorage.setItem(SALE_MUTED_KEY, String(saleMuted));
          if (iconOn) iconOn.style.display = saleMuted ? 'none' : 'block';
          if (iconOff) iconOff.style.display = saleMuted ? 'block' : 'none';
          muteBtn.classList.toggle('muted', saleMuted);
        });
      }
      // Test sale sound: add ?cha=ching to the URL. Plays once when sound is on; if autoplay blocked, plays on first click.
      (function testChaChing() {
        if (new URLSearchParams(window.location.search).get('cha') !== 'ching' || !saleAudio) return;
        function playTest() {
          if (saleMuted) return;
          saleAudio.currentTime = 0;
          saleAudio.play().catch(function() {});
        }
        playTest();
        document.body.addEventListener('click', function once() {
          document.body.removeEventListener('click', once);
          playTest();
        }, { once: true });
      })();
      const dateSelect = document.getElementById('global-date-select');
      if (dateSelect) {
        dateSelect.value = dateRange;
        updateLiveViewTitle();
        dateSelect.addEventListener('change', function() {
          dateRange = this.value;
          if (dateRange !== 'today') shopifySalesToday = null;
          countryPage = 1;
          aovPage = 1;
          bestSellersPage = 1;
          worstProductsPage = 1;
          bestVariantsPage = 1;
          updateLiveViewTitle();
          bestSellersCache = null;
          worstProductsCache = null;
          bestVariantsCache = null;
          lastStatsFetchedAt = 0;
          updateNextUpdateUi();
          if (activeMainTab === 'stats') {
            refreshStats({ force: false });
          } else {
            if (dateRange === 'today') fetchSessions();
            fetchStatsData({ force: false });
          }
        });
      }
      (function initMainTabs() {
        const TAB_KEY = 'livevisitors-main-tab';
        const tabSpy = document.getElementById('tab-spy');
        const tabStats = document.getElementById('tab-stats');
        const panelSpy = document.getElementById('tab-panel-spy');
        const panelStats = document.getElementById('tab-panel-stats');
        function setTab(tab) {
          const isSpy = tab === 'spy';
          activeMainTab = tab;
          if (tabSpy) tabSpy.setAttribute('aria-selected', isSpy ? 'true' : 'false');
          if (tabStats) tabStats.setAttribute('aria-selected', isSpy ? 'false' : 'true');
          if (panelSpy) { panelSpy.classList.toggle('active', isSpy); panelSpy.style.display = isSpy ? '' : 'none'; }
          if (panelStats) { panelStats.classList.toggle('active', !isSpy); panelStats.style.display = isSpy ? 'none' : ''; }
          try { sessionStorage.setItem(TAB_KEY, tab); } catch (_) {}
          updateNextUpdateUi();
          if (tab === 'stats') {
            const stale = !lastStatsFetchedAt || (Date.now() - lastStatsFetchedAt) > STATS_REFRESH_MS;
            if (stale) refreshStats({ force: false });
            else renderStats(statsCache || {});
          } else {
            const staleSessions = !lastSessionsFetchedAt || (Date.now() - lastSessionsFetchedAt) > LIVE_REFRESH_MS;
            const staleStats = !lastStatsFetchedAt || (Date.now() - lastStatsFetchedAt) > STATS_REFRESH_MS;
            if (staleSessions) fetchSessions();
            if (staleStats) fetchStatsData({ force: false });
            else renderLiveKpis(statsCache || {});
          }
        }
        let initialTab = 'spy';
        try {
          const saved = sessionStorage.getItem(TAB_KEY);
          if (saved === 'stats' || saved === 'spy') initialTab = saved;
        } catch (_) {}
        setTab(initialTab);
        if (tabSpy) tabSpy.addEventListener('click', function() { setTab('spy'); });
        if (tabStats) tabStats.addEventListener('click', function() { setTab('stats'); });
      })();
      (function initRefreshBtn() {
        const btn = document.getElementById('refresh-btn');
        if (btn) {
          btn.addEventListener('click', function() {
            btn.classList.add('spinning');
            setTimeout(function() { btn.classList.remove('spinning'); }, 800);
            if (activeMainTab === 'stats') refreshStats({ force: true });
            else fetchSessions();
          });
        }
      })();
      updateServerTimeDisplay();
      updateNextUpdateUi();
      setInterval(function() {
        updateServerTimeDisplay();
        updateNextUpdateUi();
      }, 1000);
    })();

    (function setupStatsCardScrollHideHeader() {
      function onScroll(wrapId, cardId) {
        const wrap = document.getElementById(wrapId);
        const card = document.getElementById(cardId);
        if (!wrap || !card) return;
        function update() {
          card.classList.toggle('scrolled', wrap.scrollTop > 0);
        }
        wrap.addEventListener('scroll', update);
        update();
      }
      onScroll('country-table-wrap', 'stats-country');
      onScroll('best-sellers-wrap', 'stats-best-sellers');
      onScroll('worst-products-wrap', 'stats-worst-products');
      onScroll('best-variants-wrap', 'stats-best-variants');
    })();

    function onLiveAutoRefreshTick() {
      if (activeMainTab !== 'spy') return;
      if (dateRange !== 'today') return;
      if (document.visibilityState !== 'visible') return;
      fetchSessions();
    }

    function onStatsAutoRefreshTick() {
      if (activeMainTab !== 'stats') return;
      if (dateRange !== 'today') return;
      if (document.visibilityState !== 'visible') return;
      refreshStats({ force: false });
    }

    // Live updates: every 60s (Today only). Stats: every 15 minutes (Today only).
    setInterval(onLiveAutoRefreshTick, LIVE_REFRESH_MS);
    setInterval(onStatsAutoRefreshTick, STATS_REFRESH_MS);
    setInterval(tickTimeOnSite, 30000);

    document.addEventListener('visibilitychange', function() {
      if (document.visibilityState !== 'visible') return;
      updateNextUpdateUi();
      if (activeMainTab === 'stats') {
        const stale = !lastStatsFetchedAt || (Date.now() - lastStatsFetchedAt) > STATS_REFRESH_MS;
        if (stale) refreshStats({ force: false });
      } else {
        const stale = !lastSessionsFetchedAt || (Date.now() - lastSessionsFetchedAt) > LIVE_REFRESH_MS;
        if (stale) fetchSessions();
      }
    });

    const ACTIVE_WINDOW_MS = 5 * 60 * 1000;
    const es = new EventSource(API + '/api/stream');
    es.onmessage = (e) => {
      try {
        const msg = JSON.parse(e.data);
        if (msg.type === 'session_update' && msg.session) {
          const session = msg.session;
          const lastSeen = session.last_seen != null ? Number(session.last_seen) : 0;
          const withinActive = lastSeen >= Date.now() - ACTIVE_WINDOW_MS;
          const idx = sessions.findIndex(s => s.session_id === session.session_id);
          let becamePurchased = false;
          let needRender = false;
          if (idx >= 0) {
            if (!withinActive) {
              sessions.splice(idx, 1);
              needRender = true;
            } else {
              const wasPurchased = !!sessions[idx].has_purchased;
              const wasOrderTotal = sessions[idx].order_total != null;
              sessions[idx] = { ...sessions[idx], ...session };
              const nowPurchased = !!sessions[idx].has_purchased;
              const nowOrderTotal = sessions[idx].order_total != null;
              becamePurchased = (!wasPurchased && nowPurchased) || (nowPurchased && !wasOrderTotal && nowOrderTotal);
              sessions.sort(function(a, b) { return (b.last_seen || 0) - (a.last_seen || 0); });
              if (becamePurchased) needRender = true;
            }
          } else if (withinActive) {
            sessions.unshift(session);
            sessions.sort(function(a, b) { return (b.last_seen || 0) - (a.last_seen || 0); });
            becamePurchased = !!session.has_purchased;
            needRender = true;
          }
          if (needRender) {
            if (becamePurchased) {
              currentPage = 1;
              if (!saleMuted && saleAudio) {
                saleAudio.currentTime = 0;
                saleAudio.play().catch(function() {});
              }
            }
            renderTable();
            updateKpis();
          }
        }
      } catch (_) {}
    };
  </script>
</body>
</html>
