<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="robots" content="noindex, nofollow" />
  <title>Live Visitors</title>
  <style>
    /* Shopify-like: light grey bg, white cards, green accent */
    :root { --bg: #f6f6f7; --card: #fff; --text: #202223; --muted: #6d7175; --accent: #008060; --border: #e1e3e5; --border-focus: #008060; }
    * { box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 0; min-height: 100vh; }
    .header { display: flex; align-items: center; justify-content: space-between; padding: 1rem 1.25rem; background: var(--card); border-bottom: 1px solid var(--border); }
    .header h1 { margin: 0; font-size: 1.35rem; font-weight: 600; color: var(--text); }
    .header a { color: var(--muted); font-size: 0.9rem; text-decoration: none; }
    .header a:hover { color: var(--accent); }
    .header a:only-child { margin-left: auto; }
    .main { padding: 1rem 1.25rem; max-width: 1400px; margin: 0 auto; }
    h2 { margin: 0 0 0.75rem; font-size: 1rem; font-weight: 600; color: var(--muted); }
    .stats-row { display: flex; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap; align-items: flex-start; }
    .stats-card { background: var(--card); padding: 1rem 1.25rem; border-radius: 8px; border: 1px solid var(--border); flex: 1; min-width: 220px; }
    .stats-card h3 { margin: 0; font-size: 0.875rem; font-weight: 600; color: var(--muted); }
    .stats-card-header { display: flex; align-items: center; justify-content: space-between; gap: 0.5rem; margin-bottom: 0.35rem; }
    .stats-section { display: flex; flex-direction: column; gap: 0.35rem; }
    .stats-main { font-size: 1.5rem; font-weight: 600; color: var(--accent); }
    .stats-breakdown { font-size: 0.875rem; color: var(--text); display: flex; flex-wrap: wrap; gap: 0.6rem; }
    .stats-breakdown span { display: inline-block; }
    .stats-divider { height: 1px; background: var(--border); margin: 0.5rem 0; }
    .stats-select { padding: 0.2rem 0.4rem; border: 1px solid var(--border); border-radius: 6px; background: #fff; color: var(--text); font-size: 0.85rem; }
    .muted { color: var(--muted); font-size: 0.8rem; }
    .country-table-wrap { overflow-y: auto; }
    .by-country-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
    .by-country-table th, .by-country-table td { padding: 0.35rem 0; border-bottom: 1px solid var(--border); }
    .by-country-table th { font-size: 0.75rem; color: var(--muted); font-weight: 600; text-transform: uppercase; letter-spacing: 0.03em; }
    .by-country-table tbody td:first-child { display: flex; align-items: center; gap: 0.5rem; }
    .by-country-table .flag-img { width: 24px; height: 18px; object-fit: cover; border-radius: 2px; }
    .kpis { display: flex; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap; }
    .kpi { background: var(--card); padding: 0.75rem 1rem; border-radius: 8px; border: 1px solid var(--border); }
    .kpi strong { display: block; font-size: 1.25rem; color: var(--accent); }
    .kpi span { font-size: 0.85rem; color: var(--muted); }
    .tabs { display: flex; gap: 0.25rem; margin-bottom: 1rem; }
    .tabs button { padding: 0.5rem 1rem; background: var(--card); border: 1px solid var(--border); color: var(--text); border-radius: 6px; cursor: pointer; }
    .tabs button:hover { border-color: var(--muted); }
    .tabs button.active { background: var(--accent); color: #fff; border-color: var(--accent); }
    .config-toggle { margin-bottom: 0.5rem; font-size: 0.9rem; color: var(--muted); }
    .config-toggle input { margin-right: 0.35rem; }
    .config-panel { background: var(--card); padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid var(--border); }
    .config-panel.hidden { display: none; }
    .config-panel h3 { margin: 0 0 0.5rem; font-size: 0.95rem; }
    .config-row { display: flex; align-items: center; gap: 0.5rem; margin: 0.25rem 0; font-size: 0.9rem; }
    .config-row.ok { color: #008060; }
    .config-row.missing { color: #d72c0d; }
    .tracking-toggle { margin-top: 0.5rem; }
    .tracking-toggle button { padding: 0.4rem 0.8rem; background: var(--accent); color: #fff; border: none; border-radius: 6px; cursor: pointer; }
    .tracking-toggle button.off { background: var(--muted); }
    .coverage-note { font-size: 0.8rem; color: var(--muted); margin-top: 0.5rem; }
    table { width: 100%; border-collapse: collapse; background: var(--card); border-radius: 8px; overflow: hidden; border: 1px solid var(--border); }
    th, td { padding: 0.5rem 0.75rem; text-align: left; border-bottom: 1px solid var(--border); vertical-align: middle; }
    th { background: #f9fafb; font-size: 0.8rem; color: var(--muted); font-weight: 600; }
    th:first-child, td:first-child { min-width: 120px; padding-left: 0.75rem; }
    tr:hover { background: #f9fafb; }
    tr.returning { background: rgba(0, 128, 96, 0.06); }
    tr.clickable { cursor: pointer; }
    .flag-cell { white-space: nowrap; }
    .flag-img { width: 24px; height: 18px; object-fit: cover; border-radius: 2px; margin-right: 0.25rem; vertical-align: middle; display: inline-block; }
    .purchase-icon { display: inline-flex; align-items: center; justify-content: center; color: #008060; width: 20px; height: 20px; margin-left: 0.25rem; vertical-align: middle; }
    .purchase-icon svg { width: 100%; height: 100%; }
    .table-title { font-size: 1rem; font-weight: 600; color: var(--text); margin-bottom: 0.5rem; }
    .time-filters { display: flex; gap: 0.5rem; margin-bottom: 0.75rem; }
    .time-filters button { padding: 0.35rem 0.75rem; font-size: 0.85rem; background: transparent; border: 1px solid var(--border); color: var(--muted); border-radius: 6px; cursor: pointer; }
    .time-filters button.active { background: var(--accent); color: #fff; border-color: var(--accent); }
    tr:nth-child(even) { background: #fafbfc; }
    tr:nth-child(even):hover { background: #f1f3f4; }
    .badge { display: inline-block; padding: 0.15rem 0.4rem; border-radius: 4px; font-size: 0.75rem; }
    .badge.new { background: #008060; color: #fff; }
    .badge.returning { background: #5c6ac4; color: #fff; }
    .chip { display: inline-block; padding: 0.1rem 0.35rem; border-radius: 4px; font-size: 0.7rem; margin-right: 0.25rem; }
    .chip.checking-out { background: #008060; color: #fff; }
    .chip.abandoned { background: #d72c0d; color: #fff; }
    .side-panel { position: fixed; top: 0; right: 0; width: 400px; max-width: 100%; height: 100%; background: var(--card); border-left: 1px solid var(--border); box-shadow: -4px 0 20px rgba(0,0,0,0.1); overflow-y: auto; z-index: 10; padding: 1rem; }
    .side-panel h3 { margin: 0 0 0.5rem; }
    .side-panel .close { float: right; cursor: pointer; font-size: 1.2rem; color: var(--muted); }
    .side-panel .meta { font-size: 0.85rem; color: var(--muted); margin: 0.5rem 0; }
    .side-panel ul.events { list-style: none; padding: 0; margin: 0.5rem 0; font-size: 0.85rem; }
    .side-panel ul.events li { padding: 0.35rem 0; border-bottom: 1px solid var(--border); }
    .empty { text-align: center; padding: 2rem; color: var(--muted); }
    .consent-debug { font-size: 0.75rem; color: var(--muted); max-width: 200px; overflow: hidden; text-overflow: ellipsis; }
  </style>
</head>
<body>
  <header class="header">
    <a href="/app/logout">Sign out</a>
  </header>

  <main class="main">
  <div class="config-toggle">
    <label><input type="checkbox" id="hide-config" checked> Hide config status</label>
  </div>
  <section class="config-panel hidden" id="config-panel">
    <h3>Config status</h3>
    <div id="config-status">Loading…</div>
    <div class="tracking-toggle">
      <button type="button" id="tracking-btn">Loading…</button>
      <span id="tracking-label"></span>
    </div>
    <div class="coverage-note">Coverage depends on customer privacy settings. Use “Consent (debug)” to verify if tracking is gated.</div>
  </section>

  <div class="stats-row">
    <div class="stats-card" id="stats-primary">
      <div class="stats-section">
        <div class="stats-card-header">
          <h3>Sales</h3>
          <span class="muted">Today (midnight UK)</span>
        </div>
        <div class="stats-main" id="sales-today"></div>
        <div class="stats-breakdown">
          <span>6hr: <strong id="sales-6h"></strong></span>
          <span>12hr: <strong id="sales-12h"></strong></span>
          <span>24hr: <strong id="sales-24h"></strong></span>
          <span>week: <strong id="sales-week"></strong></span>
        </div>
      </div>
      <div class="stats-divider"></div>
      <div class="stats-section">
        <div class="stats-card-header">
          <h3>Conversion rate</h3>
          <select id="conversion-range-select" class="stats-select" aria-label="Conversion range"></select>
        </div>
        <div class="stats-main" id="conversion-range"></div>
        <div class="stats-breakdown">
          <span>3hr: <strong id="conversion-3h"></strong></span>
          <span>6hr: <strong id="conversion-6h"></strong></span>
          <span>12hr: <strong id="conversion-12h"></strong></span>
          <span>24hr: <strong id="conversion-24h"></strong></span>
        </div>
      </div>
    </div>
    <div class="stats-card" id="stats-country">
      <div class="stats-card-header">
        <h3>Country</h3>
        <select id="country-range-select" class="stats-select" aria-label="Country range"></select>
      </div>
      <div class="country-table-wrap" id="country-table-wrap">
        <table class="by-country-table">
          <thead>
            <tr>
              <th>GEO</th>
              <th>CR</th>
              <th>Sales</th>
            </tr>
          </thead>
          <tbody id="by-country-body">
            <tr><td colspan="3" class="empty">Loading…</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="kpis">
    <div class="kpi"><strong id="kpi-revenue-today"></strong><span>Sales today (UK)</span></div>
    <div class="kpi"><strong id="kpi-active">0</strong><span>Active now (5 min)</span></div>
    <div class="kpi"><strong id="kpi-abandoned">0</strong><span>Abandoned (24h)</span></div>
  </div>

  <div class="tabs">
    <button type="button" data-filter="active">Online</button>
    <button type="button" data-filter="recent" class="active">Recently Online</button>
    <button type="button" data-filter="converted">Recent Orders</button>
    <button type="button" data-filter="abandoned">Abandoned Carts</button>
    <button type="button" data-filter="today">Today (24h)</button>
    <button type="button" data-filter="all">Last hour</button>
  </div>

  <div class="table-title" id="table-title">Recently Online</div>
  <div class="time-filters">
    <button type="button" id="time-hour" data-time="all">last hour</button>
    <button type="button" id="time-24h" data-time="today" class="active">last 24 hours</button>
  </div>

  <table>
    <thead>
      <tr>
        <th>From</th>
        <th>Device</th>
        <th>History</th>
        <th>Arrived</th>
        <th>Source</th>
        <th>Last action</th>
        <th>Cart value</th>
        <th class="consent-col" style="display:none">Consent (debug)</th>
      </tr>
    </thead>
    <tbody id="table-body"></tbody>
  </table>

  <div id="side-panel" class="side-panel" style="display:none">
    <span class="close" id="side-close">&times;</span>
    <h3>Session</h3>
    <div class="meta" id="side-meta"></div>
    <h4>Last 20 events</h4>
    <ul class="events" id="side-events"></ul>
  </div>
  </main>

  <script>
    const API = '';
    const HIDE_CONFIG_KEY = 'livevisitors-hide-config';
    const RANGE_OPTIONS = [
      { value: 'today', label: 'Today' },
      { value: 'yesterday', label: 'Yesterday' },
      { value: '3d', label: '3 days' },
      { value: '7d', label: '7 days' },
    ];
    let sessions = [];
    let statsCache = {};
    let conversionRange = 'today';
    let countryRange = 'today';

    // Auto-configure pixel when opened from Shopify (shop in URL) so merchants don't run mutations manually
    (function ensurePixelOnce() {
      const params = new URLSearchParams(window.location.search);
      const shop = params.get('shop');
      if (shop && /\.myshopify\.com$/i.test(shop)) {
        fetch(API + '/api/pixel/ensure?shop=' + encodeURIComponent(shop), { credentials: 'same-origin' })
          .then(function (r) { return r.json(); })
          .then(function (data) {
            if (data.ok && data.action) console.log('[Live Visitors] Pixel', data.action);
          })
          .catch(function () {});
      }
    })();
    let filter = 'recent';
    let selectedSessionId = null;
    let timeTick = null;
    const tz = 'Europe/London';

    function formatTs(ms) {
      if (!ms) return '';
      const d = new Date(ms);
      return d.toLocaleString('en-GB', { timeZone: tz, dateStyle: 'short', timeStyle: 'short' });
    }

    function formatRelative(ms) {
      if (!ms) return '';
      const s = Math.floor((Date.now() - ms) / 1000);
      if (s < 60) return s + 's ago';
      if (s < 3600) return Math.floor(s / 60) + 'm ago';
      return Math.floor(s / 3600) + 'h ago';
    }

    function formatDuration(startMs) {
      if (!startMs) return '';
      const s = Math.floor((Date.now() - startMs) / 1000);
      const m = Math.floor(s / 60);
      const h = Math.floor(m / 60);
      if (h > 0) return h + 'h ' + (m % 60) + 'm';
      if (m > 0) return m + 'm ' + (s % 60) + 's';
      return s + 's';
    }

    var countryNames = { GB: 'United Kingdom', US: 'United States', CA: 'Canada', AU: 'Australia', DE: 'Germany', FR: 'France', IE: 'Ireland', ES: 'Spain', IT: 'Italy', NL: 'Netherlands', IN: 'India', JP: 'Japan', DK: 'Denmark', SE: 'Sweden', NO: 'Norway', TH: 'Thailand', NZ: 'New Zealand', XX: 'Unknown' };

    function countryLabel(code) {
      if (!code || code === 'XX') return 'Unknown';
      var c = (code || 'XX').toUpperCase().slice(0, 2);
      return countryNames[c] || c;
    }

    function flagImg(code) {
      if (!code || code === 'XX') return '<img class="flag-img" src="https://flagcdn.com/w40/xx.png" alt="?" loading="lazy">';
      const c = (code || 'xx').toLowerCase().slice(0, 2);
      return '<img class="flag-img" src="https://flagcdn.com/w40/' + escapeHtml(c) + '.png" alt="' + escapeHtml(code) + '" loading="lazy">';
    }

    function purchaseIconSvg() {
      return '<span class="purchase-icon" title="Purchased"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 2L3 6v14a2 2 0 002 2h14a2 2 0 002-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/><path d="M16 10a4 4 0 01-8 0"/></svg></span>';
    }

    function arrivedAgo(startedAt) {
      if (!startedAt) return '';
      var s = Math.floor((Date.now() - startedAt) / 1000);
      if (s < 60) return s + ' secs ago';
      if (s < 3600) return Math.floor(s / 60) + ' mins ago';
      if (s < 86400) return Math.floor(s / 3600) + ' hrs ago';
      return Math.floor(s / 86400) + ' days ago';
    }

    function lastAction(s) {
      if (s.is_checking_out) return 'In checkout process';
      if (s.last_product_handle) return 'Viewed ' + escapeHtml(s.last_product_handle);
      if (s.last_path) return 'Viewed page ' + escapeHtml(s.last_path);
      return '';
    }

    function formatMoney(amount, currencyCode) {
      if (amount == null || typeof amount !== 'number') return '';
      const code = (currencyCode || 'GBP').toUpperCase();
      const sym = code === 'GBP' ? '£' : code === 'USD' ? '$' : code === 'EUR' ? '€' : code + ' ';
      return sym + (amount % 1 === 0 ? amount : amount.toFixed(2));
    }

    function sourceLabel(s) {
      const v = s.utm_campaign && String(s.utm_campaign).trim();
      return v ? escapeHtml(v) : 'Direct';
    }

    function renderRow(s) {
      const countryCode = s.country_code || 'XX';
      const visits = (s.returning_count != null ? s.returning_count : 0) + 1;
      const visitsLabel = visits === 1 ? '1 visit' : visits + ' visits';
      const cartVal = (s.cart_value != null && typeof s.cart_value === 'number')
        ? formatMoney(s.cart_value, s.cart_currency)
        : (s.cart_qty > 0 ? (s.cart_qty + ' item' + (s.cart_qty !== 1 ? 's' : '')) : '');
      const fromCell = flagImg(countryCode) + ' ' + escapeHtml(countryLabel(countryCode)) + (s.has_purchased ? ' ' + purchaseIconSvg() : '');
      const consentDebug = s.meta_json ? (JSON.parse(s.meta_json || '{}').customer_privacy_debug ? 'yes' : '') : '';
      return `<tr class="clickable ${s.is_returning ? 'returning' : ''}" data-session-id="${s.session_id}">
        <td class="flag-cell">${fromCell}</td>
        <td>${escapeHtml(s.device || '')}</td>
        <td>${visitsLabel}</td>
        <td data-started="${s.started_at}">${arrivedAgo(s.started_at)}</td>
        <td>${sourceLabel(s)}</td>
        <td>${lastAction(s)}</td>
        <td>${cartVal}</td>
        <td class="consent-debug consent-col" style="display:none">${escapeHtml(consentDebug)}</td>
      </tr>`;
    }

    function escapeHtml(str) {
      if (str == null) return '';
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    function renderTable() {
      const tbody = document.getElementById('table-body');
      const showConsent = document.querySelector('.consent-col');
      if (sessions.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="empty">No sessions in this view.</td></tr>';
        return;
      }
      tbody.innerHTML = sessions.map(renderRow).join('');
      document.querySelectorAll('#table-body tr.clickable').forEach(tr => {
        tr.addEventListener('click', () => {
          selectedSessionId = tr.dataset.sessionId;
          openSidePanel(selectedSessionId);
        });
      });
      tickTimeOnSite();
    }

    var tableTitles = { active: 'Online', recent: 'Recently Online', converted: 'Recent Orders', abandoned: 'Abandoned Carts', today: 'Today (24h)', all: 'Last hour' };
    function setTableTitle() {
      var el = document.getElementById('table-title');
      if (el) el.textContent = tableTitles[filter] || 'Sessions';
    }

    function tickTimeOnSite() {
      document.querySelectorAll('#table-body td[data-started]').forEach(td => {
        const started = parseInt(td.dataset.started, 10);
        td.textContent = arrivedAgo(started);
      });
    }

    function pct(v) { return v != null ? v.toFixed(1) + '%' : ''; }

    function initRangeSelect(selectId, value, onChange) {
      const el = document.getElementById(selectId);
      if (!el) return;
      el.innerHTML = RANGE_OPTIONS.map(opt => '<option value="' + opt.value + '">' + opt.label + '</option>').join('');
      el.value = value;
      el.addEventListener('change', () => onChange(el.value));
    }

    function formatRevenue(num) {
      if (num == null || typeof num !== 'number') return '';
      return '£' + (num % 1 === 0 ? num : num.toFixed(2));
    }

    function renderSales(data) {
      const sales = data.sales || {};
      document.getElementById('sales-today').textContent = formatRevenue(sales.today);
      const rolling = sales.rolling || {};
      document.getElementById('sales-6h').textContent = formatRevenue(rolling['6h']);
      document.getElementById('sales-12h').textContent = formatRevenue(rolling['12h']);
      document.getElementById('sales-24h').textContent = formatRevenue(rolling['24h']);
      document.getElementById('sales-week').textContent = formatRevenue(rolling['7d']);
      const revEl = document.getElementById('kpi-revenue-today');
      if (revEl) revEl.textContent = formatRevenue(sales.today);
    }

    function renderConversion(data) {
      const c = data.conversion || {};
      document.getElementById('conversion-range').textContent = pct(c[conversionRange]);
      const rolling = c.rolling || {};
      document.getElementById('conversion-3h').textContent = pct(rolling['3h']);
      document.getElementById('conversion-6h').textContent = pct(rolling['6h']);
      document.getElementById('conversion-12h').textContent = pct(rolling['12h']);
      document.getElementById('conversion-24h').textContent = pct(rolling['24h']);
    }

    function renderCountry(data) {
      const c = data.country || {};
      const rows = c[countryRange] || [];
      const tbody = document.getElementById('by-country-body');
      if (!tbody) return;
      if (rows.length === 0) {
        tbody.innerHTML = '<tr><td colspan="3" class="empty">No data</td></tr>';
        return;
      }
      tbody.innerHTML = rows.map(r => {
        const code = (r.country_code || 'XX').toUpperCase();
        const ccode = (r.country_code || 'xx').toLowerCase().slice(0, 2);
        const label = countryLabel(code);
        const conversion = pct(r.conversion);
        const revenue = formatRevenue(r.revenue);
        return '<tr><td><img class="flag-img" src="https://flagcdn.com/w40/' + ccode + '.png" alt="' + escapeHtml(code) + '" loading="lazy"> ' + escapeHtml(label) + '</td><td>' + conversion + '</td><td>' + revenue + '</td></tr>';
      }).join('');
    }

    function syncCountryTableHeight() {
      const primary = document.getElementById('stats-primary');
      const country = document.getElementById('stats-country');
      const wrap = document.getElementById('country-table-wrap');
      if (!primary || !country || !wrap) return;
      const primaryHeight = primary.getBoundingClientRect().height;
      const header = country.querySelector('.stats-card-header');
      const headerHeight = header ? header.getBoundingClientRect().height : 0;
      const styles = window.getComputedStyle(country);
      const paddingTop = parseFloat(styles.paddingTop) || 0;
      const paddingBottom = parseFloat(styles.paddingBottom) || 0;
      const available = primaryHeight - headerHeight - paddingTop - paddingBottom;
      if (available > 120) {
        wrap.style.maxHeight = Math.floor(available) + 'px';
      }
    }

    function renderStats(data) {
      statsCache = data || {};
      renderSales(statsCache);
      renderConversion(statsCache);
      renderCountry(statsCache);
      requestAnimationFrame(syncCountryTableHeight);
    }

    function fetchStats() {
      fetch(API + '/api/stats', { credentials: 'same-origin' })
        .then(r => r.json())
        .then(renderStats)
        .catch(() => renderStats({}));
    }

    function fetchSessions() {
      setTableTitle();
      fetch(API + '/api/sessions?filter=' + filter)
        .then(r => r.json())
        .then(data => {
          sessions = data.sessions || [];
          renderTable();
          updateKpis();
          updateTabCounts();
        })
        .catch(() => { sessions = []; renderTable(); });
    }

    function updateTabCounts() {
      var n = sessions.length;
      var suffix = n > 99 ? ' 99+' : (n > 0 ? ' ' + n : '');
      document.querySelectorAll('.tabs button[data-filter]').forEach(function(btn) {
        var f = btn.dataset.filter;
        var label = { active: 'Online', recent: 'Recently Online', converted: 'Recent Orders', abandoned: 'Abandoned Carts', today: 'Today (24h)', all: 'Last hour' }[f] || f;
        btn.textContent = label + (btn.classList.contains('active') ? suffix : '');
      });
    }

    function updateKpis() {
      const active = sessions.filter(s => s.last_seen >= Date.now() - 5 * 60 * 1000).length;
      fetch(API + '/api/sessions?filter=abandoned')
        .then(r => r.json())
        .then(data => {
          const abandoned = (data.sessions || []).length;
          document.getElementById('kpi-active').textContent = active;
          document.getElementById('kpi-abandoned').textContent = abandoned;
        })
        .catch(() => {
          document.getElementById('kpi-active').textContent = sessions.length;
        });
    }

    function openSidePanel(sessionId) {
      const panel = document.getElementById('side-panel');
      panel.style.display = 'block';
      document.getElementById('side-meta').textContent = 'Loading…';
      document.getElementById('side-events').innerHTML = '';
      fetch(API + '/api/sessions/' + encodeURIComponent(sessionId) + '/events?limit=20')
        .then(r => r.json())
        .then(data => {
          const session = sessions.find(s => s.session_id === sessionId) || {};
          document.getElementById('side-meta').innerHTML = `
            Session: ${escapeHtml(sessionId)}<br>
            Visitor: ${escapeHtml(session.visitor_id || '')}<br>
            Started: ${formatTs(session.started_at)}<br>
            Last seen: ${formatTs(session.last_seen)}<br>
            Cart qty: ${session.cart_qty ?? 0}<br>
            Events: ${(data.events || []).length}
          `;
          const events = (data.events || []).map(e => `<li>${formatTs(e.ts)} ${escapeHtml(e.type)} ${escapeHtml(e.path || '')} ${e.product_handle || ''} ${e.qty_delta != null ? 'Δ' + e.qty_delta : ''}</li>`).join('');
          document.getElementById('side-events').innerHTML = events || '<li>No events</li>';
        })
        .catch(() => {
          document.getElementById('side-meta').textContent = 'Failed to load.';
        });
    }

    document.getElementById('side-close').addEventListener('click', () => {
      document.getElementById('side-panel').style.display = 'none';
    });

    (function initConfigToggle() {
      const cb = document.getElementById('hide-config');
      const panel = document.getElementById('config-panel');
      const stored = localStorage.getItem(HIDE_CONFIG_KEY);
      const hideByDefault = stored === null || stored === 'true';
      cb.checked = hideByDefault;
      panel.classList.toggle('hidden', hideByDefault);
      cb.addEventListener('change', () => {
        const hide = cb.checked;
        localStorage.setItem(HIDE_CONFIG_KEY, String(hide));
        panel.classList.toggle('hidden', hide);
      });
    })();

    document.querySelectorAll('.tabs button[data-filter]').forEach(btn => {
      btn.addEventListener('click', () => {
        filter = btn.dataset.filter;
        document.querySelectorAll('.tabs button[data-filter]').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById('time-hour').classList.toggle('active', filter === 'all');
        document.getElementById('time-24h').classList.toggle('active', filter === 'today');
        fetchSessions();
      });
    });

    document.getElementById('time-hour').addEventListener('click', function() {
      filter = 'all';
      document.querySelectorAll('.tabs button[data-filter]').forEach(b => { b.classList.remove('active'); if (b.dataset.filter === 'all') b.classList.add('active'); });
      this.classList.add('active');
      document.getElementById('time-24h').classList.remove('active');
      fetchSessions();
    });
    document.getElementById('time-24h').addEventListener('click', function() {
      filter = 'today';
      document.querySelectorAll('.tabs button[data-filter]').forEach(b => { b.classList.remove('active'); if (b.dataset.filter === 'today') b.classList.add('active'); });
      this.classList.add('active');
      document.getElementById('time-hour').classList.remove('active');
      fetchSessions();
    });

    document.getElementById('tracking-btn').addEventListener('click', () => {
      const enabled = document.getElementById('tracking-btn').classList.contains('off');
      fetch(API + '/api/settings/tracking', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ enabled }),
      })
        .then(r => r.json())
        .then(data => {
          document.getElementById('tracking-btn').textContent = data.enabled ? 'Tracking ON' : 'Tracking OFF';
          document.getElementById('tracking-btn').classList.toggle('off', !data.enabled);
          document.getElementById('tracking-label').textContent = data.enabled ? 'Tracking is on.' : 'Tracking is off (ingest returns 204).';
        })
        .catch(() => {});
    });

    fetch(API + '/api/config-status')
      .then(r => r.json())
      .then(c => {
        let html = '';
        html += '<div class="config-row ' + (c.shopify?.configured ? 'ok' : 'missing') + '">' + (c.shopify?.configured ? '✅' : '❌') + ' Shopify API</div>';
        html += '<div class="config-row ' + (c.appUrl?.configured ? 'ok' : 'missing') + '">' + (c.appUrl?.configured ? '✅' : '❌') + ' App URL</div>';
        html += '<div class="config-row ' + (c.ingestSecret?.configured ? 'ok' : 'missing') + '">' + (c.ingestSecret?.configured ? '✅' : '❌') + ' Ingest secret</div>';
        html += '<div class="config-row">Ingest URL: ' + escapeHtml(c.ingestUrl || '') + '</div>';
        html += '<div class="config-row">Tracking: ' + (c.trackingEnabled ? 'ON' : 'OFF') + '</div>';
        html += '<div class="config-row ' + (c.sentry?.configured ? 'ok' : 'missing') + '">' + (c.sentry?.configured ? '✅' : '❌') + ' Sentry</div>';
        document.getElementById('config-status').innerHTML = html;
        document.getElementById('tracking-btn').textContent = c.trackingEnabled ? 'Tracking ON' : 'Tracking OFF';
        document.getElementById('tracking-btn').classList.toggle('off', !c.trackingEnabled);
        document.getElementById('tracking-label').textContent = c.trackingEnabled ? 'Tracking is on.' : 'Tracking is off.';
      })
      .catch(() => {
        document.getElementById('config-status').innerHTML = '<div class="config-row missing">Could not load config status.</div>';
      });

    (function initRangeSelects() {
      initRangeSelect('conversion-range-select', conversionRange, (value) => {
        conversionRange = value;
        renderConversion(statsCache);
      });
      initRangeSelect('country-range-select', countryRange, (value) => {
        countryRange = value;
        renderCountry(statsCache);
        requestAnimationFrame(syncCountryTableHeight);
      });
    })();
    window.addEventListener('resize', syncCountryTableHeight);

    fetchStats();
    fetchSessions();
    setInterval(fetchStats, 15000);
    setInterval(fetchSessions, 15000);
    setInterval(tickTimeOnSite, 30000);

    const es = new EventSource(API + '/api/stream');
    es.onmessage = (e) => {
      try {
        const msg = JSON.parse(e.data);
        if (msg.type === 'session_update' && msg.session) {
          const idx = sessions.findIndex(s => s.session_id === msg.session.session_id);
          if (idx >= 0) sessions[idx] = { ...sessions[idx], ...msg.session };
          else sessions.unshift(msg.session);
          renderTable();
          updateKpis();
        }
      } catch (_) {}
    };
  </script>
</body>
</html>
