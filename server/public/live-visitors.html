<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="robots" content="noindex, nofollow" />
  <link rel="icon" type="image/png" href="https://cdn.shopify.com/s/files/1/0847/7261/8587/files/spyview_favicon.png?v=1770086377" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <title>Liveview</title>
  <style>
    :root {
      --bg: #fafafa;
      --card: #fff;
      --text: #333;
      --muted: #333;
      --accent: #0d9488;
      --border: #e1e1e1;
      --shadow: 0 1px 3px rgba(0, 0, 0, .06);
      --radius: 3px;
      --th-bg: #f5f5f5;
      --row-hover: #f5f5f5;
      --converted-bg: #faf9f2;
      --converted-hover: #faf9f2;
      --returning-bg: #fff;
      --badge-new-fg: #fff;
      --badge-returning: #6366f1;
      --chip-abandoned: #dc2626;
      --side-panel-shadow: -4px 0 24px rgba(0, 0, 0, .08);
      --side-panel-sale-bg: rgba(13, 148, 136, 0.08);
      --button-hover-bg: #f5f5f5;
      --select-arrow: #333;
    }
    * { box-sizing: border-box; }
    body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 0; min-height: 100vh; line-height: 1.5; }
    .main { padding: 1.5rem; margin: 0 auto; }
    .stats-row { display: flex; gap: 1rem; margin-bottom: 1.25rem; flex-wrap: wrap; align-items: stretch; }
    .stats-card { background: var(--card); padding: 1.25rem; border-radius: var(--radius); border: 1px solid var(--border); box-shadow: var(--shadow); flex: 1; min-width: 220px; box-sizing: border-box; }
    #stats-country { display: flex; flex-direction: column; max-height: 320px; }
    .stats-card h3 { margin: 0; font-size: 0.75rem; font-weight: 600; color: var(--muted); text-transform: uppercase; letter-spacing: 0.04em; }
    .stats-card-header { display: flex; align-items: center; justify-content: space-between; gap: 0.5rem; margin-bottom: 0.5rem; }
    .stats-section { display: flex; flex-direction: column; gap: 0.4rem; }
    .stats-main { font-size: 1.5rem; font-weight: 700; color: var(--accent); letter-spacing: -0.02em; }
    .stats-breakdown { font-size: 0.8125rem; color: var(--text); display: flex; flex-wrap: wrap; gap: 0.75rem; }
    .stats-breakdown span { display: inline-block; }
    .stats-divider { height: 1px; background: var(--border); margin: 0.6rem 0; }
    .stats-select { padding: 0.35rem 0.5rem; border: 1px solid var(--border); border-radius: var(--radius); background: var(--card); color: var(--text); font-size: 0.8125rem; }
    .muted { color: var(--muted); font-size: 0.8rem; }
    .country-table-wrap { overflow-y: auto; flex: 1; min-height: 0; }
    .by-country-table { width: 100%; border-collapse: collapse; font-size: 0.875rem; }
    .by-country-table th, .by-country-table td { padding: 0.4rem 0; border-bottom: none; }
    .by-country-table th { font-size: 0.7rem; color: var(--muted); font-weight: 600; text-transform: uppercase; letter-spacing: 0.03em; }
    .by-country-table tbody td:first-child { display: flex; align-items: center; gap: 0.5rem; }
    .by-country-table .flag-img { width: 24px; height: 18px; object-fit: cover; border-radius: var(--radius); }
    .aov-list { list-style: none; padding: 0; margin: 0; font-size: 0.875rem; }
    .aov-list li { padding: 0.35rem 0; border-bottom: none; display: flex; justify-content: space-between; align-items: center; gap: 0.5rem; }
    .aov-list li > span { display: flex; align-items: center; gap: 0.5rem; }
    table { width: 100%; border-collapse: collapse; background: var(--card); border-radius: var(--radius); overflow: hidden; border: 1px solid var(--border); box-shadow: var(--shadow); }
    th, td { padding: 0.6rem 0.75rem; text-align: left; border-bottom: 1px solid var(--border); vertical-align: middle; font-size: 0.875rem; }
    th { background: var(--th-bg); font-size: 0.75rem; color: var(--muted); font-weight: 600; text-transform: uppercase; letter-spacing: 0.03em; }
    th:first-child, td:first-child { min-width: 80px; padding-left: 0.75rem; }
    tr:hover { background: inherit; }
    tr.returning { background: var(--returning-bg); }
    tr.converted { background: var(--converted-bg); }
    tr.converted:hover { background: var(--converted-bg); }
    tr.clickable { cursor: pointer; }
    .flag-cell { white-space: nowrap; }
    .arrived-cell, .last-seen-cell { font-size: 0.875rem; white-space: nowrap; }
    .flag-img { width: 24px; height: 18px; object-fit: cover; border-radius: var(--radius); margin-right: 0.25rem; vertical-align: middle; display: inline-block; }
    .last-action-cell { display: flex; align-items: center; gap: 0.5rem; }
.last-action-cell a { color: #06133b; text-decoration: none; font-size: 12px; font-weight: 500; }
.last-action-cell a:hover { text-decoration: underline; }
.landing-fallback-hint { font-size: 0.75rem; color: var(--muted); font-weight: normal; }
    .thumb-card { display: inline-flex; align-items: center; justify-content: center; width: 35px; height: 35px; padding: 2px; background: #fff; border: 1px solid var(--border); border-radius: var(--radius); box-shadow: var(--shadow); flex-shrink: 0; box-sizing: border-box; }
    .thumb-card--sale { border: none; padding: 0; box-shadow: none; background: none; }
    .thumb-card img { width: 100%; height: 100%; object-fit: cover; border-radius: 1px; display: block; }
.table-title { font-size: 1rem; font-weight: 600; color: var(--text); margin-bottom: 0.5rem; }
    .badge { display: inline-block; padding: 0.15rem 0.4rem; border-radius: var(--radius); font-size: 0.75rem; }
    .badge.new { background: var(--accent); color: var(--badge-new-fg); }
    .badge.returning { background: var(--badge-returning); color: var(--badge-new-fg); }
    .chip { display: inline-block; padding: 0.1rem 0.35rem; border-radius: var(--radius); font-size: 0.7rem; margin-right: 0.25rem; }
    .chip.checking-out { background: var(--accent); color: var(--badge-new-fg); }
    .chip.abandoned { background: var(--chip-abandoned); color: var(--badge-new-fg); }
    .side-panel { position: fixed; top: 0; right: 0; width: 400px; max-width: 100%; height: 100%; background: var(--card); border-left: 1px solid var(--border); box-shadow: var(--side-panel-shadow); overflow-y: auto; z-index: 10; padding: 1.25rem; }
    .side-panel h3 { margin: 0 0 0.5rem; }
    .side-panel .close { float: right; cursor: pointer; font-size: 1.2rem; color: var(--muted); }
    .side-panel .meta { font-size: 0.85rem; color: var(--muted); margin: 0.5rem 0; }
    .side-panel-sale { margin: 0.75rem 0; padding: 0.75rem; background: var(--side-panel-sale-bg); border-radius: var(--radius); border-left: 3px solid var(--accent); color: var(--text); }
    .side-panel-sale strong { color: var(--accent); }
    .side-panel ul.events { list-style: none; padding: 0; margin: 0.5rem 0; font-size: 0.85rem; }
    .side-panel ul.events li { padding: 0.35rem 0; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 0.5rem; }
    .side-panel ul.events li .thumb-card { flex-shrink: 0; }
    .empty { text-align: center; padding: 2rem; color: var(--muted); }
    .consent-debug { font-size: 0.75rem; color: var(--muted); max-width: 200px; overflow: hidden; text-overflow: ellipsis; }
.dashboard-top-bar { display: flex; align-items: center; justify-content: space-between; padding: 10px 1.5rem 0; margin: 0 auto; width: 100%; box-sizing: border-box; }
.dashboard-top-bar-left { display: flex; align-items: center; }
.dashboard-top-bar-center { display: flex; align-items: center; justify-content: center; flex: 1; min-width: 0; }
.dashboard-top-bar-center .top-bar-logo { width: 80px; height: auto; display: block; object-fit: contain; }
.next-update-timer { width: 30px; text-align: center; font-weight: 500; display: inline-block; }
.dashboard-top-bar-right { display: flex; align-items: center; gap: 5px; }
.server-time-block { font-size: 0.8125rem; color: var(--muted); white-space: nowrap; margin: 0 5px 0 0; }
.server-time-tz { font-size: 0.7rem; opacity: 0.9; margin-left: 0.2rem; }
.top-bar-divider { width: 1px; height: 1.2em; background: #eee; flex-shrink: 0; }
.refresh-btn { display: inline-flex; align-items: center; justify-content: center; width: 15px; height: 15px; padding: 0; border: none; background: none; cursor: pointer; color: var(--text); }
.refresh-btn:hover { color: var(--accent); }
.refresh-btn svg { width: 15px; height: 15px; }
.refresh-btn.spinning svg { animation: refresh-spin 0.8s linear; }
@keyframes refresh-spin { to { transform: rotate(360deg); } }
.next-update-block { display: inline-flex; align-items: center; gap: 0.35rem; font-size: 0.875rem; color: var(--muted); }
.table-loading-overlay { position: absolute; inset: 0; background: rgba(255,255,255,0.7); display: flex; align-items: center; justify-content: center; border-radius: var(--radius); z-index: 2; }
.table-loading-overlay .spinner { width: 28px; height: 28px; border: 3px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: refresh-spin 0.8s linear infinite; }
.stats-row-wrap { position: relative; }
.sessions-table-wrap { position: relative; }
.live-view-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; margin-left: 10px; margin-right: 10px; gap: 0; }
.live-view-header .table-title { margin: 0; font-size: 14px; font-weight: 500; color: var(--text); flex-shrink: 0; display: flex; align-items: center; gap: 0.35rem; letter-spacing: -0.1px; }
.live-view-header .live-view-online { flex-shrink: 0; }
.live-view-header .live-view-online-center { flex: 1; justify-content: center; display: flex; }
.live-view-header .next-update-block { flex-shrink: 0; }
.live-view-online { font-size: 0.875rem; color: var(--muted); display: flex; align-items: center; gap: 0.35rem; margin-right: 10px; }
.live-view-online .online-dot { width: 10px; height: 10px; border-radius: 50%; background: #4caf50; flex-shrink: 0; }
.live-view-online strong { color: var(--accent); font-size: 17px; }
.live-view-spy-icon { display: inline-flex; align-items: center; justify-content: center; width: 15px; height: 15px; flex-shrink: 0; }
.live-view-spy-icon svg { width: 15px; height: 15px; }
.dashboard-top-bar select { padding: 0.5rem 0.75rem; border: 1px solid var(--border); border-radius: var(--radius); background: var(--card); font-size: 0.875rem; color: var(--text); appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23333' d='M6 8L2 4h8z'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 0.5rem center; padding-right: 1.75rem; }
.dashboard-top-bar select option:disabled { color: var(--muted); }
.traffic-toggle { margin-left: 0.75rem; font-size: 0.8125rem; }
.traffic-toggle .traffic-link { color: var(--muted); text-decoration: none; }
.traffic-toggle .traffic-link:hover { color: var(--accent); }
.traffic-toggle .traffic-link.active { color: var(--accent); font-weight: 600; }
.traffic-toggle .muted { margin: 0 0.25rem; color: var(--muted); }
#audio-mute-btn { display: inline-flex; align-items: center; justify-content: center; width: 20px; height: 20px; padding: 0; border: none; background: none; cursor: pointer; color: var(--text); }
#audio-mute-btn:hover { color: var(--accent); }
#audio-mute-btn.muted { opacity: 0.6; color: var(--muted); }
#audio-mute-btn svg { width: 20px; height: 20px; }
.table-scroll-wrap { overflow-x: auto; -webkit-overflow-scrolling: touch; margin-bottom: 0.5rem; border-radius: var(--radius); border: 1px solid var(--border); }
.table-scroll-wrap table { margin: 0; min-width: 720px; }
.table-scroll-wrap th, .table-scroll-wrap td { border-bottom: none; }
.table-scroll-wrap th.source-cell, .table-scroll-wrap th.cart-value-cell, .table-scroll-wrap td.source-cell, .table-scroll-wrap td.cart-value-cell { text-align: center; width: 1%; white-space: nowrap; padding-right: 0.75rem; }
.table-scroll-wrap .cart-value-sale { color: var(--accent); font-weight: bold; }
.table-scroll-wrap th.sortable { cursor: pointer; user-select: none; }
.table-scroll-wrap th.sortable:hover { color: var(--accent); }
.table-scroll-wrap th.th-sort-asc::after { content: ' \u25b4'; font-size: 0.65em; opacity: 0.8; }
.table-scroll-wrap th.th-sort-desc::after { content: ' \u25be'; font-size: 0.65em; opacity: 0.8; }
.table-pagination { display: flex; align-items: center; justify-content: center; gap: 1rem; padding: 0.5rem 0 1rem; font-size: 0.875rem; color: var(--muted); }
.table-pagination button { padding: 0.35rem 0.75rem; border: 1px solid var(--border); border-radius: var(--radius); background: var(--card); color: var(--text); cursor: pointer; font-size: 0.875rem; }
.table-pagination button:hover:not(:disabled) { border-color: var(--accent); background: var(--button-hover-bg); }
.table-pagination button:disabled { opacity: 0.5; cursor: not-allowed; }
    .source-googleads-img, .source-icon-img { width: 20px; height: 20px; vertical-align: middle; display: inline-block; }
    .source-info-icon { font-size: 0.875rem; color: var(--muted); cursor: help; vertical-align: middle; }
    @media (max-width: 768px) {
      .dashboard-top-bar-center { display: none; }
      .dashboard-top-bar { padding-left: 0.75rem; padding-right: 0.75rem; }
      .main { padding: 0.75rem; }
      .stats-row { gap: 0.75rem; margin-bottom: 1rem; }
      .stats-card { min-width: 100%; }
      .stats-card:first-child { min-width: 100%; }
      .stats-main { font-size: 1.35rem; }
      .stats-breakdown { gap: 0.5rem; font-size: 0.75rem; }
      .live-view-header .table-title { font-size: 0.9375rem; }
      .table-title { font-size: 0.9375rem; margin-bottom: 0.35rem; }
      .live-view-header .next-update-block { display: none; }
      .live-view-header .live-view-online-center { margin-left: auto; flex: 0; }
      .sessions-table-wrap { margin-left: 0.75rem; margin-right: 0.75rem; }
      .table-scroll-wrap { margin-left: 0; margin-right: 0; border-radius: var(--radius); -webkit-overflow-scrolling: touch; overflow-x: auto; }
      .table-scroll-wrap th:first-child, .table-scroll-wrap td:first-child { position: sticky; left: 0; z-index: 1; background: var(--card); box-shadow: 4px 0 6px -2px rgba(0,0,0,0.08); }
      .table-scroll-wrap thead th:first-child { z-index: 2; background: var(--th-bg); }
      .side-panel { width: 100%; padding: 1rem; }
      .side-panel .close { min-width: 44px; min-height: 44px; display: inline-flex; align-items: center; justify-content: center; margin: -0.5rem 0 0.5rem 0; }
      th, td { padding: 0.5rem 0.6rem; font-size: 0.8125rem; }
      .last-action-cell a { display: none; }
      .thumb-card { width: 32px; height: 32px; padding: 1.5px; }
    }
    @media (max-width: 480px) {
      .dashboard-top-bar { padding-left: 0.5rem; padding-right: 0.5rem; }
      .main { padding: 0.5rem; }
      .stats-card { padding: 1rem; }
      .sessions-table-wrap { margin-left: 0.5rem; margin-right: 0.5rem; }
    }
    .dashboard-footer { text-align: center; padding: 0.75rem 1rem; font-size: 0.8125rem; color: var(--muted); margin: 0 auto; }
  </style>
</head>
<body>
  <div class="dashboard-top-bar">
    <div class="dashboard-top-bar-left">
      <select id="global-date-select" aria-label="Date range">
        <option value="today">Today</option>
        <option value="yesterday">Yesterday</option>
        <option value="3d">Last 3 Days</option>
        <option value="7d">Last 7 Days</option>
      </select>
      <span class="traffic-toggle" id="traffic-toggle" aria-label="Traffic filter">
        <a href="#" id="traffic-all" class="traffic-link">All</a>
        <span class="muted">|</span>
        <a href="#" id="traffic-human" class="traffic-link">Human</a>
      </span>
    </div>
    <div class="dashboard-top-bar-center">
      <img class="top-bar-logo" src="https://www.hbdjewellery.com/cdn/shop/files/HBDDarkLogo.webp?width=240" alt="HBD" width="80" height="auto" loading="lazy">
    </div>
    <div class="dashboard-top-bar-right">
      <span class="server-time-block"><span id="server-time-msg">--:--</span> <span class="server-time-tz" aria-label="UK time (GMT/BST)">UK</span></span>
      <span class="top-bar-divider" aria-hidden="true"></span>
      <button type="button" id="refresh-btn" class="refresh-btn" title="Refresh" aria-label="Refresh">
        <svg viewBox="0 0 329.028 329.028" xmlns="http://www.w3.org/2000/svg" fill="currentColor"><path d="M241.852,72.459l10.847-54.533c1.184-5.95-1.334-12.028-6.378-15.398c-5.045-3.37-11.623-3.37-16.667,0 L156.182,51.62c-0.004,0.003-0.008,0.006-0.012,0.009c-0.415,0.278-0.817,0.576-1.201,0.893c-0.219,0.181-0.418,0.377-0.625,0.568 c-0.148,0.137-0.304,0.265-0.447,0.408c-0.249,0.25-0.478,0.514-0.707,0.778c-0.088,0.101-0.183,0.196-0.268,0.299 c-0.208,0.253-0.396,0.519-0.586,0.783c-0.095,0.132-0.197,0.259-0.288,0.394c-0.155,0.232-0.292,0.473-0.433,0.712 c-0.109,0.185-0.225,0.365-0.327,0.554c-0.104,0.195-0.192,0.397-0.288,0.597c-0.118,0.245-0.24,0.487-0.344,0.739 c-0.064,0.156-0.115,0.317-0.174,0.475c-0.112,0.299-0.227,0.598-0.32,0.906c-0.042,0.137-0.069,0.276-0.106,0.414 c-0.09,0.329-0.181,0.658-0.248,0.996c-0.045,0.223-0.068,0.45-0.103,0.675c-0.038,0.252-0.088,0.501-0.113,0.758 c-0.051,0.498-0.075,0.998-0.076,1.5c0,0.004-0.001,0.009-0.001,0.013c0,0.058,0.008,0.113,0.009,0.17 c0.004,0.437,0.023,0.874,0.066,1.311c0.016,0.156,0.045,0.307,0.065,0.461c0.043,0.332,0.086,0.664,0.151,0.994 c0.042,0.212,0.102,0.418,0.152,0.627c0.064,0.264,0.124,0.529,0.204,0.791c0.077,0.256,0.173,0.503,0.264,0.753 c0.076,0.208,0.143,0.418,0.229,0.624c0.126,0.305,0.272,0.598,0.418,0.892c0.072,0.146,0.134,0.295,0.211,0.438 c0.203,0.379,0.426,0.745,0.66,1.104c0.036,0.055,0.064,0.113,0.1,0.167l0.019,0.028c0.01,0.015,0.02,0.03,0.03,0.045l49.044,73.401 c2.817,4.217,7.525,6.667,12.47,6.667c0.971,0,1.952-0.094,2.928-0.288c5.951-1.184,10.602-5.835,11.786-11.786l7.052-35.455 c23.901,20.188,39.11,50.36,39.11,84.023c0,60.636-49.331,109.968-109.967,109.968c-60.637,0-109.969-49.332-109.969-109.968 c0-40.179,21.91-77.153,57.179-96.494c7.264-3.983,9.923-13.101,5.94-20.365c-3.983-7.264-13.101-9.924-20.365-5.94 C52.424,90.871,24.546,137.924,24.546,189.06c0,77.178,62.79,139.968,139.969,139.968c77.178,0,139.967-62.79,139.967-139.968 C304.482,140.453,279.571,97.56,241.852,72.459z"/></svg>
      </button>
      <span class="top-bar-divider" aria-hidden="true"></span>
      <button type="button" id="audio-mute-btn" title="Toggle sale sound" aria-label="Toggle sale sound">
        <svg class="sound-icon-on" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M9.5 19C8.89555 19 7.01237 19 5.61714 19C4.87375 19 4.39116 18.2177 4.72361 17.5528L5.57771 15.8446C5.85542 15.2892 6 14.6774 6 14.0564C6 13.2867 6 12.1434 6 11C6 9 7 5 12 5C17 5 18 9 18 11C18 12.1434 18 13.2867 18 14.0564C18 14.6774 18.1446 15.2892 18.4223 15.8446L19.2764 17.5528C19.6088 18.2177 19.1253 19 18.382 19H14.5M9.5 19C9.5 21 10.5 22 12 22C13.5 22 14.5 21 14.5 19M9.5 19C11.0621 19 14.5 19 14.5 19"/><path d="M12 5V3"/></svg>
        <svg class="sound-icon-off" style="display:none" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M6 15C6 15 6 13 6 11C6 9 7 5 12 5C13.5723 5 14.749 5.39552 15.6235 6M9.5 19C9.5 21 10.5 22 12 22C13.5 22 14.5 21 14.5 19M9.5 19C11.0621 19 14.5 19 14.5 19M9.5 19C9.14909 19 8.36719 19 7.5 19M14.5 19H18.382C19.1253 19 19.6088 18.2177 19.2764 17.5528L18 15C18 15 18 13 18 11C18 10.3755 17.9025 9.55594 17.6161 8.72408"/><path d="M12 5V3"/><path d="M21 3L3 21"/></svg>
      </button>
    </div>
  </div>
  <main class="main">
  <div class="stats-row-wrap">
    <div class="table-loading-overlay stats-loading-overlay" id="stats-loading-overlay" style="display: none;"><div class="spinner"></div></div>
  <div class="stats-row">
    <div class="stats-card" id="stats-primary">
      <div class="stats-section">
        <div class="stats-card-header">
          <h3>Sales</h3>
        </div>
        <div class="stats-main" id="sales-today"></div>
        <div class="stats-breakdown">
          <span>3 hours: <strong id="sales-3h"></strong></span>
          <span>6 hours: <strong id="sales-6h"></strong></span>
        </div>
      </div>
      <div class="stats-divider"></div>
      <div class="stats-section">
        <div class="stats-card-header">
          <h3>Conversion rate</h3>
        </div>
        <div class="stats-main" id="conversion-range"></div>
        <div class="stats-breakdown">
          <span>3 hours: <strong id="conversion-3h"></strong></span>
          <span>6 hours: <strong id="conversion-6h"></strong></span>
        </div>
      </div>
    </div>
    <div class="stats-card" id="stats-aov">
      <div class="stats-card-header">
        <h3>Average Order Value</h3>
      </div>
      <div class="stats-section">
        <div class="stats-main" id="aov-today"></div>
        <div class="stats-breakdown">
          <span>Yesterday: <strong id="aov-yesterday"></strong></span>
          <span>7 Days: <strong id="aov-7d"></strong></span>
        </div>
      </div>
      <div class="country-table-wrap" id="aov-list-wrap">
        <ul class="aov-list" id="aov-by-country"></ul>
      </div>
    </div>
    <div class="stats-card" id="stats-country">
      <div class="stats-card-header">
        <h3>Country</h3>
      </div>
      <div class="country-table-wrap" id="country-table-wrap">
        <table class="by-country-table">
          <thead>
            <tr>
              <th>GEO</th>
              <th>CR</th>
              <th>Sales</th>
              <th>Revenue</th>
            </tr>
          </thead>
          <tbody id="by-country-body">
            <tr><td colspan="4" class="empty">Loading...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
  </div>

  <div class="live-view-header">
    <h2 class="table-title" id="table-title"><span class="live-view-spy-icon" id="live-view-spy-icon" aria-hidden="true"><svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M12.0002 5C9.89024 5 7.99432 5.92747 6.49128 7.00884C4.98034 8.0959 3.78013 9.40024 3.04026 10.2985C2.21965 11.2948 2.21965 12.7052 3.04026 13.7015C3.78013 14.5998 4.98034 15.9041 6.49128 16.9912C7.99432 18.0725 9.89024 19 12.0002 19C14.1101 19 16.006 18.0725 17.5091 16.9912C19.02 15.9041 20.2202 14.5998 20.9601 13.7015C21.7807 12.7052 21.7807 11.2948 20.9601 10.2985C20.2202 9.40025 19.02 8.0959 17.5091 7.00885C16.006 5.92747 14.1101 5 12.0002 5ZM12 10C10.8954 10 10 10.8954 10 12C10 13.1046 10.8954 14 12 14C13.1046 14 14 13.1046 14 12C14 10.8954 13.1046 10 12 10ZM8 12C8 9.79086 9.79086 8 12 8C14.2091 8 16 9.79086 16 12C16 14.2091 14.2091 16 12 16C9.79086 16 8 14.2091 8 12Z" fill="currentColor"></path></svg></span><span id="table-title-text">Spy View</span></h2>
    <div class="live-view-online live-view-online-center"><span class="online-dot"></span> Online: <strong id="online-count">0</strong></div>
    <span class="next-update-block">Next update in: <span id="next-update-msg" class="next-update-timer">-- s</span></span>
  </div>

  <div class="sessions-table-wrap">
    <div class="table-loading-overlay sessions-loading-overlay" id="sessions-loading-overlay" style="display: none;"><div class="spinner"></div></div>
  <div class="table-scroll-wrap">
  <table>
    <thead>
      <tr>
        <th>LP</th>
        <th class="sortable" data-sort="from" aria-sort="none" tabindex="0">GEO</th>
        <th>Device</th>
        <th>History</th>
        <th class="sortable" data-sort="arrived" aria-sort="none" tabindex="0">Arrived</th>
        <th>Last Seen</th>
        <th class="source-cell sortable" data-sort="source" aria-sort="none" tabindex="0">Source</th>
        <th class="cart-value-cell sortable" data-sort="cart" aria-sort="none" tabindex="0">Cart</th>
        <th class="consent-col" style="display:none">Consent (debug)</th>
      </tr>
    </thead>
    <tbody id="table-body"></tbody>
  </table>
  </div>
  <div class="table-pagination" id="table-pagination">
    <button type="button" id="pagination-prev" aria-label="Previous page">Prev</button>
    <span id="pagination-label">Page 1 of 1</span>
    <button type="button" id="pagination-next" aria-label="Next page">Next</button>
  </div>
  </div>

  <div id="side-panel" class="side-panel" style="display:none">
    <span class="close" id="side-close">&times;</span>
    <h3>Session</h3>
    <div class="meta" id="side-meta"></div>
    <h4>Activity:</h4>
    <ul class="events" id="side-events"></ul>
  </div>
  </main>
  <footer class="dashboard-footer" id="dashboard-footer">Liveview v<span id="app-version">—</span></footer>

  <script>
    const API = '';
    const STATS_INTERVAL_MS = 60000;
    fetch(API + '/api/version').then(r => r.json()).then(d => { const el = document.getElementById('app-version'); if (el) el.textContent = d.version || '—'; }).catch(() => {});
    const SALE_MUTED_KEY = 'livevisitors-sale-muted';
    const ROWS_PER_PAGE = 40;
    let sessions = [];
    let statsCache = {};
    let dateRange = 'today';
    let trafficMode = (function() { var p = new URLSearchParams(window.location.search); return p.get('traffic') === 'human' ? 'human' : 'all'; })();
    let nextStatsAt = 0;
    let lastUpdateTime = null;
    let lastConvertedCountToday = 0;
    let shopifySalesToday = null;
    let saleAudio = null;
    let saleMuted = false;
    let currentPage = 1;
    let sortBy = '';
    let sortDir = 'asc';
    const SORT_DEFAULTS = { from: 'asc', arrived: 'desc', source: 'asc', cart: 'desc' };

    // Auto-configure pixel when opened from Shopify (shop in URL) so merchants don't run mutations manually
    (function ensurePixelOnce() {
      const params = new URLSearchParams(window.location.search);
      const shop = params.get('shop');
      if (shop && /\.myshopify\.com$/i.test(shop)) {
        fetch(API + '/api/pixel/ensure?shop=' + encodeURIComponent(shop), { credentials: 'same-origin' })
          .then(function (r) { return r.json(); })
          .then(function (data) {
            if (data.ok && data.action) console.log('[Live Visitors] Pixel', data.action);
          })
          .catch(function () {});
      }
    })();
    let filter = 'today';
    let selectedSessionId = null;
    let timeTick = null;
    const tz = 'Europe/London';

    function updateServerTimeDisplay() {
      const el = document.getElementById('server-time-msg');
      if (!el) return;
      var now = new Date();
      el.textContent = now.toLocaleTimeString('en-GB', { timeZone: tz, hour: '2-digit', minute: '2-digit', hour12: false });
    }

    function toMs(v) {
      if (v == null || v === '') return null;
      let n = typeof v === 'number' ? v : Number(v);
      if (Number.isNaN(n)) return null;
      if (n < 1e12) n *= 1000;
      return n;
    }

    function formatTs(ms) {
      const n = toMs(ms);
      if (n == null) return '\u2014';
      const d = new Date(n);
      if (Number.isNaN(d.getTime())) return '\u2014';
      return d.toLocaleString('en-GB', { timeZone: tz, dateStyle: 'short', timeStyle: 'short' });
    }

    function formatRelative(ms) {
      const n = toMs(ms);
      if (n == null) return '';
      const s = Math.floor((Date.now() - n) / 1000);
      if (s < 60) return s + 's ago';
      if (s < 3600) return Math.floor(s / 60) + 'm ago';
      return Math.floor(s / 3600) + 'h ago';
    }

    function formatDuration(startMs) {
      const n = toMs(startMs);
      if (n == null) return '';
      const s = Math.floor((Date.now() - n) / 1000);
      const m = Math.floor(s / 60);
      const h = Math.floor(m / 60);
      if (h > 0) return h + 'h ' + (m % 60) + 'm';
      if (m > 0) return m + 'm ' + (s % 60) + 's';
      return s + 's';
    }

    var countryNames = { GB: 'UK', US: 'USA', CA: 'CA', AU: 'AU', DE: 'DE', FR: 'FR', IE: 'IE', ES: 'ES', IT: 'IT', NL: 'NL', IN: 'IN', JP: 'JP', DK: 'DK', SE: 'SE', NO: 'NO', TH: 'TH', NZ: 'NZ', RO: 'RO', BE: 'BE', FI: 'FI', AE: 'UAE', XX: '\u2014' };

    function countryLabel(code) {
      if (!code) return 'Unknown';
      var c = (code || 'XX').toUpperCase().slice(0, 2);
      return countryNames[c] || c;
    }

    function flagImg(code) {
      if (!code || code === 'XX') return '<img class="flag-img" src="https://flagcdn.com/w40/xx.png" alt="?" loading="lazy">';
      const c = (code || 'xx').toLowerCase().slice(0, 2);
      return '<img class="flag-img" src="https://flagcdn.com/w40/' + escapeHtml(c) + '.png" alt="' + escapeHtml(code) + '" loading="lazy">';
    }

    function arrivedAgo(startedAt) {
      var n = toMs(startedAt);
      if (n == null) return '\u2014';
      var s = Math.floor((Date.now() - n) / 1000);
      if (s < 60) return s + ' secs ago';
      if (s < 3600) return Math.floor(s / 60) + ' mins ago';
      if (s < 86400) return Math.floor(s / 3600) + ' hrs ago';
      return Math.floor(s / 86400) + ' days ago';
    }

    var storeBaseUrlFallback = '';
    var mainBaseUrlFallback = '';
    var assetsBaseUrlFallback = '';
    var shopForSalesFallback = '';
    (function fetchStoreBaseUrl() {
      fetch(API + '/api/store-base-url', { credentials: 'same-origin' })
        .then(function(r) { return r.json(); })
        .then(function(d) {
          if (d) {
            if (d.baseUrl) storeBaseUrlFallback = d.baseUrl;
            if (d.mainBaseUrl) mainBaseUrlFallback = d.mainBaseUrl;
            if (d.assetsBaseUrl) assetsBaseUrlFallback = d.assetsBaseUrl;
            if (d.shopForSales) shopForSalesFallback = d.shopForSales;
            if (sessions.length) renderTable();
            if (assetsBaseUrlFallback) {
              var link = document.querySelector('link[rel="icon"]');
              if (link) link.href = assetsBaseUrlFallback + '/favicon.png';
              if (typeof saleAudio !== 'undefined' && saleAudio) saleAudio.src = assetsBaseUrlFallback + '/cash-register.mp3';
            }
            if (shopForSalesFallback && dateRange === 'today' && typeof fetchShopifySales === 'function') fetchShopifySales();
          }
        })
        .catch(function() {});
    })();
    function getStoreBaseUrl() {
      var params = new URLSearchParams(window.location.search);
      var shop = params.get('shop');
      if (shop && /\.myshopify\.com$/i.test(shop)) return 'https://' + shop;
      return storeBaseUrlFallback || '';
    }
    function getMainBaseUrl() {
      if (mainBaseUrlFallback) return mainBaseUrlFallback;
      return getStoreBaseUrl();
    }
    function getAssetsBase() {
      if (assetsBaseUrlFallback) return assetsBaseUrlFallback;
      return (API || '') + '/assets';
    }

    var HICON_URL = 'https://cdn.shopify.com/s/files/1/0847/7261/8587/files/hicon.webp?v=1770084894';
    var DOLLAR_URL = 'https://cdn.shopify.com/s/files/1/0847/7261/8587/files/dollar.png?v=1770085223';

    function landingPageCell(s) {
      var hasFirst = (s.first_path != null && s.first_path !== '') || (s.first_product_handle != null && s.first_product_handle !== '');
      var path = (s.first_path != null && s.first_path !== '' ? s.first_path : (hasFirst ? '' : (s.last_path != null ? s.last_path : ''))).trim();
      var productHandle = s.first_product_handle != null && s.first_product_handle !== '' ? s.first_product_handle : (hasFirst ? null : (s.last_product_handle != null ? s.last_product_handle : null));
      var isFromLast = !hasFirst && (path || productHandle);
      if (path && !path.startsWith('/')) path = '/' + path;
      if (!path && productHandle) path = '/products/' + (productHandle || '');
      var pathNorm = path ? path.replace(/\/+$/, '') : '';
      var isCheckout = path && path.indexOf('/checkouts') === 0;
      var isHomeOrOrders = path === '/' || path === '/orders' || pathNorm === '/orders' || (path && path.startsWith('/orders/'));
      var isCart = path === '/cart' || pathNorm === '/cart';
      var mainBase = getMainBaseUrl();
      var fullUrl = mainBase && path ? mainBase + path : '';
      var label = '\u2014';
      var thumbSrc = '';
      if (s.has_purchased) {
        label = path === '/' ? 'Home' : (path ? escapeHtml(path) : '\u2014');
        thumbSrc = DOLLAR_URL;
      } else if (isHomeOrOrders) {
        label = path === '/' ? 'Home' : escapeHtml(path);
        thumbSrc = HICON_URL;
      } else if (isCart) {
        label = 'Cart';
        thumbSrc = HICON_URL;
      } else if (isCheckout) {
        label = 'Cart';
        thumbSrc = getAssetsBase() + '/checkout.webp';
      } else if (path) {
        label = escapeHtml(path);
        if (fullUrl) thumbSrc = (API || '') + '/api/og-thumb?url=' + encodeURIComponent(fullUrl);
      }
      if (isFromLast && label !== '\u2014') label += ' <span class="landing-fallback-hint">(last)</span>';
      if (thumbSrc || fullUrl) {
        var cardClass = thumbSrc === DOLLAR_URL ? 'thumb-card thumb-card--sale' : 'thumb-card';
        var img = thumbSrc ? '<span class="' + cardClass + '"><img src="' + thumbSrc + '" alt="" onerror="this.parentElement&&(this.parentElement.style.display=\'none\')"></span>' : '';
        var link = fullUrl ? '<a href="' + escapeHtml(fullUrl) + '" target="_blank" rel="noopener">' + label + '</a>' : label;
        return '<div class="last-action-cell">' + img + ' ' + link + '</div>';
      }
      return label === '\u2014' ? label : escapeHtml(path || '');
    }

    function formatMoney(amount, currencyCode) {
      if (amount == null || typeof amount !== 'number') return '';
      const code = (currencyCode || 'GBP').toUpperCase();
      const sym = code === 'GBP' ? '\u00A3' : code === 'USD' ? '$' : code === 'EUR' ? '\u20AC' : code + ' ';
      return sym + (amount % 1 === 0 ? amount : amount.toFixed(2));
    }

    function sourceLabel(s) {
      const parts = [];
      if (s.utm_source && String(s.utm_source).trim()) parts.push('utm_source: ' + escapeHtml(String(s.utm_source).trim()));
      if (s.utm_campaign && String(s.utm_campaign).trim()) parts.push('utm_campaign: ' + escapeHtml(String(s.utm_campaign).trim()));
      if (s.utm_medium && String(s.utm_medium).trim()) parts.push('utm_medium: ' + escapeHtml(String(s.utm_medium).trim()));
      if (s.utm_content && String(s.utm_content).trim()) parts.push('utm_content: ' + escapeHtml(String(s.utm_content).trim()));
      return parts.join(' ');
    }

    function sourceUtmString(s) {
      return [s.utm_source, s.utm_campaign, s.utm_medium, s.utm_content].filter(Boolean).join(' ').toLowerCase();
    }

    function isGoogleAdsSource(s) {
      return sourceUtmString(s).indexOf('googleads') !== -1;
    }

    function sourceFriendlyLabel(s) {
      const str = sourceUtmString(s);
      if (!str) return null;
      if (str.indexOf('googleads') !== -1) return null;
      if (str.indexOf('google') !== -1) return 'Google';
      if (str.indexOf('chatgpt') !== -1 || str.indexOf('chat gpt') !== -1) return 'Chatgpt';
      return null;
    }

    function sourceSortKey(s) {
      if (isGoogleAdsSource(s)) return 'Google Ads';
      const friendly = sourceFriendlyLabel(s);
      if (friendly === 'Google') return 'Google';
      if (friendly) return friendly;
      if (sourceUtmString(s)) return 'Other';
      return 'Direct';
    }

    const SOURCE_GOOGLE_IMG = 'https://cdn.shopify.com/s/files/1/0847/7261/8587/files/google.png?v=1770086632';
    const SOURCE_DIRECT_IMG = 'https://cdn.shopify.com/s/files/1/0847/7261/8587/files/arrow-right.png?v=1770086632';

    function sourceCell(s) {
      const fullUtm = sourceLabel(s);
      const fullTitle = (fullUtm || '').replace(/&/g, '&amp;').replace(/"/g, '&quot;');
      function infoIcon() {
        if (!fullUtm) return '';
        return ' <span class="source-info-icon" title="' + fullTitle + '" aria-label="UTM params">\u2139</span>';
      }
      if (isGoogleAdsSource(s)) {
        return '<img src="' + getAssetsBase() + '/adwords.png" alt="Google Ads" class="source-googleads-img" width="20" height="20"' + (fullUtm ? ' title="' + fullTitle + '"' : '') + '>';
      }
      const friendly = sourceFriendlyLabel(s);
      if (friendly === 'Google') {
        return '<img src="' + SOURCE_GOOGLE_IMG + '" alt="Google" class="source-icon-img" width="20" height="20"' + (fullUtm ? ' title="' + fullTitle + '"' : '') + '>';
      }
      if (friendly) return escapeHtml(friendly) + infoIcon();
      if (fullUtm) return escapeHtml('Other') + infoIcon();
      return '<img src="' + SOURCE_DIRECT_IMG + '" alt="Direct" class="source-icon-img" width="20" height="20" title="Direct">';
    }

    function renderRow(s) {
      const countryCode = s.country_code || 'XX';
      const visits = (s.returning_count != null ? s.returning_count : 0) + 1;
      const visitsLabel = visits === 1 ? '1 visit' : visits + ' visits';
      const cartValueNum = s.cart_value != null ? Number(s.cart_value) : NaN;
      const cartVal = s.has_purchased ? '' : ((s.cart_value != null && !Number.isNaN(cartValueNum))
        ? formatMoney(cartValueNum, s.cart_currency)
        : '');
      const saleVal = s.has_purchased ? formatMoney(s.order_total != null ? Number(s.order_total) : null, s.order_currency) : '';
      const cartOrSaleCell = s.has_purchased
        ? '<span class="cart-value-sale">' + escapeHtml(saleVal) + '</span>'
        : cartVal;
      const fromCell = flagImg(countryCode);
      const consentDebug = s.meta_json ? (JSON.parse(s.meta_json || '{}').customer_privacy_debug ? 'yes' : '') : '';
      return `<tr class="clickable ${s.is_returning ? 'returning' : ''} ${s.has_purchased ? 'converted' : ''}" data-session-id="${s.session_id}">
        <td>${landingPageCell(s)}</td>
        <td class="flag-cell">${fromCell}</td>
        <td>${escapeHtml(s.device || '')}</td>
        <td>${visitsLabel}</td>
        <td class="arrived-cell"><span data-started="${s.started_at}">${arrivedAgo(s.started_at)}</span></td>
        <td class="last-seen-cell"><span data-last-seen="${s.last_seen}">${arrivedAgo(s.last_seen)}</span></td>
        <td class="source-cell">${sourceCell(s)}</td>
        <td class="cart-value-cell">${cartOrSaleCell}</td>
        <td class="consent-debug consent-col" style="display:none">${escapeHtml(consentDebug)}</td>
      </tr>`;
    }

    function escapeHtml(str) {
      if (str == null) return '';
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    function cartSortValue(s) {
      if (s.has_purchased && s.order_total != null) return Number(s.order_total);
      if (s.cart_value != null) { const n = Number(s.cart_value); if (!Number.isNaN(n)) return n; }
      return -Infinity;
    }

    function getSortedSessions() {
      if (!sortBy) return sessions.slice();
      const list = sessions.slice();
      const mult = sortDir === 'asc' ? 1 : -1;
      list.sort(function (a, b) {
        var va, vb;
        if (sortBy === 'from') {
          va = (a.country_code || 'ZZ').toUpperCase();
          vb = (b.country_code || 'ZZ').toUpperCase();
          return mult * (va < vb ? -1 : va > vb ? 1 : 0);
        }
        if (sortBy === 'arrived') {
          va = toMs(a.started_at) ?? 0;
          vb = toMs(b.started_at) ?? 0;
          return mult * (va - vb);
        }
        if (sortBy === 'source') {
          va = sourceSortKey(a);
          vb = sourceSortKey(b);
          return mult * (va < vb ? -1 : va > vb ? 1 : 0);
        }
        if (sortBy === 'cart') {
          va = cartSortValue(a);
          vb = cartSortValue(b);
          return mult * (va - vb);
        }
        return 0;
      });
      return list;
    }

    function renderTable() {
      const tbody = document.getElementById('table-body');
      const sorted = getSortedSessions();
      const totalPages = Math.max(1, Math.ceil(sorted.length / ROWS_PER_PAGE));
      currentPage = Math.min(Math.max(1, currentPage), totalPages);
      const start = (currentPage - 1) * ROWS_PER_PAGE;
      const pageSessions = sorted.slice(start, start + ROWS_PER_PAGE);
      if (sorted.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="empty">No sessions in this view.</td></tr>';
      } else {
        tbody.innerHTML = pageSessions.map(renderRow).join('');
        document.querySelectorAll('#table-body tr.clickable').forEach(tr => {
          tr.addEventListener('click', () => {
            selectedSessionId = tr.dataset.sessionId;
            openSidePanel(selectedSessionId);
          });
        });
      }
      const prevBtn = document.getElementById('pagination-prev');
      const nextBtn = document.getElementById('pagination-next');
      const labelEl = document.getElementById('pagination-label');
      if (prevBtn) { prevBtn.disabled = currentPage <= 1; }
      if (nextBtn) { nextBtn.disabled = currentPage >= totalPages; }
      if (labelEl) labelEl.textContent = 'Page ' + currentPage + ' of ' + totalPages;
      updateSortHeaders();
      tickTimeOnSite();
    }

    function updateSortHeaders() {
      document.querySelectorAll('.table-scroll-wrap th.sortable').forEach(function (th) {
        var col = th.getAttribute('data-sort');
        th.classList.remove('th-sort-asc', 'th-sort-desc');
        th.setAttribute('aria-sort', sortBy === col ? (sortDir === 'asc' ? 'ascending' : 'descending') : 'none');
        if (sortBy === col) th.classList.add(sortDir === 'asc' ? 'th-sort-asc' : 'th-sort-desc');
      });
    }

    function setupSortableHeaders() {
      document.querySelectorAll('.table-scroll-wrap th.sortable').forEach(function (th) {
        th.addEventListener('click', function () {
          var col = th.getAttribute('data-sort');
          if (sortBy === col) sortDir = sortDir === 'asc' ? 'desc' : 'asc';
          else { sortBy = col; sortDir = SORT_DEFAULTS[col] || 'asc'; }
          renderTable();
        });
      });
    }

    function tickTimeOnSite() {
      document.querySelectorAll('#table-body span[data-started]').forEach(span => {
        const started = parseInt(span.getAttribute('data-started'), 10);
        span.textContent = arrivedAgo(started);
      });
      document.querySelectorAll('#table-body span[data-last-seen]').forEach(span => {
        const lastSeen = parseInt(span.getAttribute('data-last-seen'), 10);
        span.textContent = arrivedAgo(lastSeen);
      });
    }

    function pct(v) { return v != null ? v.toFixed(1) + '%' : ''; }

    function formatRevenue(num) {
      if (num == null || typeof num !== 'number') return '';
      return '\u00A3' + (num % 1 === 0 ? num : num.toFixed(2));
    }

    function getShopParam() {
      var p = new URLSearchParams(window.location.search);
      var shop = p.get('shop') || '';
      return shop && /\.myshopify\.com$/i.test(shop) ? shop : null;
    }

    function fetchShopifySales() {
      var shop = getShopParam() || shopForSalesFallback || null;
      if (!shop || dateRange !== 'today') {
        shopifySalesToday = null;
        return;
      }
      fetch(API + '/api/shopify-sales?shop=' + encodeURIComponent(shop), { credentials: 'same-origin' })
        .then(function(r) { return r.ok ? r.json() : null; })
        .then(function(data) {
          shopifySalesToday = data && typeof data.salesToday === 'number' ? data.salesToday : null;
          renderSales(statsCache);
        })
        .catch(function() { shopifySalesToday = null; renderSales(statsCache); });
    }

    function renderSales(data) {
      const sales = data.sales || {};
      const mainSales = (dateRange === 'today' && shopifySalesToday != null) ? shopifySalesToday : (sales[dateRange] != null ? sales[dateRange] : 0);
      document.getElementById('sales-today').textContent = formatRevenue(mainSales);
      const rolling = sales.rolling || {};
      const sales3 = document.getElementById('sales-3h');
      const sales6 = document.getElementById('sales-6h');
      if (sales3) sales3.textContent = formatRevenue(rolling['3h']);
      if (sales6) sales6.textContent = formatRevenue(rolling['6h']);
    }

    function renderConversion(data) {
      const c = data.conversion || {};
      document.getElementById('conversion-range').textContent = pct(c[dateRange]);
      const rolling = c.rolling || {};
      document.getElementById('conversion-3h').textContent = pct(rolling['3h']);
      document.getElementById('conversion-6h').textContent = pct(rolling['6h']);
    }

    function renderAov(data) {
      const aov = data.aov || {};
      const el = document.getElementById('aov-today');
      if (el) el.textContent = aov[dateRange] != null ? formatRevenue(aov[dateRange]) : '\u00A30.00';
      const aovYesterday = document.getElementById('aov-yesterday');
      const aov7d = document.getElementById('aov-7d');
      if (aovYesterday) aovYesterday.textContent = aov.yesterday != null ? formatRevenue(aov.yesterday) : '\u2014';
      if (aov7d) aov7d.textContent = aov['7d'] != null ? formatRevenue(aov['7d']) : '\u2014';
      const rows = (data.country || {})[dateRange] || [];
      const ul = document.getElementById('aov-by-country');
      if (!ul) return;
      if (rows.length === 0) {
        ul.innerHTML = '<li class="empty">No data</li>';
        return;
      }
      ul.innerHTML = rows.filter(r => r.aov != null && r.aov > 0).map(r => {
        const code = (r.country_code || 'xx').toLowerCase().slice(0, 2);
        const name = countryLabel((r.country_code || 'XX').toUpperCase());
        const flag = '<img class="flag-img" src="https://flagcdn.com/w40/' + code + '.png" alt="" loading="lazy">';
        return '<li><span>' + flag + ' ' + escapeHtml(name) + '</span><strong>' + formatRevenue(r.aov) + '</strong></li>';
      }).join('');
    }

    function renderCountry(data) {
      const c = data.country || {};
      const rows = c[dateRange] || [];
      const tbody = document.getElementById('by-country-body');
      if (!tbody) return;
      if (rows.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="empty">No data</td></tr>';
        return;
      }
      tbody.innerHTML = rows.map(r => {
        const code = (r.country_code || 'XX').toUpperCase();
        const ccode = (r.country_code || 'xx').toLowerCase().slice(0, 2);
        const label = countryLabel(code);
        const conversion = pct(r.conversion);
        const salesCount = r.converted != null ? Number(r.converted) : 0;
        const revenue = formatRevenue(r.revenue);
        return '<tr><td><img class="flag-img" src="https://flagcdn.com/w40/' + ccode + '.png" alt="' + escapeHtml(code) + '" loading="lazy"> ' + escapeHtml(label) + '</td><td>' + conversion + '</td><td>' + salesCount + '</td><td>' + revenue + '</td></tr>';
      }).join('');
    }

    function syncCountryTableHeight() {
      const primary = document.getElementById('stats-primary');
      const country = document.getElementById('stats-country');
      if (!primary || !country) return;
      const primaryHeight = primary.getBoundingClientRect().height;
      country.style.maxHeight = Math.floor(primaryHeight) + 'px';
    }

    function updateLiveViewTitle() {
      const textEl = document.getElementById('table-title-text');
      const iconEl = document.getElementById('live-view-spy-icon');
      if (!textEl) return;
      const labels = { today: 'Spy View', yesterday: 'Yesterday', '3d': '3 Days', '7d': '7 Days' };
      textEl.textContent = labels[dateRange] || 'Spy View';
      if (iconEl) iconEl.style.display = dateRange === 'today' ? 'inline-flex' : 'none';
    }

    function applyRangeAvailable(available) {
      const sel = document.getElementById('global-date-select');
      if (!sel) return;
      const opts = sel.querySelectorAll('option');
      const keys = ['today', 'yesterday', '3d', '7d'];
      keys.forEach((key, i) => {
        if (opts[i]) opts[i].disabled = !available[key];
      });
      if (!available[dateRange]) {
        dateRange = 'today';
        sel.value = 'today';
      }
      updateLiveViewTitle();
    }

    function renderStats(data) {
      const prevConverted = (statsCache.convertedCount || {}).today;
      statsCache = data || {};
      const conv = statsCache.convertedCount || {};
      if (typeof conv.today === 'number' && typeof lastConvertedCountToday === 'number' && conv.today > lastConvertedCountToday && !saleMuted && saleAudio) {
        saleAudio.currentTime = 0;
        saleAudio.play().catch(function() {});
      }
      lastConvertedCountToday = typeof conv.today === 'number' ? conv.today : 0;
      if (statsCache.rangeAvailable) applyRangeAvailable(statsCache.rangeAvailable);
      renderSales(statsCache);
      renderConversion(statsCache);
      renderAov(statsCache);
      renderCountry(statsCache);
      requestAnimationFrame(syncCountryTableHeight);
    }

    function fetchStats() {
      var overlay = document.getElementById('stats-loading-overlay');
      if (overlay) overlay.style.display = 'flex';
      var url = API + '/api/stats';
      if (trafficMode === 'human') url += '?traffic=human';
      fetch(url, { credentials: 'same-origin' })
        .then(r => r.json())
        .then(data => {
          nextStatsAt = Date.now() + STATS_INTERVAL_MS;
          lastUpdateTime = new Date();
          updateServerTimeDisplay();
          renderStats(data);
          fetchShopifySales();
        })
        .catch(() => { nextStatsAt = Date.now() + STATS_INTERVAL_MS; shopifySalesToday = null; renderStats({}); })
        .finally(function() { if (overlay) overlay.style.display = 'none'; });
    }

    function sessionIdsEqual(a, b) {
      if (!a && !b) return true;
      if (!a || !b || a.length !== b.length) return false;
      for (var i = 0; i < a.length; i++) if (a[i].session_id !== b[i].session_id) return false;
      return true;
    }

    function fetchSessions() {
      var overlay = document.getElementById('sessions-loading-overlay');
      if (overlay) overlay.style.display = 'flex';
      fetch(API + '/api/sessions?filter=' + filter + '&_=' + Date.now())
        .then(r => r.json())
        .then(data => {
          var next = data.sessions || [];
          next.sort(function(a, b) { return (b.last_seen || 0) - (a.last_seen || 0); });
          var listChanged = !sessionIdsEqual(sessions, next);
          sessions = next;
          if (listChanged) currentPage = 1;
          lastUpdateTime = new Date();
          updateServerTimeDisplay();
          renderTable();
          updateKpis();
        })
        .catch(() => { sessions = []; currentPage = 1; renderTable(); })
        .finally(function() { if (overlay) overlay.style.display = 'none'; });
    }

    function updateKpis() {
      const active = sessions.filter(s => s.last_seen >= Date.now() - 5 * 60 * 1000).length;
      const el = document.getElementById('online-count');
      if (el) el.textContent = active;
    }

    function openSidePanel(sessionId) {
      const panel = document.getElementById('side-panel');
      panel.style.display = 'block';
      document.getElementById('side-meta').textContent = 'Loading\u2026';
      document.getElementById('side-events').innerHTML = '';
      fetch(API + '/api/sessions/' + encodeURIComponent(sessionId) + '/events?limit=20')
        .then(r => r.json())
        .then(data => {
          const session = sessions.find(s => s.session_id === sessionId) || {};
          const saleBlock = session.has_purchased
            ? '<div class="side-panel-sale"><strong>Sale</strong><br>Order: ' + escapeHtml(formatMoney(session.order_total, session.order_currency) || '\u2014') + '<br>' + (session.purchased_at ? 'Purchased: ' + formatTs(session.purchased_at) + '<br>' : '') + '</div>'
            : '';
          document.getElementById('side-meta').innerHTML = `
            Session: ${escapeHtml(sessionId)}<br>
            Visitor: ${escapeHtml(session.visitor_id || '')}<br>
            Started: ${formatTs(session.started_at)}<br>
            Last seen: ${formatTs(session.last_seen)}<br>
            Cart qty: ${session.cart_qty ?? 0}<br>
            ${saleBlock}
            Events: ${(data.events || []).length}
          `;
          const mainBase = getMainBaseUrl();
          const eventList = (data.events || []).filter(e => e.type !== 'heartbeat').reverse();
          const events = eventList.map(e => {
            var path = (e.path || '').trim();
            if (!path && e.product_handle) path = '/products/' + (e.product_handle || '');
            if (path && !path.startsWith('/')) path = '/' + path;
            var fullUrl = mainBase && path ? mainBase + path : '';
            var thumb = fullUrl ? '<span class="thumb-card"><img src="' + (API || '') + '/api/og-thumb?url=' + encodeURIComponent(fullUrl) + '" alt="" onerror="this.parentElement&&(this.parentElement.style.display=\'none\')"></span>' : '';
            var text = formatTs(e.ts) + ' ' + escapeHtml(e.type) + ' ' + escapeHtml(e.path || '') + ' ' + (e.product_handle || '') + (e.qty_delta != null ? ' \u0394' + e.qty_delta : '');
            return '<li>' + thumb + '<span>' + text + '</span></li>';
          }).join('');
          document.getElementById('side-events').innerHTML = events || '<li>No events</li>';
        })
        .catch(() => {
          document.getElementById('side-meta').textContent = 'Failed to load.';
        });
    }

    document.getElementById('side-close').addEventListener('click', () => {
      document.getElementById('side-panel').style.display = 'none';
    });

    document.getElementById('pagination-prev').addEventListener('click', function() {
      if (currentPage > 1) { currentPage--; renderTable(); }
    });
    document.getElementById('pagination-next').addEventListener('click', function() {
      const totalPages = Math.max(1, Math.ceil(sessions.length / ROWS_PER_PAGE));
      if (currentPage < totalPages) { currentPage++; renderTable(); }
    });

    setupSortableHeaders();

    const trackingBtn = document.getElementById('tracking-btn');
    if (trackingBtn) {
      trackingBtn.addEventListener('click', () => {
        const enabled = trackingBtn.classList.contains('off');
        fetch(API + '/api/settings/tracking', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ enabled }),
        })
          .then(r => r.json())
          .then(data => {
            trackingBtn.textContent = data.enabled ? 'Tracking ON' : 'Tracking OFF';
            trackingBtn.classList.toggle('off', !data.enabled);
            const label = document.getElementById('tracking-label');
            if (label) label.textContent = data.enabled ? 'Tracking is on.' : 'Tracking is off (ingest returns 204).';
          })
          .catch(() => {});
      });
    }

    fetch(API + '/api/config-status')
      .then(r => r.json())
      .then(c => {
        let html = '';
        html += '<div class="config-row ' + (c.shopify?.configured ? 'ok' : 'missing') + '">' + (c.shopify?.configured ? 'âœ…' : 'âŒ') + ' Shopify API</div>';
        html += '<div class="config-row ' + (c.appUrl?.configured ? 'ok' : 'missing') + '">' + (c.appUrl?.configured ? 'âœ…' : 'âŒ') + ' App URL</div>';
        html += '<div class="config-row ' + (c.ingestSecret?.configured ? 'ok' : 'missing') + '">' + (c.ingestSecret?.configured ? 'âœ…' : 'âŒ') + ' Ingest secret</div>';
        html += '<div class="config-row">Ingest URL: ' + escapeHtml(c.ingestUrl || '') + '</div>';
        html += '<div class="config-row">Tracking: ' + (c.trackingEnabled ? 'ON' : 'OFF') + '</div>';
        html += '<div class="config-row ' + (c.sentry?.configured ? 'ok' : 'missing') + '">' + (c.sentry?.configured ? 'âœ…' : 'âŒ') + ' Sentry</div>';
        const configStatusEl = document.getElementById('config-status');
        if (configStatusEl) configStatusEl.innerHTML = html;
        const tb = document.getElementById('tracking-btn');
        const tl = document.getElementById('tracking-label');
        if (tb) { tb.textContent = c.trackingEnabled ? 'Tracking ON' : 'Tracking OFF'; tb.classList.toggle('off', !c.trackingEnabled); }
        if (tl) tl.textContent = c.trackingEnabled ? 'Tracking is on.' : 'Tracking is off.';
      })
      .catch(() => {
        const configStatusEl = document.getElementById('config-status');
        if (configStatusEl) configStatusEl.innerHTML = '<div class="config-row missing">Could not load config status.</div>';
      });

    (function initTopBar() {
      saleMuted = sessionStorage.getItem(SALE_MUTED_KEY) === 'true';
      saleAudio = new Audio(getAssetsBase() + '/cash-register.mp3');
      const muteBtn = document.getElementById('audio-mute-btn');
      const iconOn = muteBtn && muteBtn.querySelector('.sound-icon-on');
      const iconOff = muteBtn && muteBtn.querySelector('.sound-icon-off');
      if (muteBtn) {
        if (iconOn) iconOn.style.display = saleMuted ? 'none' : 'block';
        if (iconOff) iconOff.style.display = saleMuted ? 'block' : 'none';
        muteBtn.classList.toggle('muted', saleMuted);
        muteBtn.addEventListener('click', function() {
          saleMuted = !saleMuted;
          sessionStorage.setItem(SALE_MUTED_KEY, String(saleMuted));
          if (iconOn) iconOn.style.display = saleMuted ? 'none' : 'block';
          if (iconOff) iconOff.style.display = saleMuted ? 'block' : 'none';
          muteBtn.classList.toggle('muted', saleMuted);
        });
      }
      // Test sale sound: add ?cha=ching to the URL. Plays once when sound is on; if autoplay blocked, plays on first click.
      (function testChaChing() {
        if (new URLSearchParams(window.location.search).get('cha') !== 'ching' || !saleAudio) return;
        function playTest() {
          if (saleMuted) return;
          saleAudio.currentTime = 0;
          saleAudio.play().catch(function() {});
        }
        playTest();
        document.body.addEventListener('click', function once() {
          document.body.removeEventListener('click', once);
          playTest();
        }, { once: true });
      })();
      const dateSelect = document.getElementById('global-date-select');
      if (dateSelect) {
        dateSelect.value = dateRange;
        updateLiveViewTitle();
        dateSelect.addEventListener('change', function() {
          dateRange = this.value;
          if (dateRange !== 'today') shopifySalesToday = null;
          updateLiveViewTitle();
          renderStats(statsCache);
          if (dateRange === 'today') fetchShopifySales();
        });
      }
      (function initTrafficToggle() {
        const allLink = document.getElementById('traffic-all');
        const humanLink = document.getElementById('traffic-human');
        function setActive() {
          if (allLink) allLink.classList.toggle('active', trafficMode === 'all');
          if (humanLink) humanLink.classList.toggle('active', trafficMode === 'human');
        }
        setActive();
        if (allLink) allLink.addEventListener('click', function(e) { e.preventDefault(); trafficMode = 'all'; setActive(); fetchStats(); });
        if (humanLink) humanLink.addEventListener('click', function(e) { e.preventDefault(); trafficMode = 'human'; setActive(); fetchStats(); });
      })();
      (function initRefreshBtn() {
        const btn = document.getElementById('refresh-btn');
        if (btn) {
          btn.addEventListener('click', function() {
            btn.classList.add('spinning');
            setTimeout(function() { btn.classList.remove('spinning'); }, 800);
            fetchStats();
            fetchSessions();
          });
        }
      })();
      updateServerTimeDisplay();
      setInterval(function() {
        updateServerTimeDisplay();
        const el = document.getElementById('next-update-msg');
        if (!el) return;
        const sec = Math.max(0, Math.ceil((nextStatsAt - Date.now()) / 1000));
        el.textContent = sec + ' s';
      }, 1000);
    })();
    window.addEventListener('resize', syncCountryTableHeight);

    function onMinuteTick() {
      fetchStats();
      fetchSessions();
    }
    onMinuteTick();
    setInterval(onMinuteTick, STATS_INTERVAL_MS);
    setInterval(tickTimeOnSite, 30000);

    document.addEventListener('visibilitychange', function() {
      if (document.visibilityState === 'visible') { fetchSessions(); fetchStats(); }
    });

    const es = new EventSource(API + '/api/stream');
    es.onmessage = (e) => {
      try {
        const msg = JSON.parse(e.data);
        if (msg.type === 'session_update' && msg.session) {
          const idx = sessions.findIndex(s => s.session_id === msg.session.session_id);
          if (idx >= 0) {
            sessions[idx] = { ...sessions[idx], ...msg.session };
            sessions.sort(function(a, b) { return (b.last_seen || 0) - (a.last_seen || 0); });
          } else {
            sessions.unshift(msg.session);
            sessions.sort(function(a, b) { return (b.last_seen || 0) - (a.last_seen || 0); });
          }
          // Table and KPIs only update on manual refresh or on the minute (see fetchSessions interval)
        }
      } catch (_) {}
    };
  </script>
</body>
</html>
