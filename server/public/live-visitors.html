<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="robots" content="noindex, nofollow" />
  <link rel="icon" type="image/png" href="https://cdn.shopify.com/s/files/1/0847/7261/8587/files/favicon_e309db0f-dddb-48bf-83f4-a602cc9834d6.png" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <title>Birdseye Tracker</title>
  <style>
    :root {
      --bg: #fafafa;
      --card: #fff;
      --text: #333;
      --muted: #555;
      --accent: #0d9488;
      --border: #e5e5e5;
      --shadow: 0 1px 4px rgba(0, 0, 0, .06);
      --radius: 6px;
      --th-bg: #f8f8f8;
      --row-hover: #f5f5f5;
      --converted-bg: #edf4f3;
      --converted-hover: #edf4f3;
      --returning-bg: #fff;
      --badge-new-fg: #fff;
      --badge-returning: #6366f1;
      --chip-abandoned: #dc2626;
      --side-panel-shadow: -4px 0 24px rgba(0, 0, 0, .08);
      --side-panel-sale-bg: rgba(13, 148, 136, 0.08);
      --button-hover-bg: #f0f0f0;
      --select-arrow: #333;
      /* Table: universal — one gap, one padding, one font stack for all tables at all resolutions */
      --table-gap: 15px;
      --table-cell-padding-y: 0.6rem;
      --table-cell-padding-x: 0.8rem;
      --table-font-size: 12px;
      --table-th-font-size: 13px;
      --table-header-font-size: 14px;
      --table-row-border: 1px solid var(--border);
      --online-dot-color: #4caf50;
      --link-fg: #222;
      --top-bar-divider: #eee;
    }
    * { box-sizing: border-box; }
    body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 0; min-height: 100vh; line-height: 1.5; }
    /* SVG icons: keep a consistent icon colour (match footer icons). */
    svg { color: var(--text); }
    /* Let interactive elements tint icons via their own `color` (hover/active/focus). */
    button:hover svg,
    button:focus-visible svg,
    a:hover svg,
    a:focus-visible svg,
    [role="tab"]:hover svg,
    [role="tab"][aria-selected="true"] svg { color: inherit; }
    .main { padding: 24px; margin: 0 auto; max-width: 1600px; }
    .stats-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: var(--table-gap); margin-bottom: 1.5rem; align-items: start; }
    .stats-row.breakdown-row { grid-template-columns: repeat(2, 1fr); align-items: stretch; }
    /* Products tab has 4 cards; keep a balanced 2x2 grid on wide screens. */
    @media (min-width: 1801px) {
      #tab-panel-products .stats-row { grid-template-columns: 1fr 1fr; }
    }
    .traffic-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--table-gap); margin-bottom: 1.5rem; align-items: start; }
    @media (max-width: 768px) { .traffic-grid { grid-template-columns: 1fr; } }
    .stats-card { background: var(--card); padding: 0; border-radius: var(--radius); border: 1px solid var(--border); box-shadow: var(--shadow); min-width: 0; box-sizing: border-box; margin-right: -1px; }
    .stats-card:last-child { margin-right: 0; }
    #stats-country, #stats-best-geo-products, #stats-best-sellers, #stats-worst-products, #stats-best-variants, #stats-worst-variants, #stats-aov { display: flex; flex-direction: column; }
    .traffic-card-header { display: flex; align-items: center; justify-content: space-between; gap: 0.5rem; padding: var(--table-cell-padding-y) var(--table-cell-padding-x); background: var(--th-bg); border-bottom: var(--table-row-border); }
    .traffic-card-title { margin: 0; font-size: var(--table-th-font-size); font-weight: 600; color: var(--muted); text-transform: uppercase; letter-spacing: 0.04em; line-height: 1.4; }
    .traffic-picker-list { display: flex; flex-direction: column; gap: 0.25rem; }
    .traffic-picker-item { display: flex; align-items: center; gap: 0.5rem; padding: 0.15rem 0; font-size: 0.8125rem; }
    .traffic-picker-item input { width: 16px; height: 16px; }
    .traffic-picker-meta { margin-left: auto; font-size: 0.75rem; color: var(--muted); }
    /* Traffic Type: device -> platform expandable tree */
    .traffic-type-toggle { display: inline-flex; align-items: center; gap: 0.35rem; border: none; background: none; padding: 0; margin: 0; cursor: pointer; color: var(--link-fg); font: inherit; font-size: var(--table-font-size); font-weight: 600; }
    .traffic-type-toggle:hover { color: var(--accent); }
    .traffic-type-toggle .chev { width: 12px; height: 12px; display: inline-flex; align-items: center; justify-content: center; color: var(--muted); }
    .traffic-type-toggle .chev::before { content: '▸'; line-height: 1; }
    .traffic-type-toggle[aria-expanded="true"] .chev::before { content: '▾'; }
    .traffic-type-parent td:first-child { white-space: nowrap; }
    .traffic-type-child td:first-child { padding-left: calc(var(--table-cell-padding-x) + 18px); }
    .traffic-type-child td:first-child::before { content: '›'; display: inline-block; margin-right: 6px; color: var(--muted); }
    /* Single thead row: title in first cell, column labels in rest; one line */
    .stats-card .by-country-table thead th { white-space: nowrap; margin: 0; padding: var(--table-cell-padding-y) var(--table-cell-padding-x); font-size: var(--table-th-font-size); font-weight: 600; color: var(--muted); text-transform: uppercase; letter-spacing: 0.04em; line-height: 1.4; text-align: left; background: var(--th-bg); border-bottom: var(--table-row-border); }
    /* When a card already has a header bar, keep only that bar grey (table thead stays white). */
    .stats-card .traffic-card-header + .country-table-wrap .by-country-table thead th { background: var(--card); }
    .stats-section { display: flex; flex-direction: column; gap: 1px; }
    .stats-main { font-size: 1.5rem; font-weight: 700; color: var(--accent); letter-spacing: -0.02em; }
    .stats-breakdown { font-size: 0.8125rem; color: var(--text); display: flex; flex-wrap: wrap; gap: 0.75rem; }
    .stats-breakdown span { display: inline-block; }
    .stats-divider { height: 1px; /* background: var(--border); */ margin: 0.6rem 0; }
    .stats-select { padding: 0.35rem 0.5rem; border: 1px solid var(--border); border-radius: var(--radius); background: var(--card); color: var(--text); font-size: 0.8125rem; }
    .muted { color: var(--muted); font-size: 0.8rem; }
    .country-table-wrap { overflow-y: auto; overflow-x: hidden; flex: 1; min-height: 0; margin-bottom: 0.75rem; }
    /* Breakdown tables: same border, shadow, radius as Live table; same padding/th style */
    .by-country-table { width: 100%; border-collapse: collapse; font-size: var(--table-font-size); table-layout: fixed; border: 1px solid var(--border); box-shadow: var(--shadow); border-radius: var(--radius); overflow: hidden; }
    .by-country-table th, .by-country-table td { padding: var(--table-cell-padding-y) var(--table-cell-padding-x); border-bottom: none; line-height: 1.4; }
    .by-country-table tr:last-child td { border-bottom: none; }
    .by-country-table tbody tr { box-shadow: none; }
    .by-country-table tbody tr:last-child { box-shadow: none; }
    .by-country-table tbody td { border-bottom: none !important; }
    .stats-card .by-country-table th:first-child, .stats-card .by-country-table td:first-child { padding-left: var(--table-cell-padding-x); padding-right: var(--table-cell-padding-x); min-width: 0; width: 32%; }
    .stats-card .by-country-table th:not(:first-child), .stats-card .by-country-table td:not(:first-child) { text-align: center; min-width: 4rem; white-space: nowrap; }
    .stats-card .by-country-table th:last-child, .stats-card .by-country-table td:last-child { padding-right: var(--table-cell-padding-x); min-width: 5rem; }
    .by-country-table th { font-size: var(--table-th-font-size); color: var(--muted); font-weight: 600; text-transform: uppercase; letter-spacing: 0.04em; background: var(--th-bg); }
    /* Table header abbreviations/icons on small screens (avoid overlaps). */
    .th-label-long { display: inline; }
    .th-label-short { display: none; align-items: center; justify-content: center; gap: 0.25rem; line-height: 1; }
    .th-label-short svg { width: 16px; height: 16px; display: block; }
    @media (max-width: 768px) {
      .th-label-long { display: none; }
      .th-label-short { display: inline-flex; }
      .by-country-table th.th-sort-asc::after,
      .by-country-table th.th-sort-desc::after { margin: -10px 0 0 0; }
    }
    /* First column layout: keep td as table-cell (zebra striping), flex inside wrapper. */
    .by-country-table:not(.best-sellers-table) tbody td:first-child { min-width: 0; }
    .by-country-table:not(.best-sellers-table) tbody td:first-child .country-cell { display: flex; align-items: center; gap: 0.6rem; min-width: 0; }
    .by-country-table:not(.best-sellers-table) tbody td:first-child .country-cell > *:first-child { flex-shrink: 0; }
    .by-country-table tbody td:first-child .country-label { flex: 1; min-width: 3em; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    /* Best GEO Products: flag + product thumb only. */
    .geo-products-table tbody td:first-child .country-label { flex: 0 0 auto; white-space: normal; text-overflow: clip; display: inline-flex; align-items: center; margin-left: 0; border: 2px solid transparent; border-radius: 100px; background: transparent; }
    .geo-products-table .geo-product-thumb { width: 32px; height: 32px; overflow: hidden; border: 1px solid var(--border); display: inline-flex; align-items: center; justify-content: center; background: transparent; border-radius: 100px; }
    .geo-products-table .geo-product-thumb img { width: 100%; height: 100%; object-fit: cover; display: block; border-radius: 100px; }
    .geo-products-table .geo-product-thumb-placeholder { width: 100%; height: 100%; background: var(--border); display: block; }
    .by-country-table.aov-table .country-label { overflow: visible; text-overflow: clip; white-space: normal; word-break: break-word; }
    .by-country-table.aov-table { table-layout: fixed; }
    .stats-card .by-country-table.aov-table th:first-child,
    .stats-card .by-country-table.aov-table td:first-child { width: 70%; }
    .stats-card .by-country-table.aov-table th:last-child,
    .stats-card .by-country-table.aov-table td:last-child { width: 30%; min-width: 5.5rem; }
    .by-country-table .country-name { display: inline; }
    .by-country-table .country-code { display: none; }
    .by-country-table .flag-img { width: 26px; height: 20px; object-fit: cover; border-radius: 4px; flex-shrink: 0; }
    .best-sellers-table .bs-product-col { min-width: 200px; width: auto; max-width: none; }
    .stats-card #stats-best-sellers .by-country-table th:first-child,
    .stats-card #stats-best-sellers .by-country-table td:first-child,
    .stats-card #stats-worst-products .by-country-table th:first-child,
    .stats-card #stats-worst-products .by-country-table td:first-child,
    .stats-card #stats-best-variants .by-country-table th:first-child,
    .stats-card #stats-best-variants .by-country-table td:first-child,
    .stats-card #stats-worst-variants .by-country-table th:first-child,
    .stats-card #stats-worst-variants .by-country-table td:first-child { width: 62%; min-width: 220px; }

    /* Product tables: allow numeric cols to shrink so names can breathe. */
    .stats-card .by-country-table.best-sellers-table th:not(:first-child),
    .stats-card .by-country-table.best-sellers-table td:not(:first-child) { min-width: 3.25rem; }
    .stats-card .by-country-table.best-sellers-table th:last-child,
    .stats-card .by-country-table.best-sellers-table td:last-child { min-width: 4rem; }
    /* Product name visibility: keep a stable width so text never collapses to 0 on wide screens. */
    .best-sellers-table .product-cell { display: flex; align-items: center; gap: 0.6rem; min-width: 0; width: 100%; }
    .best-sellers-table .product-cell a { display: inline-block; text-decoration: none; flex-shrink: 0; }
    /* Product thumbnails: shared styling (prevents "thin line" aspect ratios). */
    .bs-thumb, .landing-thumb { border-radius: 100%; object-fit: cover; object-position: center; flex-shrink: 0; display: block; }
    .best-sellers-table .product-cell .bs-thumb { width: 36px; height: 36px; min-width: 36px; min-height: 36px; }
    .best-sellers-table .product-cell .bs-name {
      flex: 1;
      min-width: 0;
      overflow: hidden;
      display: block;
      white-space: nowrap;
      text-overflow: ellipsis;
      line-height: 1.2;
      font-weight: 400;
      font-size: var(--table-font-size);
    }
    .best-sellers-table .bs-thumb-placeholder { display: inline-block; width: 36px; height: 36px; background: var(--border); border-radius: 100%; }
    .by-country-table th.sortable { cursor: pointer; user-select: none; }
    .by-country-table th.sortable:hover { color: var(--accent); }
    .by-country-table th.th-sort-asc::after,
    .by-country-table th.th-sort-desc::after { content: ''; display: inline-block; width: 16px; height: 16px; margin-left: 1px; vertical-align: middle; background-color: currentColor; -webkit-mask-size: contain; -webkit-mask-repeat: no-repeat; -webkit-mask-position: center; mask-size: contain; mask-repeat: no-repeat; mask-position: center; }
    .by-country-table th.th-sort-asc::after { -webkit-mask-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 24 24' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M7 14.5L12 9.5L17 14.5' stroke='black' stroke-linecap='round' stroke-linejoin='round' stroke-width='2'/%3E%3C/svg%3E"); mask-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 24 24' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M7 14.5L12 9.5L17 14.5' stroke='black' stroke-linecap='round' stroke-linejoin='round' stroke-width='2'/%3E%3C/svg%3E"); }
    .by-country-table th.th-sort-desc::after { -webkit-mask-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 24 24' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M17 9.5L12 14.5L7 9.5' stroke='black' stroke-linecap='round' stroke-linejoin='round' stroke-width='2'/%3E%3C/svg%3E"); mask-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 24 24' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M17 9.5L12 14.5L7 9.5' stroke='black' stroke-linecap='round' stroke-linejoin='round' stroke-width='2'/%3E%3C/svg%3E"); }

    /* Medium screens */
    @media (max-width: 1200px) {
      .aov-cards-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
      .stats-card #stats-best-sellers .by-country-table th:first-child,
      .stats-card #stats-best-sellers .by-country-table td:first-child,
      .stats-card #stats-worst-products .by-country-table th:first-child,
      .stats-card #stats-worst-products .by-country-table td:first-child,
      .stats-card #stats-best-variants .by-country-table th:first-child,
      .stats-card #stats-best-variants .by-country-table td:first-child,
      .stats-card #stats-worst-variants .by-country-table th:first-child,
      .stats-card #stats-worst-variants .by-country-table td:first-child { width: 58%; min-width: 200px; }

      .stats-card .by-country-table.best-sellers-table th:not(:first-child),
      .stats-card .by-country-table.best-sellers-table td:not(:first-child) { min-width: 3rem; }
      .stats-card .by-country-table.best-sellers-table th:last-child,
      .stats-card .by-country-table.best-sellers-table td:last-child { min-width: 3.6rem; }
    }
    .aov-cards-wrap { margin-bottom: 1rem; }
    .aov-cards-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem; }
    .aov-cards-title { font-size: var(--table-header-font-size); font-weight: 600; color: var(--text); }
    .aov-cards-grid { display: grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap: var(--table-gap); }
    .aov-card { padding: 0.6rem 0.8rem; box-shadow: 2px 2px 2px #eee; display: flex; align-items: center; justify-content: space-between; gap: 0.6rem; min-width: 0; background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); }
    .aov-card-left { display: inline-flex; align-items: center; gap: 0.5rem; min-width: 0; }
    .aov-card-name { font-size: 0.85rem; font-weight: 500; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .aov-card-value { font-size: 0.9rem; font-weight: 600; color: var(--text); white-space: nowrap; }
    .aov-card-empty { justify-content: center; color: var(--muted); }
    table { width: 100%; border-collapse: collapse; background: var(--card); border-radius: var(--radius); overflow: hidden; border: 1px solid var(--border); box-shadow: var(--shadow); }
    th, td { padding: var(--table-cell-padding-y) var(--table-cell-padding-x); text-align: left; border-bottom: none; vertical-align: middle; font-size: var(--table-font-size); line-height: 1.4; }
    tr:last-child td { border-bottom: none; }
    th:not(:first-child), td:not(:first-child) { text-align: center; }
    th { background: var(--th-bg); font-size: var(--table-th-font-size); color: var(--muted); font-weight: 600; text-transform: uppercase; letter-spacing: 0.04em; }
    th:first-child, td:first-child { min-width: 80px; padding-left: var(--table-cell-padding-x); }
    tr:hover { background: inherit; }
    table tbody tr:nth-child(odd) td { background: #ffffff; }
    table tbody tr:nth-child(even) td { background: #f8f8f8; }
    tr.returning { background: var(--returning-bg); }
    tr.returning td { background: var(--returning-bg); }
    tr.converted { background: var(--converted-bg); }
    tr.converted td { background: var(--converted-bg); }
    tr.converted:hover { background: var(--converted-bg); }
    .rev-decimal { font-size: 0.75em; opacity: 0.7; vertical-align: top; }
    tr.converted td { font-weight: 500; }
    /* Converted: show a bold left-side accent at the table edge. */
    #sessions-table tr.converted { position: relative; }
    #sessions-table tr.converted::before { content: ''; position: absolute; left: -1px; top: 0; bottom: 0; width: 3px; background: var(--accent); }
    tr.clickable { cursor: pointer; }
    .flag-cell { white-space: nowrap; }
    .arrived-cell, .last-seen-cell { font-size: var(--table-font-size); white-space: nowrap; }
    .flag-img { width: 26px; height: 20px; object-fit: cover; border-radius: 4px; margin-right: 0.35rem; vertical-align: middle; display: inline-block; }
    .last-action-cell { display: flex; align-items: center; gap: 0.5rem; }
    .last-action-cell a { color: var(--link-fg); text-decoration: none; font-size: var(--table-font-size); font-weight: 400; }
.last-action-cell a:hover { text-decoration: underline; }
.last-action-cell.dual { align-items: flex-start; }
.last-action-cell .landing-lines { display: flex; flex-direction: column; /* gap: 0.15rem; */ min-width: 0; margin: 15px 0 0; }
.last-action-cell .landing-lines > * { min-width: 0; }
.last-action-cell .landing-line { display: grid; grid-template-columns: 14px minmax(0, 1fr); align-items: center; gap: 0.35rem; font-size: var(--table-font-size); font-weight: 500; line-height: 1.15; color: var(--link-fg); }
.last-action-cell .landing-line-text { min-width: 0; word-break: break-word; }
    .last-action-cell .landing-dir-icon { width: 14px; height: 14px; display: inline-block; }
    .last-action-cell .landing-dir-icon-entry { color: #0d9488; }
    .last-action-cell .landing-dir-icon-exit { color: #940d0d; }
.last-action-cell .landing-line:hover { text-decoration: underline; }
.sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border: 0; }
.landing-fallback-hint { font-size: 0.75rem; color: var(--muted); font-weight: normal; }
    .landing-thumb { width: 50px; height: 50px; min-width: 50px; min-height: 50px; }
    .table-scroll-wrap .last-action-cell .landing-thumb { width: 50px; height: 50px; min-width: 50px; min-height: 50px; border: 1px solid #e1e1e1; padding: 3px; }
    .thumb-wrap { position: relative; display: inline-block; flex-shrink: 0; }
.thumb-wrap.thumb-stack { display: inline-flex; align-items: center; }
.thumb-wrap.thumb-stack .landing-thumb { position: relative; }
.thumb-wrap.thumb-stack .landing-thumb + .landing-thumb { margin: 20px 0 0 -20px; box-sizing: content-box; z-index: 2; background: #fff; border: 0; }
.thumb-wrap.thumb-stack .landing-thumb:first-child { z-index: 1; }
.thumb-wrap.thumb-stack .landing-thumb-exit { width: 36px; height: 36px; min-width: 36px; min-height: 36px; }

.thumb-overlay {
    display: none !important;
}

.thumb-overlay img,
.thumb-overlay svg {
    width: 25px;
    height: 25px;
    display: block;
    padding: 2px;
    position: relative;
}
.thumb-overlay svg { color: var(--accent); }
.table-title { font-size: var(--table-header-font-size); font-weight: 600; color: var(--text); margin-bottom: 0.5rem; }
    .badge { display: inline-block; padding: 0.15rem 0.4rem; border-radius: var(--radius); font-size: 0.75rem; }
    .badge.new { background: var(--accent); color: var(--badge-new-fg); }
    .badge.returning { background: var(--badge-returning); color: var(--badge-new-fg); }
    .chip { display: inline-block; padding: 0.1rem 0.35rem; border-radius: var(--radius); font-size: 0.7rem; margin-right: 0.25rem; }
    .chip.checking-out { background: var(--accent); color: var(--badge-new-fg); }
    .chip.abandoned { background: var(--chip-abandoned); color: var(--badge-new-fg); }
    .side-panel { position: fixed; top: 0; right: 0; width: 400px; max-width: 100%; height: 100%; background: var(--card); border-left: 1px solid var(--border); box-shadow: var(--side-panel-shadow); overflow-y: auto; z-index: 10; padding: 1.5rem; }
    .side-panel-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border); }
    .side-panel-title { margin: 0; font-size: 1.125rem; font-weight: 600; color: var(--text); letter-spacing: -0.02em; }
    .side-panel-close { display: inline-flex; align-items: center; justify-content: center; width: 36px; height: 36px; padding: 0; border: none; border-radius: var(--radius); background: transparent; color: var(--muted); cursor: pointer; }
    .side-panel-close:hover { color: var(--text); background: rgba(0,0,0,0.06); }
    .side-panel-close svg { width: 20px; height: 20px; }
    .side-panel-section { margin-bottom: 1.5rem; }
    .side-panel-section:last-child { margin-bottom: 0; }
    .side-panel-section-title { display: flex; align-items: center; gap: 0.5rem; margin: 0 0 0.5rem; font-size: 0.6875rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.06em; color: var(--muted); }
    .side-panel-icon { width: 16px; height: 16px; flex-shrink: 0; }
    .side-panel-events { list-style: none; padding: 0; margin: 0; font-size: 0.8125rem; line-height: 1.45; }
    .side-panel-events li { display: flex; align-items: center; gap: 0.625rem; padding: 0.5rem 0; border-bottom: 1px solid var(--border); }
    .side-panel-events li:last-child { border-bottom: none; }
    .side-panel-events li .landing-thumb { flex-shrink: 0; }
    .side-panel-events li > span:last-child { flex: 1; min-width: 0; word-break: break-word; color: var(--text); }
    .side-panel-events li.muted { color: var(--muted); }
    .side-panel-meta { font-size: 0.8125rem; line-height: 1.5; }
    .side-panel-detail-row { display: flex; flex-wrap: wrap; gap: 0.25rem 0.5rem; padding: 0.375rem 0; border-bottom: 1px solid var(--border); }
    .side-panel-detail-row:last-child { border-bottom: none; }
    .side-panel-detail-row .side-panel-label { font-weight: 500; color: var(--muted); min-width: 5rem; }
    .side-panel-detail-row .side-panel-value { color: var(--text); word-break: break-word; }
    .side-panel-sale { margin-top: 0.75rem; padding: 0.875rem; background: var(--side-panel-sale-bg); border-radius: var(--radius); border-left: 3px solid var(--accent); font-size: 0.8125rem; line-height: 1.5; color: var(--text); }
    .side-panel-sale strong { color: var(--accent); font-weight: 600; }
    .side-panel-source { font-size: 0.8125rem; color: var(--text); word-break: break-all; white-space: pre-wrap; line-height: 1.5; }
    .side-panel-cf { font-size: 0.8125rem; line-height: 1.5; }
    .side-panel-cf-block { margin-bottom: 0.75rem; }
    .side-panel-cf-block:last-child { margin-bottom: 0; }
    .side-panel-cf-subtitle { margin: 0 0 0.25rem; font-size: 0.6875rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--muted); }
    .side-panel-cf .cf-row { padding: 0.25rem 0; word-break: break-word; color: var(--text); }
    .side-panel-cf .cf-row.empty { color: var(--muted); }
    .side-panel-cf .cf-row strong { font-weight: 500; color: var(--muted); margin-right: 0.35rem; }
    .empty { padding: 1.5rem 1rem; color: var(--muted); font-size: var(--table-font-size); }
    .consent-debug { font-size: 0.75rem; color: var(--muted); max-width: 200px; overflow: hidden; text-overflow: ellipsis; }
.dashboard-top-bar { display: flex; align-items: center; justify-content: space-between; padding: 10px 24px 0; margin: 0 auto; width: 100%; box-sizing: border-box; }
.mobile-brand-logo { display: none; width: 100%; justify-content: center; pointer-events: none; }
.mobile-brand-logo img { width: 80px; height: auto; display: block; }
.next-update-timer { display: inline-flex; align-items: center; justify-content: center; width: 18px; height: 18px; }
.next-update-timer .next-update-circle { display: block; }
.next-update-timer .next-update-circle-bg { opacity: 0.2; }
.next-update-timer .next-update-circle-progress { stroke: #0d9488; transition: stroke-dashoffset 0.3s linear; }
.server-time-block { font-size: 0.8125rem; color: var(--muted); white-space: nowrap; margin: 0 5px 0 0; }
.server-time-tz { font-size: 0.7rem; opacity: 0.9; margin-left: 0.2rem; }
.top-bar-divider { width: 1px; height: 1.2em; background: var(--top-bar-divider); flex-shrink: 0; }
.refresh-btn { display: inline-flex; align-items: center; justify-content: center; width: 15px; height: 15px; padding: 0; border: none; background: none; cursor: pointer; color: var(--text); }
.refresh-btn:hover { color: var(--accent); }
.refresh-btn:focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; }
.refresh-btn svg { width: 15px; height: 15px; }
.refresh-btn.spinning svg { animation: refresh-spin 0.8s linear; }
@keyframes refresh-spin { to { transform: rotate(360deg); } }
.top-bar-date-select { padding: 0.35rem 1.5rem 0.35rem 0.5rem; border: none; background: none; font-size: 0.875rem; font-weight: 500; color: var(--text); cursor: pointer; font-family: inherit; appearance: none; background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 24 24' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M17 9.5L12 14.5L7 9.5' stroke='%23666' stroke-linecap='round' stroke-linejoin='round' stroke-width='2'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 0.25rem center; background-size: 16px 16px; border-radius: var(--radius); }
.top-bar-date-select:hover { color: var(--accent); }
.top-bar-date-select:focus { outline: none; color: var(--accent); }
.top-bar-date-select option { color: var(--text); background: var(--card); }
.next-update-block { display: inline-flex; align-items: center; gap: 0.35rem; font-size: 0.875rem; color: var(--muted); }
.next-update-live-indicator { display: none; align-items: center; gap: 0.35rem; }
.live-pulse-dot { width: 10px; height: 10px; border-radius: 50%; background: var(--online-dot-color); animation: live-pulse 1.2s ease-in-out infinite; }
@keyframes live-pulse { 0% { transform: scale(0.85); opacity: 0.75; } 50% { transform: scale(1); opacity: 1; } 100% { transform: scale(0.85); opacity: 0.75; } }
.table-loading-overlay { position: absolute; inset: 0; background: rgba(255,255,255,0.7); display: flex; align-items: center; justify-content: center; border-radius: var(--radius); z-index: 2; }
.table-loading-overlay .spinner { width: 28px; height: 28px; border: 3px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: refresh-spin 0.8s linear infinite; }
.inline-spinner { width: 28px; height: 28px; border: 3px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: refresh-spin 0.8s linear infinite; display: inline-block; }
.report-loading-overlay { background: rgba(255,255,255,0.96); }
.report-build-wrap { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 0.35rem; padding: 1rem; text-align: center; }
.report-build-title { font-size: 0.95rem; font-weight: 700; color: var(--accent); letter-spacing: -0.1px; }
.report-build-step { font-size: 0.85rem; color: var(--muted); min-height: 1.2em; }
/* Tab switch: Home (main table) vs Breakdown (cards); date range shared on same row */
.main-tabs { display: flex; align-items: stretch; gap: 0; margin-bottom: 1rem; border-bottom: 1px solid var(--border); position: relative; }
.main-tabs [role="tab"] { display: inline-flex; align-items: center; gap: 0.35rem; padding: 0.5rem 1rem; font-size: 0.875rem; font-weight: 500; color: var(--muted); background: none; border: none; border-bottom: 2px solid transparent; margin-bottom: -1px; cursor: pointer; font-family: inherit; }
.main-tabs [role="tab"]:hover { color: var(--text); }
.main-tabs [role="tab"][aria-selected="true"] { color: var(--accent); border-bottom-color: var(--accent); }
.main-tabs [role="tab"] .tab-icon { width: 16px; height: 16px; display: inline-block; vertical-align: middle; }
.main-tabs [role="tab"] .tab-icon-home { width: 25px; height: 25px; object-fit: contain; }
.main-tabs [role="tab"] .tab-icon-home-swap { position: relative; width: 25px; height: 25px; display: inline-block; flex-shrink: 0; }
.main-tabs [role="tab"] .tab-icon-home-swap img { position: absolute; inset: 0; width: 25px; height: 25px; object-fit: contain; display: block; }
#tab-spy .tab-icon-home--inactive { opacity: 1; }
#tab-spy .tab-icon-home--active { opacity: 0; }
#tab-spy[aria-selected="true"] .tab-icon-home--inactive { opacity: 0; }
#tab-spy[aria-selected="true"] .tab-icon-home--active { opacity: 1; }
.main-tabs [role="tab"] .tab-text { display: inline; }
@media (min-width: 769px) { #tab-spy .tab-text { display: none; } }
.main-tabs-center-logo { display: none; position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); pointer-events: none; z-index: 2; }
.main-tabs-center-logo img { width: 30px; height: 30px; margin: 0 0 10px; display: block; object-fit: contain; }
.main-tabs-spacer { flex: 1; min-width: 0; }
.main-tabs-date-select { padding: 0.35rem 1.5rem 0.35rem 0.5rem; border: none; background: none; font-size: 0.875rem; font-weight: 500; color: var(--text); cursor: pointer; font-family: inherit; appearance: none; background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 24 24' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M17 9.5L12 14.5L7 9.5' stroke='%23666' stroke-linecap='round' stroke-linejoin='round' stroke-width='2'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 0.25rem center; background-size: 16px 16px; border-radius: var(--radius); margin-bottom: -1px; }
.main-tabs-date-select:hover { color: var(--accent); }
.main-tabs-date-select:focus { outline: none; color: var(--accent); }
.main-tabs-date-select option { color: var(--text); background: var(--card); }
.mobile-date-btn {
    display: none;
    align-items: center;
    justify-content: space-between;
    gap: 0.45rem;
    padding: 10px 0;
    border: none;
    border-radius: var(--radius);
    background: none;
    cursor: pointer;
    color: var(--text);
    font-size: 0.875rem;
    font-weight: 500;
    max-width: 80px;
    width: 80px;
    flex: 0 0 auto;
}
.mobile-date-btn:hover { color: var(--accent); }
.mobile-date-btn svg { width: 18px; height: 18px; display: block; flex-shrink: 0; }
.mobile-date-menu { display: none; position: absolute; right: 0; top: calc(100% + 6px); background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); box-shadow: var(--shadow); padding: 0.25rem; z-index: 50; min-width: 160px; }
.mobile-date-menu.open { display: block; }
.mobile-date-item { width: 100%; text-align: left; padding: 0.5rem 0.75rem; border: none; background: none; cursor: pointer; font-size: 0.875rem; color: var(--text); border-radius: var(--radius); font-family: inherit; }
.mobile-date-item:hover { background: var(--row-hover); }
.mobile-date-item[aria-current="true"] { background: rgba(13, 148, 136, 0.12); color: var(--accent); }
.mobile-tabs-btn {
    display: none;
    align-items: center;
    gap: 0.5rem;
    padding: 10px 0;
    border: none;
    border-radius: var(--radius);
    background: none;
    cursor: pointer;
    color: var(--text);
    font-size: 0.875rem;
    font-weight: 500;
}
.mobile-tabs-btn:hover { color: var(--accent); }
.mobile-tabs-btn svg { width: 18px; height: 18px; display: block; }
.mobile-tabs-menu { display: none; position: absolute; left: 0; top: calc(100% + 6px); background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); box-shadow: var(--shadow); padding: 0.25rem; z-index: 50; min-width: 180px; }
.mobile-tabs-menu.open { display: block; }
.mobile-tabs-item { width: 100%; text-align: left; padding: 0.5rem 0.75rem; border: none; background: none; cursor: pointer; font-size: 0.875rem; color: var(--text); border-radius: var(--radius); font-family: inherit; }
.mobile-tabs-item:hover { background: var(--row-hover); }
.mobile-tabs-item[aria-current="true"] { background: rgba(13, 148, 136, 0.12); color: var(--accent); }
@media (max-width: 768px) {
  .main-tabs { gap: 0.5rem; }
  .main-tabs [role="tab"] { display: none; }
  .mobile-tabs-btn { display: inline-flex; }
  .main-tabs-center-logo { display: block; }
  .main-tabs-date-select { display: none; }
  .mobile-date-btn { display: inline-flex; }
}
.main-tab-panel { display: none; }
.main-tab-panel.active { display: block; }
.stats-row-wrap { position: relative; }
.report-building .stats-row,
.report-building .traffic-grid { visibility: hidden; }
.sessions-table-wrap { position: relative; }
.live-kpi-grid { --kpi-gap: 1rem; display: grid; grid-template-columns: repeat(6, 1fr); gap: var(--kpi-gap); }
.live-kpi-cell { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); padding: 0.75rem 1rem; text-align: center; box-shadow: var(--shadow); }
    .live-kpi-cell .live-kpi-label { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.04em; color: #000; font-weight: 600; margin-bottom: 0.25rem; }
    .live-kpi-cell .live-kpi-value { font-size: 1.2rem; font-weight: 700; color: #444; line-height: 1.3; }
.kpi-mini-spinner { width: 14px; height: 14px; border: 2px solid rgba(13, 148, 136, 0.25); border-top-color: #0d9488; border-radius: 50%; animation: refresh-spin 0.8s linear infinite; display: inline-block; vertical-align: middle; }
.sale-toast-host { position: relative; overflow: visible; }
.sale-toast-host.toast-open { z-index: 10; }
.sale-toast { position: absolute; left: -1px; top: -1px; height: calc(100% + 2px); width: calc(200% + var(--kpi-gap) + 2px); border-radius: var(--radius); border: 1px solid #0d9488; background: #0d9488; box-shadow: var(--shadow); display: flex; align-items: stretch; gap: 0.75rem; padding: 0.65rem 2.25rem 0.65rem 0.75rem; opacity: 0; transform: translateY(6px); transition: opacity 240ms ease, transform 240ms ease; pointer-events: none; color: #fff; }
.sale-toast.active { opacity: 1; transform: translateY(0); }
.sale-toast .sale-toast-flag { display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
.sale-toast .sale-toast-flag .sale-toast-bird-icon { width: 42px; height: 100%; object-fit: contain; border-radius: 6px; margin: 0; }
.sale-toast .sale-toast-mid { flex: 1; min-width: 0; display: flex; flex-direction: column; justify-content: center; text-align: left; }
    .sale-toast .sale-toast-title { display: flex; align-items: center; gap: 0.35rem; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.04em; color: #fff; font-weight: 500; line-height: 1.1; }
.sale-toast .sale-toast-inline-flag-img { width: 14px; height: 10px; object-fit: cover; border-radius: 3px; display: block; flex-shrink: 0; }
    .sale-toast .sale-toast-product { font-size: 0.86rem; font-weight: 300; color: #fff; line-height: 1.25; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .sale-toast .sale-toast-amount-wrap { min-width: 90px; display: flex; align-items: center; justify-content: flex-end; background: #06655d; padding: 0 10px; border-radius: 0 4px 4px 0; }
    .sale-toast .sale-toast-amount { display: inline-flex; align-items: center; justify-content: flex-end; font-size: 1.05rem; font-weight: 800; color: #fff; letter-spacing: -0.2px; }
.sale-toast .sale-toast-close { position: absolute; top: 8px; right: 8px; width: 26px; height: 26px; border: 1px solid rgba(255, 255, 255, 0.22); background: rgba(255, 255, 255, 0.12); color: #fff; border-radius: 8px; padding: 0; display: inline-flex; align-items: center; justify-content: center; cursor: pointer; pointer-events: auto; }
.sale-toast .sale-toast-close:hover { background: rgba(255, 255, 255, 0.18); }
.sale-toast .sale-toast-close:active { transform: translateY(1px); }
.sale-toast .sale-toast-close:focus-visible { outline: 2px solid rgba(255, 255, 255, 0.6); outline-offset: 2px; }
.sale-toast .sale-toast-close svg { width: 16px; height: 16px; display: block; }
.kpi-ticker { display: inline-block; overflow: hidden; height: 1.15em; vertical-align: bottom; }
.kpi-ticker-stack { display: block; transform: translateY(0); transition: transform 420ms cubic-bezier(0.22, 1, 0.36, 1); }
.kpi-ticker-line { display: block; height: 1.15em; line-height: 1.15em; }
.kpi-ticker.run .kpi-ticker-stack { transform: translateY(-100%); }
.shared-kpi-wrap { margin-bottom: 1.25rem; }
    .kpi-mobile-pager { position: relative; }
    .kpi-mobile-pager.kpi-pager-active { padding-right: 44px; }
    .kpi-mobile-next {
      display: none;
      position: absolute;
      right: 0;
      top: 50%;
      transform: translateY(-50%);
      width: 36px;
      height: 36px;
      align-items: center;
      justify-content: center;
      border: 1px solid var(--border);
      border-radius: 999px;
      background: var(--card);
      color: var(--text);
      cursor: pointer;
      box-shadow: var(--shadow);
    }
    .kpi-mobile-next:hover { color: var(--accent); border-color: rgba(13, 148, 136, 0.55); }
    .kpi-mobile-next:focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; }
    .kpi-mobile-next svg { width: 18px; height: 18px; display: block; }
@media (max-width: 768px) {
  .kpi-mobile-pager { overflow-x: auto; -webkit-overflow-scrolling: touch; }
  .live-kpi-grid { --kpi-gap: 0.5rem; display: flex; gap: var(--kpi-gap); }
  .live-kpi-cell { min-width: 150px; flex: 0 0 auto; }
  .live-kpi-cell .live-kpi-value { font-size: 1rem; }
}
.live-view-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; gap: 0; }
.live-view-header .table-title { margin: 0; font-size: var(--table-header-font-size); font-weight: 500; color: var(--text); flex-shrink: 0; display: flex; align-items: center; gap: 0.35rem; letter-spacing: -0.1px; }
.table-title-tabs { display: inline-flex; align-items: center; gap: 0; flex-wrap: wrap; }
.table-title-tabs button { padding: 0.2rem 0.5rem; margin: 0; border: none; background: none; font-size: inherit; font-weight: 500; color: var(--muted); cursor: pointer; border-radius: var(--radius); }
.table-title-tabs button:hover { color: var(--text); }
.table-title-tabs button[aria-selected="true"] { color: var(--accent); font-weight: 600; }
.table-title-tabs-sep { margin: 0 0.35rem; color: var(--border); font-weight: 400; user-select: none; }
.table-title-label { display: inline; }
.live-view-header .live-view-online { flex-shrink: 0; }
.live-view-header .next-update-block { flex-shrink: 0; }
.live-view-header .live-view-next-update-center { flex: 1; display: flex; justify-content: center; }
.live-view-online { font-size: 0.875rem; color: var(--muted); display: flex; align-items: center; gap: 0.35rem; margin-right: 10px; }
.live-view-online .online-user-icon { width: 16px; height: 16px; flex-shrink: 0; display: block; }
.live-view-online .online-count-wrap { display: inline-flex; align-items: center; gap: 0.35rem; }
.mini-spinner { width: 12px; height: 12px; border: 2px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: refresh-spin 0.8s linear infinite; display: inline-block; }
.live-view-online strong {
    color: #333;
    font-size: 16px;
    line-height: 15px;
    vertical-align: middle;
    padding: 2px 0 0 0;
}
.dashboard-top-bar select:not(.top-bar-date-select) { padding: 0.5rem 0.75rem; border: 1px solid var(--border); border-radius: var(--radius); background: var(--card); font-size: 0.875rem; color: var(--text); appearance: none; background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 24 24' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M17 9.5L12 14.5L7 9.5' stroke='%23333' stroke-linecap='round' stroke-linejoin='round' stroke-width='2'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 0.5rem center; background-size: 16px 16px; padding-right: 1.75rem; }
.dashboard-top-bar select option:disabled { color: var(--muted); }
#audio-mute-btn { display: inline-flex; align-items: center; justify-content: center; width: 20px; height: 20px; padding: 0; border: none; background: none; cursor: pointer; color: var(--text); }
#audio-mute-btn:hover { color: var(--accent); }
#audio-mute-btn:focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; }
#audio-mute-btn.muted { opacity: 0.6; color: var(--muted); }
#audio-mute-btn svg { width: 20px; height: 20px; }
.table-scroll-wrap { overflow-x: auto; -webkit-overflow-scrolling: touch; margin-bottom: 0.75rem; border-radius: var(--radius); border: 1px solid var(--border); }
.table-scroll-wrap.tight-cols { --table-cell-padding-x: 0.6rem; }
.table-scroll-wrap table { margin: 0; width: max(100%, 800px); table-layout: auto; border: none; box-shadow: none; }
.table-scroll-wrap th, .table-scroll-wrap td { border-bottom: none; padding: var(--table-cell-padding-y) var(--table-cell-padding-x); }
    .table-scroll-wrap tr:last-child td { border-bottom: none; }
.table-scroll-wrap th:nth-child(1), .table-scroll-wrap td:nth-child(1) { width: 1%; min-width: 240px; text-align: left; }
.table-scroll-wrap .last-action-cell { min-width: 60px; }
.table-scroll-wrap .last-action-cell .landing-thumb { flex-shrink: 0; }
.table-scroll-wrap th:nth-child(2), .table-scroll-wrap td:nth-child(2) { min-width: 56px; }
.table-scroll-wrap th.source-cell, .table-scroll-wrap td.source-cell { min-width: 90px; max-width: 160px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.table-scroll-wrap th.cart-value-cell, .table-scroll-wrap td.cart-value-cell { width: 1%; min-width: 4.5rem; max-width: 6rem; white-space: nowrap; }
.table-scroll-wrap .last-action-cell { min-width: 100px; max-width: none; }
.table-scroll-wrap .last-action-cell a { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 100%; display: inline-block; }
.table-scroll-wrap .cart-value-sale { color: var(--accent); font-weight: 600; }
.table-scroll-wrap th.sortable { cursor: pointer; user-select: none; }
.table-scroll-wrap th.sortable:hover { color: var(--accent); }
.table-scroll-wrap th.th-sort-asc::after,
.table-scroll-wrap th.th-sort-desc::after { content: ''; display: inline-block; width: 16px; height: 16px; margin-left: 6px; vertical-align: middle; background-color: currentColor; -webkit-mask-size: contain; -webkit-mask-repeat: no-repeat; -webkit-mask-position: center; mask-size: contain; mask-repeat: no-repeat; mask-position: center; }
.table-scroll-wrap th.th-sort-asc::after { -webkit-mask-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 24 24' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M7 14.5L12 9.5L17 14.5' stroke='black' stroke-linecap='round' stroke-linejoin='round' stroke-width='2'/%3E%3C/svg%3E"); mask-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 24 24' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M7 14.5L12 9.5L17 14.5' stroke='black' stroke-linecap='round' stroke-linejoin='round' stroke-width='2'/%3E%3C/svg%3E"); }
.table-scroll-wrap th.th-sort-desc::after { -webkit-mask-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 24 24' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M17 9.5L12 14.5L7 9.5' stroke='black' stroke-linecap='round' stroke-linejoin='round' stroke-width='2'/%3E%3C/svg%3E"); mask-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 24 24' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M17 9.5L12 14.5L7 9.5' stroke='black' stroke-linecap='round' stroke-linejoin='round' stroke-width='2'/%3E%3C/svg%3E"); }
.table-scroll-wrap .arrived-cell, .table-scroll-wrap .last-seen-cell { min-width: 4.5rem; }
.table-pagination {
  display: flex;
  align-items: center;
  justify-content: center;
  flex-wrap: wrap;
  gap: 0;
  padding: 0.75rem 0 1.25rem;
  font-size: 0.875rem;
  color: var(--muted);
}
.table-pagination .pagination-segments {
  display: inline-flex;
  align-items: stretch;
  justify-content: center;
  flex-wrap: nowrap;
}
.table-pagination .pagination-segments > * + * { border-left: none; }
.table-pagination .pagination-segments > :first-child { border-radius: 4px 0 0 4px; }
.table-pagination .pagination-segments > :last-child { border-radius: 0 4px 4px 0; }
.table-pagination button {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 0.4rem;
  padding: 0.42rem 0.75rem;
  border: 1px solid var(--border);
  border-radius: 0;
  background: rgba(255, 255, 255, 0.85);
  box-shadow: none;
  color: var(--text);
  cursor: pointer;
  font-size: 0.875rem;
  font-weight: 650;
  line-height: 1;
  transition: background 160ms ease, border-color 160ms ease, color 160ms ease, box-shadow 160ms ease, opacity 160ms ease;
}
.table-pagination button:focus-visible { outline: 2px solid rgba(13, 148, 136, 0.6); outline-offset: 2px; }
.table-pagination button:hover:not(:disabled) { border-color: rgba(13, 148, 136, 0.45); background: rgba(13, 148, 136, 0.08); color: var(--accent); }
.table-pagination button:active:not(:disabled) { box-shadow: 0 0 0 rgba(0,0,0,0); }
.table-pagination button:disabled { opacity: 0.45; cursor: not-allowed; box-shadow: none; transform: none; }

.table-pagination button#pagination-prev::before,
.card-pagination button[id$="-prev"]::before,
.table-pagination button#pagination-next::after,
.card-pagination button[id$="-next"]::after {
  content: '';
  display: inline-block;
  width: 16px;
  height: 16px;
  background-color: currentColor;
  -webkit-mask-size: contain;
  -webkit-mask-repeat: no-repeat;
  -webkit-mask-position: center;
  mask-size: contain;
  mask-repeat: no-repeat;
  mask-position: center;
  opacity: 0.9;
}
.table-pagination button#pagination-prev::before,
.card-pagination button[id$="-prev"]::before {
  -webkit-mask-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 24 24' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M15 18l-6-6 6-6' stroke='black' stroke-linecap='round' stroke-linejoin='round' stroke-width='2'/%3E%3C/svg%3E");
  mask-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 24 24' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M15 18l-6-6 6-6' stroke='black' stroke-linecap='round' stroke-linejoin='round' stroke-width='2'/%3E%3C/svg%3E");
}
.table-pagination button#pagination-next::after,
.card-pagination button[id$="-next"]::after {
  -webkit-mask-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 24 24' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M9 6l6 6-6 6' stroke='black' stroke-linecap='round' stroke-linejoin='round' stroke-width='2'/%3E%3C/svg%3E");
  mask-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 24 24' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M9 6l6 6-6 6' stroke='black' stroke-linecap='round' stroke-linejoin='round' stroke-width='2'/%3E%3C/svg%3E");
}

.table-pagination #pagination-label {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 0.38rem 0.85rem;
  border: 1px solid var(--border);
  border-radius: 0;
  background: rgba(255, 255, 255, 0.85);
  box-shadow: none;
  color: var(--muted);
  font-weight: 600;
  font-variant-numeric: tabular-nums;
}
.table-pagination #rows-per-page-wrap { display: none !important; }
.table-pagination #rows-per-page-wrap .muted {
  font-size: 0.72rem;
  letter-spacing: 0.06em;
  text-transform: uppercase;
  color: var(--muted);
}
@media (max-width: 768px) {
  .table-pagination #rows-per-page-wrap .muted { display: none; }
}
.table-pagination #rows-per-page-select {
  border: none;
  background: none;
  padding: 0.2rem 1.25rem 0.2rem 0.25rem;
  font-size: 0.8125rem;
  font-weight: 650;
  color: var(--text);
  cursor: pointer;
  font-family: inherit;
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 24 24' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M17 9.5L12 14.5L7 9.5' stroke='%23666' stroke-linecap='round' stroke-linejoin='round' stroke-width='2'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 0.2rem center;
  background-size: 16px 16px;
}
.table-pagination #rows-per-page-wrap:focus-within { border-color: rgba(13, 148, 136, 0.5); box-shadow: 0 0 0 3px rgba(13, 148, 136, 0.12); position: relative; z-index: 1; }
.table-pagination #rows-per-page-select:hover { color: var(--accent); }
.table-pagination #rows-per-page-select:focus { outline: none; }

.card-pagination {
  display: none;
  align-items: center;
  justify-content: center;
  flex-wrap: wrap;
  gap: 0;
  padding: 0.65rem 0.75rem;
  background: rgba(255, 255, 255, 0.7);
  border-top: 1px solid var(--border);
  font-size: 0.8125rem;
  color: var(--muted);
  border-radius: 0 0 var(--radius) var(--radius);
  -webkit-backdrop-filter: blur(8px);
  backdrop-filter: blur(8px);
}
.card-pagination button {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 0.35rem;
  padding: 0.34rem 0.6rem;
  border: 1px solid var(--border);
  border-radius: 0;
  background: rgba(255, 255, 255, 0.9);
  box-shadow: none;
  color: var(--text);
  cursor: pointer;
  font-size: 0.8125rem;
  font-weight: 650;
  line-height: 1;
  transition: background 160ms ease, border-color 160ms ease, color 160ms ease, box-shadow 160ms ease, opacity 160ms ease;
}
.card-pagination button:hover:not(:disabled) { border-color: rgba(13, 148, 136, 0.45); background: rgba(13, 148, 136, 0.08); color: var(--accent); }
.card-pagination button:active:not(:disabled) { box-shadow: 0 0 0 rgba(0,0,0,0); }
.card-pagination button:disabled { opacity: 0.45; cursor: not-allowed; box-shadow: none; transform: none; }
.card-pagination .page-label {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 0.3rem 0.7rem;
  border: 1px solid var(--border);
  border-radius: 0;
  background: rgba(255, 255, 255, 0.82);
  box-shadow: none;
  min-width: 104px;
  text-align: center;
  font-variant-numeric: tabular-nums;
  color: var(--muted);
  font-weight: 600;
}
.card-pagination button[id$="-prev"] { border-radius: 4px 0 0 4px; }
.card-pagination button[id$="-next"] { border-radius: 0 4px 4px 0; }
.card-pagination .page-label,
.card-pagination button[id$="-next"] { border-left: none; }
    .source-googleads-img, .source-icon-img { width: 20px; height: 20px; vertical-align: middle; display: inline-block; }
    .source-icons { display: inline-flex; align-items: center; gap: 4px; }
    .source-icons img { width: 20px; height: 20px; }
    @media (max-width: 1800px) {
      .stats-row { display: grid; grid-template-columns: 1fr 1fr; gap: var(--table-gap); }
      .stats-card { min-width: 0; }
      .stats-card #stats-best-sellers .by-country-table th:first-child,
      .stats-card #stats-best-sellers .by-country-table td:first-child,
      .stats-card #stats-worst-products .by-country-table th:first-child,
      .stats-card #stats-worst-products .by-country-table td:first-child,
      .stats-card #stats-best-variants .by-country-table th:first-child,
      .stats-card #stats-best-variants .by-country-table td:first-child,
      .stats-card #stats-worst-variants .by-country-table th:first-child,
      .stats-card #stats-worst-variants .by-country-table td:first-child { min-width: 200px; }
    }
    @media (max-width: 768px) {
      .aov-cards-grid { grid-template-columns: 1fr; }
      .dashboard-top-bar { padding-left: 20px; padding-right: 20px; }
      .mobile-brand-logo { display: flex; }
      .main { padding: 20px; }
      .stats-row { grid-template-columns: 1fr; gap: var(--table-gap); margin-bottom: 1.25rem; }
      .stats-card { min-width: 100%; padding: 0; }
      .stats-card:first-child { min-width: 100%; }
      .stats-card #stats-best-sellers .by-country-table th:first-child,
      .stats-card #stats-best-sellers .by-country-table td:first-child,
      .stats-card #stats-worst-products .by-country-table th:first-child,
      .stats-card #stats-worst-products .by-country-table td:first-child,
      .stats-card #stats-best-variants .by-country-table th:first-child,
      .stats-card #stats-best-variants .by-country-table td:first-child,
      .stats-card #stats-worst-variants .by-country-table th:first-child,
      .stats-card #stats-worst-variants .by-country-table td:first-child { width: 55%; min-width: 140px; }
      .stats-main { font-size: 1.35rem; }
      .stats-breakdown { gap: 0.5rem; font-size: 0.75rem; }
      .live-view-header .table-title { font-size: var(--table-header-font-size); }
      .table-title { font-size: var(--table-header-font-size); margin-bottom: 0.35rem; }
      .live-view-header .next-update-block { display: inline-flex; }
      .live-view-header .live-view-next-update-center { flex: 0; }
      .next-update-label { display: none !important; }
      #table-tab-1h, #table-tab-sep-today-1h, #table-tab-sep-1h-live { display: none !important; }
      .table-scroll-wrap { margin-left: 0; margin-right: 0; border-radius: var(--radius); -webkit-overflow-scrolling: touch; overflow-x: auto; }
      .side-panel { width: 100%; padding: 1rem; }
      .side-panel-close { min-width: 44px; min-height: 44px; }
      .last-action-cell a { display: none; }
      .last-action-cell .landing-lines a { display: grid; }
      .landing-thumb { width: 32px; height: 32px; }
      .thumb-wrap.thumb-stack .landing-thumb-exit { width: 24px; height: 24px; min-width: 24px; min-height: 24px; }
    }
    @media (max-width: 480px) {
      .dashboard-top-bar { padding-left: 20px; padding-right: 20px; }
      .main { padding: 20px; }
      .stats-card { padding: 0; }
    }
    .dashboard-footer { position: fixed; bottom: 0; left: 0; right: 0; z-index: 5; display: flex; align-items: center; justify-content: center; gap: 20px; flex-wrap: wrap; padding: 10px 20px; font-size: 0.8125rem; color: var(--muted); background: #eee; }
    body { padding-bottom: 52px; }
    .dashboard-footer .footer-last-sale { white-space: nowrap; }
    .dashboard-footer .refresh-btn,
    .dashboard-footer #audio-mute-btn,
    .dashboard-footer .config-btn { flex-shrink: 0; }

    .config-btn { display: inline-flex; align-items: center; justify-content: center; width: 18px; height: 18px; padding: 0; border: 1px solid var(--border); border-radius: 999px; background: var(--card); cursor: pointer; color: var(--text); font-size: 12px; line-height: 1; }
    .config-btn svg { display: block; width: 18px; height: 18px; }
        .config-btn:hover { color: var(--accent); }
    .config-btn:focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; }
    .config-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.35); display: none; align-items: center; justify-content: center; padding: 1rem; z-index: 9999; }
    .config-modal.open { display: flex; }
    .config-modal-card { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); box-shadow: var(--shadow); width: 560px; max-width: 100%; max-height: 80vh; overflow: auto; padding: 1rem; }
    .config-modal-header { display: flex; align-items: center; justify-content: space-between; gap: 0.75rem; margin-bottom: 0.75rem; }
    .config-modal-title { margin: 0; font-size: 0.75rem; font-weight: 600; color: var(--muted); text-transform: uppercase; letter-spacing: 0.04em; }
    .config-close { border: none; background: none; cursor: pointer; font-size: 1.25rem; line-height: 1; color: var(--muted); }
    .config-close:hover { color: var(--accent); }
    .date-cal { display: grid; gap: 1rem; }
    .date-cal-month { border: 1px solid var(--border); border-radius: var(--radius); padding: 0.75rem; background: rgba(255,255,255,0.6); }
    .date-cal-month-title { font-size: 0.8125rem; font-weight: 700; color: var(--text); margin: 0 0 0.5rem; }
    .date-cal-weekdays, .date-cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 0.25rem; }
    .date-cal-weekday { font-size: 0.7rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.04em; text-align: center; padding: 0.15rem 0; }
    .date-cal-spacer { height: 32px; }
    .date-cal-day { border: 1px solid var(--border); border-radius: 8px; background: var(--card); color: var(--text); cursor: pointer; padding: 0.4rem 0; font-size: 0.85rem; font-weight: 600; text-align: center; }
    .date-cal-day:hover { border-color: rgba(13, 148, 136, 0.6); color: var(--accent); }
    .date-cal-day[disabled], .date-cal-day.disabled { opacity: 0.35; cursor: not-allowed; }
    .date-cal-day.selected { background: rgba(13, 148, 136, 0.12); border-color: rgba(13, 148, 136, 0.6); color: var(--accent); }
    .date-cal-day.in-range { background: rgba(13, 148, 136, 0.10); border-color: rgba(13, 148, 136, 0.25); }
    .date-cal-day.range-start,
    .date-cal-day.range-end { background: var(--accent); border-color: var(--accent); color: #fff; }
    .date-cal-day.range-start:hover,
    .date-cal-day.range-end:hover { color: #fff; }
    .date-cal-day.today { box-shadow: inset 0 0 0 2px rgba(13, 148, 136, 0.25); }
    .date-cal-footer { display: flex; align-items: center; justify-content: space-between; gap: 0.75rem; margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid var(--border); }
    .date-cal-summary { font-size: 0.8125rem; color: var(--text); font-weight: 600; }
    .date-cal-actions { display: inline-flex; align-items: center; gap: 0.5rem; flex-shrink: 0; }
    .date-cal-btn { display: inline-flex; align-items: center; justify-content: center; padding: 0.42rem 0.75rem; border: 1px solid var(--border); border-radius: 999px; background: rgba(255, 255, 255, 0.9); box-shadow: var(--shadow); color: var(--text); cursor: pointer; font-size: 0.8125rem; font-weight: 650; }
    .date-cal-btn:hover { color: var(--accent); border-color: rgba(13, 148, 136, 0.35); }
    .date-cal-btn.primary { border-color: rgba(13, 148, 136, 0.55); color: var(--accent); background: rgba(13, 148, 136, 0.08); }
    .date-cal-btn.primary:hover { border-color: rgba(13, 148, 136, 0.8); }
    .date-cal-btn:disabled { opacity: 0.55; cursor: not-allowed; }
    .config-row { font-size: 0.8125rem; color: var(--text); margin: 0.25rem 0; word-break: break-word; }
    .config-row.ok { color: #0f766e; }
    .config-row.missing { color: #b91c1c; }

    /* Diagnostics (config status) redesign */
    #config-modal .config-modal-card { width: 940px; max-width: calc(100vw - 2rem); max-height: 86vh; }
    #config-modal .config-modal-header { margin-bottom: 0.5rem; }

    .diag { display: flex; flex-direction: column; gap: 0.85rem; }
    .diag-loading { font-size: 0.85rem; color: var(--muted); padding: 0.5rem 0; }

    .diag-top-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; }
    .diag-card { border: 1px solid var(--border); border-radius: var(--radius); background: rgba(255,255,255,0.75); padding: 0.9rem; }
    .diag-card-header { display: flex; align-items: center; justify-content: space-between; gap: 0.75rem; margin-bottom: 0.6rem; }
    .diag-brand { display: flex; align-items: center; gap: 0.55rem; min-width: 0; }
    .diag-logo { width: 26px; height: 26px; display: block; object-fit: contain; border-radius: 6px; flex-shrink: 0; }
    .diag-title { font-size: 0.95rem; font-weight: 750; color: var(--text); line-height: 1.1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .diag-sub { font-size: 0.75rem; color: var(--muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    .diag-metrics { display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; }
    .diag-metric { display: flex; flex-direction: column; gap: 0.25rem; min-width: 0; }
    .diag-metric-label { font-size: 0.7rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.04em; }
    .diag-metric-value { font-size: 1.35rem; font-weight: 780; color: var(--text); line-height: 1.05; }
    .diag-metric-value.small { font-size: 1.15rem; }
    .diag-card-bots { grid-column: 1 / -1; display: flex; align-items: center; justify-content: space-between; gap: 1rem; }
    .diag-bots-left { display: flex; align-items: center; gap: 0.55rem; min-width: 0; }
    .diag-icon { width: 18px; height: 18px; color: var(--accent); flex-shrink: 0; }
    .diag-bots-meta { font-size: 0.75rem; color: var(--muted); }

    .diag-section-title { display: flex; align-items: center; gap: 0.45rem; margin: 0.1rem 0 0.2rem; font-size: 0.75rem; font-weight: 700; color: var(--muted); text-transform: uppercase; letter-spacing: 0.04em; }
    .diag-section-title svg { width: 16px; height: 16px; }

    .diag-table-scroll { overflow: auto; border-radius: var(--radius); }
    .diag-compare-table { width: 100%; table-layout: fixed; }
    .diag-compare-table th, .diag-compare-table td { padding: 0.55rem 0.65rem; font-size: 0.8125rem; }
    .diag-compare-table th:first-child, .diag-compare-table td:first-child { text-align: left; }
    .diag-compare-table td code { font-size: 0.78rem; }
    .diag-compare-table .diag-diff-ok { color: #0f766e; font-weight: 750; }
    .diag-compare-table .diag-diff-bad { color: #b91c1c; font-weight: 750; }
    .diag-compare-table .diag-diff-warn { color: #a16207; font-weight: 750; }

    .diag-pill { display: inline-flex; align-items: center; gap: 0.35rem; padding: 0.15rem 0.5rem; border-radius: 999px; font-size: 0.72rem; font-weight: 800; letter-spacing: 0.01em; white-space: nowrap; }
    .diag-pill.ok { background: rgba(13, 148, 136, 0.12); border: 1px solid rgba(13, 148, 136, 0.25); color: #0f766e; }
    .diag-pill.bad { background: rgba(185, 28, 28, 0.10); border: 1px solid rgba(185, 28, 28, 0.25); color: #b91c1c; }
    .diag-pill.warn { background: rgba(161, 98, 7, 0.12); border: 1px solid rgba(161, 98, 7, 0.24); color: #a16207; }

    .diag-tech { border: 1px solid var(--border); border-radius: var(--radius); background: rgba(255,255,255,0.72); overflow: hidden; }
    .diag-tech summary { list-style: none; cursor: pointer; display: flex; align-items: center; justify-content: space-between; gap: 0.75rem; padding: 0.75rem 0.9rem; }
    .diag-tech summary::-webkit-details-marker { display: none; }
    .diag-tech-head { display: flex; flex-direction: column; gap: 0.1rem; min-width: 0; }
    .diag-tech-head strong { font-size: 0.9rem; color: var(--text); }
    .diag-tech-head span { font-size: 0.75rem; color: var(--muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .diag-chevron { width: 18px; height: 18px; color: var(--muted); flex-shrink: 0; transition: transform 0.18s ease; }
    .diag-tech[open] .diag-chevron { transform: rotate(180deg); }

    .diag-tabs { border-top: 1px solid var(--border); padding: 0.75rem 0.9rem 0.9rem; }
    .diag-tab-nav { display: flex; flex-wrap: wrap; gap: 0.35rem; align-items: center; }
    .diag-tab { position: absolute; opacity: 0; pointer-events: none; }
    .diag-tab-label { display: inline-flex; align-items: center; gap: 0.4rem; padding: 0.4rem 0.65rem; border: 1px solid var(--border); border-radius: 999px; background: var(--card); cursor: pointer; font-size: 0.8rem; color: var(--text); }
    .diag-tab-label svg { width: 14px; height: 14px; }
    .diag-tab:focus-visible + .diag-tab-label { outline: 2px solid var(--accent); outline-offset: 2px; }
    .diag-tab:checked + .diag-tab-label { border-color: rgba(13, 148, 136, 0.55); color: var(--accent); background: rgba(13, 148, 136, 0.08); }

    .diag-panels { display: block; flex-basis: 100%; width: 100%; margin-top: 0.75rem; }
    .diag-panel { display: none; }
    #diag-tab-shopify:checked ~ .diag-panels .diag-panel-shopify { display: block; }
    #diag-tab-pixel:checked ~ .diag-panels .diag-panel-pixel { display: block; }
    #diag-tab-traffic:checked ~ .diag-panels .diag-panel-traffic { display: block; }
    #diag-tab-sources:checked ~ .diag-panels .diag-panel-sources { display: block; }
    #diag-tab-system:checked ~ .diag-panels .diag-panel-system { display: block; }

    .diag-panel-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; }
    .diag-panel-card { border: 1px solid var(--border); border-radius: var(--radius); background: rgba(255,255,255,0.82); padding: 0.75rem; }
    .diag-panel-card-title { display: flex; align-items: center; gap: 0.45rem; margin: 0 0 0.5rem; font-size: 0.75rem; font-weight: 700; color: var(--muted); text-transform: uppercase; letter-spacing: 0.04em; }
    .diag-panel-card-title svg { width: 16px; height: 16px; }
    .diag-kv { display: flex; align-items: baseline; justify-content: space-between; gap: 0.75rem; padding: 0.25rem 0; border-bottom: 1px dashed rgba(0,0,0,0.08); font-size: 0.8125rem; }
    .diag-kv:last-child { border-bottom: none; }
    .diag-kv .k { color: var(--muted); flex: 0 0 auto; }
    .diag-kv .v { color: var(--text); font-weight: 650; text-align: right; min-width: 0; word-break: break-word; }
    .diag-note { margin-top: 0.45rem; font-size: 0.75rem; color: var(--muted); line-height: 1.35; }

    @media (max-width: 768px) {
      #config-modal .config-modal-card { width: 100%; max-height: 92vh; }
      .diag-top-grid { grid-template-columns: 1fr; }
      .diag-card-bots { grid-column: auto; }
      .diag-panel-grid { grid-template-columns: 1fr; }
    }

    /* Traffic source mapping UI (config modal) */
    .tsm-actions { display: flex; flex-wrap: wrap; gap: 0.45rem; align-items: center; margin: 0 0 0.6rem; }
    .tsm-btn { display: inline-flex; align-items: center; gap: 0.35rem; padding: 0.4rem 0.65rem; border: 1px solid var(--border); border-radius: 999px; background: var(--card); cursor: pointer; font-size: 0.8rem; color: var(--text); }
    .tsm-btn svg { width: 14px; height: 14px; }
    .tsm-btn.primary { border-color: rgba(13, 148, 136, 0.55); color: var(--accent); background: rgba(13, 148, 136, 0.08); }
    .tsm-btn:disabled { opacity: 0.6; cursor: not-allowed; }
    .tsm-table-scroll { overflow: auto; border-radius: var(--radius); border: 1px solid rgba(0,0,0,0.06); background: rgba(255,255,255,0.65); }
    .tsm-table { width: 100%; border-collapse: separate; border-spacing: 0; }
    .tsm-table th, .tsm-table td { padding: 0.5rem 0.6rem; font-size: 0.8125rem; border-bottom: 1px dashed rgba(0,0,0,0.08); vertical-align: top; }
    .tsm-table th { text-align: left; color: var(--muted); text-transform: uppercase; letter-spacing: 0.04em; font-size: 0.7rem; }
    .tsm-table tr:last-child td { border-bottom: none; }
    .tsm-input { width: 100%; padding: 0.45rem 0.55rem; border: 1px solid var(--border); border-radius: 0.6rem; background: rgba(255,255,255,0.9); color: var(--text); font-size: 0.82rem; }
    .tsm-input::placeholder { color: rgba(0,0,0,0.4); }
    .tsm-mapped-pill { display: inline-flex; align-items: center; gap: 0.35rem; padding: 0.18rem 0.5rem; border-radius: 999px; border: 1px solid rgba(0,0,0,0.10); background: rgba(255,255,255,0.65); font-size: 0.75rem; font-weight: 750; margin: 0.15rem 0.35rem 0 0; }
    .tsm-icon-preview { width: 18px; height: 18px; border-radius: 5px; object-fit: contain; background: rgba(0,0,0,0.03); border: 1px solid rgba(0,0,0,0.06); }
  </style>
</head>
<body>
  <main class="main">
  <div class="main-tabs" role="tablist" aria-label="View">
    <button type="button" id="mobile-tabs-btn" class="mobile-tabs-btn" aria-label="Open menu" aria-haspopup="menu" aria-expanded="false" aria-controls="mobile-tabs-menu">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
      <span id="mobile-tabs-current">Home</span>
    </button>
    <div id="mobile-tabs-menu" class="mobile-tabs-menu" role="menu" aria-label="View menu">
      <button type="button" class="mobile-tabs-item" role="menuitem" data-tab="spy">Home</button>
      <button type="button" class="mobile-tabs-item" role="menuitem" data-tab="stats">Breakdown</button>
      <button type="button" class="mobile-tabs-item" role="menuitem" data-tab="products">Products</button>
      <button type="button" class="mobile-tabs-item" role="menuitem" data-tab="traffic">Traffic</button>
    </div>

    <div class="main-tabs-center-logo" aria-hidden="true">
      <img src="https://cdn.shopify.com/s/files/1/0847/7261/8587/files/birdseyegreen.webp?v=1770250895" width="30" height="30" alt="" decoding="async" />
    </div>

    <button type="button" role="tab" id="tab-spy" aria-label="Home" aria-selected="true" aria-controls="tab-panel-spy" data-tab="spy">
      <span class="tab-icon-home-swap" aria-hidden="true">
        <img class="tab-icon tab-icon-home tab-icon-home--inactive" src="https://cdn.shopify.com/s/files/1/0847/7261/8587/files/birdseyesmallicon.png?v=1770248783" width="25" height="25" alt="" decoding="async" />
        <img class="tab-icon tab-icon-home tab-icon-home--active" src="https://cdn.shopify.com/s/files/1/0847/7261/8587/files/birdseyegreen.webp?v=1770250895" width="25" height="25" alt="" decoding="async" />
      </span>
      <span class="tab-text">Home</span>
    </button>
    <button type="button" role="tab" id="tab-stats" aria-selected="false" aria-controls="tab-panel-stats" data-tab="stats">Breakdown</button>
    <button type="button" role="tab" id="tab-products" aria-selected="false" aria-controls="tab-panel-products" data-tab="products">Products</button>
    <button type="button" role="tab" id="tab-traffic" aria-selected="false" aria-controls="tab-panel-traffic" data-tab="traffic">Traffic</button>
    <span class="main-tabs-spacer" aria-hidden="true"></span>
    <button type="button" id="mobile-date-btn" class="mobile-date-btn" aria-label="Date range" aria-haspopup="menu" aria-expanded="false" aria-controls="mobile-date-menu">
      <span>Date</span>
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.9" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <rect x="3" y="4" width="18" height="18" rx="3"></rect>
        <path d="M16 2v4M8 2v4M3 10h18"></path>
      </svg>
    </button>
    <div id="mobile-date-menu" class="mobile-date-menu" role="menu" aria-label="Date range menu">
      <button type="button" class="mobile-date-item" role="menuitem" data-value="today">Today</button>
      <button type="button" class="mobile-date-item" role="menuitem" data-value="yesterday">Yesterday</button>
      <button type="button" class="mobile-date-item" role="menuitem" data-value="custom">Choose dates…</button>
    </div>
    <select id="global-date-select" class="main-tabs-date-select" aria-label="Date range">
      <!-- Date range Today: table tabs Today | Last Hour | Now above table -->
      <option value="today">Today</option>
      <option value="yesterday">Yesterday</option>
      <option value="custom" id="date-opt-custom">Choose dates…</option>
    </select>
  </div>
  <div class="shared-kpi-wrap" aria-label="KPIs for selected date range">
    <div class="kpi-mobile-pager">
    <div class="live-kpi-grid" id="live-kpi-grid">
      <div class="live-kpi-cell sale-toast-host" id="live-kpi-sales-cell">
        <div class="live-kpi-label" id="live-kpi-sales-label">Sales</div>
        <div class="live-kpi-value" id="live-kpi-sales">—</div>
        <div class="sale-toast" id="sale-toast" aria-hidden="true" style="display:none">
          <button type="button" class="sale-toast-close" id="sale-toast-close" aria-label="Dismiss sale notification" title="Dismiss">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <path d="M18 6L6 18M6 6l12 12"></path>
            </svg>
          </button>
          <div class="sale-toast-flag" id="sale-toast-flag"></div>
          <div class="sale-toast-mid">
            <div class="sale-toast-title"><span id="sale-toast-inline-flag" aria-hidden="true"></span>New Sale</div>
            <div class="sale-toast-product" id="sale-toast-product">—</div>
          </div>
          <div class="sale-toast-amount-wrap"><div class="sale-toast-amount" id="sale-toast-amount">£—</div></div>
        </div>
      </div>
      <div class="live-kpi-cell"><div class="live-kpi-label">Conv rate</div><div class="live-kpi-value" id="live-kpi-conv">—</div></div>
      <div class="live-kpi-cell"><div class="live-kpi-label">Sessions</div><div class="live-kpi-value" id="live-kpi-sessions">—</div></div>
      <div class="live-kpi-cell"><div class="live-kpi-label">Returning</div><div class="live-kpi-value" id="live-kpi-returning">—</div></div>
      <div class="live-kpi-cell"><div class="live-kpi-label">AOV</div><div class="live-kpi-value" id="live-kpi-aov">—</div></div>
      <div class="live-kpi-cell"><div class="live-kpi-label">Bounce rate</div><div class="live-kpi-value" id="live-kpi-bounce">—</div></div>
    </div>
    <button type="button" class="kpi-mobile-next" id="kpi-mobile-next" aria-label="Next KPIs" title="Next KPIs">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><polyline points="9 18 15 12 9 6"/></svg>
    </button>
    </div>
  </div>
  <div id="tab-panel-spy" class="main-tab-panel active" role="tabpanel" aria-labelledby="tab-spy">
  <div class="live-view-header">
    <h2 class="table-title" id="table-title">
      <span id="table-title-tabs" class="table-title-tabs" role="tablist" aria-label="Time window" style="display: none;">
        <button type="button" role="tab" id="table-tab-today" data-range="today" aria-selected="false">Today</button>
        <span class="table-title-tabs-sep" id="table-tab-sep-today-1h" aria-hidden="true">|</span>
        <button type="button" role="tab" id="table-tab-1h" data-range="1h" aria-selected="false">Last Hour</button>
        <span class="table-title-tabs-sep" id="table-tab-sep-1h-live" aria-hidden="true">|</span>
        <button type="button" role="tab" id="table-tab-live" data-range="live" aria-selected="false">Now</button>
      </span>
      <span id="table-title-text" class="table-title-label">Today</span>
    </h2>
    <span class="next-update-block live-view-next-update-center" id="next-update-block">
      <span class="next-update-label" id="next-update-label">Next update</span>
      <span class="next-update-timer" id="next-update-timer-wrap" aria-hidden="true"><svg class="next-update-circle" viewBox="0 0 36 36" width="18" height="18"><circle class="next-update-circle-bg" cx="18" cy="18" r="15.9" fill="none" stroke="currentColor" stroke-width="2.5"/><circle id="next-update-circle-progress" class="next-update-circle-progress" cx="18" cy="18" r="15.9" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-dasharray="100" stroke-dashoffset="100" transform="rotate(-90 18 18)"/></svg></span>
      <span class="next-update-live-indicator" id="next-update-live-indicator" aria-hidden="true"><span class="live-pulse-dot"></span> Live</span>
    </span>
    <div class="live-view-online">
      <svg class="online-user-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><circle cx="12" cy="6" r="4"></circle><path d="M19.9975 18C20 17.8358 20 17.669 20 17.5C20 15.0147 16.4183 13 12 13C7.58172 13 4 15.0147 4 17.5C4 19.9853 4 22 12 22C14.231 22 15.8398 21.8433 17 21.5634"></path></svg>
      Online:
      <span class="online-count-wrap">
        <span id="online-count-spinner" class="mini-spinner" aria-hidden="true"></span>
        <strong id="online-count" style="display:none">0</strong>
      </span>
    </div>
  </div>
  <div class="sessions-table-wrap">
    <div class="table-loading-overlay sessions-loading-overlay" id="sessions-loading-overlay" style="display: none;"><div class="spinner"></div></div>
  <div class="table-scroll-wrap">
  <table id="sessions-table">
    <thead>
      <tr>
        <th class="sortable" data-sort="landing" aria-sort="none" tabindex="0" aria-label="Landing Page"><span class="th-label-long">Landing Page</span><span class="th-label-short">Land</span></th>
        <th class="sortable" data-sort="from" aria-sort="none" tabindex="0" aria-label="GEO"><span class="th-label-long">GEO</span><span class="th-label-short">GEO</span></th>
        <th class="source-cell sortable" data-sort="source" aria-sort="none" tabindex="0" aria-label="Source"><span class="th-label-long">Source</span><span class="th-label-short">Src</span></th>
        <th class="sortable" data-sort="device" aria-sort="none" tabindex="0" aria-label="Device"><span class="th-label-long">Device</span><span class="th-label-short">Dev</span></th>
        <th class="cart-value-cell sortable" data-sort="cart" aria-sort="none" tabindex="0" aria-label="Cart"><span class="th-label-long">Cart</span><span class="th-label-short">Cart</span></th>
        <th class="sortable" data-sort="arrived" aria-sort="none" tabindex="0" aria-label="Arrived"><span class="th-label-long">Arrived</span><span class="th-label-short">Arr</span></th>
        <th class="sortable" data-sort="last_seen" aria-sort="none" tabindex="0" aria-label="Seen"><span class="th-label-long">Seen</span><span class="th-label-short">Seen</span></th>
        <th class="sortable" data-sort="history" aria-sort="none" tabindex="0" aria-label="History"><span class="th-label-long">History</span><span class="th-label-short">Hist</span></th>
        <th class="consent-col" style="display:none" aria-label="Consent (debug)"><span class="th-label-long">Consent (debug)</span><span class="th-label-short">Cons</span></th>
      </tr>
    </thead>
    <tbody id="table-body"></tbody>
  </table>
  </div>
  <div class="table-pagination" id="table-pagination">
    <div class="pagination-segments" role="group" aria-label="Pagination">
      <button type="button" id="pagination-prev" aria-label="Previous page">Prev</button>
      <span id="pagination-label">1 of 1</span>
      <button type="button" id="pagination-next" aria-label="Next page">Next</button>
      <span id="rows-per-page-wrap"><span class="muted">Rows</span>
      <select id="rows-per-page-select" class="stats-select" aria-label="Rows per page">
      <option value="15">15</option>
      <option value="25" selected>25</option>
      <option value="30">30</option>
      <option value="50">50</option>
      <option value="75">75</option>
      <option value="100">100</option>
      </select></span>
    </div>
  </div>
  </div>
  </div>
  <div id="tab-panel-stats" class="main-tab-panel" role="tabpanel" aria-labelledby="tab-stats">
  <div class="stats-row-wrap">
    <div class="table-loading-overlay stats-loading-overlay report-loading-overlay" id="stats-loading-overlay" style="display: none;">
      <div class="report-build-wrap">
        <div class="spinner"></div>
        <div class="report-build-title">building reports</div>
        <div class="report-build-step" id="stats-build-step">—</div>
      </div>
    </div>
  <div class="aov-cards-wrap" id="aov-cards-wrap">
    <div class="aov-cards-header">
      <div class="aov-cards-title">Average Order Value</div>
    </div>
    <div class="aov-cards-grid" id="aov-cards-grid">
      <div class="aov-card aov-card-empty">—</div>
    </div>
  </div>
  <div class="stats-row breakdown-row">
    <div class="stats-card" id="stats-country">
      <div class="country-table-wrap" id="country-table-wrap">
        <table id="country-table" class="by-country-table">
          <thead>
            <tr>
              <th class="sortable" data-sort="country" aria-sort="none" tabindex="0" aria-label="Country"><span class="th-label-long">Country</span><span class="th-label-short">Geo</span></th>
              <th class="sortable" data-sort="cr" aria-sort="none" tabindex="0" aria-label="CR"><span class="th-label-long">CR</span><span class="th-label-short"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M5 19L19 5M9 7C9 8.10457 8.10457 9 7 9C5.89543 9 5 8.10457 5 7C5 5.89543 5.89543 5 7 5C8.10457 5 9 5.89543 9 7ZM19 17C19 18.1046 18.1046 19 17 19C15.8954 19 15 18.1046 15 17C15 15.8954 15.8954 15 17 15C18.1046 15 19 15.8954 19 17Z"></path></svg></span></th>
              <th class="sortable" data-sort="sales" aria-sort="none" tabindex="0" aria-label="Sales"><span class="th-label-long">Sales</span><span class="th-label-short"><svg viewBox="0 0 32 32" fill="currentColor" aria-hidden="true"><path d="M29.4819,8.624l-10-5.5a1,1,0,0,0-.9638,0l-10,5.5a1,1,0,0,0,0,1.752L18,15.5913V26.3086l-3.0362-1.6693L14,26.3912l4.5181,2.4848a.9984.9984,0,0,0,.9638,0l10-5.5A1,1,0,0,0,30,22.5V9.5A1,1,0,0,0,29.4819,8.624ZM19,5.1416,26.9248,9.5,19,13.8584,11.0752,9.5Zm9,16.7671-8,4.4V15.5913l8-4.4Z"></path><rect x="2" y="14" width="8" height="2" transform="translate(12 30) rotate(-180)"></rect><rect x="4" y="22" width="8" height="2" transform="translate(16 46) rotate(-180)"></rect><rect x="6" y="18" width="8" height="2" transform="translate(20 38) rotate(-180)"></rect></svg></span></th>
              <th class="sortable" data-sort="clicks" aria-sort="none" tabindex="0" aria-label="Clicks"><span class="th-label-long">Clicks</span><span class="th-label-short"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M9 4.94198C6.47561 4.02693 5.129 3.65381 4.39141 4.39141C3.55146 5.23136 4.15187 6.86106 5.3527 10.1205L7.3603 15.5696C7.96225 17.2035 8.26322 18.0204 8.92489 18.1658C9.58656 18.3111 10.2022 17.6955 11.4334 16.4643L12.6361 15.2616L16.5744 19.1999C16.9821 19.6077 17.186 19.8116 17.4135 19.9058C17.7168 20.0314 18.0575 20.0314 18.3608 19.9058C18.5882 19.8116 18.7921 19.6077 19.1999 19.1999C19.6077 18.7921 19.8116 18.5882 19.9058 18.3608C20.0314 18.0575 20.0314 17.7168 19.9058 17.4135C19.8116 17.186 19.6077 16.9821 19.1999 16.5744L15.2616 12.6361L16.4643 11.4334C17.6955 10.2022 18.3111 9.58656 18.1658 8.92489C18.0204 8.26322 17.2035 7.96225 15.5696 7.3603L13 6.41359"></path></svg></span></th>
              <th class="sortable" data-sort="rev" aria-sort="none" tabindex="0" aria-label="Rev"><span class="th-label-long">Rev</span><span class="th-label-short"><svg viewBox="0 0 256 256" fill="currentColor" aria-hidden="true"><path d="M192,208a8.00008,8.00008,0,0,1-8,8H56a8,8,0,0,1,0-16,28.03146,28.03146,0,0,0,28-28V140H56a8,8,0,0,1,0-16H84V84a52,52,0,0,1,88.76953-36.76953A8.00018,8.00018,0,0,1,161.45508,58.544,35.99961,35.99961,0,0,0,100,84v40h36a8,8,0,0,1,0,16H100v32a43.79679,43.79679,0,0,1-10.08447,28H184A8.00008,8.00008,0,0,1,192,208Z"></path></svg></span></th>
            </tr>
          </thead>
          <tbody id="by-country-body">
            <tr><td colspan="5" class="empty">—</td></tr>
          </tbody>
        </table>
      </div>
      <div class="card-pagination" id="country-pagination" aria-label="Country pagination">
        <button type="button" id="country-prev">Prev</button>
        <span class="page-label" id="country-label">Page 1 of 1</span>
        <button type="button" id="country-next">Next</button>
      </div>
    </div>
    <div class="stats-card" id="stats-best-geo-products">
      <div class="traffic-card-header">
        <h3 class="traffic-card-title">Best by GEO</h3>
      </div>
      <div class="country-table-wrap" id="best-geo-products-wrap">
        <table id="best-geo-products-table" class="by-country-table geo-products-table">
          <thead>
            <tr>
              <th class="sortable" data-sort="country" aria-sort="none" tabindex="0" aria-label="Country"><span class="th-label-long">Country</span><span class="th-label-short">Geo</span></th>
              <th class="sortable" data-sort="cr" aria-sort="none" tabindex="0" aria-label="CR"><span class="th-label-long">CR</span><span class="th-label-short"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M5 19L19 5M9 7C9 8.10457 8.10457 9 7 9C5.89543 9 5 8.10457 5 7C5 5.89543 5.89543 5 7 5C8.10457 5 9 5.89543 9 7ZM19 17C19 18.1046 18.1046 19 17 19C15.8954 19 15 18.1046 15 17C15 15.8954 15.8954 15 17 15C18.1046 15 19 15.8954 19 17Z"></path></svg></span></th>
              <th class="sortable" data-sort="sales" aria-sort="none" tabindex="0" aria-label="Sales"><span class="th-label-long">Sales</span><span class="th-label-short"><svg viewBox="0 0 32 32" fill="currentColor" aria-hidden="true"><path d="M29.4819,8.624l-10-5.5a1,1,0,0,0-.9638,0l-10,5.5a1,1,0,0,0,0,1.752L18,15.5913V26.3086l-3.0362-1.6693L14,26.3912l4.5181,2.4848a.9984.9984,0,0,0,.9638,0l10-5.5A1,1,0,0,0,30,22.5V9.5A1,1,0,0,0,29.4819,8.624ZM19,5.1416,26.9248,9.5,19,13.8584,11.0752,9.5Zm9,16.7671-8,4.4V15.5913l8-4.4Z"></path><rect x="2" y="14" width="8" height="2" transform="translate(12 30) rotate(-180)"></rect><rect x="4" y="22" width="8" height="2" transform="translate(16 46) rotate(-180)"></rect><rect x="6" y="18" width="8" height="2" transform="translate(20 38) rotate(-180)"></rect></svg></span></th>
              <th class="sortable" data-sort="clicks" aria-sort="none" tabindex="0" aria-label="Clicks"><span class="th-label-long">Clicks</span><span class="th-label-short"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M9 4.94198C6.47561 4.02693 5.129 3.65381 4.39141 4.39141C3.55146 5.23136 4.15187 6.86106 5.3527 10.1205L7.3603 15.5696C7.96225 17.2035 8.26322 18.0204 8.92489 18.1658C9.58656 18.3111 10.2022 17.6955 11.4334 16.4643L12.6361 15.2616L16.5744 19.1999C16.9821 19.6077 17.186 19.8116 17.4135 19.9058C17.7168 20.0314 18.0575 20.0314 18.3608 19.9058C18.5882 19.8116 18.7921 19.6077 19.1999 19.1999C19.6077 18.7921 19.8116 18.5882 19.9058 18.3608C20.0314 18.0575 20.0314 17.7168 19.9058 17.4135C19.8116 17.186 19.6077 16.9821 19.1999 16.5744L15.2616 12.6361L16.4643 11.4334C17.6955 10.2022 18.3111 9.58656 18.1658 8.92489C18.0204 8.26322 17.2035 7.96225 15.5696 7.3603L13 6.41359"></path></svg></span></th>
              <th class="sortable" data-sort="rev" aria-sort="none" tabindex="0" aria-label="Rev"><span class="th-label-long">Rev</span><span class="th-label-short"><svg viewBox="0 0 256 256" fill="currentColor" aria-hidden="true"><path d="M192,208a8.00008,8.00008,0,0,1-8,8H56a8,8,0,0,1,0-16,28.03146,28.03146,0,0,0,28-28V140H56a8,8,0,0,1,0-16H84V84a52,52,0,0,1,88.76953-36.76953A8.00018,8.00018,0,0,1,161.45508,58.544,35.99961,35.99961,0,0,0,100,84v40h36a8,8,0,0,1,0,16H100v32a43.79679,43.79679,0,0,1-10.08447,28H184A8.00008,8.00008,0,0,1,192,208Z"></path></svg></span></th>
            </tr>
          </thead>
          <tbody id="best-geo-products-body">
            <tr><td colspan="5" class="empty">—</td></tr>
          </tbody>
        </table>
      </div>
      <div class="card-pagination" id="best-geo-products-pagination" aria-label="Best GEO products pagination">
        <button type="button" id="best-geo-products-prev">Prev</button>
        <span class="page-label" id="best-geo-products-label">Page 1 of 1</span>
        <button type="button" id="best-geo-products-next">Next</button>
      </div>
    </div>
  </div>
  </div>
  </div>

  <div id="tab-panel-products" class="main-tab-panel" role="tabpanel" aria-labelledby="tab-products">
  <div class="stats-row-wrap">
    <div class="table-loading-overlay stats-loading-overlay report-loading-overlay" id="products-loading-overlay" style="display: none;">
      <div class="report-build-wrap">
        <div class="spinner"></div>
        <div class="report-build-title">building reports</div>
        <div class="report-build-step" id="products-build-step">—</div>
      </div>
    </div>
  <div class="stats-row">
    <div class="stats-card" id="stats-best-sellers">
      <div class="country-table-wrap" id="best-sellers-wrap">
        <table id="best-sellers-table" class="by-country-table best-sellers-table">
          <thead>
            <tr>
              <th class="bs-product-col sortable" data-sort="title" aria-sort="none" tabindex="0" aria-label="Best"><span class="th-label-long">Best</span><span class="th-label-short">Best</span></th>
              <th class="sortable" data-sort="orders" aria-sort="none" tabindex="0" aria-label="Sales"><span class="th-label-long">Sales</span><span class="th-label-short"><svg viewBox="0 0 32 32" fill="currentColor" aria-hidden="true"><path d="M29.4819,8.624l-10-5.5a1,1,0,0,0-.9638,0l-10,5.5a1,1,0,0,0,0,1.752L18,15.5913V26.3086l-3.0362-1.6693L14,26.3912l4.5181,2.4848a.9984.9984,0,0,0,.9638,0l10-5.5A1,1,0,0,0,30,22.5V9.5A1,1,0,0,0,29.4819,8.624ZM19,5.1416,26.9248,9.5,19,13.8584,11.0752,9.5Zm9,16.7671-8,4.4V15.5913l8-4.4Z"></path><rect x="2" y="14" width="8" height="2" transform="translate(12 30) rotate(-180)"></rect><rect x="4" y="22" width="8" height="2" transform="translate(16 46) rotate(-180)"></rect><rect x="6" y="18" width="8" height="2" transform="translate(20 38) rotate(-180)"></rect></svg></span></th>
              <th class="sortable" data-sort="clicks" aria-sort="none" tabindex="0" aria-label="Clicks"><span class="th-label-long">Clicks</span><span class="th-label-short"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M9 4.94198C6.47561 4.02693 5.129 3.65381 4.39141 4.39141C3.55146 5.23136 4.15187 6.86106 5.3527 10.1205L7.3603 15.5696C7.96225 17.2035 8.26322 18.0204 8.92489 18.1658C9.58656 18.3111 10.2022 17.6955 11.4334 16.4643L12.6361 15.2616L16.5744 19.1999C16.9821 19.6077 17.186 19.8116 17.4135 19.9058C17.7168 20.0314 18.0575 20.0314 18.3608 19.9058C18.5882 19.8116 18.7921 19.6077 19.1999 19.1999C19.6077 18.7921 19.8116 18.5882 19.9058 18.3608C20.0314 18.0575 20.0314 17.7168 19.9058 17.4135C19.8116 17.186 19.6077 16.9821 19.1999 16.5744L15.2616 12.6361L16.4643 11.4334C17.6955 10.2022 18.3111 9.58656 18.1658 8.92489C18.0204 8.26322 17.2035 7.96225 15.5696 7.3603L13 6.41359"></path></svg></span></th>
              <th class="sortable" data-sort="rev" aria-sort="descending" tabindex="0" aria-label="Rev"><span class="th-label-long">Rev</span><span class="th-label-short"><svg viewBox="0 0 256 256" fill="currentColor" aria-hidden="true"><path d="M192,208a8.00008,8.00008,0,0,1-8,8H56a8,8,0,0,1,0-16,28.03146,28.03146,0,0,0,28-28V140H56a8,8,0,0,1,0-16H84V84a52,52,0,0,1,88.76953-36.76953A8.00018,8.00018,0,0,1,161.45508,58.544,35.99961,35.99961,0,0,0,100,84v40h36a8,8,0,0,1,0,16H100v32a43.79679,43.79679,0,0,1-10.08447,28H184A8.00008,8.00008,0,0,1,192,208Z"></path></svg></span></th>
              <th class="sortable" data-sort="cr" aria-sort="none" tabindex="0" aria-label="CR%"><span class="th-label-long">CR%</span><span class="th-label-short"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M5 19L19 5M9 7C9 8.10457 8.10457 9 7 9C5.89543 9 5 8.10457 5 7C5 5.89543 5.89543 5 7 5C8.10457 5 9 5.89543 9 7ZM19 17C19 18.1046 18.1046 19 17 19C15.8954 19 15 18.1046 15 17C15 15.8954 15.8954 15 17 15C18.1046 15 19 15.8954 19 17Z"></path></svg></span></th>
            </tr>
          </thead>
          <tbody id="best-sellers-body">
            <tr><td colspan="5" class="empty">—</td></tr>
          </tbody>
        </table>
      </div>
      <div class="card-pagination" id="best-sellers-pagination" aria-label="Best sellers pagination">
        <button type="button" id="best-sellers-prev">Prev</button>
        <span class="page-label" id="best-sellers-label">Page 1 of 1</span>
        <button type="button" id="best-sellers-next">Next</button>
      </div>
    </div>
    <div class="stats-card" id="stats-worst-products">
      <div class="country-table-wrap" id="worst-products-wrap">
        <table id="worst-products-table" class="by-country-table best-sellers-table">
          <thead>
            <tr>
              <th class="bs-product-col sortable" data-sort="product" aria-sort="none" tabindex="0" aria-label="Worst"><span class="th-label-long">Worst</span><span class="th-label-short">Worst</span></th>
              <th class="sortable" data-sort="sales" aria-sort="none" tabindex="0" aria-label="Sales"><span class="th-label-long">Sales</span><span class="th-label-short"><svg viewBox="0 0 32 32" fill="currentColor" aria-hidden="true"><path d="M29.4819,8.624l-10-5.5a1,1,0,0,0-.9638,0l-10,5.5a1,1,0,0,0,0,1.752L18,15.5913V26.3086l-3.0362-1.6693L14,26.3912l4.5181,2.4848a.9984.9984,0,0,0,.9638,0l10-5.5A1,1,0,0,0,30,22.5V9.5A1,1,0,0,0,29.4819,8.624ZM19,5.1416,26.9248,9.5,19,13.8584,11.0752,9.5Zm9,16.7671-8,4.4V15.5913l8-4.4Z"></path><rect x="2" y="14" width="8" height="2" transform="translate(12 30) rotate(-180)"></rect><rect x="4" y="22" width="8" height="2" transform="translate(16 46) rotate(-180)"></rect><rect x="6" y="18" width="8" height="2" transform="translate(20 38) rotate(-180)"></rect></svg></span></th>
              <th class="sortable" data-sort="clicks" aria-sort="none" tabindex="0" aria-label="Clicks"><span class="th-label-long">Clicks</span><span class="th-label-short"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M9 4.94198C6.47561 4.02693 5.129 3.65381 4.39141 4.39141C3.55146 5.23136 4.15187 6.86106 5.3527 10.1205L7.3603 15.5696C7.96225 17.2035 8.26322 18.0204 8.92489 18.1658C9.58656 18.3111 10.2022 17.6955 11.4334 16.4643L12.6361 15.2616L16.5744 19.1999C16.9821 19.6077 17.186 19.8116 17.4135 19.9058C17.7168 20.0314 18.0575 20.0314 18.3608 19.9058C18.5882 19.8116 18.7921 19.6077 19.1999 19.1999C19.6077 18.7921 19.8116 18.5882 19.9058 18.3608C20.0314 18.0575 20.0314 17.7168 19.9058 17.4135C19.8116 17.186 19.6077 16.9821 19.1999 16.5744L15.2616 12.6361L16.4643 11.4334C17.6955 10.2022 18.3111 9.58656 18.1658 8.92489C18.0204 8.26322 17.2035 7.96225 15.5696 7.3603L13 6.41359"></path></svg></span></th>
              <th class="sortable" data-sort="rev" aria-sort="none" tabindex="0" aria-label="Rev"><span class="th-label-long">Rev</span><span class="th-label-short"><svg viewBox="0 0 256 256" fill="currentColor" aria-hidden="true"><path d="M192,208a8.00008,8.00008,0,0,1-8,8H56a8,8,0,0,1,0-16,28.03146,28.03146,0,0,0,28-28V140H56a8,8,0,0,1,0-16H84V84a52,52,0,0,1,88.76953-36.76953A8.00018,8.00018,0,0,1,161.45508,58.544,35.99961,35.99961,0,0,0,100,84v40h36a8,8,0,0,1,0,16H100v32a43.79679,43.79679,0,0,1-10.08447,28H184A8.00008,8.00008,0,0,1,192,208Z"></path></svg></span></th>
              <th class="sortable" data-sort="cr" aria-sort="none" tabindex="0" aria-label="CR%"><span class="th-label-long">CR%</span><span class="th-label-short"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M5 19L19 5M9 7C9 8.10457 8.10457 9 7 9C5.89543 9 5 8.10457 5 7C5 5.89543 5.89543 5 7 5C8.10457 5 9 5.89543 9 7ZM19 17C19 18.1046 18.1046 19 17 19C15.8954 19 15 18.1046 15 17C15 15.8954 15.8954 15 17 15C18.1046 15 19 15.8954 19 17Z"></path></svg></span></th>
            </tr>
          </thead>
          <tbody id="worst-products-body">
            <tr><td colspan="5" class="empty">—</td></tr>
          </tbody>
        </table>
      </div>
      <div class="card-pagination" id="worst-products-pagination" aria-label="Worst products pagination">
        <button type="button" id="worst-products-prev">Prev</button>
        <span class="page-label" id="worst-products-label">Page 1 of 1</span>
        <button type="button" id="worst-products-next">Next</button>
      </div>
    </div>
    <div class="stats-card" id="stats-best-variants">
      <div class="country-table-wrap" id="best-variants-wrap">
        <table id="best-variants-table" class="by-country-table best-sellers-table">
          <thead>
            <tr>
              <th class="bs-product-col sortable" data-sort="variant" aria-sort="none" tabindex="0" aria-label="Best Variants"><span class="th-label-long">Best Variants</span><span class="th-label-short">B.Var</span></th>
              <th class="sortable" data-sort="sales" aria-sort="none" tabindex="0" aria-label="Sales"><span class="th-label-long">Sales</span><span class="th-label-short"><svg viewBox="0 0 32 32" fill="currentColor" aria-hidden="true"><path d="M29.4819,8.624l-10-5.5a1,1,0,0,0-.9638,0l-10,5.5a1,1,0,0,0,0,1.752L18,15.5913V26.3086l-3.0362-1.6693L14,26.3912l4.5181,2.4848a.9984.9984,0,0,0,.9638,0l10-5.5A1,1,0,0,0,30,22.5V9.5A1,1,0,0,0,29.4819,8.624ZM19,5.1416,26.9248,9.5,19,13.8584,11.0752,9.5Zm9,16.7671-8,4.4V15.5913l8-4.4Z"></path><rect x="2" y="14" width="8" height="2" transform="translate(12 30) rotate(-180)"></rect><rect x="4" y="22" width="8" height="2" transform="translate(16 46) rotate(-180)"></rect><rect x="6" y="18" width="8" height="2" transform="translate(20 38) rotate(-180)"></rect></svg></span></th>
              <th class="sortable" data-sort="clicks" aria-sort="none" tabindex="0" aria-label="Clicks"><span class="th-label-long">Clicks</span><span class="th-label-short"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M9 4.94198C6.47561 4.02693 5.129 3.65381 4.39141 4.39141C3.55146 5.23136 4.15187 6.86106 5.3527 10.1205L7.3603 15.5696C7.96225 17.2035 8.26322 18.0204 8.92489 18.1658C9.58656 18.3111 10.2022 17.6955 11.4334 16.4643L12.6361 15.2616L16.5744 19.1999C16.9821 19.6077 17.186 19.8116 17.4135 19.9058C17.7168 20.0314 18.0575 20.0314 18.3608 19.9058C18.5882 19.8116 18.7921 19.6077 19.1999 19.1999C19.6077 18.7921 19.8116 18.5882 19.9058 18.3608C20.0314 18.0575 20.0314 17.7168 19.9058 17.4135C19.8116 17.186 19.6077 16.9821 19.1999 16.5744L15.2616 12.6361L16.4643 11.4334C17.6955 10.2022 18.3111 9.58656 18.1658 8.92489C18.0204 8.26322 17.2035 7.96225 15.5696 7.3603L13 6.41359"></path></svg></span></th>
              <th class="sortable" data-sort="rev" aria-sort="none" tabindex="0" aria-label="Rev"><span class="th-label-long">Rev</span><span class="th-label-short"><svg viewBox="0 0 256 256" fill="currentColor" aria-hidden="true"><path d="M192,208a8.00008,8.00008,0,0,1-8,8H56a8,8,0,0,1,0-16,28.03146,28.03146,0,0,0,28-28V140H56a8,8,0,0,1,0-16H84V84a52,52,0,0,1,88.76953-36.76953A8.00018,8.00018,0,0,1,161.45508,58.544,35.99961,35.99961,0,0,0,100,84v40h36a8,8,0,0,1,0,16H100v32a43.79679,43.79679,0,0,1-10.08447,28H184A8.00008,8.00008,0,0,1,192,208Z"></path></svg></span></th>
              <th class="sortable" data-sort="cr" aria-sort="none" tabindex="0" aria-label="CR%"><span class="th-label-long">CR%</span><span class="th-label-short"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M5 19L19 5M9 7C9 8.10457 8.10457 9 7 9C5.89543 9 5 8.10457 5 7C5 5.89543 5.89543 5 7 5C8.10457 5 9 5.89543 9 7ZM19 17C19 18.1046 18.1046 19 17 19C15.8954 19 15 18.1046 15 17C15 15.8954 15.8954 15 17 15C18.1046 15 19 15.8954 19 17Z"></path></svg></span></th>
            </tr>
          </thead>
          <tbody id="best-variants-body">
            <tr><td colspan="5" class="empty">—</td></tr>
          </tbody>
        </table>
      </div>
      <div class="card-pagination" id="best-variants-pagination" aria-label="Best variants pagination">
        <button type="button" id="best-variants-prev">Prev</button>
        <span class="page-label" id="best-variants-label">Page 1 of 1</span>
        <button type="button" id="best-variants-next">Next</button>
      </div>
    </div>
    <div class="stats-card" id="stats-worst-variants">
      <div class="country-table-wrap" id="worst-variants-wrap">
        <table id="worst-variants-table" class="by-country-table best-sellers-table">
          <thead>
            <tr>
              <th class="bs-product-col sortable" data-sort="variant" aria-sort="none" tabindex="0" aria-label="Worst Variants"><span class="th-label-long">Worst Variants</span><span class="th-label-short">W.Var</span></th>
              <th class="sortable" data-sort="sales" aria-sort="none" tabindex="0" aria-label="Sales"><span class="th-label-long">Sales</span><span class="th-label-short"><svg viewBox="0 0 32 32" fill="currentColor" aria-hidden="true"><path d="M29.4819,8.624l-10-5.5a1,1,0,0,0-.9638,0l-10,5.5a1,1,0,0,0,0,1.752L18,15.5913V26.3086l-3.0362-1.6693L14,26.3912l4.5181,2.4848a.9984.9984,0,0,0,.9638,0l10-5.5A1,1,0,0,0,30,22.5V9.5A1,1,0,0,0,29.4819,8.624ZM19,5.1416,26.9248,9.5,19,13.8584,11.0752,9.5Zm9,16.7671-8,4.4V15.5913l8-4.4Z"></path><rect x="2" y="14" width="8" height="2" transform="translate(12 30) rotate(-180)"></rect><rect x="4" y="22" width="8" height="2" transform="translate(16 46) rotate(-180)"></rect><rect x="6" y="18" width="8" height="2" transform="translate(20 38) rotate(-180)"></rect></svg></span></th>
              <th class="sortable" data-sort="clicks" aria-sort="none" tabindex="0" aria-label="Clicks"><span class="th-label-long">Clicks</span><span class="th-label-short"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M9 4.94198C6.47561 4.02693 5.129 3.65381 4.39141 4.39141C3.55146 5.23136 4.15187 6.86106 5.3527 10.1205L7.3603 15.5696C7.96225 17.2035 8.26322 18.0204 8.92489 18.1658C9.58656 18.3111 10.2022 17.6955 11.4334 16.4643L12.6361 15.2616L16.5744 19.1999C16.9821 19.6077 17.186 19.8116 17.4135 19.9058C17.7168 20.0314 18.0575 20.0314 18.3608 19.9058C18.5882 19.8116 18.7921 19.6077 19.1999 19.1999C19.6077 18.7921 19.8116 18.5882 19.9058 18.3608C20.0314 18.0575 20.0314 17.7168 19.9058 17.4135C19.8116 17.186 19.6077 16.9821 19.1999 16.5744L15.2616 12.6361L16.4643 11.4334C17.6955 10.2022 18.3111 9.58656 18.1658 8.92489C18.0204 8.26322 17.2035 7.96225 15.5696 7.3603L13 6.41359"></path></svg></span></th>
              <th class="sortable" data-sort="rev" aria-sort="none" tabindex="0" aria-label="Rev"><span class="th-label-long">Rev</span><span class="th-label-short"><svg viewBox="0 0 256 256" fill="currentColor" aria-hidden="true"><path d="M192,208a8.00008,8.00008,0,0,1-8,8H56a8,8,0,0,1,0-16,28.03146,28.03146,0,0,0,28-28V140H56a8,8,0,0,1,0-16H84V84a52,52,0,0,1,88.76953-36.76953A8.00018,8.00018,0,0,1,161.45508,58.544,35.99961,35.99961,0,0,0,100,84v40h36a8,8,0,0,1,0,16H100v32a43.79679,43.79679,0,0,1-10.08447,28H184A8.00008,8.00008,0,0,1,192,208Z"></path></svg></span></th>
              <th class="sortable" data-sort="cr" aria-sort="none" tabindex="0" aria-label="CR%"><span class="th-label-long">CR%</span><span class="th-label-short"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M5 19L19 5M9 7C9 8.10457 8.10457 9 7 9C5.89543 9 5 8.10457 5 7C5 5.89543 5.89543 5 7 5C8.10457 5 9 5.89543 9 7ZM19 17C19 18.1046 18.1046 19 17 19C15.8954 19 15 18.1046 15 17C15 15.8954 15.8954 15 17 15C18.1046 15 19 15.8954 19 17Z"></path></svg></span></th>
            </tr>
          </thead>
          <tbody id="worst-variants-body">
            <tr><td colspan="5" class="empty">—</td></tr>
          </tbody>
        </table>
      </div>
      <div class="card-pagination" id="worst-variants-pagination" aria-label="Worst variants pagination">
        <button type="button" id="worst-variants-prev">Prev</button>
        <span class="page-label" id="worst-variants-label">Page 1 of 1</span>
        <button type="button" id="worst-variants-next">Next</button>
      </div>
    </div>
  </div>
  </div>
  </div>

  <div id="tab-panel-traffic" class="main-tab-panel" role="tabpanel" aria-labelledby="tab-traffic">
  <div class="stats-row-wrap">
    <div class="table-loading-overlay stats-loading-overlay report-loading-overlay" id="traffic-loading-overlay" style="display: none;">
      <div class="report-build-wrap">
        <div class="spinner"></div>
        <div class="report-build-title">building reports</div>
        <div class="report-build-step" id="traffic-build-step">—</div>
      </div>
    </div>
  <div class="traffic-grid">
    <div class="stats-card" id="traffic-sources-card">
      <div class="traffic-card-header">
        <h3 class="traffic-card-title">Channels</h3>
        <button type="button" id="traffic-sources-config-btn" class="config-btn" title="Select sources" aria-label="Select sources">
          <svg width="18" height="18" viewBox="0 0 492.878 492.878" xmlns="http://www.w3.org/2000/svg" fill="currentColor" aria-hidden="true"><path d="M488.891,175.542l-0.4-1l-0.8-2l-1.6-4l-12.5-32.3l-0.4-1l-0.7-1.6l-0.5-1.1l-1.2-2.2c-1.5-2.6-3.1-4.6-5.1-6.5 c-3.9-3.8-8.7-6.6-14-8.1c-2.6-0.7-5.3-1.1-8.1-1.1c-1.4,0-2.7,0.1-4.1,0.2c-1.2,0.2-3,0.5-3.4,0.6l-8.5,1.7l-24.2,4.9 c-7.2-9.1-15.1-17.6-23.8-25.4l8.8-34.8l0.3-1.4c0.2-1.1,0.3-2.3,0.4-3.5c0.1-2,0.1-3.8-0.1-5.6c-0.4-3.7-1.4-7.4-2.9-10.8 c-3.1-6.8-8.6-12.6-15.4-15.9l-21.4-9.5l-21.3-9.3l-1.5-0.6c-1.1-0.4-2.3-0.7-3.5-1c-1.9-0.4-3.8-0.7-5.7-0.8 c-3.8-0.2-7.7,0.2-11.4,1.3c-7.4,2.1-14,6.7-18.5,12.9l-18.1,28.9c-10.6-1.1-21.4-1.4-32.2-0.8l-17.8-29.5l-0.8-1.2 c-0.7-1-1.5-2-2.4-3c-1.4-1.5-2.8-2.9-4.3-4.1c-3.1-2.5-6.6-4.4-10.3-5.8c-7.4-2.7-15.7-2.9-23.4-0.3c-2.3,0.8-2.7,1-3.7,1.4 l-2.6,1l-5.2,2.1l-10.5,4.2l-21.7,8.7l-1.3,0.6c-1,0.5-2.2,1.1-3.2,1.7c-1.8,1.1-3.4,2.3-4.9,3.6c-3,2.6-5.6,5.8-7.6,9.3 c-4,6.9-5.5,15.3-4.3,23.1l0.5,2.6l0.3,1.4l0.6,2.8l1.2,5.5l2.4,11l2.3,10.3c-8.6,7-16.5,14.8-23.7,23.2l-11.4-2.7l-11.5-2.7 l-5.8-1.3l-2.9-0.7l-1.6-0.3l-0.7-0.1l-1.5-0.2l-1.9-0.2c-8.5-0.6-16.7,1.8-23.3,6.7c-3.3,2.4-6.2,5.5-8.5,8.9 c-1.1,1.7-2.1,3.5-2.9,5.4l-1.2,2.8l-9,21.8l-4.3,9.7l-2.2,4.9l-0.8,2l-0.5,1.2c-0.3,0.8-0.7,2.2-1,3.2c-0.3,1.1-0.4,1.9-0.6,2.9 c-1.2,7.3,0,15,3.3,21.6c1.7,3.3,3.9,6.3,6.5,8.9c2.4,2.6,6.4,5.1,7.2,5.6l25.4,16.8c-1.1,10.5-1.3,21.1-0.7,31.6l-29.2,17.5 c-6.5,4.3-11.8,11.2-14.3,18.6c-2.6,7.4-2.8,15.8-0.2,23.5l8.7,22.1l8.6,21.7c3.2,7.3,9.2,13.8,16.4,17.5 c7.2,3.9,15.9,5.1,23.8,3.6l32.2-6.9c6.5,7.8,13.7,15.1,21.3,21.9l-7.7,32.4l-0.1,0.7l-0.2,1.4c-0.2,1.2-0.3,2.7-0.3,3.7 c-0.1,2,0,4.1,0.3,6.1c0.5,4.1,1.7,8,3.6,11.7c3.6,7.3,9.9,13.5,17.4,16.9l21.3,9l21.5,9c7.5,2.9,16.3,3.1,23.9,0.6 c7.7-2.4,14.6-7.6,19-14.3l18-28.5c10.7,0.8,21.4,0.8,32-0.1l15.7,24.8l1.4,2.2l1.2,1.8l1.1,1.5c0.7,0.9,1.4,1.8,2.1,2.5l1.9,1.9 c1.3,1.2,2.7,2.3,4.1,3.3c5.8,3.9,12.7,6,19.6,5.9c3.5,0,7-0.6,10.3-1.7l2.4-0.9l1.2-0.5l2.4-1l9.5-4c6.4-2.8,12.6-5.5,18.6-8.1 c3.2-1.5,6.4-2.9,9.5-4.3l1.1-0.5c0.4-0.2,1.5-0.8,2.3-1.3c1.7-1,2.6-1.8,3.9-2.8c2.3-1.9,4.3-4.2,5.9-6.5 c3.3-4.8,5.1-10.3,5.4-15.7c0.2-2.7,0-5.3-0.5-7.8l-0.4-1.9c-0.2-0.7-0.2-0.8-0.3-1.2l-0.6-1.9c-1.6-5.1-3.2-9.9-4.8-14.1 c-6.2-17-11.8-26.6-15.8-23.6c-3.6,2.7-4.8,14-3.7,31.7c0.3,4.3,0.8,9.4,1.2,14.2c-0.1,2.2-1.3,4.1-2.9,5.1c-0.3,0.2-1,0.6-1,0.5 c0.4-0.2-0.7,0.3-1.4,0.5c0.2-0.1-0.5,0.2,0.5-0.2l0,0h-0.1h-0.1l-0.3,0.1l-1,0.3l-1.1,0.4c-2.9,1-6,2.1-9.1,3.1 c-6.2,2.2-12.6,4.5-19.3,7.1l-9.3,3.5c-2.1,0.8-1.7,0.6-2.2,0.7c-0.3,0.1-0.7,0-1-0.1c-0.7-0.1-1.3-0.5-1.8-0.9 c-0.1-0.1-0.1-0.1-0.2-0.2c-0.1-0.2-0.3-0.5-0.5-0.7l-2.2-3.7c-6.7-11.4-13.4-22.9-20.2-34.4c-2.7-4.7-8-7.5-13.8-6.9l-0.5,0.1 c-15.6,1.7-31.5,1.4-47-1.3c-5.7-1-11.6,1.4-15,6.5l-0.2,0.4c-8.2,12.3-16.3,24.6-24.5,37c-0.3,0.3-0.4,0.3-0.6,0.3 c-0.1,0-0.1,0-0.1,0l-19.3-8.4l-20.3-8.9l-0.6-0.3c-0.1-0.1,0,0-0.1-0.1l0,0l0,0v-0.1c3.3-13.8,6.6-27.6,9.9-41.3l0.5-2.1v-0.1 c1.5-6.2-0.7-12.9-6.1-17c-12.4-9.4-23.3-20.6-32.7-33.2l-0.1-0.1c-3.7-5-10.2-7.6-16.6-6.2l-43.3,9.7c-0.4,0.1-0.6,0.2-0.9-0.4 l-8.2-20.1l-8.1-19.8c-0.3-0.5-0.1-1.7,0.6-2.1l37.7-23.4l0.2-0.1c4.9-3,7.8-8.7,6.9-14.8c-2.2-15.6-2.2-31.5,0.1-47v-0.3 c0.8-5.5-1.6-11.3-6.6-14.4l-37.6-23.8c-1-0.6-1.5-1.8-1.1-3.1l8.4-20.1l8.5-20.3c0.5-1.2,1.7-2.2,3.7-1.8l43.1,10l0.2,0.1 c4.9,1.1,10.2-0.6,13.3-4.9c5.8-7.8,12.3-15,19.4-21.6c5-4.2,10.2-8,15.7-11.6c4.2-2.8,6.6-7.9,5.6-13.1l-0.2-0.9 c-2.6-14.4-5.2-28.9-7.9-43.4c0-0.5,0.2-0.8,0.5-1c0.1-0.1,0.2-0.2,0.4-0.2l0.2-0.1c-0.1,0.1-0.3,0.2-0.4,0.3l1.1-0.5l20.5-7.6 l10.6-3.9l5.3-2l2.6-1l1.3-0.5c0.2-0.2,0.6,0,0.5-0.5c0,0,0,0.6,0,0.5c0,0,0.1-0.2,0.2-0.3l0,0l0.2,0.3l0.2,0.3 c-1.7-0.8-0.5-0.2-0.8-0.3l0,0v0.1l0.1,0.2l0.4,0.6l0.7,1.2l1.4,2.4l2.9,4.9l5.7,9.7l11.5,19.5c3.4,5.8,10.1,9.4,17.2,8.6l0.6-0.1 c15.1-1.7,30.6-1,46,1.5c7.1,1.2,14.5-1.9,18.6-8.3l0.2-0.4l12.1-18.8l6.1-9.4l3-4.7l1.3-2l0.3,0.1l2.6,1.1l5.1,2.2l10.3,4.5 l10.3,4.5l5.2,2.2l2,0.9v0.1l-0.7,2.7l-1.3,5.5l-2.7,10.9l-5.3,21.8c-1.8,7.3,0.7,15.4,7,20.4l0,0c12,9.4,22.7,20.4,31.5,32.7 c4.5,6.2,12.4,9.6,20.4,7.9l22-4.8l11-2.4l5.5-1.2l2-0.4v0.1l1.1,2.6l2.1,5.2l4.2,10.4l4.2,10.4l2.1,5.2l0.9,2.2l-0.1,0.1 l-2.4,1.5l-4.8,2.9l-9.6,5.9l-19.2,11.8h-0.1c-6.4,3.9-10.2,11.3-9.2,19.2c1.9,15,1.6,30.4-0.7,45.7c-1.1,7.4,2.1,15.1,8.8,19.5 l18.9,12.1l9.5,6.1l4.7,3l1.9,1.2l-0.1,0.2l-1.1,2.6l-2.2,5.2l-4.4,10.3l-4.4,10.3l-2.2,5.1l-0.8,1.8l-0.2-0.1l-2.7-0.7l-5.4-1.4 l-10.9-2.7l-21.7-5.4c-7.2-1.8-15.2,0.6-20.2,6.7l-0.4,0.5l-2.6,3.2c-3.8,4.6-8.3,10.8-12.6,16.4c-4.2,5.6-8.2,10.7-9.8,13.5 c-3.5,5.7-1.5,7,4.3,5.2c5.6-1.7,14.8-6.9,24.5-15c4-3.3,7.8-6.9,11.9-11.1l0.1-0.1c0.1-0.1,0.2-0.1,0.3-0.1 c12.8,4.7,26,9.3,39.7,13.9c1.7,0.5,3.3,1.2,5.7,1.6c2.4,0.4,4.6,0.3,6.9-0.1c4.6-0.8,9.1-3.1,12.4-6.8c0.8-0.9,1.6-1.9,2.3-2.9 c0.7-1,1.3-2.3,1.7-3l2.6-5c1.7-3.3,3.4-6.7,5.1-10c3.4-6.7,6.8-13.5,10.3-20.4l1.3-2.6l0.7-1.7c0.2-0.3,0.5-1.4,0.8-2.2 c0.9-3.1,1.2-5.9,1-9c-0.4-6-2.9-11.9-7.2-16.4c-1.1-1.1-2.2-2.2-3.5-3.1l-2.7-1.9l-4.8-3.4c-3.2-2.3-6.5-4.5-9.7-6.8 c-4.4-3-8.8-6.1-13.2-9.2c1.9-12.5,2.6-25.5,1.8-38.6c9.6-5.7,19.2-11.3,28.9-17.1l1.9-1.1l0.9-0.6l1.4-0.9l0.5-0.4l1-0.7 c0.6-0.5,1.3-1.1,1.8-1.5c1-0.9,1.9-1.8,2.8-2.8c3.4-4,5.8-8.9,6.8-14c1.1-5.1,0.8-10.6-0.9-15.7L488.891,175.542z"/><path d="M310.491,267.942l-1.4,3.9c-0.8,2.7-2.3,5-3.3,7.6c-2.7,4.8-5.6,9.6-9.4,13.8c-7.2,8.6-16.7,15.4-27.3,20 c-3,1.5-6,2.4-8.7,3.9c-2.8,1-5.3,2.5-7.4,3.9c-4.3,2.6-7.3,6.1-6.8,10.6c0.5,4.1,3.7,7.6,9.5,10.1c2.9,0.9,6.5,1.7,10.5,1.8 c4-0.2,8.5-0.3,13.1-1.9c8.5-2.2,16.4-6,24.1-10.4c7.5-4.6,14.6-10.2,20.7-16.7c6-6.6,11.5-13.8,15.5-21.9 c2.2-3.9,3.7-8.2,5.4-12.4c0.8-2.1,1.3-4.3,1.9-6.5s1.2-4.3,1.6-6.8l0.9-5.8l0.4-2.9l0.1-2.3l0.2-4.6l0.1-1.1v-0.6v-0.3v-0.9v-0.1 v-0.2l-0.1-2.7c-0.2-7.2-1.1-14.4-2.9-21.4c-3.5-14-10-27.2-18.9-38.4c-17.7-22.6-44.9-36.5-73.2-37.9c-11.9-2.4-25.4-2.4-38,0.6 c-12.8,2.9-25.1,8.6-35.8,16.5c-10.7,8-19.9,18.2-26.8,29.9l-4.7,9c-1.3,3.1-2.5,6.3-3.8,9.5c-1,3.2-1.9,6.5-2.8,9.8 c-0.8,3.5-1.3,7.3-1.9,10.9l-0.2,1.4l0.1,1.2l-0.1,2.1l-0.3,4.1l-0.1,1v0.5v1.1v0.2v0.3l0.1,2.5l0.2,5.1 c0.4,6.8,1.5,13.5,3.3,20.1c3.5,13.2,9.5,25.6,17.6,36.5s18.2,20.2,29.7,27.3c2.8,1.9,5.8,3.5,8.9,5c3,1.6,6.1,2.9,9.3,4.1 c3.1,1.3,6.4,2.4,9.6,3.3l4.9,1.4l5.5,1c6,1.2,11.7-2.2,13.9-4.4c4.1-4.6-0.5-9-7.8-12.8c-12.1-6.8-22.7-14.8-32-24 c-9.1-9.4-16.7-20.1-21.8-31.8c-3.2-7-4.9-14.6-5.6-22.1c-0.1-1.9-0.5-3.8-0.3-5.7l0.1-2.8v-1.4v-0.7v-0.2c0.5-4.4,0.9-9.4,1.8-12 l0.5-2.4c0.2-0.8,0.6-1.7,0.8-2.6c0.6-1.7,1-3.6,1.8-5.2l2.2-5.1l2.7-4.8c3.8-6.3,8.5-11.9,13.9-16.8c5.4-4.8,11.6-8.7,18.1-11.7 c3.2-1.6,6.7-2.6,10.1-3.8c3.5-0.8,6.9-1.7,10.5-2l2.7-0.4l2.7-0.1l2.7-0.1l1.3-0.1h0.1h0.7l6.9,0.4l4.7,0.7 c6.6,1.1,13.9,3.4,20.4,6.5c6.1,3.9,11.5,8.8,16.1,14.2c14.9,17.1,20.2,41.2,14.5,62.7L310.491,267.942z"/></svg>
        </button>
      </div>
      <div class="country-table-wrap">
        <table id="traffic-sources-table" class="by-country-table">
          <thead>
            <tr>
              <th class="sortable" data-sort="source" aria-sort="none" tabindex="0" aria-label="Source"><span class="th-label-long">Source</span><span class="th-label-short">Src</span></th>
              <th class="sortable" data-sort="cr" aria-sort="none" tabindex="0" aria-label="CR%"><span class="th-label-long">CR%</span><span class="th-label-short"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M5 19L19 5M9 7C9 8.10457 8.10457 9 7 9C5.89543 9 5 8.10457 5 7C5 5.89543 5.89543 5 7 5C8.10457 5 9 5.89543 9 7ZM19 17C19 18.1046 18.1046 19 17 19C15.8954 19 15 18.1046 15 17C15 15.8954 15.8954 15 17 15C18.1046 15 19 15.8954 19 17Z"></path></svg></span></th>
              <th class="sortable" data-sort="orders" aria-sort="none" tabindex="0" aria-label="Orders"><span class="th-label-long">Orders</span><span class="th-label-short"><svg viewBox="0 0 32 32" fill="currentColor" aria-hidden="true"><path d="M29.4819,8.624l-10-5.5a1,1,0,0,0-.9638,0l-10,5.5a1,1,0,0,0,0,1.752L18,15.5913V26.3086l-3.0362-1.6693L14,26.3912l4.5181,2.4848a.9984.9984,0,0,0,.9638,0l10-5.5A1,1,0,0,0,30,22.5V9.5A1,1,0,0,0,29.4819,8.624ZM19,5.1416,26.9248,9.5,19,13.8584,11.0752,9.5Zm9,16.7671-8,4.4V15.5913l8-4.4Z"></path><rect x="2" y="14" width="8" height="2" transform="translate(12 30) rotate(-180)"></rect><rect x="4" y="22" width="8" height="2" transform="translate(16 46) rotate(-180)"></rect><rect x="6" y="18" width="8" height="2" transform="translate(20 38) rotate(-180)"></rect></svg></span></th>
              <th class="sortable" data-sort="sessions" aria-sort="none" tabindex="0" aria-label="Sessions"><span class="th-label-long">Sessions</span><span class="th-label-short"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><circle cx="12" cy="6" r="4"></circle><path d="M19.9975 18C20 17.8358 20 17.669 20 17.5C20 15.0147 16.4183 13 12 13C7.58172 13 4 15.0147 4 17.5C4 19.9853 4 22 12 22C14.231 22 15.8398 21.8433 17 21.5634"></path></svg></span></th>
              <th class="sortable" data-sort="rev" aria-sort="none" tabindex="0" aria-label="Rev"><span class="th-label-long">Rev</span><span class="th-label-short"><svg viewBox="0 0 256 256" fill="currentColor" aria-hidden="true"><path d="M192,208a8.00008,8.00008,0,0,1-8,8H56a8,8,0,0,1,0-16,28.03146,28.03146,0,0,0,28-28V140H56a8,8,0,0,1,0-16H84V84a52,52,0,0,1,88.76953-36.76953A8.00018,8.00018,0,0,1,161.45508,58.544,35.99961,35.99961,0,0,0,100,84v40h36a8,8,0,0,1,0,16H100v32a43.79679,43.79679,0,0,1-10.08447,28H184A8.00008,8.00008,0,0,1,192,208Z"></path></svg></span></th>
            </tr>
          </thead>
          <tbody id="traffic-sources-body">
            <tr><td colspan="5" class="empty">Click the settings icon to add sources.</td></tr>
          </tbody>
        </table>
      </div>
    </div>
    <div class="stats-card" id="traffic-types-card">
      <div class="traffic-card-header">
        <h3 class="traffic-card-title">Traffic</h3>
        <button type="button" id="traffic-types-config-btn" class="config-btn" title="Select traffic types" aria-label="Select traffic types">
          <svg width="18" height="18" viewBox="0 0 492.878 492.878" xmlns="http://www.w3.org/2000/svg" fill="currentColor" aria-hidden="true"><path d="M488.891,175.542l-0.4-1l-0.8-2l-1.6-4l-12.5-32.3l-0.4-1l-0.7-1.6l-0.5-1.1l-1.2-2.2c-1.5-2.6-3.1-4.6-5.1-6.5 c-3.9-3.8-8.7-6.6-14-8.1c-2.6-0.7-5.3-1.1-8.1-1.1c-1.4,0-2.7,0.1-4.1,0.2c-1.2,0.2-3,0.5-3.4,0.6l-8.5,1.7l-24.2,4.9 c-7.2-9.1-15.1-17.6-23.8-25.4l8.8-34.8l0.3-1.4c0.2-1.1,0.3-2.3,0.4-3.5c0.1-2,0.1-3.8-0.1-5.6c-0.4-3.7-1.4-7.4-2.9-10.8 c-3.1-6.8-8.6-12.6-15.4-15.9l-21.4-9.5l-21.3-9.3l-1.5-0.6c-1.1-0.4-2.3-0.7-3.5-1c-1.9-0.4-3.8-0.7-5.7-0.8 c-3.8-0.2-7.7,0.2-11.4,1.3c-7.4,2.1-14,6.7-18.5,12.9l-18.1,28.9c-10.6-1.1-21.4-1.4-32.2-0.8l-17.8-29.5l-0.8-1.2 c-0.7-1-1.5-2-2.4-3c-1.4-1.5-2.8-2.9-4.3-4.1c-3.1-2.5-6.6-4.4-10.3-5.8c-7.4-2.7-15.7-2.9-23.4-0.3c-2.3,0.8-2.7,1-3.7,1.4 l-2.6,1l-5.2,2.1l-10.5,4.2l-21.7,8.7l-1.3,0.6c-1,0.5-2.2,1.1-3.2,1.7c-1.8,1.1-3.4,2.3-4.9,3.6c-3,2.6-5.6,5.8-7.6,9.3 c-4,6.9-5.5,15.3-4.3,23.1l0.5,2.6l0.3,1.4l0.6,2.8l1.2,5.5l2.4,11l2.3,10.3c-8.6,7-16.5,14.8-23.7,23.2l-11.4-2.7l-11.5-2.7 l-5.8-1.3l-2.9-0.7l-1.6-0.3l-0.7-0.1l-1.5-0.2l-1.9-0.2c-8.5-0.6-16.7,1.8-23.3,6.7c-3.3,2.4-6.2,5.5-8.5,8.9 c-1.1,1.7-2.1,3.5-2.9,5.4l-1.2,2.8l-9,21.8l-4.3,9.7l-2.2,4.9l-0.8,2l-0.5,1.2c-0.3,0.8-0.7,2.2-1,3.2c-0.3,1.1-0.4,1.9-0.6,2.9 c-1.2,7.3,0,15,3.3,21.6c1.7,3.3,3.9,6.3,6.5,8.9c2.4,2.6,6.4,5.1,7.2,5.6l25.4,16.8c-1.1,10.5-1.3,21.1-0.7,31.6l-29.2,17.5 c-6.5,4.3-11.8,11.2-14.3,18.6c-2.6,7.4-2.8,15.8-0.2,23.5l8.7,22.1l8.6,21.7c3.2,7.3,9.2,13.8,16.4,17.5 c7.2,3.9,15.9,5.1,23.8,3.6l32.2-6.9c6.5,7.8,13.7,15.1,21.3,21.9l-7.7,32.4l-0.1,0.7l-0.2,1.4c-0.2,1.2-0.3,2.7-0.3,3.7 c-0.1,2,0,4.1,0.3,6.1c0.5,4.1,1.7,8,3.6,11.7c3.6,7.3,9.9,13.5,17.4,16.9l21.3,9l21.5,9c7.5,2.9,16.3,3.1,23.9,0.6 c7.7-2.4,14.6-7.6,19-14.3l18-28.5c10.7,0.8,21.4,0.8,32-0.1l15.7,24.8l1.4,2.2l1.2,1.8l1.1,1.5c0.7,0.9,1.4,1.8,2.1,2.5l1.9,1.9 c1.3,1.2,2.7,2.3,4.1,3.3c5.8,3.9,12.7,6,19.6,5.9c3.5,0,7-0.6,10.3-1.7l2.4-0.9l1.2-0.5l2.4-1l9.5-4c6.4-2.8,12.6-5.5,18.6-8.1 c3.2-1.5,6.4-2.9,9.5-4.3l1.1-0.5c0.4-0.2,1.5-0.8,2.3-1.3c1.7-1,2.6-1.8,3.9-2.8c2.3-1.9,4.3-4.2,5.9-6.5 c3.3-4.8,5.1-10.3,5.4-15.7c0.2-2.7,0-5.3-0.5-7.8l-0.4-1.9c-0.2-0.7-0.2-0.8-0.3-1.2l-0.6-1.9c-1.6-5.1-3.2-9.9-4.8-14.1 c-6.2-17-11.8-26.6-15.8-23.6c-3.6,2.7-4.8,14-3.7,31.7c0.3,4.3,0.8,9.4,1.2,14.2c-0.1,2.2-1.3,4.1-2.9,5.1c-0.3,0.2-1,0.6-1,0.5 c0.4-0.2-0.7,0.3-1.4,0.5c0.2-0.1-0.5,0.2,0.5-0.2l0,0h-0.1h-0.1l-0.3,0.1l-1,0.3l-1.1,0.4c-2.9,1-6,2.1-9.1,3.1 c-6.2,2.2-12.6,4.5-19.3,7.1l-9.3,3.5c-2.1,0.8-1.7,0.6-2.2,0.7c-0.3,0.1-0.7,0-1-0.1c-0.7-0.1-1.3-0.5-1.8-0.9 c-0.1-0.1-0.1-0.1-0.2-0.2c-0.1-0.2-0.3-0.5-0.5-0.7l-2.2-3.7c-6.7-11.4-13.4-22.9-20.2-34.4c-2.7-4.7-8-7.5-13.8-6.9l-0.5,0.1 c-15.6,1.7-31.5,1.4-47-1.3c-5.7-1-11.6,1.4-15,6.5l-0.2,0.4c-8.2,12.3-16.3,24.6-24.5,37c-0.3,0.3-0.4,0.3-0.6,0.3 c-0.1,0-0.1,0-0.1,0l-19.3-8.4l-20.3-8.9l-0.6-0.3c-0.1-0.1,0,0-0.1-0.1l0,0l0,0v-0.1c3.3-13.8,6.6-27.6,9.9-41.3l0.5-2.1v-0.1 c1.5-6.2-0.7-12.9-6.1-17c-12.4-9.4-23.3-20.6-32.7-33.2l-0.1-0.1c-3.7-5-10.2-7.6-16.6-6.2l-43.3,9.7c-0.4,0.1-0.6,0.2-0.9-0.4 l-8.2-20.1l-8.1-19.8c-0.3-0.5-0.1-1.7,0.6-2.1l37.7-23.4l0.2-0.1c4.9-3,7.8-8.7,6.9-14.8c-2.2-15.6-2.2-31.5,0.1-47v-0.3 c0.8-5.5-1.6-11.3-6.6-14.4l-37.6-23.8c-1-0.6-1.5-1.8-1.1-3.1l8.4-20.1l8.5-20.3c0.5-1.2,1.7-2.2,3.7-1.8l43.1,10l0.2,0.1 c4.9,1.1,10.2-0.6,13.3-4.9c5.8-7.8,12.3-15,19.4-21.6c5-4.2,10.2-8,15.7-11.6c4.2-2.8,6.6-7.9,5.6-13.1l-0.2-0.9 c-2.6-14.4-5.2-28.9-7.9-43.4c0-0.5,0.2-0.8,0.5-1c0.1-0.1,0.2-0.2,0.4-0.2l0.2-0.1c-0.1,0.1-0.3,0.2-0.4,0.3l1.1-0.5l20.5-7.6 l10.6-3.9l5.3-2l2.6-1l1.3-0.5c0.2-0.2,0.6,0,0.5-0.5c0,0,0,0.6,0,0.5c0,0,0.1-0.2,0.2-0.3l0,0l0.2,0.3l0.2,0.3 c-1.7-0.8-0.5-0.2-0.8-0.3l0,0v0.1l0.1,0.2l0.4,0.6l0.7,1.2l1.4,2.4l2.9,4.9l5.7,9.7l11.5,19.5c3.4,5.8,10.1,9.4,17.2,8.6l0.6-0.1 c15.1-1.7,30.6-1,46,1.5c7.1,1.2,14.5-1.9,18.6-8.3l0.2-0.4l12.1-18.8l6.1-9.4l3-4.7l1.3-2l0.3,0.1l2.6,1.1l5.1,2.2l10.3,4.5 l10.3,4.5l5.2,2.2l2,0.9v0.1l-0.7,2.7l-1.3,5.5l-2.7,10.9l-5.3,21.8c-1.8,7.3,0.7,15.4,7,20.4l0,0c12,9.4,22.7,20.4,31.5,32.7 c4.5,6.2,12.4,9.6,20.4,7.9l22-4.8l11-2.4l5.5-1.2l2-0.4v0.1l1.1,2.6l2.1,5.2l4.2,10.4l4.2,10.4l2.1,5.2l0.9,2.2l-0.1,0.1 l-2.4,1.5l-4.8,2.9l-9.6,5.9l-19.2,11.8h-0.1c-6.4,3.9-10.2,11.3-9.2,19.2c1.9,15,1.6,30.4-0.7,45.7c-1.1,7.4,2.1,15.1,8.8,19.5 l18.9,12.1l9.5,6.1l4.7,3l1.9,1.2l-0.1,0.2l-1.1,2.6l-2.2,5.2l-4.4,10.3l-4.4,10.3l-2.2,5.1l-0.8,1.8l-0.2-0.1l-2.7-0.7l-5.4-1.4 l-10.9-2.7l-21.7-5.4c-7.2-1.8-15.2,0.6-20.2,6.7l-0.4,0.5l-2.6,3.2c-3.8,4.6-8.3,10.8-12.6,16.4c-4.2,5.6-8.2,10.7-9.8,13.5 c-3.5,5.7-1.5,7,4.3,5.2c5.6-1.7,14.8-6.9,24.5-15c4-3.3,7.8-6.9,11.9-11.1l0.1-0.1c0.1-0.1,0.2-0.1,0.3-0.1 c12.8,4.7,26,9.3,39.7,13.9c1.7,0.5,3.3,1.2,5.7,1.6c2.4,0.4,4.6,0.3,6.9-0.1c4.6-0.8,9.1-3.1,12.4-6.8c0.8-0.9,1.6-1.9,2.3-2.9 c0.7-1,1.3-2.3,1.7-3l2.6-5c1.7-3.3,3.4-6.7,5.1-10c3.4-6.7,6.8-13.5,10.3-20.4l1.3-2.6l0.7-1.7c0.2-0.3,0.5-1.4,0.8-2.2 c0.9-3.1,1.2-5.9,1-9c-0.4-6-2.9-11.9-7.2-16.4c-1.1-1.1-2.2-2.2-3.5-3.1l-2.7-1.9l-4.8-3.4c-3.2-2.3-6.5-4.5-9.7-6.8 c-4.4-3-8.8-6.1-13.2-9.2c1.9-12.5,2.6-25.5,1.8-38.6c9.6-5.7,19.2-11.3,28.9-17.1l1.9-1.1l0.9-0.6l1.4-0.9l0.5-0.4l1-0.7 c0.6-0.5,1.3-1.1,1.8-1.5c1-0.9,1.9-1.8,2.8-2.8c3.4-4,5.8-8.9,6.8-14c1.1-5.1,0.8-10.6-0.9-15.7L488.891,175.542z"/><path d="M310.491,267.942l-1.4,3.9c-0.8,2.7-2.3,5-3.3,7.6c-2.7,4.8-5.6,9.6-9.4,13.8c-7.2,8.6-16.7,15.4-27.3,20 c-3,1.5-6,2.4-8.7,3.9c-2.8,1-5.3,2.5-7.4,3.9c-4.3,2.6-7.3,6.1-6.8,10.6c0.5,4.1,3.7,7.6,9.5,10.1c2.9,0.9,6.5,1.7,10.5,1.8 c4-0.2,8.5-0.3,13.1-1.9c8.5-2.2,16.4-6,24.1-10.4c7.5-4.6,14.6-10.2,20.7-16.7c6-6.6,11.5-13.8,15.5-21.9 c2.2-3.9,3.7-8.2,5.4-12.4c0.8-2.1,1.3-4.3,1.9-6.5s1.2-4.3,1.6-6.8l0.9-5.8l0.4-2.9l0.1-2.3l0.2-4.6l0.1-1.1v-0.6v-0.3v-0.9v-0.1 v-0.2l-0.1-2.7c-0.2-7.2-1.1-14.4-2.9-21.4c-3.5-14-10-27.2-18.9-38.4c-17.7-22.6-44.9-36.5-73.2-37.9c-11.9-2.4-25.4-2.4-38,0.6 c-12.8,2.9-25.1,8.6-35.8,16.5c-10.7,8-19.9,18.2-26.8,29.9l-4.7,9c-1.3,3.1-2.5,6.3-3.8,9.5c-1,3.2-1.9,6.5-2.8,9.8 c-0.8,3.5-1.3,7.3-1.9,10.9l-0.2,1.4l0.1,1.2l-0.1,2.1l-0.3,4.1l-0.1,1v0.5v1.1v0.2v0.3l0.1,2.5l0.2,5.1 c0.4,6.8,1.5,13.5,3.3,20.1c3.5,13.2,9.5,25.6,17.6,36.5s18.2,20.2,29.7,27.3c2.8,1.9,5.8,3.5,8.9,5c3,1.6,6.1,2.9,9.3,4.1 c3.1,1.3,6.4,2.4,9.6,3.3l4.9,1.4l5.5,1c6,1.2,11.7-2.2,13.9-4.4c4.1-4.6-0.5-9-7.8-12.8c-12.1-6.8-22.7-14.8-32-24 c-9.1-9.4-16.7-20.1-21.8-31.8c-3.2-7-4.9-14.6-5.6-22.1c-0.1-1.9-0.5-3.8-0.3-5.7l0.1-2.8v-1.4v-0.7v-0.2c0.5-4.4,0.9-9.4,1.8-12 l0.5-2.4c0.2-0.8,0.6-1.7,0.8-2.6c0.6-1.7,1-3.6,1.8-5.2l2.2-5.1l2.7-4.8c3.8-6.3,8.5-11.9,13.9-16.8c5.4-4.8,11.6-8.7,18.1-11.7 c3.2-1.6,6.7-2.6,10.1-3.8c3.5-0.8,6.9-1.7,10.5-2l2.7-0.4l2.7-0.1l2.7-0.1l1.3-0.1h0.1h0.7l6.9,0.4l4.7,0.7 c6.6,1.1,13.9,3.4,20.4,6.5c6.1,3.9,11.5,8.8,16.1,14.2c14.9,17.1,20.2,41.2,14.5,62.7L310.491,267.942z"/></svg>
        </button>
      </div>
      <div class="country-table-wrap">
        <table id="traffic-types-table" class="by-country-table">
          <thead>
            <tr>
              <th class="sortable" data-sort="type" aria-sort="none" tabindex="0" aria-label="Type"><span class="th-label-long">Type</span><span class="th-label-short">Type</span></th>
              <th class="sortable" data-sort="cr" aria-sort="none" tabindex="0" aria-label="CR%"><span class="th-label-long">CR%</span><span class="th-label-short"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M5 19L19 5M9 7C9 8.10457 8.10457 9 7 9C5.89543 9 5 8.10457 5 7C5 5.89543 5.89543 5 7 5C8.10457 5 9 5.89543 9 7ZM19 17C19 18.1046 18.1046 19 17 19C15.8954 19 15 18.1046 15 17C15 15.8954 15.8954 15 17 15C18.1046 15 19 15.8954 19 17Z"></path></svg></span></th>
              <th class="sortable" data-sort="orders" aria-sort="none" tabindex="0" aria-label="Orders"><span class="th-label-long">Orders</span><span class="th-label-short"><svg viewBox="0 0 32 32" fill="currentColor" aria-hidden="true"><path d="M29.4819,8.624l-10-5.5a1,1,0,0,0-.9638,0l-10,5.5a1,1,0,0,0,0,1.752L18,15.5913V26.3086l-3.0362-1.6693L14,26.3912l4.5181,2.4848a.9984.9984,0,0,0,.9638,0l10-5.5A1,1,0,0,0,30,22.5V9.5A1,1,0,0,0,29.4819,8.624ZM19,5.1416,26.9248,9.5,19,13.8584,11.0752,9.5Zm9,16.7671-8,4.4V15.5913l8-4.4Z"></path><rect x="2" y="14" width="8" height="2" transform="translate(12 30) rotate(-180)"></rect><rect x="4" y="22" width="8" height="2" transform="translate(16 46) rotate(-180)"></rect><rect x="6" y="18" width="8" height="2" transform="translate(20 38) rotate(-180)"></rect></svg></span></th>
              <th class="sortable" data-sort="sessions" aria-sort="none" tabindex="0" aria-label="Sessions"><span class="th-label-long">Sessions</span><span class="th-label-short"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><circle cx="12" cy="6" r="4"></circle><path d="M19.9975 18C20 17.8358 20 17.669 20 17.5C20 15.0147 16.4183 13 12 13C7.58172 13 4 15.0147 4 17.5C4 19.9853 4 22 12 22C14.231 22 15.8398 21.8433 17 21.5634"></path></svg></span></th>
              <th class="sortable" data-sort="rev" aria-sort="none" tabindex="0" aria-label="Rev"><span class="th-label-long">Rev</span><span class="th-label-short"><svg viewBox="0 0 256 256" fill="currentColor" aria-hidden="true"><path d="M192,208a8.00008,8.00008,0,0,1-8,8H56a8,8,0,0,1,0-16,28.03146,28.03146,0,0,0,28-28V140H56a8,8,0,0,1,0-16H84V84a52,52,0,0,1,88.76953-36.76953A8.00018,8.00018,0,0,1,161.45508,58.544,35.99961,35.99961,0,0,0,100,84v40h36a8,8,0,0,1,0,16H100v32a43.79679,43.79679,0,0,1-10.08447,28H184A8.00008,8.00008,0,0,1,192,208Z"></path></svg></span></th>
            </tr>
          </thead>
          <tbody id="traffic-types-body">
            <tr><td colspan="5" class="empty">Click the settings icon to add types.</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
  </div>
  </div>

  <div id="side-panel" class="side-panel" style="display:none">
    <header class="side-panel-header">
      <h3 class="side-panel-title">Session</h3>
      <button type="button" class="side-panel-close" id="side-close" aria-label="Close">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6L6 18M6 6l12 12"/></svg>
      </button>
    </header>
    <section class="side-panel-section">
      <h4 class="side-panel-section-title"><svg class="side-panel-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>Activity</h4>
      <ul class="side-panel-events" id="side-events"></ul>
    </section>
    <section class="side-panel-section">
      <h4 class="side-panel-section-title"><svg class="side-panel-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>Details</h4>
      <div class="side-panel-meta" id="side-meta"></div>
    </section>
    <section class="side-panel-section">
      <h4 class="side-panel-section-title"><svg class="side-panel-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>Source</h4>
      <div class="side-panel-source" id="side-source"></div>
    </section>
    <section class="side-panel-section">
      <h4 class="side-panel-section-title"><svg class="side-panel-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"/></svg>Network</h4>
      <div id="side-cf" class="side-panel-cf"></div>
    </section>
  </div>
  </main>
  <footer class="dashboard-footer" id="dashboard-footer">
    <span class="footer-last-sale">Last sale: <span id="last-sale-ago">—</span></span>
    <button type="button" id="refresh-btn" class="refresh-btn" title="Refresh" aria-label="Refresh">
      <svg viewBox="0 0 329.028 329.028" xmlns="http://www.w3.org/2000/svg" fill="currentColor"><path d="M241.852,72.459l10.847-54.533c1.184-5.95-1.334-12.028-6.378-15.398c-5.045-3.37-11.623-3.37-16.667,0 L156.182,51.62c-0.004,0.003-0.008,0.006-0.012,0.009c-0.415,0.278-0.817,0.576-1.201,0.893c-0.219,0.181-0.418,0.377-0.625,0.568 c-0.148,0.137-0.304,0.265-0.447,0.408c-0.249,0.25-0.478,0.514-0.707,0.778c-0.088,0.101-0.183,0.196-0.268,0.299 c-0.208,0.253-0.396,0.519-0.586,0.783c-0.095,0.132-0.197,0.259-0.288,0.394c-0.155,0.232-0.292,0.473-0.433,0.712 c-0.109,0.185-0.225,0.365-0.327,0.554c-0.104,0.195-0.192,0.397-0.288,0.597c-0.118,0.245-0.24,0.487-0.344,0.739 c-0.064,0.156-0.115,0.317-0.174,0.475c-0.112,0.299-0.227,0.598-0.32,0.906c-0.042,0.137-0.069,0.276-0.106,0.414 c-0.09,0.329-0.181,0.658-0.248,0.996c-0.045,0.223-0.068,0.45-0.103,0.675c-0.038,0.252-0.088,0.501-0.113,0.758 c-0.051,0.498-0.075,0.998-0.076,1.5c0,0.004-0.001,0.009-0.001,0.013c0,0.058,0.008,0.113,0.009,0.17 c0.004,0.437,0.023,0.874,0.066,1.311c0.016,0.156,0.045,0.307,0.065,0.461c0.043,0.332,0.086,0.664,0.151,0.994 c0.042,0.212,0.102,0.418,0.152,0.627c0.064,0.264,0.124,0.529,0.204,0.791c0.077,0.256,0.173,0.503,0.264,0.753 c0.076,0.208,0.143,0.418,0.229,0.624c0.126,0.305,0.272,0.598,0.418,0.892c0.072,0.146,0.134,0.295,0.211,0.438 c0.203,0.379,0.426,0.745,0.66,1.104c0.036,0.055,0.064,0.113,0.1,0.167l0.019,0.028c0.01,0.015,0.02,0.03,0.03,0.045l49.044,73.401 c2.817,4.217,7.525,6.667,12.47,6.667c0.971,0,1.952-0.094,2.928-0.288c5.951-1.184,10.602-5.835,11.786-11.786l7.052-35.455 c23.901,20.188,39.11,50.36,39.11,84.023c0,60.636-49.331,109.968-109.967,109.968c-60.637,0-109.969-49.332-109.969-109.968 c0-40.179,21.91-77.153,57.179-96.494c7.264-3.983,9.923-13.101,5.94-20.365c-3.983-7.264-13.101-9.924-20.365-5.94 C52.424,90.871,24.546,137.924,24.546,189.06c0,77.178,62.79,139.968,139.969,139.968c77.178,0,139.967-62.79,139.967-139.968 C304.482,140.453,279.571,97.56,241.852,72.459z"/></svg>
    </button>
    <button type="button" id="audio-mute-btn" title="Toggle sale sound" aria-label="Toggle sale sound">
      <svg class="sound-icon-on" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M9.5 19C8.89555 19 7.01237 19 5.61714 19C4.87375 19 4.39116 18.2177 4.72361 17.5528L5.57771 15.8446C5.85542 15.2892 6 14.6774 6 14.0564C6 13.2867 6 12.1434 6 11C6 9 7 5 12 5C17 5 18 9 18 11C18 12.1434 18 13.2867 18 14.0564C18 14.6774 18.1446 15.2892 18.4223 15.8446L19.2764 17.5528C19.6088 18.2177 19.1253 19 18.382 19H14.5M9.5 19C9.5 21 10.5 22 12 22C13.5 22 14.5 21 14.5 19M9.5 19C11.0621 19 14.5 19 14.5 19"/><path d="M12 5V3"/></svg>
      <svg class="sound-icon-off" style="display:none" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M6 15C6 15 6 13 6 11C6 9 7 5 12 5C13.5723 5 14.749 5.39552 15.6235 6M9.5 19C9.5 21 10.5 22 12 22C13.5 22 14.5 21 14.5 19M9.5 19C11.0621 19 14.5 19 14.5 19M9.5 19C9.14909 19 8.36719 19 7.5 19M14.5 19H18.382C19.1253 19 19.6088 18.2177 19.2764 17.5528L18 15C18 15 18 13 18 11C18 10.3755 17.9025 9.55594 17.6161 8.72408"/><path d="M12 5V3"/><path d="M21 3L3 21"/></svg>
    </button>
    <button type="button" id="config-open-btn" class="config-btn" title="Diagnostics" aria-label="Diagnostics">
      <svg width="18" height="18" viewBox="0 0 492.878 492.878" xmlns="http://www.w3.org/2000/svg" fill="currentColor" aria-hidden="true"><path d="M488.891,175.542l-0.4-1l-0.8-2l-1.6-4l-12.5-32.3l-0.4-1l-0.7-1.6l-0.5-1.1l-1.2-2.2c-1.5-2.6-3.1-4.6-5.1-6.5 c-3.9-3.8-8.7-6.6-14-8.1c-2.6-0.7-5.3-1.1-8.1-1.1c-1.4,0-2.7,0.1-4.1,0.2c-1.2,0.2-3,0.5-3.4,0.6l-8.5,1.7l-24.2,4.9 c-7.2-9.1-15.1-17.6-23.8-25.4l8.8-34.8l0.3-1.4c0.2-1.1,0.3-2.3,0.4-3.5c0.1-2,0.1-3.8-0.1-5.6c-0.4-3.7-1.4-7.4-2.9-10.8 c-3.1-6.8-8.6-12.6-15.4-15.9l-21.4-9.5l-21.3-9.3l-1.5-0.6c-1.1-0.4-2.3-0.7-3.5-1c-1.9-0.4-3.8-0.7-5.7-0.8 c-3.8-0.2-7.7,0.2-11.4,1.3c-7.4,2.1-14,6.7-18.5,12.9l-18.1,28.9c-10.6-1.1-21.4-1.4-32.2-0.8l-17.8-29.5l-0.8-1.2 c-0.7-1-1.5-2-2.4-3c-1.4-1.5-2.8-2.9-4.3-4.1c-3.1-2.5-6.6-4.4-10.3-5.8c-7.4-2.7-15.7-2.9-23.4-0.3c-2.3,0.8-2.7,1-3.7,1.4 l-2.6,1l-5.2,2.1l-10.5,4.2l-21.7,8.7l-1.3,0.6c-1,0.5-2.2,1.1-3.2,1.7c-1.8,1.1-3.4,2.3-4.9,3.6c-3,2.6-5.6,5.8-7.6,9.3 c-4,6.9-5.5,15.3-4.3,23.1l0.5,2.6l0.3,1.4l0.6,2.8l1.2,5.5l2.4,11l2.3,10.3c-8.6,7-16.5,14.8-23.7,23.2l-11.4-2.7l-11.5-2.7 l-5.8-1.3l-2.9-0.7l-1.6-0.3l-0.7-0.1l-1.5-0.2l-1.9-0.2c-8.5-0.6-16.7,1.8-23.3,6.7c-3.3,2.4-6.2,5.5-8.5,8.9 c-1.1,1.7-2.1,3.5-2.9,5.4l-1.2,2.8l-9,21.8l-4.3,9.7l-2.2,4.9l-0.8,2l-0.5,1.2c-0.3,0.8-0.7,2.2-1,3.2c-0.3,1.1-0.4,1.9-0.6,2.9 c-1.2,7.3,0,15,3.3,21.6c1.7,3.3,3.9,6.3,6.5,8.9c2.4,2.6,6.4,5.1,7.2,5.6l25.4,16.8c-1.1,10.5-1.3,21.1-0.7,31.6l-29.2,17.5 c-6.5,4.3-11.8,11.2-14.3,18.6c-2.6,7.4-2.8,15.8-0.2,23.5l8.7,22.1l8.6,21.7c3.2,7.3,9.2,13.8,16.4,17.5 c7.2,3.9,15.9,5.1,23.8,3.6l32.2-6.9c6.5,7.8,13.7,15.1,21.3,21.9l-7.7,32.4l-0.1,0.7l-0.2,1.4c-0.2,1.2-0.3,2.7-0.3,3.7 c-0.1,2,0,4.1,0.3,6.1c0.5,4.1,1.7,8,3.6,11.7c3.6,7.3,9.9,13.5,17.4,16.9l21.3,9l21.5,9c7.5,2.9,16.3,3.1,23.9,0.6 c7.7-2.4,14.6-7.6,19-14.3l18-28.5c10.7,0.8,21.4,0.8,32-0.1l15.7,24.8l1.4,2.2l1.2,1.8l1.1,1.5c0.7,0.9,1.4,1.8,2.1,2.5l1.9,1.9 c1.3,1.2,2.7,2.3,4.1,3.3c5.8,3.9,12.7,6,19.6,5.9c3.5,0,7-0.6,10.3-1.7l2.4-0.9l1.2-0.5l2.4-1l9.5-4c6.4-2.8,12.6-5.5,18.6-8.1 c3.2-1.5,6.4-2.9,9.5-4.3l1.1-0.5c0.4-0.2,1.5-0.8,2.3-1.3c1.7-1,2.6-1.8,3.9-2.8c2.3-1.9,4.3-4.2,5.9-6.5 c3.3-4.8,5.1-10.3,5.4-15.7c0.2-2.7,0-5.3-0.5-7.8l-0.4-1.9c-0.2-0.7-0.2-0.8-0.3-1.2l-0.6-1.9c-1.6-5.1-3.2-9.9-4.8-14.1 c-6.2-17-11.8-26.6-15.8-23.6c-3.6,2.7-4.8,14-3.7,31.7c0.3,4.3,0.8,9.4,1.2,14.2c-0.1,2.2-1.3,4.1-2.9,5.1c-0.3,0.2-1,0.6-1,0.5 c0.4-0.2-0.7,0.3-1.4,0.5c0.2-0.1-0.5,0.2,0.5-0.2l0,0h-0.1h-0.1l-0.3,0.1l-1,0.3l-1.1,0.4c-2.9,1-6,2.1-9.1,3.1 c-6.2,2.2-12.6,4.5-19.3,7.1l-9.3,3.5c-2.1,0.8-1.7,0.6-2.2,0.7c-0.3,0.1-0.7,0-1-0.1c-0.7-0.1-1.3-0.5-1.8-0.9 c-0.1-0.1-0.1-0.1-0.2-0.2c-0.1-0.2-0.3-0.5-0.5-0.7l-2.2-3.7c-6.7-11.4-13.4-22.9-20.2-34.4c-2.7-4.7-8-7.5-13.8-6.9l-0.5,0.1 c-15.6,1.7-31.5,1.4-47-1.3c-5.7-1-11.6,1.4-15,6.5l-0.2,0.4c-8.2,12.3-16.3,24.6-24.5,37c-0.3,0.3-0.4,0.3-0.6,0.3 c-0.1,0-0.1,0-0.1,0l-19.3-8.4l-20.3-8.9l-0.6-0.3c-0.1-0.1,0,0-0.1-0.1l0,0l0,0v-0.1c3.3-13.8,6.6-27.6,9.9-41.3l0.5-2.1v-0.1 c1.5-6.2-0.7-12.9-6.1-17c-12.4-9.4-23.3-20.6-32.7-33.2l-0.1-0.1c-3.7-5-10.2-7.6-16.6-6.2l-43.3,9.7c-0.4,0.1-0.6,0.2-0.9-0.4 l-8.2-20.1l-8.1-19.8c-0.3-0.5-0.1-1.7,0.6-2.1l37.7-23.4l0.2-0.1c4.9-3,7.8-8.7,6.9-14.8c-2.2-15.6-2.2-31.5,0.1-47v-0.3 c0.8-5.5-1.6-11.3-6.6-14.4l-37.6-23.8c-1-0.6-1.5-1.8-1.1-3.1l8.4-20.1l8.5-20.3c0.5-1.2,1.7-2.2,3.7-1.8l43.1,10l0.2,0.1 c4.9,1.1,10.2-0.6,13.3-4.9c5.8-7.8,12.3-15,19.4-21.6c5-4.2,10.2-8,15.7-11.6c4.2-2.8,6.6-7.9,5.6-13.1l-0.2-0.9 c-2.6-14.4-5.2-28.9-7.9-43.4c0-0.5,0.2-0.8,0.5-1c0.1-0.1,0.2-0.2,0.4-0.2l0.2-0.1c-0.1,0.1-0.3,0.2-0.4,0.3l1.1-0.5l20.5-7.6 l10.6-3.9l5.3-2l2.6-1l1.3-0.5c0.2-0.2,0.6,0,0.5-0.5c0,0,0,0.6,0,0.5c0,0,0.1-0.2,0.2-0.3l0,0l0.2,0.3l0.2,0.3 c-1.7-0.8-0.5-0.2-0.8-0.3l0,0v0.1l0.1,0.2l0.4,0.6l0.7,1.2l1.4,2.4l2.9,4.9l5.7,9.7l11.5,19.5c3.4,5.8,10.1,9.4,17.2,8.6l0.6-0.1 c15.1-1.7,30.6-1,46,1.5c7.1,1.2,14.5-1.9,18.6-8.3l0.2-0.4l12.1-18.8l6.1-9.4l3-4.7l1.3-2l0.3,0.1l2.6,1.1l5.1,2.2l10.3,4.5 l10.3,4.5l5.2,2.2l2,0.9v0.1l-0.7,2.7l-1.3,5.5l-2.7,10.9l-5.3,21.8c-1.8,7.3,0.7,15.4,7,20.4l0,0c12,9.4,22.7,20.4,31.5,32.7 c4.5,6.2,12.4,9.6,20.4,7.9l22-4.8l11-2.4l5.5-1.2l2-0.4v0.1l1.1,2.6l2.1,5.2l4.2,10.4l4.2,10.4l2.1,5.2l0.9,2.2l-0.1,0.1 l-2.4,1.5l-4.8,2.9l-9.6,5.9l-19.2,11.8h-0.1c-6.4,3.9-10.2,11.3-9.2,19.2c1.9,15,1.6,30.4-0.7,45.7c-1.1,7.4,2.1,15.1,8.8,19.5 l18.9,12.1l9.5,6.1l4.7,3l1.9,1.2l-0.1,0.2l-1.1,2.6l-2.2,5.2l-4.4,10.3l-4.4,10.3l-2.2,5.1l-0.8,1.8l-0.2-0.1l-2.7-0.7l-5.4-1.4 l-10.9-2.7l-21.7-5.4c-7.2-1.8-15.2,0.6-20.2,6.7l-0.4,0.5l-2.6,3.2c-3.8,4.6-8.3,10.8-12.6,16.4c-4.2,5.6-8.2,10.7-9.8,13.5 c-3.5,5.7-1.5,7,4.3,5.2c5.6-1.7,14.8-6.9,24.5-15c4-3.3,7.8-6.9,11.9-11.1l0.1-0.1c0.1-0.1,0.2-0.1,0.3-0.1 c12.8,4.7,26,9.3,39.7,13.9c1.7,0.5,3.3,1.2,5.7,1.6c2.4,0.4,4.6,0.3,6.9-0.1c4.6-0.8,9.1-3.1,12.4-6.8c0.8-0.9,1.6-1.9,2.3-2.9 c0.7-1,1.3-2.3,1.7-3l2.6-5c1.7-3.3,3.4-6.7,5.1-10c3.4-6.7,6.8-13.5,10.3-20.4l1.3-2.6l0.7-1.7c0.2-0.3,0.5-1.4,0.8-2.2 c0.9-3.1,1.2-5.9,1-9c-0.4-6-2.9-11.9-7.2-16.4c-1.1-1.1-2.2-2.2-3.5-3.1l-2.7-1.9l-4.8-3.4c-3.2-2.3-6.5-4.5-9.7-6.8 c-4.4-3-8.8-6.1-13.2-9.2c1.9-12.5,2.6-25.5,1.8-38.6c9.6-5.7,19.2-11.3,28.9-17.1l1.9-1.1l0.9-0.6l1.4-0.9l0.5-0.4l1-0.7 c0.6-0.5,1.3-1.1,1.8-1.5c1-0.9,1.9-1.8,2.8-2.8c3.4-4,5.8-8.9,6.8-14c1.1-5.1,0.8-10.6-0.9-15.7L488.891,175.542z"/><path d="M310.491,267.942l-1.4,3.9c-0.8,2.7-2.3,5-3.3,7.6c-2.7,4.8-5.6,9.6-9.4,13.8c-7.2,8.6-16.7,15.4-27.3,20 c-3,1.5-6,2.4-8.7,3.9c-2.8,1-5.3,2.5-7.4,3.9c-4.3,2.6-7.3,6.1-6.8,10.6c0.5,4.1,3.7,7.6,9.5,10.1c2.9,0.9,6.5,1.7,10.5,1.8 c4-0.2,8.5-0.3,13.1-1.9c8.5-2.2,16.4-6,24.1-10.4c7.5-4.6,14.6-10.2,20.7-16.7c6-6.6,11.5-13.8,15.5-21.9 c2.2-3.9,3.7-8.2,5.4-12.4c0.8-2.1,1.3-4.3,1.9-6.5s1.2-4.3,1.6-6.8l0.9-5.8l0.4-2.9l0.1-2.3l0.2-4.6l0.1-1.1v-0.6v-0.3v-0.9v-0.1 v-0.2l-0.1-2.7c-0.2-7.2-1.1-14.4-2.9-21.4c-3.5-14-10-27.2-18.9-38.4c-17.7-22.6-44.9-36.5-73.2-37.9c-11.9-2.4-25.4-2.4-38,0.6 c-12.8,2.9-25.1,8.6-35.8,16.5c-10.7,8-19.9,18.2-26.8,29.9l-4.7,9c-1.3,3.1-2.5,6.3-3.8,9.5c-1,3.2-1.9,6.5-2.8,9.8 c-0.8,3.5-1.3,7.3-1.9,10.9l-0.2,1.4l0.1,1.2l-0.1,2.1l-0.3,4.1l-0.1,1v0.5v1.1v0.2v0.3l0.1,2.5l0.2,5.1 c0.4,6.8,1.5,13.5,3.3,20.1c3.5,13.2,9.5,25.6,17.6,36.5s18.2,20.2,29.7,27.3c2.8,1.9,5.8,3.5,8.9,5c3,1.6,6.1,2.9,9.3,4.1 c3.1,1.3,6.4,2.4,9.6,3.3l4.9,1.4l5.5,1c6,1.2,11.7-2.2,13.9-4.4c4.1-4.6-0.5-9-7.8-12.8c-12.1-6.8-22.7-14.8-32-24 c-9.1-9.4-16.7-20.1-21.8-31.8c-3.2-7-4.9-14.6-5.6-22.1c-0.1-1.9-0.5-3.8-0.3-5.7l0.1-2.8v-1.4v-0.7v-0.2c0.5-4.4,0.9-9.4,1.8-12 l0.5-2.4c0.2-0.8,0.6-1.7,0.8-2.6c0.6-1.7,1-3.6,1.8-5.2l2.2-5.1l2.7-4.8c3.8-6.3,8.5-11.9,13.9-16.8c5.4-4.8,11.6-8.7,18.1-11.7 c3.2-1.6,6.7-2.6,10.1-3.8c3.5-0.8,6.9-1.7,10.5-2l2.7-0.4l2.7-0.1l2.7-0.1l1.3-0.1h0.1h0.7l6.9,0.4l4.7,0.7 c6.6,1.1,13.9,3.4,20.4,6.5c6.1,3.9,11.5,8.8,16.1,14.2c14.9,17.1,20.2,41.2,14.5,62.7L310.491,267.942z"/></svg>
    </button>
  </footer>

  <div class="config-modal" id="config-modal" aria-hidden="true">
    <div class="config-modal-card" role="dialog" aria-modal="true" aria-label="Diagnostics">
      <div class="config-modal-header">
        <h3 class="config-modal-title">Diagnostics</h3>
        <button type="button" class="config-close" id="config-close-btn" aria-label="Close">×</button>
      </div>
      <div id="config-status"></div>
    </div>
  </div>

  <div class="config-modal" id="traffic-sources-modal" aria-hidden="true">
    <div class="config-modal-card" role="dialog" aria-modal="true" aria-label="Traffic sources">
      <div class="config-modal-header">
        <h3 class="config-modal-title">Traffic · Sources</h3>
        <button type="button" class="config-close" id="traffic-sources-close-btn" aria-label="Close">×</button>
      </div>
      <div class="muted" style="margin-bottom: 0.5rem;">Tick sources to show in the Traffic table. New sources appear here as they’re detected.</div>
      <div id="traffic-sources-picker" class="traffic-picker-list"></div>
      <details class="diag-tech" id="traffic-source-mapping-details" style="margin-top: 0.85rem;">
        <summary>
          <div class="diag-tech-head">
            <strong>Source mapping</strong>
            <span>Map URL UTMs into custom sources + icons</span>
          </div>
          <svg class="diag-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><polyline points="6 9 12 15 18 9"/></svg>
        </summary>
        <div style="border-top: 1px solid var(--border); padding: 0.75rem 0.9rem 0.9rem;">
          <div id="traffic-source-mapping-mini"><div class="muted">Loading…</div></div>
        </div>
      </details>
    </div>
  </div>

  <div class="config-modal" id="traffic-types-modal" aria-hidden="true">
    <div class="config-modal-card" role="dialog" aria-modal="true" aria-label="Traffic types">
      <div class="config-modal-header">
        <h3 class="config-modal-title">Traffic · Types</h3>
        <button type="button" class="config-close" id="traffic-types-close-btn" aria-label="Close">×</button>
      </div>
      <div class="muted" style="margin-bottom: 0.5rem;">Tick device/platform types to show in the Traffic table.</div>
      <div id="traffic-types-picker" class="traffic-picker-list"></div>
    </div>
  </div>

  <div class="config-modal" id="date-custom-modal" aria-hidden="true">
    <div class="config-modal-card" role="dialog" aria-modal="true" aria-label="Choose dates">
      <div class="config-modal-header">
        <h3 class="config-modal-title">Choose dates</h3>
        <button type="button" class="config-close" id="date-custom-close-btn" aria-label="Close">×</button>
      </div>
      <div class="muted" style="margin-bottom: 0.5rem;">Click a start date, then an end date (last 30 days). Grey dates have no data.</div>
      <div id="date-custom-calendar" class="date-cal"></div>
      <div class="date-cal-footer">
        <div class="date-cal-summary" id="date-custom-summary">Select a start date.</div>
        <div class="date-cal-actions">
          <button type="button" class="date-cal-btn" id="date-custom-clear" disabled>Clear</button>
          <button type="button" class="date-cal-btn primary" id="date-custom-apply" disabled>Apply</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API = '';
    const LIVE_REFRESH_MS = 60000;
    const RANGE_REFRESH_MS = 5 * 60 * 1000; // Today and Last Hour refresh every 5 min
    const ACTIVE_WINDOW_MS = 10 * 60 * 1000; // Live view: only show sessions seen in last 10 min
    const ARRIVED_WINDOW_MS = 60 * 60 * 1000; // Live view: only show sessions that arrived in last 60 min
    const STATS_REFRESH_MS = 5 * 60 * 1000; // Breakdown / Products / Traffic refresh (Today only)
    const SALE_MUTED_KEY = 'livevisitors-sale-muted';
    const TOP_TABLE_PAGE_SIZE = 10;
    const ROWS_PER_PAGE_DEFAULT = 25;
    function loadRowsPerPage() {
      return ROWS_PER_PAGE_DEFAULT;
    }
    let rowsPerPage = loadRowsPerPage();
    let sessions = [];
    let sessionsLoadError = null;
    let statsCache = {};
    let trafficCache = null;
    let trafficTypeExpanded = {}; // device -> boolean (Traffic Type tree)
    let dateRange = 'live';
    let customRangeStartYmd = null; // YYYY-MM-DD (admin TZ)
    let customRangeEndYmd = null; // YYYY-MM-DD (admin TZ)
    let pendingCustomRangeStartYmd = null; // modal-only pending selection
    let pendingCustomRangeEndYmd = null; // modal-only pending selection
    let customCalendarLastPayload = null; // last /api/available-days payload used for rendering
    /** When dateRange is 'live' or '1h', stats/KPIs use today's data; only the main table shows live/lasthour. */
    function getStatsRange() { return (dateRange === 'live' || dateRange === '1h') ? 'today' : dateRange; }
    function getKpiData() { return kpiCache || statsCache || {}; }
    let activeMainTab = 'spy';
    let nextLiveAt = 0;
    let nextRangeAt = 0; // next refresh for Today/Last Hour (5 min)
    let lastSessionsFetchedAt = 0;
    let lastSessionsMode = null; // 'live' or 'range' - helps avoid Online count flicker when switching modes
    let lastStatsFetchedAt = 0;
    let lastKpisFetchedAt = 0;
    let lastTrafficFetchedAt = 0;
    let lastProductsFetchedAt = 0;
    let kpiCache = null;
    let liveRefreshInFlight = null;
    let statsRefreshInFlight = null;
    let trafficRefreshInFlight = null;
    let productsRefreshInFlight = null;
    let kpisRefreshInFlight = null;
    let reportBuildTokens = { stats: 0, products: 0, traffic: 0 };
    let lastUpdateTime = null;
    let lastConvertedCountToday = 0;
    let hasSeenConvertedCountToday = false; // prevents "sale" triggers on first load
    let convertedCountDayYmd = null; // YYYY-MM-DD in admin TZ; resets converted-count baseline daily
    let lastSaleAt = null; // ms; authoritative timestamp of most recent sale we know about (Shopify truth preferred)
    let lastOnlineCount = null; // when dateRange !== 'live', we fetch active count so Online always shows real people online
    let onlineCountInFlight = false;
    let shopifySalesToday = null;
    let shopifyOrderCountToday = null;
    let shopifySalesTodayLoaded = false; // true once we have attempted to fetch (success or failure)
    let shopifySalesTodayLoading = false;
    let shopifySessionsToday = null;
    let shopifySessionsTodayLoaded = false;
    let shopifySessionsTodayLoading = false;
    let bestSellersCache = null;
    let worstProductsCache = null;
    let bestVariantsCache = null;
    let worstVariantsCache = null;
    let countryPage = 1;
    let bestGeoProductsPage = 1;
    let bestSellersPage = 1;
    let worstProductsPage = 1;
    let bestVariantsPage = 1;
    let worstVariantsPage = 1;
    let bestSellersSortBy = 'rev';
    let bestSellersSortDir = 'desc';
    const tableSortState = {
      country: { by: 'rev', dir: 'desc' },
      bestGeoProducts: { by: 'rev', dir: 'desc' },
      aov: { by: 'aov', dir: 'desc' },
      worstProducts: { by: 'cr', dir: 'asc' },
      bestVariants: { by: 'rev', dir: 'desc' },
      worstVariants: { by: 'rev', dir: 'asc' },
      trafficSources: { by: 'rev', dir: 'desc' },
      trafficTypes: { by: 'rev', dir: 'desc' },
    };
    const TABLE_SORT_DEFAULTS = {
      country: { country: 'asc', cr: 'desc', sales: 'desc', clicks: 'desc', rev: 'desc' },
      bestGeoProducts: { country: 'asc', cr: 'desc', sales: 'desc', clicks: 'desc', rev: 'desc' },
      aov: { aov: 'desc' },
      worstProducts: { product: 'asc', sales: 'desc', clicks: 'desc', rev: 'desc', cr: 'asc' },
      bestVariants: { variant: 'asc', sales: 'desc', clicks: 'desc', rev: 'desc', cr: 'desc' },
      worstVariants: { variant: 'asc', sales: 'asc', clicks: 'asc', rev: 'asc', cr: 'asc' },
      trafficSources: { source: 'asc', cr: 'desc', orders: 'desc', sessions: 'desc', rev: 'desc' },
      trafficTypes: { type: 'asc', cr: 'desc', orders: 'desc', sessions: 'desc', rev: 'desc' },
    };
    let saleAudio = null;
    let saleMuted = false;
    let saleToastActive = false;
    let saleToastToken = 0; // increments per toast trigger; prevents stale latest-sale fetch overwriting newer toasts
    let saleToastSessionId = null; // best-effort: session_id that opened the current toast (used to avoid double plays)
    let saleToastHideTimer = null;
    let saleToastPendingKpi = null; // { labelText, valueText }
    let saleToastLastOrderId = null;
    let saleToastLastShownAt = 0;
    let currentPage = 1;
    let sortBy = 'last_seen';
    let sortDir = 'desc';
    const SORT_DEFAULTS = { landing: 'asc', from: 'asc', arrived: 'desc', source: 'asc', device: 'asc', cart: 'desc', last_seen: 'desc', history: 'desc' };

    // Auto-configure pixel when opened from Shopify (shop in URL) so merchants don't run mutations manually
    (function ensurePixelOnce() {
      const params = new URLSearchParams(window.location.search);
      const shop = params.get('shop');
      if (shop && /\.myshopify\.com$/i.test(shop)) {
        fetch(API + '/api/pixel/ensure?shop=' + encodeURIComponent(shop), { credentials: 'same-origin' })
          .then(function (r) { return r.json(); })
          .then(function (data) {
            if (data.ok && data.action) console.log('[Live Visitors] Pixel', data.action);
          })
          .catch(function () {});
      }
    })();
    // 'active' = Live view (last 5 min + arrived 60 min). Range mode uses ?range= with pagination.
    let filter = 'active';
    let sessionsTotal = null; // set when fetching by range (today/yesterday/3d/7d); null for Live
    let selectedSessionId = null;
    let timeTick = null;
    const tz = 'Europe/London';

    function updateServerTimeDisplay() {
      const el = document.getElementById('server-time-msg');
      if (!el) return;
      var now = new Date();
      el.textContent = now.toLocaleTimeString('en-GB', { timeZone: tz, hour: '2-digit', minute: '2-digit', hour12: false });
    }

    const NEXT_UPDATE_CIRCLE_C = 2 * Math.PI * 15.9;
    function updateNextUpdateUi() {
      const block = document.querySelector('#tab-panel-spy .next-update-block');
      if (!block) return;
      const labelEl = document.getElementById('next-update-label');
      const timerWrap = document.getElementById('next-update-timer-wrap');
      const liveEl = document.getElementById('next-update-live-indicator');
      const progressEl = document.getElementById('next-update-circle-progress');

      const isLive = dateRange === 'live';
      const show = activeMainTab === 'spy' && (isLive || dateRange === '1h' || dateRange === 'today');
      if (!show) {
        block.style.display = 'none';
        return;
      }

      block.style.display = 'inline-flex';

      if (isLive) {
        if (labelEl) labelEl.style.display = 'none';
        if (timerWrap) timerWrap.style.display = 'none';
        if (liveEl) liveEl.style.display = 'inline-flex';
        return;
      }

      if (labelEl) labelEl.style.display = '';
      if (timerWrap) timerWrap.style.display = 'inline-flex';
      if (liveEl) liveEl.style.display = 'none';
      if (!progressEl) return;

      const duration = RANGE_REFRESH_MS;
      const target = (typeof nextRangeAt === 'number' && nextRangeAt > Date.now())
        ? nextRangeAt
        : (Date.now() + RANGE_REFRESH_MS);
      const remaining = Math.max(0, target - Date.now());
      const progress = Math.min(1, 1 - remaining / duration);
      progressEl.style.strokeDasharray = String(NEXT_UPDATE_CIRCLE_C);
      progressEl.style.strokeDashoffset = String(NEXT_UPDATE_CIRCLE_C * (1 - progress));
    }

    function toMs(v) {
      if (v == null || v === '') return null;
      let n = typeof v === 'number' ? v : Number(v);
      if (Number.isNaN(n)) return null;
      if (n < 1e12) n *= 1000;
      return n;
    }

    function formatTs(ms) {
      const n = toMs(ms);
      if (n == null) return '\u2014';
      const d = new Date(n);
      if (Number.isNaN(d.getTime())) return '\u2014';
      return d.toLocaleString('en-GB', { timeZone: tz, dateStyle: 'short', timeStyle: 'short' });
    }

    function formatRelative(ms) {
      const n = toMs(ms);
      if (n == null) return '';
      const s = Math.floor((Date.now() - n) / 1000);
      if (s < 60) return s + 's ago';
      if (s < 3600) return Math.floor(s / 60) + 'm ago';
      return Math.floor(s / 3600) + 'h ago';
    }

    function ymdNowInTz() {
      try {
        // en-CA yields YYYY-MM-DD.
        return new Intl.DateTimeFormat('en-CA', { timeZone: tz, year: 'numeric', month: '2-digit', day: '2-digit' }).format(new Date());
      } catch (_) {
        return new Date().toISOString().slice(0, 10);
      }
    }

    function updateLastSaleAgo() {
      const el = document.getElementById('last-sale-ago');
      if (!el) return;
      if (lastSaleAt == null) { el.textContent = '\u2014'; return; }
      el.textContent = formatRelative(lastSaleAt);
    }

    function setLastSaleAt(ms) {
      const n = toMs(ms);
      if (n == null) return;
      const cur = lastSaleAt == null ? null : toMs(lastSaleAt);
      if (cur == null || n > cur) {
        lastSaleAt = n;
        updateLastSaleAgo();
      }
    }

    function formatDuration(startMs) {
      const n = toMs(startMs);
      if (n == null) return '';
      const s = Math.floor((Date.now() - n) / 1000);
      const m = Math.floor(s / 60);
      const h = Math.floor(m / 60);
      if (h > 0) return h + 'h ' + (m % 60) + 'm';
      if (m > 0) return m + 'm ' + (s % 60) + 's';
      return s + 's';
    }

    var countryNames = { GB: 'UK', US: 'USA', CA: 'CA', AU: 'AU', DE: 'DE', FR: 'FR', IE: 'IE', ES: 'ES', IT: 'IT', NL: 'NL', IN: 'IN', JP: 'JP', DK: 'DK', SE: 'SE', NO: 'NO', TH: 'TH', NZ: 'NZ', RO: 'RO', BE: 'BE', FI: 'FI', AE: 'UAE', XX: '\u2014' };
    var countryNamesFull = { GB: 'United Kingdom', US: 'United States', CA: 'Canada', AU: 'Australia', DE: 'Germany', FR: 'France', IE: 'Ireland', ES: 'Spain', IT: 'Italy', NL: 'Netherlands', IN: 'India', JP: 'Japan', DK: 'Denmark', SE: 'Sweden', NO: 'Norway', TH: 'Thailand', NZ: 'New Zealand', RO: 'Romania', BE: 'Belgium', FI: 'Finland', AE: 'United Arab Emirates', XX: '\u2014' };

    function countryLabel(code) {
      if (!code) return 'Unknown';
      var c = (code || 'XX').toUpperCase().slice(0, 2);
      return countryNames[c] || c;
    }

    function countryLabelFull(code) {
      if (!code) return 'Unknown';
      var c = (code || 'XX').toUpperCase().slice(0, 2);
      return countryNamesFull[c] || countryNames[c] || c;
    }

    // Add width=100 to hotlinked images (? or & depending on existing params).
    function hotImg(url) {
      if (typeof url !== 'string') return url;
      if (/^https?:\/\//i.test(url)) {
        try {
          const u = new URL(url);
          u.searchParams.set('width', '100');
          return u.toString();
        } catch (_) {
          return url + (url.indexOf('?') >= 0 ? '&' : '?') + 'width=100';
        }
      }
      return url + (url.indexOf('?') >= 0 ? '&' : '?') + 'width=100';
    }
    // Product thumbs: request square (width + height) so object-fit: cover gives identical framing.
    function hotImgSquare(url) {
      if (typeof url !== 'string') return url;
      if (/^https?:\/\//i.test(url)) {
        try {
          const u = new URL(url);
          u.searchParams.set('width', '100');
          u.searchParams.set('height', '100');
          if (u.hostname.includes('shopify.com')) u.searchParams.set('crop', 'center');
          return u.toString();
        } catch (_) {
          const sep = url.indexOf('?') >= 0 ? '&' : '?';
          return url + sep + 'width=100&height=100';
        }
      }
      return url + (url.indexOf('?') >= 0 ? '&' : '?') + 'width=100&height=100';
    }

    function flagImg(code) {
      if (!code || code === 'XX') return '<img class="flag-img" src="' + hotImg('https://flagcdn.com/w40/xx.png') + '" alt="?" loading="lazy">';
      const c = (code || 'xx').toLowerCase().slice(0, 2);
      return '<img class="flag-img" src="' + hotImg('https://flagcdn.com/w40/' + escapeHtml(c) + '.png') + '" alt="' + escapeHtml(code) + '" loading="lazy">';
    }

    function flagImgSmall(code) {
      const src = (!code || code === 'XX')
        ? hotImg('https://flagcdn.com/w40/xx.png')
        : hotImg('https://flagcdn.com/w40/' + escapeHtml((code || 'xx').toLowerCase().slice(0, 2)) + '.png');
      return '<img class="sale-toast-inline-flag-img" src="' + src + '" alt="" aria-hidden="true" loading="lazy">';
    }

    function arrivedAgo(startedAt) {
      var n = toMs(startedAt);
      if (n == null) return '\u2014';
      var s = Math.floor((Date.now() - n) / 1000);
      if (s < 60) return s + ' secs ago';
      if (s < 3600) return Math.floor(s / 60) + ' mins ago';
      if (s < 86400) return Math.floor(s / 3600) + ' hrs ago';
      return Math.floor(s / 86400) + ' days ago';
    }

    var storeBaseUrlFallback = '';
    var mainBaseUrlFallback = '';
    var assetsBaseUrlFallback = '';
    var shopForSalesFallback = '';
    var storeBaseUrlLoaded = false;
    (function fetchStoreBaseUrl() {
      fetch(API + '/api/store-base-url', { credentials: 'same-origin' })
        .then(function(r) { return r.json(); })
        .then(function(d) {
          if (d) {
            if (d.baseUrl) storeBaseUrlFallback = d.baseUrl;
            if (d.mainBaseUrl) mainBaseUrlFallback = d.mainBaseUrl;
            if (d.assetsBaseUrl) assetsBaseUrlFallback = d.assetsBaseUrl;
            if (d.shopForSales) shopForSalesFallback = d.shopForSales;
            if (sessions.length) renderTable();
            if (assetsBaseUrlFallback) {
              var link = document.querySelector('link[rel="icon"]');
              if (link) link.href = 'https://cdn.shopify.com/s/files/1/0847/7261/8587/files/favicon_e309db0f-dddb-48bf-83f4-a602cc9834d6.png';
              if (typeof saleAudio !== 'undefined' && saleAudio) saleAudio.src = CASH_REGISTER_MP3_URL;
            }
            if (activeMainTab === 'products' && shopForSalesFallback && typeof fetchBestSellers === 'function') fetchBestSellers();
            if (activeMainTab === 'products' && shopForSalesFallback && typeof fetchBestVariants === 'function') fetchBestVariants();
            if (activeMainTab === 'products' && shopForSalesFallback && typeof fetchWorstVariants === 'function') fetchWorstVariants();
          }
          storeBaseUrlLoaded = true;
          if (typeof renderSales === 'function') renderSales(statsCache);
        })
        .catch(function() { storeBaseUrlLoaded = true; if (typeof renderSales === 'function') renderSales(statsCache); });
    })();

    function getShopForSales() {
      var shop = getShopParam() || shopForSalesFallback || null;
      return shop && /\.myshopify\.com$/i.test(shop) ? shop : null;
    }

    function getStoreBaseUrl() {
      var params = new URLSearchParams(window.location.search);
      var shop = params.get('shop');
      if (shop && /\.myshopify\.com$/i.test(shop)) return 'https://' + shop;
      return storeBaseUrlFallback || '';
    }
    function getMainBaseUrl() {
      if (mainBaseUrlFallback) return mainBaseUrlFallback;
      return getStoreBaseUrl();
    }
    function getAssetsBase() {
      if (assetsBaseUrlFallback) return assetsBaseUrlFallback;
      return (API || '') + '/assets';
    }

    var HICON_URL = hotImg('https://cdn.shopify.com/s/files/1/0847/7261/8587/files/hicon.webp?v=1770084894');
    var DOLLAR_URL = hotImg('https://cdn.shopify.com/s/files/1/0847/7261/8587/files/dollar.png?v=1770085223');
    var NEW_SALE_BIRD_URL = hotImgSquare('https://cdn.shopify.com/s/files/1/0847/7261/8587/files/newsalebird.webp?v=1770255597');
    var CASH_REGISTER_MP3_URL = 'https://cdn.shopify.com/s/files/1/0847/7261/8587/files/cash-register.mp3?v=1770171264';

    function titleCaseFromHandle(handle) {
      if (typeof handle !== 'string') return null;
      let s = handle;
      try { s = decodeURIComponent(s); } catch (_) {}
      s = s.replace(/[-_]+/g, ' ').replace(/\s+/g, ' ').trim();
      if (!s) return null;
      return s.split(' ').filter(Boolean).map(function(w) {
        const lower = w.toLowerCase();
        return lower.charAt(0).toUpperCase() + lower.slice(1);
      }).join(' ');
    }

    function productTitleFromPath(path) {
      if (typeof path !== 'string') return null;
      const m = path.trim().match(/^\/products\/([^/?#]+)/i);
      if (!m) return null;
      return titleCaseFromHandle(m[1]);
    }

    /** For display: /collections/bracelets -> Bracelets, /products/foo -> title-cased product name, else null. */
    function friendlyLabelFromPath(path) {
      if (typeof path !== 'string') return null;
      const p = path.trim();
      const pNorm = p.replace(/\/+$/, '') || '/';
      if (pNorm === '/pages/order-tracker') return 'Order Tracker';
      if (pNorm === '/pages/contact') return 'Contact';
      if (pNorm === '/account/login' || pNorm.startsWith('/account/login/')) return 'Login';
      if (pNorm === '/orders' || pNorm.startsWith('/orders/')) return 'Viewed Order';
      const collectionsMatch = p.match(/^\/collections\/([^/?#]+)/i);
      if (collectionsMatch) return titleCaseFromHandle(collectionsMatch[1]);
      const productsMatch = p.match(/^\/products\/([^/?#]+)/i);
      if (productsMatch) return titleCaseFromHandle(productsMatch[1]);
      return null;
    }

    function landingSortKey(s) {
      function trimStr(v) { return v != null ? String(v).trim() : ''; }
      function normalizeToPath(pathVal, handleVal) {
        var path = trimStr(pathVal);
        var handle = trimStr(handleVal);
        if (!path && handle) path = '/products/' + handle.replace(/^\/+/, '');
        if (path && !path.startsWith('/')) path = '/' + path;
        try {
          if (/^https?:\/\//i.test(path)) path = new URL(path).pathname || '/';
        } catch (_) {}
        path = (path || '').split('#')[0].split('?')[0];
        path = path.replace(/\/+$/, '');
        if (path === '') path = '/';
        return path;
      }
      function collapseKey(path) {
        if (!path) return '';
        var pathNorm = path.replace(/\/+$/, '');
        if (path.indexOf('/checkouts') === 0) return '/checkouts';
        if (pathNorm === '/cart') return '/cart';
        if (path === '/orders' || pathNorm === '/orders' || path.indexOf('/orders/') === 0) return '/orders';
        return path;
      }

      var path = normalizeToPath(s && s.first_path, s && s.first_product_handle);
      var key = collapseKey(path);
      if (!key) return '';
      if (key === '/') return 'Home';
      if (key === '/orders') return 'Viewed Order';
      if (key === '/cart' || key === '/checkouts') return 'Cart';
      return friendlyLabelFromPath(key) || key;
    }

    function visitsCount(s) {
      var n = 0;
      try { n = s && s.returning_count != null ? Number(s.returning_count) : 0; } catch (_) { n = 0; }
      if (!Number.isFinite(n)) n = 0;
      return n + 1;
    }

    function landingPageCell(s) {
      function trimStr(v) { return v != null ? String(v).trim() : ''; }
      function normalizeToPathDual(pathVal, handleVal) {
        var path = trimStr(pathVal);
        var handle = trimStr(handleVal);
        if (!path && !handle) return '';
        if (!path && handle) path = '/products/' + handle.replace(/^\/+/, '');
        if (path && !path.startsWith('/')) path = '/' + path;
        try {
          if (/^https?:\/\//i.test(path)) path = new URL(path).pathname || '/';
        } catch (_) {}
        path = path.split('#')[0].split('?')[0];
        path = path.replace(/\/+$/, '');
        if (path === '') path = '/';
        return path;
      }
      function collapseKeyDual(path) {
        if (!path) return '';
        if (path.indexOf('/checkouts') === 0) return '/checkouts';
        if (path === '/cart') return '/cart';
        if (path === '/orders' || path.indexOf('/orders/') === 0) return '/orders';
        return path;
      }

      var entryPathDual = normalizeToPathDual(s && s.first_path, s && s.first_product_handle);
      var exitPathDual = normalizeToPathDual(s && s.last_path, s && s.last_product_handle);
      var entryKeyDual = collapseKeyDual(entryPathDual);
      var exitKeyDual = collapseKeyDual(exitPathDual);

      // When we have BOTH entry + exit, show them both (otherwise keep the current single-thumb layout).
      if (entryPathDual && exitPathDual && entryKeyDual && exitKeyDual && entryKeyDual !== exitKeyDual) {
        var mainBaseDual = getMainBaseUrl();
        var isPurchasedDual = !!(s && s.has_purchased);

        function metaForDual(path) {
          var pathNorm = path ? path.replace(/\/+$/, '') : '';
          var isCheckout = path && path.indexOf('/checkouts') === 0;
          var isHomeOrOrders = path === '/' || path === '/orders' || pathNorm === '/orders' || (path && path.startsWith('/orders/'));
          var isCart = path === '/cart' || pathNorm === '/cart';
          var fullUrl = mainBaseDual && path ? mainBaseDual + path : '';
          var labelText = '\u2014';
          var thumbSrc = '';
          if (isHomeOrOrders) {
            labelText = path === '/' ? 'Home' : 'Viewed Order';
            thumbSrc = HICON_URL;
          } else if (isCart) {
            labelText = 'Cart';
            thumbSrc = HICON_URL;
          } else if (isCheckout) {
            labelText = 'Cart';
            // Prefer a product thumb when possible (even if the session didn't purchase).
            var ph = '';
            try {
              ph = (s && s.last_product_handle != null ? String(s.last_product_handle).trim() : '') ||
                   (s && s.first_product_handle != null ? String(s.first_product_handle).trim() : '');
            } catch (_) { ph = ''; }
            if (ph && mainBaseDual) {
              thumbSrc = (API || '') + '/api/og-thumb?url=' + encodeURIComponent(mainBaseDual + '/products/' + ph.replace(/^\/+/, '')) + '&width=100';
            } else {
              thumbSrc = HICON_URL;
            }
          } else if (path) {
            labelText = friendlyLabelFromPath(path) || path;
            if (fullUrl) thumbSrc = (API || '') + '/api/og-thumb?url=' + encodeURIComponent(fullUrl) + '&width=100';
          }
          return { fullUrl, labelText, thumbSrc };
        }

        var entryMeta = metaForDual(entryPathDual);
        var exitMeta = metaForDual(exitPathDual);

        var entryImg = entryMeta.thumbSrc
          ? '<img class="landing-thumb" src="' + entryMeta.thumbSrc + '" alt="" onerror="this.style.display=\\\'none\\\'">'
          : '';
        var exitImg = exitMeta.thumbSrc
          ? '<img class="landing-thumb landing-thumb-exit" src="' + exitMeta.thumbSrc + '" alt="" onerror="this.style.display=\\\'none\\\'">'
          : '';
        var thumbsInner = entryImg + exitImg;
        var overlay = isPurchasedDual
          ? '<span class="thumb-overlay" aria-hidden="true">' + BOUGHT_OVERLAY_SVG + '</span>'
          : '';
        var thumbs = thumbsInner ? ('<span class="thumb-wrap thumb-stack">' + thumbsInner + overlay + '</span>') : '';

        function dirArrowSvg(kind) {
          var isExit = kind === 'exit';
          var cls = 'landing-dir-icon ' + (isExit ? 'landing-dir-icon-exit' : 'landing-dir-icon-entry');
          var path = isExit
            ? '<path d="M19 12H5M11 6l-6 6 6 6"></path>'
            : '<path d="M5 12h14M13 6l6 6-6 6"></path>';
          return '<svg class="' + cls + '" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">' + path + '</svg>';
        }

        function line(kind, meta) {
          var isExit = kind === 'exit';
          var prefix = isExit ? 'Exit' : 'Entry';
          var label = meta && meta.labelText ? String(meta.labelText) : '\u2014';
          var inner = dirArrowSvg(kind) +
            '<span class="landing-line-text"><span class="sr-only">' + prefix + ': </span>' + escapeHtml(label) + '</span>';
          if (meta && meta.fullUrl) {
            return '<a class="landing-line" href="' + escapeHtml(meta.fullUrl) + '" target="_blank" rel="noopener">' + inner + '</a>';
          }
          return '<span class="landing-line">' + inner + '</span>';
        }

        var lines = '<div class="landing-lines">' + line('entry', entryMeta) + line('exit', exitMeta) + '</div>';
        return '<div class="last-action-cell dual">' + thumbs + ' ' + lines + '</div>';
      }

      var hasFirst = (s.first_path != null && s.first_path !== '') || (s.first_product_handle != null && s.first_product_handle !== '');
      var path = (s.first_path != null && s.first_path !== '' ? s.first_path : (hasFirst ? '' : (s.last_path != null ? s.last_path : ''))).trim();
      var productHandle = s.first_product_handle != null && s.first_product_handle !== '' ? s.first_product_handle : (hasFirst ? null : (s.last_product_handle != null ? s.last_product_handle : null));
      var isFromLast = !hasFirst && (path || productHandle);
      if (path && !path.startsWith('/')) path = '/' + path;
      if (!path && productHandle) path = '/products/' + (productHandle || '');
      var pathNorm = path ? path.replace(/\/+$/, '') : '';
      var isCheckout = path && path.indexOf('/checkouts') === 0;
      var isHomeOrOrders = path === '/' || path === '/orders' || pathNorm === '/orders' || (path && path.startsWith('/orders/'));
      var isCart = path === '/cart' || pathNorm === '/cart';
      var mainBase = getMainBaseUrl();
      var fullUrl = mainBase && path ? mainBase + path : '';
      var label = '\u2014';
      var thumbSrc = '';
      var isPurchased = !!(s && s.has_purchased);
      // Keep the Landing Page thumbnail stable even after purchase; do not swap to a "sale" icon.
      if (isHomeOrOrders) {
        label = path === '/' ? 'Home' : 'Viewed Order';
        thumbSrc = HICON_URL;
      } else if (isCart) {
        label = 'Cart';
        thumbSrc = HICON_URL;
      } else if (isCheckout) {
        label = 'Cart';
        // Prefer a product thumb when possible (even if the session didn't purchase).
        var ph = '';
        try {
          ph = (s && s.last_product_handle != null ? String(s.last_product_handle).trim() : '') ||
               (s && s.first_product_handle != null ? String(s.first_product_handle).trim() : '');
        } catch (_) { ph = ''; }
        if (ph && mainBase) {
          thumbSrc = (API || '') + '/api/og-thumb?url=' + encodeURIComponent(mainBase + '/products/' + ph.replace(/^\/+/, '')) + '&width=100';
        } else {
          thumbSrc = HICON_URL;
        }
      } else if (path) {
        // Display friendly name: /collections/bracelets -> Bracelets, /products/<handle> -> title-cased (link unchanged).
        label = escapeHtml(friendlyLabelFromPath(path) || path);
        if (fullUrl) thumbSrc = (API || '') + '/api/og-thumb?url=' + encodeURIComponent(fullUrl) + '&width=100';
      }
      if (isFromLast && label !== '\u2014') label += ' <span class="landing-fallback-hint">(last)</span>';
      if (thumbSrc || fullUrl) {
        var img = '';
        if (thumbSrc) {
          img = isPurchased
            ? '<span class="thumb-wrap"><img class="landing-thumb" src="' + thumbSrc + '" alt="" onerror="this.parentNode && (this.parentNode.style.display=\\\'none\\\')"><span class="thumb-overlay" aria-hidden="true">' + BOUGHT_OVERLAY_SVG + '</span></span>'
            : '<img class="landing-thumb" src="' + thumbSrc + '" alt="" onerror="this.style.display=\\\'none\\\'">';
        }
        var link = fullUrl ? '<a href="' + escapeHtml(fullUrl) + '" target="_blank" rel="noopener">' + label + '</a>' : label;
        return '<div class="last-action-cell">' + img + ' ' + link + '</div>';
      }
      return label === '\u2014' ? label : escapeHtml(path || '');
    }

    function formatMoney(amount, currencyCode) {
      if (amount == null || typeof amount !== 'number') return '';
      const code = (currencyCode || 'GBP').toUpperCase();
      const sym = code === 'GBP' ? '\u00A3' : code === 'USD' ? '$' : code === 'EUR' ? '\u20AC' : code + ' ';
      return sym + (amount % 1 === 0 ? amount : amount.toFixed(2));
    }

    function sourceLabel(s) {
      const parts = [];
      if (s.utm_source && String(s.utm_source).trim()) parts.push('utm_source: ' + escapeHtml(String(s.utm_source).trim()));
      if (s.utm_campaign && String(s.utm_campaign).trim()) parts.push('utm_campaign: ' + escapeHtml(String(s.utm_campaign).trim()));
      if (s.utm_medium && String(s.utm_medium).trim()) parts.push('utm_medium: ' + escapeHtml(String(s.utm_medium).trim()));
      if (s.utm_content && String(s.utm_content).trim()) parts.push('utm_content: ' + escapeHtml(String(s.utm_content).trim()));
      if (s.referrer && String(s.referrer).trim()) parts.push('referrer: ' + escapeHtml(String(s.referrer).trim()));
      return parts.join(' ');
    }

    function sourceUtmString(s) {
      return [s.utm_source, s.utm_campaign, s.utm_medium, s.utm_content].filter(Boolean).join(' ').toLowerCase();
    }

    function isGoogleAdsSource(s) {
      return sourceUtmString(s).indexOf('googleads') !== -1;
    }

    /** Derive friendly source name from referrer URL host (when no UTM). Use for tooltip and to collect images. */
    function sourceReferrerFriendlyLabel(s) {
      const ref = s.referrer && String(s.referrer).trim();
      if (!ref) return null;
      try {
        const u = new URL(ref);
        const host = (u.hostname || '').toLowerCase().replace(/^www\./, '');
        if (!host) return null;
        if (host === 'account.heybigday.com') return 'HeyBigDay Account';
        if (host === 'account.hbdjewellery.com') return 'HBD Account';
        if (host === 'hbdjewellery.com' || host.endsWith('.myshopify.com')) return 'Store';
        if (host.indexOf('omnisend') !== -1) return 'Omnisend';
        if (host.indexOf('google') !== -1) return 'Google';
        if (host.indexOf('facebook') !== -1 || host.indexOf('fb.') === 0 || host === 'fb.com') return 'Facebook';
        if (host.indexOf('instagram') !== -1) return 'Instagram';
        if (host.indexOf('pinterest') !== -1) return 'Pinterest';
        if (host.indexOf('tiktok') !== -1) return 'TikTok';
        if (host.indexOf('twitter') !== -1 || host.indexOf('x.com') !== -1) return 'X (Twitter)';
        if (host.indexOf('youtube') !== -1) return 'YouTube';
        if (host.indexOf('linkedin') !== -1) return 'LinkedIn';
        if (host.indexOf('bing') !== -1) return 'Bing';
        if (host.indexOf('yahoo') !== -1) return 'Yahoo';
        if (host.indexOf('duckduckgo') !== -1) return 'DuckDuckGo';
        return host;
      } catch (_) { return null; }
    }

    function sourceFriendlyLabel(s) {
      const str = sourceUtmString(s);
      if (str) {
        if (str.indexOf('googleads') !== -1) return null;
        if (str.indexOf('google') !== -1) return 'Google';
        if (str.indexOf('bing') !== -1) return 'Bing';
        if (str.indexOf('omnisend') !== -1) return 'Omnisend';
        if (str.indexOf('chatgpt') !== -1 || str.indexOf('chat gpt') !== -1) return 'Chatgpt';
        return null;
      }
      return sourceReferrerFriendlyLabel(s);
    }

    function sourceSortKey(s) {
      try {
        const mapped = getMappedSourceKeysForSession(s);
        if (mapped && mapped.length) {
          const key0 = String(mapped[0] || '').trim().toLowerCase();
          if (key0) return trafficSourceLabelForKey(key0, key0) || key0;
        }
      } catch (_) {}
      if (isGoogleAdsSource(s)) return 'Google Ads';
      const friendly = sourceFriendlyLabel(s);
      if (friendly === 'Google') return 'Google';
      if (friendly) return friendly;
      if (sourceUtmString(s)) return 'Other';
      if (s.referrer && String(s.referrer).trim()) return 'Other';
      return 'Direct';
    }

    const SOURCE_GOOGLE_IMG = hotImg('https://cdn.shopify.com/s/files/1/0847/7261/8587/files/google.png?v=1770086632');
    const SOURCE_DIRECT_IMG = hotImg('https://cdn.shopify.com/s/files/1/0847/7261/8587/files/arrow-right.png?v=1770086632');
    const BOUGHT_OVERLAY_SVG = '<svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><circle cx="16" cy="16" r="16" fill="currentColor"></circle><path d="M11.087 14.815v-2.332c0-3.676 2.219-5.983 6.075-5.983 2.932 0 4.57 1.242 5.838 2.84l-2.483 1.9c-.951-1.165-1.85-1.85-3.328-1.85-1.77 0-2.827 1.217-2.827 3.17v2.255h6.578v2.637h-6.578v4.335h8.585V24.5H9v-1.977l2.087-.609v-4.462H9v-2.637z" fill="#ffffff"></path></svg>';
    const SOURCE_UNKNOWN_IMG = hotImg('https://cdn.shopify.com/s/files/1/0847/7261/8587/files/question.png?v=1770135816');
    const SOURCE_OMNISEND_IMG = hotImg('https://cdn.shopify.com/s/files/1/0847/7261/8587/files/omnisend.png?v=1770141052');
    const SOURCE_BING_IMG = hotImg('https://cdn.shopify.com/s/files/1/0847/7261/8587/files/bing.png?v=1770141094');
    const SOURCE_LIVEVIEW_SOURCE_IMG = hotImg('https://cdn.shopify.com/s/files/1/0847/7261/8587/files/liveview-source-logo.png?v=1770141081');

    // Traffic source mapping (server-configurable)
    const TRAFFIC_SOURCE_MAP_ALLOWED_PARAMS = [
      'utm_source',
      'utm_medium',
      'utm_campaign',
      'utm_term',
      'utm_content',
      'utm_id',
      'utm_source_platform',
      'utm_creative_format',
      'utm_marketing_tactic',
      'utm_name',
      'utm_cid',
      'utm_referrer',
      'utm_reader',
    ];
    const TRAFFIC_SOURCE_MAP_ALLOWED_PARAM_SET = new Set(TRAFFIC_SOURCE_MAP_ALLOWED_PARAMS);

    let trafficSourceMetaByKey = new Map(); // key -> { label, iconUrl, updatedAt }
    let trafficSourceRulesIndex = new Map(); // param -> value -> [source_key]
    let trafficSourceMetaLoadedAt = 0;
    let trafficSourceMetaInFlight = null;

    function safeUrlParams(url) {
      const raw = url != null ? String(url).trim() : '';
      if (!raw) return null;
      try { return new URL(raw).searchParams; } catch (_) {}
      try { return new URL('https://' + raw).searchParams; } catch (_) {}
      return null;
    }

    function normalizeUtmParam(v) {
      const s = v != null ? String(v).trim().toLowerCase() : '';
      if (!s) return '';
      return TRAFFIC_SOURCE_MAP_ALLOWED_PARAM_SET.has(s) ? s : '';
    }

    function normalizeUtmValue(v) {
      const s = v != null ? String(v).trim() : '';
      if (!s) return '';
      return (s.length > 256 ? s.slice(0, 256) : s).toLowerCase();
    }

    function buildTrafficSourceRulesIndex(rules) {
      const idx = new Map();
      (Array.isArray(rules) ? rules : []).forEach(function(r) {
        const p = normalizeUtmParam(r && r.utm_param);
        const v = normalizeUtmValue(r && r.utm_value);
        const k = (r && r.source_key != null) ? String(r.source_key).trim().toLowerCase() : '';
        if (!p || !v || !k) return;
        if (!idx.has(p)) idx.set(p, new Map());
        const byVal = idx.get(p);
        if (!byVal.has(v)) byVal.set(v, []);
        byVal.get(v).push(k);
      });
      return idx;
    }

    function refreshTrafficSourceMeta(options = {}) {
      const force = !!options.force;
      const now = Date.now();
      if (!force && trafficSourceMetaLoadedAt && (now - trafficSourceMetaLoadedAt) < 60 * 1000) {
        return Promise.resolve({ ok: true, cached: true });
      }
      if (trafficSourceMetaInFlight) return trafficSourceMetaInFlight;
      trafficSourceMetaInFlight = fetchWithTimeout(API + '/api/traffic-source-meta' + (force ? ('?_=' + now) : ''), { credentials: 'same-origin', cache: 'no-store' }, 20000)
        .then(function(r) { if (!r.ok) throw new Error('Meta HTTP ' + r.status); return r.json(); })
        .then(function(json) {
          const meta = (json && json.meta && typeof json.meta === 'object') ? json.meta : {};
          const m = new Map();
          Object.keys(meta).forEach(function(k) {
            const kk = String(k || '').trim().toLowerCase();
            if (!kk) return;
            const v = meta[k] || {};
            m.set(kk, {
              label: v && v.label != null ? String(v.label) : kk,
              iconUrl: v && v.iconUrl != null ? String(v.iconUrl) : (v && v.icon_url != null ? String(v.icon_url) : null),
              updatedAt: v && v.updatedAt != null ? Number(v.updatedAt) : (v && v.updated_at != null ? Number(v.updated_at) : null),
            });
          });
          const rules = (json && Array.isArray(json.rules)) ? json.rules : [];
          trafficSourceMetaByKey = m;
          trafficSourceRulesIndex = buildTrafficSourceRulesIndex(rules);
          trafficSourceMetaLoadedAt = Date.now();
          try { if (trafficCache) renderTraffic(trafficCache); } catch (_) {}
          try { if (sessions && sessions.length) renderTable(); } catch (_) {}
          return { ok: true, metaCount: m.size, ruleCount: rules.length };
        })
        .catch(function(err) {
          console.error(err);
          return { ok: false, error: err && err.message ? String(err.message) : 'Failed' };
        })
        .finally(function() { trafficSourceMetaInFlight = null; });
      return trafficSourceMetaInFlight;
    }

    function trafficSourceLabelForKey(key, fallbackLabel) {
      const k = key != null ? String(key).trim().toLowerCase() : '';
      if (!k) return fallbackLabel != null ? String(fallbackLabel) : '';
      const meta = trafficSourceMetaByKey.get(k);
      if (meta && meta.label != null && String(meta.label).trim() !== '') return String(meta.label);
      return fallbackLabel != null ? String(fallbackLabel) : k;
    }

    function trafficSourceIconUrlForKey(key) {
      const k = key != null ? String(key).trim().toLowerCase() : '';
      if (!k) return '';
      const meta = trafficSourceMetaByKey.get(k);
      return meta && meta.iconUrl != null && String(meta.iconUrl).trim() !== '' ? String(meta.iconUrl).trim() : '';
    }

    function extractMappedUtmTokensFromSession(s) {
      const out = [];
      function add(param, value) {
        const p = normalizeUtmParam(param);
        const v = normalizeUtmValue(value);
        if (!p || !v) return;
        out.push({ param: p, value: v });
      }
      const params = safeUrlParams(s && s.entry_url ? String(s.entry_url) : '');
      if (params) {
        TRAFFIC_SOURCE_MAP_ALLOWED_PARAMS.forEach(function(p) {
          const v = params.get(p);
          if (v != null && String(v).trim() !== '') add(p, v);
        });
      }
      add('utm_source', s && s.utm_source != null ? String(s.utm_source) : '');
      add('utm_medium', s && s.utm_medium != null ? String(s.utm_medium) : '');
      add('utm_campaign', s && s.utm_campaign != null ? String(s.utm_campaign) : '');
      add('utm_content', s && s.utm_content != null ? String(s.utm_content) : '');

      const seen = new Set();
      const deduped = [];
      out.forEach(function(t) {
        const k = t.param + '\0' + t.value;
        if (seen.has(k)) return;
        seen.add(k);
        deduped.push(t);
      });
      return deduped;
    }

    function getMappedSourceKeysForSession(s) {
      const tokens = extractMappedUtmTokensFromSession(s);
      if (!tokens.length) return [];
      const out = [];
      const seen = new Set();
      tokens.forEach(function(t) {
        const byVal = trafficSourceRulesIndex.get(t.param);
        if (!byVal) return;
        const keys = byVal.get(t.value);
        if (!Array.isArray(keys) || !keys.length) return;
        keys.forEach(function(k) {
          const kk = String(k || '').trim().toLowerCase();
          if (!kk || seen.has(kk)) return;
          seen.add(kk);
          out.push(kk);
        });
      });
      return out;
    }

    function trafficSourceBuiltInIconSrc(key) {
      const k = key != null ? String(key).trim().toLowerCase() : '';
      if (!k) return '';
      if (k === 'google_ads') return getAssetsBase() + '/adwords.png?width=100';
      if (k === 'google_organic') return SOURCE_GOOGLE_IMG;
      if (k === 'bing_ads' || k === 'bing_organic') return SOURCE_BING_IMG;
      if (k === 'omnisend') return SOURCE_OMNISEND_IMG;
      if (k === 'direct') return SOURCE_DIRECT_IMG;
      return SOURCE_UNKNOWN_IMG;
    }

    // Config modal: source mapping UI
    let trafficSourceMapsShowMappedTokens = false;
    let trafficSourceMapsUiInFlight = null;

    function fetchTrafficSourceMaps(options = {}) {
      const sinceDays = (options && typeof options.sinceDays === 'number') ? options.sinceDays : 30;
      const limitTokens = (options && typeof options.limitTokens === 'number') ? options.limitTokens : 250;
      const unmappedOnly = options && options.unmappedOnly != null ? !!options.unmappedOnly : !trafficSourceMapsShowMappedTokens;
      let url = API + '/api/traffic-source-maps?sinceDays=' + encodeURIComponent(String(sinceDays)) +
        '&limitTokens=' + encodeURIComponent(String(limitTokens)) +
        '&unmappedOnly=' + encodeURIComponent(unmappedOnly ? '1' : '0');
      url += '&_=' + Date.now();
      return fetchWithTimeout(url, { credentials: 'same-origin', cache: 'no-store' }, 25000)
        .then(function(r) { if (!r.ok) throw new Error('Maps HTTP ' + r.status); return r.json(); });
    }

    function postTrafficSourceMap(payload) {
      return fetchWithTimeout(API + '/api/traffic-source-maps/map', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'same-origin',
        cache: 'no-store',
        body: JSON.stringify(payload || {}),
      }, 45000).then(function(r) { return r.ok ? r.json() : r.json().catch(function() { return null; }).then(function(j) { throw new Error((j && j.error) ? j.error : ('HTTP ' + r.status)); }); });
    }

    function postTrafficSourceMeta(payload) {
      return fetchWithTimeout(API + '/api/traffic-source-maps/meta', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'same-origin',
        cache: 'no-store',
        body: JSON.stringify(payload || {}),
      }, 25000).then(function(r) { return r.ok ? r.json() : r.json().catch(function() { return null; }).then(function(j) { throw new Error((j && j.error) ? j.error : ('HTTP ' + r.status)); }); });
    }

    function postTrafficSourceBackfill(payload) {
      return fetchWithTimeout(API + '/api/traffic-source-maps/backfill', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'same-origin',
        cache: 'no-store',
        body: JSON.stringify(payload || {}),
      }, 60000).then(function(r) { return r.ok ? r.json() : null; });
    }

    function renderTrafficSourceMappingPanel(state) {
      const sources = (state && Array.isArray(state.sources)) ? state.sources.slice() : [];
      const tokens = (state && Array.isArray(state.tokens)) ? state.tokens.slice() : [];
      sources.sort(function(a, b) {
        const al = (a && a.label != null) ? String(a.label) : '';
        const bl = (b && b.label != null) ? String(b.label) : '';
        return al.localeCompare(bl);
      });

      function fmtTs(ms) { return (typeof ms === 'number' && isFinite(ms)) ? formatTs(ms) : '—'; }

      let html = '';
      html += '<div class="tsm-actions">';
      html +=   '<button type="button" class="tsm-btn primary" data-tsm-action="refresh">' + '<span>Refresh</span>' + '</button>';
      html +=   '<button type="button" class="tsm-btn" data-tsm-action="scan">' + '<span>Scan last 30d</span>' + '</button>';
      html +=   '<button type="button" class="tsm-btn" data-tsm-action="toggle-mapped">' + '<span>' + (trafficSourceMapsShowMappedTokens ? 'Hide mapped tokens' : 'Show mapped tokens') + '</span>' + '</button>';
      html += '</div>';
      html += '<div class="diag-note">Unmapped tokens appear here first. Map a token to a Source name (creates a new key like <code>custom_...</code>) and optionally paste an icon URL. Mapped sources will start showing in the Traffic picker + tables.</div>';

      html += '<div class="diag-section-title">' + '<span>Mapped sources</span>' + '</div>';
      if (!sources.length) {
        html += '<div class="diag-note">No custom sources yet.</div>';
      } else {
        html += '<div class="tsm-table-scroll"><table class="tsm-table"><thead><tr>' +
          '<th>Source</th><th>Key</th><th>Icon URL</th><th></th>' +
          '</tr></thead><tbody>';
        sources.forEach(function(s) {
          const key = s && s.source_key != null ? String(s.source_key).trim().toLowerCase() : '';
          if (!key) return;
          const label = s && s.label != null ? String(s.label) : key;
          const iconUrl = s && s.icon_url != null ? String(s.icon_url) : '';
          const preview = iconUrl && iconUrl.trim()
            ? ('<img class="tsm-icon-preview" src="' + escapeHtml(iconUrl.trim()) + '" alt="" onerror="this.style.display=\\\'none\\\'">')
            : '<span style="display:inline-block;width:18px;height:18px"></span>';
          html += '<tr class="tsm-source-row" data-source-key="' + escapeHtml(key) + '">' +
            '<td><input class="tsm-input" data-field="label" value="' + escapeHtml(label) + '" /></td>' +
            '<td><code>' + escapeHtml(key) + '</code></td>' +
            '<td><div style="display:flex;gap:0.45rem;align-items:center">' +
              preview +
              '<input class="tsm-input" data-field="icon_url" placeholder="https://.../icon.png" value="' + escapeHtml(iconUrl || '') + '" />' +
            '</div></td>' +
            '<td><button type="button" class="tsm-btn primary" data-tsm-action="save-meta">Save</button></td>' +
          '</tr>';
        });
        html += '</tbody></table></div>';
      }

      html += '<div class="diag-section-title" style="margin-top:0.85rem">' + '<span>' + (trafficSourceMapsShowMappedTokens ? 'Tokens (mapped + unmapped)' : 'Unmapped tokens') + '</span>' + '</div>';
      if (!tokens.length) {
        html += '<div class="diag-note">No tokens captured yet. Click <strong>Scan last 30d</strong> (or wait for new sessions) and they will appear here.</div>';
      } else {
        html += '<div class="tsm-table-scroll"><table class="tsm-table"><thead><tr>' +
          '<th>Token</th><th>Seen</th><th>Map / existing</th>' +
          '</tr></thead><tbody>';
        tokens.forEach(function(t) {
          const p = t && t.utm_param != null ? String(t.utm_param).trim().toLowerCase() : '';
          const v = t && t.utm_value != null ? String(t.utm_value).trim().toLowerCase() : '';
          if (!p || !v) return;
          const seenCount = t && typeof t.seen_count === 'number' ? t.seen_count : 0;
          const lastSeen = t && typeof t.last_seen_at === 'number' ? t.last_seen_at : null;
          const mapped = (t && Array.isArray(t.mapped)) ? t.mapped : [];
          html += '<tr class="tsm-token-row" data-utm-param="' + escapeHtml(p) + '" data-utm-value="' + escapeHtml(v) + '">' +
            '<td><code>' + escapeHtml(p) + '=' + escapeHtml(v) + '</code></td>' +
            '<td>' + escapeHtml(String(seenCount || 0)) + '<div class="diag-note" style="margin:0.15rem 0 0">Last: ' + escapeHtml(fmtTs(lastSeen)) + '</div></td>' +
            '<td>' +
              '<div style="display:grid;grid-template-columns: 1fr 1fr auto; gap:0.45rem; align-items:center">' +
                '<input class="tsm-input" data-field="source_label" placeholder="Source name (e.g. TikTok Influencers)" />' +
                '<input class="tsm-input" data-field="icon_url" placeholder="Icon URL (optional)" />' +
                '<button type="button" class="tsm-btn primary" data-tsm-action="map-token">Map</button>' +
              '</div>' +
              (mapped.length ? ('<div style="margin-top:0.35rem">' + mapped.map(function(m) {
                const ml = m && m.label != null ? String(m.label) : (m && m.source_key ? String(m.source_key) : '');
                const mu = m && m.icon_url != null ? String(m.icon_url) : '';
                const prev = (mu && mu.trim()) ? ('<img class="tsm-icon-preview" src="' + escapeHtml(mu.trim()) + '" alt="" onerror="this.style.display=\\\'none\\\'">') : '';
                return '<span class="tsm-mapped-pill">' + prev + escapeHtml(ml) + '</span>';
              }).join('') + '</div>') : '') +
            '</td>' +
          '</tr>';
        });
        html += '</tbody></table></div>';
      }

      return html;
    }

    let trafficSourceMapsLastState = null;
    let trafficSourceMapsLastLoadedAt = 0;

    function refreshTrafficSourceMappingPanel(options = {}) {
      const rootId = options && options.rootId ? String(options.rootId) : 'traffic-source-mapping-root';
      const root = document.getElementById(rootId);
      if (!root) return Promise.resolve(null);
      const force = !!options.force;
      const now = Date.now();
      const fresh = !!(trafficSourceMapsLastState && trafficSourceMapsLastLoadedAt && (now - trafficSourceMapsLastLoadedAt) < 30 * 1000);
      if (!force && fresh) {
        root.innerHTML = renderTrafficSourceMappingPanel(trafficSourceMapsLastState);
        return Promise.resolve(trafficSourceMapsLastState);
      }

      root.innerHTML = '<div class="diag-loading">Loading\u2026</div>';

      if (trafficSourceMapsUiInFlight) {
        return trafficSourceMapsUiInFlight
          .then(function(state) {
            if (state && state.ok === true) root.innerHTML = renderTrafficSourceMappingPanel(state);
            else root.innerHTML = '<div class="diag-note">Failed to load source mapping.</div>';
            return state;
          })
          .catch(function(err) {
            console.error(err);
            root.innerHTML = '<div class="diag-note">Failed to load source mapping. ' + escapeHtml(err && err.message ? String(err.message) : '') + '</div>';
            return null;
          });
      }

      trafficSourceMapsUiInFlight = fetchTrafficSourceMaps({ force: true, unmappedOnly: !trafficSourceMapsShowMappedTokens })
        .then(function(json) {
          if (!json || json.ok !== true) throw new Error('Bad response');
          trafficSourceMapsLastState = json;
          trafficSourceMapsLastLoadedAt = Date.now();
          return json;
        })
        .catch(function(err) {
          console.error(err);
          return null;
        })
        .finally(function() { trafficSourceMapsUiInFlight = null; });

      return trafficSourceMapsUiInFlight.then(function(state) {
        if (state && state.ok === true) root.innerHTML = renderTrafficSourceMappingPanel(state);
        else root.innerHTML = '<div class="diag-note">Failed to load source mapping.</div>';
        return state;
      });
    }

    function initTrafficSourceMappingPanel(options = {}) {
      const rootId = options && options.rootId ? String(options.rootId) : 'traffic-source-mapping-root';
      const root = document.getElementById(rootId);
      if (!root) return;
      root.onclick = function(e) {
        const btn = e && e.target ? e.target.closest('button[data-tsm-action]') : null;
        if (!btn) return;
        const action = (btn.getAttribute('data-tsm-action') || '').trim();
        if (action === 'refresh') {
          refreshTrafficSourceMappingPanel({ force: true, rootId: rootId });
          return;
        }
        if (action === 'toggle-mapped') {
          trafficSourceMapsShowMappedTokens = !trafficSourceMapsShowMappedTokens;
          refreshTrafficSourceMappingPanel({ force: true, rootId: rootId });
          return;
        }
        if (action === 'scan') {
          btn.disabled = true;
          postTrafficSourceBackfill({ since_days: 30, limit_sessions: 20000 })
            .then(function() { return refreshTrafficSourceMappingPanel({ force: true, rootId: rootId }); })
            .finally(function() { btn.disabled = false; });
          return;
        }
        if (action === 'map-token') {
          const row = btn.closest('.tsm-token-row');
          if (!row) return;
          const utmParam = (row.getAttribute('data-utm-param') || '').trim();
          const utmValue = (row.getAttribute('data-utm-value') || '').trim();
          const labelEl = row.querySelector('input[data-field="source_label"]');
          const iconEl = row.querySelector('input[data-field="icon_url"]');
          const sourceLabel = labelEl ? String(labelEl.value || '').trim() : '';
          const iconUrl = iconEl ? String(iconEl.value || '').trim() : '';
          if (!utmParam || !utmValue || !sourceLabel) {
            alert('Please enter a Source name.');
            return;
          }
          btn.disabled = true;
          postTrafficSourceMap({ utm_param: utmParam, utm_value: utmValue, source_label: sourceLabel, icon_url: iconUrl || null, since_days: 30, limit_sessions: 50000 })
            .then(function() { return refreshTrafficSourceMeta({ force: true }); })
            .then(function() { try { refreshTraffic({ force: true }); } catch (_) {} })
            .then(function() { return refreshTrafficSourceMappingPanel({ force: true, rootId: rootId }); })
            .finally(function() { btn.disabled = false; });
          return;
        }
        if (action === 'save-meta') {
          const row = btn.closest('.tsm-source-row');
          if (!row) return;
          const sourceKey = (row.getAttribute('data-source-key') || '').trim();
          const labelEl = row.querySelector('input[data-field="label"]');
          const iconEl = row.querySelector('input[data-field="icon_url"]');
          const label = labelEl ? String(labelEl.value || '').trim() : '';
          const iconUrl = iconEl ? String(iconEl.value || '').trim() : '';
          if (!sourceKey || !label) {
            alert('Source label is required.');
            return;
          }
          btn.disabled = true;
          postTrafficSourceMeta({ source_key: sourceKey, label: label, icon_url: iconUrl || null })
            .then(function() { return refreshTrafficSourceMeta({ force: true }); })
            .then(function() { try { renderTable(); } catch (_) {} })
            .then(function() { try { refreshTraffic({ force: true }); } catch (_) {} })
            .then(function() { return refreshTrafficSourceMappingPanel({ force: true, rootId: rootId }); })
            .finally(function() { btn.disabled = false; });
          return;
        }
      };

      // Initial load (best-effort).
      if (!root.getAttribute('data-tsm-loaded')) {
        root.setAttribute('data-tsm-loaded', '1');
        refreshTrafficSourceMappingPanel({ force: true, rootId: rootId });
      }
    }

    function sourceCell(s) {
      function icon(src, alt, title, extraClass) {
        const cls = (extraClass ? (extraClass + ' ') : '') + 'source-icon-img';
        const t = title ? ' title="' + escapeHtml(String(title)) + '"' : '';
        return '<img src="' + escapeHtml(hotImg(src) || src || '') + '" alt="' + escapeHtml(alt || '') + '" class="' + cls + '" width="20" height="20"' + t + '>';
      }

      const out = [];

      // 0) Custom mapping icons (if any) take precedence.
      try {
        const mapped = getMappedSourceKeysForSession(s);
        if (mapped && mapped.length) {
          mapped.forEach(function(key) {
            const label = trafficSourceLabelForKey(key, key);
            const metaIcon = trafficSourceIconUrlForKey(key);
            const src = metaIcon || trafficSourceBuiltInIconSrc(key) || SOURCE_UNKNOWN_IMG;
            const extra = key === 'google_ads' ? 'source-googleads-img' : '';
            out.push(icon(src, label, label, extra));
          });
          return '<span class="source-icons">' + out.join('') + '</span>';
        }
      } catch (_) {}

      // 1) UTM-derived source icon (campaign/source)
      const utmStr = sourceUtmString(s);
      let utmLabel = '';
      const hasGoogleAds = isGoogleAdsSource(s);
      if (hasGoogleAds) {
        utmLabel = 'Google Ads';
        out.push(icon(getAssetsBase() + '/adwords.png?width=100', utmLabel, utmLabel, 'source-googleads-img'));
      } else if (utmStr) {
        const friendly = sourceFriendlyLabel(s);
        utmLabel = friendly || 'Other (UTM)';
        if (friendly === 'Google') out.push(icon(SOURCE_GOOGLE_IMG, 'Google', 'Google (UTM)'));
        else if (friendly === 'Bing') out.push(icon(SOURCE_BING_IMG, 'Bing', 'Bing (UTM)'));
        else if (friendly === 'Omnisend') out.push(icon(SOURCE_OMNISEND_IMG, 'Omnisend', 'Omnisend (UTM)'));
        else out.push(icon(SOURCE_UNKNOWN_IMG, utmLabel, utmLabel));
      }

      // 2) Referrer-derived source icon (organic/social)
      const refLabel = sourceReferrerFriendlyLabel(s);
      if (refLabel && refLabel !== 'Store' && refLabel !== utmLabel) {
        if (refLabel === 'Google') {
          // Don't show a generic Google icon when Google Ads is present.
          if (!hasGoogleAds) out.push(icon(SOURCE_GOOGLE_IMG, 'Google', 'Google (Referrer)'));
        }
        else if (refLabel === 'Bing') out.push(icon(SOURCE_BING_IMG, 'Bing', 'Bing (Referrer)'));
        else if (refLabel === 'Omnisend') out.push(icon(SOURCE_OMNISEND_IMG, 'Omnisend', 'Omnisend (Referrer)'));
        else if (refLabel === 'HeyBigDay Account' || refLabel === 'HBD Account') out.push(icon(SOURCE_LIVEVIEW_SOURCE_IMG, refLabel, String(refLabel)));
        else out.push(icon(SOURCE_UNKNOWN_IMG, refLabel, String(refLabel)));
      }

      // 3) Direct fallback
      if (out.length === 0) out.push(icon(SOURCE_DIRECT_IMG, 'Direct', 'Direct'));

      return '<span class="source-icons">' + out.join('') + '</span>';
    }

    function sourceDetailForPanel(s) {
      const lines = [];
      const entry = s.entry_url && String(s.entry_url).trim();
      if (entry) lines.push('Entry URL (CF referer): ' + entry);
      const ref = s.referrer && String(s.referrer).trim();
      if (ref) lines.push('Referrer: ' + ref);
      if (s.utm_source != null && String(s.utm_source).trim() !== '') lines.push('utm_source: ' + String(s.utm_source).trim());
      if (s.utm_medium != null && String(s.utm_medium).trim() !== '') lines.push('utm_medium: ' + String(s.utm_medium).trim());
      if (s.utm_campaign != null && String(s.utm_campaign).trim() !== '') lines.push('utm_campaign: ' + String(s.utm_campaign).trim());
      if (s.utm_content != null && String(s.utm_content).trim() !== '') lines.push('utm_content: ' + String(s.utm_content).trim());
      if (lines.length === 0) return '—';
      return lines.join('\n');
    }

    function renderRow(s) {
      const countryCode = s.country_code || 'XX';
      const visits = (s.returning_count != null ? s.returning_count : 0) + 1;
      const visitsLabel = visits === 1 ? '1 visit' : visits + ' visits';
      const cartValueNum = s.cart_value != null ? Number(s.cart_value) : NaN;
      const cartVal = s.has_purchased ? '' : ((s.cart_value != null && !Number.isNaN(cartValueNum))
        ? formatMoney(Math.floor(cartValueNum), s.cart_currency)
        : '');
      const saleVal = s.has_purchased ? formatMoney(s.order_total != null ? Number(s.order_total) : null, s.order_currency) : '';
      const cartOrSaleCell = s.has_purchased
        ? '<span class="cart-value-sale">' + escapeHtml(saleVal) + '</span>'
        : cartVal;
      const fromCell = flagImg(countryCode);
      const consentDebug = s.meta_json ? (JSON.parse(s.meta_json || '{}').customer_privacy_debug ? 'yes' : '') : '';
      return `<tr class="clickable ${s.is_returning ? 'returning' : ''} ${s.has_purchased ? 'converted' : ''}" data-session-id="${s.session_id}">
        <td>${landingPageCell(s)}</td>
        <td class="flag-cell">${fromCell}</td>
        <td class="source-cell">${sourceCell(s)}</td>
        <td>${escapeHtml(s.device || '')}</td>
        <td class="cart-value-cell">${cartOrSaleCell}</td>
        <td class="arrived-cell"><span data-started="${s.started_at}">${arrivedAgo(s.started_at)}</span></td>
        <td class="last-seen-cell"><span data-last-seen="${s.last_seen}">${arrivedAgo(s.last_seen)}</span></td>
        <td>${visitsLabel}</td>
        <td class="consent-debug consent-col" style="display:none">${escapeHtml(consentDebug)}</td>
      </tr>`;
    }

    function escapeHtml(str) {
      if (str == null) return '';
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    function cartSortValue(s) {
      if (s.has_purchased && s.order_total != null) return Number(s.order_total);
      if (s.cart_value != null) { const n = Number(s.cart_value); if (!Number.isNaN(n)) return n; }
      return -Infinity;
    }

    function getSortedSessions() {
      if (!sortBy) return sessions.slice();
      const list = sessions.slice();
      const mult = sortDir === 'asc' ? 1 : -1;
      list.sort(function (a, b) {
        var va, vb;
        if (sortBy === 'landing') {
          va = (landingSortKey(a) || '').toLowerCase();
          vb = (landingSortKey(b) || '').toLowerCase();
          return mult * (va < vb ? -1 : va > vb ? 1 : 0);
        }
        if (sortBy === 'from') {
          va = (a.country_code || 'ZZ').toUpperCase();
          vb = (b.country_code || 'ZZ').toUpperCase();
          return mult * (va < vb ? -1 : va > vb ? 1 : 0);
        }
        if (sortBy === 'arrived') {
          va = toMs(a.started_at) ?? 0;
          vb = toMs(b.started_at) ?? 0;
          return mult * (va - vb);
        }
        if (sortBy === 'source') {
          va = sourceSortKey(a);
          vb = sourceSortKey(b);
          return mult * (va < vb ? -1 : va > vb ? 1 : 0);
        }
        if (sortBy === 'device') {
          va = (a && a.device != null ? String(a.device) : '').trim().toLowerCase();
          vb = (b && b.device != null ? String(b.device) : '').trim().toLowerCase();
          return mult * (va < vb ? -1 : va > vb ? 1 : 0);
        }
        if (sortBy === 'cart') {
          va = cartSortValue(a);
          vb = cartSortValue(b);
          return mult * (va - vb);
        }
        if (sortBy === 'last_seen') {
          va = toMs(a.last_seen) ?? 0;
          vb = toMs(b.last_seen) ?? 0;
          return mult * (va - vb);
        }
        if (sortBy === 'history') {
          va = visitsCount(a);
          vb = visitsCount(b);
          return mult * (va - vb);
        }
        return 0;
      });
      return list;
    }

    function renderTable() {
      const tbody = document.getElementById('table-body');
      const isRangeMode = sessionsTotal != null;
      const totalPages = isRangeMode
        ? Math.max(1, Math.ceil(sessionsTotal / rowsPerPage))
        : Math.max(1, Math.ceil(getSortedSessions().length / rowsPerPage));
      currentPage = Math.min(Math.max(1, currentPage), totalPages);
      const start = (currentPage - 1) * rowsPerPage;
      const sorted = getSortedSessions();
      const pageSessions = isRangeMode ? sorted : sorted.slice(start, start + rowsPerPage);
      if (pageSessions.length === 0) {
        var emptyMsg = sessionsLoadError ? sessionsLoadError : 'No sessions in this view.';
        tbody.innerHTML = '<tr><td colspan="9" class="empty">' + escapeHtml(emptyMsg) + '</td></tr>';
      } else {
        tbody.innerHTML = pageSessions.map(renderRow).join('');
        document.querySelectorAll('#table-body tr.clickable').forEach(tr => {
          tr.addEventListener('click', () => {
            selectedSessionId = tr.dataset.sessionId;
            openSidePanel(selectedSessionId);
          });
        });
      }
      const prevBtn = document.getElementById('pagination-prev');
      const nextBtn = document.getElementById('pagination-next');
      const labelEl = document.getElementById('pagination-label');
      if (prevBtn) { prevBtn.disabled = currentPage <= 1; }
      if (nextBtn) { nextBtn.disabled = currentPage >= totalPages; }
      if (labelEl) labelEl.textContent = currentPage + ' of ' + totalPages;
      const rowsSelect = document.getElementById('rows-per-page-select');
      if (rowsSelect) rowsSelect.value = String(rowsPerPage);
      updateSortHeaders();
      syncSessionsTableTightMode();
      tickTimeOnSite();
    }

    function syncSessionsTableTightMode() {
      const wrap = document.querySelector('.table-scroll-wrap');
      const table = document.getElementById('sessions-table');
      if (!wrap || !table) return;
      // "Max mode": when all columns fit, remove extra inter-column padding.
      const fits = table.scrollWidth <= wrap.clientWidth + 1;
      wrap.classList.toggle('tight-cols', !!fits);
    }

    function updateSortHeaders() {
      document.querySelectorAll('.table-scroll-wrap th.sortable').forEach(function (th) {
        var col = th.getAttribute('data-sort');
        th.classList.remove('th-sort-asc', 'th-sort-desc');
        th.setAttribute('aria-sort', sortBy === col ? (sortDir === 'asc' ? 'ascending' : 'descending') : 'none');
        if (sortBy === col) th.classList.add(sortDir === 'asc' ? 'th-sort-asc' : 'th-sort-desc');
      });
    }

    function setupSortableHeaders() {
      document.querySelectorAll('.table-scroll-wrap th.sortable').forEach(function (th) {
        function activate() {
          var col = (th.getAttribute('data-sort') || '').trim();
          if (!col) return;
          if (sortBy === col) sortDir = sortDir === 'asc' ? 'desc' : 'asc';
          else { sortBy = col; sortDir = SORT_DEFAULTS[col] || 'asc'; }
          renderTable();
        }
        th.addEventListener('click', function (e) {
          if (e && typeof e.preventDefault === 'function') e.preventDefault();
          activate();
        });
        th.addEventListener('keydown', function (e) {
          if (!e || (e.key !== 'Enter' && e.key !== ' ')) return;
          e.preventDefault();
          activate();
        });
      });
    }

    function tickTimeOnSite() {
      document.querySelectorAll('#table-body span[data-started]').forEach(span => {
        const started = parseInt(span.getAttribute('data-started'), 10);
        span.textContent = arrivedAgo(started);
      });
      document.querySelectorAll('#table-body span[data-last-seen]').forEach(span => {
        const lastSeen = parseInt(span.getAttribute('data-last-seen'), 10);
        span.textContent = arrivedAgo(lastSeen);
      });
    }

    function pct(v) { return v != null ? v.toFixed(1) + '%' : ''; }

    function formatRevenue(num) {
      if (num == null || typeof num !== 'number') return '';
      return '\u00A3' + (num % 1 === 0 ? num : num.toFixed(2));
    }

    function isIconMode() {
      try {
        return !!(window.matchMedia && window.matchMedia('(max-width: 768px)').matches);
      } catch (_) {
        return false;
      }
    }

    function formatRevenueTableHtml(num) {
      if (num == null || typeof num !== 'number' || !Number.isFinite(num)) return '—';
      if (isIconMode()) return '\u00A3' + Math.round(num);
      if (num % 1 === 0) return '\u00A3' + num;
      const fixed = num.toFixed(2);
      const parts = fixed.split('.');
      return '\u00A3' + parts[0] + '<span class="rev-decimal">.' + parts[1] + '</span>';
    }

    function animateTickerText(el, nextText) {
      if (!el) return;
      const prev = el.textContent != null ? String(el.textContent) : '';
      const next = nextText != null ? String(nextText) : '';
      if (prev === next) {
        el.textContent = next;
        return;
      }
      const wrap = document.createElement('span');
      wrap.className = 'kpi-ticker';
      const stack = document.createElement('span');
      stack.className = 'kpi-ticker-stack';
      const a = document.createElement('span');
      a.className = 'kpi-ticker-line';
      a.textContent = prev;
      const b = document.createElement('span');
      b.className = 'kpi-ticker-line';
      b.textContent = next;
      stack.appendChild(a);
      stack.appendChild(b);
      wrap.appendChild(stack);
      while (el.firstChild) el.removeChild(el.firstChild);
      el.appendChild(wrap);
      requestAnimationFrame(function() { wrap.classList.add('run'); });
      setTimeout(function() {
        // Finalize (but only if the wrapper is still present).
        if (el && el.contains(wrap)) el.textContent = next;
      }, 460);
    }

    function setSaleToastContent(patch) {
      patch = patch && typeof patch === 'object' ? patch : {};
      const cc = (patch.countryCode || 'XX').toString().trim().toUpperCase().slice(0, 2) || 'XX';
      const product = patch.productTitle != null ? String(patch.productTitle) : '';
      const amountGbp = patch.amountGbp != null ? Number(patch.amountGbp) : null;
      const flagEl = document.getElementById('sale-toast-flag');
      const inlineFlagEl = document.getElementById('sale-toast-inline-flag');
      const productEl = document.getElementById('sale-toast-product');
      const amountEl = document.getElementById('sale-toast-amount');
      if (flagEl) flagEl.innerHTML = '<img class="sale-toast-bird-icon" src="' + escapeHtml(NEW_SALE_BIRD_URL) + '" alt="" aria-hidden="true" decoding="async" loading="eager">';
      if (inlineFlagEl) inlineFlagEl.innerHTML = flagImgSmall(cc);
      if (productEl) productEl.textContent = product && product.trim() ? product : '\u2014';
      if (amountEl) amountEl.textContent = (amountGbp != null && Number.isFinite(amountGbp)) ? (formatRevenue(amountGbp) || '\u00A3\u2014') : '\u00A3\u2014';
    }

    function showSaleToast() {
      const host = document.getElementById('live-kpi-sales-cell');
      const toast = document.getElementById('sale-toast');
      if (!host || !toast) return;
      saleToastActive = true;
      saleToastLastShownAt = Date.now();
      host.classList.add('toast-open');
      toast.style.display = 'flex';
      toast.setAttribute('aria-hidden', 'false');
      requestAnimationFrame(function() { toast.classList.add('active'); });
    }

    function applyPendingSalesKpiUpdate() {
      if (!saleToastPendingKpi) return;
      const labelEl = document.getElementById('live-kpi-sales-label');
      const valueEl = document.getElementById('live-kpi-sales');
      if (labelEl) {
        labelEl.title = '';
        animateTickerText(labelEl, saleToastPendingKpi.labelText);
      }
      if (valueEl) animateTickerText(valueEl, saleToastPendingKpi.valueText);
      saleToastPendingKpi = null;
    }

    function hideSaleToast() {
      const host = document.getElementById('live-kpi-sales-cell');
      const toast = document.getElementById('sale-toast');
      if (saleToastHideTimer) {
        clearTimeout(saleToastHideTimer);
        saleToastHideTimer = null;
      }
      if (!host || !toast) {
        saleToastActive = false;
        saleToastSessionId = null;
        applyPendingSalesKpiUpdate();
        return;
      }
      toast.classList.remove('active');
      toast.setAttribute('aria-hidden', 'true');
      setTimeout(function() {
        toast.style.display = 'none';
        host.classList.remove('toast-open');
        saleToastActive = false;
        saleToastSessionId = null;
        applyPendingSalesKpiUpdate();
      }, 260);
    }

    (function initSaleToastCloseButton() {
      const btn = document.getElementById('sale-toast-close');
      if (!btn) return;
      btn.addEventListener('click', function(e) {
        if (e && typeof e.preventDefault === 'function') e.preventDefault();
        if (e && typeof e.stopPropagation === 'function') e.stopPropagation();
        // Invalidate any in-flight /api/latest-sale update for the current toast.
        saleToastToken += 1;
        hideSaleToast();
      });
    })();

    let latestSaleFetchInFlight = null;
    function fetchLatestSaleForToast(options = {}) {
      const forceNew = !!(options && options.forceNew);
      if (!forceNew && latestSaleFetchInFlight) return latestSaleFetchInFlight;
      const url = API + '/api/latest-sale?_=' + Date.now();
      const p = fetch(url, { credentials: 'same-origin', cache: 'no-store' })
        .then(function(r) { return r.ok ? r.json() : null; })
        .then(function(json) { return (json && json.ok && json.sale) ? json.sale : null; })
        .catch(function() { return null; })
        .finally(function() { if (latestSaleFetchInFlight === p) latestSaleFetchInFlight = null; });
      latestSaleFetchInFlight = p;
      return p;
    }

    function buildSalesKpiUpdateFromStats(data) {
      const rangeKey = getStatsRange();
      const sales = data && data.sales ? data.sales : {};
      const convertedCountMap = data && data.convertedCount ? data.convertedCount : {};
      const salesVal = typeof sales[rangeKey] === 'number' ? sales[rangeKey] : null;
      const orderCountVal = typeof convertedCountMap[rangeKey] === 'number' ? convertedCountMap[rangeKey] : null;
      return {
        labelText: orderCountVal != null ? (orderCountVal + ' Orders') : 'Orders',
        valueText: salesVal != null ? (formatRevenue(salesVal) || '\u2014') : '\u2014',
      };
    }

    function triggerSaleToast(opts) {
      opts = opts && typeof opts === 'object' ? opts : {};
      const session = opts.session || null;
      const kpiUpdate = opts.kpiUpdate || null;
      const playSound = opts.playSound !== false;
      const toastToken = ++saleToastToken; // newest toast wins
      saleToastSessionId = session && session.session_id != null ? String(session.session_id) : null;
      saleToastLastOrderId = null;

      // Freeze the Sales KPI until the toast fades away.
      if (kpiUpdate && typeof kpiUpdate.labelText === 'string' && typeof kpiUpdate.valueText === 'string') {
        saleToastPendingKpi = { labelText: kpiUpdate.labelText, valueText: kpiUpdate.valueText };
      }

      showSaleToast();

      // Fast, best-effort content from the session update (then refined by truth).
      try {
        const cc = session && session.country_code ? String(session.country_code).toUpperCase().slice(0, 2) : 'XX';
        let productTitle = '';
        if (session && session.last_product_handle) productTitle = titleCaseFromHandle(String(session.last_product_handle));
        let amountGbp = null;
        if (session && session.order_total != null) {
          const n = typeof session.order_total === 'number' ? session.order_total : parseFloat(String(session.order_total));
          if (Number.isFinite(n)) amountGbp = n;
        }
        setSaleToastContent({ countryCode: cc, productTitle: productTitle || 'Processing\u2026', amountGbp });
      } catch (_) {}

      if (playSound && !saleMuted && saleAudio) {
        saleAudio.currentTime = 0;
        saleAudio.play().catch(function() {});
      }

      if (saleToastHideTimer) clearTimeout(saleToastHideTimer);
      saleToastHideTimer = setTimeout(hideSaleToast, 10000);

      fetchLatestSaleForToast({ forceNew: true }).then(function(sale) {
        if (!sale) return;
        if (toastToken !== saleToastToken) return; // stale fetch (a newer sale toast is showing)
        if (!saleToastActive) return;
        const orderId = sale.orderId != null ? String(sale.orderId) : '';
        if (orderId) saleToastLastOrderId = orderId;
        const cc = sale.countryCode ? String(sale.countryCode).toUpperCase().slice(0, 2) : 'XX';
        const product = sale.productTitle && String(sale.productTitle).trim() ? String(sale.productTitle).trim() : '';
        const amount = sale.amountGbp != null ? Number(sale.amountGbp) : null;
        setSaleToastContent({
          countryCode: cc || 'XX',
          productTitle: product || (document.getElementById('sale-toast-product') ? document.getElementById('sale-toast-product').textContent : '—'),
          amountGbp: (amount != null && Number.isFinite(amount)) ? amount : null,
        });
      });
    }

    function getShopParam() {
      var p = new URLSearchParams(window.location.search);
      var shop = p.get('shop') || '';
      return shop && /\.myshopify\.com$/i.test(shop) ? shop : null;
    }

    function fetchShopifySales() {
      var shop = getShopForSales();
      if (!shop || getStatsRange() !== 'today') {
        // If the store-base-url lookup is done and we still have no shop, stop waiting and fall back to DB.
        if (getStatsRange() === 'today' && storeBaseUrlLoaded && !shop) shopifySalesTodayLoaded = true;
        shopifySalesTodayLoading = false;
        return;
      }
      if (shopifySalesTodayLoading) return;
      shopifySalesTodayLoading = true;
      fetch(API + '/api/shopify-sales?shop=' + encodeURIComponent(shop), { credentials: 'same-origin' })
        .then(function(r) { return r.ok ? r.json() : null; })
        .then(function(data) {
          shopifySalesToday = data && typeof data.salesToday === 'number' ? data.salesToday : null;
          shopifyOrderCountToday = data && typeof data.orderCountToday === 'number' ? data.orderCountToday : null;
          shopifySalesTodayLoaded = true;
          shopifySalesTodayLoading = false;
          renderSales(statsCache);
          renderLiveKpis(getKpiData());
        })
        .catch(function() {
          shopifySalesToday = null;
          shopifyOrderCountToday = null;
          shopifySalesTodayLoaded = true;
          shopifySalesTodayLoading = false;
          renderSales(statsCache);
          renderLiveKpis(getKpiData());
        });
    }

    function fetchShopifySessions() {
      var shop = getShopForSales();
      if (!shop || getStatsRange() !== 'today') {
        if (getStatsRange() === 'today' && storeBaseUrlLoaded && !shop) shopifySessionsTodayLoaded = true;
        shopifySessionsTodayLoading = false;
        return;
      }
      if (shopifySessionsTodayLoading) return;
      shopifySessionsTodayLoading = true;
      fetch(API + '/api/shopify-sessions?shop=' + encodeURIComponent(shop), { credentials: 'same-origin' })
        .then(function(r) { return r.ok ? r.json() : null; })
        .then(function(data) {
          shopifySessionsToday = data && typeof data.sessionsToday === 'number' ? data.sessionsToday : null;
          shopifySessionsTodayLoaded = true;
          shopifySessionsTodayLoading = false;
          renderLiveKpis(getKpiData());
        })
        .catch(function() {
          shopifySessionsToday = null;
          shopifySessionsTodayLoaded = true;
          shopifySessionsTodayLoading = false;
          renderLiveKpis(getKpiData());
        });
    }

    function fetchBestSellers(options = {}) {
      const force = !!options.force;
      var shop = getShopParam() || shopForSalesFallback || null;
      if (!shop) {
        bestSellersCache = null;
        renderBestSellers(null);
        return Promise.resolve(null);
      }
      let url = API + '/api/shopify-best-sellers?shop=' + encodeURIComponent(shop) +
          '&range=' + encodeURIComponent(getStatsRange()) +
          '&page=' + encodeURIComponent(String(bestSellersPage || 1)) +
          '&pageSize=' + encodeURIComponent(String(TOP_TABLE_PAGE_SIZE)) +
          '&sort=' + encodeURIComponent(String(bestSellersSortBy || 'rev')) +
          '&dir=' + encodeURIComponent(String(bestSellersSortDir || 'desc'));
      if (force) url += '&_=' + Date.now();
      return fetchWithTimeout(url, { credentials: 'same-origin', cache: force ? 'no-store' : 'default' }, 30000)
        .then(function(r) { return r.json().then(function(data) { return { ok: r.ok, status: r.status, data: data || {} }; }).catch(function() { return { ok: r.ok, status: r.status, data: {} }; }); })
        .then(function(result) {
          if (result.ok) {
            bestSellersCache = result.data;
            renderBestSellers(result.data);
            return result.data;
          }
          var msg = (result.data && result.data.error) ? result.data.error : ('Error ' + result.status);
          if (result.data && result.data.hint) msg += '. ' + result.data.hint;
          bestSellersCache = null;
          renderBestSellers(null, msg);
          return null;
        })
        .catch(function() { bestSellersCache = null; renderBestSellers(null); return null; });
    }

    function fetchWorstProducts(options = {}) {
      const force = !!options.force;
      let url = API + '/api/worst-products?range=' + encodeURIComponent(getStatsRange()) +
          '&page=' + encodeURIComponent(String(worstProductsPage || 1)) +
          '&pageSize=' + encodeURIComponent(String(TOP_TABLE_PAGE_SIZE));
      if (force) url += '&_=' + Date.now();
      return fetchWithTimeout(url, { credentials: 'same-origin', cache: force ? 'no-store' : 'default' }, 30000)
        .then(function(r) { return r.ok ? r.json() : null; })
        .then(function(data) {
          worstProductsCache = data;
          renderWorstProducts(data);
          return data;
        })
        .catch(function() { worstProductsCache = null; renderWorstProducts(null); return null; });
    }

    function renderWorstProducts(data) {
      const tbody = document.getElementById('worst-products-body');
      if (!tbody) return;
      if (!data || !Array.isArray(data.worstProducts)) {
        tbody.innerHTML = '<tr><td colspan="5" class="empty">No data</td></tr>';
        updateSortHeadersInContainer(document.getElementById('worst-products-table'), tableSortState.worstProducts.by, tableSortState.worstProducts.dir);
        updateCardPagination('worst-products', 1, 1);
        return;
      }
      const rows = data.worstProducts.slice();
      const wpBy = (tableSortState.worstProducts.by || 'cr').toString().trim().toLowerCase();
      const wpDir = (tableSortState.worstProducts.dir || 'asc').toString().trim().toLowerCase() === 'desc' ? 'desc' : 'asc';
      rows.sort(function(a, b) {
        var primary = 0;
        if (wpBy === 'product') primary = cmpNullableText(a && a.handle, b && b.handle, wpDir);
        else if (wpBy === 'sales') primary = cmpNullableNumber(a && a.converted, b && b.converted, wpDir);
        else if (wpBy === 'clicks') primary = cmpNullableNumber(a && a.clicks, b && b.clicks, wpDir);
        else if (wpBy === 'rev') primary = cmpNullableNumber(a && a.revenue, b && b.revenue, wpDir);
        else if (wpBy === 'cr') primary = cmpNullableNumber(a && a.conversion, b && b.conversion, wpDir);

        return primary ||
          // Sensible, stable fallback ordering for "worst" list.
          cmpNullableNumber(a && a.conversion, b && b.conversion, 'asc') ||
          cmpNullableNumber(a && a.clicks, b && b.clicks, 'desc') ||
          cmpNullableNumber(a && a.revenue, b && b.revenue, 'asc') ||
          cmpNullableNumber(a && a.converted, b && b.converted, 'asc') ||
          cmpNullableText(a && a.handle, b && b.handle, 'asc');
      });
      const pageSize = (data && typeof data.pageSize === 'number' && data.pageSize > 0) ? data.pageSize : TOP_TABLE_PAGE_SIZE;
      const totalCount = (data && typeof data.totalCount === 'number' && data.totalCount >= 0) ? data.totalCount : rows.length;
      const totalPages = Math.max(1, Math.ceil(totalCount / pageSize));
      worstProductsPage = clampPage((data && typeof data.page === 'number') ? data.page : worstProductsPage, totalPages);
      updateCardPagination('worst-products', worstProductsPage, totalPages);
      if (rows.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="empty">No product landings in this range</td></tr>';
        updateSortHeadersInContainer(document.getElementById('worst-products-table'), wpBy, wpDir);
        return;
      }
      tbody.innerHTML = rows.map(function(p) {
        const handle = p.handle || '';
        const mainBase = getMainBaseUrl();
        const productUrl = (mainBase && handle) ? (mainBase + '/products/' + encodeURIComponent(handle)) : '';
        const thumbSrc = productUrl ? (API || '') + '/api/og-thumb?url=' + encodeURIComponent(productUrl) + '&width=100' : '';
        const thumbImg = thumbSrc ? '<img class="bs-thumb" src="' + thumbSrc + '" alt="" loading="lazy" onerror="this.style.display=\'none\'">' : '<span class="bs-thumb bs-thumb-placeholder"></span>';
        const thumb = productUrl ? '<a href="' + productUrl + '" target="_blank" rel="noopener">' + thumbImg + '</a>' : thumbImg;
        const name = '<span class="bs-name" title="' + escapeHtml(handle) + '">' + escapeHtml(handle) + '</span>';
        const conversion = p.conversion != null ? pct(p.conversion) : '\u2014';
        const sales = formatSessions(typeof p.converted === 'number' ? p.converted : 0);
        const clicks = formatSessions(typeof p.clicks === 'number' ? p.clicks : 0);
        const revNum = p.revenue != null ? Number(p.revenue) : NaN;
        const revenue = (!Number.isNaN(revNum) && Number.isFinite(revNum)) ? formatRevenueTableHtml(revNum) : '\u2014';
        return '<tr><td class="bs-product-col"><div class="product-cell">' + thumb + ' ' + name + '</div></td><td>' + sales + '</td><td>' + clicks + '</td><td>' + revenue + '</td><td>' + conversion + '</td></tr>';
      }).join('');
      updateSortHeadersInContainer(document.getElementById('worst-products-table'), wpBy, wpDir);
    }

    function fetchBestVariants(options = {}) {
      const force = !!options.force;
      var shop = getShopParam() || shopForSalesFallback || null;
      if (!shop) {
        bestVariantsCache = null;
        renderBestVariants(null);
        return Promise.resolve(null);
      }
      let url = API + '/api/shopify-best-variants?shop=' + encodeURIComponent(shop) +
          '&range=' + encodeURIComponent(getStatsRange()) +
          '&page=' + encodeURIComponent(String(bestVariantsPage || 1)) +
          '&pageSize=' + encodeURIComponent(String(TOP_TABLE_PAGE_SIZE));
      if (force) url += '&_=' + Date.now();
      return fetchWithTimeout(url, { credentials: 'same-origin', cache: force ? 'no-store' : 'default' }, 30000)
        .then(function(r) { return r.json().then(function(data) { return { ok: r.ok, status: r.status, data: data || {} }; }).catch(function() { return { ok: r.ok, status: r.status, data: {} }; }); })
        .then(function(result) {
          if (result.ok) {
            bestVariantsCache = result.data;
            renderBestVariants(result.data);
            return result.data;
          }
          var msg = (result.data && result.data.error) ? result.data.error : ('Error ' + result.status);
          if (result.data && result.data.hint) msg += '. ' + result.data.hint;
          bestVariantsCache = null;
          renderBestVariants(null, msg);
          return null;
        })
        .catch(function() { bestVariantsCache = null; renderBestVariants(null); return null; });
    }

    function fetchWorstVariants(options = {}) {
      const force = !!options.force;
      var shop = getShopParam() || shopForSalesFallback || null;
      if (!shop) {
        worstVariantsCache = null;
        renderWorstVariants(null);
        return Promise.resolve(null);
      }
      let url = API + '/api/shopify-worst-variants?shop=' + encodeURIComponent(shop) +
          '&range=' + encodeURIComponent(getStatsRange()) +
          '&page=' + encodeURIComponent(String(worstVariantsPage || 1)) +
          '&pageSize=' + encodeURIComponent(String(TOP_TABLE_PAGE_SIZE));
      if (force) url += '&_=' + Date.now();
      return fetchWithTimeout(url, { credentials: 'same-origin', cache: force ? 'no-store' : 'default' }, 30000)
        .then(function(r) { return r.json().then(function(data) { return { ok: r.ok, status: r.status, data: data || {} }; }).catch(function() { return { ok: r.ok, status: r.status, data: {} }; }); })
        .then(function(result) {
          if (result.ok) {
            worstVariantsCache = result.data;
            renderWorstVariants(result.data);
            return result.data;
          }
          var msg = (result.data && result.data.error) ? result.data.error : ('Error ' + result.status);
          if (result.data && result.data.hint) msg += '. ' + result.data.hint;
          worstVariantsCache = null;
          renderWorstVariants(null, msg);
          return null;
        })
        .catch(function() { worstVariantsCache = null; renderWorstVariants(null); return null; });
    }

    function renderBestVariants(data, errorMessage) {
      const tbody = document.getElementById('best-variants-body');
      if (!tbody) return;
      if (!data || !Array.isArray(data.bestVariants)) {
        tbody.innerHTML = '<tr><td colspan="5" class="empty">' + (errorMessage ? escapeHtml(errorMessage) : 'No shop or no data') + '</td></tr>';
        updateSortHeadersInContainer(document.getElementById('best-variants-table'), tableSortState.bestVariants.by, tableSortState.bestVariants.dir);
        updateCardPagination('best-variants', 1, 1);
        return;
      }
      const rows = data.bestVariants.slice();
      const bvBy = (tableSortState.bestVariants.by || 'rev').toString().trim().toLowerCase();
      const bvDir = (tableSortState.bestVariants.dir || 'desc').toString().trim().toLowerCase() === 'asc' ? 'asc' : 'desc';
      const totalOrders = (data && typeof data.totalOrders === 'number') ? (Number(data.totalOrders) || 0) : 0;
      function displayVariantName(v) {
        const variantName = (v && v.variant_title && String(v.variant_title).trim()) ? String(v.variant_title).trim() : 'Default';
        const productName = (v && v.title && String(v.title).trim()) ? String(v.title).trim() : '';
        return variantName + (productName ? (' \u2014 ' + productName) : '');
      }
      rows.sort(function(a, b) {
        var primary = 0;
        if (bvBy === 'variant') primary = cmpNullableText(displayVariantName(a), displayVariantName(b), bvDir);
        else if (bvBy === 'sales') primary = cmpNullableNumber(a && a.orders, b && b.orders, bvDir);
        else if (bvBy === 'clicks') primary = cmpNullableNumber(a && a.clicks, b && b.clicks, bvDir);
        else if (bvBy === 'rev') primary = cmpNullableNumber(a && a.revenue, b && b.revenue, bvDir);
        else if (bvBy === 'cr') {
          var ao = a && a.orders != null ? (Number(a.orders) || 0) : 0;
          var bo = b && b.orders != null ? (Number(b.orders) || 0) : 0;
          var acr = totalOrders > 0 ? (ao / totalOrders) : null;
          var bcr = totalOrders > 0 ? (bo / totalOrders) : null;
          primary = cmpNullableNumber(acr, bcr, bvDir) || cmpNullableNumber(ao, bo, 'desc');
        }
        return primary ||
          cmpNullableNumber(a && a.revenue, b && b.revenue, 'desc') ||
          cmpNullableNumber(a && a.orders, b && b.orders, 'desc') ||
          cmpNullableText(displayVariantName(a), displayVariantName(b), 'asc');
      });
      const pageSize = (data && typeof data.pageSize === 'number' && data.pageSize > 0) ? data.pageSize : TOP_TABLE_PAGE_SIZE;
      const totalCount = (data && typeof data.totalCount === 'number' && data.totalCount >= 0) ? data.totalCount : rows.length;
      const totalPages = Math.max(1, Math.ceil(totalCount / pageSize));
      bestVariantsPage = clampPage((data && typeof data.page === 'number') ? data.page : bestVariantsPage, totalPages);
      updateCardPagination('best-variants', bestVariantsPage, totalPages);
      if (rows.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="empty">No orders in this range</td></tr>';
        updateSortHeadersInContainer(document.getElementById('best-variants-table'), bvBy, bvDir);
        return;
      }
      tbody.innerHTML = rows.map(function(v) {
        const variantName = (v.variant_title && String(v.variant_title).trim()) ? String(v.variant_title).trim() : 'Default';
        const productName = (v.title && String(v.title).trim()) ? String(v.title).trim() : '';
        const displayName = variantName + (productName ? (' \u2014 ' + productName) : '');
        const thumbUrl = v.thumb_url ? (hotImgSquare(String(v.thumb_url)) || String(v.thumb_url)) : null;
        const thumbImg = thumbUrl ? '<img class="bs-thumb" src="' + escapeHtml(thumbUrl) + '" alt=\"\" loading=\"lazy\">' : '<span class="bs-thumb bs-thumb-placeholder"></span>';
        const mainBase = getMainBaseUrl();
        const productUrl = (mainBase && v.handle) ? (mainBase + '/products/' + escapeHtml(v.handle) + (v.variant_id ? ('?variant=' + encodeURIComponent(String(v.variant_id))) : '')) : '';
        const thumb = productUrl ? '<a href="' + productUrl + '" target="_blank" rel="noopener">' + thumbImg + '</a>' : thumbImg;
        const name = '<span class="bs-name" title="' + escapeHtml(displayName) + '">' + escapeHtml(displayName) + '</span>';
        const ordersNum = v.orders != null ? (Number(v.orders) || 0) : 0;
        const sales = formatSessions(ordersNum);
        const clicks = (typeof v.clicks === 'number') ? formatSessions(v.clicks) : '\u2014';
        const revenue = formatRevenueTableHtml(v.revenue);
        const totalOrders = (data && typeof data.totalOrders === 'number') ? (Number(data.totalOrders) || 0) : 0;
        const crVal = totalOrders > 0 ? (Math.round((ordersNum / totalOrders) * 1000) / 10) : null;
        const cr = crVal != null ? pct(crVal) : '\u2014';
        return '<tr><td class="bs-product-col"><div class="product-cell">' + thumb + ' ' + name + '</div></td><td>' + sales + '</td><td>' + clicks + '</td><td>' + revenue + '</td><td>' + cr + '</td></tr>';
      }).join('');
      updateSortHeadersInContainer(document.getElementById('best-variants-table'), bvBy, bvDir);
    }

    function renderWorstVariants(data, errorMessage) {
      const tbody = document.getElementById('worst-variants-body');
      if (!tbody) return;
      if (!data || !Array.isArray(data.worstVariants)) {
        tbody.innerHTML = '<tr><td colspan="5" class="empty">' + (errorMessage ? escapeHtml(errorMessage) : 'No shop or no data') + '</td></tr>';
        updateSortHeadersInContainer(document.getElementById('worst-variants-table'), tableSortState.worstVariants.by, tableSortState.worstVariants.dir);
        updateCardPagination('worst-variants', 1, 1);
        return;
      }
      const rows = data.worstVariants.slice();
      const wvBy = (tableSortState.worstVariants.by || 'rev').toString().trim().toLowerCase();
      const wvDir = (tableSortState.worstVariants.dir || 'asc').toString().trim().toLowerCase() === 'desc' ? 'desc' : 'asc';
      const totalOrders = (data && typeof data.totalOrders === 'number') ? (Number(data.totalOrders) || 0) : 0;
      function displayVariantName(v) {
        const variantName = (v && v.variant_title && String(v.variant_title).trim()) ? String(v.variant_title).trim() : 'Default';
        const productName = (v && v.title && String(v.title).trim()) ? String(v.title).trim() : '';
        return variantName + (productName ? (' \u2014 ' + productName) : '');
      }
      rows.sort(function(a, b) {
        var primary = 0;
        if (wvBy === 'variant') primary = cmpNullableText(displayVariantName(a), displayVariantName(b), wvDir);
        else if (wvBy === 'sales') primary = cmpNullableNumber(a && a.orders, b && b.orders, wvDir);
        else if (wvBy === 'clicks') primary = cmpNullableNumber(a && a.clicks, b && b.clicks, wvDir);
        else if (wvBy === 'rev') primary = cmpNullableNumber(a && a.revenue, b && b.revenue, wvDir);
        else if (wvBy === 'cr') {
          var ao = a && a.orders != null ? (Number(a.orders) || 0) : 0;
          var bo = b && b.orders != null ? (Number(b.orders) || 0) : 0;
          var acr = totalOrders > 0 ? (ao / totalOrders) : null;
          var bcr = totalOrders > 0 ? (bo / totalOrders) : null;
          primary = cmpNullableNumber(acr, bcr, wvDir) || cmpNullableNumber(ao, bo, 'asc');
        }
        return primary ||
          // Stable fallback ordering for "worst" list.
          cmpNullableNumber(a && a.revenue, b && b.revenue, 'asc') ||
          cmpNullableNumber(a && a.orders, b && b.orders, 'asc') ||
          cmpNullableNumber(a && a.clicks, b && b.clicks, 'asc') ||
          cmpNullableText(displayVariantName(a), displayVariantName(b), 'asc');
      });
      const pageSize = (data && typeof data.pageSize === 'number' && data.pageSize > 0) ? data.pageSize : TOP_TABLE_PAGE_SIZE;
      const totalCount = (data && typeof data.totalCount === 'number' && data.totalCount >= 0) ? data.totalCount : rows.length;
      const totalPages = Math.max(1, Math.ceil(totalCount / pageSize));
      worstVariantsPage = clampPage((data && typeof data.page === 'number') ? data.page : worstVariantsPage, totalPages);
      updateCardPagination('worst-variants', worstVariantsPage, totalPages);
      if (rows.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="empty">No orders in this range</td></tr>';
        updateSortHeadersInContainer(document.getElementById('worst-variants-table'), wvBy, wvDir);
        return;
      }
      tbody.innerHTML = rows.map(function(v) {
        const variantName = (v.variant_title && String(v.variant_title).trim()) ? String(v.variant_title).trim() : 'Default';
        const productName = (v.title && String(v.title).trim()) ? String(v.title).trim() : '';
        const displayName = variantName + (productName ? (' \u2014 ' + productName) : '');
        const thumbUrl = v.thumb_url ? (hotImgSquare(String(v.thumb_url)) || String(v.thumb_url)) : null;
        const thumbImg = thumbUrl ? '<img class="bs-thumb" src="' + escapeHtml(thumbUrl) + '" alt=\"\" loading=\"lazy\">' : '<span class="bs-thumb bs-thumb-placeholder"></span>';
        const mainBase = getMainBaseUrl();
        const productUrl = (mainBase && v.handle) ? (mainBase + '/products/' + escapeHtml(v.handle) + (v.variant_id ? ('?variant=' + encodeURIComponent(String(v.variant_id))) : '')) : '';
        const thumb = productUrl ? '<a href="' + productUrl + '" target="_blank" rel="noopener">' + thumbImg + '</a>' : thumbImg;
        const name = '<span class="bs-name" title="' + escapeHtml(displayName) + '">' + escapeHtml(displayName) + '</span>';
        const ordersNum = v.orders != null ? (Number(v.orders) || 0) : 0;
        const sales = formatSessions(ordersNum);
        const clicks = (typeof v.clicks === 'number') ? formatSessions(v.clicks) : '\u2014';
        const revenue = formatRevenueTableHtml(v.revenue);
        const totalOrders = (data && typeof data.totalOrders === 'number') ? (Number(data.totalOrders) || 0) : 0;
        const crVal = totalOrders > 0 ? (Math.round((ordersNum / totalOrders) * 1000) / 10) : null;
        const cr = crVal != null ? pct(crVal) : '\u2014';
        return '<tr><td class="bs-product-col"><div class="product-cell">' + thumb + ' ' + name + '</div></td><td>' + sales + '</td><td>' + clicks + '</td><td>' + revenue + '</td><td>' + cr + '</td></tr>';
      }).join('');
      updateSortHeadersInContainer(document.getElementById('worst-variants-table'), wvBy, wvDir);
    }

    function renderBestSellers(data, errorMessage) {
      const tbody = document.getElementById('best-sellers-body');
      if (!tbody) return;
      if (!data || !Array.isArray(data.bestSellers)) {
        tbody.innerHTML = '<tr><td colspan="5" class="empty">' + (errorMessage ? escapeHtml(errorMessage) : 'No shop or no data') + '</td></tr>';
        updateBestSellersSortHeaders();
        updateCardPagination('best-sellers', 1, 1);
        return;
      }
      const rows = data.bestSellers.slice();
      const sortKey = (bestSellersSortBy || 'rev').toString().trim().toLowerCase();
      const sortDir = (bestSellersSortDir || 'desc').toString().trim().toLowerCase() === 'asc' ? 'asc' : 'desc';
      rows.sort(function(a, b) {
        if (sortKey === 'title') return cmpNullableText(a && a.title, b && b.title, sortDir);
        if (sortKey === 'orders') return cmpNullableNumber(a && a.orders, b && b.orders, sortDir);
        if (sortKey === 'clicks') return cmpNullableNumber(a && a.clicks, b && b.clicks, sortDir);
        if (sortKey === 'rev') return cmpNullableNumber(a && a.revenue, b && b.revenue, sortDir);
        if (sortKey === 'cr') {
          return cmpNullableNumber(a && a.cr, b && b.cr, sortDir) ||
            cmpNullableNumber(a && a.orders, b && b.orders, 'desc');
        }
        return 0;
      });
      const pageSize = (data && typeof data.pageSize === 'number' && data.pageSize > 0) ? data.pageSize : TOP_TABLE_PAGE_SIZE;
      const totalCount = (data && typeof data.totalCount === 'number' && data.totalCount >= 0) ? data.totalCount : rows.length;
      const totalPages = Math.max(1, Math.ceil(totalCount / pageSize));
      bestSellersPage = clampPage((data && typeof data.page === 'number') ? data.page : bestSellersPage, totalPages);
      updateCardPagination('best-sellers', bestSellersPage, totalPages);
      if (rows.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="empty">No orders in this range</td></tr>';
        updateBestSellersSortHeaders();
        return;
      }
      tbody.innerHTML = rows.map(function(p) {
        const thumbUrl = p.thumb_url ? (hotImgSquare(String(p.thumb_url)) || String(p.thumb_url)) : null;
        const thumbImg = thumbUrl ? '<img class="bs-thumb" src="' + escapeHtml(thumbUrl) + '" alt="" loading="lazy">' : '<span class="bs-thumb bs-thumb-placeholder"></span>';
        const mainBase = getMainBaseUrl();
        const productUrl = (mainBase && p.handle) ? mainBase + '/products/' + escapeHtml(p.handle) : '';
        const thumb = productUrl ? '<a href="' + productUrl + '" target="_blank" rel="noopener">' + thumbImg + '</a>' : thumbImg;
        const name = '<span class="bs-name" title="' + escapeHtml(p.title) + '">' + escapeHtml(p.title) + '</span>';
        const orders = String(p.orders != null ? p.orders : 0);
        const clicks = (typeof p.clicks === 'number') ? formatSessions(p.clicks) : '\u2014';
        const revenue = formatRevenueTableHtml(p.revenue);
        const cr = p.cr != null ? pct(p.cr) : '\u2014';
        return '<tr><td class="bs-product-col"><div class="product-cell">' + thumb + ' ' + name + '</div></td><td>' + orders + '</td><td>' + clicks + '</td><td>' + revenue + '</td><td>' + cr + '</td></tr>';
      }).join('');
      updateBestSellersSortHeaders();
    }

    function updateBestSellersSortHeaders() {
      document.querySelectorAll('#best-sellers-wrap th.sortable').forEach(function(th) {
        var col = th.getAttribute('data-sort');
        th.classList.remove('th-sort-asc', 'th-sort-desc');
        th.setAttribute('aria-sort', bestSellersSortBy === col ? (bestSellersSortDir === 'asc' ? 'ascending' : 'descending') : 'none');
        if (bestSellersSortBy === col) th.classList.add(bestSellersSortDir === 'asc' ? 'th-sort-asc' : 'th-sort-desc');
      });
    }

    function setupBestSellersSort() {
      document.querySelectorAll('#best-sellers-wrap th.sortable').forEach(function(th) {
        function activate() {
          var col = (th.getAttribute('data-sort') || '').trim();
          if (!col) return;
          if (bestSellersSortBy === col) bestSellersSortDir = bestSellersSortDir === 'asc' ? 'desc' : 'asc';
          else { bestSellersSortBy = col; bestSellersSortDir = col === 'title' ? 'asc' : 'desc'; }
          bestSellersPage = 1;
          updateBestSellersSortHeaders();
          fetchBestSellers();
        }
        th.addEventListener('click', function(e) {
          if (e && typeof e.preventDefault === 'function') e.preventDefault();
          activate();
        });
        th.addEventListener('keydown', function(e) {
          if (!e || (e.key !== 'Enter' && e.key !== ' ')) return;
          e.preventDefault();
          activate();
        });
      });
    }

    function asSortText(v) {
      if (v == null) return '';
      return String(v).trim().toLowerCase();
    }

    function asFiniteNumber(v) {
      const n = (typeof v === 'number') ? v : Number(v);
      return Number.isFinite(n) ? n : null;
    }

    function cmpNullableText(a, b, dir) {
      const da = asSortText(a);
      const db = asSortText(b);
      const d = dir === 'asc' ? 'asc' : 'desc';
      if (!da && !db) return 0;
      if (!da) return 1;
      if (!db) return -1;
      if (da === db) return 0;
      if (d === 'asc') return da < db ? -1 : 1;
      return da < db ? 1 : -1;
    }

    function cmpNullableNumber(a, b, dir) {
      const na = asFiniteNumber(a);
      const nb = asFiniteNumber(b);
      const d = dir === 'asc' ? 'asc' : 'desc';
      if (na == null && nb == null) return 0;
      if (na == null) return 1;
      if (nb == null) return -1;
      if (na === nb) return 0;
      return d === 'asc' ? (na - nb) : (nb - na);
    }

    function updateSortHeadersInContainer(container, sortBy, sortDir) {
      const root = typeof container === 'string' ? document.querySelector(container) : container;
      if (!root) return;
      root.querySelectorAll('th.sortable').forEach(function(th) {
        var col = (th.getAttribute('data-sort') || '').trim();
        th.classList.remove('th-sort-asc', 'th-sort-desc');
        th.setAttribute('aria-sort', sortBy === col ? (sortDir === 'asc' ? 'ascending' : 'descending') : 'none');
        if (sortBy === col) th.classList.add(sortDir === 'asc' ? 'th-sort-asc' : 'th-sort-desc');
      });
    }

    function setupTableSortHeaders(container, state, defaults, onChange) {
      const root = typeof container === 'string' ? document.querySelector(container) : container;
      if (!root || !state) return;
      root.querySelectorAll('th.sortable').forEach(function(th) {
        function activate() {
          var col = (th.getAttribute('data-sort') || '').trim();
          if (!col) return;
          var prevCol = state.by;
          if (state.by === col) state.dir = state.dir === 'asc' ? 'desc' : 'asc';
          else { state.by = col; state.dir = (defaults && defaults[col]) ? defaults[col] : 'asc'; }
          state.dir = state.dir === 'asc' ? 'asc' : 'desc';
          updateSortHeadersInContainer(root, state.by, state.dir);
          if (typeof onChange === 'function') onChange({ by: state.by, dir: state.dir, columnChanged: prevCol !== state.by });
        }
        th.addEventListener('click', function(e) {
          if (e && typeof e.preventDefault === 'function') e.preventDefault();
          activate();
        });
        th.addEventListener('keydown', function(e) {
          if (!e || (e.key !== 'Enter' && e.key !== ' ')) return;
          e.preventDefault();
          activate();
        });
      });
      state.dir = state.dir === 'asc' ? 'asc' : 'desc';
      updateSortHeadersInContainer(root, state.by, state.dir);
    }

    function setupAllTableSorts() {
      setupTableSortHeaders(document.getElementById('country-table'), tableSortState.country, TABLE_SORT_DEFAULTS.country, function(info) {
        if (info && info.columnChanged) countryPage = 1;
        renderCountry(statsCache);
      });
      setupTableSortHeaders(document.getElementById('best-geo-products-table'), tableSortState.bestGeoProducts, TABLE_SORT_DEFAULTS.bestGeoProducts, function(info) {
        if (info && info.columnChanged) bestGeoProductsPage = 1;
        renderBestGeoProducts(statsCache);
      });
      setupTableSortHeaders(document.getElementById('worst-products-table'), tableSortState.worstProducts, TABLE_SORT_DEFAULTS.worstProducts, function(info) {
        if (info && info.columnChanged) {
          worstProductsPage = 1;
          fetchWorstProducts();
          return;
        }
        if (worstProductsCache) renderWorstProducts(worstProductsCache);
        else fetchWorstProducts();
      });
      setupTableSortHeaders(document.getElementById('best-variants-table'), tableSortState.bestVariants, TABLE_SORT_DEFAULTS.bestVariants, function(info) {
        if (info && info.columnChanged) {
          bestVariantsPage = 1;
          fetchBestVariants();
          return;
        }
        if (bestVariantsCache) renderBestVariants(bestVariantsCache);
        else fetchBestVariants();
      });
      setupTableSortHeaders(document.getElementById('worst-variants-table'), tableSortState.worstVariants, TABLE_SORT_DEFAULTS.worstVariants, function(info) {
        if (info && info.columnChanged) {
          worstVariantsPage = 1;
          fetchWorstVariants();
          return;
        }
        if (worstVariantsCache) renderWorstVariants(worstVariantsCache);
        else fetchWorstVariants();
      });

      setupTableSortHeaders(document.getElementById('traffic-sources-table'), tableSortState.trafficSources, TABLE_SORT_DEFAULTS.trafficSources, function() {
        renderTrafficTables(trafficCache || {});
      });
      setupTableSortHeaders(document.getElementById('traffic-types-table'), tableSortState.trafficTypes, TABLE_SORT_DEFAULTS.trafficTypes, function() {
        renderTrafficTables(trafficCache || {});
      });
    }

    function formatSessions(n) {
      if (n == null || typeof n !== 'number') return '—';
      return n.toLocaleString();
    }

    function clampPage(p, totalPages) {
      const n = typeof p === 'number' ? p : parseInt(String(p), 10);
      if (!Number.isFinite(n)) return 1;
      return Math.min(Math.max(1, n), Math.max(1, totalPages || 1));
    }

    function updateCardPagination(prefix, page, totalPages) {
      const wrap = document.getElementById(prefix + '-pagination');
      const prev = document.getElementById(prefix + '-prev');
      const next = document.getElementById(prefix + '-next');
      const label = document.getElementById(prefix + '-label');
      if (!wrap || !prev || !next || !label) return;
      const pages = Math.max(1, totalPages || 1);
      const show = pages > 1;
      wrap.dataset.paginated = show ? '1' : '0';
      wrap.dataset.pages = String(pages);
      wrap.dataset.page = String(page);
      wrap.style.display = show ? 'flex' : 'none';
      prev.disabled = page <= 1;
      next.disabled = page >= pages;
      label.textContent = 'Page ' + page + ' of ' + pages;
    }

    let breakdownSyncRaf = null;
    function scheduleBreakdownSync() {
      if (typeof requestAnimationFrame !== 'function') {
        syncBreakdownPaginationHeights();
        return;
      }
      if (breakdownSyncRaf) cancelAnimationFrame(breakdownSyncRaf);
      breakdownSyncRaf = requestAnimationFrame(function() {
        breakdownSyncRaf = null;
        syncBreakdownPaginationHeights();
      });
    }

    function syncBreakdownPaginationHeights() {
      const countryCard = document.getElementById('stats-country');
      const geoCard = document.getElementById('stats-best-geo-products');
      const countryPag = document.getElementById('country-pagination');
      const geoPag = document.getElementById('best-geo-products-pagination');
      if (!countryCard || !geoCard || !countryPag || !geoPag) return;

      countryCard.style.minHeight = '';
      geoCard.style.minHeight = '';

      const countryNeeds = countryPag.dataset.paginated === '1';
      const geoNeeds = geoPag.dataset.paginated === '1';
      countryPag.style.display = countryNeeds ? 'flex' : 'none';
      geoPag.style.display = geoNeeds ? 'flex' : 'none';

      const countryHeight = countryCard.getBoundingClientRect().height;
      const geoHeight = geoCard.getBoundingClientRect().height;
      if (!Number.isFinite(countryHeight) || !Number.isFinite(geoHeight)) return;
      if (Math.abs(countryHeight - geoHeight) < 1) return;

      const shorter = countryHeight < geoHeight
        ? { card: countryCard, pag: countryPag, needs: countryNeeds }
        : { card: geoCard, pag: geoPag, needs: geoNeeds };
      const taller = countryHeight < geoHeight ? geoCard : countryCard;

      if (!shorter.needs) shorter.pag.style.display = 'flex';

      const newCountryHeight = countryCard.getBoundingClientRect().height;
      const newGeoHeight = geoCard.getBoundingClientRect().height;
      const maxHeight = Math.max(newCountryHeight, newGeoHeight);
      countryCard.style.minHeight = maxHeight + 'px';
      geoCard.style.minHeight = maxHeight + 'px';
      if (taller) taller.style.minHeight = maxHeight + 'px';
    }

    function renderSales(data) {
      const sales = data.sales || {};
      const salesTodayEl = document.getElementById('sales-today');
      const range = getStatsRange();
      const baseSales = (sales[range] != null ? sales[range] : 0);
      if (salesTodayEl) salesTodayEl.textContent = formatRevenue(baseSales);
      const salesYesterdayEl = document.getElementById('sales-yesterday');
      if (salesYesterdayEl) salesYesterdayEl.textContent = formatRevenue(sales.yesterday);
    }

    function renderConversion(data) {
      const c = data.conversion || {};
      const range = getStatsRange();
      document.getElementById('conversion-range').textContent = pct(c[range]);
      const productCr = (data.productConversion || {})[range];
      const productCrEl = document.getElementById('conversion-product-cr');
      if (productCrEl) productCrEl.textContent = productCr != null ? pct(productCr) : '\u2014';
    }

    function renderSessions(data) {
      const breakdown = data && data.trafficBreakdown ? data.trafficBreakdown : {};
      const forRange = breakdown[getStatsRange()];
      const forYesterday = breakdown.yesterday;
      const main = forRange != null ? forRange.human_sessions : null;
      const yesterday = forYesterday != null ? forYesterday.human_sessions : null;
      const sessionsRangeEl = document.getElementById('sessions-range');
      const sessionsYesterdayEl = document.getElementById('sessions-yesterday');
      if (sessionsRangeEl) sessionsRangeEl.textContent = formatSessions(main);
      if (sessionsYesterdayEl) sessionsYesterdayEl.textContent = formatSessions(yesterday);
    }

    function renderAov(data) {
      const rows = (data.country || {})[getStatsRange()] || [];
      const grid = document.getElementById('aov-cards-grid');
      if (!grid) return;
      const filtered = rows.filter(r => r.aov != null && r.aov > 0);
      if (filtered.length === 0) {
        grid.innerHTML = '<div class="aov-card aov-card-empty">No data</div>';
        return;
      }
      const list = filtered.slice();
      list.sort(function(a, b) { return cmpNullableNumber(a && a.aov, b && b.aov, 'desc'); });
      grid.innerHTML = list.map(r => {
        const iso = (r.country_code || 'XX').toUpperCase().slice(0, 2);
        const code = iso.toLowerCase();
        const label = countryLabelFull(iso);
        const flag = '<img class="flag-img" src="' + hotImg('https://flagcdn.com/w40/' + code + '.png') + '" alt="' + escapeHtml(label) + '" title="' + escapeHtml(label) + '" loading="lazy">';
        return '<div class="aov-card">' +
          '<div class="aov-card-left">' + flag + '<span class="aov-card-name">' + escapeHtml(label) + '</span></div>' +
          '<div class="aov-card-value">' + formatRevenueTableHtml(r.aov) + '</div>' +
        '</div>';
      }).join('');
    }

    function renderCountry(data) {
      const c = data.country || {};
      const rows = c[getStatsRange()] || [];
      const tbody = document.getElementById('by-country-body');
      if (!tbody) return;
      if (rows.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="empty">No data</td></tr>';
        updateSortHeadersInContainer(document.getElementById('country-table'), tableSortState.country.by, tableSortState.country.dir);
        updateCardPagination('country', 1, 1);
        return;
      }
      const list = rows.slice();
      const countryBy = (tableSortState.country.by || 'rev').toString().trim().toLowerCase();
      const countryDir = (tableSortState.country.dir || 'desc').toString().trim().toLowerCase() === 'asc' ? 'asc' : 'desc';
      function labelFor(r) {
        const code = (r && r.country_code != null ? String(r.country_code) : 'XX').toUpperCase().slice(0, 2);
        return countryLabel(code);
      }
      list.sort(function(a, b) {
        if (countryBy === 'country') return cmpNullableText(labelFor(a), labelFor(b), countryDir);
        if (countryBy === 'cr') return cmpNullableNumber(a && a.conversion, b && b.conversion, countryDir) || cmpNullableText(labelFor(a), labelFor(b), 'asc');
        if (countryBy === 'sales') return cmpNullableNumber(a && a.converted, b && b.converted, countryDir) || cmpNullableText(labelFor(a), labelFor(b), 'asc');
        if (countryBy === 'clicks') return cmpNullableNumber(a && a.total, b && b.total, countryDir) || cmpNullableText(labelFor(a), labelFor(b), 'asc');
        if (countryBy === 'rev') return cmpNullableNumber(a && a.revenue, b && b.revenue, countryDir) || cmpNullableText(labelFor(a), labelFor(b), 'asc');
        return 0;
      });

      const totalPages = Math.max(1, Math.ceil(list.length / TOP_TABLE_PAGE_SIZE));
      countryPage = clampPage(countryPage, totalPages);
      updateCardPagination('country', countryPage, totalPages);
      const start = (countryPage - 1) * TOP_TABLE_PAGE_SIZE;
      const pageRows = list.slice(start, start + TOP_TABLE_PAGE_SIZE);
      tbody.innerHTML = pageRows.map(r => {
        const code = (r.country_code || 'XX').toUpperCase().slice(0, 2);
        const ccode = (r.country_code || 'xx').toLowerCase().slice(0, 2);
        const label = countryLabel(code);
        const conversion = pct(r.conversion);
        const salesCount = r.converted != null ? Number(r.converted) : 0;
        const clicks = r.total != null ? formatSessions(r.total) : '—';
        const revenue = formatRevenueTableHtml(r.revenue);
        const flag = '<img class="flag-img" src="' + hotImg('https://flagcdn.com/w40/' + ccode + '.png') + '" alt="' + escapeHtml(label) + '" title="' + escapeHtml(label) + '" loading="lazy">';
        const labelHtml = '<span class="country-label"><span class="country-name">' + escapeHtml(label) + '</span><span class="country-code">' + escapeHtml(code) + '</span></span>';
        return '<tr><td><span class="country-cell">' + flag + labelHtml + '</span></td><td>' + conversion + '</td><td>' + salesCount + '</td><td>' + clicks + '</td><td>' + revenue + '</td></tr>';
      }).join('');
      updateSortHeadersInContainer(document.getElementById('country-table'), countryBy, countryDir);
      scheduleBreakdownSync();
    }

    function renderBestGeoProducts(data) {
      const map = data && data.bestGeoProducts ? data.bestGeoProducts : {};
      const rows = map[getStatsRange()] || [];
      const tbody = document.getElementById('best-geo-products-body');
      if (!tbody) return;
      if (!Array.isArray(rows) || rows.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="empty">No data</td></tr>';
        updateSortHeadersInContainer(document.getElementById('best-geo-products-table'), tableSortState.bestGeoProducts.by, tableSortState.bestGeoProducts.dir);
        updateCardPagination('best-geo-products', 1, 1);
        return;
      }
      const list = rows.slice();
      const geoBy = (tableSortState.bestGeoProducts.by || 'rev').toString().trim().toLowerCase();
      const geoDir = (tableSortState.bestGeoProducts.dir || 'desc').toString().trim().toLowerCase() === 'asc' ? 'asc' : 'desc';
      function geoCountryLabel(r) {
        const iso = (r && r.country_code != null ? String(r.country_code) : 'XX').toUpperCase().slice(0, 2);
        return countryLabel(iso);
      }
      function geoProductTitle(r) {
        return (r && r.product_title != null) ? String(r.product_title).trim() : '';
      }
      list.sort(function(a, b) {
        if (geoBy === 'country') {
          return cmpNullableText(geoCountryLabel(a), geoCountryLabel(b), geoDir) ||
            cmpNullableText(geoProductTitle(a), geoProductTitle(b), 'asc');
        }
        if (geoBy === 'cr') return cmpNullableNumber(a && a.conversion, b && b.conversion, geoDir) || cmpNullableNumber(a && a.total, b && b.total, 'desc');
        if (geoBy === 'sales') return cmpNullableNumber(a && a.converted, b && b.converted, geoDir) || cmpNullableNumber(a && a.revenue, b && b.revenue, 'desc');
        if (geoBy === 'clicks') return cmpNullableNumber(a && a.total, b && b.total, geoDir) || cmpNullableNumber(a && a.converted, b && b.converted, 'desc');
        if (geoBy === 'rev') return cmpNullableNumber(a && a.revenue, b && b.revenue, geoDir) || cmpNullableNumber(a && a.converted, b && b.converted, 'desc');
        return 0;
      });

      const totalPages = Math.max(1, Math.ceil(list.length / TOP_TABLE_PAGE_SIZE));
      bestGeoProductsPage = clampPage(bestGeoProductsPage, totalPages);
      updateCardPagination('best-geo-products', bestGeoProductsPage, totalPages);
      const start = (bestGeoProductsPage - 1) * TOP_TABLE_PAGE_SIZE;
      const pageRows = list.slice(start, start + TOP_TABLE_PAGE_SIZE);
      tbody.innerHTML = pageRows.map(r => {
        const iso = (r.country_code || 'XX').toUpperCase().slice(0, 2);
        const ccode = iso.toLowerCase();
        const label = countryLabel(iso);
        const productTitle = (r.product_title && String(r.product_title).trim()) ? String(r.product_title).trim() : '—';
        const productHandle = (r && r.product_handle != null) ? String(r.product_handle).trim() : '';
        const productThumb = (r && r.product_thumb_url != null) ? String(r.product_thumb_url).trim() : '';
        const mainBase = getMainBaseUrl();
        const productUrl = (mainBase && productHandle) ? (mainBase + '/products/' + encodeURIComponent(productHandle)) : '';
        const conversion = pct(r.conversion);
        const salesCount = r.converted != null ? Number(r.converted) : 0;
        const clicks = r.total != null ? formatSessions(r.total) : '—';
        const revenue = formatRevenueTableHtml(r.revenue);
        const flag = '<img class="flag-img" src="' + hotImg('https://flagcdn.com/w40/' + ccode + '.png') + '" alt="' + escapeHtml(label) + '" title="' + escapeHtml(label) + '" loading="lazy">';
        const thumbImg = productThumb
          ? '<img src="' + escapeHtml(productThumb) + '" alt="' + escapeHtml(productTitle) + '" loading="lazy">'
          : '<span class="geo-product-thumb-placeholder" aria-hidden="true"></span>';
        const thumb = productUrl
          ? '<a class="geo-product-thumb" href="' + escapeHtml(productUrl) + '" target="_blank" rel="noopener" title="' + escapeHtml(productTitle) + '">' + thumbImg + '</a>'
          : '<span class="geo-product-thumb" title="' + escapeHtml(productTitle) + '">' + thumbImg + '</span>';
        const labelHtml = '<span class="country-label">' + thumb + '</span>';
        return '<tr><td><span class="country-cell">' + flag + labelHtml + '</span></td><td>' + conversion + '</td><td>' + salesCount + '</td><td>' + clicks + '</td><td>' + revenue + '</td></tr>';
      }).join('');
      updateSortHeadersInContainer(document.getElementById('best-geo-products-table'), geoBy, geoDir);
      scheduleBreakdownSync();
    }

    function isCustomDayRangeKey(v) {
      return typeof v === 'string' && /^d:\d{4}-\d{2}-\d{2}$/.test(v);
    }

    function isCustomRangeKey(v) {
      return typeof v === 'string' && /^r:\d{4}-\d{2}-\d{2}:\d{4}-\d{2}-\d{2}$/.test(v);
    }

    function ymdFromDayKey(dayKey) {
      if (!isCustomDayRangeKey(dayKey)) return null;
      return dayKey.slice(2);
    }

    function ymdRangeFromRangeKey(rangeKey) {
      if (!isCustomRangeKey(rangeKey)) return null;
      const parts = String(rangeKey).split(':');
      if (parts.length !== 3) return null;
      const a = String(parts[1] || '').trim();
      const b = String(parts[2] || '').trim();
      if (!/^\d{4}-\d{2}-\d{2}$/.test(a) || !/^\d{4}-\d{2}-\d{2}$/.test(b)) return null;
      const startYmd = a <= b ? a : b;
      const endYmd = a <= b ? b : a;
      return { startYmd, endYmd };
    }

    function appliedYmdRangeFromDateRange() {
      if (isCustomRangeKey(dateRange)) return ymdRangeFromRangeKey(dateRange);
      if (isCustomDayRangeKey(dateRange)) {
        const ymd = ymdFromDayKey(dateRange);
        return ymd ? { startYmd: ymd, endYmd: ymd } : null;
      }
      return null;
    }

    function formatYmdLabel(ymd) {
      if (!ymd || !/^\d{4}-\d{2}-\d{2}$/.test(String(ymd))) return String(ymd || '');
      const y = parseInt(String(ymd).slice(0, 4), 10);
      const m = parseInt(String(ymd).slice(5, 7), 10);
      const d = parseInt(String(ymd).slice(8, 10), 10);
      if (!Number.isFinite(y) || !Number.isFinite(m) || !Number.isFinite(d)) return String(ymd || '');
      const dt = new Date(Date.UTC(y, m - 1, d, 12, 0, 0));
      try {
        return new Intl.DateTimeFormat('en-GB', { weekday: 'short', day: 'numeric', month: 'short' }).format(dt);
      } catch (_) {
        return String(ymd || '');
      }
    }

    function formatYmdRangeLabel(startYmd, endYmd) {
      if (!startYmd || !endYmd) return '';
      if (startYmd === endYmd) return formatYmdLabel(startYmd);
      return formatYmdLabel(startYmd) + ' – ' + formatYmdLabel(endYmd);
    }

    function makeRangeKeyFromYmds(startYmd, endYmd) {
      const a = String(startYmd || '').trim();
      const b = String(endYmd || '').trim();
      if (!/^\d{4}-\d{2}-\d{2}$/.test(a) || !/^\d{4}-\d{2}-\d{2}$/.test(b)) return null;
      const s = a <= b ? a : b;
      const e = a <= b ? b : a;
      return 'r:' + s + ':' + e;
    }

    function updateLiveViewTitle() {
      const tabsWrap = document.getElementById('table-title-tabs');
      const textEl = document.getElementById('table-title-text');
      const sel = document.getElementById('global-date-select');
      const showTabs = (dateRange === 'live' || dateRange === '1h' || dateRange === 'today');
      if (tabsWrap) tabsWrap.style.display = showTabs ? 'inline-flex' : 'none';
      if (textEl) textEl.style.display = showTabs ? 'none' : 'inline';
      if (showTabs && tabsWrap) {
        ['today', '1h', 'live'].forEach(function(r) {
          const btn = document.getElementById('table-tab-' + (r === '1h' ? '1h' : r));
          if (btn) btn.setAttribute('aria-selected', dateRange === r ? 'true' : 'false');
        });
      } else {
        let label = null;
        const applied = appliedYmdRangeFromDateRange();
        if (applied && applied.startYmd && applied.endYmd) {
          label = formatYmdRangeLabel(applied.startYmd, applied.endYmd);
        } else if (sel) {
          const opt = sel.querySelector('option[value="' + dateRange + '"]') || sel.options[sel.selectedIndex];
          label = opt && opt.textContent ? String(opt.textContent).trim() : null;
        }
        const fallback = { live: 'Now', today: 'Today', yesterday: 'Yesterday', '3d': 'Last 3 Days', '7d': 'Last 7 Days', '1h': 'Last Hour', custom: 'Choose dates' };
        if (textEl) textEl.textContent = label || fallback[dateRange] || 'Today';
      }
    }

    function updateRowsPerPageVisibility() {
      const wrap = document.getElementById('rows-per-page-wrap');
      if (wrap) wrap.style.display = dateRange === 'live' ? 'none' : '';
    }

    function syncDateSelectOptions() {
      const sel = document.getElementById('global-date-select');
      if (!sel) return;
      const hasLive = sel.querySelector('option[value="live"]');
      if (hasLive) hasLive.remove();
      // Keep the "Choose dates…" option stable, and create a dynamic option for the currently applied custom range.
      const customOpt = document.getElementById('date-opt-custom') || sel.querySelector('option[value="custom"]');
      if (customOpt) customOpt.textContent = 'Choose dates…';

      // Remove previous dynamic custom-range option(s).
      sel.querySelectorAll('option[data-custom-range="1"]').forEach(function(o) { try { o.remove(); } catch (_) {} });

      // Normalize legacy single-day custom keys into the new range key.
      if (isCustomDayRangeKey(dateRange)) {
        const ymd = ymdFromDayKey(dateRange);
        const rk = ymd ? makeRangeKeyFromYmds(ymd, ymd) : null;
        if (rk) dateRange = rk;
      }

      const applied = appliedYmdRangeFromDateRange();
      if (applied && applied.startYmd && applied.endYmd) {
        customRangeStartYmd = applied.startYmd;
        customRangeEndYmd = applied.endYmd;
        const label = formatYmdRangeLabel(applied.startYmd, applied.endYmd) || 'Selected dates';
        const opt = document.createElement('option');
        opt.value = String(dateRange);
        opt.textContent = label;
        opt.setAttribute('data-custom-range', '1');
        if (customOpt && customOpt.parentNode === sel) sel.insertBefore(opt, customOpt);
        else sel.appendChild(opt);
        sel.value = String(dateRange);
      } else if (activeMainTab === 'spy') {
        // Spy supports live/last-hour table tabs; dropdown stays on Today/Yesterday/Choose dates.
        sel.value = (dateRange === 'live' || dateRange === '1h') ? 'today' : String(dateRange || 'today');
      } else {
        // Other tabs only use day/range ranges; if somehow on live, treat as Today.
        if (dateRange === 'live') {
          dateRange = 'today';
          sessionsTotal = null;
        }
        sel.value = (dateRange === 'live' || dateRange === '1h') ? 'today' : String(dateRange || 'today');
      }

      updateLiveViewTitle();
      updateRowsPerPageVisibility();
    }

    function applyRangeAvailable(available) {
      const sel = document.getElementById('global-date-select');
      if (!sel) return;
      const opts = sel.querySelectorAll('option');
      const keys = ['today', 'yesterday'];
      const start = 0;
      keys.forEach((key, i) => {
        const o = opts[start + i];
        if (o) o.disabled = !available[key];
      });
      if (dateRange !== 'live' && !isCustomDayRangeKey(dateRange) && !isCustomRangeKey(dateRange) && available && available[dateRange] === false) {
        dateRange = 'today';
        customRangeStartYmd = null;
        customRangeEndYmd = null;
        syncDateSelectOptions();
      }
      updateLiveViewTitle();
      updateRowsPerPageVisibility();
    }

    // Custom date calendar (last 30 days, disabled if no data)
    let availableDaysMemo = null;
    let availableDaysMemoAt = 0;
    let availableDaysInflight = null;
    const AVAILABLE_DAYS_MEMO_TTL_MS = 60 * 1000;

    function fetchAvailableDays(days, opts = {}) {
      const force = !!opts.force;
      const now = Date.now();
      if (!force && availableDaysMemo && (now - availableDaysMemoAt) < AVAILABLE_DAYS_MEMO_TTL_MS) {
        return Promise.resolve(availableDaysMemo);
      }
      if (!force && availableDaysInflight) return availableDaysInflight;
      const url = API + '/api/available-days?days=' + encodeURIComponent(String(days || 30)) + (force ? ('&_=' + now) : '');
      const p = fetchWithTimeout(url, { credentials: 'same-origin', cache: force ? 'no-store' : 'default' }, 20000)
        .then((r) => (r && r.ok) ? r.json() : null)
        .then((data) => {
          if (data && data.ok) {
            availableDaysMemo = data;
            availableDaysMemoAt = Date.now();
          }
          return data;
        })
        .catch(() => null)
        .finally(() => {
          if (availableDaysInflight === p) availableDaysInflight = null;
        });
      availableDaysInflight = p;
      return p;
    }

    function pad2(n) { return String(n).padStart(2, '0'); }

    function weekdayMon0(year, month, day, timeZone) {
      const dt = new Date(Date.UTC(year, month - 1, day, 12, 0, 0));
      try {
        const wd = new Intl.DateTimeFormat('en-US', { timeZone: timeZone || undefined, weekday: 'short' }).format(dt);
        const map = { Mon: 0, Tue: 1, Wed: 2, Thu: 3, Fri: 4, Sat: 5, Sun: 6 };
        if (map[wd] != null) return map[wd];
      } catch (_) {}
      const dow = dt.getUTCDay(); // 0=Sun..6=Sat
      return (dow + 6) % 7; // Mon=0..Sun=6
    }

    function daysInMonth(year, month) {
      // month: 1-12
      return new Date(Date.UTC(year, month, 0, 12, 0, 0)).getUTCDate();
    }

    function renderCustomCalendar(container, payload) {
      if (!container) return;
      const data = payload && payload.ok ? payload : null;
      if (!data || !Array.isArray(data.days)) {
        container.innerHTML = '<div class="muted">Could not load calendar.</div>';
        return;
      }
      const timeZone = data.timeZone || undefined;
      const list = data.days.slice(); // { date, hasSessions } (today -> older)
      const availableByYmd = new Map();
      const ymdSet = new Set();
      for (const it of list) {
        if (!it || !it.date) continue;
        const ymd = String(it.date);
        ymdSet.add(ymd);
        availableByYmd.set(ymd, !!it.hasSessions);
      }
      const months = [];
      for (let i = list.length - 1; i >= 0; i--) {
        const ymd = list[i] && list[i].date ? String(list[i].date) : '';
        const key = ymd.slice(0, 7);
        if (key && (months.length === 0 || months[months.length - 1] !== key)) months.push(key);
      }
      const partsToMonthTitle = (year, month) => {
        const dt = new Date(Date.UTC(year, month - 1, 1, 12, 0, 0));
        try {
          return new Intl.DateTimeFormat('en-GB', { timeZone: timeZone || undefined, month: 'long', year: 'numeric' }).format(dt);
        } catch (_) {
          return year + '-' + pad2(month);
        }
      };
      let startSel = pendingCustomRangeStartYmd;
      let endSel = pendingCustomRangeEndYmd;
      if (startSel && endSel && startSel > endSel) {
        const tmp = startSel;
        startSel = endSel;
        endSel = tmp;
      }
      const weekdayLabels = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
      container.innerHTML = months.map((mk) => {
        const y = parseInt(mk.slice(0, 4), 10);
        const m = parseInt(mk.slice(5, 7), 10);
        if (!Number.isFinite(y) || !Number.isFinite(m)) return '';
        const firstOffset = weekdayMon0(y, m, 1, timeZone);
        const dim = daysInMonth(y, m);
        const title = partsToMonthTitle(y, m);
        const weekdayRow = '<div class="date-cal-weekdays">' + weekdayLabels.map((w) => '<div class="date-cal-weekday">' + w + '</div>').join('') + '</div>';
        let cells = '';
        for (let i = 0; i < firstOffset; i++) cells += '<div class="date-cal-spacer"></div>';
        for (let d = 1; d <= dim; d++) {
          const ymd = y + '-' + pad2(m) + '-' + pad2(d);
          if (!ymdSet.has(ymd)) {
            cells += '<div class="date-cal-spacer"></div>';
            continue;
          }
          const has = !!availableByYmd.get(ymd);
          const isStart = startSel && ymd === startSel;
          const isEnd = endSel && ymd === endSel;
          const inRange = startSel && endSel && ymd > startSel && ymd < endSel;
          const isToday = list[0] && String(list[0].date) === ymd;
          const cls = [
            'date-cal-day',
            has ? '' : 'disabled',
            inRange ? 'in-range' : '',
            isStart ? 'range-start' : '',
            isEnd ? 'range-end' : '',
            isToday ? 'today' : '',
          ].filter(Boolean).join(' ');
          const disabledAttr = has ? '' : ' disabled';
          cells += '<button type="button" class="' + cls + '" data-ymd="' + ymd + '"' + disabledAttr + '>' + d + '</button>';
        }
        return '<div class="date-cal-month">' +
          '<div class="date-cal-month-title">' + title + '</div>' +
          weekdayRow +
          '<div class="date-cal-grid">' + cells + '</div>' +
        '</div>';
      }).join('');
    }

    function closeCustomDateModal() {
      const modal = document.getElementById('date-custom-modal');
      if (!modal) return;
      modal.classList.remove('open');
      modal.setAttribute('aria-hidden', 'true');
      pendingCustomRangeStartYmd = null;
      pendingCustomRangeEndYmd = null;
      syncDateSelectOptions();
    }

    function applyDateRangeChange() {
      if (dateRange !== 'live') lastOnlineCount = null;
      countryPage = 1;
      bestGeoProductsPage = 1;
      aovPage = 1;
      bestSellersPage = 1;
      bestVariantsPage = 1;
      worstProductsPage = 1;
      worstVariantsPage = 1;
      currentPage = 1;
      syncDateSelectOptions();
      // Reset caches when range changes.
      bestSellersCache = null;
      bestVariantsCache = null;
      worstProductsCache = null;
      worstVariantsCache = null;
      trafficCache = null;
      lastStatsFetchedAt = 0;
      lastProductsFetchedAt = 0;
      lastTrafficFetchedAt = 0;
      updateNextUpdateUi();

      // Top KPI grid refreshes independently (every minute). On range change, force a refresh immediately.
      refreshKpis({ force: true });

      if (activeMainTab === 'stats') {
        refreshStats({ force: false });
      } else if (activeMainTab === 'traffic') {
        refreshTraffic({ force: false });
      } else if (activeMainTab === 'products') {
        refreshProducts({ force: false });
      } else {
        updateKpis();
        fetchSessions();
      }
    }

    function openCustomDateModal() {
      const modal = document.getElementById('date-custom-modal');
      const cal = document.getElementById('date-custom-calendar');
      if (!modal || !cal) return;
      modal.classList.add('open');
      modal.setAttribute('aria-hidden', 'false');
      const applied = appliedYmdRangeFromDateRange();
      pendingCustomRangeStartYmd = applied && applied.startYmd ? applied.startYmd : null;
      pendingCustomRangeEndYmd = applied && applied.endYmd ? applied.endYmd : null;
      customCalendarLastPayload = null;
      updateCustomDateFooter();
      cal.innerHTML = '<div class="muted">Loading…</div>';
      fetchAvailableDays(30).then((payload) => {
        customCalendarLastPayload = payload;
        renderCustomCalendar(cal, payload);
        updateCustomDateFooter();
      });
    }

    function updateCustomDateFooter() {
      const summaryEl = document.getElementById('date-custom-summary');
      const clearBtn = document.getElementById('date-custom-clear');
      const applyBtn = document.getElementById('date-custom-apply');
      if (!summaryEl) return;
      const a = pendingCustomRangeStartYmd;
      const b = pendingCustomRangeEndYmd;
      if (!a) {
        summaryEl.textContent = 'Select a start date.';
        if (clearBtn) clearBtn.disabled = true;
        if (applyBtn) applyBtn.disabled = true;
        return;
      }
      if (!b) {
        summaryEl.textContent = 'Start: ' + formatYmdLabel(a) + '. Select an end date.';
        if (clearBtn) clearBtn.disabled = false;
        if (applyBtn) applyBtn.disabled = true;
        return;
      }
      const startYmd = a <= b ? a : b;
      const endYmd = a <= b ? b : a;
      summaryEl.textContent = 'Selected: ' + (formatYmdRangeLabel(startYmd, endYmd) || (startYmd + ' – ' + endYmd));
      if (clearBtn) clearBtn.disabled = false;
      if (applyBtn) applyBtn.disabled = false;
    }

    let customDateModalInited = false;
    function initCustomDateModal() {
      if (customDateModalInited) return;
      customDateModalInited = true;
      const modal = document.getElementById('date-custom-modal');
      if (!modal) return;
      const closeBtn = document.getElementById('date-custom-close-btn');
      if (closeBtn) closeBtn.addEventListener('click', function(e) { e.preventDefault(); closeCustomDateModal(); });
      modal.addEventListener('click', function(e) {
        if (e && e.target === modal) closeCustomDateModal();
      });
      document.addEventListener('keydown', function(e) {
        if (!modal.classList.contains('open')) return;
        const key = e && (e.key || e.code) ? String(e.key || e.code) : '';
        if (key === 'Escape') closeCustomDateModal();
      });
      const clearBtn = document.getElementById('date-custom-clear');
      const applyBtn = document.getElementById('date-custom-apply');
      if (clearBtn) {
        clearBtn.addEventListener('click', function(e) {
          e.preventDefault();
          pendingCustomRangeStartYmd = null;
          pendingCustomRangeEndYmd = null;
          const cal = document.getElementById('date-custom-calendar');
          if (cal) renderCustomCalendar(cal, customCalendarLastPayload || availableDaysMemo);
          updateCustomDateFooter();
        });
      }
      if (applyBtn) {
        applyBtn.addEventListener('click', function(e) {
          e.preventDefault();
          const a = pendingCustomRangeStartYmd;
          const b = pendingCustomRangeEndYmd;
          if (!a || !b) return;
          const startYmd = a <= b ? a : b;
          const endYmd = a <= b ? b : a;
          const rk = makeRangeKeyFromYmds(startYmd, endYmd);
          if (!rk) return;
          customRangeStartYmd = startYmd;
          customRangeEndYmd = endYmd;
          dateRange = rk;
          closeCustomDateModal();
          applyDateRangeChange();
        });
      }
      const cal = document.getElementById('date-custom-calendar');
      if (cal) {
        cal.addEventListener('click', function(e) {
          const t = e && e.target ? e.target : null;
          if (!t) return;
          const btn = t.closest ? t.closest('button.date-cal-day') : null;
          if (!btn) return;
          if (btn.disabled) return;
          const ymd = btn.getAttribute('data-ymd') || '';
          if (!ymd) return;
          if (!pendingCustomRangeStartYmd || (pendingCustomRangeStartYmd && pendingCustomRangeEndYmd)) {
            pendingCustomRangeStartYmd = ymd;
            pendingCustomRangeEndYmd = null;
          } else {
            pendingCustomRangeEndYmd = ymd;
          }
          renderCustomCalendar(cal, customCalendarLastPayload || availableDaysMemo);
          updateCustomDateFooter();
        });
      }
    }

    function maybeTriggerSaleToastFromStatsLikeData(data) {
      const conv = data && data.convertedCount ? data.convertedCount : {};
      const haveToday = (typeof conv.today === 'number' && Number.isFinite(conv.today));
      if (!haveToday) return;

      // Reset the converted-count baseline daily (admin TZ).
      try {
        const day = ymdNowInTz();
        if (convertedCountDayYmd == null) convertedCountDayYmd = day;
        if (day && convertedCountDayYmd !== day) {
          convertedCountDayYmd = day;
          hasSeenConvertedCountToday = false;
          lastConvertedCountToday = 0;
        }
      } catch (_) {}

      // Guard against stale/cache drift where counts briefly move backwards (would cause double "sale" sounds).
      if (hasSeenConvertedCountToday && conv.today < lastConvertedCountToday) return;

      const increased = hasSeenConvertedCountToday && conv.today > lastConvertedCountToday;
      if (increased) {
        const kpiUpdate = buildSalesKpiUpdateFromStats(data);
        // If a real-time sale toast is already open (e.g. SSE Live), don't double-trigger audio/toast.
        if (saleToastActive) {
          saleToastPendingKpi = kpiUpdate;
        } else {
          triggerSaleToast({ origin: 'stats', kpiUpdate: kpiUpdate, playSound: true });
        }
        // Pull the authoritative timestamp (truth/evidence) so the footer is accurate.
        try { refreshConfigStatus(); } catch (_) {}
      }
      lastConvertedCountToday = conv.today;
      hasSeenConvertedCountToday = true;
    }

    function setLiveKpisLoading() {
      const spinner = '<span class="kpi-mini-spinner" aria-hidden="true"></span>';
      const ids = ['live-kpi-sales', 'live-kpi-sessions', 'live-kpi-conv', 'live-kpi-returning', 'live-kpi-aov', 'live-kpi-bounce'];
      ids.forEach(function(id) {
        const el = document.getElementById(id);
        if (!el) return;
        if (id === 'live-kpi-sales' && saleToastActive) return; // don't overwrite during toast freeze
        el.innerHTML = spinner;
      });
    }

    function renderStats(data) {
      statsCache = data || {};
      kpiCache = statsCache;
      maybeTriggerSaleToastFromStatsLikeData(statsCache);
      if (statsCache.rangeAvailable) applyRangeAvailable(statsCache.rangeAvailable);
      renderCountry(statsCache);
      renderBestGeoProducts(statsCache);
      renderAov(statsCache);
      renderLiveKpis(getKpiData());
      scheduleBreakdownSync();
    }

    function kpiDelta(current, baseline, invert) {
      const cur = typeof current === 'number' ? current : NaN;
      const base = typeof baseline === 'number' ? baseline : NaN;
      if (!Number.isFinite(cur) || !Number.isFinite(base) || base <= 0) return null;
      const diff = invert ? (base - cur) : (cur - base);
      return diff / base;
    }

    function applyKpiDeltaColor(el, current, baseline, invert) {
      if (!el) return;
      el.style.color = '#444';
      const delta = kpiDelta(current, baseline, invert);
      if (delta == null) return;
      if (delta >= 0.1) el.style.color = '#0d9488';
      else if (delta <= -0.1) el.style.color = '#940d0d';
    }

    // KPI boxes temporarily show N/A: sales/revenue dedupe and pixel-vs-Shopify alignment are not final;
    // numbers were over- or under-reporting. To restore real values: in renderLiveKpis below, remove the
    // "N/A" block and uncomment the "Real values (when fixed)" block so KPIs use data again.
    function renderLiveKpis(data) {
      const salesEl = document.getElementById('live-kpi-sales');
      const sessionsEl = document.getElementById('live-kpi-sessions');
      const convEl = document.getElementById('live-kpi-conv');
      const returningEl = document.getElementById('live-kpi-returning');
      const aovEl = document.getElementById('live-kpi-aov');
      const bounceEl = document.getElementById('live-kpi-bounce');
      const salesLabelEl = document.getElementById('live-kpi-sales-label');
      const sales = data && data.sales ? data.sales : {};
      const convertedCountMap = data && data.convertedCount ? data.convertedCount : {};
      const returningRevenue = data && data.returningRevenue ? data.returningRevenue : {};
      const breakdown = data && data.trafficBreakdown ? data.trafficBreakdown : {};
      const conv = data && data.conversion ? data.conversion : {};
      const aovMap = data && data.aov ? data.aov : {};
      const bounceMap = data && data.bounce ? data.bounce : {};
      const kpiRange = getStatsRange();
      const forRange = breakdown[kpiRange];
      const sessionsVal = forRange != null && typeof forRange.human_sessions === 'number' ? forRange.human_sessions : null;
      const salesVal = typeof sales[kpiRange] === 'number' ? sales[kpiRange] : null;
      const orderCountVal = typeof convertedCountMap[kpiRange] === 'number' ? convertedCountMap[kpiRange] : null;
      const returningVal = typeof returningRevenue[kpiRange] === 'number' ? returningRevenue[kpiRange] : null;
      const convVal = typeof conv[kpiRange] === 'number' ? conv[kpiRange] : null;
      const aovVal = typeof aovMap[kpiRange] === 'number' ? aovMap[kpiRange] : null;
      const bounceVal = typeof bounceMap[kpiRange] === 'number' ? bounceMap[kpiRange] : null;
      const compare = data && data.compare ? data.compare : null;
      const compareBreakdown = compare && compare.trafficBreakdown ? compare.trafficBreakdown : null;
      const compareSessionsVal = compareBreakdown && typeof compareBreakdown.human_sessions === 'number' ? compareBreakdown.human_sessions : null;
      const compareSalesVal = compare && typeof compare.sales === 'number' ? compare.sales : null;
      const compareReturningVal = compare && typeof compare.returningRevenue === 'number' ? compare.returningRevenue : null;
      const compareConvVal = compare && typeof compare.conversion === 'number' ? compare.conversion : null;
      const compareAovVal = compare && typeof compare.aov === 'number' ? compare.aov : null;
      const compareBounceVal = compare && typeof compare.bounce === 'number' ? compare.bounce : null;

      const freezeSales = !!saleToastActive;
      if (salesLabelEl && !freezeSales) {
        salesLabelEl.textContent = orderCountVal != null ? (orderCountVal + ' Orders') : 'Orders';
        salesLabelEl.title = '';
      }
      if (salesEl && !freezeSales) salesEl.textContent = salesVal != null ? formatRevenue(salesVal) : '\u2014';
      if (sessionsEl) sessionsEl.textContent = sessionsVal != null ? formatSessions(sessionsVal) : '\u2014';
      if (convEl) convEl.textContent = convVal != null ? pct(convVal) : '\u2014';
      if (returningEl) returningEl.textContent = returningVal != null ? formatRevenue(returningVal) : '\u2014';
      if (aovEl) aovEl.textContent = aovVal != null ? formatRevenue(aovVal) : '\u2014';
      if (bounceEl) bounceEl.textContent = bounceVal != null ? pct(bounceVal) : '\u2014';

      if (!freezeSales) applyKpiDeltaColor(salesEl, salesVal, compareSalesVal, false);
      applyKpiDeltaColor(sessionsEl, sessionsVal, compareSessionsVal, false);
      applyKpiDeltaColor(convEl, convVal, compareConvVal, false);
      applyKpiDeltaColor(returningEl, returningVal, compareReturningVal, false);
      applyKpiDeltaColor(aovEl, aovVal, compareAovVal, false);
      applyKpiDeltaColor(bounceEl, bounceVal, compareBounceVal, true);
      scheduleKpiPagerUpdate();
    }

    // KPI pager: swipe on mobile, page on desktop when labels wrap.
    let kpiPagerPage = 0;
    let kpiPagerRaf = null;
    function scheduleKpiPagerUpdate() {
      if (typeof requestAnimationFrame !== 'function') {
        applyKpiPager();
        return;
      }
      if (kpiPagerRaf) cancelAnimationFrame(kpiPagerRaf);
      kpiPagerRaf = requestAnimationFrame(function() {
        kpiPagerRaf = null;
        applyKpiPager();
      });
    }
    function kpiLabelWraps(el) {
      if (!el) return false;
      const rect = el.getBoundingClientRect();
      const style = window.getComputedStyle ? window.getComputedStyle(el) : null;
      const lh = style ? parseFloat(style.lineHeight) : 0;
      const fs = style ? parseFloat(style.fontSize) : 0;
      const lineHeight = (Number.isFinite(lh) && lh > 0) ? lh : (Number.isFinite(fs) && fs > 0 ? fs * 1.2 : 0);
      if (!lineHeight) return false;
      return rect.height > lineHeight * 1.4;
    }
    function applyKpiPager() {
      const grid = document.getElementById('live-kpi-grid');
      const btn = document.getElementById('kpi-mobile-next');
      const wrap = document.querySelector('.kpi-mobile-pager');
      if (!grid || !btn) return;
      const isMobile = !!(window.matchMedia && window.matchMedia('(max-width: 768px)').matches);
      const cells = Array.from(grid.querySelectorAll('.live-kpi-cell'));
      if (isMobile) {
        cells.forEach(function(c) { c.style.display = ''; c.removeAttribute('aria-hidden'); });
        btn.style.display = 'none';
        btn.disabled = true;
        if (wrap) wrap.classList.remove('kpi-pager-active');
        return;
      }
      const labels = Array.from(grid.querySelectorAll('.live-kpi-label'));
      const needsPager = labels.some(kpiLabelWraps);
      if (!needsPager) {
        cells.forEach(function(c) { c.style.display = ''; c.removeAttribute('aria-hidden'); });
        btn.style.display = 'none';
        btn.disabled = true;
        if (wrap) wrap.classList.remove('kpi-pager-active');
        return;
      }
      const perPage = Math.max(1, Math.min(4, cells.length));
      const totalPages = Math.max(1, Math.ceil(cells.length / perPage));
      if (kpiPagerPage >= totalPages) kpiPagerPage = 0;
      const start = kpiPagerPage * perPage;
      const end = start + perPage;
      cells.forEach(function(c, idx) {
        const show = idx >= start && idx < end;
        c.style.display = show ? '' : 'none';
        c.setAttribute('aria-hidden', show ? 'false' : 'true');
      });
      const showBtn = totalPages > 1;
      btn.style.display = showBtn ? 'inline-flex' : 'none';
      btn.disabled = !showBtn;
      btn.setAttribute('aria-label', showBtn ? ('Next KPIs (page ' + (kpiPagerPage + 1) + ' of ' + totalPages + ')') : 'KPIs');
      if (wrap) {
        if (showBtn) wrap.classList.add('kpi-pager-active');
        else wrap.classList.remove('kpi-pager-active');
      }
    }
    (function initKpiPager() {
      const btn = document.getElementById('kpi-mobile-next');
      if (btn) {
        btn.addEventListener('click', function() {
          kpiPagerPage = kpiPagerPage + 1;
          applyKpiPager();
        });
      }
      scheduleKpiPagerUpdate();
      window.addEventListener('resize', function() { scheduleKpiPagerUpdate(); scheduleBreakdownSync(); });
    })();

    function delay(ms) {
      const n = Number(ms) || 0;
      if (n <= 0) return Promise.resolve();
      return new Promise(function(resolve) { setTimeout(resolve, n); });
    }

    function fetchWithTimeout(url, options, timeoutMs) {
      const ms = Number(timeoutMs) || 0;
      const timeout = ms > 0 ? ms : 25000;
      if (typeof AbortController === 'undefined') {
        return Promise.race([
          fetch(url, options),
          new Promise(function(_, reject) {
            setTimeout(function() { reject(new Error('Request timed out')); }, timeout);
          }),
        ]);
      }
      const controller = new AbortController();
      const timer = setTimeout(function() { try { controller.abort(); } catch (_) {} }, timeout);
      const opts = Object.assign({}, options || {}, { signal: controller.signal });
      return fetch(url, opts).finally(function() { clearTimeout(timer); });
    }

    function startReportBuild(opts) {
      opts = opts && typeof opts === 'object' ? opts : {};
      const key = opts.key ? String(opts.key) : '';
      if (!key || !reportBuildTokens || typeof reportBuildTokens[key] !== 'number') {
        return { step: function() {}, finish: function() {} };
      }

      reportBuildTokens[key] = (reportBuildTokens[key] || 0) + 1;
      const token = reportBuildTokens[key];
      const overlayId = opts.overlayId ? String(opts.overlayId) : '';
      const stepId = opts.stepId ? String(opts.stepId) : '';
      const overlay = overlayId ? document.getElementById(overlayId) : null;
      const wrap = overlay ? overlay.parentElement : null;
      const stepEl = stepId ? document.getElementById(stepId) : null;

      if (wrap) wrap.classList.add('report-building');
      if (overlay) overlay.style.display = 'flex';
      if (stepEl) stepEl.textContent = '';

      function step(text) {
        if (reportBuildTokens[key] !== token) return;
        if (!stepEl) return;
        stepEl.textContent = text != null ? String(text) : '';
      }

      function finish() {
        if (reportBuildTokens[key] !== token) return;
        if (overlay) overlay.style.display = 'none';
        if (wrap) wrap.classList.remove('report-building');
      }

      return { step: step, finish: finish };
    }

    function fetchStatsData(options = {}) {
      const force = !!options.force;
      let url = API + '/api/stats?range=' + encodeURIComponent(getStatsRange());
      if (force) url += (url.indexOf('?') >= 0 ? '&' : '?') + '_=' + Date.now();
      const cacheMode = force ? 'no-store' : 'default';
      return fetchWithTimeout(url, { credentials: 'same-origin', cache: cacheMode }, 30000)
        .then(function(r) {
          if (!r.ok) throw new Error('Stats HTTP ' + r.status);
          return r.json();
        })
        .then(function(data) {
          lastStatsFetchedAt = Date.now();
          lastUpdateTime = new Date();
          updateServerTimeDisplay();
          renderStats(data && typeof data.country === 'object' ? data : {});
          return data;
        })
        .catch(function(err) {
          console.error(err);
          renderStats(statsCache || {});
          return null;
        });
    }

    const KPI_REFRESH_MS = 60000;
    const KPI_SPINNER_MIN_MS = 800;
    let kpisSpinnerShownOnce = false;

    function fetchKpisData(options = {}) {
      const force = !!options.force;
      let url = API + '/api/kpis?range=' + encodeURIComponent(getStatsRange());
      if (force) url += (url.indexOf('?') >= 0 ? '&' : '?') + 'force=1';
      return fetchWithTimeout(url, { credentials: 'same-origin', cache: 'no-store' }, 25000)
        .then(function(r) {
          if (!r.ok) throw new Error('KPIs HTTP ' + r.status);
          return r.json();
        });
    }

    function refreshKpis(options = {}) {
      const force = !!options.force;
      if (kpisRefreshInFlight) return kpisRefreshInFlight;

      // Only show the KPI mini spinners on the very first load (avoid visual noise on minute refreshes).
      const showSpinner = !kpisSpinnerShownOnce;
      if (showSpinner) {
        kpisSpinnerShownOnce = true;
        setLiveKpisLoading();
      }

      const fetchP = fetchKpisData({ force });
      kpisRefreshInFlight = (showSpinner ? Promise.all([fetchP, delay(KPI_SPINNER_MIN_MS)]) : fetchP)
        .then(function(partsOrData) {
          const data = showSpinner
            ? (partsOrData && partsOrData[0] && typeof partsOrData[0] === 'object' ? partsOrData[0] : null)
            : (partsOrData && typeof partsOrData === 'object' ? partsOrData : null);
          lastKpisFetchedAt = Date.now();
          if (data) {
            kpiCache = data;
            maybeTriggerSaleToastFromStatsLikeData(kpiCache);
          }
          renderLiveKpis(getKpiData());
          return data;
        })
        .catch(function(err) {
          console.error(err);
          renderLiveKpis(getKpiData());
          return null;
        })
        .finally(function() {
          kpisRefreshInFlight = null;
        });
      return kpisRefreshInFlight;
    }

    function refreshStats(options = {}) {
      const force = !!options.force;
      if (statsRefreshInFlight) return statsRefreshInFlight;

      const build = startReportBuild({ key: 'stats', overlayId: 'stats-loading-overlay', stepId: 'stats-build-step' });
      build.step('building countries...');
      statsRefreshInFlight = fetchStatsData({ force })
        .then(function(data) {
          build.step('building countries... done');
          return delay(180).then(function() {
            build.step('building average order...');
            return delay(120).then(function() {
              build.step('building average order... done');
              return delay(180).then(function() { return data; });
            });
          });
        })
        .finally(function() {
          statsRefreshInFlight = null;
          build.finish();
        });
      return statsRefreshInFlight;
    }

    function refreshProducts(options = {}) {
      const force = !!options.force;
      if (productsRefreshInFlight) return productsRefreshInFlight;

      const build = startReportBuild({ key: 'products', overlayId: 'products-loading-overlay', stepId: 'products-build-step' });
      const bestP = fetchBestSellers({ force });
      const worstP = fetchWorstProducts({ force });
      const variantsP = fetchBestVariants({ force });
      const worstVariantsP = fetchWorstVariants({ force });
      function settled(p) {
        return Promise.resolve(p)
          .then(function(v) { return { ok: true, value: v }; })
          .catch(function(err) { console.error(err); return { ok: false, error: err }; });
      }
      const bestS = settled(bestP);
      const worstS = settled(worstP);
      const variantsS = settled(variantsP);
      const worstVariantsS = settled(worstVariantsP);

      productsRefreshInFlight = Promise.resolve()
        .then(function() { build.step('building best products...'); return bestS; })
        .then(function() { build.step('building best products... done'); return delay(180); })
        .then(function() { build.step('building worst products...'); return worstS; })
        .then(function() { build.step('building worst products... done'); return delay(180); })
        .then(function() { build.step('building best variants...'); return variantsS; })
        .then(function() { build.step('building best variants... done'); return delay(180); })
        .then(function() { build.step('building worst variants...'); return worstVariantsS; })
        .then(function() { build.step('building worst variants... done'); return delay(180); })
        .then(function() { lastProductsFetchedAt = Date.now(); })
        .finally(function() {
          productsRefreshInFlight = null;
          build.finish();
        });
      return productsRefreshInFlight;
    }

    function renderTrafficTables(data) {
      const sources = data && data.sources ? data.sources : null;
      const types = data && data.types ? data.types : null;
      const srcBy = (tableSortState.trafficSources.by || 'rev').toString().trim().toLowerCase();
      const srcDir = (tableSortState.trafficSources.dir || 'desc').toString().trim().toLowerCase() === 'asc' ? 'asc' : 'desc';
      const typeBy = (tableSortState.trafficTypes.by || 'rev').toString().trim().toLowerCase();
      const typeDir = (tableSortState.trafficTypes.dir || 'desc').toString().trim().toLowerCase() === 'asc' ? 'asc' : 'desc';

      function trafficSourceIconHtml(keyRaw, labelRaw) {
        function icon(src, alt, title, extraClass) {
          const cls = (extraClass ? (extraClass + ' ') : '') + 'source-icon-img';
          const t = title ? ' title="' + escapeHtml(String(title)) + '"' : '';
          return '<img src="' + escapeHtml(hotImg(src) || src || '') + '" alt="' + escapeHtml(alt || '') + '" class="' + cls + '" width="20" height="20"' + t + '>';
        }
        const key = keyRaw != null ? String(keyRaw).trim().toLowerCase() : '';
        const label = labelRaw != null ? String(labelRaw).trim() : '';
        if (!key) return escapeHtml(label || '—');
        const resolvedLabel = trafficSourceLabelForKey(key, label || key);
        const customIcon = trafficSourceIconUrlForKey(key);
        const src = customIcon || trafficSourceBuiltInIconSrc(key) || SOURCE_UNKNOWN_IMG;
        const extra = key === 'google_ads' ? 'source-googleads-img' : '';
        return '<span class="source-icons">' + icon(src, resolvedLabel, resolvedLabel, extra) + '</span>';
      }

      function renderRows(bodyId, rows, emptyText) {
        const body = document.getElementById(bodyId);
        if (!body) return;
        const list = Array.isArray(rows) ? rows.slice() : [];
        function sourceLabel(r) {
          const key = (r && r.key != null) ? String(r.key).trim().toLowerCase() : '';
          const labelText = (r && r.label) ? String(r.label) : (key || '—');
          return labelText;
        }
        list.sort(function(a, b) {
          var primary = 0;
          if (srcBy === 'source') primary = cmpNullableText(sourceLabel(a), sourceLabel(b), srcDir);
          else if (srcBy === 'cr') primary = cmpNullableNumber(a && a.conversionPct, b && b.conversionPct, srcDir);
          else if (srcBy === 'orders') primary = cmpNullableNumber(a && a.orders, b && b.orders, srcDir);
          else if (srcBy === 'sessions') primary = cmpNullableNumber(a && a.sessions, b && b.sessions, srcDir);
          else if (srcBy === 'rev') primary = cmpNullableNumber(a && a.revenueGbp, b && b.revenueGbp, srcDir);
          return primary ||
            cmpNullableNumber(a && a.revenueGbp, b && b.revenueGbp, 'desc') ||
            cmpNullableNumber(a && a.orders, b && b.orders, 'desc') ||
            cmpNullableNumber(a && a.sessions, b && b.sessions, 'desc') ||
            cmpNullableText(sourceLabel(a), sourceLabel(b), 'asc');
        });
        if (!list.length) {
          body.innerHTML = '<tr><td colspan="5" class="empty">' + escapeHtml(emptyText || '—') + '</td></tr>';
          return;
        }
        let html = '';
        list.forEach(function(r) {
          const key = (r && r.key != null) ? String(r.key).trim().toLowerCase() : '';
          const labelText = (r && r.label) ? String(r.label) : (key || '—');
          const labelCell = trafficSourceIconHtml(key, labelText);
          const cr = (r && typeof r.conversionPct === 'number') ? pct(r.conversionPct) : '—';
          const orders = (r && typeof r.orders === 'number') ? formatSessions(r.orders) : '—';
          const sessions = (r && typeof r.sessions === 'number') ? formatSessions(r.sessions) : '—';
          const rev = (r && typeof r.revenueGbp === 'number') ? formatRevenueTableHtml(r.revenueGbp) : '—';
          html += '<tr>' +
            '<td>' + labelCell + '</td>' +
            '<td>' + escapeHtml(cr || '—') + '</td>' +
            '<td>' + escapeHtml(orders || '—') + '</td>' +
            '<td>' + escapeHtml(sessions || '—') + '</td>' +
            '<td>' + (rev || '—') + '</td>' +
            '</tr>';
        });
        body.innerHTML = html;
      }

      renderRows('traffic-sources-body', sources ? sources.rows : [], 'Click the settings icon to add sources.');
      (function renderTypeTree() {
        const body = document.getElementById('traffic-types-body');
        if (!body) return;
        const groups = types && Array.isArray(types.rows) ? types.rows.slice() : [];
        if (!groups.length) {
          body.innerHTML = '<tr><td colspan="5" class="empty">' + escapeHtml('Click the settings icon to choose devices.') + '</td></tr>';
          return;
        }
        function typeLabel(r) {
          if (!r) return '—';
          if (r.label != null && String(r.label).trim() !== '') return String(r.label);
          if (r.platform != null && String(r.platform).trim() !== '') return String(r.platform);
          if (r.key != null && String(r.key).trim() !== '') return String(r.key);
          return '—';
        }
        groups.sort(function(a, b) {
          var primary = 0;
          if (typeBy === 'type') primary = cmpNullableText(typeLabel(a), typeLabel(b), typeDir);
          else if (typeBy === 'cr') primary = cmpNullableNumber(a && a.conversionPct, b && b.conversionPct, typeDir);
          else if (typeBy === 'orders') primary = cmpNullableNumber(a && a.orders, b && b.orders, typeDir);
          else if (typeBy === 'sessions') primary = cmpNullableNumber(a && a.sessions, b && b.sessions, typeDir);
          else if (typeBy === 'rev') primary = cmpNullableNumber(a && a.revenueGbp, b && b.revenueGbp, typeDir);
          return primary ||
            cmpNullableNumber(a && a.revenueGbp, b && b.revenueGbp, 'desc') ||
            cmpNullableNumber(a && a.orders, b && b.orders, 'desc') ||
            cmpNullableNumber(a && a.sessions, b && b.sessions, 'desc') ||
            cmpNullableText(typeLabel(a), typeLabel(b), 'asc');
        });

        let html = '';
        groups.forEach(function(g) {
          const device = (g && g.device != null) ? String(g.device).trim().toLowerCase() : '';
          const open = !!(device && trafficTypeExpanded && trafficTypeExpanded[device]);
          const label = escapeHtml((g && g.label) ? String(g.label) : (g && g.key ? String(g.key) : '—'));
          const cr = (g && typeof g.conversionPct === 'number') ? pct(g.conversionPct) : '—';
          const orders = (g && typeof g.orders === 'number') ? formatSessions(g.orders) : '—';
          const sessions = (g && typeof g.sessions === 'number') ? formatSessions(g.sessions) : '—';
          const rev = (g && typeof g.revenueGbp === 'number') ? formatRevenueTableHtml(g.revenueGbp) : '—';
          html += '<tr class="traffic-type-parent" data-device="' + escapeHtml(device) + '">' +
            '<td>' +
              '<button type="button" class="traffic-type-toggle" data-device="' + escapeHtml(device) + '" aria-expanded="' + (open ? 'true' : 'false') + '">' +
                '<span class="chev" aria-hidden="true"></span>' +
                '<span>' + label + '</span>' +
              '</button>' +
            '</td>' +
            '<td>' + escapeHtml(cr || '—') + '</td>' +
            '<td>' + escapeHtml(orders || '—') + '</td>' +
            '<td>' + escapeHtml(sessions || '—') + '</td>' +
            '<td>' + (rev || '—') + '</td>' +
          '</tr>';

          const kids = (g && Array.isArray(g.children)) ? g.children.slice() : [];
          kids.sort(function(a, b) {
            var primary = 0;
            if (typeBy === 'type') primary = cmpNullableText(typeLabel(a), typeLabel(b), typeDir);
            else if (typeBy === 'cr') primary = cmpNullableNumber(a && a.conversionPct, b && b.conversionPct, typeDir);
            else if (typeBy === 'orders') primary = cmpNullableNumber(a && a.orders, b && b.orders, typeDir);
            else if (typeBy === 'sessions') primary = cmpNullableNumber(a && a.sessions, b && b.sessions, typeDir);
            else if (typeBy === 'rev') primary = cmpNullableNumber(a && a.revenueGbp, b && b.revenueGbp, typeDir);
            return primary ||
              cmpNullableNumber(a && a.revenueGbp, b && b.revenueGbp, 'desc') ||
              cmpNullableNumber(a && a.orders, b && b.orders, 'desc') ||
              cmpNullableNumber(a && a.sessions, b && b.sessions, 'desc') ||
              cmpNullableText(typeLabel(a), typeLabel(b), 'asc');
          });
          kids.forEach(function(c) {
            const clabel = escapeHtml((c && c.label) ? String(c.label) : (c && c.platform ? String(c.platform) : (c && c.key ? String(c.key) : '—')));
            const ccr = (c && typeof c.conversionPct === 'number') ? pct(c.conversionPct) : '—';
            const corders = (c && typeof c.orders === 'number') ? formatSessions(c.orders) : '—';
            const csessions = (c && typeof c.sessions === 'number') ? formatSessions(c.sessions) : '—';
            const crev = (c && typeof c.revenueGbp === 'number') ? formatRevenueTableHtml(c.revenueGbp) : '—';
            html += '<tr class="traffic-type-child" data-parent="' + escapeHtml(device) + '"' + (open ? '' : ' style="display:none"') + '>' +
              '<td>' + clabel + '</td>' +
              '<td>' + escapeHtml(ccr || '—') + '</td>' +
              '<td>' + escapeHtml(corders || '—') + '</td>' +
              '<td>' + escapeHtml(csessions || '—') + '</td>' +
              '<td>' + (crev || '—') + '</td>' +
            '</tr>';
          });
        });
        body.innerHTML = html;
      })();

      updateSortHeadersInContainer(document.getElementById('traffic-sources-table'), srcBy, srcDir);
      updateSortHeadersInContainer(document.getElementById('traffic-types-table'), typeBy, typeDir);
    }

    function renderTrafficPickers(data) {
      function renderPicker(containerId, available, enabled, onChange) {
        const el = document.getElementById(containerId);
        if (!el) return;
        const have = new Set((enabled || []).map(function(k) { return String(k || '').trim().toLowerCase(); }).filter(Boolean));
        const list = Array.isArray(available) ? available.slice() : [];
        if (!list.length) {
          el.innerHTML = '<div class="config-row muted">No items yet.</div>';
          return;
        }
        let html = '';
        list.forEach(function(item) {
          const key = item && item.key != null ? String(item.key).trim().toLowerCase() : '';
          if (!key) return;
          const label = escapeHtml(item.label != null ? String(item.label) : key);
          const checked = have.has(key);
          const meta = (item && typeof item.sessions === 'number') ? (formatSessions(item.sessions) + ' sessions') : '';
          html += '<label class="traffic-picker-item">' +
            '<input type="checkbox" data-key="' + key + '"' + (checked ? ' checked' : '') + ' />' +
            '<span>' + label + '</span>' +
            (meta ? ('<span class="traffic-picker-meta">' + escapeHtml(meta) + '</span>') : '') +
            '</label>';
        });
        el.innerHTML = html;
        el.onchange = function(e) {
          const t = e && e.target ? e.target : null;
          if (!t || t.tagName !== 'INPUT') return;
          const keys = Array.from(el.querySelectorAll('input[type="checkbox"][data-key]:checked'))
            .map(function(inp) { return (inp.getAttribute('data-key') || '').trim(); })
            .filter(Boolean);
          onChange(keys);
        };
      }

      renderPicker(
        'traffic-sources-picker',
        data && data.sources ? data.sources.available : [],
        data && data.sources ? data.sources.enabled : [],
        function(keys) { saveTrafficPrefs({ sourcesEnabled: keys }); }
      );
      renderPicker(
        'traffic-types-picker',
        data && data.types ? data.types.available : [],
        data && data.types ? data.types.enabled : [],
        function(keys) { saveTrafficPrefs({ typesEnabled: keys }); }
      );
    }

    function renderTraffic(data) {
      trafficCache = data || trafficCache || null;
      renderTrafficTables(trafficCache);
      renderTrafficPickers(trafficCache);
    }

    function fetchTrafficData(options = {}) {
      const force = !!options.force;
      let url = API + '/api/traffic?range=' + encodeURIComponent(getStatsRange());
      if (force) url += (url.indexOf('?') >= 0 ? '&' : '?') + '_=' + Date.now();
      const cacheMode = force ? 'no-store' : 'default';
      return fetchWithTimeout(url, { credentials: 'same-origin', cache: cacheMode }, 25000)
        .then(function(r) {
          if (!r.ok) throw new Error('Traffic HTTP ' + r.status);
          return r.json();
        })
        .then(function(data) {
          lastTrafficFetchedAt = Date.now();
          renderTraffic(data && typeof data === 'object' ? data : null);
          return data;
        })
        .catch(function(err) {
          console.error(err);
          renderTraffic(trafficCache || null);
          return null;
        });
    }

    function refreshTraffic(options = {}) {
      const force = !!options.force;
      if (trafficRefreshInFlight) return trafficRefreshInFlight;

      const build = startReportBuild({ key: 'traffic', overlayId: 'traffic-loading-overlay', stepId: 'traffic-build-step' });
      build.step('building channels...');
      trafficRefreshInFlight = fetchTrafficData({ force })
        .then(function(data) {
          build.step('building channels... done');
          return delay(180).then(function() {
            build.step('building traffic...');
            return delay(120).then(function() {
              build.step('building traffic... done');
              return delay(180).then(function() { return data; });
            });
          });
        })
        .finally(function() {
          trafficRefreshInFlight = null;
          build.finish();
        });
      return trafficRefreshInFlight;
    }

    function saveTrafficPrefs(payload) {
      if (!payload || typeof payload !== 'object') return Promise.resolve(null);
      return fetch(API + '/api/traffic-prefs', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'same-origin',
        cache: 'no-store',
        body: JSON.stringify(payload),
      })
        .then(function(r) { return r.ok ? r.json() : null; })
        .then(function(json) {
          if (!json || json.ok !== true) return null;
          // Re-fetch so tables match new enabled selections.
          refreshTraffic({ force: true });
          return json;
        })
        .catch(function(err) { console.error(err); return null; });
    }

    function sessionIdsEqual(a, b) {
      if (!a && !b) return true;
      if (!a || !b || a.length !== b.length) return false;
      for (var i = 0; i < a.length; i++) if (a[i].session_id !== b[i].session_id) return false;
      return true;
    }

    function fetchSessions() {
      if (liveRefreshInFlight) return liveRefreshInFlight;
      var overlay = document.getElementById('sessions-loading-overlay');
      if (overlay) overlay.style.display = 'flex';
      var isLive = dateRange === 'live';
      var url;
      if (isLive) {
        url = API + '/api/sessions?filter=active&_=' + Date.now();
      } else {
        var limit = rowsPerPage;
        var offset = (currentPage - 1) * rowsPerPage;
        url = API + '/api/sessions?range=' + encodeURIComponent(dateRange) + '&limit=' + limit + '&offset=' + offset + '&timezone=' + encodeURIComponent(tz) + '&_=' + Date.now();
      }
      liveRefreshInFlight = fetch(url, { credentials: 'same-origin', cache: 'no-store' })
        .then(function(r) {
          if (!r.ok) {
            sessionsLoadError = r.status === 502 ? 'Server error (502). Try again or refresh.' : 'Server error (' + r.status + ').';
            sessions = [];
            sessionsTotal = null;
            renderTable();
            return null;
          }
          return r.json();
        })
        .then(function(data) {
          if (data == null) return null;
          sessionsLoadError = null;
          if (isLive) {
            sessionsTotal = null;
            var next = data.sessions || [];
            var cutoff = Date.now() - ACTIVE_WINDOW_MS;
            var arrivedCutoff = Date.now() - ARRIVED_WINDOW_MS;
            next = next.filter(function(s) {
              return (s.last_seen != null && s.last_seen >= cutoff) &&
                (s.started_at != null && s.started_at >= arrivedCutoff);
            });
            next.sort(function(a, b) { return (b.last_seen || 0) - (a.last_seen || 0); });
            var listChanged = !sessionIdsEqual(sessions, next);
            sessions = next;
            if (listChanged) currentPage = 1;
          } else {
            sessions = data.sessions || [];
            sessionsTotal = typeof data.total === 'number' ? data.total : sessions.length;
          }
          lastSessionsMode = isLive ? 'live' : 'range';
          lastSessionsFetchedAt = Date.now();
          if (isLive) nextLiveAt = Date.now() + LIVE_REFRESH_MS;
          else if (dateRange === 'today' || dateRange === '1h') nextRangeAt = Date.now() + RANGE_REFRESH_MS;
          lastUpdateTime = new Date();
          updateServerTimeDisplay();
          renderTable();
          updateKpis();
          return sessions;
        })
        .catch(function() { sessionsLoadError = 'Could not load sessions. Check connection or refresh.'; sessions = []; sessionsTotal = null; currentPage = 1; renderTable(); return null; })
        .finally(function() {
          liveRefreshInFlight = null;
          if (overlay) overlay.style.display = 'none';
        });
      return liveRefreshInFlight;
    }

    function fetchOnlineCount() {
      if (onlineCountInFlight) return;
      onlineCountInFlight = true;
      fetch(API + '/api/sessions?filter=active&countOnly=1&_=' + Date.now(), { credentials: 'same-origin', cache: 'no-store' })
        .then(function(r) { return r.ok ? r.json() : null; })
        .then(function(data) {
          if (data != null && typeof data.count === 'number') {
            lastOnlineCount = data.count;
          }
        })
        .catch(function() {})
        .then(function() {
          onlineCountInFlight = false;
          updateKpis();
        });
    }

    function updateKpis() {
      const el = document.getElementById('online-count');
      const spinner = document.getElementById('online-count-spinner');
      if (!el) return;
      function showSpinner() {
        if (spinner) spinner.style.display = '';
        el.style.display = 'none';
      }
      function showCount(n) {
        if (spinner) spinner.style.display = 'none';
        el.style.display = '';
        el.textContent = String(n);
      }
      if (dateRange === 'live') {
        if (lastSessionsMode !== 'live') {
          showSpinner();
          fetchSessions();
          return;
        }
        const active = sessions.filter(s => s.last_seen >= Date.now() - ACTIVE_WINDOW_MS).length;
        showCount(active);
        return;
      }
      // Online is real people online right now; show count regardless of date range (Today, Yesterday, etc.)
      if (lastOnlineCount != null) {
        showCount(lastOnlineCount);
      } else {
        showSpinner();
        fetchOnlineCount();
      }
    }

    function cfSection(title, value) {
      const v = value != null && String(value).trim() !== '' ? String(value).trim() : null;
      const cls = v ? 'cf-row' : 'cf-row empty';
      return '<div class="' + cls + '"><strong>' + escapeHtml(title) + ':</strong> ' + (v ? escapeHtml(v) : '\u2014') + '</div>';
    }

    function buildSidePanelCf(session) {
      const s = session || {};
      const blocks = [
        ['Country & Device', cfSection('Country', s.cf_country || s.country_code) + cfSection('Device', s.device)],
        ['Referrer / Entry', cfSection('Referrer', s.referrer) + cfSection('Entry URL', s.entry_url)],
        ['Colo / ASN', cfSection('Colo', s.cf_colo) + cfSection('ASN', s.cf_asn)],
        ['Bot', cfSection('Known bot', s.cf_known_bot != null ? (s.cf_known_bot === 1 ? 'Yes' : 'No') : null) + cfSection('Verified bot category', s.cf_verified_bot_category)],
        ['City', cfSection('City', null)]
      ];
      return blocks.map(function (b) { return '<div class="side-panel-cf-block"><div class="side-panel-cf-subtitle">' + escapeHtml(b[0]) + '</div>' + b[1] + '</div>'; }).join('');
    }

    function openSidePanel(sessionId) {
      const panel = document.getElementById('side-panel');
      panel.style.display = 'block';
      document.getElementById('side-events').innerHTML = '<li class="muted">Loading\u2026</li>';
      document.getElementById('side-meta').innerHTML = '<div class="side-panel-detail-row"><span class="side-panel-value muted">Loading\u2026</span></div>';
      const sideSourceEl = document.getElementById('side-source');
      if (sideSourceEl) sideSourceEl.textContent = '';
      document.getElementById('side-cf').innerHTML = '';
      fetch(API + '/api/sessions/' + encodeURIComponent(sessionId) + '/events?limit=20')
        .then(r => r.json())
        .then(data => {
          const session = sessions.find(s => s.session_id === sessionId) || {};
          const saleBlock = session.has_purchased
            ? '<div class="side-panel-sale"><strong>Sale</strong><br>Order: ' + escapeHtml(formatMoney(session.order_total, session.order_currency) || '\u2014') + (session.purchased_at ? '<br>Purchased: ' + formatTs(session.purchased_at) : '') + '</div>'
            : '';
          const mainBase = getMainBaseUrl();
          const eventList = (data.events || []).filter(e => e.type !== 'heartbeat').reverse();
          const eventsHtml = eventList.map(e => {
            var path = (e.path || '').trim();
            if (!path && e.product_handle) path = '/products/' + (e.product_handle || '');
            if (path && !path.startsWith('/')) path = '/' + path;
            var pathLabel = path ? (friendlyLabelFromPath(path) || path) : (e.product_handle || '');
            var fullUrl = mainBase && path ? mainBase + path : '';
            var thumb = fullUrl ? '<img class="landing-thumb" src="' + (API || '') + '/api/og-thumb?url=' + encodeURIComponent(fullUrl) + '&width=100' + '" alt="" onerror="this.style.display=\'none\'">' : '';
            var text = formatTs(e.ts) + ' ' + escapeHtml(e.type) + ' ' + escapeHtml(pathLabel) + (e.qty_delta != null ? ' \u0394' + e.qty_delta : '');
            return '<li>' + thumb + '<span>' + text + '</span></li>';
          }).join('');
          document.getElementById('side-events').innerHTML = eventsHtml || '<li class="muted">No events</li>';
          const metaRows = [
            ['Session', sessionId],
            ['Visitor', session.visitor_id || '\u2014'],
            ['Started', formatTs(session.started_at)],
            ['Seen', formatTs(session.last_seen)],
            ['Cart qty', String(session.cart_qty ?? 0)]
          ].map(function (r) { return '<div class="side-panel-detail-row"><span class="side-panel-label">' + escapeHtml(r[0]) + '</span><span class="side-panel-value">' + escapeHtml(String(r[1])) + '</span></div>'; }).join('');
          var startedMs = session.started_at != null ? Number(session.started_at) : 0;
          var seenMs = session.last_seen != null ? Number(session.last_seen) : 0;
          var gapHours = (seenMs - startedMs) / (60 * 60 * 1000);
          var openTabHint = (gapHours >= 1) ? '<div class="side-panel-detail-row muted" style="margin-top:0.5rem;font-size:0.8em">If Started and Seen are many hours apart, the visitor likely left the tab open; we receive a heartbeat every 30s which updates Seen.</div>' : '';
          document.getElementById('side-meta').innerHTML = metaRows + openTabHint + (saleBlock ? saleBlock : '');
          if (sideSourceEl) sideSourceEl.textContent = sourceDetailForPanel(session);
          document.getElementById('side-cf').innerHTML = buildSidePanelCf(session);
        })
        .catch(() => {
          document.getElementById('side-events').innerHTML = '<li class="muted">Failed to load.</li>';
          document.getElementById('side-meta').innerHTML = '<div class="side-panel-detail-row"><span class="side-panel-value muted">Failed to load.</span></div>';
        });
    }

    document.getElementById('side-close').addEventListener('click', () => {
      document.getElementById('side-panel').style.display = 'none';
    });

    document.getElementById('pagination-prev').addEventListener('click', function() {
      if (currentPage <= 1) return;
      currentPage--;
      if (sessionsTotal != null) fetchSessions(); else renderTable();
    });
    document.getElementById('pagination-next').addEventListener('click', function() {
      const totalPages = sessionsTotal != null
        ? Math.max(1, Math.ceil(sessionsTotal / rowsPerPage))
        : Math.max(1, Math.ceil(getSortedSessions().length / rowsPerPage));
      if (currentPage >= totalPages) return;
      currentPage++;
      if (sessionsTotal != null) fetchSessions(); else renderTable();
    });

    setupSortableHeaders();
    setupBestSellersSort();
    setupAllTableSorts();

    (function initTopTablePagination() {
      function bind(prefix, onPrev, onNext) {
        const prev = document.getElementById(prefix + '-prev');
        const next = document.getElementById(prefix + '-next');
        if (prev) prev.addEventListener('click', function() { onPrev(); });
        if (next) next.addEventListener('click', function() { onNext(); });
      }
      bind('country',
        function() { countryPage = Math.max(1, countryPage - 1); renderCountry(statsCache); },
        function() { countryPage = countryPage + 1; renderCountry(statsCache); }
      );
      bind('best-geo-products',
        function() { bestGeoProductsPage = Math.max(1, bestGeoProductsPage - 1); renderBestGeoProducts(statsCache); },
        function() { bestGeoProductsPage = bestGeoProductsPage + 1; renderBestGeoProducts(statsCache); }
      );
      bind('best-sellers',
        function() { bestSellersPage = Math.max(1, bestSellersPage - 1); fetchBestSellers(); },
        function() { bestSellersPage = bestSellersPage + 1; fetchBestSellers(); }
      );
      bind('worst-products',
        function() { worstProductsPage = Math.max(1, worstProductsPage - 1); fetchWorstProducts(); },
        function() { worstProductsPage = worstProductsPage + 1; fetchWorstProducts(); }
      );
      bind('best-variants',
        function() { bestVariantsPage = Math.max(1, bestVariantsPage - 1); fetchBestVariants(); },
        function() { bestVariantsPage = bestVariantsPage + 1; fetchBestVariants(); }
      );
      bind('worst-variants',
        function() { worstVariantsPage = Math.max(1, worstVariantsPage - 1); fetchWorstVariants(); },
        function() { worstVariantsPage = worstVariantsPage + 1; fetchWorstVariants(); }
      );
    })();

    (function initRowsPerPageSelect() {
      // Rows-per-page UI is intentionally hidden; keep page size fixed at default.
      const sel = document.getElementById('rows-per-page-select');
      if (sel) sel.value = String(rowsPerPage);
    })();

    function getConfigStatusUrl() {
      var url = API + '/api/config-status';
      try {
        var shop = getShopParam();
        if (!shop && typeof shopForSalesFallback === 'string' && shopForSalesFallback) shop = shopForSalesFallback;
        if (shop) url += (url.indexOf('?') >= 0 ? '&' : '?') + 'shop=' + encodeURIComponent(shop);
      } catch (_) {}
      return url;
    }

    function refreshConfigStatus() {
      const configStatusEl = document.getElementById('config-status');
      if (configStatusEl) configStatusEl.innerHTML = '<div class="diag"><div class="diag-loading">Loading…</div></div>';

      return fetch(getConfigStatusUrl(), { credentials: 'same-origin', cache: 'no-store' })
        .then(r => r.json())
        .then(c => {
          function code(value) { return '<code>' + escapeHtml(value == null ? '' : String(value)) + '</code>'; }
          function pill(text, tone) {
            const t = (tone === 'bad' || tone === 'warn') ? tone : 'ok';
            return '<span class="diag-pill ' + t + '">' + escapeHtml(String(text || '')) + '</span>';
          }
          function kv(label, valueHtml) {
            return '<div class="diag-kv"><div class="k">' + escapeHtml(label) + '</div><div class="v">' + valueHtml + '</div></div>';
          }
          function icon(name, cls) {
            const k = cls ? (' class="' + cls + '"') : '';
            if (name === 'shield') {
              return '<svg' + k + ' viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>';
            }
            if (name === 'columns') {
              return '<svg' + k + ' viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M12 3v18"/><path d="M3 4h18v16H3z"/></svg>';
            }
            if (name === 'bag') {
              return '<svg' + k + ' viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/><path d="M16 10a4 4 0 0 1-8 0"/></svg>';
            }
            if (name === 'activity') {
              return '<svg' + k + ' viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>';
            }
            if (name === 'bar') {
              return '<svg' + k + ' viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>';
            }
            if (name === 'server') {
              return '<svg' + k + ' viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><rect x="2" y="2" width="20" height="8" rx="2" ry="2"/><rect x="2" y="14" width="20" height="8" rx="2" ry="2"/><line x1="6" y1="6" x2="6.01" y2="6"/><line x1="6" y1="18" x2="6.01" y2="18"/></svg>';
            }
            if (name === 'key') {
              return '<svg' + k + ' viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M21 2l-2 2m-7.5 7.5a4.5 4.5 0 1 1 0-6.36A4.5 4.5 0 0 1 11.5 11.5z"/><path d="M15 7l4 4"/><path d="M13 9l2 2"/></svg>';
            }
            if (name === 'link') {
              return '<svg' + k + ' viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>';
            }
            if (name === 'chev') {
              return '<svg' + k + ' viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><polyline points="6 9 12 15 18 9"/></svg>';
            }
            return '';
          }
          function fmtSessions(n) { return (typeof n === 'number' && isFinite(n)) ? escapeHtml(formatSessions(n)) : '\u2014'; }
          function fmtRevenue(n) { return (typeof n === 'number' && isFinite(n)) ? escapeHtml(formatRevenue(n)) : '\u2014'; }
          function fmtTsMaybe(ms) { return (typeof ms === 'number' && isFinite(ms)) ? escapeHtml(formatTs(ms)) : '\u2014'; }
          function fmtPct(p) {
            if (typeof p !== 'number' || !isFinite(p)) return '\u2014';
            const s = (Math.round(p * 10) / 10).toFixed(1).replace(/\.0$/, '');
            return escapeHtml(s + '%');
          }
          function fmtSigned(n, fmtAbsFn, unitSuffix) {
            if (typeof n !== 'number' || !isFinite(n)) return '\u2014';
            const sign = n > 0 ? '+' : (n < 0 ? '-' : '');
            const abs = Math.abs(n);
            const core = fmtAbsFn ? fmtAbsFn(abs) : String(abs);
            return escapeHtml(sign + core + (unitSuffix || ''));
          }

          const app = c && c.app ? c.app : {};
          const shopify = c && c.shopify ? c.shopify : {};
          const db = c && c.db ? c.db : {};
          const ingest = c && c.ingest ? c.ingest : {};
          const reporting = c && c.reporting ? c.reporting : {};
          const traffic = c && c.traffic ? c.traffic : {};
          const sales = c && c.sales ? c.sales : {};
          const truth = sales && sales.truth ? sales.truth : {};
          const truthToday = truth && truth.today ? truth.today : {};
          const health = truth && truth.health ? truth.health : {};
          const evidenceToday = sales && sales.evidence && sales.evidence.today ? sales.evidence.today : {};
          const driftOrders = sales && sales.drift && typeof sales.drift.orders === 'number' ? sales.drift.orders : null;
          const pixelDerivedToday = sales && sales.pixel && sales.pixel.today ? sales.pixel.today : {};
          const pixelDerivedOrders = (typeof pixelDerivedToday.orderCount === 'number') ? pixelDerivedToday.orderCount : null;
          const pixelDerivedRevenue = (typeof pixelDerivedToday.revenueGbp === 'number') ? pixelDerivedToday.revenueGbp : null;
          const driftPixelOrders = sales && sales.drift && typeof sales.drift.pixelVsTruthOrders === 'number' ? sales.drift.pixelVsTruthOrders : null;
          const driftPixelRevenue = sales && sales.drift && typeof sales.drift.pixelVsTruthRevenueGbp === 'number' ? sales.drift.pixelVsTruthRevenueGbp : null;
          const pixel = c && c.pixel ? c.pixel : {};

          const truthOrders = (typeof truthToday.orderCount === 'number') ? truthToday.orderCount : null;
          const truthRevenue = (typeof truthToday.revenueGbp === 'number') ? truthToday.revenueGbp : null;
          const truthReturningCustomers = (typeof truthToday.returningCustomerCount === 'number') ? truthToday.returningCustomerCount : null;
          const truthReturningRevenue = (typeof truthToday.returningRevenueGbp === 'number') ? truthToday.returningRevenueGbp : null;
          const evTotal = (typeof evidenceToday.checkoutCompleted === 'number') ? evidenceToday.checkoutCompleted : null;
          const evLinked = (typeof evidenceToday.linked === 'number') ? evidenceToday.linked : null;
          const evUnlinked = (typeof evidenceToday.unlinked === 'number') ? evidenceToday.unlinked : null;
          const staleSec = (health && typeof health.staleMs === 'number') ? Math.round(health.staleMs / 1000) : null;

          const SHOPIFY_LOGO_URL = 'https://cdn.shopify.com/s/files/1/0847/7261/8587/files/shopify.png?v=1770253742';
          const BIRDSEYE_LOGO_URL = 'https://cdn.shopify.com/s/files/1/0847/7261/8587/files/birdseyegreen.webp?v=1770250895';

          const shopifySessionsToday = (traffic && typeof traffic.shopifySessionsToday === 'number') ? traffic.shopifySessionsToday : null;
          const birdseyeSessionsToday = (traffic && traffic.today && typeof traffic.today.humanSessions === 'number') ? traffic.today.humanSessions :
            (traffic && traffic.today && typeof traffic.today.sessionsReachedApp === 'number') ? traffic.today.sessionsReachedApp : null;
          const botsBlockedToday = (traffic && traffic.today && typeof traffic.today.botsBlockedAtEdge === 'number') ? traffic.today.botsBlockedAtEdge : null;
          const botsBlockedUpdatedAt = (traffic && traffic.today && typeof traffic.today.botsBlockedAtEdgeUpdatedAt === 'number') ? traffic.today.botsBlockedAtEdgeUpdatedAt : null;

          const shopifyCr = (truthOrders != null && shopifySessionsToday != null && shopifySessionsToday > 0) ? (truthOrders / shopifySessionsToday) * 100 : null;
          const birdseyeCr = (truthOrders != null && birdseyeSessionsToday != null && birdseyeSessionsToday > 0) ? (truthOrders / birdseyeSessionsToday) * 100 : null;

          const sessionsDiff = (shopifySessionsToday != null && birdseyeSessionsToday != null) ? (shopifySessionsToday - birdseyeSessionsToday) : null;
          const crDiff = (shopifyCr != null && birdseyeCr != null) ? (shopifyCr - birdseyeCr) : null;

          const storedScopesStr = (shopify && shopify.storedScopes) ? String(shopify.storedScopes) : '';
          const serverScopesStr = (shopify && shopify.serverScopes) ? String(shopify.serverScopes) : '';
          const storedScopes = storedScopesStr ? storedScopesStr.split(',').map(s => s.trim()).filter(Boolean) : [];
          const serverScopes = serverScopesStr ? serverScopesStr.split(',').map(s => s.trim()).filter(Boolean) : [];
          const missingScopes = (storedScopes.length && serverScopes.length) ? serverScopes.filter(s => storedScopes.indexOf(s) === -1) : [];

          const pixelIngestUrl = (pixel && pixel.ingestUrl != null) ? String(pixel.ingestUrl) : '';
          const expectedIngestUrl = (ingest && ingest.effectiveIngestUrl != null) ? String(ingest.effectiveIngestUrl) : '';
          const ingestUrlMatch = (pixelIngestUrl && expectedIngestUrl) ? (pixelIngestUrl === expectedIngestUrl) : null;

          function diffCell(text, cls) {
            const c = cls ? (' ' + cls) : '';
            return '<span class="' + c.trim() + '">' + escapeHtml(text) + '</span>';
          }

          let html = '';
          html += '<div class="diag">';

          // Top KPI grid (Shopify vs Birdseye)
          html += '<div class="diag-top-grid">';
          html += '<div class="diag-card">';
          html +=   '<div class="diag-card-header">';
          html +=     '<div class="diag-brand">';
          html +=       '<img class="diag-logo" src="' + escapeHtml(SHOPIFY_LOGO_URL) + '" alt="Shopify" decoding="async" loading="eager" fetchpriority="high" />';
          html +=       '<div style="min-width:0">';
          html +=         '<div class="diag-title">Shopify</div>';
          html +=         '<div class="diag-sub">Sessions + CR%</div>';
          html +=       '</div>';
          html +=     '</div>';
          html +=   '</div>';
          html +=   '<div class="diag-metrics">';
          html +=     '<div class="diag-metric"><div class="diag-metric-label">Shopify Sessions</div><div class="diag-metric-value">' + fmtSessions(shopifySessionsToday) + '</div></div>';
          html +=     '<div class="diag-metric"><div class="diag-metric-label">Shopify CR%</div><div class="diag-metric-value">' + fmtPct(shopifyCr) + '</div></div>';
          html +=   '</div>';
          html += '</div>';

          html += '<div class="diag-card">';
          html +=   '<div class="diag-card-header">';
          html +=     '<div class="diag-brand">';
          html +=       '<img class="diag-logo" src="' + escapeHtml(BIRDSEYE_LOGO_URL) + '" alt="Birdseye" decoding="async" loading="eager" fetchpriority="high" />';
          html +=       '<div style="min-width:0">';
          html +=         '<div class="diag-title">Birdseye</div>';
          html +=         '<div class="diag-sub">Sessions + CR%</div>';
          html +=       '</div>';
          html +=     '</div>';
          html +=   '</div>';
          html +=   '<div class="diag-metrics">';
          html +=     '<div class="diag-metric"><div class="diag-metric-label">Birdseye Sessions</div><div class="diag-metric-value">' + fmtSessions(birdseyeSessionsToday) + '</div></div>';
          html +=     '<div class="diag-metric"><div class="diag-metric-label">Birdseye CR%</div><div class="diag-metric-value">' + fmtPct(birdseyeCr) + '</div></div>';
          html +=   '</div>';
          html += '</div>';

          html += '<div class="diag-card diag-card-bots">';
          html +=   '<div class="diag-bots-left">';
          html +=     icon('shield', 'diag-icon');
          html +=     '<div style="min-width:0">';
          html +=       '<div class="diag-title">Bots Blocked</div>';
          html +=       '<div class="diag-sub">Edge (today)</div>';
          html +=     '</div>';
          html +=   '</div>';
          html +=   '<div style="text-align:right">';
          html +=     '<div class="diag-metric-value small">' + fmtSessions(botsBlockedToday) + '</div>';
          html +=     (botsBlockedUpdatedAt ? ('<div class="diag-bots-meta">last ' + fmtTsMaybe(botsBlockedUpdatedAt) + '</div>') : '');
          html +=   '</div>';
          html += '</div>';
          html += '</div>';

          // Side-by-side comparison table (diffable elements)
          html += '<div>';
          html +=   '<div class="diag-section-title">' + icon('columns', '') + 'Diffable comparison</div>';
          html +=   '<div class="diag-table-scroll">';
          html +=     '<table class="diag-compare-table">';
          html +=       '<thead><tr><th>Item</th><th>Shopify</th><th>Birdseye</th><th>Diff / status</th></tr></thead>';
          html +=       '<tbody>';

          // Traffic
          html +=       '<tr><td><strong>Traffic</strong></td><td></td><td></td><td></td></tr>';
          html +=       '<tr>' +
                        '<td>Sessions (today)</td>' +
                        '<td>' + fmtSessions(shopifySessionsToday) + '</td>' +
                        '<td>' + fmtSessions(birdseyeSessionsToday) + '</td>' +
                        '<td>' + (sessionsDiff == null ? '\u2014' : ('<span class="' + (sessionsDiff === 0 ? 'diag-diff-ok' : 'diag-diff-warn') + '">' + fmtSigned(sessionsDiff, function(a){ return formatSessions(a); }, '') + '</span>')) + '</td>' +
                        '</tr>';
          html +=       '<tr>' +
                        '<td>CR% (today)</td>' +
                        '<td>' + fmtPct(shopifyCr) + '</td>' +
                        '<td>' + fmtPct(birdseyeCr) + '</td>' +
                        '<td>' + (crDiff == null ? '\u2014' : ('<span class="' + (Math.abs(crDiff) < 0.0001 ? 'diag-diff-ok' : 'diag-diff-warn') + '">' + fmtSigned(crDiff, function(a){ const s=(Math.round(a*10)/10).toFixed(1).replace(/\\.0$/,''); return s; }, 'pp') + '</span>')) + '</td>' +
                        '</tr>';
          html +=       '<tr>' +
                        '<td>Bots blocked (today)</td>' +
                        '<td>\u2014</td>' +
                        '<td>' + fmtSessions(botsBlockedToday) + '</td>' +
                        '<td>' + (botsBlockedToday != null ? pill('Tracked', 'ok') : '\u2014') + '</td>' +
                        '</tr>';

          // Sales / drift
          html +=       '<tr><td><strong>Sales</strong></td><td></td><td></td><td></td></tr>';
          html +=       '<tr>' +
                        '<td>Orders (today)</td>' +
                        '<td>' + (truthOrders != null ? escapeHtml(String(truthOrders)) : '\u2014') + '</td>' +
                        '<td>' + (pixelDerivedOrders != null ? escapeHtml(String(pixelDerivedOrders)) : '\u2014') + '</td>' +
                        '<td>' + (driftPixelOrders == null ? '\u2014' : ('<span class="' + (driftPixelOrders === 0 ? 'diag-diff-ok' : 'diag-diff-bad') + '">' + fmtSigned(driftPixelOrders, function(a){ return String(a); }, '') + '</span>')) + '</td>' +
                        '</tr>';
          html +=       '<tr>' +
                        '<td>Revenue (today)</td>' +
                        '<td>' + fmtRevenue(truthRevenue) + '</td>' +
                        '<td>' + fmtRevenue(pixelDerivedRevenue) + '</td>' +
                        '<td>' + (driftPixelRevenue == null ? '\u2014' : ('<span class="' + (driftPixelRevenue === 0 ? 'diag-diff-ok' : 'diag-diff-bad') + '">' + escapeHtml((driftPixelRevenue >= 0 ? '+' : '') + String(driftPixelRevenue)) + '</span>')) + '</td>' +
                        '</tr>';
          html +=       '<tr>' +
                        '<td>Checkout events (today)</td>' +
                        '<td>' + (truthOrders != null ? escapeHtml(String(truthOrders)) : '\u2014') + '</td>' +
                        '<td>' + (evTotal != null ? escapeHtml(String(evTotal)) : '\u2014') + '</td>' +
                        '<td>' + (driftOrders == null ? '\u2014' : ('<span class="' + (driftOrders === 0 ? 'diag-diff-ok' : 'diag-diff-warn') + '">' + fmtSigned(driftOrders, function(a){ return String(a); }, '') + '</span>')) + '</td>' +
                        '</tr>';

          // Config checks
          html +=       '<tr><td><strong>Config checks</strong></td><td></td><td></td><td></td></tr>';
          html +=       '<tr>' +
                        '<td>OAuth token</td>' +
                        '<td>' + (shopify.hasToken ? pill('Stored', 'ok') : pill('Missing', 'bad')) + '</td>' +
                        '<td>' + pill('Required', 'warn') + '</td>' +
                        '<td>' + (shopify.hasToken ? pill('OK', 'ok') : pill('Fix', 'bad')) + '</td>' +
                        '</tr>';
          html +=       '<tr>' +
                        '<td>Scopes</td>' +
                        '<td>' + (storedScopes.length ? escapeHtml(String(storedScopes.length) + ' granted') : '\u2014') + '</td>' +
                        '<td>' + (serverScopes.length ? escapeHtml(String(serverScopes.length) + ' required') : '\u2014') + '</td>' +
                        '<td>' + (missingScopes.length ? (pill('Missing', 'bad') + ' ' + code(missingScopes.join(', '))) : pill('All scopes OK', 'ok')) + '</td>' +
                        '</tr>';
          html +=       '<tr>' +
                        '<td>Pixel installed</td>' +
                        '<td>' + (pixel && pixel.installed === true ? pill('Yes', 'ok') : (pixel && pixel.installed === false ? pill('No', 'bad') : '\u2014')) + '</td>' +
                        '<td>' + pill('Required', 'warn') + '</td>' +
                        '<td>' + (pixel && pixel.installed === true ? pill('OK', 'ok') : (pixel && pixel.installed === false ? pill('Fix', 'bad') : '\u2014')) + '</td>' +
                        '</tr>';
          html +=       '<tr>' +
                        '<td>Pixel ingestUrl</td>' +
                        '<td>' + (pixelIngestUrl ? code(pixelIngestUrl) : '\u2014') + '</td>' +
                        '<td>' + (expectedIngestUrl ? code(expectedIngestUrl) : '\u2014') + '</td>' +
                        '<td>' + (ingestUrlMatch == null ? '\u2014' : (ingestUrlMatch ? pill('Match', 'ok') : pill('Mismatch', 'bad'))) + '</td>' +
                        '</tr>';
          html +=       '<tr>' +
                        '<td>Ingest secret</td>' +
                        '<td>\u2014</td>' +
                        '<td>' + (ingest.ingestSecretConfigured ? pill('Set', 'ok') : pill('Missing', 'bad')) + '</td>' +
                        '<td>' + (ingest.ingestSecretConfigured ? pill('OK', 'ok') : pill('Fix', 'bad')) + '</td>' +
                        '</tr>';

          html +=       '</tbody>';
          html +=     '</table>';
          html +=   '</div>';
          if (missingScopes.length) {
            html += '<div class="diag-note">Missing scopes: re-open the app from Shopify Admin to re-authorize and grant the missing scopes.</div>';
          }
          if (truthOrders != null && truthOrders > 0 && evTotal === 0) {
            html += '<div class="diag-note">Evidence can be 0 right after reinstall/pixel creation; it only starts counting from the next checkout.</div>';
          }
          html += '</div>';

          // Technical details (collapsed by default)
          html += '<details class="diag-tech">';
          html +=   '<summary>';
          html +=     '<div class="diag-tech-head">';
          html +=       '<strong>Technical details</strong>';
          html +=       '<span>Scopes, pixel config, truth sync, ingest, DB</span>';
          html +=     '</div>';
          html +=     icon('chev', 'diag-chevron');
          html +=   '</summary>';
          html +=   '<div class="diag-tabs">';
          html +=     '<div class="diag-tab-nav">';
          html +=       '<input class="diag-tab" type="radio" name="diag-tech-tab" id="diag-tab-shopify" checked />';
          html +=       '<label class="diag-tab-label" for="diag-tab-shopify">' + icon('bag', '') + 'Shopify</label>';
          html +=       '<input class="diag-tab" type="radio" name="diag-tech-tab" id="diag-tab-pixel" />';
          html +=       '<label class="diag-tab-label" for="diag-tab-pixel">' + icon('activity', '') + 'Pixel</label>';
          html +=       '<input class="diag-tab" type="radio" name="diag-tech-tab" id="diag-tab-traffic" />';
          html +=       '<label class="diag-tab-label" for="diag-tab-traffic">' + icon('bar', '') + 'Traffic</label>';
          html +=       '<input class="diag-tab" type="radio" name="diag-tech-tab" id="diag-tab-sources" />';
          html +=       '<label class="diag-tab-label" for="diag-tab-sources">' + icon('link', '') + 'Sources</label>';
          html +=       '<input class="diag-tab" type="radio" name="diag-tech-tab" id="diag-tab-system" />';
          html +=       '<label class="diag-tab-label" for="diag-tab-system">' + icon('server', '') + 'System</label>';
          html +=     '<div class="diag-panels">';

          // Shopify panel
          html +=       '<div class="diag-panel diag-panel-shopify">';
          html +=         '<div class="diag-panel-grid">';
          html +=           '<div class="diag-panel-card">';
          html +=             '<div class="diag-panel-card-title">' + icon('key', '') + 'Auth + scopes</div>';
          html +=             kv('Shop', shopify.shop ? code(shopify.shop) : pill('MISSING', 'bad'));
          html +=             kv('Token stored', shopify.hasToken ? pill('YES', 'ok') : pill('NO', 'bad'));
          if (storedScopesStr) html += kv('Stored scopes', code(storedScopesStr));
          if (serverScopesStr) html += kv('Server scopes', code(serverScopesStr));
          if (missingScopes.length) html += kv('Missing scopes', code(missingScopes.join(', ')));
          html +=           '</div>';

          html +=           '<div class="diag-panel-card">';
          html +=             '<div class="diag-panel-card-title">' + icon('bag', '') + 'Truth (orders)</div>';
          html +=             kv('Today', (truthOrders != null ? (code(truthOrders) + ' orders') : '\u2014') + (truthRevenue != null ? (' \u00b7 ' + code(formatRevenue(truthRevenue))) : ''));
          if (truthReturningCustomers != null || truthReturningRevenue != null) {
            html += kv('Returning (today)', (truthReturningCustomers != null ? (code(truthReturningCustomers) + ' customers') : '\u2014') + (truthReturningRevenue != null ? (' \u00b7 ' + code(formatRevenue(truthReturningRevenue))) : ''));
          }
          if (typeof truthToday.lastOrderCreatedAt === 'number') html += kv('Last order', code(formatTs(truthToday.lastOrderCreatedAt)));
          html +=           '</div>';

          html +=           '<div class="diag-panel-card">';
          html +=             '<div class="diag-panel-card-title">' + icon('activity', '') + 'Sync health</div>';
          html +=             kv('Sync age', staleSec != null ? code(staleSec + 's') : '\u2014');
          if (health && health.lastSuccessAt) html += kv('Last sync', code(formatTs(health.lastSuccessAt)));
          if (health && health.lastError) html += kv('Last error', code(String(health.lastError).slice(0, 220)));
          if (truth && truth.lastVerify && truth.lastVerify.ts) {
            html += kv('Last verify', (truth.lastVerify.ok ? pill('OK', 'ok') : pill('CHECK', 'bad')) + ' \u00b7 ' + code(formatTs(truth.lastVerify.ts)));
            const vd = truth.lastVerify.todayDiff || null;
            if (vd && (
              (typeof vd.orderCount === 'number' && vd.orderCount !== 0) ||
              (typeof vd.revenueGbp === 'number' && vd.revenueGbp !== 0) ||
              (typeof vd.returningCustomerCount === 'number' && vd.returningCustomerCount !== 0) ||
              (typeof vd.returningRevenueGbp === 'number' && vd.returningRevenueGbp !== 0)
            )) {
              html += kv('Verify diff (today)', code(JSON.stringify(vd)));
            }
          }
          html +=           '</div>';
          html +=         '</div>';
          html +=       '</div>';

          // Pixel panel
          html +=       '<div class="diag-panel diag-panel-pixel">';
          html +=         '<div class="diag-panel-grid">';
          html +=           '<div class="diag-panel-card">';
          html +=             '<div class="diag-panel-card-title">' + icon('activity', '') + 'Evidence (checkout_completed)</div>';
          if (evTotal != null) {
            let evLine = code(evTotal) + ' events';
            if (evLinked != null && evUnlinked != null) evLine += ' \u00b7 linked ' + code(evLinked) + ' \u00b7 unlinked ' + code(evUnlinked);
            if (driftOrders != null) evLine += ' \u00b7 drift vs truth ' + code((driftOrders >= 0 ? '+' + driftOrders : String(driftOrders)));
            html += kv('Today', evLine);
          } else {
            html += kv('Today', '\u2014');
          }
          if (typeof evidenceToday.lastOccurredAt === 'number') html += kv('Last event', code(formatTs(evidenceToday.lastOccurredAt)));
          html +=           '</div>';

          html +=           '<div class="diag-panel-card">';
          html +=             '<div class="diag-panel-card-title">' + icon('bag', '') + 'Purchases (derived)</div>';
          if (pixelDerivedOrders != null || pixelDerivedRevenue != null) {
            let line = (pixelDerivedOrders != null ? (code(pixelDerivedOrders) + ' orders') : '\u2014');
            if (pixelDerivedRevenue != null) line += ' \u00b7 ' + code(formatRevenue(pixelDerivedRevenue));
            if (driftPixelOrders != null) line += ' \u00b7 drift vs truth ' + code((driftPixelOrders >= 0 ? '+' + driftPixelOrders : String(driftPixelOrders)));
            if (driftPixelRevenue != null) line += ' \u00b7 \u00a3 drift ' + code(String(driftPixelRevenue >= 0 ? ('+' + driftPixelRevenue) : driftPixelRevenue));
            html += kv('Today', line);
          } else {
            html += kv('Today', '\u2014');
          }
          html +=           '</div>';

          html +=           '<div class="diag-panel-card">';
          html +=             '<div class="diag-panel-card-title">' + icon('link', '') + 'Pixel settings (Shopify)</div>';
          if (pixel && pixel.installed === false) {
            html += kv('Pixel', pill('Not installed', 'bad'));
          } else if (pixel && pixel.installed === true) {
            html += kv('Pixel', pill('Installed', 'ok'));
          } else if (pixel && pixel.message) {
            html += kv('Pixel', code(pixel.message));
          } else {
            html += kv('Pixel', '\u2014');
          }
          if (pixelIngestUrl) html += kv('Pixel ingestUrl', code(pixelIngestUrl));
          if (expectedIngestUrl) html += kv('Expected ingestUrl', code(expectedIngestUrl));
          if (ingestUrlMatch === false) html += '<div class="diag-note">Pixel ingestUrl does not match expected ingest URL. Run Pixel Ensure to update settings.</div>';
          html +=           '</div>';
          html +=         '</div>';
          html +=       '</div>';

          // Traffic panel
          html +=       '<div class="diag-panel diag-panel-traffic">';
          html +=         '<div class="diag-panel-grid">';
          html +=           '<div class="diag-panel-card">';
          html +=             '<div class="diag-panel-card-title">' + icon('bar', '') + 'Sessions</div>';
          if (traffic && traffic.today) {
            if (typeof traffic.today.sessionsReachedApp === 'number') html += kv('Reached app (today)', code(formatSessions(traffic.today.sessionsReachedApp)));
            if (typeof traffic.today.humanSessions === 'number') html += kv('Human sessions (today)', code(formatSessions(traffic.today.humanSessions)));
            if (typeof traffic.today.botSessionsTagged === 'number') html += kv('Bot sessions tagged (today)', code(formatSessions(traffic.today.botSessionsTagged)));
            if (typeof traffic.today.totalTrafficEst === 'number') {
              html += kv('Total traffic est. (today)', code(formatSessions(traffic.today.totalTrafficEst)));
              html += '<div class="diag-note">Total traffic est. = sessions reached app + bots blocked at edge.</div>';
            }
          }
          if (typeof traffic.shopifySessionsToday === 'number') {
            html += kv('Shopify sessions (today)', code(formatSessions(traffic.shopifySessionsToday)));
            if (traffic && traffic.today && typeof traffic.today.humanSessions === 'number') {
              html += kv('Shopify \u2212 ours (human)', code(formatSessions(traffic.shopifySessionsToday - traffic.today.humanSessions)));
            }
          } else if (traffic.shopifySessionsTodayNote) {
            html += kv('Shopify sessions (today)', '\u2014');
            html += '<div class="diag-note">' + escapeHtml(traffic.shopifySessionsTodayNote) + '</div>';
          }
          html +=           '</div>';

          html +=           '<div class="diag-panel-card">';
          html +=             '<div class="diag-panel-card-title">' + icon('shield', '') + 'Edge + ingest</div>';
          html +=             kv('Ingest secret', ingest.ingestSecretConfigured ? pill('SET', 'ok') : pill('MISSING', 'bad'));
          if (botsBlockedToday != null) {
            let line = code(formatSessions(botsBlockedToday));
            if (botsBlockedUpdatedAt) line += ' \u00b7 last ' + code(formatTs(botsBlockedUpdatedAt));
            html += kv('Bots blocked (today)', line);
          }
          html +=           '</div>';
          html +=         '</div>';
          html +=       '</div>';

          // Sources panel (mapping + icons)
          html +=       '<div class="diag-panel diag-panel-sources">';
          html +=         '<div class="diag-panel-grid">';
          html +=           '<div class="diag-panel-card" style="grid-column: 1 / -1;">';
          html +=             '<div class="diag-panel-card-title">' + icon('link', '') + 'Source mapping</div>';
          html +=             '<div id="traffic-source-mapping-root"><div class="diag-note">Loading\u2026</div></div>';
          html +=           '</div>';
          html +=         '</div>';
          html +=       '</div>';

          // System panel
          html +=       '<div class="diag-panel diag-panel-system">';
          html +=         '<div class="diag-panel-grid">';
          html +=           '<div class="diag-panel-card">';
          html +=             '<div class="diag-panel-card-title">' + icon('server', '') + 'Reporting</div>';
          if (reporting && (reporting.ordersSource || reporting.sessionsSource)) {
            if (reporting.ordersSource) html += kv('Orders source', code(reporting.ordersSource));
            if (reporting.sessionsSource) html += kv('Sessions source', code(reporting.sessionsSource));
          } else {
            html += kv('Sources', '\u2014');
          }
          html +=           '</div>';

          html +=           '<div class="diag-panel-card">';
          html +=             '<div class="diag-panel-card-title">' + icon('server', '') + 'Runtime</div>';
          if (app && app.version) html += kv('App version', code(app.version));
          if (db && db.engine) html += kv('DB', code(db.engine + (db.configured ? '' : ' (DB_URL not set)')));
          if (db && db.tables) {
            const t = db.tables;
            const bits = [];
            function add(name, ok) { bits.push(name + (ok ? ' ✓' : ' ✗')); }
            add('sessions', !!t.sessions);
            add('events', !!t.events);
            add('orders_shopify', !!t.orders_shopify);
            add('customer_order_facts', !!t.customer_order_facts);
            add('purchase_events', !!t.purchase_events);
            add('reconcile_state', !!t.reconcile_state);
            add('audit_log', !!t.audit_log);
            html += kv('Tables', code(bits.join(' · ')));
          }
          if (app && typeof app.sentryConfigured === 'boolean') html += kv('Sentry', app.sentryConfigured ? pill('ON', 'ok') : pill('OFF', 'bad'));
          html +=           '</div>';
          html +=         '</div>';
          html +=       '</div>';

          html +=     '</div>'; // panels
          html +=   '</div>'; // diag-tab-nav
          html +=   '</div>'; // diag-tabs
          html += '</details>';

          html += '</div>'; // diag

          const configStatusEl = document.getElementById('config-status');
          if (configStatusEl) configStatusEl.innerHTML = html;
          try { initTrafficSourceMappingPanel(); } catch (_) {}

          // Footer: keep "Last sale" accurate. Prefer Shopify truth order.created_at, else evidence last checkout_completed.
          if (truthToday && typeof truthToday.lastOrderCreatedAt === 'number') {
            setLastSaleAt(truthToday.lastOrderCreatedAt);
          } else if (evidenceToday && typeof evidenceToday.lastOccurredAt === 'number') {
            setLastSaleAt(evidenceToday.lastOccurredAt);
          }
          return c;
        })
        .catch(() => {
          const configStatusEl = document.getElementById('config-status');
          if (configStatusEl) configStatusEl.innerHTML = '<div class="diag"><div class="diag-loading">' + '<span class="diag-pill bad">Error</span> Could not load diagnostics.' + '</div></div>';
        });
    }

    refreshConfigStatus();

    updateLastSaleAgo();
    setInterval(updateLastSaleAgo, 10000);

    (function initConfigModal() {
      const modal = document.getElementById('config-modal');
      const openBtn = document.getElementById('config-open-btn');
      const closeBtn = document.getElementById('config-close-btn');
      if (!modal) return;
      function open() {
        try { refreshConfigStatus(); } catch (_) {}
        modal.classList.add('open');
        modal.setAttribute('aria-hidden', 'false');
      }
      function close() { modal.classList.remove('open'); modal.setAttribute('aria-hidden', 'true'); }
      if (openBtn) openBtn.addEventListener('click', open);
      if (closeBtn) closeBtn.addEventListener('click', close);
      modal.addEventListener('click', function(e) { if (e.target === modal) close(); });
      document.addEventListener('keydown', function(e) { if (e.key === 'Escape') close(); });
    })();

    (function initTrafficModals() {
      const sourcesModal = document.getElementById('traffic-sources-modal');
      const typesModal = document.getElementById('traffic-types-modal');
      const openSourcesBtn = document.getElementById('traffic-sources-config-btn');
      const openTypesBtn = document.getElementById('traffic-types-config-btn');
      const closeSourcesBtn = document.getElementById('traffic-sources-close-btn');
      const closeTypesBtn = document.getElementById('traffic-types-close-btn');
      if (!sourcesModal || !typesModal) return;

      function open(modal) {
        try { refreshTraffic({ force: true }); } catch (_) {}
        modal.classList.add('open');
        modal.setAttribute('aria-hidden', 'false');
        try {
          if (modal === sourcesModal) initTrafficSourceMappingPanel({ rootId: 'traffic-source-mapping-mini' });
        } catch (_) {}
      }
      function close(modal) {
        modal.classList.remove('open');
        modal.setAttribute('aria-hidden', 'true');
      }

      if (openSourcesBtn) openSourcesBtn.addEventListener('click', function() { open(sourcesModal); });
      if (openTypesBtn) openTypesBtn.addEventListener('click', function() { open(typesModal); });
      if (closeSourcesBtn) closeSourcesBtn.addEventListener('click', function() { close(sourcesModal); });
      if (closeTypesBtn) closeTypesBtn.addEventListener('click', function() { close(typesModal); });

      sourcesModal.addEventListener('click', function(e) { if (e.target === sourcesModal) close(sourcesModal); });
      typesModal.addEventListener('click', function(e) { if (e.target === typesModal) close(typesModal); });

      document.addEventListener('keydown', function(e) {
        if (e.key !== 'Escape') return;
        if (sourcesModal.classList.contains('open')) close(sourcesModal);
        if (typesModal.classList.contains('open')) close(typesModal);
      });
    })();

    (function initTrafficTypeTree() {
      const body = document.getElementById('traffic-types-body');
      if (!body) return;
      body.addEventListener('click', function(e) {
        const target = e && e.target ? e.target : null;
        const btn = target && target.closest ? target.closest('.traffic-type-toggle') : null;
        if (!btn) return;
        e.preventDefault();
        e.stopPropagation();
        const device = (btn.getAttribute('data-device') || '').trim().toLowerCase();
        if (!device) return;
        if (!trafficTypeExpanded || typeof trafficTypeExpanded !== 'object') trafficTypeExpanded = {};
        const nextOpen = !trafficTypeExpanded[device];
        trafficTypeExpanded[device] = nextOpen;
        btn.setAttribute('aria-expanded', nextOpen ? 'true' : 'false');
        body.querySelectorAll('tr.traffic-type-child[data-parent="' + device + '"]').forEach(function(tr) {
          tr.style.display = nextOpen ? '' : 'none';
        });
      });
    })();

    (function initTopBar() {
      saleMuted = sessionStorage.getItem(SALE_MUTED_KEY) === 'true';
      saleAudio = new Audio(CASH_REGISTER_MP3_URL);
      const muteBtn = document.getElementById('audio-mute-btn');
      const iconOn = muteBtn && muteBtn.querySelector('.sound-icon-on');
      const iconOff = muteBtn && muteBtn.querySelector('.sound-icon-off');
      if (muteBtn) {
        if (iconOn) iconOn.style.display = saleMuted ? 'none' : 'block';
        if (iconOff) iconOff.style.display = saleMuted ? 'block' : 'none';
        muteBtn.classList.toggle('muted', saleMuted);
        muteBtn.addEventListener('click', function() {
          saleMuted = !saleMuted;
          sessionStorage.setItem(SALE_MUTED_KEY, String(saleMuted));
          if (iconOn) iconOn.style.display = saleMuted ? 'none' : 'block';
          if (iconOff) iconOff.style.display = saleMuted ? 'block' : 'none';
          muteBtn.classList.toggle('muted', saleMuted);
        });
      }
      // Test sale sound: add ?cha=ching to the URL. Plays once when sound is on; if autoplay blocked, plays on first click.
      (function testChaChing() {
        if (new URLSearchParams(window.location.search).get('cha') !== 'ching' || !saleAudio) return;
        function playTest() {
          if (saleMuted) return;
          saleAudio.currentTime = 0;
          saleAudio.play().catch(function() {});
        }
        playTest();
        document.body.addEventListener('click', function once() {
          document.body.removeEventListener('click', once);
          playTest();
        }, { once: true });
      })();
      const dateSelect = document.getElementById('global-date-select');
      if (dateSelect) {
        syncDateSelectOptions();
        updateLiveViewTitle();
        updateRowsPerPageVisibility();
        dateSelect.addEventListener('change', function() {
          const next = String(this.value || '').trim().toLowerCase();
          if (next === 'custom') {
            openCustomDateModal();
            // Revert the select so "Choose dates…" can be selected again.
            syncDateSelectOptions();
            return;
          }
          if (next === 'today' || next === 'yesterday') {
            dateRange = next;
            applyDateRangeChange();
            return;
          }
          // Defensive: allow selecting an applied range key if present.
          if (isCustomRangeKey(next)) {
            dateRange = next;
            applyDateRangeChange();
          }
        });
        initCustomDateModal();
      }
      (function initMobileDateMenu() {
        const btn = document.getElementById('mobile-date-btn');
        const menu = document.getElementById('mobile-date-menu');
        const sel = document.getElementById('global-date-select');
        if (!btn || !menu || !sel) return;

        function close() {
          menu.classList.remove('open');
          btn.setAttribute('aria-expanded', 'false');
        }

        function syncSelection() {
          let cur = String(dateRange || 'today');
          if (cur === 'live' || cur === '1h') cur = 'today';
          if (typeof cur === 'string' && (cur.startsWith('r:') || cur.startsWith('d:'))) cur = 'custom';
          menu.querySelectorAll('.mobile-date-item[data-value]').forEach(function(it) {
            const v = it.getAttribute('data-value');
            it.setAttribute('aria-current', v === cur ? 'true' : 'false');
          });
        }

        function toggle(e) {
          if (e) {
            e.preventDefault();
            e.stopPropagation();
          }
          const nextOpen = !menu.classList.contains('open');
          if (nextOpen) syncSelection();
          menu.classList.toggle('open', nextOpen);
          btn.setAttribute('aria-expanded', nextOpen ? 'true' : 'false');
        }

        btn.addEventListener('click', toggle);
        menu.querySelectorAll('.mobile-date-item[data-value]').forEach(function(it) {
          it.addEventListener('click', function(e) {
            e.preventDefault();
            const v = String(it.getAttribute('data-value') || '').trim().toLowerCase();
            if (!v) return;
            sel.value = v;
            try {
              sel.dispatchEvent(new Event('change', { bubbles: true }));
            } catch (_) {
              // Fallback for older browsers
              const ev = document.createEvent('Event');
              ev.initEvent('change', true, true);
              sel.dispatchEvent(ev);
            }
            close();
          });
        });

        document.addEventListener('click', function(e) {
          if (!menu.classList.contains('open')) return;
          const target = e.target;
          if (menu.contains(target) || btn.contains(target)) return;
          close();
        });
        document.addEventListener('keydown', function(e) {
          if (e.key !== 'Escape') return;
          close();
        });
      })();
      (function initTableTitleTabs() {
        const tabsWrap = document.getElementById('table-title-tabs');
        if (!tabsWrap) return;
        function setRangeFromTab(range) {
          dateRange = range;
          if (dateRange === '1h') {
            const sel = document.getElementById('global-date-select');
            if (sel) sel.value = 'today';
          }
          lastOnlineCount = null;
          countryPage = 1;
          updateLiveViewTitle();
          updateRowsPerPageVisibility();
          refreshKpis({ force: true });
          updateKpis();
          fetchSessions();
          updateNextUpdateUi();
        }
        document.querySelectorAll('#table-title-tabs button[data-range]').forEach(function(btn) {
          btn.addEventListener('click', function() { setRangeFromTab(btn.getAttribute('data-range')); });
        });
      })();
      (function initMainTabs() {
        const TAB_KEY = 'livevisitors-main-tab';
        const tabSpy = document.getElementById('tab-spy');
        const tabStats = document.getElementById('tab-stats');
        const tabProducts = document.getElementById('tab-products');
        const tabTraffic = document.getElementById('tab-traffic');
        const panelSpy = document.getElementById('tab-panel-spy');
        const panelStats = document.getElementById('tab-panel-stats');
        const panelProducts = document.getElementById('tab-panel-products');
        const panelTraffic = document.getElementById('tab-panel-traffic');
        const mobileBtn = document.getElementById('mobile-tabs-btn');
        const mobileMenu = document.getElementById('mobile-tabs-menu');
        const mobileCurrent = document.getElementById('mobile-tabs-current');

        function closeMobileMenu() {
          if (!mobileMenu || !mobileBtn) return;
          mobileMenu.classList.remove('open');
          mobileBtn.setAttribute('aria-expanded', 'false');
        }

        function syncMobileMenu(tab) {
          if (mobileCurrent) {
            mobileCurrent.textContent = tab === 'stats' ? 'Breakdown' : (tab === 'products' ? 'Products' : (tab === 'traffic' ? 'Traffic' : 'Home'));
          }
          if (mobileMenu) {
            mobileMenu.querySelectorAll('.mobile-tabs-item[data-tab]').forEach(function(btn) {
              const t = btn.getAttribute('data-tab');
              btn.setAttribute('aria-current', t === tab ? 'true' : 'false');
            });
          }
        }

        function toggleMobileMenu() {
          if (!mobileMenu || !mobileBtn) return;
          const nextOpen = !mobileMenu.classList.contains('open');
          mobileMenu.classList.toggle('open', nextOpen);
          mobileBtn.setAttribute('aria-expanded', nextOpen ? 'true' : 'false');
        }

        function setTab(tab) {
          const isSpy = tab === 'spy';
          const isStats = tab === 'stats';
          const isProducts = tab === 'products';
          const isTraffic = tab === 'traffic';
          activeMainTab = tab;
          syncMobileMenu(tab);
          closeMobileMenu();
          if (tabSpy) tabSpy.setAttribute('aria-selected', isSpy ? 'true' : 'false');
          if (tabStats) tabStats.setAttribute('aria-selected', isStats ? 'true' : 'false');
          if (tabProducts) tabProducts.setAttribute('aria-selected', isProducts ? 'true' : 'false');
          if (tabTraffic) tabTraffic.setAttribute('aria-selected', isTraffic ? 'true' : 'false');
          if (panelSpy) { panelSpy.classList.toggle('active', isSpy); panelSpy.style.display = isSpy ? '' : 'none'; }
          if (panelStats) { panelStats.classList.toggle('active', isStats); panelStats.style.display = isStats ? '' : 'none'; }
          if (panelProducts) { panelProducts.classList.toggle('active', isProducts); panelProducts.style.display = isProducts ? '' : 'none'; }
          if (panelTraffic) { panelTraffic.classList.toggle('active', isTraffic); panelTraffic.style.display = isTraffic ? '' : 'none'; }
          try { sessionStorage.setItem(TAB_KEY, tab); } catch (_) {}
          syncDateSelectOptions();
          updateNextUpdateUi();
          function ensureKpis() {
            const staleKpis = !lastKpisFetchedAt || (Date.now() - lastKpisFetchedAt) > KPI_REFRESH_MS;
            if (staleKpis) refreshKpis({ force: false });
            else renderLiveKpis(getKpiData());
          }
          if (tab === 'stats') {
            // Always refresh when entering Breakdown so tables are never stuck on "Loading..."
            refreshStats({ force: false });
            ensureKpis();
          } else if (tab === 'products') {
            refreshProducts({ force: false });
            ensureKpis();
          } else if (tab === 'traffic') {
            refreshTraffic({ force: false });
            ensureKpis();
          } else {
            const sessionStaleMs = dateRange === 'live' ? LIVE_REFRESH_MS : (dateRange === 'today' || dateRange === '1h' ? RANGE_REFRESH_MS : LIVE_REFRESH_MS);
            const staleSessions = !lastSessionsFetchedAt || (Date.now() - lastSessionsFetchedAt) > sessionStaleMs;
            if (staleSessions) fetchSessions();
            ensureKpis();
          }
        }
        let initialTab = 'spy';
        try {
          const saved = sessionStorage.getItem(TAB_KEY);
          if (saved === 'stats' || saved === 'spy' || saved === 'products' || saved === 'traffic') initialTab = saved;
        } catch (_) {}
        setTab(initialTab);
        if (tabSpy) tabSpy.addEventListener('click', function() { setTab('spy'); });
        if (tabStats) tabStats.addEventListener('click', function() { setTab('stats'); });
        if (tabProducts) tabProducts.addEventListener('click', function() { setTab('products'); });
        if (tabTraffic) tabTraffic.addEventListener('click', function() { setTab('traffic'); });
        if (mobileBtn && mobileMenu) {
          mobileBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            toggleMobileMenu();
          });
          mobileMenu.querySelectorAll('.mobile-tabs-item[data-tab]').forEach(function(btn) {
            btn.addEventListener('click', function(e) {
              e.preventDefault();
              const t = btn.getAttribute('data-tab') || 'spy';
              setTab(t);
            });
          });
          document.addEventListener('click', function(e) {
            if (!mobileMenu.classList.contains('open')) return;
            const target = e.target;
            if (mobileMenu.contains(target) || mobileBtn.contains(target)) return;
            closeMobileMenu();
          });
          document.addEventListener('keydown', function(e) {
            if (e.key !== 'Escape') return;
            closeMobileMenu();
          });
        }
      })();
      (function initRefreshBtn() {
        const btn = document.getElementById('refresh-btn');
        if (btn) {
          btn.addEventListener('click', function() {
            btn.classList.add('spinning');
            setTimeout(function() { btn.classList.remove('spinning'); }, 800);
            if (activeMainTab === 'stats') refreshStats({ force: true });
            else if (activeMainTab === 'products') refreshProducts({ force: true });
            else if (activeMainTab === 'traffic') refreshTraffic({ force: true });
            else fetchSessions();
          });
        }
      })();
      updateServerTimeDisplay();
      updateNextUpdateUi();
      setInterval(function() {
        updateServerTimeDisplay();
        updateNextUpdateUi();
      }, 1000);
    })();

    (function setupStatsCardScrollHideHeader() {
      function onScroll(wrapId, cardId) {
        const wrap = document.getElementById(wrapId);
        const card = document.getElementById(cardId);
        if (!wrap || !card) return;
        function update() {
          card.classList.toggle('scrolled', wrap.scrollTop > 0);
        }
        wrap.addEventListener('scroll', update);
        update();
      }
      onScroll('country-table-wrap', 'stats-country');
      onScroll('best-sellers-wrap', 'stats-best-sellers');
      onScroll('worst-products-wrap', 'stats-worst-products');
      onScroll('best-variants-wrap', 'stats-best-variants');
      onScroll('worst-variants-wrap', 'stats-worst-variants');
    })();

    // Load traffic source mapping + custom icons (best-effort).
    try { refreshTrafficSourceMeta({ force: false }); } catch (_) {}

    function onLiveAutoRefreshTick() {
      if (activeMainTab !== 'spy') return;
      if (dateRange !== 'live') return;
      if (document.visibilityState !== 'visible') return;
      fetchSessions();
    }

    function onRangeAutoRefreshTick() {
      if (activeMainTab !== 'spy') return;
      if (dateRange !== 'today' && dateRange !== '1h') return;
      if (document.visibilityState !== 'visible') return;
      if (Date.now() < nextRangeAt) return;
      fetchSessions();
    }

    function onStatsAutoRefreshTick() {
      if (activeMainTab !== 'stats') return;
      if (getStatsRange() !== 'today') return;
      if (document.visibilityState !== 'visible') return;
      refreshStats({ force: false });
    }

    function onKpisAutoRefreshTick() {
      if (document.visibilityState !== 'visible') return;
      refreshKpis({ force: false });
    }

    function onProductsAutoRefreshTick() {
      if (activeMainTab !== 'products') return;
      if (getStatsRange() !== 'today') return;
      if (document.visibilityState !== 'visible') return;
      refreshProducts({ force: false });
    }

    function onTrafficAutoRefreshTick() {
      if (activeMainTab !== 'traffic') return;
      if (getStatsRange() !== 'today') return;
      if (document.visibilityState !== 'visible') return;
      refreshTraffic({ force: false });
    }

    // Live: refresh every 60s. Today/Last Hour: refresh every 5 min. Breakdown/Products/Traffic: every 5 min (Today only).
    setInterval(onLiveAutoRefreshTick, LIVE_REFRESH_MS);
    setInterval(onRangeAutoRefreshTick, 60000); // check every 60s whether to refresh Today/1h (5 min interval)
    setInterval(onKpisAutoRefreshTick, KPI_REFRESH_MS);
    setInterval(onStatsAutoRefreshTick, STATS_REFRESH_MS);
    setInterval(onProductsAutoRefreshTick, STATS_REFRESH_MS);
    setInterval(onTrafficAutoRefreshTick, STATS_REFRESH_MS);
    setInterval(tickTimeOnSite, 30000);
    // Online count: when not on Live, refresh every 60s so Online always shows real people online
    setInterval(function() {
      if (activeMainTab !== 'spy' || dateRange === 'live') return;
      fetchOnlineCount();
    }, LIVE_REFRESH_MS);
    // Prune stale sessions from Live list (e.g. tab left open, no SSE update) so they drop off after 10 min or if arrived too long ago
    setInterval(function() {
      if (activeMainTab !== 'spy' || dateRange !== 'live') return;
      var cutoff = Date.now() - ACTIVE_WINDOW_MS;
      var arrivedCutoff = Date.now() - ARRIVED_WINDOW_MS;
      var before = sessions.length;
      sessions = sessions.filter(function(s) {
        return s.last_seen != null && s.last_seen >= cutoff &&
          s.started_at != null && s.started_at >= arrivedCutoff;
      });
      if (sessions.length !== before) { currentPage = 1; renderTable(); updateKpis(); }
    }, 30000);

    document.addEventListener('visibilitychange', function() {
      if (document.visibilityState !== 'visible') return;
      updateNextUpdateUi();
      refreshKpis({ force: false });
      if (activeMainTab === 'stats') {
        const stale = !lastStatsFetchedAt || (Date.now() - lastStatsFetchedAt) > STATS_REFRESH_MS;
        if (stale) refreshStats({ force: false });
      } else if (activeMainTab === 'products') {
        const staleProducts = !lastProductsFetchedAt || (Date.now() - lastProductsFetchedAt) > STATS_REFRESH_MS;
        if (staleProducts) refreshProducts({ force: false });
      } else if (activeMainTab === 'traffic') {
        const staleTraffic = !lastTrafficFetchedAt || (Date.now() - lastTrafficFetchedAt) > STATS_REFRESH_MS;
        if (staleTraffic) refreshTraffic({ force: false });
      } else {
        const sessionStaleMs = dateRange === 'live' ? LIVE_REFRESH_MS : (dateRange === 'today' || dateRange === '1h' ? RANGE_REFRESH_MS : LIVE_REFRESH_MS);
        const stale = !lastSessionsFetchedAt || (Date.now() - lastSessionsFetchedAt) > sessionStaleMs;
        if (stale) fetchSessions();
      }
    });

    // Debug: force the "new sale" toast for UI review.
    (function maybeTriggerDebugSaleToast() {
      try {
        const params = new URLSearchParams(window.location.search);
        if (params.get('birdseye_sale') !== '1') return;
        setTimeout(function() {
          try {
            triggerSaleToast({
              origin: 'debug',
              session: { country_code: 'GB', last_product_handle: 'debug-product', order_total: 53, has_purchased: 1, purchased_at: Date.now(), last_seen: Date.now(), started_at: Date.now() - 60000 },
              playSound: false,
            });
          } catch (_) {}
        }, 250);
      } catch (_) {}
    })();

    const es = new EventSource(API + '/api/stream');
    es.onmessage = (e) => {
      try {
        const msg = JSON.parse(e.data);
        if (msg.type === 'session_update' && msg.session) {
          const session = msg.session;
          // Keep footer "Last sale" correct even when not on Live tab.
          if (session && session.has_purchased && session.purchased_at != null) {
            setLastSaleAt(session.purchased_at);
          }
          if (activeMainTab !== 'spy' || dateRange !== 'live') return;
          const lastSeen = session.last_seen != null ? Number(session.last_seen) : 0;
          const startedAt = session.started_at != null ? Number(session.started_at) : 0;
          const withinActive = lastSeen >= Date.now() - ACTIVE_WINDOW_MS;
          const withinArrived = startedAt >= Date.now() - ARRIVED_WINDOW_MS;
          const idx = sessions.findIndex(s => s.session_id === session.session_id);
          let becamePurchased = false;
          let filledOrderTotal = false;
          let needRender = false;
          if (idx >= 0) {
            if (!withinActive || !withinArrived) {
              sessions.splice(idx, 1);
              needRender = true;
            } else {
              const wasPurchased = !!sessions[idx].has_purchased;
              const wasOrderTotal = sessions[idx].order_total != null;
              sessions[idx] = { ...sessions[idx], ...session };
              const nowPurchased = !!sessions[idx].has_purchased;
              const nowOrderTotal = sessions[idx].order_total != null;
              becamePurchased = (!wasPurchased && nowPurchased);
              filledOrderTotal = (nowPurchased && !wasOrderTotal && nowOrderTotal);
              sessions.sort(function(a, b) { return (b.last_seen || 0) - (a.last_seen || 0); });
              if (becamePurchased || filledOrderTotal) needRender = true;
              // Avoid a second "cha-ching" when order_total arrives after has_purchased.
              // If the toast is currently showing for this session, just patch the amount.
              if (filledOrderTotal) {
                try {
                  const sid = session && session.session_id != null ? String(session.session_id) : '';
                  if (sid && saleToastActive && saleToastSessionId && String(saleToastSessionId) === sid) {
                    const cc = session && session.country_code ? String(session.country_code).toUpperCase().slice(0, 2) : 'XX';
                    const productTitle = (session && session.last_product_handle) ? titleCaseFromHandle(String(session.last_product_handle)) : '';
                    const curTitle = document.getElementById('sale-toast-product') ? String(document.getElementById('sale-toast-product').textContent || '') : '';
                    let amountGbp = null;
                    if (session && session.order_total != null) {
                      const n = typeof session.order_total === 'number' ? session.order_total : parseFloat(String(session.order_total));
                      if (Number.isFinite(n)) amountGbp = n;
                    }
                    if (amountGbp != null && Number.isFinite(amountGbp)) {
                      setSaleToastContent({ countryCode: cc || 'XX', productTitle: (productTitle || curTitle || '—'), amountGbp });
                    }
                  }
                } catch (_) {}
              }
            }
          } else if (withinActive && withinArrived) {
            sessions.unshift(session);
            sessions.sort(function(a, b) { return (b.last_seen || 0) - (a.last_seen || 0); });
            // Don't play sound when adding a session that's already purchased (e.g. re-add after prune, or heartbeat from old sale)
            becamePurchased = false;
            needRender = true;
          }
          if (needRender) {
            if (becamePurchased) {
              currentPage = 1;
              triggerSaleToast({ origin: 'sse', session: session, playSound: true });
              // Update footer immediately when a sale happens.
              setLastSaleAt(session.purchased_at || session.last_seen || Date.now());
              // Keep the converted-count baseline in sync so KPI/stats refreshes don't double-trigger audio.
              try {
                const day = ymdNowInTz();
                if (convertedCountDayYmd == null) convertedCountDayYmd = day;
                if (day && convertedCountDayYmd !== day) {
                  convertedCountDayYmd = day;
                  hasSeenConvertedCountToday = false;
                  lastConvertedCountToday = 0;
                }
                if (hasSeenConvertedCountToday) lastConvertedCountToday = (Number(lastConvertedCountToday) || 0) + 1;
              } catch (_) {}
              try { refreshConfigStatus(); } catch (_) {}
              // Pull updated KPIs so Sales/Orders can animate after the toast fades.
              try { refreshKpis({ force: true }); } catch (_) {}
            }
            renderTable();
            updateKpis();
          }
        }
      } catch (_) {}
    };
  </script>
</body>
</html>
