<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="robots" content="noindex, nofollow" />
  <link rel="icon" type="image/png" href="/assets/favicon.png" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <title>Kexo</title>
  <link rel="stylesheet" href="/app.css" />
  <link rel="stylesheet" href="/diagnostics-modal.css" />
  <link rel="stylesheet" href="/nav.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js" defer></script>
  <script type="text/plain" id="inline-css-deprecated">
    :root {
      --bg: #fafafa;
      --card: #fff;
      --text: #333;
      --muted: #555;
      --accent: #0d9488;
      --border: #e5e5e5;
      --shadow: 0 1px 4px rgba(0, 0, 0, .06);
      --radius: 6px;
      --th-bg: #f8f8f8;
      --row-hover: #f5f5f5;
      --converted-bg: #f1f9f8;
      --converted-hover: #edf4f3;
      --returning-bg: #fff;
      --badge-new-fg: #fff;
      --badge-returning: #6366f1;
      --chip-abandoned: #dc2626;
      --side-panel-shadow: -4px 0 24px rgba(0, 0, 0, .08);
      --side-panel-sale-bg: rgba(13, 148, 136, 0.08);
      --button-hover-bg: #f0f0f0;
      --select-arrow: #333;
      /* Table: universal — one gap, one padding, one font stack for all tables at all resolutions */
      --table-gap: 15px;
      --table-cell-padding-y: 0.6rem;
      --table-cell-padding-x: 0.8rem;
      --table-font-size: 12px;
      --table-th-font-size: 13px;
      --table-header-font-size: 14px;
      --table-row-border: 1px solid var(--border);
      --online-dot-color: #4caf50;
      --link-fg: #222;
      --top-bar-divider: #eee;
    }
    * { box-sizing: border-box; }
    body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 0; min-height: 100vh; line-height: 1.5; }
    /* SVG icons: keep a consistent icon colour (match footer icons). */
    svg { color: var(--text); }
    /* Let interactive elements tint icons via their own `color` (hover/active/focus). */
    button:hover svg,
    button:focus-visible svg,
    a:hover svg,
    a:focus-visible svg,
    [role="tab"]:hover svg,
    [role="tab"][aria-selected="true"] svg { color: inherit; }
    .main { padding: 24px; margin: 0 auto; max-width: 1600px; }
    .stats-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: var(--table-gap); margin-bottom: 1.5rem; align-items: start; }
    .stats-row.breakdown-row { grid-template-columns: repeat(2, 1fr); align-items: start; }
    .breakdown-row .by-country-table tr { height: 50px; }
    /* Products tab: best-sellers full-width; type tables stay 2-col via #products-type-tables-row. */
    .traffic-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--table-gap); margin-bottom: 1.5rem; align-items: start; }
    @media (max-width: 768px) { .traffic-grid { grid-template-columns: 1fr; } }
    .stats-card { background: var(--card); padding: 0; border-radius: var(--radius); border: 1px solid var(--border); box-shadow: var(--shadow); min-width: 0; box-sizing: border-box; margin-right: -1px; }
    .stats-card:last-child { margin-right: 0; }
    #stats-country, #stats-best-geo-products, #stats-best-sellers, #stats-worst-products, #stats-best-variants, #stats-worst-variants, #stats-aov { display: flex; flex-direction: column; }
    .traffic-card-header { display: flex; align-items: center; justify-content: space-between; gap: 0.5rem; padding: var(--table-cell-padding-y) var(--table-cell-padding-x); background: var(--th-bg); border-bottom: var(--table-row-border); }
    .traffic-card-title { margin: 0; font-size: var(--table-th-font-size); font-weight: 600; color: var(--muted); text-transform: uppercase; letter-spacing: 0.04em; line-height: 1.4; }
    .traffic-picker-list { display: flex; flex-direction: column; gap: 0.25rem; }
    .traffic-picker-item { display: flex; align-items: center; gap: 0.5rem; padding: 0.15rem 0; font-size: 0.8125rem; }
    .traffic-picker-item input { width: 16px; height: 16px; }
    .traffic-picker-meta { margin-left: auto; font-size: 0.75rem; color: var(--muted); }
    /* Traffic Type: device -> platform expandable tree */
    .traffic-type-toggle { display: inline-flex; align-items: center; gap: 0.35rem; border: none; background: none; padding: 0; margin: 0; cursor: pointer; color: var(--link-fg); font: inherit; font-size: var(--table-font-size); font-weight: 600; }
    .traffic-type-toggle:hover { color: var(--accent); }
    .tt-device-icon { display: inline-flex; align-items: center; justify-content: center; color: var(--muted); flex-shrink: 0; }
    .traffic-type-parent td:first-child { white-space: nowrap; }
    .traffic-type-child td:first-child { padding-left: calc(var(--table-cell-padding-x) + 18px); }
    .traffic-type-child td:first-child::before { content: '›'; display: inline-block; margin-right: 6px; color: var(--muted); }
    /* Single thead row: title in first cell, column labels in rest; one line */
    .stats-card .by-country-table thead th { white-space: nowrap; margin: 0; padding: var(--table-cell-padding-y) var(--table-cell-padding-x); font-size: var(--table-th-font-size); font-weight: 600; color: var(--muted); text-transform: uppercase; letter-spacing: 0.04em; line-height: 1.4; text-align: left; background: var(--th-bg); border-bottom: var(--table-row-border); }
    /* When a card already has a header bar, keep only that bar grey (table thead stays white). */
    .stats-card .traffic-card-header + .country-table-wrap .by-country-table thead th { background: var(--card); }
    .stats-section { display: flex; flex-direction: column; gap: 1px; }
    .stats-main { font-size: 1.5rem; font-weight: 700; color: var(--accent); letter-spacing: -0.02em; }
    .stats-breakdown { font-size: 0.8125rem; color: var(--text); display: flex; flex-wrap: wrap; gap: 0.75rem; }
    .stats-breakdown span { display: inline-block; }
    .stats-divider { height: 1px; /* background: var(--border); */ margin: 0.6rem 0; }
    .stats-select { padding: 0.35rem 0.5rem; border: 1px solid var(--border); border-radius: var(--radius); background: var(--card); color: var(--text); font-size: 0.8125rem; }
    .muted { color: var(--muted); font-size: 0.8rem; }
    .country-table-wrap { overflow-y: auto; overflow-x: hidden; flex: 1; min-height: 0; margin-bottom: 0; }
    /* Breakdown tables: same padding/th style; border only on card so no double border */
    .by-country-table { width: 100%; border-collapse: collapse; font-size: var(--table-font-size); table-layout: fixed; border: 1px solid var(--border); box-shadow: var(--shadow); border-radius: var(--radius); overflow: hidden; }
    .stats-card .by-country-table { border: none; box-shadow: none; }
    .by-country-table th, .by-country-table td { padding: var(--table-cell-padding-y) var(--table-cell-padding-x); border-bottom: none; line-height: 1.4; }
    .by-country-table tr:last-child td { border-bottom: none; }
    .by-country-table tbody tr { box-shadow: none; }
    .by-country-table tbody tr:last-child { box-shadow: none; }
    .by-country-table tbody td { border-bottom: none !important; }
    .stats-card .by-country-table th:first-child, .stats-card .by-country-table td:first-child { padding-left: var(--table-cell-padding-x); padding-right: var(--table-cell-padding-x); min-width: 0; width: 32%; }
    .stats-card .by-country-table th:not(:first-child), .stats-card .by-country-table td:not(:first-child) { text-align: center; min-width: 4rem; white-space: nowrap; }
    .stats-card .by-country-table th:last-child, .stats-card .by-country-table td:last-child { padding-right: var(--table-cell-padding-x); min-width: 5rem; }
    .by-country-table th { font-size: var(--table-th-font-size); color: var(--muted); font-weight: 600; text-transform: uppercase; letter-spacing: 0.04em; background: var(--th-bg); }
    /* Table header abbreviations/icons on small screens (avoid overlaps). */
    .th-label-long { display: inline; }
    .th-label-short { display: none; align-items: center; justify-content: center; gap: 0.25rem; line-height: 1; }
    .th-label-short svg { width: 16px; height: 16px; display: block; }
    @media (max-width: 768px) {
      .th-label-long { display: none; }
      .th-label-short { display: inline-flex; }
      .by-country-table th.th-sort-asc::after,
      .by-country-table th.th-sort-desc::after { margin: -10px 0 0 0; }
    }
    /* First column layout: keep td as table-cell (zebra striping), flex inside wrapper. */
    .by-country-table:not(.best-sellers-table) tbody td:first-child { min-width: 0; }
    .by-country-table:not(.best-sellers-table) tbody td:first-child .country-cell { display: flex; align-items: center; gap: 0.6rem; min-width: 0; }
    .by-country-table:not(.best-sellers-table) tbody td:first-child .country-cell > *:first-child { flex-shrink: 0; }
    .by-country-table tbody td:first-child .country-label { flex: 1; min-width: 3em; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    /* Best GEO Products: flag + product thumb only. */
    .geo-products-table tbody td:first-child .country-label { flex: 0 0 auto; white-space: normal; text-overflow: clip; display: inline-flex; align-items: center; margin-left: -20px; border: 2px solid transparent; border-radius: 100px; }
    .geo-products-table tbody tr:nth-child(odd) td:first-child .country-label { background: #ffffff; }
    .geo-products-table tbody tr:nth-child(even) td:first-child .country-label { background: #f8f8f8; }
    .geo-products-table .geo-product-thumb { width: 32px; height: 32px; overflow: hidden; border: 1px solid var(--border); display: inline-flex; align-items: center; justify-content: center; background: transparent; border-radius: 100px; }
    .geo-products-table .geo-product-thumb img { width: 100%; height: 100%; object-fit: cover; display: block; border-radius: 100px; }
    .geo-products-table .geo-product-thumb-placeholder { width: 100%; height: 100%; background: var(--border); display: block; }
    .by-country-table.aov-table .country-label { overflow: visible; text-overflow: clip; white-space: normal; word-break: break-word; }
    .by-country-table.aov-table { table-layout: fixed; }
    .stats-card .by-country-table.aov-table th:first-child,
    .stats-card .by-country-table.aov-table td:first-child { width: 70%; }
    .stats-card .by-country-table.aov-table th:last-child,
    .stats-card .by-country-table.aov-table td:last-child { width: 30%; min-width: 5.5rem; }
    .by-country-table .country-name { display: inline; }
    .by-country-table .country-code { display: none; }
    .by-country-table .flag-img { width: 26px; height: 20px; object-fit: cover; border-radius: 4px; flex-shrink: 0; }
    .best-sellers-table .bs-product-col { min-width: 200px; width: auto; max-width: none; }
    .stats-card #stats-best-sellers .by-country-table th:first-child,
    .stats-card #stats-best-sellers .by-country-table td:first-child,
    .stats-card #stats-worst-products .by-country-table th:first-child,
    .stats-card #stats-worst-products .by-country-table td:first-child,
    .stats-card #stats-best-variants .by-country-table th:first-child,
    .stats-card #stats-best-variants .by-country-table td:first-child,
    .stats-card #stats-worst-variants .by-country-table th:first-child,
    .stats-card #stats-worst-variants .by-country-table td:first-child { width: 62%; min-width: 220px; }

    /* Product tables: allow numeric cols to shrink so names can breathe. */
    .stats-card .by-country-table.best-sellers-table th:not(:first-child),
    .stats-card .by-country-table.best-sellers-table td:not(:first-child) { min-width: 3.25rem; }
    .stats-card .by-country-table.best-sellers-table th:last-child,
    .stats-card .by-country-table.best-sellers-table td:last-child { min-width: 4rem; }
    /* Product name visibility: keep a stable width so text never collapses to 0 on wide screens. */
    .best-sellers-table .product-cell { display: flex; align-items: center; gap: 0.6rem; min-width: 0; width: 100%; }
    .best-sellers-table .product-cell a { display: inline-block; text-decoration: none; flex-shrink: 0; }
    /* Product thumbnails: shared styling (prevents "thin line" aspect ratios). */
    .bs-thumb, .landing-thumb { border-radius: 100%; object-fit: cover; object-position: center; flex-shrink: 0; display: block; }
    .best-sellers-table .product-cell .bs-thumb { width: 36px; height: 36px; min-width: 36px; min-height: 36px; }
    .best-sellers-table .product-cell .bs-name {
      flex: 1;
      min-width: 0;
      overflow: hidden;
      display: block;
      white-space: nowrap;
      text-overflow: ellipsis;
      line-height: 1.2;
      font-weight: 400;
      font-size: var(--table-font-size);
    }
    .best-sellers-table .thumb-wrap { width: 36px; height: 36px; }
    .best-sellers-table .bs-thumb-placeholder { position: absolute; inset: 0; width: 36px; height: 36px; background: var(--border); border-radius: 100%; }
    .best-sellers-table .product-cell .bs-thumb { position: absolute; inset: 0; }
    .by-country-table th.sortable { cursor: pointer; user-select: none; }
    .by-country-table th.sortable:hover { color: var(--accent); }
    .by-country-table th.th-sort-asc::after,
    .by-country-table th.th-sort-desc::after { content: ''; display: inline-block; width: 16px; height: 16px; margin-left: 1px; vertical-align: middle; background-color: currentColor; -webkit-mask-size: contain; -webkit-mask-repeat: no-repeat; -webkit-mask-position: center; mask-size: contain; mask-repeat: no-repeat; mask-position: center; }
    .by-country-table th.th-sort-asc::after { -webkit-mask-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 24 24' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M7 14.5L12 9.5L17 14.5' stroke='black' stroke-linecap='round' stroke-linejoin='round' stroke-width='2'/%3E%3C/svg%3E"); mask-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 24 24' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M7 14.5L12 9.5L17 14.5' stroke='black' stroke-linecap='round' stroke-linejoin='round' stroke-width='2'/%3E%3C/svg%3E"); }
    .by-country-table th.th-sort-desc::after { -webkit-mask-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 24 24' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M17 9.5L12 14.5L7 9.5' stroke='black' stroke-linecap='round' stroke-linejoin='round' stroke-width='2'/%3E%3C/svg%3E"); mask-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 24 24' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M17 9.5L12 14.5L7 9.5' stroke='black' stroke-linecap='round' stroke-linejoin='round' stroke-width='2'/%3E%3C/svg%3E"); }

    /* Medium screens */
    @media (max-width: 1200px) {
      .aov-cards-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
      .stats-card #stats-best-sellers .by-country-table th:first-child,
      .stats-card #stats-best-sellers .by-country-table td:first-child,
      .stats-card #stats-worst-products .by-country-table th:first-child,
      .stats-card #stats-worst-products .by-country-table td:first-child,
      .stats-card #stats-best-variants .by-country-table th:first-child,
      .stats-card #stats-best-variants .by-country-table td:first-child,
      .stats-card #stats-worst-variants .by-country-table th:first-child,
      .stats-card #stats-worst-variants .by-country-table td:first-child { width: 58%; min-width: 200px; }

      .stats-card .by-country-table.best-sellers-table th:not(:first-child),
      .stats-card .by-country-table.best-sellers-table td:not(:first-child) { min-width: 3rem; }
      .stats-card .by-country-table.best-sellers-table th:last-child,
      .stats-card .by-country-table.best-sellers-table td:last-child { min-width: 3.6rem; }
    }
    .aov-cards-wrap { margin-bottom: 1rem; }
    .aov-cards-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem; }
    .aov-cards-title { font-size: var(--table-header-font-size); font-weight: 600; color: var(--text); }
    .aov-cards-grid { display: grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap: var(--table-gap); }
    .aov-card { padding: 0.6rem 0.8rem; box-shadow: 2px 2px 2px #eee; display: flex; align-items: center; justify-content: space-between; gap: 0.6rem; min-width: 0; background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); }
    .aov-card-left { display: inline-flex; align-items: center; gap: 0.5rem; min-width: 0; }
    .aov-card-name { font-size: 0.85rem; font-weight: 500; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .aov-card-value { font-size: 0.9rem; font-weight: 600; color: var(--text); white-space: nowrap; }
    .aov-card-empty { justify-content: center; color: var(--muted); }
    table { width: 100%; border-collapse: collapse; background: var(--card); border-radius: var(--radius); overflow: hidden; border: 1px solid var(--border); box-shadow: var(--shadow); }
    th, td { padding: var(--table-cell-padding-y) var(--table-cell-padding-x); text-align: left; border-bottom: none; vertical-align: middle; font-size: var(--table-font-size); line-height: 1.4; }
    tr:last-child td { border-bottom: none; }
    th:not(:first-child), td:not(:first-child) { text-align: center; }
    th { background: var(--th-bg); font-size: var(--table-th-font-size); color: var(--muted); font-weight: 600; text-transform: uppercase; letter-spacing: 0.04em; }
    th:first-child, td:first-child { min-width: 80px; padding-left: var(--table-cell-padding-x); }
    tr:hover { background: inherit; }
    table tbody tr:nth-child(odd) td { background: #ffffff; }
    table tbody tr:nth-child(even) td { background: #f8f8f8; }
    tr.returning { background: var(--returning-bg); }
    tr.returning td { background: var(--returning-bg); }
    tr.converted { background: var(--converted-bg); }
    tr.converted td { background: #f1f9f8 !important; }
    tr.converted td:first-child { background: #f1f9f8 !important; box-shadow: inset 3px 0 0 #0d9488, inset 4px 0 0 #fff; }
    tr.converted:hover { background: var(--converted-bg); }
    .rev-decimal { font-size: 0.75em; opacity: 0.7; vertical-align: top; }
    tr.converted td { font-weight: 500; }
    tr.clickable { cursor: pointer; }
    .flag-cell { white-space: nowrap; }
    .arrived-cell, .last-seen-cell { font-size: var(--table-font-size); white-space: nowrap; }
    .flag-img { width: 26px; height: 20px; object-fit: cover; border-radius: 4px; margin-right: 0.35rem; vertical-align: middle; display: inline-block; }
    .last-action-cell { display: flex; align-items: center; gap: 0.5rem; }
    .last-action-cell a { color: var(--link-fg); text-decoration: none; font-size: var(--table-font-size); font-weight: 400; }
.last-action-cell a:hover { text-decoration: underline; }
.last-action-cell.dual { align-items: flex-start; }
.last-action-cell .landing-lines { display: flex; flex-direction: column; /* gap: 0.15rem; */ min-width: 0; margin: 15px 0 0; }
.last-action-cell .landing-lines > * { min-width: 0; }
.last-action-cell .landing-line { display: grid; grid-template-columns: 14px minmax(0, 1fr); align-items: center; gap: 0.35rem 0; font-size: var(--table-font-size); font-weight: 500; line-height: 1.15; color: var(--link-fg); }
.last-action-cell .landing-line-text { min-width: 0; word-break: break-word; }
    .last-action-cell .landing-dir-icon { width: 14px; height: 14px; flex-shrink: 0; margin-right: 0.35rem; display: inline-block; }
    .last-action-cell .landing-dir-icon-entry { color: #0d9488; }
    .last-action-cell .landing-dir-icon-exit { color: #940d0d; }
.last-action-cell .landing-line:hover { text-decoration: underline; }
.sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border: 0; }
.landing-fallback-hint { font-size: 0.75rem; color: var(--muted); font-weight: normal; }
    .landing-thumb { width: 50px; height: 50px; min-width: 50px; min-height: 50px; }
    .table-scroll-wrap .last-action-cell .landing-thumb { width: 50px; height: 50px; min-width: 50px; min-height: 50px; border: 1px solid #e1e1e1; padding: 3px; }
    .thumb-wrap { position: relative; display: inline-block; flex-shrink: 0; }
.thumb-wrap.thumb-stack { display: inline-flex; align-items: center; }
.thumb-wrap.thumb-stack .landing-thumb { position: relative; }
.thumb-wrap.thumb-stack .landing-thumb + .landing-thumb { margin: 20px 0 0 -20px; box-sizing: content-box; z-index: 2; background: #fff; border: 0; }
.thumb-wrap.thumb-stack .landing-thumb:first-child { z-index: 1; }
.thumb-wrap.thumb-stack .landing-thumb-exit { width: 36px; height: 36px; min-width: 36px; min-height: 36px; }

.thumb-overlay {
    display: none !important;
}

.thumb-overlay img,
.thumb-overlay svg {
    width: 25px;
    height: 25px;
    display: block;
    padding: 2px;
    position: relative;
}
.thumb-overlay svg { color: var(--accent); }
.table-title { font-size: var(--table-header-font-size); font-weight: 600; color: var(--text); margin-bottom: 0.5rem; }
    .badge { display: inline-block; padding: 0.15rem 0.4rem; border-radius: var(--radius); font-size: 0.75rem; }
    .badge.new { background: var(--accent); color: var(--badge-new-fg); }
    .badge.returning { background: var(--badge-returning); color: var(--badge-new-fg); }
    .chip { display: inline-block; padding: 0.1rem 0.35rem; border-radius: var(--radius); font-size: 0.7rem; margin-right: 0.25rem; }
    .chip.checking-out { background: var(--accent); color: var(--badge-new-fg); }
    .chip.abandoned { background: var(--chip-abandoned); color: var(--badge-new-fg); }
    .side-panel { position: fixed; top: 0; right: 0; width: 400px; max-width: 100%; height: 100%; background: var(--card); border-left: 1px solid var(--border); box-shadow: var(--side-panel-shadow); overflow-y: auto; z-index: 10; padding: 1.5rem; }
    .side-panel-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border); }
    .side-panel-title { margin: 0; font-size: 1.125rem; font-weight: 600; color: var(--text); letter-spacing: -0.02em; }
    .side-panel-close { display: inline-flex; align-items: center; justify-content: center; width: 36px; height: 36px; padding: 0; border: none; border-radius: var(--radius); background: transparent; color: var(--muted); cursor: pointer; }
    .side-panel-close:hover { color: var(--text); background: rgba(0,0,0,0.06); }
    .side-panel-close svg { width: 20px; height: 20px; }
    .side-panel-section { margin-bottom: 1.5rem; }
    .side-panel-section:last-child { margin-bottom: 0; }
    .side-panel-section-title { display: flex; align-items: center; gap: 0.5rem; margin: 0 0 0.5rem; font-size: 0.6875rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.06em; color: var(--muted); }
    .side-panel-icon { width: 16px; height: 16px; flex-shrink: 0; }
    .side-panel-events { list-style: none; padding: 0; margin: 0; font-size: 0.8125rem; line-height: 1.45; }
    .side-panel-events li { display: flex; align-items: center; gap: 0.625rem; padding: 0.5rem 0; border-bottom: 1px solid var(--border); }
    .side-panel-events li:last-child { border-bottom: none; }
    .side-panel-events li .landing-thumb { flex-shrink: 0; }
    .side-panel-events li > span:last-child { flex: 1; min-width: 0; word-break: break-word; color: var(--text); }
    .side-panel-events li.muted { color: var(--muted); }
    .side-panel-meta { font-size: 0.8125rem; line-height: 1.5; }
    .side-panel-detail-row { display: flex; flex-wrap: wrap; gap: 0.25rem 0.5rem; padding: 0.375rem 0; border-bottom: 1px solid var(--border); }
    .side-panel-detail-row:last-child { border-bottom: none; }
    .side-panel-detail-row .side-panel-label { font-weight: 500; color: var(--muted); min-width: 5rem; }
    .side-panel-detail-row .side-panel-value { color: var(--text); word-break: break-word; }
    .side-panel-sale { margin-top: 0.75rem; padding: 0.875rem; background: var(--side-panel-sale-bg); border-radius: var(--radius); border-left: 3px solid var(--accent); font-size: 0.8125rem; line-height: 1.5; color: var(--text); }
    .side-panel-sale strong { color: var(--accent); font-weight: 600; }
    .side-panel-source { font-size: 0.8125rem; color: var(--text); word-break: break-all; white-space: pre-wrap; line-height: 1.5; }
    .side-panel-cf { font-size: 0.8125rem; line-height: 1.5; }
    .side-panel-cf-block { margin-bottom: 0.75rem; }
    .side-panel-cf-block:last-child { margin-bottom: 0; }
    .side-panel-cf-subtitle { margin: 0 0 0.25rem; font-size: 0.6875rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--muted); }
    .side-panel-cf .cf-row { padding: 0.25rem 0; word-break: break-word; color: var(--text); }
    .side-panel-cf .cf-row.empty { color: var(--muted); }
    .side-panel-cf .cf-row strong { font-weight: 500; color: var(--muted); margin-right: 0.35rem; }
    .empty { padding: 1.5rem 1rem; color: var(--muted); font-size: var(--table-font-size); }
    .consent-debug { font-size: 0.75rem; color: var(--muted); max-width: 200px; overflow: hidden; text-overflow: ellipsis; }
.dashboard-top-bar { display: flex; align-items: center; justify-content: space-between; padding: 10px 24px 0; margin: 0 auto; width: 100%; box-sizing: border-box; }
.mobile-brand-logo { display: none; width: 100%; justify-content: center; pointer-events: none; }
.mobile-brand-logo img { width: 80px; height: auto; display: block; }
.next-update-timer { display: inline-flex; align-items: center; justify-content: center; width: 18px; height: 18px; }
.next-update-timer .next-update-circle { display: block; }
.next-update-timer .next-update-circle-bg { opacity: 0.2; }
.next-update-timer .next-update-circle-progress { stroke: #0d9488; transition: stroke-dashoffset 0.3s linear; }
.server-time-block { font-size: 0.8125rem; color: var(--muted); white-space: nowrap; margin: 0 5px 0 0; }
.server-time-tz { font-size: 0.7rem; opacity: 0.9; margin-left: 0.2rem; }
.top-bar-divider { width: 1px; height: 1.2em; background: var(--top-bar-divider); flex-shrink: 0; }
.refresh-btn { display: inline-flex; align-items: center; justify-content: center; width: 15px; height: 15px; padding: 0; border: none; background: none; cursor: pointer; color: var(--text); }
.refresh-btn:hover { color: var(--accent); }
.refresh-btn:focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; }
.refresh-btn svg { width: 15px; height: 15px; }
.refresh-btn.spinning svg { animation: refresh-spin 0.8s linear; }
@keyframes refresh-spin { to { transform: rotate(360deg); } }
.top-bar-date-select { padding: 0.35rem 1.5rem 0.35rem 0.5rem; border: none; background: none; font-size: 0.875rem; font-weight: 500; color: var(--text); cursor: pointer; font-family: inherit; appearance: none; background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 24 24' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M17 9.5L12 14.5L7 9.5' stroke='%23666' stroke-linecap='round' stroke-linejoin='round' stroke-width='2'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 0.25rem center; background-size: 16px 16px; border-radius: var(--radius); }
.top-bar-date-select:hover { color: var(--accent); }
.top-bar-date-select:focus { outline: none; color: var(--accent); }
.top-bar-date-select option { color: var(--text); background: var(--card); }
.next-update-block { display: inline-flex; align-items: center; gap: 0.35rem; font-size: 0.875rem; color: var(--muted); }
.live-tab-dot { display: none; width: 7px; height: 7px; border-radius: 50%; background: var(--accent); margin-right: 0.3rem; flex-shrink: 0; }
#table-tab-live[aria-selected="true"] .live-tab-dot { display: inline-block; animation: live-tab-pulse 2.4s ease-in-out infinite; }
@keyframes live-tab-pulse { 0% { opacity: 0.45; transform: scale(0.9); } 50% { opacity: 1; transform: scale(1); } 100% { opacity: 0.45; transform: scale(0.9); } }
.table-loading-overlay { position: absolute; inset: 0; background: rgba(255,255,255,0.7); display: flex; align-items: center; justify-content: center; border-radius: var(--radius); z-index: 2; }
.table-loading-overlay .spinner { width: 28px; height: 28px; border: 3px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: refresh-spin 0.8s linear infinite; }
.inline-spinner { width: 28px; height: 28px; border: 3px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: refresh-spin 0.8s linear infinite; display: inline-block; }
.table-loading-overlay.report-loading-overlay {
  position: fixed;
  inset: auto;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: min(420px, calc(100vw - 32px));
  height: auto;
  border-radius: 14px;
  background: rgba(255,255,255,0.92);
  border: 1px solid rgba(0,0,0,0.08);
  box-shadow: var(--shadow);
  z-index: 200;
  pointer-events: none;
}
.table-loading-overlay.report-loading-overlay .report-build-wrap { padding: 0.9rem 1rem; gap: 0.25rem; }
@media (max-width: 768px) {
  .table-loading-overlay.report-loading-overlay { top: 50%; }
}
.report-loading-overlay { background: rgba(255,255,255,0.96); }
.report-build-wrap { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 0.35rem; padding: 1rem; text-align: center; }
.report-build-title { font-size: 0.95rem; font-weight: 700; color: var(--accent); letter-spacing: -0.1px; }
.report-build-step { font-size: 0.85rem; color: var(--muted); min-height: 1.2em; }
/* Tab switch: Home (main table) vs Breakdown (cards); date range shared on same row */
.main-tabs { display: flex; align-items: stretch; gap: 0; margin-bottom: 1rem; border-bottom: 1px solid var(--border); position: relative; }
.main-tabs [role="tab"] { display: inline-flex; align-items: center; gap: 0.35rem; padding: 0.5rem 1rem; font-size: 0.875rem; font-weight: 500; color: var(--muted); background: none; border: none; border-bottom: 2px solid transparent; margin-bottom: -1px; cursor: pointer; font-family: inherit; }
.main-tabs [role="tab"]:hover { color: var(--text); }
.main-tabs [role="tab"][aria-selected="true"] { color: var(--accent); border-bottom-color: var(--accent); }
.main-tabs [role="tab"] .tab-icon { width: 16px; height: 16px; display: inline-block; vertical-align: middle; }
.main-tabs [role="tab"] .tab-icon-home { width: 25px; height: 25px; object-fit: contain; }
.main-tabs [role="tab"] .tab-icon-home-swap { position: relative; width: 25px; height: 25px; display: inline-block; flex-shrink: 0; }
.main-tabs [role="tab"] .tab-icon-home-swap img { position: absolute; inset: 0; width: 25px; height: 25px; object-fit: contain; display: block; }
#tab-dashboard .tab-icon-home--inactive { opacity: 1; }
#tab-dashboard .tab-icon-home--active { opacity: 0; }
#tab-dashboard[aria-selected="true"] .tab-icon-home--inactive { opacity: 0; }
#tab-dashboard[aria-selected="true"] .tab-icon-home--active { opacity: 1; }
.main-tabs [role="tab"] .tab-text { display: inline; }
@media (min-width: 769px) { #tab-dashboard .tab-text { display: none; } }
.main-tabs-center-logo { display: none; position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); pointer-events: none; z-index: 2; }
.main-tabs-center-logo img { width: 30px; height: 30px; margin: 0 0 10px; display: block; object-fit: contain; }
.main-tabs-spacer { flex: 1; min-width: 0; }
.main-tabs-date-select { padding: 0.35rem 1.5rem 0.35rem 0.5rem; border: none; background: none; font-size: 0.875rem; font-weight: 500; color: var(--text); cursor: pointer; font-family: inherit; appearance: none; background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 24 24' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M17 9.5L12 14.5L7 9.5' stroke='%23666' stroke-linecap='round' stroke-linejoin='round' stroke-width='2'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 0.25rem center; background-size: 16px 16px; border-radius: var(--radius); margin-bottom: -1px; }
.main-tabs-date-select:hover { color: var(--accent); }
.main-tabs-date-select:focus { outline: none; color: var(--accent); }
.main-tabs-date-select option { color: var(--text); background: var(--card); }
.mobile-date-btn {
    display: none;
    align-items: center;
    justify-content: space-between;
    gap: 0.45rem;
    padding: 10px 0;
    border: none;
    border-radius: var(--radius);
    background: none;
    cursor: pointer;
    color: var(--text);
    font-size: 0.875rem;
    font-weight: 500;
    max-width: 55px;
    width: 55px;
    flex: 0 0 auto;
}
.mobile-date-btn:hover { color: var(--accent); }
.mobile-date-btn svg { width: 18px; height: 18px; display: block; flex-shrink: 0; }
.mobile-date-menu { display: none; position: absolute; right: 0; top: calc(100% + 6px); background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); box-shadow: var(--shadow); padding: 0.25rem; z-index: 50; min-width: 160px; }
.mobile-date-menu.open { display: block; }
.mobile-date-item { width: 100%; text-align: left; padding: 0.5rem 0.75rem; border: none; background: none; cursor: pointer; font-size: 0.875rem; color: var(--text); border-radius: var(--radius); font-family: inherit; }
.mobile-date-item:hover { background: var(--row-hover); }
.mobile-date-item[aria-current="true"] { background: rgba(13, 148, 136, 0.12); color: var(--accent); }
.mobile-tabs-btn {
    display: none;
    align-items: center;
    gap: 0.5rem;
    padding: 10px 0;
    border: none;
    border-radius: var(--radius);
    background: none;
    cursor: pointer;
    color: var(--text);
    font-size: 0.875rem;
    font-weight: 500;
}
.mobile-tabs-btn:hover { color: var(--accent); }
.mobile-tabs-btn svg { width: 18px; height: 18px; display: block; }
.mobile-tabs-menu { display: none; position: absolute; left: 0; top: calc(100% + 6px); background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); box-shadow: var(--shadow); padding: 0.25rem; z-index: 50; min-width: 180px; }
.mobile-tabs-menu.open { display: block; }
.mobile-tabs-item { width: 100%; text-align: left; padding: 0.5rem 0.75rem; border: none; background: none; cursor: pointer; font-size: 0.875rem; color: var(--text); border-radius: var(--radius); font-family: inherit; }
.mobile-tabs-item:hover { background: var(--row-hover); }
.mobile-tabs-item[aria-current="true"] { background: rgba(13, 148, 136, 0.12); color: var(--accent); }
@media (max-width: 768px) {
  .main-tabs { gap: 0.5rem; }
  .main-tabs [role="tab"] { display: none; }
  .mobile-tabs-btn { display: inline-flex; }
  .main-tabs-center-logo { display: block; }
  .main-tabs-date-select { display: none; }
  .mobile-date-btn { display: inline-flex; }
}
.main-tab-panel { display: none; }
.main-tab-panel.active { display: block; }
.stats-row-wrap { position: relative; }
.stats-row-wrap.report-building > :not(.report-loading-overlay) { display: none !important; }
.sessions-table-wrap { position: relative; }
.live-kpi-grid { --kpi-gap: 1rem; display: grid; grid-template-columns: repeat(6, minmax(150px, 1fr)); gap: var(--kpi-gap); }
.live-kpi-cell { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); padding: 0.75rem 1rem; text-align: center; box-shadow: var(--shadow); }
    .live-kpi-cell .live-kpi-label { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.04em; color: #000; font-weight: 600; margin-bottom: 0.25rem; }
    .live-kpi-cell .live-kpi-value { font-size: 1.2rem; font-weight: 700; color: #444; line-height: 1.3; }
.live-kpi-cell .kpi-delta-icon { display: inline-flex; align-items: center; margin-left: 3px; width: 1em; height: 1em; vertical-align: middle; }
.live-kpi-cell .kpi-delta-icon svg { width: 100%; height: 100%; display: block; }
.live-kpi-cell .kpi-delta-icon.kpi-delta-icon-down { transform: rotate(90deg); }
.kpi-mini-spinner { width: 14px; height: 14px; border: 2px solid rgba(13, 148, 136, 0.25); border-top-color: #0d9488; border-radius: 50%; animation: refresh-spin 0.8s linear infinite; display: inline-block; vertical-align: middle; }
.sale-toast-host { position: relative; overflow: visible; }
.sale-toast-host.toast-open { z-index: 10; }
.sale-toast { position: absolute; left: -1px; top: -1px; height: calc(100% + 2px); width: calc(200% + var(--kpi-gap) + 3px); border-radius: var(--radius); border: 1px solid #0d9488; background: #0d9488; display: flex; align-items: stretch; gap: 0.75rem; padding: 0.65rem 2.25rem 0.65rem 0.75rem; opacity: 0; transform: translateY(6px); transition: opacity 240ms ease, transform 240ms ease; pointer-events: none; color: #fff; }
.sale-toast.active { opacity: 1; transform: translateY(0); }
.sale-toast .sale-toast-flag { display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
.sale-toast .sale-toast-flag .sale-toast-bird-icon { width: 30px; height: 100%; object-fit: contain; border-radius: 6px; display: block; margin: 0 0 5px; }
.sale-toast .sale-toast-mid { flex: 1; min-width: 0; display: flex; flex-direction: column; justify-content: center; text-align: left; }
    .sale-toast .sale-toast-title { display: flex; align-items: center; gap: 0.35rem; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.04em; color: #fff; font-weight: 500; line-height: 1.1; }
.sale-toast .sale-toast-inline-flag-img { width: 20px; height: 15px; object-fit: cover; border-radius: 4px; display: block; margin: -1px 0 0; flex-shrink: 0; }
    .sale-toast .sale-toast-product { font-size: 0.86rem; font-weight: 300; color: #fff; line-height: 1.25; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding: 5px 0 0 0; }
    .sale-toast .sale-toast-amount-wrap { min-width: 90px; display: flex; align-items: center; justify-content: flex-end; background: #088378; padding: 0 15px 0 0; border-radius: 4px; position: absolute; top: 0; right: 0; height: -webkit-fill-available; }
    .sale-toast .sale-toast-amount { display: inline-flex; align-items: center; justify-content: flex-end; font-size: 1.05rem; font-weight: 800; color: #fff; letter-spacing: -0.2px; }
.sale-toast .sale-toast-close { position: absolute; top: -5px; right: -5px; width: 25px; height: 25px; border: 2px solid #0d9488; background: #0d9488; color: #fff; border-radius: 100px; padding: 0; display: inline-flex; align-items: center; justify-content: center; cursor: pointer; pointer-events: auto; z-index: 3; }
.sale-toast .sale-toast-close:active { transform: translateY(1px); }
.sale-toast .sale-toast-close:focus-visible { outline: 2px solid rgba(255, 255, 255, 0.6); outline-offset: 2px; }
.sale-toast .sale-toast-close svg { width: 16px; height: 16px; display: block; }
.kpi-ticker { display: inline-block; overflow: hidden; height: 1.15em; vertical-align: bottom; }
.kpi-ticker-stack { display: block; transform: translateY(0); transition: transform 420ms cubic-bezier(0.22, 1, 0.36, 1); }
.kpi-ticker-line { display: block; height: 1.15em; line-height: 1.15em; }
.kpi-ticker.run .kpi-ticker-stack { transform: translateY(-100%); }
.shared-kpi-wrap { margin-bottom: 1.25rem; }
    .kpi-mobile-pager { position: relative; overflow-x: auto; -webkit-overflow-scrolling: touch; scrollbar-width: none; -ms-overflow-style: none; }
    .kpi-mobile-pager::-webkit-scrollbar { display: none; }
    .kpi-mobile-pager.kpi-pager-active { padding-right: 44px; }
    .kpi-mobile-next {
      display: none;
      position: absolute;
      right: 0;
      top: 50%;
      transform: translateY(-50%);
      width: 36px;
      height: 36px;
      align-items: center;
      justify-content: center;
      border: 1px solid var(--border);
      border-radius: 999px;
      background: var(--card);
      color: var(--text);
      cursor: pointer;
      box-shadow: var(--shadow);
    }
    .kpi-mobile-next:hover { color: var(--accent); border-color: rgba(13, 148, 136, 0.55); }
    .kpi-mobile-next:focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; }
    .kpi-mobile-next svg { width: 18px; height: 18px; display: block; }
@media (max-width: 768px) {
  .kpi-mobile-pager { overflow-x: auto; -webkit-overflow-scrolling: touch; scrollbar-width: none; -ms-overflow-style: none; }
  .kpi-mobile-pager::-webkit-scrollbar { display: none; }
  .live-kpi-grid { --kpi-gap: 0.5rem; display: flex; gap: var(--kpi-gap); }
  .live-kpi-cell { min-width: 150px; flex: 0 0 auto; }
  .live-kpi-cell .live-kpi-value { font-size: 1rem; }
}
.live-view-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; gap: 0; }
.live-view-header .table-title { margin: 0; font-size: var(--table-header-font-size); font-weight: 500; color: var(--text); flex-shrink: 0; display: flex; align-items: center; gap: 0.35rem; letter-spacing: -0.1px; }
.table-title-tabs { display: inline-flex; align-items: center; gap: 0; flex-wrap: wrap; }
.table-title-tabs button { padding: 0.2rem 0.5rem; margin: 0; border: none; background: none; font-size: inherit; font-weight: 500; color: var(--muted); cursor: pointer; border-radius: var(--radius); display: inline-flex; align-items: center; }
.table-title-tabs button:hover { color: var(--text); }
.table-title-tabs button[aria-selected="true"] { color: var(--accent); font-weight: 600; }
.table-title-tabs-sep { margin: 0 0.35rem; color: var(--border); font-weight: 400; user-select: none; }
.table-title-label { display: inline; }
.live-view-header .live-view-online { flex-shrink: 0; }
.live-view-header .next-update-block { flex-shrink: 0; }
.live-view-header .live-view-next-update-center { flex: 1; display: flex; justify-content: center; }
.live-view-online { font-size: 0.875rem; color: var(--muted); display: flex; align-items: center; gap: 0.35rem; margin-right: 10px; }
.live-view-online .online-user-icon { width: 16px; height: 16px; flex-shrink: 0; display: block; }
.live-view-online .online-count-wrap { display: inline-flex; align-items: center; gap: 0.35rem; }
.mini-spinner { width: 12px; height: 12px; border: 2px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: refresh-spin 0.8s linear infinite; display: inline-block; }
.live-view-online strong {
    color: #333;
    font-size: 16px;
    line-height: 15px;
    vertical-align: middle;
    padding: 2px 0 0 0;
}
.dashboard-top-bar select:not(.top-bar-date-select) { padding: 0.5rem 0.75rem; border: 1px solid var(--border); border-radius: var(--radius); background: var(--card); font-size: 0.875rem; color: var(--text); appearance: none; background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 24 24' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M17 9.5L12 14.5L7 9.5' stroke='%23333' stroke-linecap='round' stroke-linejoin='round' stroke-width='2'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 0.5rem center; background-size: 16px 16px; padding-right: 1.75rem; }
.dashboard-top-bar select option:disabled { color: var(--muted); }
#audio-mute-btn { display: inline-flex; align-items: center; justify-content: center; width: 20px; height: 20px; padding: 0; border: none; background: none; cursor: pointer; color: var(--text); }
#audio-mute-btn:hover { color: var(--accent); }
#audio-mute-btn:focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; }
#audio-mute-btn.muted { opacity: 0.6; color: var(--muted); }
#audio-mute-btn svg { width: 20px; height: 20px; }
.table-scroll-wrap { overflow-x: auto; -webkit-overflow-scrolling: touch; margin-bottom: 0.75rem; border-radius: var(--radius); border: 1px solid var(--border); }
.table-scroll-wrap.tight-cols { --table-cell-padding-x: 0.6rem; }
.table-scroll-wrap table { margin: 0; width: max(100%, 800px); table-layout: auto; border: none; box-shadow: none; }
.table-scroll-wrap th, .table-scroll-wrap td { border-bottom: none; padding: var(--table-cell-padding-y) var(--table-cell-padding-x); }
    .table-scroll-wrap tr:last-child td { border-bottom: none; }
.table-scroll-wrap th:nth-child(1), .table-scroll-wrap td:nth-child(1) { width: 1%; min-width: 240px; text-align: left; }
.table-scroll-wrap .last-action-cell { min-width: 60px; }
.table-scroll-wrap .last-action-cell .landing-thumb { flex-shrink: 0; }
.table-scroll-wrap th:nth-child(2), .table-scroll-wrap td:nth-child(2) { min-width: 56px; }
.table-scroll-wrap th.source-cell, .table-scroll-wrap td.source-cell { min-width: 90px; max-width: 160px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.table-scroll-wrap th.cart-value-cell, .table-scroll-wrap td.cart-value-cell { width: 1%; min-width: 4.5rem; max-width: 6rem; white-space: nowrap; }
.table-scroll-wrap .last-action-cell { min-width: 100px; max-width: none; }
.table-scroll-wrap .last-action-cell a { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 100%; display: inline-block; }
.table-scroll-wrap .cart-value-sale { color: var(--accent); font-weight: 600; }
.table-scroll-wrap th.sortable { cursor: pointer; user-select: none; }
.table-scroll-wrap th.sortable:hover { color: var(--accent); }
.table-scroll-wrap th.th-sort-asc::after,
.table-scroll-wrap th.th-sort-desc::after { content: ''; display: inline-block; width: 16px; height: 16px; margin-left: 6px; vertical-align: middle; background-color: currentColor; -webkit-mask-size: contain; -webkit-mask-repeat: no-repeat; -webkit-mask-position: center; mask-size: contain; mask-repeat: no-repeat; mask-position: center; }
.table-scroll-wrap th.th-sort-asc::after { -webkit-mask-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 24 24' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M7 14.5L12 9.5L17 14.5' stroke='black' stroke-linecap='round' stroke-linejoin='round' stroke-width='2'/%3E%3C/svg%3E"); mask-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 24 24' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M7 14.5L12 9.5L17 14.5' stroke='black' stroke-linecap='round' stroke-linejoin='round' stroke-width='2'/%3E%3C/svg%3E"); }
.table-scroll-wrap th.th-sort-desc::after { -webkit-mask-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 24 24' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M17 9.5L12 14.5L7 9.5' stroke='black' stroke-linecap='round' stroke-linejoin='round' stroke-width='2'/%3E%3C/svg%3E"); mask-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 24 24' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M17 9.5L12 14.5L7 9.5' stroke='black' stroke-linecap='round' stroke-linejoin='round' stroke-width='2'/%3E%3C/svg%3E"); }
.table-scroll-wrap .arrived-cell, .table-scroll-wrap .last-seen-cell { min-width: 4.5rem; }
.table-pagination {
  display: flex;
  align-items: center;
  justify-content: center;
  flex-wrap: wrap;
  gap: 0;
  padding: 0.75rem 0 1.25rem;
  font-size: 0.875rem;
  color: var(--muted);
}
.table-pagination .pagination-segments {
  display: inline-flex;
  align-items: stretch;
  justify-content: center;
  flex-wrap: nowrap;
}
.table-pagination .pagination-segments > * + * { border-left: none; }
.table-pagination .pagination-segments > :first-child { border-radius: 4px 0 0 4px; }
.table-pagination .pagination-segments > :last-child { border-radius: 0 4px 4px 0; }
.table-pagination button {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 0.4rem;
  padding: 0.42rem 0.75rem;
  border: 1px solid var(--border);
  border-radius: 0;
  background: rgba(255, 255, 255, 0.85);
  box-shadow: none;
  color: var(--text);
  cursor: pointer;
  font-size: 0.875rem;
  font-weight: 650;
  line-height: 1;
  transition: background 160ms ease, border-color 160ms ease, color 160ms ease, box-shadow 160ms ease, opacity 160ms ease;
}
.table-pagination button:focus-visible { outline: 2px solid rgba(13, 148, 136, 0.6); outline-offset: 2px; }
.table-pagination button:hover:not(:disabled) { border-color: rgba(13, 148, 136, 0.45); background: rgba(13, 148, 136, 0.08); color: var(--accent); }
.table-pagination button:active:not(:disabled) { box-shadow: 0 0 0 rgba(0,0,0,0); }
.table-pagination button:disabled { opacity: 0.45; cursor: not-allowed; box-shadow: none; transform: none; }

.table-pagination button#pagination-prev::before,
.card-pagination button[id$="-prev"]::before,
.table-pagination button#pagination-next::after,
.card-pagination button[id$="-next"]::after {
  content: '';
  display: inline-block;
  width: 16px;
  height: 16px;
  background-color: currentColor;
  -webkit-mask-size: contain;
  -webkit-mask-repeat: no-repeat;
  -webkit-mask-position: center;
  mask-size: contain;
  mask-repeat: no-repeat;
  mask-position: center;
  opacity: 0.9;
}
.table-pagination button#pagination-prev::before,
.card-pagination button[id$="-prev"]::before {
  -webkit-mask-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 24 24' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M15 18l-6-6 6-6' stroke='black' stroke-linecap='round' stroke-linejoin='round' stroke-width='2'/%3E%3C/svg%3E");
  mask-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 24 24' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M15 18l-6-6 6-6' stroke='black' stroke-linecap='round' stroke-linejoin='round' stroke-width='2'/%3E%3C/svg%3E");
}
.table-pagination button#pagination-next::after,
.card-pagination button[id$="-next"]::after {
  -webkit-mask-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 24 24' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M9 6l6 6-6 6' stroke='black' stroke-linecap='round' stroke-linejoin='round' stroke-width='2'/%3E%3C/svg%3E");
  mask-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 24 24' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M9 6l6 6-6 6' stroke='black' stroke-linecap='round' stroke-linejoin='round' stroke-width='2'/%3E%3C/svg%3E");
}

.table-pagination #pagination-label {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 0.38rem 0.85rem;
  border: 1px solid var(--border);
  border-radius: 0;
  background: rgba(255, 255, 255, 0.85);
  box-shadow: none;
  color: var(--muted);
  font-weight: 600;
  font-variant-numeric: tabular-nums;
}
.table-pagination #rows-per-page-wrap { display: none !important; }
.table-pagination #rows-per-page-wrap .muted {
  font-size: 0.72rem;
  letter-spacing: 0.06em;
  text-transform: uppercase;
  color: var(--muted);
}
@media (max-width: 768px) {
  .table-pagination #rows-per-page-wrap .muted { display: none; }
}
.table-pagination #rows-per-page-select {
  border: none;
  background: none;
  padding: 0.2rem 1.25rem 0.2rem 0.25rem;
  font-size: 0.8125rem;
  font-weight: 650;
  color: var(--text);
  cursor: pointer;
  font-family: inherit;
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 24 24' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M17 9.5L12 14.5L7 9.5' stroke='%23666' stroke-linecap='round' stroke-linejoin='round' stroke-width='2'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 0.2rem center;
  background-size: 16px 16px;
}
.table-pagination #rows-per-page-wrap:focus-within { border-color: rgba(13, 148, 136, 0.5); box-shadow: 0 0 0 3px rgba(13, 148, 136, 0.12); position: relative; z-index: 1; }
.table-pagination #rows-per-page-select:hover { color: var(--accent); }
.table-pagination #rows-per-page-select:focus { outline: none; }

.card-pagination {
  display: none;
  align-items: center;
  justify-content: center;
  flex-wrap: wrap;
  gap: 0;
  padding: 0.65rem 0.75rem;
  background: rgba(255, 255, 255, 0.7);
  border-top: 1px solid var(--border);
  font-size: 0.8125rem;
  color: var(--muted);
  border-radius: 0 0 var(--radius) var(--radius);
  -webkit-backdrop-filter: blur(8px);
  backdrop-filter: blur(8px);
}
.card-pagination button {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 0;
  padding: 0 10px;
  height: 30px;
  border: 1px solid var(--border);
  border-radius: 0;
  background: rgba(255, 255, 255, 0.9);
  box-shadow: none;
  color: var(--text);
  cursor: pointer;
  font-size: 0.8125rem;
  font-weight: 650;
  line-height: 1;
  transition: background 160ms ease, border-color 160ms ease, color 160ms ease, box-shadow 160ms ease, opacity 160ms ease;
}
.card-pagination button:hover:not(:disabled) { border-color: rgba(13, 148, 136, 0.45); background: rgba(13, 148, 136, 0.08); color: var(--accent); }
.card-pagination button:active:not(:disabled) { box-shadow: 0 0 0 rgba(0,0,0,0); }
.card-pagination button:disabled { opacity: 0.45; cursor: not-allowed; box-shadow: none; transform: none; }
.card-pagination .page-label {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  /* padding: 10px; */
  height: 30px;
  border: 1px solid var(--border);
  border-radius: 0;
  background: rgba(255, 255, 255, 0.82);
  box-shadow: none;
  min-width: 104px;
  text-align: center;
  font-variant-numeric: tabular-nums;
  color: var(--muted);
  font-weight: 600;
}
.card-pagination button[id$="-prev"] { border-radius: 4px 0 0 4px; }
.card-pagination button[id$="-next"] { border-radius: 0 4px 4px 0; }
.card-pagination .page-label,
.card-pagination button[id$="-next"] { border-left: none; }
    .source-googleads-img, .source-icon-img { width: 20px; height: 20px; vertical-align: middle; display: inline-block; }
    .source-icons { display: inline-flex; align-items: center; gap: 4px; }
    .source-icons img { width: 20px; height: 20px; }
    .traffic-source-cell { display: inline-flex; align-items: center; gap: 0.5rem; min-width: 0; }
    .traffic-source-label { font-weight: 650; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 220px; }
    @media (max-width: 1800px) {
      .stats-row { display: grid; grid-template-columns: 1fr 1fr; gap: var(--table-gap); }
      .stats-card { min-width: 0; }
      .stats-card #stats-best-sellers .by-country-table th:first-child,
      .stats-card #stats-best-sellers .by-country-table td:first-child,
      .stats-card #stats-worst-products .by-country-table th:first-child,
      .stats-card #stats-worst-products .by-country-table td:first-child,
      .stats-card #stats-best-variants .by-country-table th:first-child,
      .stats-card #stats-best-variants .by-country-table td:first-child,
      .stats-card #stats-worst-variants .by-country-table th:first-child,
      .stats-card #stats-worst-variants .by-country-table td:first-child { min-width: 200px; }
    }
    @media (max-width: 768px) {
      .aov-cards-grid { grid-template-columns: 1fr; }
      .dashboard-top-bar { padding-left: 20px; padding-right: 20px; }
      .mobile-brand-logo { display: flex; }
      .main { padding: 20px; }
      .stats-row { grid-template-columns: 1fr; gap: var(--table-gap); margin-bottom: 1.25rem; }
      .stats-row.breakdown-row { grid-template-columns: 1fr; }
      .stats-card { min-width: 100%; padding: 0; }
      .stats-card:first-child { min-width: 100%; }
      .stats-card #stats-best-sellers .by-country-table th:first-child,
      .stats-card #stats-best-sellers .by-country-table td:first-child,
      .stats-card #stats-worst-products .by-country-table th:first-child,
      .stats-card #stats-worst-products .by-country-table td:first-child,
      .stats-card #stats-best-variants .by-country-table th:first-child,
      .stats-card #stats-best-variants .by-country-table td:first-child,
      .stats-card #stats-worst-variants .by-country-table th:first-child,
      .stats-card #stats-worst-variants .by-country-table td:first-child { width: 55%; min-width: 140px; }
      .stats-main { font-size: 1.35rem; }
      .stats-breakdown { gap: 0.5rem; font-size: 0.75rem; }
      .live-view-header .table-title { font-size: var(--table-header-font-size); }
      .table-title { font-size: var(--table-header-font-size); margin-bottom: 0.35rem; }
      .live-view-header .next-update-block { display: inline-flex; }
      .live-view-header .live-view-next-update-center { flex: 0; }
      .next-update-label { display: none !important; }
      #table-tab-sales, #table-tab-sep-today-sales, #table-tab-sep-sales-live { display: none !important; }
      .table-scroll-wrap { margin-left: 0; margin-right: 0; border-radius: var(--radius); -webkit-overflow-scrolling: touch; overflow-x: auto; }
      .side-panel { width: 100%; padding: 1rem; }
      .side-panel-close { min-width: 44px; min-height: 44px; }
      .last-action-cell a { display: none; }
      .last-action-cell .landing-lines a { display: grid; }
      .last-action-cell .landing-lines { margin-top: 0.35rem; }
      .landing-thumb { width: 32px; height: 32px; }
      .thumb-wrap.thumb-stack .landing-thumb-exit { width: 24px; height: 24px; min-width: 24px; min-height: 24px; }
    }
    @media (max-width: 480px) {
      .dashboard-top-bar { padding-left: 20px; padding-right: 20px; }
      .main { padding: 20px; }
      .stats-card { padding: 0; }
    }
    .dashboard-footer { position: fixed; bottom: 0; left: 0; right: 0; z-index: 5; display: flex; align-items: center; justify-content: center; gap: 20px; flex-wrap: wrap; padding: 10px 20px; font-size: 0.8125rem; color: var(--muted); background: #eee; }
    body { padding-bottom: 52px; }
    .dashboard-footer .footer-last-sale { white-space: nowrap; }
    .dashboard-footer .refresh-btn,
    .dashboard-footer #audio-mute-btn,
    .dashboard-footer .config-btn { flex-shrink: 0; }

    .config-btn { display: inline-flex; align-items: center; justify-content: center; width: 18px; height: 18px; padding: 0; border: 1px solid var(--border); border-radius: 999px; background: var(--card); cursor: pointer; color: var(--text); font-size: 12px; line-height: 1; }
    .config-btn svg { display: block; width: 18px; height: 18px; }
        .config-btn:hover { color: var(--accent); }
    .config-btn:focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; }
    .config-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.35); display: none; align-items: center; justify-content: center; padding: 1rem; z-index: 9999; }
    .config-modal.open { display: flex; }
    .config-modal-card { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); box-shadow: var(--shadow); width: 560px; max-width: 100%; max-height: 80vh; overflow: auto; padding: 1rem; }
    .config-modal-header { display: flex; align-items: center; justify-content: space-between; gap: 0.75rem; margin-bottom: 0.75rem; }
    .config-modal-title { margin: 0; font-size: 0.75rem; font-weight: 600; color: var(--muted); text-transform: uppercase; letter-spacing: 0.04em; }
    .config-modal-actions { display: flex; align-items: center; gap: 0.45rem; }
    .config-close { border: none; background: none; cursor: pointer; font-size: 1.25rem; line-height: 1; color: var(--muted); }
    .config-close:hover { color: var(--accent); }
    .config-refresh-btn.spinning svg { animation: refresh-spin 0.8s linear infinite; }
    .config-reconcile-btn.spinning svg { animation: refresh-spin 0.8s linear infinite; }

    .date-cal { display: grid; gap: 1rem; }
    .date-cal-month { border: 1px solid var(--border); border-radius: var(--radius); padding: 0.75rem; background: rgba(255,255,255,0.6); }
    .date-cal-month-title { font-size: 0.8125rem; font-weight: 700; color: var(--text); margin: 0 0 0.5rem; }
    .date-cal-weekdays, .date-cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 0.25rem; }
    .date-cal-weekday { font-size: 0.7rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.04em; text-align: center; padding: 0.15rem 0; }
    .date-cal-spacer { height: 32px; }
    .date-cal-day { border: 1px solid var(--border); border-radius: 8px; background: var(--card); color: var(--text); cursor: pointer; padding: 0.4rem 0; font-size: 0.85rem; font-weight: 600; text-align: center; }
    .date-cal-day:hover { border-color: rgba(13, 148, 136, 0.6); color: var(--accent); }
    .date-cal-day[disabled], .date-cal-day.disabled { opacity: 0.35; cursor: not-allowed; }
    .date-cal-day.selected { background: rgba(13, 148, 136, 0.12); border-color: rgba(13, 148, 136, 0.6); color: var(--accent); }
    .date-cal-day.in-range { background: rgba(13, 148, 136, 0.10); border-color: rgba(13, 148, 136, 0.25); }
    .date-cal-day.range-start,
    .date-cal-day.range-end { background: var(--accent); border-color: var(--accent); color: #fff; }
    .date-cal-day.range-start:hover,
    .date-cal-day.range-end:hover { color: #fff; }
    .date-cal-day.today { box-shadow: inset 0 0 0 2px rgba(13, 148, 136, 0.25); }
    .date-cal-footer { display: flex; align-items: center; justify-content: space-between; gap: 0.75rem; margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid var(--border); }
    .date-cal-summary { font-size: 0.8125rem; color: var(--text); font-weight: 600; }
    .date-cal-actions { display: inline-flex; align-items: center; gap: 0.5rem; flex-shrink: 0; }
    .date-cal-btn { display: inline-flex; align-items: center; justify-content: center; padding: 0.42rem 0.75rem; border: 1px solid var(--border); border-radius: 999px; background: rgba(255, 255, 255, 0.9); box-shadow: var(--shadow); color: var(--text); cursor: pointer; font-size: 0.8125rem; font-weight: 650; }
    .date-cal-btn:hover { color: var(--accent); border-color: rgba(13, 148, 136, 0.35); }
    .date-cal-btn.primary { border-color: rgba(13, 148, 136, 0.55); color: var(--accent); background: rgba(13, 148, 136, 0.08); }
    .date-cal-btn.primary:hover { border-color: rgba(13, 148, 136, 0.8); }
    .date-cal-btn:disabled { opacity: 0.55; cursor: not-allowed; }
    .config-row { font-size: 0.8125rem; color: var(--text); margin: 0.25rem 0; word-break: break-word; }
    .config-row.ok { color: #0f766e; }
    .config-row.missing { color: #b91c1c; }

    .diag { display: flex; flex-direction: column; gap: 0.85rem; }
    .diag-loading { font-size: 0.85rem; color: var(--muted); padding: 0.5rem 0; }

    .diag-top-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; }
    .diag-card { border: 1px solid var(--border); border-radius: var(--radius); background: rgba(255,255,255,0.75); padding: 0.9rem; }
    .diag-card-header { display: flex; align-items: center; justify-content: space-between; gap: 0.75rem; margin-bottom: 0.6rem; }
    .diag-brand { display: flex; align-items: center; gap: 0.55rem; min-width: 0; }
    .diag-logo { width: 26px; height: 26px; display: block; object-fit: contain; border-radius: 6px; flex-shrink: 0; }
    .diag-title { font-size: 0.95rem; font-weight: 750; color: var(--text); line-height: 1.1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .diag-sub { font-size: 0.75rem; color: var(--muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    .diag-metrics { display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; }
    .diag-metric { display: flex; flex-direction: column; gap: 0.25rem; min-width: 0; }
    .diag-metric-label { font-size: 0.7rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.04em; }
    .diag-metric-value { font-size: 1.35rem; font-weight: 780; color: var(--text); line-height: 1.05; }
    .diag-metric-value.small { font-size: 1.15rem; }
    .diag-card-bots { grid-column: 1 / -1; display: flex; align-items: center; justify-content: space-between; gap: 1rem; }
    .diag-bots-left { display: flex; align-items: center; gap: 0.55rem; min-width: 0; }
    .diag-icon { width: 18px; height: 18px; color: var(--accent); flex-shrink: 0; }
    .diag-bots-meta { font-size: 0.75rem; color: var(--muted); }

    .diag-section-title { display: flex; align-items: center; gap: 0.45rem; margin: 0.1rem 0 0.2rem; font-size: 0.75rem; font-weight: 700; color: var(--muted); text-transform: uppercase; letter-spacing: 0.04em; }
    .diag-section-title svg { width: 16px; height: 16px; }

    .diag-table-scroll { overflow: auto; border-radius: var(--radius); }
    .diag-compare-table { width: 100%; table-layout: fixed; }
    .diag-compare-table th, .diag-compare-table td { padding: 0.55rem 0.65rem; font-size: 0.8125rem; }
    .diag-compare-table th:first-child, .diag-compare-table td:first-child { text-align: left; }
    .diag-compare-table td code { font-size: 0.78rem; }
    .diag-compare-table .diag-diff-ok { color: #0f766e; font-weight: 750; }
    .diag-compare-table .diag-diff-bad { color: #b91c1c; font-weight: 750; }
    .diag-compare-table .diag-diff-warn { color: #a16207; font-weight: 750; }

    .diag-pill { display: inline-flex; align-items: center; gap: 0.35rem; padding: 0.15rem 0.5rem; border-radius: 999px; font-size: 0.72rem; font-weight: 800; letter-spacing: 0.01em; white-space: nowrap; }
    .diag-pill.ok { background: rgba(13, 148, 136, 0.12); border: 1px solid rgba(13, 148, 136, 0.25); color: #0f766e; }
    .diag-pill.bad { background: rgba(185, 28, 28, 0.10); border: 1px solid rgba(185, 28, 28, 0.25); color: #b91c1c; }
    .diag-pill.warn { background: rgba(161, 98, 7, 0.12); border: 1px solid rgba(161, 98, 7, 0.24); color: #a16207; }

    .diag-tech { border: 1px solid var(--border); border-radius: var(--radius); background: rgba(255,255,255,0.72); overflow: hidden; }
    .diag-tech summary { list-style: none; cursor: pointer; display: flex; align-items: center; justify-content: space-between; gap: 0.75rem; padding: 0.75rem 0.9rem; }
    .diag-tech summary::-webkit-details-marker { display: none; }
    .diag-tech-head { display: flex; flex-direction: column; gap: 0.1rem; min-width: 0; }
    .diag-tech-head strong { font-size: 0.9rem; color: var(--text); }
    .diag-tech-head span { font-size: 0.75rem; color: var(--muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .diag-chevron { width: 18px; height: 18px; color: var(--muted); flex-shrink: 0; transition: transform 0.18s ease; }
    .diag-tech[open] .diag-chevron { transform: rotate(180deg); }

    .diag-tabs { border-top: 1px solid var(--border); padding: 0.75rem 0.9rem 0.9rem; }
    .diag-tab-nav { display: flex; flex-wrap: wrap; gap: 0.35rem; align-items: center; }
    .diag-tab { position: absolute; opacity: 0; pointer-events: none; }
    .diag-tab-label { display: inline-flex; align-items: center; gap: 0.4rem; padding: 0.4rem 0.65rem; border: 1px solid var(--border); border-radius: 999px; background: var(--card); cursor: pointer; font-size: 0.8rem; color: var(--text); }
    .diag-tab-label svg { width: 14px; height: 14px; }
    .diag-tab:focus-visible + .diag-tab-label { outline: 2px solid var(--accent); outline-offset: 2px; }
    .diag-tab:checked + .diag-tab-label { border-color: rgba(13, 148, 136, 0.55); color: var(--accent); background: rgba(13, 148, 136, 0.08); }

    .diag-panels { display: block; flex-basis: 100%; width: 100%; margin-top: 0.75rem; }
    .diag-panel { display: none; }
    #diag-tab-shopify:checked ~ .diag-panels .diag-panel-shopify { display: block; }
    #diag-tab-pixel:checked ~ .diag-panels .diag-panel-pixel { display: block; }
    #diag-tab-traffic:checked ~ .diag-panels .diag-panel-traffic { display: block; }
    #diag-tab-sources:checked ~ .diag-panels .diag-panel-sources { display: block; }
    #diag-tab-system:checked ~ .diag-panels .diag-panel-system { display: block; }

    /* Diagnostics main tabs (Comparison / Technical / Definitions) */
    #diag-main-tab-compare:checked ~ .diag-panels .diag-panel-main-compare { display: block; }
    #diag-main-tab-tech:checked ~ .diag-panels .diag-panel-main-tech { display: block; }
    #diag-main-tab-defs:checked ~ .diag-panels .diag-panel-main-defs { display: block; }

    /* When tech panel is already a tab, remove inner top border/padding */
    .diag-panel-main-tech .diag-tabs { border-top: none; padding: 0; }

    .diag-panel-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; }
    .diag-panel-card { border: 1px solid var(--border); border-radius: var(--radius); background: rgba(255,255,255,0.82); padding: 0.75rem; }
    .diag-panel-card-title { display: flex; align-items: center; gap: 0.45rem; margin: 0 0 0.5rem; font-size: 0.75rem; font-weight: 700; color: var(--muted); text-transform: uppercase; letter-spacing: 0.04em; }
    .diag-panel-card-title svg { width: 16px; height: 16px; }
    .diag-kv { display: flex; align-items: baseline; justify-content: space-between; gap: 0.75rem; padding: 0.25rem 0; border-bottom: 1px dashed rgba(0,0,0,0.08); font-size: 0.8125rem; }
    .diag-kv:last-child { border-bottom: none; }
    .diag-kv .k { color: var(--muted); flex: 0 0 auto; }
    .diag-kv .v { color: var(--text); font-weight: 650; text-align: right; min-width: 0; word-break: break-word; }
    .diag-note { margin-top: 0.45rem; font-size: 0.75rem; color: var(--muted); line-height: 1.35; }
    .diag-toggle-row { display: flex; align-items: center; gap: 0.55rem; margin-top: 0.25rem; font-size: 0.85rem; color: var(--text); font-weight: 650; }
    .diag-toggle-row input { width: 16px; height: 16px; accent-color: var(--accent); }
    .diag-toggle-row span { flex: 1; min-width: 0; }
    .diag-def-list { margin: 0.35rem 0 0; padding-left: 1.1rem; font-size: 0.8125rem; color: var(--text); }
    .diag-def-list li { margin: 0.2rem 0; }
    .diag-def-list code { font-size: 0.78rem; }

    @media (max-width: 768px) {
      .diag-top-grid { grid-template-columns: 1fr; }
      .diag-card-bots { grid-column: auto; }
      .diag-panel-grid { grid-template-columns: 1fr; }
    }

    /* Traffic source mapping UI (config modal) */
    .tsm-actions { display: flex; flex-wrap: wrap; gap: 0.45rem; align-items: center; margin: 0 0 0.6rem; }
    .tsm-btn { display: inline-flex; align-items: center; gap: 0.35rem; padding: 0.4rem 0.65rem; border: 1px solid var(--border); border-radius: 999px; background: var(--card); cursor: pointer; font-size: 0.8rem; color: var(--text); }
    .tsm-btn svg { width: 14px; height: 14px; }
    .tsm-btn.primary { border-color: rgba(13, 148, 136, 0.55); color: var(--accent); background: rgba(13, 148, 136, 0.08); }
    .tsm-btn:disabled { opacity: 0.6; cursor: not-allowed; }
    .tsm-table-scroll { overflow: auto; border-radius: var(--radius); border: 1px solid rgba(0,0,0,0.06); background: rgba(255,255,255,0.65); }
    .tsm-table { width: 100%; border-collapse: separate; border-spacing: 0; }
    .tsm-table th, .tsm-table td { padding: 0.5rem 0.6rem; font-size: 0.8125rem; border-bottom: 1px dashed rgba(0,0,0,0.08); vertical-align: top; }
    .tsm-table th { text-align: left; color: var(--muted); text-transform: uppercase; letter-spacing: 0.04em; font-size: 0.7rem; }
    .tsm-table tr:last-child td { border-bottom: none; }
    .tsm-input { width: 100%; min-height: 40px; padding: 0.55rem 0.7rem; border: 1px solid var(--border); border-radius: 0.7rem; background: rgba(255,255,255,0.9); color: var(--text); font-size: 0.92rem; }
    .tsm-input::placeholder { color: rgba(0,0,0,0.4); }
    .tsm-select { min-height: 40px; }
    .tsm-save-msg { font-size: 0.75rem; color: var(--muted); }
    .tsm-token-table th:nth-child(1), .tsm-token-table td:nth-child(1) { width: 25%; }
    .tsm-token-table th:nth-child(2), .tsm-token-table td:nth-child(2) { width: 25%; }
    .tsm-token-table th:nth-child(3), .tsm-token-table td:nth-child(3) { width: 50%; }
    .tsm-token-map-row { display: flex; flex-wrap: wrap; gap: 0.45rem; align-items: center; }
    .tsm-token-map-row .tsm-select { width: 160px; flex: 0 0 160px; }
    .tsm-token-other { flex: 1 1 180px; min-width: 160px; }
    .tsm-token-icon { flex: 2 1 240px; min-width: 200px; }
    .tsm-mapped-pill { display: inline-flex; align-items: center; gap: 0.35rem; padding: 0.18rem 0.5rem; border-radius: 999px; border: 1px solid rgba(0,0,0,0.10); background: rgba(255,255,255,0.65); font-size: 0.75rem; font-weight: 750; margin: 0.15rem 0.35rem 0 0; }
</head>
<body class="page-dashboard">
  <main class="main">
  <nav class="top-nav" aria-label="Main Navigation">
    <button type="button" class="mobile-tabs-btn" id="mobile-tabs-btn" aria-label="Menu" aria-haspopup="menu" aria-expanded="false" aria-controls="mobile-tabs-menu">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
    </button>
    
    <div class="desktop-only nav-group">
      <button type="button" class="nav-item" role="tab" id="nav-tab-dashboard" aria-label="Dashboard" onclick="setTab('dashboard')" title="Dashboard">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
      </button>
      <button type="button" class="nav-item" role="tab" id="nav-tab-spy" aria-label="Live View" onclick="setTab('spy')" title="Live View">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
      </button>
      <button type="button" class="nav-item" role="tab" id="nav-tab-breakdown" aria-label="Overview" onclick="setTab('breakdown')" title="Overview">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
      </button>
      <button type="button" class="nav-item" role="tab" id="nav-tab-stats" aria-label="Countries" onclick="setTab('stats')" title="Countries">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="10"/><path d="M2 12h20"/><path d="M12 2a15.3 15.3 0 0 1 0 20"/><path d="M12 2a15.3 15.3 0 0 0 0 20"/></svg>
      </button>
    </div>

    <div class="nav-logo">
      <img src="/assets/kexo_logo_fullcolor.webp" alt="Kexo" width="40" height="40" />
    </div>

    <div class="desktop-only nav-group">
      <button type="button" class="nav-item" role="tab" id="nav-tab-products" aria-label="Products" onclick="setTab('products')" title="Products">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>
      </button>
      <button type="button" class="nav-item" role="tab" id="nav-tab-traffic" aria-label="Traffic" onclick="setTab('traffic')" title="Traffic">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
      </button>
      <button type="button" class="nav-item" role="tab" id="nav-tab-ads" aria-label="Ads" onclick="setTab('ads')" title="Ads">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2zm1 14.93V7h-2v9.93A5 5 0 0 1 7.1 12a5 5 0 1 1 9.8 0 5 5 0 0 1-1.9 4.93z"/></svg>
      </button>
      <button type="button" class="nav-item" role="tab" id="nav-tab-tools" aria-label="Tools" onclick="setTab('tools')" title="Tools">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M14.7 6.3a5 5 0 0 0-6.4 6.4L2 19v3h3l6.3-6.3a5 5 0 0 0 6.4-6.4L14 9l-2-2 2.7-0.7z"/></svg>
      </button>
    </div>

    <div class="nav-extras">
      <select id="global-date-select" class="main-tabs-date-select" aria-label="Date range">
        <option value="today">Today</option>
        <option value="yesterday">Yesterday</option>
        <option value="custom" id="date-opt-custom">Custom</option>
      </select>
      <button type="button" class="refresh-btn" id="refresh-btn" aria-label="Refresh">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10"/><path d="M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
      </button>
      <button type="button" class="config-btn" id="config-btn" aria-label="Settings">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
      </button>
    </div>

    <div id="mobile-tabs-menu" class="mobile-tabs-menu" role="menu" aria-label="View menu">
      <button type="button" class="mobile-tabs-item" role="menuitem" data-tab="dashboard">Dashboard</button>
      <button type="button" class="mobile-tabs-item" role="menuitem" data-tab="spy">Live View</button>
      <button type="button" class="mobile-tabs-item" role="menuitem" data-tab="breakdown">Overview</button>
      <button type="button" class="mobile-tabs-item" role="menuitem" data-tab="stats">Countries</button>
      <button type="button" class="mobile-tabs-item" role="menuitem" data-tab="products">Products</button>
      <button type="button" class="mobile-tabs-item" role="menuitem" data-tab="traffic">Traffic</button>
      <button type="button" class="mobile-tabs-item" role="menuitem" data-tab="ads">Ads</button>
      <button type="button" class="mobile-tabs-item" role="menuitem" data-tab="tools">Tools</button>
    </div>
  </nav>
  <div class="shared-kpi-wrap" aria-label="KPIs for selected date range">
    <div class="kpi-mobile-pager">
    <div class="live-kpi-grid" id="live-kpi-grid">
      <div class="live-kpi-cell" id="live-kpi-sales-cell">
        <div class="live-kpi-label" id="live-kpi-sales-label">Sales</div>
        <div class="live-kpi-value" id="live-kpi-sales">—</div>
        <div class="live-kpi-sub is-hidden" id="live-kpi-sales-sub"></div>
      </div>
      <div class="live-kpi-cell" id="live-kpi-conv-cell">
        <div class="live-kpi-label">Conv rate</div>
        <div class="live-kpi-value" id="live-kpi-conv">—</div>
        <div class="live-kpi-sub is-hidden" id="live-kpi-conv-sub"></div>
      </div>
      <div class="live-kpi-cell"><div class="live-kpi-label">Sessions</div><div class="live-kpi-value" id="live-kpi-sessions">—</div><div class="live-kpi-sub is-hidden" id="live-kpi-sessions-sub"></div></div>
      <div class="live-kpi-cell"><div class="live-kpi-label">Returning</div><div class="live-kpi-value" id="live-kpi-returning">—</div><div class="live-kpi-sub is-hidden" id="live-kpi-returning-sub"></div></div>
      <div class="live-kpi-cell"><div class="live-kpi-label">AOV</div><div class="live-kpi-value" id="live-kpi-aov">—</div><div class="live-kpi-sub is-hidden" id="live-kpi-aov-sub"></div></div>
      <div class="live-kpi-cell"><div class="live-kpi-label">Bounce</div><div class="live-kpi-value" id="live-kpi-bounce">—</div><div class="live-kpi-sub is-hidden" id="live-kpi-bounce-sub"></div></div>
    </div>
    <button type="button" class="kpi-mobile-next is-hidden" id="kpi-mobile-next" aria-label="Next KPIs" title="Next KPIs">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><polyline points="9 18 15 12 9 6"/></svg>
    </button>
    </div>
  </div>

  <div class="page-title-wrap">
    <h1 class="page-title" id="page-title">Dashboard</h1>
  </div>

  <div id="tab-panel-dashboard" class="main-tab-panel active" role="tabpanel" aria-labelledby="tab-dashboard">
    <div class="dash-header">
      <h2 class="dash-title">Dashboard</h2>
      <div class="dash-range-wrap">
        <select id="dash-range-select" class="stats-select" aria-label="Dashboard range">
          <option value="7">Last 7 days</option>
          <option value="14">Last 14 days</option>
          <option value="30" selected>Last 30 days</option>
          <option value="90">Last 90 days</option>
        </select>
      </div>
    </div>
    <div class="dash-kpi-row" id="dash-kpi-row">
      <div class="dash-kpi-card"><div class="dash-kpi-label">Revenue</div><div class="dash-kpi-value" id="dash-kpi-revenue">&mdash;</div></div>
      <div class="dash-kpi-card"><div class="dash-kpi-label">Orders</div><div class="dash-kpi-value" id="dash-kpi-orders">&mdash;</div></div>
      <div class="dash-kpi-card"><div class="dash-kpi-label">Sessions</div><div class="dash-kpi-value" id="dash-kpi-sessions">&mdash;</div></div>
      <div class="dash-kpi-card"><div class="dash-kpi-label">Conv Rate</div><div class="dash-kpi-value" id="dash-kpi-conv">&mdash;</div></div>
      <div class="dash-kpi-card"><div class="dash-kpi-label">AOV</div><div class="dash-kpi-value" id="dash-kpi-aov">&mdash;</div></div>
      <div class="dash-kpi-card"><div class="dash-kpi-label">Ad Spend</div><div class="dash-kpi-value" id="dash-kpi-adspend">&mdash;</div></div>
    </div>
    <div class="dash-charts-row">
      <div class="dash-chart-card">
        <div class="dash-chart-title">Revenue</div>
        <div class="dash-chart-wrap"><canvas id="dash-chart-revenue"></canvas></div>
      </div>
      <div class="dash-chart-card">
        <div class="dash-chart-title">Orders</div>
        <div class="dash-chart-wrap"><canvas id="dash-chart-orders"></canvas></div>
      </div>
    </div>
    <div class="dash-charts-row">
      <div class="dash-chart-card">
        <div class="dash-chart-title">Conversion Rate</div>
        <div class="dash-chart-wrap"><canvas id="dash-chart-conv"></canvas></div>
      </div>
      <div class="dash-chart-card">
        <div class="dash-chart-title">Sessions</div>
        <div class="dash-chart-wrap"><canvas id="dash-chart-sessions"></canvas></div>
      </div>
    </div>
    <div class="dash-charts-row dash-charts-row--single" id="dash-adspend-row" style="display:none">
      <div class="dash-chart-card dash-chart-card--wide">
        <div class="dash-chart-title">Revenue vs Ad Spend</div>
        <div class="dash-chart-wrap"><canvas id="dash-chart-adspend"></canvas></div>
      </div>
    </div>
    <div class="dash-tables-row">
      <div class="dash-table-card">
        <div class="dash-table-title">Top Products</div>
        <table class="dash-table" id="dash-top-products">
          <thead><tr><th>Product</th><th>Revenue</th><th>Orders</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="dash-table-card">
        <div class="dash-table-title">Top Countries</div>
        <table class="dash-table" id="dash-top-countries">
          <thead><tr><th>Country</th><th>Revenue</th><th>Orders</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
    <div class="dash-roas-row" id="dash-roas-row" style="display:none">
      <div class="dash-kpi-card dash-kpi-card--accent"><div class="dash-kpi-label">ROAS</div><div class="dash-kpi-value" id="dash-kpi-roas">&mdash;</div></div>
    </div>
  </div>

  <div id="tab-panel-spy" class="main-tab-panel" role="tabpanel" aria-labelledby="tab-spy">
  <div class="live-view-header">
    <h2 class="table-title" id="table-title">
      <span id="table-title-tabs" class="table-title-tabs is-hidden" role="tablist" aria-label="Time window">
        <button type="button" role="tab" id="table-tab-today" data-range="today" aria-selected="false">Today</button>
        <span class="table-title-tabs-sep" id="table-tab-sep-today-sales" aria-hidden="true">|</span>
        <button type="button" role="tab" id="table-tab-sales" data-range="sales" aria-selected="false">Sales</button>
        <span class="table-title-tabs-sep" id="table-tab-sep-sales-live" aria-hidden="true">|</span>
        <button type="button" role="tab" id="table-tab-live" data-range="live" aria-selected="false"><span class="live-tab-dot"></span>Live</button>
      </span>
      <span id="table-title-text" class="table-title-label">Today</span>
    </h2>
    <span class="next-update-block live-view-next-update-center" id="next-update-block">
      <span class="next-update-label is-hidden" id="next-update-label">Next update</span>
      <span class="next-update-timer is-hidden" id="next-update-timer-wrap" aria-hidden="true"></span>
    </span>
    <div class="live-view-online">
      <svg class="online-user-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><circle cx="12" cy="6" r="4"></circle><path d="M19.9975 18C20 17.8358 20 17.669 20 17.5C20 15.0147 16.4183 13 12 13C7.58172 13 4 15.0147 4 17.5C4 19.9853 4 22 12 22C14.231 22 15.8398 21.8433 17 21.5634"></path></svg>
      Online:
      <span class="online-count-wrap">
        <span id="online-count-spinner" class="mini-spinner" aria-hidden="true"></span>
        <strong id="online-count" class="is-hidden">0</strong>
      </span>
    </div>
  </div>
  <div class="sessions-table-wrap">
    <div class="table-loading-overlay sessions-loading-overlay is-hidden" id="sessions-loading-overlay"><div class="spinner"></div></div>
  <div class="table-scroll-wrap">
  <div id="sessions-table" class="grid-table sessions-table" role="table" aria-label="Sessions">
    <div class="grid-header" role="rowgroup">
      <div class="grid-row grid-row--header" role="row">
        <div class="grid-cell sortable" role="columnheader" data-sort="landing" aria-sort="none" tabindex="0" aria-label="Landing Page"><span class="th-label-long">Landing Page</span><span class="th-label-short">Land</span></div>
        <div class="grid-cell sortable" role="columnheader" data-sort="from" aria-sort="none" tabindex="0" aria-label="GEO"><span class="th-label-long">GEO</span><span class="th-label-short">GEO</span></div>
        <div class="grid-cell source-cell sortable" role="columnheader" data-sort="source" aria-sort="none" tabindex="0" aria-label="Source"><span class="th-label-long">Source</span><span class="th-label-short">Src</span></div>
        <div class="grid-cell sortable" role="columnheader" data-sort="device" aria-sort="none" tabindex="0" aria-label="Device"><span class="th-label-long">Device</span><span class="th-label-short">Dev</span></div>
        <div class="grid-cell cart-value-cell sortable" role="columnheader" data-sort="cart" aria-sort="none" tabindex="0" aria-label="Cart"><span class="th-label-long">Cart</span><span class="th-label-short">Cart</span></div>
        <div class="grid-cell sortable" role="columnheader" data-sort="arrived" aria-sort="none" tabindex="0" aria-label="Arrived"><span class="th-label-long">Arrived</span><span class="th-label-short">Arr</span></div>
        <div class="grid-cell sortable" role="columnheader" data-sort="last_seen" aria-sort="none" tabindex="0" aria-label="Seen"><span class="th-label-long">Seen</span><span class="th-label-short">Seen</span></div>
        <div class="grid-cell sortable" role="columnheader" data-sort="history" aria-sort="none" tabindex="0" aria-label="History"><span class="th-label-long">History</span><span class="th-label-short">Hist</span></div>
        <div class="grid-cell consent-col is-hidden" role="columnheader" aria-label="Consent (debug)"><span class="th-label-long">Consent (debug)</span><span class="th-label-short">Cons</span></div>
      </div>
    </div>
    <div id="table-body" class="grid-body" role="rowgroup"></div>
  </div>
  </div>
  <div class="table-pagination" id="table-pagination">
    <div class="pagination-segments" role="group" aria-label="Pagination">
      <button type="button" id="pagination-prev" aria-label="Previous page">Prev</button>
      <span id="pagination-label">1 of 1</span>
      <button type="button" id="pagination-next" aria-label="Next page">Next</button>
      <span id="rows-per-page-wrap"><span class="muted">Rows</span>
      <select id="rows-per-page-select" class="stats-select" aria-label="Rows per page">
      <option value="15">15</option>
      <option value="25" selected>25</option>
      <option value="30">30</option>
      <option value="50">50</option>
      <option value="75">75</option>
      <option value="100">100</option>
      </select></span>
    </div>
  </div>
  </div>
  </div>
  <div id="tab-panel-stats" class="main-tab-panel" role="tabpanel" aria-labelledby="tab-stats">
  <div class="stats-row-wrap">
    <div class="table-loading-overlay stats-loading-overlay report-loading-overlay is-hidden" id="stats-loading-overlay">
      <div class="report-build-wrap">
        <div class="spinner"></div>
        <div class="report-build-title">building reports</div>
        <div class="report-build-step" id="stats-build-step">—</div>
      </div>
    </div>
  <div class="stats-row breakdown-row">
    <div class="stats-card" id="stats-country">
      <div class="country-table-wrap" id="country-table-wrap">
        <div id="country-table" class="grid-table by-country-table" role="table" aria-label="Country">
          <div class="grid-header" role="rowgroup">
            <div class="grid-row grid-row--header" role="row">
              <div class="grid-cell sortable" role="columnheader" data-sort="country" aria-sort="none" tabindex="0" aria-label="Country"><span class="th-label-long">Country</span><span class="th-label-short">Geo</span></div>
              <div class="grid-cell sortable" role="columnheader" data-sort="cr" aria-sort="none" tabindex="0" aria-label="CR"><span class="th-label-long">CR</span><span class="th-label-short"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M5 19L19 5M9 7C9 8.10457 8.10457 9 7 9C5.89543 9 5 8.10457 5 7C5 5.89543 5.89543 5 7 5C8.10457 5 9 5.89543 9 7ZM19 17C19 18.1046 18.1046 19 17 19C15.8954 19 15 18.1046 15 17C15 15.8954 15.8954 15 17 15C18.1046 15 19 15.8954 19 17Z"></path></svg></span></div>
              <div class="grid-cell sortable" role="columnheader" data-sort="sales" aria-sort="none" tabindex="0" aria-label="Orders"><span class="th-label-long">Orders</span><span class="th-label-short"><svg viewBox="0 0 32 32" fill="currentColor" aria-hidden="true"><path d="M29.4819,8.624l-10-5.5a1,1,0,0,0-.9638,0l-10,5.5a1,1,0,0,0,0,1.752L18,15.5913V26.3086l-3.0362-1.6693L14,26.3912l4.5181,2.4848a.9984.9984,0,0,0,.9638,0l10-5.5A1,1,0,0,0,30,22.5V9.5A1,1,0,0,0,29.4819,8.624ZM19,5.1416,26.9248,9.5,19,13.8584,11.0752,9.5Zm9,16.7671-8,4.4V15.5913l8-4.4Z"></path><rect x="2" y="14" width="8" height="2" transform="translate(12 30) rotate(-180)"></rect><rect x="4" y="22" width="8" height="2" transform="translate(16 46) rotate(-180)"></rect><rect x="6" y="18" width="8" height="2" transform="translate(20 38) rotate(-180)"></rect></svg></span></div>
              <div class="grid-cell sortable" role="columnheader" data-sort="clicks" aria-sort="none" tabindex="0" aria-label="Sessions"><span class="th-label-long">Sessions</span><span class="th-label-short"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><circle cx="12" cy="6" r="4"></circle><path d="M19.9975 18C20 17.8358 20 17.669 20 17.5C20 15.0147 16.4183 13 12 13C7.58172 13 4 15.0147 4 17.5C4 19.9853 4 22 12 22C14.231 22 15.8398 21.8433 17 21.5634"></path></svg></span></div>
              <div class="grid-cell sortable" role="columnheader" data-sort="rev" aria-sort="none" tabindex="0" aria-label="Rev"><span class="th-label-long">Rev</span><span class="th-label-short"><svg viewBox="0 0 256 256" fill="currentColor" aria-hidden="true"><path d="M192,208a8.00008,8.00008,0,0,1-8,8H56a8,8,0,0,1,0-16,28.03146,28.03146,0,0,0,28-28V140H56a8,8,0,0,1,0-16H84V84a52,52,0,0,1,88.76953-36.76953A8.00018,8.00018,0,0,1,161.45508,58.544,35.99961,35.99961,0,0,0,100,84v40h36a8,8,0,0,1,0,16H100v32a43.79679,43.79679,0,0,1-10.08447,28H184A8.00008,8.00008,0,0,1,192,208Z"></path></svg></span></div>
            </div>
          </div>
          <div id="by-country-body" class="grid-body" role="rowgroup">
            <div class="grid-row" role="row"><div class="grid-cell empty span-all" role="cell">—</div></div>
          </div>
        </div>
      </div>
      <div class="card-pagination is-hidden" id="country-pagination" aria-label="Country pagination">
        <button type="button" id="country-prev">Prev</button>
        <span class="page-label" id="country-label">1 of 1</span>
        <button type="button" id="country-next">Next</button>
      </div>
    </div>
    <div class="stats-card" id="stats-best-geo-products">
      <div class="country-table-wrap" id="best-geo-products-wrap">
        <div id="best-geo-products-table" class="grid-table by-country-table geo-products-table" role="table" aria-label="Best/Geo products">
          <div class="grid-header" role="rowgroup">
            <div class="grid-row grid-row--header" role="row">
              <div class="grid-cell sortable" role="columnheader" data-sort="country" aria-sort="none" tabindex="0" aria-label="Best/Geo"><span class="th-label-long">Best/Geo</span><span class="th-label-short">Best/Geo</span></div>
              <div class="grid-cell sortable" role="columnheader" data-sort="cr" aria-sort="none" tabindex="0" aria-label="CR"><span class="th-label-long">CR</span><span class="th-label-short"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M5 19L19 5M9 7C9 8.10457 8.10457 9 7 9C5.89543 9 5 8.10457 5 7C5 5.89543 5.89543 5 7 5C8.10457 5 9 5.89543 9 7ZM19 17C19 18.1046 18.1046 19 17 19C15.8954 19 15 18.1046 15 17C15 15.8954 15.8954 15 17 15C18.1046 15 19 15.8954 19 17Z"></path></svg></span></div>
              <div class="grid-cell sortable" role="columnheader" data-sort="sales" aria-sort="none" tabindex="0" aria-label="Orders"><span class="th-label-long">Orders</span><span class="th-label-short"><svg viewBox="0 0 32 32" fill="currentColor" aria-hidden="true"><path d="M29.4819,8.624l-10-5.5a1,1,0,0,0-.9638,0l-10,5.5a1,1,0,0,0,0,1.752L18,15.5913V26.3086l-3.0362-1.6693L14,26.3912l4.5181,2.4848a.9984.9984,0,0,0,.9638,0l10-5.5A1,1,0,0,0,30,22.5V9.5A1,1,0,0,0,29.4819,8.624ZM19,5.1416,26.9248,9.5,19,13.8584,11.0752,9.5Zm9,16.7671-8,4.4V15.5913l8-4.4Z"></path><rect x="2" y="14" width="8" height="2" transform="translate(12 30) rotate(-180)"></rect><rect x="4" y="22" width="8" height="2" transform="translate(16 46) rotate(-180)"></rect><rect x="6" y="18" width="8" height="2" transform="translate(20 38) rotate(-180)"></rect></svg></span></div>
              <div class="grid-cell sortable" role="columnheader" data-sort="clicks" aria-sort="none" tabindex="0" aria-label="Sessions"><span class="th-label-long">Sessions</span><span class="th-label-short"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><circle cx="12" cy="6" r="4"></circle><path d="M19.9975 18C20 17.8358 20 17.669 20 17.5C20 15.0147 16.4183 13 12 13C7.58172 13 4 15.0147 4 17.5C4 19.9853 4 22 12 22C14.231 22 15.8398 21.8433 17 21.5634"></path></svg></span></div>
              <div class="grid-cell sortable" role="columnheader" data-sort="rev" aria-sort="none" tabindex="0" aria-label="Rev"><span class="th-label-long">Rev</span><span class="th-label-short"><svg viewBox="0 0 256 256" fill="currentColor" aria-hidden="true"><path d="M192,208a8.00008,8.00008,0,0,1-8,8H56a8,8,0,0,1,0-16,28.03146,28.03146,0,0,0,28-28V140H56a8,8,0,0,1,0-16H84V84a52,52,0,0,1,88.76953-36.76953A8.00018,8.00018,0,0,1,161.45508,58.544,35.99961,35.99961,0,0,0,100,84v40h36a8,8,0,0,1,0,16H100v32a43.79679,43.79679,0,0,1-10.08447,28H184A8.00008,8.00008,0,0,1,192,208Z"></path></svg></span></div>
            </div>
          </div>
          <div id="best-geo-products-body" class="grid-body" role="rowgroup">
            <div class="grid-row" role="row"><div class="grid-cell empty span-all" role="cell">—</div></div>
          </div>
        </div>
      </div>
      <div class="card-pagination is-hidden" id="best-geo-products-pagination" aria-label="Best GEO products pagination">
        <button type="button" id="best-geo-products-prev">Prev</button>
        <span class="page-label" id="best-geo-products-label">1 of 1</span>
        <button type="button" id="best-geo-products-next">Next</button>
      </div>
    </div>
  </div>
  </div>
  </div>

  <div id="tab-panel-breakdown" class="main-tab-panel" role="tabpanel" aria-labelledby="tab-breakdown">
  <div class="stats-row-wrap">
    <div class="table-loading-overlay stats-loading-overlay report-loading-overlay is-hidden" id="breakdown-loading-overlay">
      <div class="report-build-wrap">
        <div class="spinner"></div>
        <div class="report-build-title">Overview</div>
        <div class="report-build-step" id="breakdown-build-step">—</div>
      </div>
    </div>
  <div class="stats-row">
    <div class="stats-card">
      <div class="country-table-wrap">
        <div id="breakdown-aov-table" class="grid-table by-country-table" role="table" aria-label="Country">
          <div class="grid-header" role="rowgroup"><div class="grid-row grid-row--header" role="row">
            <div class="grid-cell" role="columnheader"><span class="th-label-long">Country</span><span class="th-label-short">Geo</span></div>
            <div class="grid-cell" role="columnheader"><span class="th-label-long">Rev</span><span class="th-label-short"><svg viewBox="0 0 256 256" fill="currentColor" aria-hidden="true"><path d="M192,208a8.00008,8.00008,0,0,1-8,8H56a8,8,0,0,1,0-16,28.03146,28.03146,0,0,0,28-28V140H56a8,8,0,0,1,0-16H84V84a52,52,0,0,1,88.76953-36.76953A8.00018,8.00018,0,0,1,161.45508,58.544,35.99961,35.99961,0,0,0,100,84v40h36a8,8,0,0,1,0,16H100v32a43.79679,43.79679,0,0,1-10.08447,28H184A8.00008,8.00008,0,0,1,192,208Z"></path></svg></span></div>
            <div class="grid-cell" role="columnheader"><span class="th-label-long">AOV</span><span class="th-label-short">AOV</span></div>
            <div class="grid-cell" role="columnheader"><span class="th-label-long">CR%</span><span class="th-label-short"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M5 19L19 5M9 7C9 8.10457 8.10457 9 7 9C5.89543 9 5 8.10457 5 7C5 5.89543 5.89543 5 7 5C8.10457 5 9 5.89543 9 7ZM19 17C19 18.1046 18.1046 19 17 19C15.8954 19 15 18.1046 15 17C15 15.8954 15.8954 15 17 15C18.1046 15 19 15.8954 19 17Z"></path></svg></span></div>
          </div></div>
          <div id="breakdown-aov-body" class="grid-body" role="rowgroup"><div class="grid-row" role="row"><div class="grid-cell empty span-all" role="cell">—</div></div></div>
        </div>
      </div>
      <div class="card-pagination is-hidden" id="breakdown-aov-pagination" aria-label="AOV pagination"><button type="button" id="breakdown-aov-prev">Prev</button><span class="page-label" id="breakdown-aov-label">1 of 1</span><button type="button" id="breakdown-aov-next">Next</button></div>
    </div>
    <div class="stats-card">
      <div class="country-table-wrap">
        <div id="breakdown-product-table" class="grid-table by-country-table" role="table" aria-label="Product breakdown">
          <div class="grid-header" role="rowgroup"><div class="grid-row grid-row--header" role="row">
            <div class="grid-cell" role="columnheader"><span class="th-label-long">Product</span><span class="th-label-short">Product</span></div>
            <div class="grid-cell" role="columnheader"><span class="th-label-long">Rev</span><span class="th-label-short">Rev</span></div>
            <div class="grid-cell" role="columnheader"><span class="th-label-long">CR%</span><span class="th-label-short">CR%</span></div>
          </div></div>
          <div id="breakdown-title-body" class="grid-body" role="rowgroup"><div class="grid-row" role="row"><div class="grid-cell empty span-all" role="cell">—</div></div></div>
        </div>
      </div>
      <div class="card-pagination is-hidden" id="breakdown-title-pagination" aria-label="Product pagination"><button type="button" id="breakdown-title-prev">Prev</button><span class="page-label" id="breakdown-title-label">1 of 1</span><button type="button" id="breakdown-title-next">Next</button></div>
    </div>
    <div class="stats-card">
      <div class="country-table-wrap">
        <div id="breakdown-type-table" class="grid-table by-country-table" role="table" aria-label="Type breakdown">
          <div class="grid-header" role="rowgroup"><div class="grid-row grid-row--header" role="row">
            <div class="grid-cell" role="columnheader"><span class="th-label-long">Type</span><span class="th-label-short">Type</span></div>
            <div class="grid-cell" role="columnheader"><span class="th-label-long">Rev</span><span class="th-label-short">Rev</span></div>
            <div class="grid-cell" role="columnheader"><span class="th-label-long">CR%</span><span class="th-label-short">CR%</span></div>
          </div></div>
          <div id="breakdown-type-body" class="grid-body" role="rowgroup"><div class="grid-row" role="row"><div class="grid-cell empty span-all" role="cell">—</div></div></div>
        </div>
      </div>
    </div>
    <div class="stats-card">
      <div class="country-table-wrap">
        <div id="breakdown-finish-table" class="grid-table by-country-table" role="table" aria-label="Finish breakdown">
          <div class="grid-header" role="rowgroup"><div class="grid-row grid-row--header" role="row">
            <div class="grid-cell" role="columnheader"><span class="th-label-long">Finish</span><span class="th-label-short">Finish</span></div>
            <div class="grid-cell" role="columnheader"><span class="th-label-long">Rev</span><span class="th-label-short">Rev</span></div>
            <div class="grid-cell" role="columnheader"><span class="th-label-long">CR%</span><span class="th-label-short">CR%</span></div>
          </div></div>
          <div id="breakdown-finish-body" class="grid-body" role="rowgroup"><div class="grid-row" role="row"><div class="grid-cell empty span-all" role="cell">—</div></div></div>
        </div>
      </div>
      <div class="card-pagination is-hidden" id="breakdown-finish-pagination" aria-label="Finish pagination"><button type="button" id="breakdown-finish-prev">Prev</button><span class="page-label" id="breakdown-finish-label">1 of 1</span><button type="button" id="breakdown-finish-next">Next</button></div>
    </div>
    <div class="stats-card">
      <div class="country-table-wrap">
        <div id="breakdown-length-table" class="grid-table by-country-table" role="table" aria-label="Chain Length breakdown">
          <div class="grid-header" role="rowgroup"><div class="grid-row grid-row--header" role="row">
            <div class="grid-cell" role="columnheader"><span class="th-label-long">Chain Length</span><span class="th-label-short">Length</span></div>
            <div class="grid-cell" role="columnheader"><span class="th-label-long">Rev</span><span class="th-label-short">Rev</span></div>
            <div class="grid-cell" role="columnheader"><span class="th-label-long">CR%</span><span class="th-label-short">CR%</span></div>
          </div></div>
          <div id="breakdown-length-body" class="grid-body" role="rowgroup"><div class="grid-row" role="row"><div class="grid-cell empty span-all" role="cell">—</div></div></div>
        </div>
      </div>
      <div class="card-pagination is-hidden" id="breakdown-length-pagination" aria-label="Length pagination"><button type="button" id="breakdown-length-prev">Prev</button><span class="page-label" id="breakdown-length-label">1 of 1</span><button type="button" id="breakdown-length-next">Next</button></div>
    </div>
    <div class="stats-card">
      <div class="country-table-wrap">
        <div id="breakdown-chainstyle-table" class="grid-table by-country-table" role="table" aria-label="Chain Styles breakdown">
          <div class="grid-header" role="rowgroup"><div class="grid-row grid-row--header" role="row">
            <div class="grid-cell" role="columnheader"><span class="th-label-long">Chain Style</span><span class="th-label-short">Chain</span></div>
            <div class="grid-cell" role="columnheader"><span class="th-label-long">Rev</span><span class="th-label-short">Rev</span></div>
            <div class="grid-cell" role="columnheader"><span class="th-label-long">CR%</span><span class="th-label-short">CR%</span></div>
          </div></div>
          <div id="breakdown-chainstyle-body" class="grid-body" role="rowgroup"><div class="grid-row" role="row"><div class="grid-cell empty span-all" role="cell">—</div></div></div>
        </div>
      </div>
      <div class="card-pagination is-hidden" id="breakdown-chainstyle-pagination" aria-label="Chain Style pagination"><button type="button" id="breakdown-chainstyle-prev">Prev</button><span class="page-label" id="breakdown-chainstyle-label">1 of 1</span><button type="button" id="breakdown-chainstyle-next">Next</button></div>
    </div>
  </div>
  </div>
  </div>

  <div id="tab-panel-products" class="main-tab-panel" role="tabpanel" aria-labelledby="tab-products">
  <div class="stats-row-wrap">
    <div class="table-loading-overlay stats-loading-overlay report-loading-overlay is-hidden" id="products-loading-overlay">
      <div class="report-build-wrap">
        <div class="spinner"></div>
        <div class="report-build-title">building reports</div>
        <div class="report-build-step" id="products-build-step">—</div>
      </div>
    </div>

  <div class="stats-row">
    <div class="stats-card" id="stats-best-sellers">
      <div class="country-table-wrap" id="best-sellers-wrap">
        <div id="best-sellers-table" class="grid-table by-country-table best-sellers-table" role="table" aria-label="Best sellers">
          <div class="grid-header" role="rowgroup">
            <div class="grid-row grid-row--header" role="row">
              <div class="grid-cell bs-product-col sortable" role="columnheader" data-sort="title" aria-sort="none" tabindex="0" aria-label="Best"><span class="th-label-long">Best</span><span class="th-label-short">Best</span></div>
              <div class="grid-cell sortable" role="columnheader" data-sort="orders" aria-sort="none" tabindex="0" aria-label="Orders"><span class="th-label-long">Orders</span><span class="th-label-short"><svg viewBox="0 0 32 32" fill="currentColor" aria-hidden="true"><path d="M29.4819,8.624l-10-5.5a1,1,0,0,0-.9638,0l-10,5.5a1,1,0,0,0,0,1.752L18,15.5913V26.3086l-3.0362-1.6693L14,26.3912l4.5181,2.4848a.9984.9984,0,0,0,.9638,0l10-5.5A1,1,0,0,0,30,22.5V9.5A1,1,0,0,0,29.4819,8.624ZM19,5.1416,26.9248,9.5,19,13.8584,11.0752,9.5Zm9,16.7671-8,4.4V15.5913l8-4.4Z"></path><rect x="2" y="14" width="8" height="2" transform="translate(12 30) rotate(-180)"></rect><rect x="4" y="22" width="8" height="2" transform="translate(16 46) rotate(-180)"></rect><rect x="6" y="18" width="8" height="2" transform="translate(20 38) rotate(-180)"></rect></svg></span></div>
              <div class="grid-cell sortable" role="columnheader" data-sort="clicks" aria-sort="none" tabindex="0" aria-label="Sessions"><span class="th-label-long">Sessions</span><span class="th-label-short"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M9 4.94198C6.47561 4.02693 5.129 3.65381 4.39141 4.39141C3.55146 5.23136 4.15187 6.86106 5.3527 10.1205L7.3603 15.5696C7.96225 17.2035 8.26322 18.0204 8.92489 18.1658C9.58656 18.3111 10.2022 17.6955 11.4334 16.4643L12.6361 15.2616L16.5744 19.1999C16.9821 19.6077 17.186 19.8116 17.4135 19.9058C17.7168 20.0314 18.0575 20.0314 18.3608 19.9058C18.5882 19.8116 18.7921 19.6077 19.1999 19.1999C19.6077 18.7921 19.8116 18.5882 19.9058 18.3608C20.0314 18.0575 20.0314 17.7168 19.9058 17.4135C19.8116 17.186 19.6077 16.9821 19.1999 16.5744L15.2616 12.6361L16.4643 11.4334C17.6955 10.2022 18.3111 9.58656 18.1658 8.92489C18.0204 8.26322 17.2035 7.96225 15.5696 7.3603L13 6.41359"></path></svg></span></div>
              <div class="grid-cell sortable" role="columnheader" data-sort="rev" aria-sort="descending" tabindex="0" aria-label="Rev"><span class="th-label-long">Rev</span><span class="th-label-short"><svg viewBox="0 0 256 256" fill="currentColor" aria-hidden="true"><path d="M192,208a8.00008,8.00008,0,0,1-8,8H56a8,8,0,0,1,0-16,28.03146,28.03146,0,0,0,28-28V140H56a8,8,0,0,1,0-16H84V84a52,52,0,0,1,88.76953-36.76953A8.00018,8.00018,0,0,1,161.45508,58.544,35.99961,35.99961,0,0,0,100,84v40h36a8,8,0,0,1,0,16H100v32a43.79679,43.79679,0,0,1-10.08447,28H184A8.00008,8.00008,0,0,1,192,208Z"></path></svg></span></div>
              <div class="grid-cell sortable" role="columnheader" data-sort="cr" aria-sort="none" tabindex="0" aria-label="CR%"><span class="th-label-long">CR%</span><span class="th-label-short"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M5 19L19 5M9 7C9 8.10457 8.10457 9 7 9C5.89543 9 5 8.10457 5 7C5 5.89543 5.89543 5 7 5C8.10457 5 9 5.89543 9 7ZM19 17C19 18.1046 18.1046 19 17 19C15.8954 19 15 18.1046 15 17C15 15.8954 15.8954 15 17 15C18.1046 15 19 15.8954 19 17Z"></path></svg></span></div>
            </div>
          </div>
          <div id="best-sellers-body" class="grid-body" role="rowgroup">
            <div class="grid-row" role="row"><div class="grid-cell empty span-all" role="cell">—</div></div>
          </div>
        </div>
      </div>
      <div class="card-pagination is-hidden" id="best-sellers-pagination" aria-label="Best sellers pagination">
        <button type="button" id="best-sellers-prev">Prev</button>
        <span class="page-label" id="best-sellers-label">1 of 1</span>
        <button type="button" id="best-sellers-next">Next</button>
      </div>
    </div>
    <div class="stats-card" id="stats-best-variants">
      <div class="country-table-wrap" id="best-variants-wrap">
        <div id="best-variants-table" class="grid-table by-country-table best-sellers-table" role="table" aria-label="Best variants">
          <div class="grid-header" role="rowgroup">
            <div class="grid-row grid-row--header" role="row">
              <div class="grid-cell bs-product-col sortable" role="columnheader" data-sort="variant" aria-sort="none" tabindex="0" aria-label="by Variant"><span class="th-label-long">by Variant</span><span class="th-label-short">Variant</span></div>
              <div class="grid-cell sortable" role="columnheader" data-sort="sales" aria-sort="none" tabindex="0" aria-label="Orders"><span class="th-label-long">Orders</span><span class="th-label-short"><svg viewBox="0 0 32 32" fill="currentColor" aria-hidden="true"><path d="M29.4819,8.624l-10-5.5a1,1,0,0,0-.9638,0l-10,5.5a1,1,0,0,0,0,1.752L18,15.5913V26.3086l-3.0362-1.6693L14,26.3912l4.5181,2.4848a.9984.9984,0,0,0,.9638,0l10-5.5A1,1,0,0,0,30,22.5V9.5A1,1,0,0,0,29.4819,8.624ZM19,5.1416,26.9248,9.5,19,13.8584,11.0752,9.5Zm9,16.7671-8,4.4V15.5913l8-4.4Z"></path><rect x="2" y="14" width="8" height="2" transform="translate(12 30) rotate(-180)"></rect><rect x="4" y="22" width="8" height="2" transform="translate(16 46) rotate(-180)"></rect><rect x="6" y="18" width="8" height="2" transform="translate(20 38) rotate(-180)"></rect></svg></span></div>
              <div class="grid-cell sortable" role="columnheader" data-sort="clicks" aria-sort="none" tabindex="0" aria-label="Sessions"><span class="th-label-long">Sessions</span><span class="th-label-short"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M9 4.94198C6.47561 4.02693 5.129 3.65381 4.39141 4.39141C3.55146 5.23136 4.15187 6.86106 5.3527 10.1205L7.3603 15.5696C7.96225 17.2035 8.26322 18.0204 8.92489 18.1658C9.58656 18.3111 10.2022 17.6955 11.4334 16.4643L12.6361 15.2616L16.5744 19.1999C16.9821 19.6077 17.186 19.8116 17.4135 19.9058C17.7168 20.0314 18.0575 20.0314 18.3608 19.9058C18.5882 19.8116 18.7921 19.6077 19.1999 19.1999C19.6077 18.7921 19.8116 18.5882 19.9058 18.3608C20.0314 18.0575 20.0314 17.7168 19.9058 17.4135C19.8116 17.186 19.6077 16.9821 19.1999 16.5744L15.2616 12.6361L16.4643 11.4334C17.6955 10.2022 18.3111 9.58656 18.1658 8.92489C18.0204 8.26322 17.2035 7.96225 15.5696 7.3603L13 6.41359"></path></svg></span></div>
              <div class="grid-cell sortable" role="columnheader" data-sort="rev" aria-sort="none" tabindex="0" aria-label="Rev"><span class="th-label-long">Rev</span><span class="th-label-short"><svg viewBox="0 0 256 256" fill="currentColor" aria-hidden="true"><path d="M192,208a8.00008,8.00008,0,0,1-8,8H56a8,8,0,0,1,0-16,28.03146,28.03146,0,0,0,28-28V140H56a8,8,0,0,1,0-16H84V84a52,52,0,0,1,88.76953-36.76953A8.00018,8.00018,0,0,1,161.45508,58.544,35.99961,35.99961,0,0,0,100,84v40h36a8,8,0,0,1,0,16H100v32a43.79679,43.79679,0,0,1-10.08447,28H184A8.00008,8.00008,0,0,1,192,208Z"></path></svg></span></div>
              <div class="grid-cell sortable" role="columnheader" data-sort="cr" aria-sort="none" tabindex="0" aria-label="CR%"><span class="th-label-long">CR%</span><span class="th-label-short"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M5 19L19 5M9 7C9 8.10457 8.10457 9 7 9C5.89543 9 5 8.10457 5 7C5 5.89543 5.89543 5 7 5C8.10457 5 9 5.89543 9 7ZM19 17C19 18.1046 18.1046 19 17 19C15.8954 19 15 18.1046 15 17C15 15.8954 15.8954 15 17 15C18.1046 15 19 15.8954 19 17Z"></path></svg></span></div>
            </div>
          </div>
          <div id="best-variants-body" class="grid-body" role="rowgroup">
            <div class="grid-row" role="row"><div class="grid-cell empty span-all" role="cell">—</div></div>
          </div>
        </div>
      </div>
      <div class="card-pagination is-hidden" id="best-variants-pagination" aria-label="Best variants pagination">
        <button type="button" id="best-variants-prev">Prev</button>
        <span class="page-label" id="best-variants-label">1 of 1</span>
        <button type="button" id="best-variants-next">Next</button>
      </div>
    </div>
  </div>
  <div class="stats-row" id="products-type-tables-row">
    <div class="stats-card" id="stats-type-necklaces">
      <div class="country-table-wrap">
        <div id="type-necklaces-table" class="grid-table by-country-table best-sellers-table" role="table" aria-label="Necklaces">
          <div class="grid-header" role="rowgroup"><div class="grid-row grid-row--header" role="row">
            <div class="grid-cell bs-product-col" role="columnheader"><span class="th-label-long">Necklaces</span><span class="th-label-short">Necklaces</span></div>
            <div class="grid-cell" role="columnheader"><span class="th-label-long">Orders</span><span class="th-label-short">Ord</span></div>
            <div class="grid-cell" role="columnheader"><span class="th-label-long">Sessions</span><span class="th-label-short">Sess</span></div>
            <div class="grid-cell" role="columnheader"><span class="th-label-long">Rev</span><span class="th-label-short">Rev</span></div>
            <div class="grid-cell" role="columnheader"><span class="th-label-long">CR%</span><span class="th-label-short">CR%</span></div>
          </div></div>
          <div id="type-necklaces-body" class="grid-body" role="rowgroup"><div class="grid-row" role="row"><div class="grid-cell empty span-all" role="cell">—</div></div></div>
        </div>
      </div>
      <div class="card-pagination is-hidden" id="type-necklaces-pagination" aria-label="Necklaces pagination"><button type="button" id="type-necklaces-prev">Prev</button><span class="page-label" id="type-necklaces-label">1 of 1</span><button type="button" id="type-necklaces-next">Next</button></div>
    </div>
    <div class="stats-card" id="stats-type-bracelets">
      <div class="country-table-wrap">
        <div id="type-bracelets-table" class="grid-table by-country-table best-sellers-table" role="table" aria-label="Bracelets">
          <div class="grid-header" role="rowgroup"><div class="grid-row grid-row--header" role="row">
            <div class="grid-cell bs-product-col" role="columnheader"><span class="th-label-long">Bracelets</span><span class="th-label-short">Bracelets</span></div>
            <div class="grid-cell" role="columnheader"><span class="th-label-long">Orders</span><span class="th-label-short">Ord</span></div>
            <div class="grid-cell" role="columnheader"><span class="th-label-long">Sessions</span><span class="th-label-short">Sess</span></div>
            <div class="grid-cell" role="columnheader"><span class="th-label-long">Rev</span><span class="th-label-short">Rev</span></div>
            <div class="grid-cell" role="columnheader"><span class="th-label-long">CR%</span><span class="th-label-short">CR%</span></div>
          </div></div>
          <div id="type-bracelets-body" class="grid-body" role="rowgroup"><div class="grid-row" role="row"><div class="grid-cell empty span-all" role="cell">—</div></div></div>
        </div>
      </div>
      <div class="card-pagination is-hidden" id="type-bracelets-pagination" aria-label="Bracelets pagination"><button type="button" id="type-bracelets-prev">Prev</button><span class="page-label" id="type-bracelets-label">1 of 1</span><button type="button" id="type-bracelets-next">Next</button></div>
    </div>
    <div class="stats-card" id="stats-type-earrings">
      <div class="country-table-wrap">
        <div id="type-earrings-table" class="grid-table by-country-table best-sellers-table" role="table" aria-label="Earrings">
          <div class="grid-header" role="rowgroup"><div class="grid-row grid-row--header" role="row">
            <div class="grid-cell bs-product-col" role="columnheader"><span class="th-label-long">Earrings</span><span class="th-label-short">Earrings</span></div>
            <div class="grid-cell" role="columnheader"><span class="th-label-long">Orders</span><span class="th-label-short">Ord</span></div>
            <div class="grid-cell" role="columnheader"><span class="th-label-long">Sessions</span><span class="th-label-short">Sess</span></div>
            <div class="grid-cell" role="columnheader"><span class="th-label-long">Rev</span><span class="th-label-short">Rev</span></div>
            <div class="grid-cell" role="columnheader"><span class="th-label-long">CR%</span><span class="th-label-short">CR%</span></div>
          </div></div>
          <div id="type-earrings-body" class="grid-body" role="rowgroup"><div class="grid-row" role="row"><div class="grid-cell empty span-all" role="cell">—</div></div></div>
        </div>
      </div>
      <div class="card-pagination is-hidden" id="type-earrings-pagination" aria-label="Earrings pagination"><button type="button" id="type-earrings-prev">Prev</button><span class="page-label" id="type-earrings-label">1 of 1</span><button type="button" id="type-earrings-next">Next</button></div>
    </div>
    <div class="stats-card" id="stats-type-sets">
      <div class="country-table-wrap">
        <div id="type-sets-table" class="grid-table by-country-table best-sellers-table" role="table" aria-label="Sets">
          <div class="grid-header" role="rowgroup"><div class="grid-row grid-row--header" role="row">
            <div class="grid-cell bs-product-col" role="columnheader"><span class="th-label-long">Jewelry Sets</span><span class="th-label-short">Sets</span></div>
            <div class="grid-cell" role="columnheader"><span class="th-label-long">Orders</span><span class="th-label-short">Ord</span></div>
            <div class="grid-cell" role="columnheader"><span class="th-label-long">Sessions</span><span class="th-label-short">Sess</span></div>
            <div class="grid-cell" role="columnheader"><span class="th-label-long">Rev</span><span class="th-label-short">Rev</span></div>
            <div class="grid-cell" role="columnheader"><span class="th-label-long">CR%</span><span class="th-label-short">CR%</span></div>
          </div></div>
          <div id="type-sets-body" class="grid-body" role="rowgroup"><div class="grid-row" role="row"><div class="grid-cell empty span-all" role="cell">—</div></div></div>
        </div>
      </div>
      <div class="card-pagination is-hidden" id="type-sets-pagination" aria-label="Sets pagination"><button type="button" id="type-sets-prev">Prev</button><span class="page-label" id="type-sets-label">1 of 1</span><button type="button" id="type-sets-next">Next</button></div>
    </div>
    <div class="stats-card" id="stats-type-charms">
      <div class="country-table-wrap">
        <div id="type-charms-table" class="grid-table by-country-table best-sellers-table" role="table" aria-label="Charms">
          <div class="grid-header" role="rowgroup"><div class="grid-row grid-row--header" role="row">
            <div class="grid-cell bs-product-col" role="columnheader"><span class="th-label-long">Charms</span><span class="th-label-short">Charms</span></div>
            <div class="grid-cell" role="columnheader"><span class="th-label-long">Orders</span><span class="th-label-short">Ord</span></div>
            <div class="grid-cell" role="columnheader"><span class="th-label-long">Sessions</span><span class="th-label-short">Sess</span></div>
            <div class="grid-cell" role="columnheader"><span class="th-label-long">Rev</span><span class="th-label-short">Rev</span></div>
            <div class="grid-cell" role="columnheader"><span class="th-label-long">CR%</span><span class="th-label-short">CR%</span></div>
          </div></div>
          <div id="type-charms-body" class="grid-body" role="rowgroup"><div class="grid-row" role="row"><div class="grid-cell empty span-all" role="cell">—</div></div></div>
        </div>
      </div>
      <div class="card-pagination is-hidden" id="type-charms-pagination" aria-label="Charms pagination"><button type="button" id="type-charms-prev">Prev</button><span class="page-label" id="type-charms-label">1 of 1</span><button type="button" id="type-charms-next">Next</button></div>
    </div>
    <div class="stats-card" id="stats-type-extras">
      <div class="country-table-wrap">
        <div id="type-extras-table" class="grid-table by-country-table best-sellers-table" role="table" aria-label="Extras">
          <div class="grid-header" role="rowgroup"><div class="grid-row grid-row--header" role="row">
            <div class="grid-cell bs-product-col" role="columnheader"><span class="th-label-long">Extras</span><span class="th-label-short">Extras</span></div>
            <div class="grid-cell" role="columnheader"><span class="th-label-long">Orders</span><span class="th-label-short">Ord</span></div>
            <div class="grid-cell" role="columnheader"><span class="th-label-long">Sessions</span><span class="th-label-short">Sess</span></div>
            <div class="grid-cell" role="columnheader"><span class="th-label-long">Rev</span><span class="th-label-short">Rev</span></div>
            <div class="grid-cell" role="columnheader"><span class="th-label-long">CR%</span><span class="th-label-short">CR%</span></div>
          </div></div>
          <div id="type-extras-body" class="grid-body" role="rowgroup"><div class="grid-row" role="row"><div class="grid-cell empty span-all" role="cell">—</div></div></div>
        </div>
      </div>
      <div class="card-pagination is-hidden" id="type-extras-pagination" aria-label="Extras pagination"><button type="button" id="type-extras-prev">Prev</button><span class="page-label" id="type-extras-label">1 of 1</span><button type="button" id="type-extras-next">Next</button></div>
    </div>
  </div>
  </div>
  </div>

  <div id="tab-panel-traffic" class="main-tab-panel" role="tabpanel" aria-labelledby="tab-traffic">
  <div class="stats-row-wrap">
    <div class="table-loading-overlay stats-loading-overlay report-loading-overlay is-hidden" id="traffic-loading-overlay">
      <div class="report-build-wrap">
        <div class="spinner"></div>
        <div class="report-build-title">building reports</div>
        <div class="report-build-step" id="traffic-build-step">—</div>
      </div>
    </div>
  <div class="traffic-grid">
    <div class="stats-card" id="traffic-sources-card">
      <div class="traffic-card-header">
        <h3 class="traffic-card-title">Channels</h3>
      </div>
      <div class="country-table-wrap">
        <div id="traffic-sources-table" class="grid-table by-country-table" role="table" aria-label="Traffic sources">
          <div class="grid-header" role="rowgroup">
            <div class="grid-row grid-row--header" role="row">
              <div class="grid-cell sortable" role="columnheader" data-sort="source" aria-sort="none" tabindex="0" aria-label="Source"><span class="th-label-long">Source</span><span class="th-label-short">Src</span></div>
              <div class="grid-cell sortable" role="columnheader" data-sort="cr" aria-sort="none" tabindex="0" aria-label="CR%"><span class="th-label-long">CR%</span><span class="th-label-short"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M5 19L19 5M9 7C9 8.10457 8.10457 9 7 9C5.89543 9 5 8.10457 5 7C5 5.89543 5.89543 5 7 5C8.10457 5 9 5.89543 9 7ZM19 17C19 18.1046 18.1046 19 17 19C15.8954 19 15 18.1046 15 17C15 15.8954 15.8954 15 17 15C18.1046 15 19 15.8954 19 17Z"></path></svg></span></div>
              <div class="grid-cell sortable" role="columnheader" data-sort="orders" aria-sort="none" tabindex="0" aria-label="Orders"><span class="th-label-long">Orders</span><span class="th-label-short"><svg viewBox="0 0 32 32" fill="currentColor" aria-hidden="true"><path d="M29.4819,8.624l-10-5.5a1,1,0,0,0-.9638,0l-10,5.5a1,1,0,0,0,0,1.752L18,15.5913V26.3086l-3.0362-1.6693L14,26.3912l4.5181,2.4848a.9984.9984,0,0,0,.9638,0l10-5.5A1,1,0,0,0,30,22.5V9.5A1,1,0,0,0,29.4819,8.624ZM19,5.1416,26.9248,9.5,19,13.8584,11.0752,9.5Zm9,16.7671-8,4.4V15.5913l8-4.4Z"></path><rect x="2" y="14" width="8" height="2" transform="translate(12 30) rotate(-180)"></rect><rect x="4" y="22" width="8" height="2" transform="translate(16 46) rotate(-180)"></rect><rect x="6" y="18" width="8" height="2" transform="translate(20 38) rotate(-180)"></rect></svg></span></div>
              <div class="grid-cell sortable" role="columnheader" data-sort="sessions" aria-sort="none" tabindex="0" aria-label="Sessions"><span class="th-label-long">Sessions</span><span class="th-label-short"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><circle cx="12" cy="6" r="4"></circle><path d="M19.9975 18C20 17.8358 20 17.669 20 17.5C20 15.0147 16.4183 13 12 13C7.58172 13 4 15.0147 4 17.5C4 19.9853 4 22 12 22C14.231 22 15.8398 21.8433 17 21.5634"></path></svg></span></div>
              <div class="grid-cell sortable" role="columnheader" data-sort="rev" aria-sort="none" tabindex="0" aria-label="Rev"><span class="th-label-long">Rev</span><span class="th-label-short"><svg viewBox="0 0 256 256" fill="currentColor" aria-hidden="true"><path d="M192,208a8.00008,8.00008,0,0,1-8,8H56a8,8,0,0,1,0-16,28.03146,28.03146,0,0,0,28-28V140H56a8,8,0,0,1,0-16H84V84a52,52,0,0,1,88.76953-36.76953A8.00018,8.00018,0,0,1,161.45508,58.544,35.99961,35.99961,0,0,0,100,84v40h36a8,8,0,0,1,0,16H100v32a43.79679,43.79679,0,0,1-10.08447,28H184A8.00008,8.00008,0,0,1,192,208Z"></path></svg></span></div>
            </div>
          </div>
          <div id="traffic-sources-body" class="grid-body" role="rowgroup">
            <div class="grid-row" role="row"><div class="grid-cell empty span-all" role="cell">Open Settings (footer) → Traffic to choose channels.</div></div>
          </div>
        </div>
      </div>
    </div>
    <div class="stats-card" id="traffic-types-card">
      <div class="traffic-card-header">
        <h3 class="traffic-card-title">Traffic</h3>
      </div>
      <div class="country-table-wrap">
        <div id="traffic-types-table" class="grid-table by-country-table" role="table" aria-label="Traffic types">
          <div class="grid-header" role="rowgroup">
            <div class="grid-row grid-row--header" role="row">
              <div class="grid-cell sortable" role="columnheader" data-sort="type" aria-sort="none" tabindex="0" aria-label="Type"><span class="th-label-long">Type</span><span class="th-label-short">Type</span></div>
              <div class="grid-cell sortable" role="columnheader" data-sort="cr" aria-sort="none" tabindex="0" aria-label="CR%"><span class="th-label-long">CR%</span><span class="th-label-short"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M5 19L19 5M9 7C9 8.10457 8.10457 9 7 9C5.89543 9 5 8.10457 5 7C5 5.89543 5.89543 5 7 5C8.10457 5 9 5.89543 9 7ZM19 17C19 18.1046 18.1046 19 17 19C15.8954 19 15 18.1046 15 17C15 15.8954 15.8954 15 17 15C18.1046 15 19 15.8954 19 17Z"></path></svg></span></div>
              <div class="grid-cell sortable" role="columnheader" data-sort="orders" aria-sort="none" tabindex="0" aria-label="Orders"><span class="th-label-long">Orders</span><span class="th-label-short"><svg viewBox="0 0 32 32" fill="currentColor" aria-hidden="true"><path d="M29.4819,8.624l-10-5.5a1,1,0,0,0-.9638,0l-10,5.5a1,1,0,0,0,0,1.752L18,15.5913V26.3086l-3.0362-1.6693L14,26.3912l4.5181,2.4848a.9984.9984,0,0,0,.9638,0l10-5.5A1,1,0,0,0,30,22.5V9.5A1,1,0,0,0,29.4819,8.624ZM19,5.1416,26.9248,9.5,19,13.8584,11.0752,9.5Zm9,16.7671-8,4.4V15.5913l8-4.4Z"></path><rect x="2" y="14" width="8" height="2" transform="translate(12 30) rotate(-180)"></rect><rect x="4" y="22" width="8" height="2" transform="translate(16 46) rotate(-180)"></rect><rect x="6" y="18" width="8" height="2" transform="translate(20 38) rotate(-180)"></rect></svg></span></div>
              <div class="grid-cell sortable" role="columnheader" data-sort="sessions" aria-sort="none" tabindex="0" aria-label="Sessions"><span class="th-label-long">Sessions</span><span class="th-label-short"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><circle cx="12" cy="6" r="4"></circle><path d="M19.9975 18C20 17.8358 20 17.669 20 17.5C20 15.0147 16.4183 13 12 13C7.58172 13 4 15.0147 4 17.5C4 19.9853 4 22 12 22C14.231 22 15.8398 21.8433 17 21.5634"></path></svg></span></div>
              <div class="grid-cell sortable" role="columnheader" data-sort="rev" aria-sort="none" tabindex="0" aria-label="Rev"><span class="th-label-long">Rev</span><span class="th-label-short"><svg viewBox="0 0 256 256" fill="currentColor" aria-hidden="true"><path d="M192,208a8.00008,8.00008,0,0,1-8,8H56a8,8,0,0,1,0-16,28.03146,28.03146,0,0,0,28-28V140H56a8,8,0,0,1,0-16H84V84a52,52,0,0,1,88.76953-36.76953A8.00018,8.00018,0,0,1,161.45508,58.544,35.99961,35.99961,0,0,0,100,84v40h36a8,8,0,0,1,0,16H100v32a43.79679,43.79679,0,0,1-10.08447,28H184A8.00008,8.00008,0,0,1,192,208Z"></path></svg></span></div>
            </div>
          </div>
          <div id="traffic-types-body" class="grid-body" role="rowgroup">
            <div class="grid-row" role="row"><div class="grid-cell empty span-all" role="cell">Open Settings (footer) → Traffic to choose device types.</div></div>
          </div>
        </div>
      </div>
    </div>
  </div>
  </div>
  </div>

  <div id="tab-panel-ads" class="main-tab-panel" role="tabpanel" aria-labelledby="tab-ads">
    <div id="ads-root"></div>
  </div>

  <div id="side-panel" class="side-panel is-hidden">
    <header class="side-panel-header">
      <h3 class="side-panel-title">Session</h3>
      <button type="button" class="side-panel-close" id="side-close" aria-label="Close">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6L6 18M6 6l12 12"/></svg>
      </button>
    </header>
    <section class="side-panel-section">
      <h4 class="side-panel-section-title"><svg class="side-panel-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>Activity</h4>
      <ul class="side-panel-events" id="side-events"></ul>
    </section>
    <section class="side-panel-section">
      <h4 class="side-panel-section-title"><svg class="side-panel-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>Details</h4>
      <div class="side-panel-meta" id="side-meta"></div>
    </section>
    <section class="side-panel-section">
      <h4 class="side-panel-section-title"><svg class="side-panel-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>Source</h4>
      <div class="side-panel-source" id="side-source"></div>
    </section>
    <section class="side-panel-section">
      <h4 class="side-panel-section-title"><svg class="side-panel-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"/></svg>Network</h4>
      <div id="side-cf" class="side-panel-cf"></div>
    </section>
  </div>
  </main>
  <footer class="dashboard-footer" id="dashboard-footer">
    <span class="footer-last-sale">Last sale: <span id="last-sale-ago">—</span> <button type="button" id="last-sale-toggle" class="footer-last-sale-toggle" aria-pressed="false" aria-label="Show last sale toast">
      <svg class="toggle-icon toggle-icon-show" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M15.0007 12C15.0007 13.6569 13.6576 15 12.0007 15C10.3439 15 9.00073 13.6569 9.00073 12C9.00073 10.3431 10.3439 9 12.0007 9C13.6576 9 15.0007 10.3431 15.0007 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path><path d="M12.0012 5C7.52354 5 3.73326 7.94288 2.45898 12C3.73324 16.0571 7.52354 19 12.0012 19C16.4788 19 20.2691 16.0571 21.5434 12C20.2691 7.94291 16.4788 5 12.0012 5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg>
      <svg class="toggle-icon toggle-icon-hide" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M2.99902 3L20.999 21M9.8433 9.91364C9.32066 10.4536 8.99902 11.1892 8.99902 12C8.99902 13.6569 10.3422 15 11.999 15C12.8215 15 13.5667 14.669 14.1086 14.133M6.49902 6.64715C4.59972 7.90034 3.15305 9.78394 2.45703 12C3.73128 16.0571 7.52159 19 11.9992 19C13.9881 19 15.8414 18.4194 17.3988 17.4184M10.999 5.04939C11.328 5.01673 11.6617 5 11.9992 5C16.4769 5 20.2672 7.94291 21.5414 12C21.2607 12.894 20.8577 13.7338 20.3522 14.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg>
    </button></span>
    <button type="button" id="refresh-btn" class="refresh-btn" title="Refresh" aria-label="Refresh">
      <svg viewBox="0 0 329.028 329.028" xmlns="http://www.w3.org/2000/svg" fill="currentColor"><path d="M241.852,72.459l10.847-54.533c1.184-5.95-1.334-12.028-6.378-15.398c-5.045-3.37-11.623-3.37-16.667,0 L156.182,51.62c-0.004,0.003-0.008,0.006-0.012,0.009c-0.415,0.278-0.817,0.576-1.201,0.893c-0.219,0.181-0.418,0.377-0.625,0.568 c-0.148,0.137-0.304,0.265-0.447,0.408c-0.249,0.25-0.478,0.514-0.707,0.778c-0.088,0.101-0.183,0.196-0.268,0.299 c-0.208,0.253-0.396,0.519-0.586,0.783c-0.095,0.132-0.197,0.259-0.288,0.394c-0.155,0.232-0.292,0.473-0.433,0.712 c-0.109,0.185-0.225,0.365-0.327,0.554c-0.104,0.195-0.192,0.397-0.288,0.597c-0.118,0.245-0.24,0.487-0.344,0.739 c-0.064,0.156-0.115,0.317-0.174,0.475c-0.112,0.299-0.227,0.598-0.32,0.906c-0.042,0.137-0.069,0.276-0.106,0.414 c-0.09,0.329-0.181,0.658-0.248,0.996c-0.045,0.223-0.068,0.45-0.103,0.675c-0.038,0.252-0.088,0.501-0.113,0.758 c-0.051,0.498-0.075,0.998-0.076,1.5c0,0.004-0.001,0.009-0.001,0.013c0,0.058,0.008,0.113,0.009,0.17 c0.004,0.437,0.023,0.874,0.066,1.311c0.016,0.156,0.045,0.307,0.065,0.461c0.043,0.332,0.086,0.664,0.151,0.994 c0.042,0.212,0.102,0.418,0.152,0.627c0.064,0.264,0.124,0.529,0.204,0.791c0.077,0.256,0.173,0.503,0.264,0.753 c0.076,0.208,0.143,0.418,0.229,0.624c0.126,0.305,0.272,0.598,0.418,0.892c0.072,0.146,0.134,0.295,0.211,0.438 c0.203,0.379,0.426,0.745,0.66,1.104c0.036,0.055,0.064,0.113,0.1,0.167l0.019,0.028c0.01,0.015,0.02,0.03,0.03,0.045l49.044,73.401 c2.817,4.217,7.525,6.667,12.47,6.667c0.971,0,1.952-0.094,2.928-0.288c5.951-1.184,10.602-5.835,11.786-11.786l7.052-35.455 c23.901,20.188,39.11,50.36,39.11,84.023c0,60.636-49.331,109.968-109.967,109.968c-60.637,0-109.969-49.332-109.969-109.968 c0-40.179,21.91-77.153,57.179-96.494c7.264-3.983,9.923-13.101,5.94-20.365c-3.983-7.264-13.101-9.924-20.365-5.94 C52.424,90.871,24.546,137.924,24.546,189.06c0,77.178,62.79,139.968,139.969,139.968c77.178,0,139.967-62.79,139.967-139.968 C304.482,140.453,279.571,97.56,241.852,72.459z"/></svg>
    </button>
    <button type="button" id="audio-mute-btn" title="Toggle sale sound" aria-label="Toggle sale sound">
      <svg class="sound-icon-on" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M9.5 19C8.89555 19 7.01237 19 5.61714 19C4.87375 19 4.39116 18.2177 4.72361 17.5528L5.57771 15.8446C5.85542 15.2892 6 14.6774 6 14.0564C6 13.2867 6 12.1434 6 11C6 9 7 5 12 5C17 5 18 9 18 11C18 12.1434 18 13.2867 18 14.0564C18 14.6774 18.1446 15.2892 18.4223 15.8446L19.2764 17.5528C19.6088 18.2177 19.1253 19 18.382 19H14.5M9.5 19C9.5 21 10.5 22 12 22C13.5 22 14.5 21 14.5 19M9.5 19C11.0621 19 14.5 19 14.5 19"/><path d="M12 5V3"/></svg>
      <svg class="sound-icon-off is-hidden" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M6 15C6 15 6 13 6 11C6 9 7 5 12 5C13.5723 5 14.749 5.39552 15.6235 6M9.5 19C9.5 21 10.5 22 12 22C13.5 22 14.5 21 14.5 19M9.5 19C11.0621 19 14.5 19 14.5 19M9.5 19C9.14909 19 8.36719 19 7.5 19M14.5 19H18.382C19.1253 19 19.6088 18.2177 19.2764 17.5528L18 15C18 15 18 13 18 11C18 10.3755 17.9025 9.55594 17.6161 8.72408"/><path d="M12 5V3"/><path d="M21 3L3 21"/></svg>
    </button>
    <button type="button" id="config-open-btn" class="config-btn" title="Settings" aria-label="Settings">
      <svg width="18" height="18" viewBox="0 0 492.878 492.878" xmlns="http://www.w3.org/2000/svg" fill="currentColor" aria-hidden="true"><path d="M488.891,175.542l-0.4-1l-0.8-2l-1.6-4l-12.5-32.3l-0.4-1l-0.7-1.6l-0.5-1.1l-1.2-2.2c-1.5-2.6-3.1-4.6-5.1-6.5 c-3.9-3.8-8.7-6.6-14-8.1c-2.6-0.7-5.3-1.1-8.1-1.1c-1.4,0-2.7,0.1-4.1,0.2c-1.2,0.2-3,0.5-3.4,0.6l-8.5,1.7l-24.2,4.9 c-7.2-9.1-15.1-17.6-23.8-25.4l8.8-34.8l0.3-1.4c0.2-1.1,0.3-2.3,0.4-3.5c0.1-2,0.1-3.8-0.1-5.6c-0.4-3.7-1.4-7.4-2.9-10.8 c-3.1-6.8-8.6-12.6-15.4-15.9l-21.4-9.5l-21.3-9.3l-1.5-0.6c-1.1-0.4-2.3-0.7-3.5-1c-1.9-0.4-3.8-0.7-5.7-0.8 c-3.8-0.2-7.7,0.2-11.4,1.3c-7.4,2.1-14,6.7-18.5,12.9l-18.1,28.9c-10.6-1.1-21.4-1.4-32.2-0.8l-17.8-29.5l-0.8-1.2 c-0.7-1-1.5-2-2.4-3c-1.4-1.5-2.8-2.9-4.3-4.1c-3.1-2.5-6.6-4.4-10.3-5.8c-7.4-2.7-15.7-2.9-23.4-0.3c-2.3,0.8-2.7,1-3.7,1.4 l-2.6,1l-5.2,2.1l-10.5,4.2l-21.7,8.7l-1.3,0.6c-1,0.5-2.2,1.1-3.2,1.7c-1.8,1.1-3.4,2.3-4.9,3.6c-3,2.6-5.6,5.8-7.6,9.3 c-4,6.9-5.5,15.3-4.3,23.1l0.5,2.6l0.3,1.4l0.6,2.8l1.2,5.5l2.4,11l2.3,10.3c-8.6,7-16.5,14.8-23.7,23.2l-11.4-2.7l-11.5-2.7 l-5.8-1.3l-2.9-0.7l-1.6-0.3l-0.7-0.1l-1.5-0.2l-1.9-0.2c-8.5-0.6-16.7,1.8-23.3,6.7c-3.3,2.4-6.2,5.5-8.5,8.9 c-1.1,1.7-2.1,3.5-2.9,5.4l-1.2,2.8l-9,21.8l-4.3,9.7l-2.2,4.9l-0.8,2l-0.5,1.2c-0.3,0.8-0.7,2.2-1,3.2c-0.3,1.1-0.4,1.9-0.6,2.9 c-1.2,7.3,0,15,3.3,21.6c1.7,3.3,3.9,6.3,6.5,8.9c2.4,2.6,6.4,5.1,7.2,5.6l25.4,16.8c-1.1,10.5-1.3,21.1-0.7,31.6l-29.2,17.5 c-6.5,4.3-11.8,11.2-14.3,18.6c-2.6,7.4-2.8,15.8-0.2,23.5l8.7,22.1l8.6,21.7c3.2,7.3,9.2,13.8,16.4,17.5 c7.2,3.9,15.9,5.1,23.8,3.6l32.2-6.9c6.5,7.8,13.7,15.1,21.3,21.9l-7.7,32.4l-0.1,0.7l-0.2,1.4c-0.2,1.2-0.3,2.7-0.3,3.7 c-0.1,2,0,4.1,0.3,6.1c0.5,4.1,1.7,8,3.6,11.7c3.6,7.3,9.9,13.5,17.4,16.9l21.3,9l21.5,9c7.5,2.9,16.3,3.1,23.9,0.6 c7.7-2.4,14.6-7.6,19-14.3l18-28.5c10.7,0.8,21.4,0.8,32-0.1l15.7,24.8l1.4,2.2l1.2,1.8l1.1,1.5c0.7,0.9,1.4,1.8,2.1,2.5l1.9,1.9 c1.3,1.2,2.7,2.3,4.1,3.3c5.8,3.9,12.7,6,19.6,5.9c3.5,0,7-0.6,10.3-1.7l2.4-0.9l1.2-0.5l2.4-1l9.5-4c6.4-2.8,12.6-5.5,18.6-8.1 c3.2-1.5,6.4-2.9,9.5-4.3l1.1-0.5c0.4-0.2,1.5-0.8,2.3-1.3c1.7-1,2.6-1.8,3.9-2.8c2.3-1.9,4.3-4.2,5.9-6.5 c3.3-4.8,5.1-10.3,5.4-15.7c0.2-2.7,0-5.3-0.5-7.8l-0.4-1.9c-0.2-0.7-0.2-0.8-0.3-1.2l-0.6-1.9c-1.6-5.1-3.2-9.9-4.8-14.1 c-6.2-17-11.8-26.6-15.8-23.6c-3.6,2.7-4.8,14-3.7,31.7c0.3,4.3,0.8,9.4,1.2,14.2c-0.1,2.2-1.3,4.1-2.9,5.1c-0.3,0.2-1,0.6-1,0.5 c0.4-0.2-0.7,0.3-1.4,0.5c0.2-0.1-0.5,0.2,0.5-0.2l0,0h-0.1h-0.1l-0.3,0.1l-1,0.3l-1.1,0.4c-2.9,1-6,2.1-9.1,3.1 c-6.2,2.2-12.6,4.5-19.3,7.1l-9.3,3.5c-2.1,0.8-1.7,0.6-2.2,0.7c-0.3,0.1-0.7,0-1-0.1c-0.7-0.1-1.3-0.5-1.8-0.9 c-0.1-0.1-0.1-0.1-0.2-0.2c-0.1-0.2-0.3-0.5-0.5-0.7l-2.2-3.7c-6.7-11.4-13.4-22.9-20.2-34.4c-2.7-4.7-8-7.5-13.8-6.9l-0.5,0.1 c-15.6,1.7-31.5,1.4-47-1.3c-5.7-1-11.6,1.4-15,6.5l-0.2,0.4c-8.2,12.3-16.3,24.6-24.5,37c-0.3,0.3-0.4,0.3-0.6,0.3 c-0.1,0-0.1,0-0.1,0l-19.3-8.4l-20.3-8.9l-0.6-0.3c-0.1-0.1,0,0-0.1-0.1l0,0l0,0v-0.1c3.3-13.8,6.6-27.6,9.9-41.3l0.5-2.1v-0.1 c1.5-6.2-0.7-12.9-6.1-17c-12.4-9.4-23.3-20.6-32.7-33.2l-0.1-0.1c-3.7-5-10.2-7.6-16.6-6.2l-43.3,9.7c-0.4,0.1-0.6,0.2-0.9-0.4 l-8.2-20.1l-8.1-19.8c-0.3-0.5-0.1-1.7,0.6-2.1l37.7-23.4l0.2-0.1c4.9-3,7.8-8.7,6.9-14.8c-2.2-15.6-2.2-31.5,0.1-47v-0.3 c0.8-5.5-1.6-11.3-6.6-14.4l-37.6-23.8c-1-0.6-1.5-1.8-1.1-3.1l8.4-20.1l8.5-20.3c0.5-1.2,1.7-2.2,3.7-1.8l43.1,10l0.2,0.1 c4.9,1.1,10.2-0.6,13.3-4.9c5.8-7.8,12.3-15,19.4-21.6c5-4.2,10.2-8,15.7-11.6c4.2-2.8,6.6-7.9,5.6-13.1l-0.2-0.9 c-2.6-14.4-5.2-28.9-7.9-43.4c0-0.5,0.2-0.8,0.5-1c0.1-0.1,0.2-0.2,0.4-0.2l0.2-0.1c-0.1,0.1-0.3,0.2-0.4,0.3l1.1-0.5l20.5-7.6 l10.6-3.9l5.3-2l2.6-1l1.3-0.5c0.2-0.2,0.6,0,0.5-0.5c0,0,0,0.6,0,0.5c0,0,0.1-0.2,0.2-0.3l0,0l0.2,0.3l0.2,0.3 c-1.7-0.8-0.5-0.2-0.8-0.3l0,0v0.1l0.1,0.2l0.4,0.6l0.7,1.2l1.4,2.4l2.9,4.9l5.7,9.7l11.5,19.5c3.4,5.8,10.1,9.4,17.2,8.6l0.6-0.1 c15.1-1.7,30.6-1,46,1.5c7.1,1.2,14.5-1.9,18.6-8.3l0.2-0.4l12.1-18.8l6.1-9.4l3-4.7l1.3-2l0.3,0.1l2.6,1.1l5.1,2.2l10.3,4.5 l10.3,4.5l5.2,2.2l2,0.9v0.1l-0.7,2.7l-1.3,5.5l-2.7,10.9l-5.3,21.8c-1.8,7.3,0.7,15.4,7,20.4l0,0c12,9.4,22.7,20.4,31.5,32.7 c4.5,6.2,12.4,9.6,20.4,7.9l22-4.8l11-2.4l5.5-1.2l2-0.4v0.1l1.1,2.6l2.1,5.2l4.2,10.4l4.2,10.4l2.1,5.2l0.9,2.2l-0.1,0.1 l-2.4,1.5l-4.8,2.9l-9.6,5.9l-19.2,11.8h-0.1c-6.4,3.9-10.2,11.3-9.2,19.2c1.9,15,1.6,30.4-0.7,45.7c-1.1,7.4,2.1,15.1,8.8,19.5 l18.9,12.1l9.5,6.1l4.7,3l1.9,1.2l-0.1,0.2l-1.1,2.6l-2.2,5.2l-4.4,10.3l-4.4,10.3l-2.2,5.1l-0.8,1.8l-0.2-0.1l-2.7-0.7l-5.4-1.4 l-10.9-2.7l-21.7-5.4c-7.2-1.8-15.2,0.6-20.2,6.7l-0.4,0.5l-2.6,3.2c-3.8,4.6-8.3,10.8-12.6,16.4c-4.2,5.6-8.2,10.7-9.8,13.5 c-3.5,5.7-1.5,7,4.3,5.2c5.6-1.7,14.8-6.9,24.5-15c4-3.3,7.8-6.9,11.9-11.1l0.1-0.1c0.1-0.1,0.2-0.1,0.3-0.1 c12.8,4.7,26,9.3,39.7,13.9c1.7,0.5,3.3,1.2,5.7,1.6c2.4,0.4,4.6,0.3,6.9-0.1c4.6-0.8,9.1-3.1,12.4-6.8c0.8-0.9,1.6-1.9,2.3-2.9 c0.7-1,1.3-2.3,1.7-3l2.6-5c1.7-3.3,3.4-6.7,5.1-10c3.4-6.7,6.8-13.5,10.3-20.4l1.3-2.6l0.7-1.7c0.2-0.3,0.5-1.4,0.8-2.2 c0.9-3.1,1.2-5.9,1-9c-0.4-6-2.9-11.9-7.2-16.4c-1.1-1.1-2.2-2.2-3.5-3.1l-2.7-1.9l-4.8-3.4c-3.2-2.3-6.5-4.5-9.7-6.8 c-4.4-3-8.8-6.1-13.2-9.2c1.9-12.5,2.6-25.5,1.8-38.6c9.6-5.7,19.2-11.3,28.9-17.1l1.9-1.1l0.9-0.6l1.4-0.9l0.5-0.4l1-0.7 c0.6-0.5,1.3-1.1,1.8-1.5c1-0.9,1.9-1.8,2.8-2.8c3.4-4,5.8-8.9,6.8-14c1.1-5.1,0.8-10.6-0.9-15.7L488.891,175.542z"/><path d="M310.491,267.942l-1.4,3.9c-0.8,2.7-2.3,5-3.3,7.6c-2.7,4.8-5.6,9.6-9.4,13.8c-7.2,8.6-16.7,15.4-27.3,20 c-3,1.5-6,2.4-8.7,3.9c-2.8,1-5.3,2.5-7.4,3.9c-4.3,2.6-7.3,6.1-6.8,10.6c0.5,4.1,3.7,7.6,9.5,10.1c2.9,0.9,6.5,1.7,10.5,1.8 c4-0.2,8.5-0.3,13.1-1.9c8.5-2.2,16.4-6,24.1-10.4c7.5-4.6,14.6-10.2,20.7-16.7c6-6.6,11.5-13.8,15.5-21.9 c2.2-3.9,3.7-8.2,5.4-12.4c0.8-2.1,1.3-4.3,1.9-6.5s1.2-4.3,1.6-6.8l0.9-5.8l0.4-2.9l0.1-2.3l0.2-4.6l0.1-1.1v-0.6v-0.3v-0.9v-0.1 v-0.2l-0.1-2.7c-0.2-7.2-1.1-14.4-2.9-21.4c-3.5-14-10-27.2-18.9-38.4c-17.7-22.6-44.9-36.5-73.2-37.9c-11.9-2.4-25.4-2.4-38,0.6 c-12.8,2.9-25.1,8.6-35.8,16.5c-10.7,8-19.9,18.2-26.8,29.9l-4.7,9c-1.3,3.1-2.5,6.3-3.8,9.5c-1,3.2-1.9,6.5-2.8,9.8 c-0.8,3.5-1.3,7.3-1.9,10.9l-0.2,1.4l0.1,1.2l-0.1,2.1l-0.3,4.1l-0.1,1v0.5v1.1v0.2v0.3l0.1,2.5l0.2,5.1 c0.4,6.8,1.5,13.5,3.3,20.1c3.5,13.2,9.5,25.6,17.6,36.5s18.2,20.2,29.7,27.3c2.8,1.9,5.8,3.5,8.9,5c3,1.6,6.1,2.9,9.3,4.1 c3.1,1.3,6.4,2.4,9.6,3.3l4.9,1.4l5.5,1c6,1.2,11.7-2.2,13.9-4.4c4.1-4.6-0.5-9-7.8-12.8c-12.1-6.8-22.7-14.8-32-24 c-9.1-9.4-16.7-20.1-21.8-31.8c-3.2-7-4.9-14.6-5.6-22.1c-0.1-1.9-0.5-3.8-0.3-5.7l0.1-2.8v-1.4v-0.7v-0.2c0.5-4.4,0.9-9.4,1.8-12 l0.5-2.4c0.2-0.8,0.6-1.7,0.8-2.6c0.6-1.7,1-3.6,1.8-5.2l2.2-5.1l2.7-4.8c3.8-6.3,8.5-11.9,13.9-16.8c5.4-4.8,11.6-8.7,18.1-11.7 c3.2-1.6,6.7-2.6,10.1-3.8c3.5-0.8,6.9-1.7,10.5-2l2.7-0.4l2.7-0.1l2.7-0.1l1.3-0.1h0.1h0.7l6.9,0.4l4.7,0.7 c6.6,1.1,13.9,3.4,20.4,6.5c6.1,3.9,11.5,8.8,16.1,14.2c14.9,17.1,20.2,41.2,14.5,62.7L310.491,267.942z"/></svg>
    </button>
  </footer>

  <div class="config-modal" id="config-modal" aria-hidden="true">
    <div class="config-modal-card" role="dialog" aria-modal="true" aria-label="Settings">
      <div class="config-modal-header">
        <div class="config-modal-header-inner">
          <h3 class="config-modal-title">Settings</h3>
        </div>
        <div class="config-modal-actions">
          <button type="button" id="config-refresh-btn" class="config-btn config-refresh-btn" title="Refresh diagnostics" aria-label="Refresh diagnostics">
            <svg viewBox="0 0 329.028 329.028" xmlns="http://www.w3.org/2000/svg" fill="currentColor" aria-hidden="true"><path d="M241.852,72.459l10.847-54.533c1.184-5.95-1.334-12.028-6.378-15.398c-5.045-3.37-11.623-3.37-16.667,0 L156.182,51.62c-0.004,0.003-0.008,0.006-0.012,0.009c-0.415,0.278-0.817,0.576-1.201,0.893c-0.219,0.181-0.418,0.377-0.625,0.568 c-0.148,0.137-0.304,0.265-0.447,0.408c-0.249,0.25-0.478,0.514-0.707,0.778c-0.088,0.101-0.183,0.196-0.268,0.299 c-0.208,0.253-0.396,0.519-0.586,0.783c-0.095,0.132-0.197,0.259-0.288,0.394c-0.155,0.232-0.292,0.473-0.433,0.712 c-0.109,0.185-0.225,0.365-0.327,0.554c-0.104,0.195-0.192,0.397-0.288,0.597c-0.118,0.245-0.24,0.487-0.344,0.739 c-0.064,0.156-0.115,0.317-0.174,0.475c-0.112,0.299-0.227,0.598-0.32,0.906c-0.042,0.137-0.069,0.276-0.106,0.414 c-0.09,0.329-0.181,0.658-0.248,0.996c-0.045,0.223-0.068,0.45-0.103,0.675c-0.038,0.252-0.088,0.501-0.113,0.758 c-0.051,0.498-0.075,0.998-0.076,1.5c0,0.004-0.001,0.009-0.001,0.013c0,0.058,0.008,0.113,0.009,0.17 c0.004,0.437,0.023,0.874,0.066,1.311c0.016,0.156,0.045,0.307,0.065,0.461c0.043,0.332,0.086,0.664,0.151,0.994 c0.042,0.212,0.102,0.418,0.152,0.627c0.064,0.264,0.124,0.529,0.204,0.791c0.077,0.256,0.173,0.503,0.264,0.753 c0.076,0.208,0.143,0.418,0.229,0.624c0.126,0.305,0.272,0.598,0.418,0.892c0.072,0.146,0.134,0.295,0.211,0.438 c0.203,0.379,0.426,0.745,0.66,1.104c0.036,0.055,0.064,0.113,0.1,0.167l0.019,0.028c0.01,0.015,0.02,0.03,0.03,0.045l49.044,73.401 c2.817,4.217,7.525,6.667,12.47,6.667c0.971,0,1.952-0.094,2.928-0.288c5.951-1.184,10.602-5.835,11.786-11.786l7.052-35.455 c23.901,20.188,39.11,50.36,39.11,84.023c0,60.636-49.331,109.968-109.967,109.968c-60.637,0-109.969-49.332-109.969-109.968 c0-40.179,21.91-77.153,57.179-96.494c7.264-3.983,9.923-13.101,5.94-20.365c-3.983-7.264-13.101-9.924-20.365-5.94 C52.424,90.871,24.546,137.924,24.546,189.06c0,77.178,62.79,139.968,139.969,139.968c77.178,0,139.967-62.79,139.967-139.968 C304.482,140.453,279.571,97.56,241.852,72.459z"/></svg>
          </button>
          <button type="button" id="config-reconcile-btn" class="config-btn config-reconcile-btn" title="Sync Shopify orders (7d)" aria-label="Sync Shopify orders (7d)">
            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
              <path d="M7 10l5 5 5-5" />
              <path d="M12 15V3" />
            </svg>
          </button>
          <button type="button" class="config-close" id="config-close-btn" aria-label="Close">×</button>
        </div>
      </div>
      <div id="config-status"><div class="dm-loading-spinner"><div class="report-build-wrap"><div class="spinner"></div><div class="report-build-title">building diagnostics</div><div class="report-build-step">—</div></div></div></div>
    </div>
  </div>

  <div class="config-modal" id="kpi-compare-modal" aria-hidden="true">
    <div class="config-modal-card kpi-compare-modal-card" role="dialog" aria-modal="true" aria-label="KPI comparison">
      <div class="kpi-compare-modal-header">
        <div class="kpi-compare-modal-header-left">
          <div class="kpi-compare-kicker" id="kpi-compare-kicker">KPI</div>
          <h3 class="kpi-compare-title">Shopify vs Kexo</h3>
          <div class="kpi-compare-meta" id="kpi-compare-updated">Updated —</div>
        </div>
        <div class="kpi-compare-modal-actions">
          <button type="button" id="kpi-compare-refresh-btn" class="kpi-compare-action-btn" title="Refresh comparison" aria-label="Refresh comparison">
            <svg viewBox="0 0 329.028 329.028" xmlns="http://www.w3.org/2000/svg" fill="currentColor" aria-hidden="true"><path d="M241.852,72.459l10.847-54.533c1.184-5.95-1.334-12.028-6.378-15.398c-5.045-3.37-11.623-3.37-16.667,0 L156.182,51.62c-0.004,0.003-0.008,0.006-0.012,0.009c-0.415,0.278-0.817,0.576-1.201,0.893c-0.219,0.181-0.418,0.377-0.625,0.568 c-0.148,0.137-0.304,0.265-0.447,0.408c-0.249,0.25-0.478,0.514-0.707,0.778c-0.088,0.101-0.183,0.196-0.268,0.299 c-0.208,0.253-0.396,0.519-0.586,0.783c-0.095,0.132-0.197,0.259-0.288,0.394c-0.155,0.232-0.292,0.473-0.433,0.712 c-0.109,0.185-0.225,0.365-0.327,0.554c-0.104,0.195-0.192,0.397-0.288,0.597c-0.118,0.245-0.24,0.487-0.344,0.739 c-0.064,0.156-0.115,0.317-0.174,0.475c-0.112,0.299-0.227,0.598-0.32,0.906c-0.042,0.137-0.069,0.276-0.106,0.414 c-0.09,0.329-0.181,0.658-0.248,0.996c-0.045,0.223-0.068,0.45-0.103,0.675c-0.038,0.252-0.088,0.501-0.113,0.758 c-0.051,0.498-0.075,0.998-0.076,1.5c0,0.004-0.001,0.009-0.001,0.013c0,0.058,0.008,0.113,0.009,0.17 c0.004,0.437,0.023,0.874,0.066,1.311c0.016,0.156,0.045,0.307,0.065,0.461c0.043,0.332,0.086,0.664,0.151,0.994 c0.042,0.212,0.102,0.418,0.152,0.627c0.064,0.264,0.124,0.529,0.204,0.791c0.077,0.256,0.173,0.503,0.264,0.753 c0.076,0.208,0.143,0.418,0.229,0.624c0.126,0.305,0.272,0.598,0.418,0.892c0.072,0.146,0.134,0.295,0.211,0.438 c0.203,0.379,0.426,0.745,0.66,1.104c0.036,0.055,0.064,0.113,0.1,0.167l0.019,0.028c0.01,0.015,0.02,0.03,0.03,0.045l49.044,73.401 c2.817,4.217,7.525,6.667,12.47,6.667c0.971,0,1.952-0.094,2.928-0.288c5.951-1.184,10.602-5.835,11.786-11.786l7.052-35.455 c23.901,20.188,39.11,50.36,39.11,84.023c0,60.636-49.331,109.968-109.967,109.968c-60.637,0-109.969-49.332-109.969-109.968 c0-40.179,21.91-77.153,57.179-96.494c7.264-3.983,9.923-13.101,5.94-20.365c-3.983-7.264-13.101-9.924-20.365-5.94 C52.424,90.871,24.546,137.924,24.546,189.06c0,77.178,62.79,139.968,139.969,139.968c77.178,0,139.967-62.79,139.967-139.968 C304.482,140.453,279.571,97.56,241.852,72.459z"/></svg>
            <span>Refresh</span>
          </button>
          <button type="button" class="kpi-compare-close-btn" id="kpi-compare-close-btn" aria-label="Close">×</button>
        </div>
      </div>
      <div class="kpi-compare-modal-body" id="kpi-compare-status">
        <div class="kpi-compare-loading"><div class="report-build-wrap"><div class="spinner"></div><div class="report-build-title">building KPI comparison</div><div class="report-build-step">—</div></div></div>
      </div>
    </div>
  </div>

  <div class="config-modal" id="date-custom-modal" aria-hidden="true">
    <div class="config-modal-card" role="dialog" aria-modal="true" aria-label="Choose dates">
      <div class="config-modal-header">
        <h3 class="config-modal-title">Choose dates</h3>
        <button type="button" class="config-close" id="date-custom-close-btn" aria-label="Close">×</button>
      </div>
      <div class="muted u-mb-sm">Click a start date, then an end date (last 30 days). Grey dates have no data.</div>
      <div id="date-custom-calendar" class="date-cal"></div>
      <div class="date-cal-footer">
        <div class="date-cal-summary" id="date-custom-summary">Select a start date.</div>
        <div class="date-cal-actions">
          <button type="button" class="date-cal-btn" id="date-custom-clear" disabled>Clear</button>
          <button type="button" class="date-cal-btn primary" id="date-custom-apply" disabled>Apply</button>
        </div>
      </div>
    </div>
  </div>

  <div class="sale-toast-overlay" id="sale-toast-overlay" aria-hidden="true">
    <div class="sale-toast" id="sale-toast" aria-hidden="true">
      <div class="sale-toast-thumb" id="sale-toast-thumb" aria-hidden="true"></div>
      <div class="sale-toast-mid">
        <div class="sale-toast-title"><span id="sale-toast-inline-flag" aria-hidden="true"></span><span id="sale-toast-title">—</span></div>
        <div class="sale-toast-product" id="sale-toast-product">—</div>
      </div>
      <div class="sale-toast-amount-wrap">
        <div class="sale-toast-amount" id="sale-toast-amount">£—</div>
        <div class="sale-toast-time">
          <svg class="sale-toast-time-icon" viewBox="0 0 32 32" fill="currentColor" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <title>time</title>
            <path d="M0 16q0-3.232 1.28-6.208t3.392-5.12 5.12-3.392 6.208-1.28q3.264 0 6.24 1.28t5.088 3.392 3.392 5.12 1.28 6.208q0 3.264-1.28 6.208t-3.392 5.12-5.12 3.424-6.208 1.248-6.208-1.248-5.12-3.424-3.392-5.12-1.28-6.208zM4 16q0 3.264 1.6 6.048t4.384 4.352 6.016 1.6 6.016-1.6 4.384-4.352 1.6-6.048-1.6-6.016-4.384-4.352-6.016-1.632-6.016 1.632-4.384 4.352-1.6 6.016zM14.016 16v-5.984q0-0.832 0.576-1.408t1.408-0.608 1.408 0.608 0.608 1.408v4h4q0.8 0 1.408 0.576t0.576 1.408-0.576 1.44-1.408 0.576h-6.016q-0.832 0-1.408-0.576t-0.576-1.44z"></path>
          </svg>
          <span id="sale-toast-time">—</span>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API = '';
    const LIVE_REFRESH_MS = 60000;
    const RANGE_REFRESH_MS = 5 * 60 * 1000; // Today and Sales refresh every 5 min
    const ACTIVE_WINDOW_MS = 10 * 60 * 1000; // Live view: only show sessions seen in last 10 min
    const ARRIVED_WINDOW_MS = 60 * 60 * 1000; // Live view: only show sessions that arrived in last 60 min
    const STATS_REFRESH_MS = 5 * 60 * 1000; // Breakdown / Products / Traffic refresh (Today only)
    const SALE_MUTED_KEY = 'livevisitors-sale-muted';
    const TOP_TABLE_PAGE_SIZE = 10;
    const COUNTRY_PAGE_SIZE = 11;
    const COUNTRY_PRODUCTS_PAGE_SIZE = 10;
    const BREAKDOWN_PAGE_SIZE = 4;
    const ROWS_PER_PAGE_DEFAULT = 25;
    function loadRowsPerPage() {
      return ROWS_PER_PAGE_DEFAULT;
    }
    let rowsPerPage = loadRowsPerPage();
    let sessions = [];
    let sessionsLoadError = null;
    let statsCache = {};
    let trafficCache = null;
    let trafficTypeExpanded = null; // device -> boolean (Traffic Type tree) — null = first render, default all open
    let dateRange = 'live';
    let customRangeStartYmd = null; // YYYY-MM-DD (admin TZ)
    let customRangeEndYmd = null; // YYYY-MM-DD (admin TZ)
    let pendingCustomRangeStartYmd = null; // modal-only pending selection
    let pendingCustomRangeEndYmd = null; // modal-only pending selection
    let customCalendarLastPayload = null; // last /api/available-days payload used for rendering
    /** When dateRange is 'live' or 'sales', stats/KPIs use today's data; only the main table shows those special views. */
    function getStatsRange() { return (dateRange === 'live' || dateRange === 'sales' || dateRange === '1h') ? 'today' : dateRange; }
    function getKpiData() {
      if (kpiCache) return kpiCache;
      if (getStatsRange() === 'today') return {};
      return statsCache || {};
    }
    let activeMainTab = 'spy';
    let nextLiveAt = 0;
    let nextRangeAt = 0; // next refresh for Today/Sales (5 min)
    let lastSessionsFetchedAt = 0;
    let lastSessionsMode = null; // 'live' or 'range' - helps avoid Online count flicker when switching modes
    let lastStatsFetchedAt = 0;
    let lastKpisFetchedAt = 0;
    let lastTrafficFetchedAt = 0;
    let lastProductsFetchedAt = 0;
    let lastBreakdownFetchedAt = 0;
    let kpiCache = null;
    let liveRefreshInFlight = null;
    let statsRefreshInFlight = null;
    let trafficRefreshInFlight = null;
    let productsRefreshInFlight = null;
    let breakdownRefreshInFlight = null;
    let kpisRefreshInFlight = null;
    let configStatusRefreshInFlight = null;
    let activeKpiCompareKey = 'conv';
    let reportBuildTokens = { stats: 0, breakdown: 0, products: 0, traffic: 0 };
    let lastUpdateTime = null;
    let lastConvertedCountToday = 0;
    let hasSeenConvertedCountToday = false; // prevents "sale" triggers on first load
    let convertedCountDayYmd = null; // YYYY-MM-DD in admin TZ; resets converted-count baseline daily
    let lastSaleAt = null; // ms; authoritative timestamp of most recent sale we know about (Shopify truth preferred)
    let lastOnlineCount = null; // when dateRange !== 'live', we fetch active count so Online always shows real people online
    let onlineCountInFlight = false;
    let shopifySalesToday = null;
    let shopifyOrderCountToday = null;
    let shopifySalesTodayLoaded = false; // true once we have attempted to fetch (success or failure)
    let shopifySalesTodayLoading = false;
    let shopifySessionsToday = null;
    let shopifySessionsTodayLoaded = false;
    let shopifySessionsTodayLoading = false;
    const PRODUCTS_LEADERBOARD_VIEW_KEY = 'products-leaderboard-view';
    const PRODUCTS_LEADERBOARD_FETCH_LIMIT = 20;
    let productsLeaderboardView = 'title';
    let leaderboardCache = null;
    let leaderboardLoading = false;
    const PRODUCTS_VARIANT_CARDS_VIEW_KEY = 'products-variant-cards-view';
    let productsVariantCardsView = 'finishes';
    let finishesCache = null;
    let finishesLoading = false;
    let lengthsCache = null;
    let lengthsLoading = false;
    let chainStylesCache = null;
    let chainStylesLoading = false;
    let bestSellersCache = null;
    let bestVariantsCache = null;
    let countryPage = 1;
    let lastCountryRowCount = 0;
    let bestGeoProductsPage = 1;
    let bestSellersPage = 1;
    let bestVariantsPage = 1;
    let bestSellersSortBy = 'rev';
    let bestSellersSortDir = 'desc';
    const tableSortState = {
      country: { by: 'rev', dir: 'desc' },
      bestGeoProducts: { by: 'rev', dir: 'desc' },
      aov: { by: 'aov', dir: 'desc' },
      bestVariants: { by: 'rev', dir: 'desc' },
      trafficSources: { by: 'rev', dir: 'desc' },
      trafficTypes: { by: 'rev', dir: 'desc' },
    };
    const TABLE_SORT_DEFAULTS = {
      country: { country: 'asc', cr: 'desc', sales: 'desc', clicks: 'desc', rev: 'desc' },
      bestGeoProducts: { country: 'asc', cr: 'desc', sales: 'desc', clicks: 'desc', rev: 'desc' },
      aov: { aov: 'desc' },
      bestVariants: { variant: 'asc', sales: 'desc', clicks: 'desc', rev: 'desc', cr: 'desc' },
      trafficSources: { source: 'asc', cr: 'desc', orders: 'desc', sessions: 'desc', rev: 'desc' },
      trafficTypes: { type: 'asc', cr: 'desc', orders: 'desc', sessions: 'desc', rev: 'desc' },
    };
    let saleAudio = null;
    let saleMuted = false;
    let saleAudioPrimed = false;
    let saleSoundDeferredOnce = false;
    let saleToastActive = false;
    let saleToastToken = 0; // increments per toast trigger; prevents stale latest-sale fetch overwriting newer toasts
    let saleToastSessionId = null; // best-effort: session_id that opened the current toast (used to avoid double plays)
    let saleToastHideTimer = null;
    let saleToastLastOrderId = null;
    let saleToastLastPayload = null;
    let saleToastPinned = false;
    let saleToastLastShownAt = 0;
    let currentPage = 1;
    let sortBy = 'last_seen';
    let sortDir = 'desc';
    const SORT_DEFAULTS = { landing: 'asc', from: 'asc', arrived: 'desc', source: 'asc', device: 'asc', cart: 'desc', last_seen: 'desc', history: 'desc' };

    (function restoreProductsVariantCardsView() {
      try {
        const raw = sessionStorage.getItem(PRODUCTS_VARIANT_CARDS_VIEW_KEY);
        const s = raw != null ? String(raw).trim().toLowerCase() : '';
        productsVariantCardsView = (s === 'lengths' || s === 'length') ? 'lengths' : 'finishes';
      } catch (_) {
        productsVariantCardsView = 'finishes';
      }
    })();

    (function restoreProductsLeaderboardView() {
      try {
        const raw = sessionStorage.getItem(PRODUCTS_LEADERBOARD_VIEW_KEY);
        const s = raw != null ? String(raw).trim().toLowerCase() : '';
        productsLeaderboardView = (s === 'type') ? 'type' : 'title';
      } catch (_) {
        productsLeaderboardView = 'title';
      }
    })();

    // Auto-configure pixel when opened from Shopify (shop in URL) so merchants don't run mutations manually
    (function ensurePixelOnce() {
      const params = new URLSearchParams(window.location.search);
      const shop = params.get('shop');
      if (shop && /\.myshopify\.com$/i.test(shop)) {
        fetch(API + '/api/pixel/ensure?shop=' + encodeURIComponent(shop), { credentials: 'same-origin' })
          .then(function (r) { return r.json(); })
          .then(function (data) {
            if (data.ok && data.action) console.log('[Live Visitors] Pixel', data.action);
          })
          .catch(function () {});
      }
    })();
    // 'active' = Live view (last 5 min + arrived 60 min). Range mode uses ?range= with pagination.
    let filter = 'active';
    let sessionsTotal = null; // set when fetching by range (today/yesterday/3d/7d); null for Live
    let selectedSessionId = null;
    let timeTick = null;
    const tz = 'Europe/London';
    const MIN_YMD = '2026-02-08';

    function floorAllowsYesterday() {
      try {
        return ymdNowInTz() > MIN_YMD;
      } catch (_) {
        return true;
      }
    }

    function updateServerTimeDisplay() {
      const el = document.getElementById('server-time-msg');
      if (!el) return;
      var now = new Date();
      el.textContent = now.toLocaleTimeString('en-GB', { timeZone: tz, hour: '2-digit', minute: '2-digit', hour12: false });
    }

    function updateNextUpdateUi() {
      const block = document.querySelector('#tab-panel-spy .next-update-block');
      if (!block) return;
      const labelEl = document.getElementById('next-update-label');
      const timerWrap = document.getElementById('next-update-timer-wrap');
      const isLive = dateRange === 'live';
      const show = activeMainTab === 'spy' && (isLive || dateRange === 'sales' || dateRange === 'today' || dateRange === '1h');
      block.classList.toggle('is-hidden', !show);
      if (!show) return;

      if (labelEl) labelEl.classList.toggle('is-hidden', isLive);
      if (timerWrap) timerWrap.classList.toggle('is-hidden', isLive);
      if (isLive) {
        if (timerWrap) timerWrap.style.setProperty('--progress', '0');
        return;
      }
      if (!timerWrap) return;

      const duration = RANGE_REFRESH_MS;
      const target = (typeof nextRangeAt === 'number' && nextRangeAt > Date.now())
        ? nextRangeAt
        : (Date.now() + RANGE_REFRESH_MS);
      const remaining = Math.max(0, target - Date.now());
      const progress = Math.min(1, 1 - remaining / duration);
      timerWrap.style.setProperty('--progress', String(progress));
    }

    function toMs(v) {
      if (v == null || v === '') return null;
      let n = typeof v === 'number' ? v : Number(v);
      if (Number.isNaN(n)) return null;
      if (n < 1e12) n *= 1000;
      return n;
    }

    function formatTs(ms) {
      const n = toMs(ms);
      if (n == null) return '\u2014';
      const d = new Date(n);
      if (Number.isNaN(d.getTime())) return '\u2014';
      return d.toLocaleString('en-GB', { timeZone: tz, dateStyle: 'short', timeStyle: 'short' });
    }

    function formatRelative(ms) {
      const n = toMs(ms);
      if (n == null) return '';
      const s = Math.floor((Date.now() - n) / 1000);
      if (s < 60) return s + 's ago';
      if (s < 3600) return Math.floor(s / 60) + 'm ago';
      return Math.floor(s / 3600) + 'h ago';
    }

    function formatSaleTime(ms) {
      const n = toMs(ms);
      if (n == null) return '\u2014';
      const d = new Date(n);
      if (Number.isNaN(d.getTime())) return '\u2014';
      try {
        return d.toLocaleTimeString('en-GB', { timeZone: tz, hour: '2-digit', minute: '2-digit', hour12: false });
      } catch (_) {
        return d.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', hour12: false });
      }
    }

    function ymdNowInTz() {
      try {
        // en-CA yields YYYY-MM-DD.
        return new Intl.DateTimeFormat('en-CA', { timeZone: tz, year: 'numeric', month: '2-digit', day: '2-digit' }).format(new Date());
      } catch (_) {
        return new Date().toISOString().slice(0, 10);
      }
    }

    function updateLastSaleAgo() {
      const el = document.getElementById('last-sale-ago');
      if (!el) return;
      if (lastSaleAt == null) { el.textContent = '\u2014'; return; }
      el.textContent = formatRelative(lastSaleAt);
    }

    function setLastSaleAt(ms) {
      const n = toMs(ms);
      if (n == null) return;
      const cur = lastSaleAt == null ? null : toMs(lastSaleAt);
      if (cur == null || n > cur) {
        lastSaleAt = n;
        updateLastSaleAgo();
      }
    }

    function formatDuration(startMs) {
      const n = toMs(startMs);
      if (n == null) return '';
      const s = Math.floor((Date.now() - n) / 1000);
      const m = Math.floor(s / 60);
      const h = Math.floor(m / 60);
      if (h > 0) return h + 'h ' + (m % 60) + 'm';
      if (m > 0) return m + 'm ' + (s % 60) + 's';
      return s + 's';
    }

    var countryNames = { GB: 'UK', US: 'USA', CA: 'CA', AU: 'AU', DE: 'DE', FR: 'FR', IE: 'IE', ES: 'ES', IT: 'IT', NL: 'NL', IN: 'IN', JP: 'JP', DK: 'DK', SE: 'SE', NO: 'NO', TH: 'TH', NZ: 'NZ', RO: 'RO', BE: 'BE', FI: 'FI', AE: 'UAE', XX: '\u2014' };
    var countryNamesFull = { GB: 'United Kingdom', US: 'United States', CA: 'Canada', AU: 'Australia', DE: 'Germany', FR: 'France', IE: 'Ireland', ES: 'Spain', IT: 'Italy', NL: 'Netherlands', IN: 'India', JP: 'Japan', DK: 'Denmark', SE: 'Sweden', NO: 'Norway', TH: 'Thailand', NZ: 'New Zealand', RO: 'Romania', BE: 'Belgium', FI: 'Finland', AE: 'United Arab Emirates', XX: '\u2014' };

    function countryLabel(code) {
      if (!code) return 'Unknown';
      var c = (code || 'XX').toUpperCase().slice(0, 2);
      return countryNames[c] || c;
    }

    function countryLabelFull(code) {
      if (!code) return 'Unknown';
      var c = (code || 'XX').toUpperCase().slice(0, 2);
      return countryNamesFull[c] || countryNames[c] || c;
    }

    // Add width=100 to hotlinked images (? or & depending on existing params).
    function hotImg(url) {
      if (typeof url !== 'string') return url;
      if (/^https?:\/\//i.test(url)) {
        try {
          const u = new URL(url);
          u.searchParams.set('width', '100');
          return u.toString();
        } catch (_) {
          return url + (url.indexOf('?') >= 0 ? '&' : '?') + 'width=100';
        }
      }
      return url + (url.indexOf('?') >= 0 ? '&' : '?') + 'width=100';
    }
    // Product thumbs: request square (width + height) so object-fit: cover gives identical framing.
    function hotImgSquare(url) {
      if (typeof url !== 'string') return url;
      if (/^https?:\/\//i.test(url)) {
        try {
          const u = new URL(url);
          u.searchParams.set('width', '100');
          u.searchParams.set('height', '100');
          if (u.hostname.includes('shopify.com')) u.searchParams.set('crop', 'center');
          return u.toString();
        } catch (_) {
          const sep = url.indexOf('?') >= 0 ? '&' : '?';
          return url + sep + 'width=100&height=100';
        }
      }
      return url + (url.indexOf('?') >= 0 ? '&' : '?') + 'width=100&height=100';
    }

    const FLAG_PLACEHOLDER_SRC = 'data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2240%22%20height%3D%2230%22%20viewBox%3D%220%200%2040%2030%22%3E%3Crect%20width%3D%2240%22%20height%3D%2230%22%20fill%3D%22%23f0f0f0%22/%3E%3Cpath%20d%3D%22M12%2010h16v2H12zm0%208h16v2H12z%22%20fill%3D%22%23c0c0c0%22/%3E%3C/svg%3E';

    function flagSrc(code) {
      const raw = (code || '').toString().trim().toLowerCase();
      if (!raw || raw === 'xx' || !/^[a-z]{2}$/.test(raw)) return FLAG_PLACEHOLDER_SRC;
      return hotImg('https://flagcdn.com/w40/' + raw + '.png');
    }

    function flagImg(code, label) {
      const src = flagSrc(code);
      const safeLabel = label != null ? String(label) : (code ? String(code) : '?');
      const titleAttr = label ? ' title="' + escapeHtml(safeLabel) + '"' : '';
      return '<img class="flag-img" src="' + src + '" alt="' + escapeHtml(safeLabel) + '"' + titleAttr + ' loading="lazy">';
    }

    function flagImgSmall(code) {
      const src = flagSrc(code);
      return '<img class="sale-toast-inline-flag-img" src="' + src + '" alt="" aria-hidden="true" loading="lazy">';
    }

    function arrivedAgo(startedAt) {
      var n = toMs(startedAt);
      if (n == null) return '\u2014';
      var s = Math.floor((Date.now() - n) / 1000);
      if (s < 60) return s + ' secs ago';
      if (s < 3600) return Math.floor(s / 60) + ' mins ago';
      if (s < 86400) return Math.floor(s / 3600) + ' hrs ago';
      return Math.floor(s / 86400) + ' days ago';
    }

    var storeBaseUrlFallback = '';
    var mainBaseUrlFallback = '';
    var assetsBaseUrlFallback = '';
    var shopForSalesFallback = '';
    var storeBaseUrlLoaded = false;
    (function fetchStoreBaseUrl() {
      fetch(API + '/api/store-base-url', { credentials: 'same-origin' })
        .then(function(r) { return r.json(); })
        .then(function(d) {
          if (d) {
            if (d.baseUrl) storeBaseUrlFallback = d.baseUrl;
            if (d.mainBaseUrl) mainBaseUrlFallback = d.mainBaseUrl;
            if (d.assetsBaseUrl) assetsBaseUrlFallback = d.assetsBaseUrl;
            if (d.shopForSales) shopForSalesFallback = d.shopForSales;
            if (sessions.length) renderTable();
            if (assetsBaseUrlFallback) {
              var link = document.querySelector('link[rel="icon"]');
              if (link) link.href = '/assets/favicon.png';
              if (typeof saleAudio !== 'undefined' && saleAudio) saleAudio.src = CASH_REGISTER_MP3_URL;
            }
            if (shopForSalesFallback) {
              if (activeMainTab === 'breakdown' && typeof refreshBreakdown === 'function') refreshBreakdown({ force: false });
              if (activeMainTab === 'products' && typeof refreshProducts === 'function') refreshProducts({ force: false });
              if (activeMainTab === 'stats' && typeof refreshStats === 'function') refreshStats({ force: false });
              if (activeMainTab === 'traffic' && typeof refreshTraffic === 'function') refreshTraffic({ force: false });
            }
          }
          storeBaseUrlLoaded = true;
          if (typeof renderSales === 'function') renderSales(statsCache);
        })
        .catch(function() { storeBaseUrlLoaded = true; if (typeof renderSales === 'function') renderSales(statsCache); });
    })();

    function getShopForSales() {
      var shop = getShopParam() || shopForSalesFallback || null;
      return shop && /\.myshopify\.com$/i.test(shop) ? shop : null;
    }

    function getStoreBaseUrl() {
      var params = new URLSearchParams(window.location.search);
      var shop = params.get('shop');
      if (shop && /\.myshopify\.com$/i.test(shop)) return 'https://' + shop;
      return storeBaseUrlFallback || '';
    }
    function getMainBaseUrl() {
      if (mainBaseUrlFallback) return mainBaseUrlFallback;
      return getStoreBaseUrl();
    }
    function getAssetsBase() {
      if (assetsBaseUrlFallback) return assetsBaseUrlFallback;
      return (API || '') + '/assets';
    }

    var HICON_URL = hotImg('https://cdn.shopify.com/s/files/1/0847/7261/8587/files/hicon.webp?v=1770084894');
    var DOLLAR_URL = hotImg('https://cdn.shopify.com/s/files/1/0847/7261/8587/files/dollar.png?v=1770085223');
    // Sale toast chime: load from Shopify CDN (do not rely on a repo-local MP3 file).
    var CASH_REGISTER_MP3_URL = 'https://cdn.shopify.com/s/files/1/0847/7261/8587/files/cash-register.mp3?v=1770171264';

    function titleCaseFromHandle(handle) {
      if (typeof handle !== 'string') return null;
      let s = handle;
      try { s = decodeURIComponent(s); } catch (_) {}
      s = s.replace(/[-_]+/g, ' ').replace(/\s+/g, ' ').trim();
      if (!s) return null;
      return s.split(' ').filter(Boolean).map(function(w) {
        const lower = w.toLowerCase();
        return lower.charAt(0).toUpperCase() + lower.slice(1);
      }).join(' ');
    }

    function productTitleFromPath(path) {
      if (typeof path !== 'string') return null;
      const m = path.trim().match(/^\/products\/([^/?#]+)/i);
      if (!m) return null;
      return titleCaseFromHandle(m[1]);
    }

    /** For display: /collections/bracelets -> Bracelets, /products/foo -> title-cased product name, else null. */
    function friendlyLabelFromPath(path) {
      if (typeof path !== 'string') return null;
      const p = path.trim();
      const pNorm = p.replace(/\/+$/, '') || '/';
      if (pNorm === '/pages/order-tracker') return 'Order Tracker';
      if (pNorm === '/pages/contact') return 'Contact';
      if (pNorm === '/account/login' || pNorm.startsWith('/account/login/')) return 'Login';
      if (pNorm === '/orders' || pNorm.startsWith('/orders/')) return 'Viewed Order';
      const collectionsMatch = p.match(/^\/collections\/([^/?#]+)/i);
      if (collectionsMatch) return titleCaseFromHandle(collectionsMatch[1]);
      const productsMatch = p.match(/^\/products\/([^/?#]+)/i);
      if (productsMatch) return titleCaseFromHandle(productsMatch[1]);
      return null;
    }

    function landingSortKey(s) {
      function trimStr(v) { return v != null ? String(v).trim() : ''; }
      function normalizeToPath(pathVal, handleVal) {
        var path = trimStr(pathVal);
        var handle = trimStr(handleVal);
        if (!path && handle) path = '/products/' + handle.replace(/^\/+/, '');
        if (path && !path.startsWith('/')) path = '/' + path;
        try {
          if (/^https?:\/\//i.test(path)) path = new URL(path).pathname || '/';
        } catch (_) {}
        path = (path || '').split('#')[0].split('?')[0];
        path = path.replace(/\/+$/, '');
        if (path === '') path = '/';
        return path;
      }
      function collapseKey(path) {
        if (!path) return '';
        var pathNorm = path.replace(/\/+$/, '');
        if (path.indexOf('/checkouts') === 0) return '/checkouts';
        if (pathNorm === '/cart') return '/cart';
        if (path === '/orders' || pathNorm === '/orders' || path.indexOf('/orders/') === 0) return '/orders';
        return path;
      }

      var path = normalizeToPath(s && s.first_path, s && s.first_product_handle);
      var key = collapseKey(path);
      if (!key) return '';
      if (key === '/') return 'Home';
      if (key === '/orders') return 'Viewed Order';
      if (key === '/cart' || key === '/checkouts') return 'Cart';
      return friendlyLabelFromPath(key) || key;
    }

    function visitsCount(s) {
      var n = 0;
      try { n = s && s.returning_count != null ? Number(s.returning_count) : 0; } catch (_) { n = 0; }
      if (!Number.isFinite(n)) n = 0;
      return n + 1;
    }

    function landingPageCell(s) {
      function trimStr(v) { return v != null ? String(v).trim() : ''; }
      function normalizeToPathDual(pathVal, handleVal) {
        var path = trimStr(pathVal);
        var handle = trimStr(handleVal);
        if (!path && !handle) return '';
        if (!path && handle) path = '/products/' + handle.replace(/^\/+/, '');
        if (path && !path.startsWith('/')) path = '/' + path;
        try {
          if (/^https?:\/\//i.test(path)) path = new URL(path).pathname || '/';
        } catch (_) {}
        path = path.split('#')[0].split('?')[0];
        path = path.replace(/\/+$/, '');
        if (path === '') path = '/';
        return path;
      }
      function collapseKeyDual(path) {
        if (!path) return '';
        if (path.indexOf('/checkouts') === 0) return '/checkouts';
        if (path === '/cart') return '/cart';
        if (path === '/orders' || path.indexOf('/orders/') === 0) return '/orders';
        return path;
      }

      var entryPathDual = normalizeToPathDual(s && s.first_path, s && s.first_product_handle);
      var exitPathDual = normalizeToPathDual(s && s.last_path, s && s.last_product_handle);
      var entryKeyDual = collapseKeyDual(entryPathDual);
      var exitKeyDual = collapseKeyDual(exitPathDual);

      // When we have BOTH entry + exit, show them both (otherwise keep the current single-thumb layout).
      if (entryPathDual && exitPathDual && entryKeyDual && exitKeyDual && entryKeyDual !== exitKeyDual) {
        var mainBaseDual = getMainBaseUrl();
        var isPurchasedDual = !!(s && s.has_purchased);

        function metaForDual(path) {
          var pathNorm = path ? path.replace(/\/+$/, '') : '';
          var isCheckout = path && path.indexOf('/checkouts') === 0;
          var isHomeOrOrders = path === '/' || path === '/orders' || pathNorm === '/orders' || (path && path.startsWith('/orders/'));
          var isCart = path === '/cart' || pathNorm === '/cart';
          var fullUrl = mainBaseDual && path ? mainBaseDual + path : '';
          var labelText = '\u2014';
          var thumbSrc = '';
          if (isHomeOrOrders) {
            labelText = path === '/' ? 'Home' : 'Viewed Order';
            thumbSrc = HICON_URL;
          } else if (isCart) {
            labelText = 'Cart';
            thumbSrc = HICON_URL;
          } else if (isCheckout) {
            labelText = 'Cart';
            // Prefer a product thumb when possible (even if the session didn't purchase).
            var ph = '';
            try {
              ph = (s && s.last_product_handle != null ? String(s.last_product_handle).trim() : '') ||
                   (s && s.first_product_handle != null ? String(s.first_product_handle).trim() : '');
            } catch (_) { ph = ''; }
            if (ph && mainBaseDual) {
              thumbSrc = (API || '') + '/api/og-thumb?url=' + encodeURIComponent(mainBaseDual + '/products/' + ph.replace(/^\/+/, '')) + '&width=100';
            } else {
              thumbSrc = HICON_URL;
            }
          } else if (path) {
            labelText = friendlyLabelFromPath(path) || path;
            if (fullUrl) thumbSrc = (API || '') + '/api/og-thumb?url=' + encodeURIComponent(fullUrl) + '&width=100';
          }
          return { fullUrl, labelText, thumbSrc };
        }

        var entryMeta = metaForDual(entryPathDual);
        var exitMeta = metaForDual(exitPathDual);

        var entryImg = entryMeta.thumbSrc
          ? '<img class="landing-thumb" src="' + entryMeta.thumbSrc + '" alt="" onerror="this.classList.add(\'is-hidden\')">'
          : '';
        var exitImg = exitMeta.thumbSrc
          ? '<img class="landing-thumb landing-thumb-exit" src="' + exitMeta.thumbSrc + '" alt="" onerror="this.classList.add(\'is-hidden\')">'
          : '';
        var thumbsInner = entryImg + exitImg;
        var overlay = isPurchasedDual
          ? '<span class="thumb-overlay" aria-hidden="true">' + BOUGHT_OVERLAY_SVG + '</span>'
          : '';
        var thumbs = thumbsInner ? ('<span class="thumb-wrap thumb-stack">' + thumbsInner + overlay + '</span>') : '';

        function dirArrowSvg(kind) {
          var isExit = kind === 'exit';
          var cls = 'landing-dir-icon ' + (isExit ? 'landing-dir-icon-exit' : 'landing-dir-icon-entry');
          var path = isExit
            ? '<path d="M19 12H5M11 6l-6 6 6 6"></path>'
            : '<path d="M5 12h14M13 6l6 6-6 6"></path>';
          return '<svg class="' + cls + '" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">' + path + '</svg>';
        }

        function line(kind, meta) {
          var isExit = kind === 'exit';
          var prefix = isExit ? 'Exit' : 'Entry';
          var label = meta && meta.labelText ? String(meta.labelText) : '\u2014';
          var inner = dirArrowSvg(kind) +
            '<span class="landing-line-text"><span class="sr-only">' + prefix + ': </span>' + escapeHtml(label) + '</span>';
          if (meta && meta.fullUrl) {
            return '<a class="landing-line" href="' + escapeHtml(meta.fullUrl) + '" target="_blank" rel="noopener">' + inner + '</a>';
          }
          return '<span class="landing-line">' + inner + '</span>';
        }

        var lines = '<div class="landing-lines">' + line('entry', entryMeta) + line('exit', exitMeta) + '</div>';
        return '<div class="last-action-cell dual">' + thumbs + ' ' + lines + '</div>';
      }

      var hasFirst = (s.first_path != null && s.first_path !== '') || (s.first_product_handle != null && s.first_product_handle !== '');
      var path = (s.first_path != null && s.first_path !== '' ? s.first_path : (hasFirst ? '' : (s.last_path != null ? s.last_path : ''))).trim();
      var productHandle = s.first_product_handle != null && s.first_product_handle !== '' ? s.first_product_handle : (hasFirst ? null : (s.last_product_handle != null ? s.last_product_handle : null));
      var isFromLast = !hasFirst && (path || productHandle);
      if (path && !path.startsWith('/')) path = '/' + path;
      if (!path && productHandle) path = '/products/' + (productHandle || '');
      var pathNorm = path ? path.replace(/\/+$/, '') : '';
      var isCheckout = path && path.indexOf('/checkouts') === 0;
      var isHomeOrOrders = path === '/' || path === '/orders' || pathNorm === '/orders' || (path && path.startsWith('/orders/'));
      var isCart = path === '/cart' || pathNorm === '/cart';
      var mainBase = getMainBaseUrl();
      var fullUrl = mainBase && path ? mainBase + path : '';
      var label = '\u2014';
      var thumbSrc = '';
      var isPurchased = !!(s && s.has_purchased);
      // Keep the Landing Page thumbnail stable even after purchase; do not swap to a "sale" icon.
      if (isHomeOrOrders) {
        label = path === '/' ? 'Home' : 'Viewed Order';
        thumbSrc = HICON_URL;
      } else if (isCart) {
        label = 'Cart';
        thumbSrc = HICON_URL;
      } else if (isCheckout) {
        label = 'Cart';
        // Prefer a product thumb when possible (even if the session didn't purchase).
        var ph = '';
        try {
          ph = (s && s.last_product_handle != null ? String(s.last_product_handle).trim() : '') ||
               (s && s.first_product_handle != null ? String(s.first_product_handle).trim() : '');
        } catch (_) { ph = ''; }
        if (ph && mainBase) {
          thumbSrc = (API || '') + '/api/og-thumb?url=' + encodeURIComponent(mainBase + '/products/' + ph.replace(/^\/+/, '')) + '&width=100';
        } else {
          thumbSrc = HICON_URL;
        }
      } else if (path) {
        // Display friendly name: /collections/bracelets -> Bracelets, /products/<handle> -> title-cased (link unchanged).
        label = escapeHtml(friendlyLabelFromPath(path) || path);
        if (fullUrl) thumbSrc = (API || '') + '/api/og-thumb?url=' + encodeURIComponent(fullUrl) + '&width=100';
      }
      if (isFromLast && label !== '\u2014') label += ' <span class="landing-fallback-hint">(last)</span>';
      if (thumbSrc || fullUrl) {
        var img = '';
        if (thumbSrc) {
          img = isPurchased
            ? '<span class="thumb-wrap"><img class="landing-thumb" src="' + thumbSrc + '" alt="" onerror="this.parentNode && this.parentNode.classList && this.parentNode.classList.add(\'is-hidden\')"><span class="thumb-overlay" aria-hidden="true">' + BOUGHT_OVERLAY_SVG + '</span></span>'
            : '<img class="landing-thumb" src="' + thumbSrc + '" alt="" onerror="this.classList.add(\'is-hidden\')">';
        }
        var link = fullUrl ? '<a href="' + escapeHtml(fullUrl) + '" target="_blank" rel="noopener">' + label + '</a>' : label;
        return '<div class="last-action-cell">' + img + ' ' + link + '</div>';
      }
      return label === '\u2014' ? label : escapeHtml(path || '');
    }

    function formatMoney(amount, currencyCode) {
      if (amount == null || typeof amount !== 'number') return '';
      const code = (currencyCode || 'GBP').toUpperCase();
      const sym = code === 'GBP' ? '\u00A3' : code === 'USD' ? '$' : code === 'EUR' ? '\u20AC' : code + ' ';
      return sym + (amount % 1 === 0 ? amount : amount.toFixed(2));
    }

    function formatCompactNumber(amount) {
      const raw = typeof amount === 'number' ? amount : Number(amount);
      const n = Number.isFinite(raw) ? Math.abs(raw) : 0;
      if (n < 1000) return String(Math.round(n));
      if (n >= 1e9) {
        const v = n / 1e9;
        const dec = v < 100 ? 1 : 0;
        return v.toFixed(dec).replace(/\.0$/, '') + 'b';
      }
      if (n >= 1e6) {
        const v = n / 1e6;
        const dec = v < 100 ? 1 : 0;
        return v.toFixed(dec).replace(/\.0$/, '') + 'm';
      }
      // n >= 1e3
      const v = n / 1e3;
      const dec = v < 100 ? 1 : 0;
      return v.toFixed(dec).replace(/\.0$/, '') + 'k';
    }

    function formatMoneyCompact(amount, currencyCode) {
      if (amount == null || typeof amount !== 'number') return '';
      const code = (currencyCode || 'GBP').toUpperCase();
      const sym = code === 'GBP' ? '\u00A3' : code === 'USD' ? '$' : code === 'EUR' ? '\u20AC' : code + ' ';
      const n = Number.isFinite(amount) ? amount : 0;
      const sign = n < 0 ? '-' : '';
      return sign + sym + formatCompactNumber(n);
    }

    function sourceLabel(s) {
      const parts = [];
      if (s.utm_source && String(s.utm_source).trim()) parts.push('utm_source: ' + escapeHtml(String(s.utm_source).trim()));
      if (s.utm_campaign && String(s.utm_campaign).trim()) parts.push('utm_campaign: ' + escapeHtml(String(s.utm_campaign).trim()));
      if (s.utm_medium && String(s.utm_medium).trim()) parts.push('utm_medium: ' + escapeHtml(String(s.utm_medium).trim()));
      if (s.utm_content && String(s.utm_content).trim()) parts.push('utm_content: ' + escapeHtml(String(s.utm_content).trim()));
      if (s.referrer && String(s.referrer).trim()) parts.push('referrer: ' + escapeHtml(String(s.referrer).trim()));
      return parts.join(' ');
    }

    function sourceUtmString(s) {
      return [s.utm_source, s.utm_campaign, s.utm_medium, s.utm_content].filter(Boolean).join(' ').toLowerCase();
    }

    function isGoogleAdsSource(s) {
      return sourceUtmString(s).indexOf('googleads') !== -1;
    }

    /** Derive friendly source name from referrer URL host (when no UTM). Use for tooltip and to collect images. */
    function sourceReferrerFriendlyLabel(s) {
      const ref = s.referrer && String(s.referrer).trim();
      if (!ref) return null;
      try {
        const u = new URL(ref);
        const host = (u.hostname || '').toLowerCase().replace(/^www\./, '');
        if (!host) return null;
        if (host === 'account.heybigday.com') return 'HeyBigDay Account';
        if (host === 'account.hbdjewellery.com') return 'HBD Account';
        if (host === 'hbdjewellery.com' || host.endsWith('.myshopify.com')) return 'Store';
        if (host.indexOf('omnisend') !== -1) return 'Omnisend';
        if (host.indexOf('google') !== -1) return 'Google';
        if (host.indexOf('facebook') !== -1 || host.indexOf('fb.') === 0 || host === 'fb.com') return 'Facebook';
        if (host.indexOf('instagram') !== -1) return 'Instagram';
        if (host.indexOf('pinterest') !== -1) return 'Pinterest';
        if (host.indexOf('tiktok') !== -1) return 'TikTok';
        if (host.indexOf('twitter') !== -1 || host.indexOf('x.com') !== -1) return 'X (Twitter)';
        if (host.indexOf('youtube') !== -1) return 'YouTube';
        if (host.indexOf('linkedin') !== -1) return 'LinkedIn';
        if (host.indexOf('bing') !== -1) return 'Bing';
        if (host.indexOf('yahoo') !== -1) return 'Yahoo';
        if (host.indexOf('duckduckgo') !== -1) return 'DuckDuckGo';
        return host;
      } catch (_) { return null; }
    }

    function sourceFriendlyLabel(s) {
      const str = sourceUtmString(s);
      if (str) {
        if (str.indexOf('googleads') !== -1) return null;
        if (str.indexOf('google') !== -1) return 'Google';
        if (str.indexOf('bing') !== -1) return 'Bing';
        if (str.indexOf('omnisend') !== -1) return 'Omnisend';
        if (str.indexOf('chatgpt') !== -1 || str.indexOf('chat gpt') !== -1) return 'Chatgpt';
        return null;
      }
      return sourceReferrerFriendlyLabel(s);
    }

    function sourceSortKey(s) {
      try {
        const mapped = getMappedSourceKeysForSession(s);
        if (mapped && mapped.length) {
          const key0 = String(mapped[0] || '').trim().toLowerCase();
          if (key0) return trafficSourceLabelForKey(key0, key0) || key0;
        }
      } catch (_) {}
      if (isGoogleAdsSource(s)) return 'Google Ads';
      const friendly = sourceFriendlyLabel(s);
      if (friendly === 'Google') return 'Google';
      if (friendly) return friendly;
      if (sourceUtmString(s)) return 'Other';
      if (s.referrer && String(s.referrer).trim()) return 'Other';
      return 'Direct';
    }

    const SOURCE_GOOGLE_IMG = hotImg('https://cdn.shopify.com/s/files/1/0847/7261/8587/files/google.png?v=1770086632');
    const SOURCE_DIRECT_IMG = hotImg('https://cdn.shopify.com/s/files/1/0847/7261/8587/files/arrow-right.png?v=1770086632');
    const BOUGHT_OVERLAY_SVG = '<svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><circle cx="16" cy="16" r="16" fill="currentColor"></circle><path d="M11.087 14.815v-2.332c0-3.676 2.219-5.983 6.075-5.983 2.932 0 4.57 1.242 5.838 2.84l-2.483 1.9c-.951-1.165-1.85-1.85-3.328-1.85-1.77 0-2.827 1.217-2.827 3.17v2.255h6.578v2.637h-6.578v4.335h8.585V24.5H9v-1.977l2.087-.609v-4.462H9v-2.637z" fill="#ffffff"></path></svg>';
    const SOURCE_UNKNOWN_IMG = hotImg('https://cdn.shopify.com/s/files/1/0847/7261/8587/files/question.png?v=1770135816');
    const SOURCE_OMNISEND_IMG = hotImg('https://cdn.shopify.com/s/files/1/0847/7261/8587/files/omnisend.png?v=1770141052');
    const SOURCE_BING_IMG = hotImg('https://cdn.shopify.com/s/files/1/0847/7261/8587/files/bing.png?v=1770141094');
    const SOURCE_LIVEVIEW_SOURCE_IMG = hotImg('https://cdn.shopify.com/s/files/1/0847/7261/8587/files/liveview-source-logo.png?v=1770141081');

    // Traffic source mapping (server-configurable)
    const TRAFFIC_SOURCE_MAP_ALLOWED_PARAMS = [
      'utm_source',
      'utm_medium',
      'utm_campaign',
      'utm_term',
      'utm_content',
      'utm_id',
      'utm_source_platform',
      'utm_creative_format',
      'utm_marketing_tactic',
      'utm_name',
      'utm_cid',
      'utm_referrer',
      'utm_reader',
    ];
    const TRAFFIC_SOURCE_MAP_ALLOWED_PARAM_SET = new Set(TRAFFIC_SOURCE_MAP_ALLOWED_PARAMS);

    let trafficSourceMetaByKey = new Map(); // key -> { label, iconUrl, updatedAt }
    let trafficSourceRulesIndex = new Map(); // param -> value -> [source_key]
    let trafficSourceMetaLoadedAt = 0;
    let trafficSourceMetaInFlight = null;

    function safeUrlParams(url) {
      const raw = url != null ? String(url).trim() : '';
      if (!raw) return null;
      try { return new URL(raw).searchParams; } catch (_) {}
      try { return new URL('https://' + raw).searchParams; } catch (_) {}
      return null;
    }

    function normalizeUtmParam(v) {
      const s = v != null ? String(v).trim().toLowerCase() : '';
      if (!s) return '';
      return TRAFFIC_SOURCE_MAP_ALLOWED_PARAM_SET.has(s) ? s : '';
    }

    function normalizeUtmValue(v) {
      const s = v != null ? String(v).trim() : '';
      if (!s) return '';
      return (s.length > 256 ? s.slice(0, 256) : s).toLowerCase();
    }

    function buildTrafficSourceRulesIndex(rules) {
      const idx = new Map();
      (Array.isArray(rules) ? rules : []).forEach(function(r) {
        const p = normalizeUtmParam(r && r.utm_param);
        const v = normalizeUtmValue(r && r.utm_value);
        const k = (r && r.source_key != null) ? String(r.source_key).trim().toLowerCase() : '';
        if (!p || !v || !k) return;
        if (!idx.has(p)) idx.set(p, new Map());
        const byVal = idx.get(p);
        if (!byVal.has(v)) byVal.set(v, []);
        byVal.get(v).push(k);
      });
      return idx;
    }

    function refreshTrafficSourceMeta(options = {}) {
      const force = !!options.force;
      const now = Date.now();
      if (!force && trafficSourceMetaLoadedAt && (now - trafficSourceMetaLoadedAt) < 60 * 1000) {
        return Promise.resolve({ ok: true, cached: true });
      }
      if (trafficSourceMetaInFlight) return trafficSourceMetaInFlight;
      trafficSourceMetaInFlight = fetchWithTimeout(API + '/api/traffic-source-meta' + (force ? ('?_=' + now) : ''), { credentials: 'same-origin', cache: 'no-store' }, 20000)
        .then(function(r) { if (!r.ok) throw new Error('Meta HTTP ' + r.status); return r.json(); })
        .then(function(json) {
          const meta = (json && json.meta && typeof json.meta === 'object') ? json.meta : {};
          const m = new Map();
          Object.keys(meta).forEach(function(k) {
            const kk = String(k || '').trim().toLowerCase();
            if (!kk) return;
            const v = meta[k] || {};
            m.set(kk, {
              label: v && v.label != null ? String(v.label) : kk,
              iconUrl: v && v.iconUrl != null ? String(v.iconUrl) : (v && v.icon_url != null ? String(v.icon_url) : null),
              updatedAt: v && v.updatedAt != null ? Number(v.updatedAt) : (v && v.updated_at != null ? Number(v.updated_at) : null),
            });
          });
          const rules = (json && Array.isArray(json.rules)) ? json.rules : [];
          trafficSourceMetaByKey = m;
          trafficSourceRulesIndex = buildTrafficSourceRulesIndex(rules);
          trafficSourceMetaLoadedAt = Date.now();
          try { if (trafficCache) renderTraffic(trafficCache); } catch (_) {}
          try { if (sessions && sessions.length) renderTable(); } catch (_) {}
          return { ok: true, metaCount: m.size, ruleCount: rules.length };
        })
        .catch(function(err) {
          console.error(err);
          return { ok: false, error: err && err.message ? String(err.message) : 'Failed' };
        })
        .finally(function() { trafficSourceMetaInFlight = null; });
      return trafficSourceMetaInFlight;
    }

    function trafficSourceLabelForKey(key, fallbackLabel) {
      const k = key != null ? String(key).trim().toLowerCase() : '';
      if (!k) return fallbackLabel != null ? String(fallbackLabel) : '';
      const meta = trafficSourceMetaByKey.get(k);
      if (meta && meta.label != null && String(meta.label).trim() !== '') return String(meta.label);
      return fallbackLabel != null ? String(fallbackLabel) : k;
    }

    function trafficSourceIconUrlForKey(key) {
      const k = key != null ? String(key).trim().toLowerCase() : '';
      if (!k) return '';
      const meta = trafficSourceMetaByKey.get(k);
      return meta && meta.iconUrl != null && String(meta.iconUrl).trim() !== '' ? String(meta.iconUrl).trim() : '';
    }

    function extractMappedUtmTokensFromSession(s) {
      const out = [];
      function add(param, value) {
        const p = normalizeUtmParam(param);
        const v = normalizeUtmValue(value);
        if (!p || !v) return;
        out.push({ param: p, value: v });
      }
      const params = safeUrlParams(s && s.entry_url ? String(s.entry_url) : '');
      if (params) {
        TRAFFIC_SOURCE_MAP_ALLOWED_PARAMS.forEach(function(p) {
          const v = params.get(p);
          if (v != null && String(v).trim() !== '') add(p, v);
        });
      }
      add('utm_source', s && s.utm_source != null ? String(s.utm_source) : '');
      add('utm_medium', s && s.utm_medium != null ? String(s.utm_medium) : '');
      add('utm_campaign', s && s.utm_campaign != null ? String(s.utm_campaign) : '');
      add('utm_content', s && s.utm_content != null ? String(s.utm_content) : '');

      const seen = new Set();
      const deduped = [];
      out.forEach(function(t) {
        const k = t.param + '\0' + t.value;
        if (seen.has(k)) return;
        seen.add(k);
        deduped.push(t);
      });
      return deduped;
    }

    function getMappedSourceKeysForSession(s) {
      const tokens = extractMappedUtmTokensFromSession(s);
      if (!tokens.length) return [];
      const out = [];
      const seen = new Set();
      tokens.forEach(function(t) {
        const byVal = trafficSourceRulesIndex.get(t.param);
        if (!byVal) return;
        const keys = byVal.get(t.value);
        if (!Array.isArray(keys) || !keys.length) return;
        // Newest mapping wins (rules are appended; API preserves created order).
        for (let i = keys.length - 1; i >= 0; i--) {
          const kk = String(keys[i] || '').trim().toLowerCase();
          if (!kk || seen.has(kk)) continue;
          seen.add(kk);
          out.push(kk);
        }
      });
      return out;
    }

    function trafficSourceBuiltInIconSrc(key) {
      const k = key != null ? String(key).trim().toLowerCase() : '';
      if (!k) return '';
      if (k === 'google_ads') return getAssetsBase() + '/adwords.png?width=100';
      if (k === 'google_organic') return SOURCE_GOOGLE_IMG;
      if (k === 'bing_ads' || k === 'bing_organic') return SOURCE_BING_IMG;
      if (k === 'omnisend') return SOURCE_OMNISEND_IMG;
      if (k === 'direct') return SOURCE_DIRECT_IMG;
      return SOURCE_UNKNOWN_IMG;
    }

    // Config modal: source mapping UI
    let trafficSourceMapsShowMappedTokens = false;
    let trafficSourceMapsUiInFlight = null;

    function fetchTrafficSourceMaps(options = {}) {
      const sinceDays = (options && typeof options.sinceDays === 'number') ? options.sinceDays : 30;
      const limitTokens = (options && typeof options.limitTokens === 'number') ? options.limitTokens : 250;
      const unmappedOnly = options && options.unmappedOnly != null ? !!options.unmappedOnly : !trafficSourceMapsShowMappedTokens;
      let url = API + '/api/traffic-source-maps?sinceDays=' + encodeURIComponent(String(sinceDays)) +
        '&limitTokens=' + encodeURIComponent(String(limitTokens)) +
        '&unmappedOnly=' + encodeURIComponent(unmappedOnly ? '1' : '0');
      url += '&_=' + Date.now();
      return fetchWithTimeout(url, { credentials: 'same-origin', cache: 'no-store' }, 25000)
        .then(function(r) { if (!r.ok) throw new Error('Maps HTTP ' + r.status); return r.json(); });
    }

    function postTrafficSourceMap(payload) {
      return fetchWithTimeout(API + '/api/traffic-source-maps/map', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'same-origin',
        cache: 'no-store',
        body: JSON.stringify(payload || {}),
      }, 45000).then(function(r) { return r.ok ? r.json() : r.json().catch(function() { return null; }).then(function(j) { throw new Error((j && j.error) ? j.error : ('HTTP ' + r.status)); }); });
    }

    function postTrafficSourceMeta(payload) {
      return fetchWithTimeout(API + '/api/traffic-source-maps/meta', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'same-origin',
        cache: 'no-store',
        body: JSON.stringify(payload || {}),
      }, 25000).then(function(r) { return r.ok ? r.json() : r.json().catch(function() { return null; }).then(function(j) { throw new Error((j && j.error) ? j.error : ('HTTP ' + r.status)); }); });
    }

    function postTrafficSourceBackfill(payload) {
      return fetchWithTimeout(API + '/api/traffic-source-maps/backfill', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'same-origin',
        cache: 'no-store',
        body: JSON.stringify(payload || {}),
      }, 60000).then(function(r) { return r.ok ? r.json() : null; });
    }

    // Preserve token editor inputs across refreshes (bulk mapping UX).
    // Keyed by utm_param + utm_value so "Refresh/Scan/Show mapped tokens" won't wipe in-progress edits.
    let trafficSourceTokenDrafts = new Map(); // tokenKey -> { sourcePick, sourceLabel, iconUrl }

    function normalizeFlatLabel(v) {
      const s = v != null ? String(v).trim().toLowerCase() : '';
      if (!s) return '';
      return s.replace(/[^a-z0-9]+/g, '');
    }

    function tokenDraftKey(utmParam, utmValue) {
      const p = utmParam != null ? String(utmParam).trim().toLowerCase() : '';
      const v = utmValue != null ? String(utmValue).trim().toLowerCase() : '';
      if (!p || !v) return '';
      return p + '\u0000' + v;
    }

    function setTokenRowOtherMode(row, on) {
      const otherEl = row ? row.querySelector('input[data-field="source_label"]') : null;
      if (otherEl) otherEl.classList.toggle('is-hidden', !on);
    }

    function readTokenDraftFromRow(row) {
      const pickEl = row ? row.querySelector('select[data-field="source_pick"]') : null;
      const labelEl = row ? row.querySelector('input[data-field="source_label"]') : null;
      const iconEl = row ? row.querySelector('input[data-field="icon_url"]') : null;
      const pick = pickEl ? String(pickEl.value || '').trim().toLowerCase() : '';
      const sourceLabel = labelEl ? String(labelEl.value || '') : '';
      const iconUrl = iconEl ? String(iconEl.value || '') : '';
      return { sourcePick: pick, sourceLabel, iconUrl };
    }

    function upsertTokenDraft(key, draft) {
      if (!key) return;
      const pick = draft && draft.sourcePick != null ? String(draft.sourcePick).trim().toLowerCase() : '';
      const label = draft && draft.sourceLabel != null ? String(draft.sourceLabel) : '';
      const icon = draft && draft.iconUrl != null ? String(draft.iconUrl) : '';
      const labelTrim = label.trim();
      const iconTrim = icon.trim();
      const meaningful = (!!pick) || (!!labelTrim) || (!!iconTrim);
      if (!meaningful || (pick === '__other__' && !labelTrim && !iconTrim)) {
        trafficSourceTokenDrafts.delete(key);
        return;
      }
      trafficSourceTokenDrafts.set(key, { sourcePick: pick, sourceLabel: label, iconUrl: icon });
    }

    function stashTokenDraftsFromRoot(root) {
      if (!root || !trafficSourceTokenDrafts || !trafficSourceTokenDrafts.size) return;
      const rows = root.querySelectorAll('.tsm-token-row');
      rows.forEach(function(row) {
        const p = (row.getAttribute('data-utm-param') || '').trim();
        const v = (row.getAttribute('data-utm-value') || '').trim();
        const key = tokenDraftKey(p, v);
        if (!key) return;
        if (!trafficSourceTokenDrafts.has(key)) return; // only update existing drafts (avoid making every row "dirty")
        upsertTokenDraft(key, readTokenDraftFromRow(row));
      });
    }

    function applyTokenDraftsToRoot(root) {
      if (!root || !trafficSourceTokenDrafts || !trafficSourceTokenDrafts.size) return;
      const rows = root.querySelectorAll('.tsm-token-row');
      rows.forEach(function(row) {
        const p = (row.getAttribute('data-utm-param') || '').trim();
        const v = (row.getAttribute('data-utm-value') || '').trim();
        const key = tokenDraftKey(p, v);
        if (!key) return;
        const d = trafficSourceTokenDrafts.get(key);
        if (!d) return;

        const pickEl = row.querySelector('select[data-field="source_pick"]');
        if (pickEl && d.sourcePick != null && String(d.sourcePick).trim() !== '') {
          pickEl.value = String(d.sourcePick).trim().toLowerCase();
        }

        const labelEl = row.querySelector('input[data-field="source_label"]');
        if (labelEl && d.sourceLabel != null) labelEl.value = String(d.sourceLabel);

        const iconEl = row.querySelector('input[data-field="icon_url"]');
        if (iconEl && d.iconUrl != null) iconEl.value = String(d.iconUrl);

        const pickNow = pickEl ? String(pickEl.value || '').trim().toLowerCase() : (d.sourcePick || '');
        const otherOn = (pickNow === '__other__') || (!!String(d.sourceLabel || '').trim() && (!pickNow || pickNow === '__other__'));
        setTokenRowOtherMode(row, otherOn);
      });
    }

    function setTsmSaveMsg(root, msg) {
      if (!root) return;
      const els = root.querySelectorAll('[data-tsm-save-msg]');
      els.forEach(function(el) { el.textContent = msg != null ? String(msg) : ''; });
    }

    function renderTrafficSourceMappingPanel(state) {
      const sources = (state && Array.isArray(state.sources)) ? state.sources.slice() : [];
      const tokens = (state && Array.isArray(state.tokens)) ? state.tokens.slice() : [];
      sources.sort(function(a, b) {
        const al = (a && a.label != null) ? String(a.label) : '';
        const bl = (b && b.label != null) ? String(b.label) : '';
        return al.localeCompare(bl);
      });

      function fmtTs(ms) { return (typeof ms === 'number' && isFinite(ms)) ? formatTs(ms) : '—'; }
      function tokenJumpId(p, v) {
        const s = String(p || '') + '\u0000' + String(v || '');
        let h = 2166136261;
        for (let i = 0; i < s.length; i++) {
          h ^= s.charCodeAt(i);
          h = Math.imul(h, 16777619);
        }
        return 'tsm-token-' + (h >>> 0).toString(16);
      }

      let html = '';
      html += '<div class="tsm-actions">';
      html +=   '<button type="button" class="tsm-btn primary" data-tsm-action="save-mappings">' + '<span>Save mappings</span>' + '</button>';
      html +=   '<button type="button" class="tsm-btn" data-tsm-action="refresh">' + '<span>Refresh</span>' + '</button>';
      html +=   '<button type="button" class="tsm-btn" data-tsm-action="scan">' + '<span>Scan last 30d</span>' + '</button>';
      html +=   '<button type="button" class="tsm-btn" data-tsm-action="toggle-mapped">' + '<span>' + (trafficSourceMapsShowMappedTokens ? 'Hide mapped tokens' : 'Show mapped tokens') + '</span>' + '</button>';
      html +=   '<span class="tsm-save-msg" data-tsm-save-msg></span>';
      html += '</div>';
      html += '<div class="diag-note">Unmapped tokens appear here first. Pick an existing Source (or choose <strong>Other…</strong>), then press <strong>Save mappings</strong> to apply in bulk. If you map a token again, the newest mapping wins. Paste an icon URL to override the default icon.</div>';

      html += '<div class="diag-section-title">' + '<span>Mapped sources</span>' + '</div>';
      if (!sources.length) {
        html += '<div class="diag-note">No sources yet.</div>';
      } else {
        // Quick-jump row for source meta (icons → scroll to source row)
        try {
          html += '<div class="tsm-jump-row" aria-label="Source shortcuts">';
          sources.forEach(function(s) {
            const key = s && s.source_key != null ? String(s.source_key).trim().toLowerCase() : '';
            if (!key) return;
            const label = s && s.label != null ? String(s.label) : key;
            const iconUrl = s && s.icon_url != null ? String(s.icon_url) : '';
            const builtIn = trafficSourceBuiltInIconSrc(key);
            const previewSrc = (iconUrl && iconUrl.trim())
              ? iconUrl.trim()
              : ((builtIn && builtIn !== SOURCE_UNKNOWN_IMG) ? builtIn : SOURCE_UNKNOWN_IMG);
            const targetId = 'tsm-source-' + key;
            html += '<button type="button" class="tsm-jump-btn" data-tsm-jump-source="' + escapeHtml(targetId) + '" title="' + escapeHtml(label) + '">' +
              '<img src="' + escapeHtml(hotImg(previewSrc) || previewSrc) + '" alt="" />' +
            '</button>';
          });
          html += '</div>';
        } catch (_) {}
        html += '<div class="tsm-table-scroll">';
        html +=   '<div class="grid-table tsm-table tsm-sources-grid" role="table" aria-label="Mapped sources">';
        html +=     '<div class="grid-header" role="rowgroup"><div class="grid-row grid-row--header" role="row">' +
                      '<div class="grid-cell" role="columnheader">Source</div>' +
                      '<div class="grid-cell" role="columnheader">Key</div>' +
                      '<div class="grid-cell" role="columnheader">Icon URL</div>' +
                      '<div class="grid-cell" role="columnheader"></div>' +
                    '</div></div></div>';
        html +=     '<div class="grid-body" role="rowgroup">';
        sources.forEach(function(s) {
          const key = s && s.source_key != null ? String(s.source_key).trim().toLowerCase() : '';
          if (!key) return;
          const label = s && s.label != null ? String(s.label) : key;
          const iconUrl = s && s.icon_url != null ? String(s.icon_url) : '';
          const builtIn = trafficSourceBuiltInIconSrc(key);
          const previewSrc = (iconUrl && iconUrl.trim())
            ? iconUrl.trim()
            : ((builtIn && builtIn !== SOURCE_UNKNOWN_IMG) ? builtIn : '');
          const preview = previewSrc
            ? ('<img class="tsm-icon-preview" src="' + escapeHtml(previewSrc) + '" alt="" onerror="this.classList.add(\'is-hidden\')">')
            : '<span class="tsm-icon-spacer" aria-hidden="true"></span>';
          html += '<div class="grid-row tsm-source-row" role="row" id="tsm-source-' + escapeHtml(key) + '" data-source-key="' + escapeHtml(key) + '">' +
            '<div class="grid-cell" role="cell"><input class="tsm-input" data-field="label" value="' + escapeHtml(label) + '" /></div>' +
            '<div class="grid-cell" role="cell"><code>' + escapeHtml(key) + '</code></div>' +
            '<div class="grid-cell" role="cell"><div class="tsm-icon-input-row">' +
              preview +
              '<input class="tsm-input" data-field="icon_url" placeholder="https://.../icon.png" value="' + escapeHtml(iconUrl || '') + '" />' +
            '</div></div>' +
            '<div class="grid-cell" role="cell"><button type="button" class="tsm-btn primary" data-tsm-action="save-meta">Save</button></div>' +
          '</div>';
        });
        html += '</div></div></div>';
      }

      html += '<div class="diag-section-title u-mt-md">' + '<span>' + (trafficSourceMapsShowMappedTokens ? 'Tokens (mapped + unmapped)' : 'Unmapped tokens') + '</span>' + '</div>';
      // Quick-jump row: show mapped token icons inline for fast navigation.
      try {
        const MAX_JUMPS = 120;
        const mappedTokens = [];
        tokens.forEach(function(t) {
          const p = t && t.utm_param != null ? String(t.utm_param).trim().toLowerCase() : '';
          const v = t && t.utm_value != null ? String(t.utm_value).trim().toLowerCase() : '';
          if (!p || !v) return;
          const mapped = (t && Array.isArray(t.mapped)) ? t.mapped : [];
          const currentKey = (mapped && mapped[0] && mapped[0].source_key != null) ? String(mapped[0].source_key).trim().toLowerCase() : '';
          if (!currentKey) return;
          const label = (mapped && mapped[0] && mapped[0].label != null) ? String(mapped[0].label) : currentKey;
          const mu = (mapped && mapped[0] && mapped[0].icon_url != null) ? String(mapped[0].icon_url) : '';
          let src = (mu && mu.trim()) ? mu.trim() : '';
          if (!src) {
            const bi = trafficSourceBuiltInIconSrc(currentKey);
            if (bi) src = bi;
          }
          if (!src) src = SOURCE_UNKNOWN_IMG;
          mappedTokens.push({
            jumpId: tokenJumpId(p, v),
            iconSrc: src,
            title: p + '=' + v + ' → ' + label,
          });
        });
        if (mappedTokens.length) {
          html += '<div class="tsm-jump-row" aria-label="Mapped token shortcuts">';
          mappedTokens.slice(0, MAX_JUMPS).forEach(function(it) {
            html += '<button type="button" class="tsm-jump-btn" data-tsm-jump="' + escapeHtml(it.jumpId) + '" title="' + escapeHtml(it.title) + '">' +
              '<img src="' + escapeHtml(hotImg(it.iconSrc) || it.iconSrc) + '" alt="" />' +
            '</button>';
          });
          if (mappedTokens.length > MAX_JUMPS) {
            html += '<span class="tsm-save-msg">+' + escapeHtml(String(mappedTokens.length - MAX_JUMPS)) + ' more</span>';
          }
          html += '</div>';
        }
      } catch (_) {}
      if (!tokens.length) {
        html += '<div class="diag-note">No tokens captured yet. Click <strong>Scan last 30d</strong> (or wait for new sessions) and they will appear here.</div>';
      } else {
        html += '<div class="tsm-table-scroll">';
        html +=   '<div class="grid-table tsm-table tsm-tokens-grid" role="table" aria-label="Tokens">';
        html +=     '<div class="grid-header" role="rowgroup"><div class="grid-row grid-row--header" role="row">' +
                      '<div class="grid-cell" role="columnheader">Token</div>' +
                      '<div class="grid-cell" role="columnheader">Seen</div>' +
                      '<div class="grid-cell" role="columnheader">Map / existing</div>' +
                    '</div></div></div>';
        html +=     '<div class="grid-body" role="rowgroup">';
        tokens.forEach(function(t) {
          const p = t && t.utm_param != null ? String(t.utm_param).trim().toLowerCase() : '';
          const v = t && t.utm_value != null ? String(t.utm_value).trim().toLowerCase() : '';
          if (!p || !v) return;
          const jumpId = tokenJumpId(p, v);
          const seenCount = t && typeof t.seen_count === 'number' ? t.seen_count : 0;
          const lastSeen = t && typeof t.last_seen_at === 'number' ? t.last_seen_at : null;
          const mapped = (t && Array.isArray(t.mapped)) ? t.mapped : [];
          const currentKey = (mapped && mapped[0] && mapped[0].source_key != null) ? String(mapped[0].source_key).trim().toLowerCase() : '';
          let opts = '<option value="">Choose…</option>';
          sources.forEach(function(s) {
            const sk = s && s.source_key != null ? String(s.source_key).trim().toLowerCase() : '';
            if (!sk) return;
            const sl = s && s.label != null ? String(s.label) : sk;
            opts += '<option value="' + escapeHtml(sk) + '"' + (sk === currentKey ? ' selected' : '') + '>' + escapeHtml(sl) + '</option>';
          });
          opts += '<option value="__other__">Other…</option>';

          html += '<div class="grid-row tsm-token-row" role="row" id="' + escapeHtml(jumpId) + '" data-utm-param="' + escapeHtml(p) + '" data-utm-value="' + escapeHtml(v) + '" data-current-source-key="' + escapeHtml(currentKey) + '">' +
            '<div class="grid-cell" role="cell"><code>' + escapeHtml(p) + '=' + escapeHtml(v) + '</code></div>' +
            '<div class="grid-cell" role="cell">' + escapeHtml(String(seenCount || 0)) + '<div class="diag-note tsm-seen-subnote">Last: ' + escapeHtml(fmtTs(lastSeen)) + '</div></div>' +
            '<div class="grid-cell" role="cell">' +
              '<div class="tsm-token-map-row">' +
                '<select class="tsm-input tsm-select" data-field="source_pick">' + opts + '</select>' +
                '<input class="tsm-input tsm-token-other is-hidden" data-field="source_label" placeholder="Other source…" />' +
                '<input class="tsm-input tsm-token-icon" data-field="icon_url" placeholder="Icon URL (optional)" />' +
              '</div>' +
              (mapped.length ? ('<div class="tsm-mapped-list">' + mapped.map(function(m) {
                const ml = m && m.label != null ? String(m.label) : (m && m.source_key ? String(m.source_key) : '');
                const mu = m && m.icon_url != null ? String(m.icon_url) : '';
                const mk = m && m.source_key != null ? String(m.source_key).trim().toLowerCase() : '';
                let prevSrc = (mu && mu.trim()) ? mu.trim() : '';
                if (!prevSrc && mk) {
                  const bi = trafficSourceBuiltInIconSrc(mk);
                  if (bi && bi !== SOURCE_UNKNOWN_IMG) prevSrc = bi;
                }
                const prev = prevSrc ? ('<img class="tsm-icon-preview" src="' + escapeHtml(prevSrc) + '" alt="" onerror="this.classList.add(\'is-hidden\')">') : '';
                return '<span class="tsm-mapped-pill">' + prev + escapeHtml(ml) + '</span>';
              }).join('') + '</div>') : '') +
            '</div>' +
          '</div>';
        });
        html += '</div></div></div>';
        html += '<div class="tsm-actions tsm-actions--footer">' +
          '<button type="button" class="tsm-btn primary" data-tsm-action="save-mappings">' + '<span>Save mappings</span>' + '</button>' +
          '<span class="tsm-save-msg" data-tsm-save-msg></span>' +
        '</div>';
      }

      return html;
    }

    function setTrafficSourceMappingFullscreen(on) {
      const modal = document.getElementById('traffic-sources-modal');
      if (!modal) return;
      modal.classList.toggle('tsm-fullscreen', !!on);
    }

    function bindTrafficSourceMappingFullscreen() {
      const details = document.getElementById('traffic-source-mapping-details');
      if (!details) return;
      if (details.getAttribute('data-tsm-fs-bound')) return;
      details.setAttribute('data-tsm-fs-bound', '1');
      details.addEventListener('toggle', function() {
        setTrafficSourceMappingFullscreen(!!details.open);
        if (details.open) {
          try { details.scrollIntoView({ block: 'start' }); } catch (_) {}
        }
      });
      setTrafficSourceMappingFullscreen(!!details.open);
    }

    let trafficSourceMapsLastState = null;
    let trafficSourceMapsLastLoadedAt = 0;

    function refreshTrafficSourceMappingPanel(options = {}) {
      const rootId = options && options.rootId ? String(options.rootId) : 'traffic-source-mapping-root';
      const root = document.getElementById(rootId);
      if (!root) return Promise.resolve(null);
      try { stashTokenDraftsFromRoot(root); } catch (_) {}
      const force = !!options.force;
      const now = Date.now();
      const fresh = !!(trafficSourceMapsLastState && trafficSourceMapsLastLoadedAt && (now - trafficSourceMapsLastLoadedAt) < 30 * 1000);
      if (!force && fresh) {
        root.innerHTML = renderTrafficSourceMappingPanel(trafficSourceMapsLastState);
        try { applyTokenDraftsToRoot(root); } catch (_) {}
        return Promise.resolve(trafficSourceMapsLastState);
      }

      root.innerHTML = '<div class="diag-loading">Loading\u2026</div>';

      if (trafficSourceMapsUiInFlight) {
        return trafficSourceMapsUiInFlight
          .then(function(state) {
            if (state && state.ok === true) {
              root.innerHTML = renderTrafficSourceMappingPanel(state);
              try { applyTokenDraftsToRoot(root); } catch (_) {}
            }
            else root.innerHTML = '<div class="diag-note">Failed to load source mapping.</div>';
            return state;
          })
          .catch(function(err) {
            console.error(err);
            root.innerHTML = '<div class="diag-note">Failed to load source mapping. ' + escapeHtml(err && err.message ? String(err.message) : '') + '</div>';
            return null;
          });
      }

      trafficSourceMapsUiInFlight = fetchTrafficSourceMaps({ force: true, unmappedOnly: !trafficSourceMapsShowMappedTokens })
        .then(function(json) {
          if (!json || json.ok !== true) throw new Error('Bad response');
          trafficSourceMapsLastState = json;
          trafficSourceMapsLastLoadedAt = Date.now();
          return json;
        })
        .catch(function(err) {
          console.error(err);
          return null;
        })
        .finally(function() { trafficSourceMapsUiInFlight = null; });

      return trafficSourceMapsUiInFlight.then(function(state) {
        if (state && state.ok === true) {
          root.innerHTML = renderTrafficSourceMappingPanel(state);
          try { applyTokenDraftsToRoot(root); } catch (_) {}
        }
        else root.innerHTML = '<div class="diag-note">Failed to load source mapping.</div>';
        return state;
      });
    }

    function initTrafficSourceMappingPanel(options = {}) {
      const rootId = options && options.rootId ? String(options.rootId) : 'traffic-source-mapping-root';
      const root = document.getElementById(rootId);
      if (!root) return;
      try { bindTrafficSourceMappingFullscreen(); } catch (_) {}

      // Draft-preserving editors (so Save/Refresh doesn't wipe other rows).
      root.onchange = function(e) {
        const el = e && e.target ? e.target : null;
        if (!el || !el.closest) return;
        const row = el.closest('.tsm-token-row');
        if (!row) return;
        const p = (row.getAttribute('data-utm-param') || '').trim();
        const v = (row.getAttribute('data-utm-value') || '').trim();
        const key = tokenDraftKey(p, v);
        if (!key) return;

        if (el.matches && el.matches('select[data-field="source_pick"]')) {
          const pick = String(el.value || '').trim().toLowerCase();
          setTokenRowOtherMode(row, pick === '__other__');
          if (pick === '__other__') {
            const otherEl = row.querySelector('input[data-field="source_label"]');
            if (otherEl) { try { otherEl.focus(); } catch (_) {} }
          }
        }

        upsertTokenDraft(key, readTokenDraftFromRow(row));
        try { setTsmSaveMsg(root, ''); } catch (_) {}
      };

      root.oninput = function(e) {
        const el = e && e.target ? e.target : null;
        if (!el || !el.closest) return;
        const row = el.closest('.tsm-token-row');
        if (!row) return;
        const p = (row.getAttribute('data-utm-param') || '').trim();
        const v = (row.getAttribute('data-utm-value') || '').trim();
        const key = tokenDraftKey(p, v);
        if (!key) return;
        upsertTokenDraft(key, readTokenDraftFromRow(row));
        try { setTsmSaveMsg(root, ''); } catch (_) {}
      };

      root.onclick = function(e) {
        const jump = e && e.target ? e.target.closest('[data-tsm-jump],[data-tsm-jump-source]') : null;
        if (jump) {
          const id = (jump.getAttribute('data-tsm-jump') || jump.getAttribute('data-tsm-jump-source') || '').trim();
          if (!id) return;
          const row = document.getElementById(id);
          if (row) {
            try { row.scrollIntoView({ block: 'start', behavior: 'smooth' }); } catch (_) { try { row.scrollIntoView(true); } catch (_) {} }
            try {
              row.classList.remove('tsm-flash');
              // restart animation
              void row.offsetWidth;
              row.classList.add('tsm-flash');
              setTimeout(function() { try { row.classList.remove('tsm-flash'); } catch (_) {} }, 1400);
            } catch (_) {}
          }
          return;
        }
        const btn = e && e.target ? e.target.closest('button[data-tsm-action]') : null;
        if (!btn) return;
        const action = (btn.getAttribute('data-tsm-action') || '').trim();
        if (action === 'refresh') {
          refreshTrafficSourceMappingPanel({ force: true, rootId: rootId });
          return;
        }
        if (action === 'toggle-mapped') {
          trafficSourceMapsShowMappedTokens = !trafficSourceMapsShowMappedTokens;
          refreshTrafficSourceMappingPanel({ force: true, rootId: rootId });
          return;
        }
        if (action === 'scan') {
          btn.disabled = true;
          postTrafficSourceBackfill({ since_days: 30, limit_sessions: 20000 })
            .then(function() { return refreshTrafficSourceMappingPanel({ force: true, rootId: rootId }); })
            .finally(function() { btn.disabled = false; });
          return;
        }
        if (action === 'save-mappings') {
          const rootEl = root;
          const rows = Array.from(rootEl.querySelectorAll('.tsm-token-row'));

          // Capture any "dirty" rows into drafts (resilient even if a browser misses input events).
          try {
            rows.forEach(function(r) {
              const utmParam = (r.getAttribute('data-utm-param') || '').trim();
              const utmValue = (r.getAttribute('data-utm-value') || '').trim();
              const tkey = tokenDraftKey(utmParam, utmValue);
              if (!tkey) return;
              const currentKey = (r.getAttribute('data-current-source-key') || '').trim().toLowerCase();
              const pickEl = r.querySelector('select[data-field="source_pick"]');
              const pick = pickEl ? String(pickEl.value || '').trim().toLowerCase() : '';
              const labelEl = r.querySelector('input[data-field="source_label"]');
              const iconEl = r.querySelector('input[data-field="icon_url"]');
              const label = labelEl ? String(labelEl.value || '').trim() : '';
              const iconUrl = iconEl ? String(iconEl.value || '').trim() : '';
              const dirty = (pick === '__other__') || (!!label) || (!!iconUrl) || (!!pick && pick !== currentKey);
              if (!dirty) return;
              upsertTokenDraft(tkey, { sourcePick: pick, sourceLabel: label, iconUrl: iconUrl });
            });
          } catch (_) {}

          const jobs = [];
          rows.forEach(function(r) {
            const utmParam = (r.getAttribute('data-utm-param') || '').trim();
            const utmValue = (r.getAttribute('data-utm-value') || '').trim();
            if (!utmParam || !utmValue) return;
            const tkey = tokenDraftKey(utmParam, utmValue);
            const currentKey = (r.getAttribute('data-current-source-key') || '').trim().toLowerCase();
            const pickEl = r.querySelector('select[data-field="source_pick"]');
            const pick = pickEl ? String(pickEl.value || '').trim().toLowerCase() : '';
            const labelEl = r.querySelector('input[data-field="source_label"]');
            const iconEl = r.querySelector('input[data-field="icon_url"]');
            const label = labelEl ? String(labelEl.value || '').trim() : '';
            const iconUrl = iconEl ? String(iconEl.value || '').trim() : '';
            if (!pick && !label && !iconUrl) return; // nothing entered

            const currentLabel = currentKey ? trafficSourceLabelForKey(currentKey, '') : '';
            if (pick && pick !== '__other__') {
              if (pick === currentKey) {
                if (iconUrl) {
                  jobs.push({
                    kind: 'meta',
                    tokenKey: tkey,
                    payload: { source_key: pick, label: trafficSourceLabelForKey(pick, pick), icon_url: iconUrl },
                  });
                }
                return;
              }
              jobs.push({
                kind: 'map',
                tokenKey: tkey,
                payload: { utm_param: utmParam, utm_value: utmValue, source_key: pick, source_label: '', icon_url: iconUrl || null, since_days: 30, limit_sessions: 50000 },
              });
              return;
            }

            // Other/custom label mode.
            if (!label) return; // can't map without a label

            if (currentKey && normalizeFlatLabel(currentLabel) && normalizeFlatLabel(currentLabel) === normalizeFlatLabel(label)) {
              if (iconUrl) {
                jobs.push({
                  kind: 'meta',
                  tokenKey: tkey,
                  payload: { source_key: currentKey, label: trafficSourceLabelForKey(currentKey, currentKey), icon_url: iconUrl },
                });
              }
              return;
            }

            jobs.push({
              kind: 'map',
              tokenKey: tkey,
              payload: { utm_param: utmParam, utm_value: utmValue, source_label: label, icon_url: iconUrl || null, since_days: 30, limit_sessions: 50000 },
            });
          });

          if (!jobs.length) {
            setTsmSaveMsg(rootEl, 'No pending mappings.');
            return;
          }

          // Disable action buttons while saving.
          rootEl.querySelectorAll('button[data-tsm-action]').forEach(function(b) { b.disabled = true; });
          setTsmSaveMsg(rootEl, 'Saving ' + jobs.length + '…');

          let ok = 0;
          let fail = 0;
          function run(i) {
            if (i >= jobs.length) return Promise.resolve();
            setTsmSaveMsg(rootEl, 'Saving ' + (i + 1) + '/' + jobs.length + '…');
            const j = jobs[i];
            const p = j.kind === 'meta' ? postTrafficSourceMeta(j.payload) : postTrafficSourceMap(j.payload);
            return Promise.resolve(p)
              .then(function() {
                ok += 1;
                if (j && j.tokenKey) trafficSourceTokenDrafts.delete(j.tokenKey);
              })
              .catch(function(err) {
                fail += 1;
                console.error(err);
              })
              .then(function() { return run(i + 1); });
          }

          run(0)
            .then(function() { setTsmSaveMsg(rootEl, 'Saved ' + ok + (fail ? (', failed ' + fail) : '') + '. Refreshing…'); })
            .then(function() { return refreshTrafficSourceMeta({ force: true }); })
            .then(function() { try { refreshTraffic({ force: true }); } catch (_) {} })
            .then(function() { return refreshTrafficSourceMappingPanel({ force: true, rootId: rootId }); })
            .catch(function(err) {
              console.error(err);
              setTsmSaveMsg(rootEl, 'Save failed: ' + (err && err.message ? String(err.message) : 'error'));
            })
            .finally(function() {
              // Buttons will be recreated on refresh; if refresh failed, re-enable the existing ones.
              try {
                const rr = document.getElementById(rootId);
                if (rr) rr.querySelectorAll('button[data-tsm-action]').forEach(function(b) { b.disabled = false; });
              } catch (_) {}
            });
          return;
        }
        if (action === 'map-token') {
          const row = btn.closest('.tsm-token-row');
          if (!row) return;
          const utmParam = (row.getAttribute('data-utm-param') || '').trim();
          const utmValue = (row.getAttribute('data-utm-value') || '').trim();
          const labelEl = row.querySelector('input[data-field="source_label"]');
          const iconEl = row.querySelector('input[data-field="icon_url"]');
          const sourceLabel = labelEl ? String(labelEl.value || '').trim() : '';
          const iconUrl = iconEl ? String(iconEl.value || '').trim() : '';
          if (!utmParam || !utmValue || !sourceLabel) {
            alert('Please enter a Source name.');
            return;
          }
          btn.disabled = true;
          postTrafficSourceMap({ utm_param: utmParam, utm_value: utmValue, source_label: sourceLabel, icon_url: iconUrl || null, since_days: 30, limit_sessions: 50000 })
            .then(function() { return refreshTrafficSourceMeta({ force: true }); })
            .then(function() { try { refreshTraffic({ force: true }); } catch (_) {} })
            .then(function() { return refreshTrafficSourceMappingPanel({ force: true, rootId: rootId }); })
            .finally(function() { btn.disabled = false; });
          return;
        }
        if (action === 'save-meta') {
          const row = btn.closest('.tsm-source-row');
          if (!row) return;
          const sourceKey = (row.getAttribute('data-source-key') || '').trim();
          const labelEl = row.querySelector('input[data-field="label"]');
          const iconEl = row.querySelector('input[data-field="icon_url"]');
          const label = labelEl ? String(labelEl.value || '').trim() : '';
          const iconUrl = iconEl ? String(iconEl.value || '').trim() : '';
          if (!sourceKey || !label) {
            alert('Source label is required.');
            return;
          }
          btn.disabled = true;
          postTrafficSourceMeta({ source_key: sourceKey, label: label, icon_url: iconUrl || null })
            .then(function() { return refreshTrafficSourceMeta({ force: true }); })
            .then(function() { try { renderTable(); } catch (_) {} })
            .then(function() { try { refreshTraffic({ force: true }); } catch (_) {} })
            .then(function() { return refreshTrafficSourceMappingPanel({ force: true, rootId: rootId }); })
            .finally(function() { btn.disabled = false; });
          return;
        }
      };

      // Initial load (best-effort).
      if (!root.getAttribute('data-tsm-loaded')) {
        root.setAttribute('data-tsm-loaded', '1');
        refreshTrafficSourceMappingPanel({ force: true, rootId: rootId });
      }
    }

    function sourceCell(s) {
      function icon(src, alt, title, extraClass) {
        const cls = (extraClass ? (extraClass + ' ') : '') + 'source-icon-img';
        const t = title ? ' title="' + escapeHtml(String(title)) + '"' : '';
        return '<img src="' + escapeHtml(hotImg(src) || src || '') + '" alt="' + escapeHtml(alt || '') + '" class="' + cls + '" width="20" height="20"' + t + '>';
      }

      // Show source icons driven by Traffic sources + mapping:
      // - If a session matches multiple mapping rules, show multiple icons side-by-side.
      // - Otherwise, show the derived `sessions.traffic_source_key` (includes Direct/no-referrer).
      // This avoids legacy hard-coded UTM/referrer icon heuristics and prevents duplicates.
      const keys = [];
      const seen = new Set();
      function addKey(v) {
        const k = v != null ? String(v).trim().toLowerCase() : '';
        if (!k) return;
        if (seen.has(k)) return;
        seen.add(k);
        keys.push(k);
      }

      try {
        const mapped = getMappedSourceKeysForSession(s);
        (Array.isArray(mapped) ? mapped : []).forEach(addKey);
      } catch (_) {}

      if (!keys.length) {
        // Fallback: use stored source_key (so icon/meta changes go live even when no UTM-token mapping exists).
        let k = s && (s.traffic_source_key ?? s.trafficSourceKey ?? s.source_key ?? s.sourceKey);
        const kk = k != null ? String(k).trim().toLowerCase() : '';
        if (kk === 'other') {
          const ref = s && s.referrer != null ? String(s.referrer).toLowerCase() : '';
          if (ref.includes('heybigday.com') || ref.includes('hbdjewellery.com')) k = 'direct';
        }
        addKey(k);
      }

      if (!keys.length) return '';

      const out = [];
      keys.forEach(function(key) {
        const label = trafficSourceLabelForKey(key, key);
        const metaIcon = trafficSourceIconUrlForKey(key);
        const src = metaIcon || trafficSourceBuiltInIconSrc(key) || SOURCE_UNKNOWN_IMG;
        const extra = key === 'google_ads' ? 'source-googleads-img' : '';
        out.push(icon(src, label, label, extra));
      });
      return out.length ? ('<span class="source-icons">' + out.join('') + '</span>') : '';
    }

    function sourceDetailForPanel(s) {
      const lines = [];
      const entry = s.entry_url && String(s.entry_url).trim();
      if (entry) lines.push('Entry URL (CF referer): ' + entry);
      const ref = s.referrer && String(s.referrer).trim();
      if (ref) lines.push('Referrer: ' + ref);
      if (s.utm_source != null && String(s.utm_source).trim() !== '') lines.push('utm_source: ' + String(s.utm_source).trim());
      if (s.utm_medium != null && String(s.utm_medium).trim() !== '') lines.push('utm_medium: ' + String(s.utm_medium).trim());
      if (s.utm_campaign != null && String(s.utm_campaign).trim() !== '') lines.push('utm_campaign: ' + String(s.utm_campaign).trim());
      if (s.utm_content != null && String(s.utm_content).trim() !== '') lines.push('utm_content: ' + String(s.utm_content).trim());
      if (lines.length === 0) return '—';
      return lines.join('\n');
    }

    function renderRow(s) {
      const countryCode = s.country_code || 'XX';
      const visits = (s.returning_count != null ? s.returning_count : 0) + 1;
      const visitsLabel = visits === 1 ? '1 visit' : visits + ' visits';
      const cartValueNum = s.cart_value != null ? Number(s.cart_value) : NaN;
      const cartVal = s.has_purchased ? '' : ((s.cart_value != null && !Number.isNaN(cartValueNum))
        ? formatMoney(Math.floor(cartValueNum), s.cart_currency)
        : '');
      const saleVal = s.has_purchased ? formatMoney(s.order_total != null ? Number(s.order_total) : null, s.order_currency) : '';
      const cartOrSaleCell = s.has_purchased
        ? '<span class="cart-value-sale">' + escapeHtml(saleVal) + '</span>'
        : cartVal;
      const fromCell = flagImg(countryCode);
      let consentDebug = '';
      if (s && s.meta_json) {
        try {
          const mj = JSON.parse(String(s.meta_json || '{}'));
          consentDebug = (mj && mj.customer_privacy_debug) ? 'yes' : '';
        } catch (_) {}
      }
      return `<div class="grid-row clickable ${s.is_returning ? 'returning' : ''} ${s.has_purchased ? 'converted' : ''}" role="row" data-session-id="${s.session_id}">
        <div class="grid-cell" role="cell">${landingPageCell(s)}</div>
        <div class="grid-cell flag-cell" role="cell">${fromCell}</div>
        <div class="grid-cell source-cell" role="cell">${sourceCell(s)}</div>
        <div class="grid-cell" role="cell">${escapeHtml(s.device || '')}</div>
        <div class="grid-cell cart-value-cell" role="cell">${cartOrSaleCell}</div>
        <div class="grid-cell arrived-cell" role="cell"><span data-started="${s.started_at}">${arrivedAgo(s.started_at)}</span></div>
        <div class="grid-cell last-seen-cell" role="cell"><span data-last-seen="${s.last_seen}">${arrivedAgo(s.last_seen)}</span></div>
        <div class="grid-cell" role="cell">${visitsLabel}</div>
        <div class="grid-cell consent-debug consent-col is-hidden" role="cell">${escapeHtml(consentDebug)}</div>
      </div>`;
    }

    function escapeHtml(str) {
      if (str == null) return '';
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    function cartSortValue(s) {
      if (s.has_purchased && s.order_total != null) return Number(s.order_total);
      if (s.cart_value != null) { const n = Number(s.cart_value); if (!Number.isNaN(n)) return n; }
      return -Infinity;
    }

    function getSortedSessions() {
      if (!sortBy) return sessions.slice();
      const list = sessions.slice();
      const mult = sortDir === 'asc' ? 1 : -1;
      list.sort(function (a, b) {
        var va, vb;
        if (sortBy === 'landing') {
          va = (landingSortKey(a) || '').toLowerCase();
          vb = (landingSortKey(b) || '').toLowerCase();
          return mult * (va < vb ? -1 : va > vb ? 1 : 0);
        }
        if (sortBy === 'from') {
          va = (a.country_code || 'ZZ').toUpperCase();
          vb = (b.country_code || 'ZZ').toUpperCase();
          return mult * (va < vb ? -1 : va > vb ? 1 : 0);
        }
        if (sortBy === 'arrived') {
          va = toMs(a.started_at) ?? 0;
          vb = toMs(b.started_at) ?? 0;
          return mult * (va - vb);
        }
        if (sortBy === 'source') {
          va = sourceSortKey(a);
          vb = sourceSortKey(b);
          return mult * (va < vb ? -1 : va > vb ? 1 : 0);
        }
        if (sortBy === 'device') {
          va = (a && a.device != null ? String(a.device) : '').trim().toLowerCase();
          vb = (b && b.device != null ? String(b.device) : '').trim().toLowerCase();
          return mult * (va < vb ? -1 : va > vb ? 1 : 0);
        }
        if (sortBy === 'cart') {
          va = cartSortValue(a);
          vb = cartSortValue(b);
          return mult * (va - vb);
        }
        if (sortBy === 'last_seen') {
          va = toMs(a.last_seen) ?? 0;
          vb = toMs(b.last_seen) ?? 0;
          return mult * (va - vb);
        }
        if (sortBy === 'history') {
          va = visitsCount(a);
          vb = visitsCount(b);
          return mult * (va - vb);
        }
        return 0;
      });
      return list;
    }

    function renderTable() {
      const tbody = document.getElementById('table-body');
      const isRangeMode = sessionsTotal != null;
      const totalPages = isRangeMode
        ? Math.max(1, Math.ceil(sessionsTotal / rowsPerPage))
        : Math.max(1, Math.ceil(getSortedSessions().length / rowsPerPage));
      currentPage = Math.min(Math.max(1, currentPage), totalPages);
      const start = (currentPage - 1) * rowsPerPage;
      const sorted = getSortedSessions();
      const pageSessions = isRangeMode ? sorted : sorted.slice(start, start + rowsPerPage);
      if (pageSessions.length === 0) {
        var emptyMsg = sessionsLoadError ? sessionsLoadError : 'No sessions in this view.';
        tbody.innerHTML = '<div class="grid-row" role="row"><div class="grid-cell empty span-all" role="cell">' + escapeHtml(emptyMsg) + '</div></div>';
      } else {
        tbody.innerHTML = pageSessions.map(renderRow).join('');
        document.querySelectorAll('#table-body .grid-row.clickable').forEach(tr => {
          tr.addEventListener('click', () => {
            selectedSessionId = tr.dataset.sessionId;
            openSidePanel(selectedSessionId);
          });
        });
      }
      const prevBtn = document.getElementById('pagination-prev');
      const nextBtn = document.getElementById('pagination-next');
      const labelEl = document.getElementById('pagination-label');
      if (prevBtn) { prevBtn.disabled = currentPage <= 1; }
      if (nextBtn) { nextBtn.disabled = currentPage >= totalPages; }
      if (labelEl) labelEl.textContent = currentPage + ' of ' + totalPages;
      const rowsSelect = document.getElementById('rows-per-page-select');
      if (rowsSelect) rowsSelect.value = String(rowsPerPage);
      updateSortHeaders();
      syncSessionsTableTightMode();
      tickTimeOnSite();
    }

    function syncSessionsTableTightMode() {
      const wrap = document.querySelector('.table-scroll-wrap');
      const table = document.getElementById('sessions-table');
      if (!wrap || !table) return;
      // "Max mode": when all columns fit, remove extra inter-column padding.
      const fits = table.scrollWidth <= wrap.clientWidth + 1;
      wrap.classList.toggle('tight-cols', !!fits);
    }

    function updateSortHeaders() {
      document.querySelectorAll('.table-scroll-wrap .grid-cell.sortable').forEach(function (th) {
        var col = th.getAttribute('data-sort');
        th.classList.remove('th-sort-asc', 'th-sort-desc');
        th.setAttribute('aria-sort', sortBy === col ? (sortDir === 'asc' ? 'ascending' : 'descending') : 'none');
        if (sortBy === col) th.classList.add(sortDir === 'asc' ? 'th-sort-asc' : 'th-sort-desc');
      });
    }

    function setupSortableHeaders() {
      document.querySelectorAll('.table-scroll-wrap .grid-cell.sortable').forEach(function (th) {
        function activate() {
          var col = (th.getAttribute('data-sort') || '').trim();
          if (!col) return;
          if (sortBy === col) sortDir = sortDir === 'asc' ? 'desc' : 'asc';
          else { sortBy = col; sortDir = SORT_DEFAULTS[col] || 'asc'; }
          renderTable();
        }
        th.addEventListener('click', function (e) {
          if (e && typeof e.preventDefault === 'function') e.preventDefault();
          activate();
        });
        th.addEventListener('keydown', function (e) {
          if (!e || (e.key !== 'Enter' && e.key !== ' ')) return;
          e.preventDefault();
          activate();
        });
      });
    }

    function tickTimeOnSite() {
      document.querySelectorAll('#table-body span[data-started]').forEach(span => {
        const started = parseInt(span.getAttribute('data-started'), 10);
        span.textContent = arrivedAgo(started);
      });
      document.querySelectorAll('#table-body span[data-last-seen]').forEach(span => {
        const lastSeen = parseInt(span.getAttribute('data-last-seen'), 10);
        span.textContent = arrivedAgo(lastSeen);
      });
    }

    function pct(v) { return v != null ? v.toFixed(1) + '%' : ''; }

    function crPillHtml(v) {
      const n = v != null ? Number(v) : NaN;
      if (!Number.isFinite(n)) return '';
      return '<span class="aov-card-cr-pill" title="Conversion rate">CR ' + escapeHtml(pct(n)) + '</span>';
    }

    function formatRevenue(num) {
      if (num == null || typeof num !== 'number') return '';
      return '\u00A3' + (num % 1 === 0 ? num : num.toFixed(2));
    }

    function formatRevenueSub(num) {
      if (num == null || typeof num !== 'number' || !Number.isFinite(num)) return '\u2014';
      return formatRevenue(num) || '\u2014';
    }

    function isIconMode() {
      try {
        return !!(window.matchMedia && window.matchMedia('(max-width: 768px)').matches);
      } catch (_) {
        return false;
      }
    }

    function formatRevenueTableHtml(num) {
      if (num == null || typeof num !== 'number' || !Number.isFinite(num)) return '—';
      if (isIconMode()) return '\u00A3' + Math.round(num);
      if (num % 1 === 0) return '\u00A3' + num;
      const fixed = num.toFixed(2);
      const parts = fixed.split('.');
      return '\u00A3' + parts[0] + '<span class="rev-decimal">.' + parts[1] + '</span>';
    }

    function animateTickerText(el, nextText) {
      if (!el) return;
      const prev = el.textContent != null ? String(el.textContent) : '';
      const next = nextText != null ? String(nextText) : '';
      if (prev === next) {
        el.textContent = next;
        return;
      }
      const wrap = document.createElement('span');
      wrap.className = 'kpi-ticker';
      const stack = document.createElement('span');
      stack.className = 'kpi-ticker-stack';
      const a = document.createElement('span');
      a.className = 'kpi-ticker-line';
      a.textContent = prev;
      const b = document.createElement('span');
      b.className = 'kpi-ticker-line';
      b.textContent = next;
      stack.appendChild(a);
      stack.appendChild(b);
      wrap.appendChild(stack);
      while (el.firstChild) el.removeChild(el.firstChild);
      el.appendChild(wrap);
      requestAnimationFrame(function() { wrap.classList.add('run'); });
      setTimeout(function() {
        // Finalize (but only if the wrapper is still present).
        if (el && el.contains(wrap)) el.textContent = next;
      }, 460);
    }

    function animateOdometerText(el, nextText) {
      if (!el) return;
      const next = nextText != null ? String(nextText) : '';
      const prevStored = el.getAttribute('data-odometer');
      const prev = prevStored != null ? String(prevStored) : (el.textContent != null ? String(el.textContent) : '');
      if (prev === next) {
        el.textContent = next;
        el.setAttribute('data-odometer', next);
        return;
      }
      const wrap = document.createElement('span');
      wrap.className = 'kpi-odometer';
      const stacks = [];
      for (let i = 0; i < next.length; i++) {
        const ch = next[i];
        if (ch >= '0' && ch <= '9') {
          const prevCh = prev[i] || '0';
          const prevDigit = (prevCh >= '0' && prevCh <= '9') ? parseInt(prevCh, 10) : 0;
          const digit = parseInt(ch, 10);
          const digitWrap = document.createElement('span');
          digitWrap.className = 'kpi-odometer-digit';
          const stack = document.createElement('span');
          stack.className = 'kpi-odometer-stack';
          for (let d = 0; d <= 9; d++) {
            const line = document.createElement('span');
            line.textContent = String(d);
            stack.appendChild(line);
          }
          stack.style.transform = 'translateY(' + (-prevDigit) + 'em)';
          digitWrap.appendChild(stack);
          wrap.appendChild(digitWrap);
          stacks.push({ stack, digit });
        } else {
          const span = document.createElement('span');
          span.className = 'kpi-odometer-char';
          span.textContent = ch;
          wrap.appendChild(span);
        }
      }
      while (el.firstChild) el.removeChild(el.firstChild);
      el.appendChild(wrap);
      el.setAttribute('data-odometer', next);
      requestAnimationFrame(function() {
        stacks.forEach(function(item) {
          item.stack.style.transform = 'translateY(' + (-item.digit) + 'em)';
        });
      });
      setTimeout(function() {
        if (!el || !el.contains(wrap)) return;
        const icon = el.querySelector('.kpi-delta-icon');
        el.textContent = next;
        if (icon) el.appendChild(icon);
      }, 460);
    }

    function productUrlFromHandle(handle) {
      const h = handle != null ? String(handle).trim() : '';
      if (!h) return '';
      const base = getMainBaseUrl();
      if (!base) return '';
      return base + '/products/' + encodeURIComponent(h.replace(/^\/+/, ''));
    }

    function resolveSaleToastThumbSrc(data) {
      if (!data) return '';
      const rawThumb = data.productThumbUrl != null ? String(data.productThumbUrl).trim() : '';
      if (rawThumb) return hotImgSquare(rawThumb) || rawThumb;
      const directUrl = data.productUrl != null ? String(data.productUrl).trim() : '';
      const handleUrl = data.productHandle ? productUrlFromHandle(data.productHandle) : '';
      const finalUrl = directUrl || handleUrl;
      if (!finalUrl) return '';
      return (API || '') + '/api/og-thumb?url=' + encodeURIComponent(finalUrl) + '&width=100';
    }

    function setSaleToastContent(patch) {
      patch = patch && typeof patch === 'object' ? patch : {};
      const data = { ...(saleToastLastPayload || {}) };
      const hasOwn = Object.prototype.hasOwnProperty;
      if (hasOwn.call(patch, 'countryCode')) data.countryCode = patch.countryCode;
      if (hasOwn.call(patch, 'productTitle')) data.productTitle = patch.productTitle;
      if (hasOwn.call(patch, 'amountGbp')) data.amountGbp = patch.amountGbp;
      if (hasOwn.call(patch, 'productHandle')) data.productHandle = patch.productHandle;
      if (hasOwn.call(patch, 'productUrl')) data.productUrl = patch.productUrl;
      if (hasOwn.call(patch, 'productThumbUrl')) data.productThumbUrl = patch.productThumbUrl;
      if (hasOwn.call(patch, 'createdAt')) data.createdAt = patch.createdAt;

      const cc = (data.countryCode || 'XX').toString().trim().toUpperCase().slice(0, 2) || 'XX';
      const product = data.productTitle != null ? String(data.productTitle) : '';
      const amountRaw = data.amountGbp != null ? Number(data.amountGbp) : null;
      const amountGbp = (amountRaw != null && Number.isFinite(amountRaw)) ? amountRaw : null;
      const thumbSrc = resolveSaleToastThumbSrc(data);
      const timeText = formatSaleTime(data.createdAt);

      saleToastLastPayload = {
        ...data,
        countryCode: cc,
        productTitle: product,
        amountGbp: amountGbp,
      };

      const inlineFlagEl = document.getElementById('sale-toast-inline-flag');
      const titleEl = document.getElementById('sale-toast-title');
      const productEl = document.getElementById('sale-toast-product');
      const amountEl = document.getElementById('sale-toast-amount');
      const thumbEl = document.getElementById('sale-toast-thumb');
      const timeEl = document.getElementById('sale-toast-time');
      const titleText = (cc && cc !== 'XX') ? countryLabelFull(cc) : 'Unknown';
      if (inlineFlagEl) inlineFlagEl.innerHTML = flagImgSmall(cc);
      if (titleEl) titleEl.textContent = titleText || 'Unknown';
      if (productEl) productEl.textContent = product && product.trim() ? product : '\u2014';
      if (amountEl) amountEl.textContent = (amountGbp != null) ? (formatRevenue(amountGbp) || '\u00A3\u2014') : '\u00A3\u2014';
      if (thumbEl) {
        thumbEl.innerHTML = thumbSrc
          ? '<img src="' + escapeHtml(thumbSrc) + '" alt="" loading="lazy" onerror="this.classList.add(\'is-hidden\')">'
          : '<span class="sale-toast-thumb-placeholder" aria-hidden="true"></span>';
      }
      if (timeEl) timeEl.textContent = timeText;
      if (data.createdAt != null) {
        try { setLastSaleAt(data.createdAt); } catch (_) {}
      }
    }

    function updateSaleToastToggle() {
      const btn = document.getElementById('last-sale-toggle');
      if (!btn) return;
      const isPinned = !!saleToastPinned;
      btn.classList.toggle('is-on', isPinned);
      btn.setAttribute('aria-pressed', isPinned ? 'true' : 'false');
      btn.setAttribute('aria-label', isPinned ? 'Hide last sale toast' : 'Show last sale toast');
    }

    function showSaleToast() {
      const overlay = document.getElementById('sale-toast-overlay');
      const toast = document.getElementById('sale-toast');
      if (!overlay || !toast) return;
      saleToastActive = true;
      saleToastLastShownAt = Date.now();
      toast.classList.remove('settled');
      overlay.setAttribute('aria-hidden', 'false');
      toast.setAttribute('aria-hidden', 'false');
      requestAnimationFrame(function() { toast.classList.add('active'); });
    }

    function hideSaleToast() {
      const overlay = document.getElementById('sale-toast-overlay');
      const toast = document.getElementById('sale-toast');
      if (saleToastHideTimer) {
        clearTimeout(saleToastHideTimer);
        saleToastHideTimer = null;
      }
      if (!overlay || !toast) {
        saleToastActive = false;
        saleToastSessionId = null;
        return;
      }
      toast.classList.remove('settled');
      toast.classList.remove('active');
      toast.setAttribute('aria-hidden', 'true');
      overlay.setAttribute('aria-hidden', 'true');
      setTimeout(function() {
        saleToastActive = false;
        saleToastSessionId = null;
      }, 320);
    }

    (function initSaleToastTextCrispFix() {
      const toast = document.getElementById('sale-toast');
      if (!toast || !toast.addEventListener) return;
      toast.addEventListener('transitionend', function(e) {
        // When the toast finishes sliding in, drop the transform layer so text stays crisp.
        if (!toast.classList.contains('active')) return;
        if (e && e.propertyName && e.propertyName !== 'transform') return;
        toast.classList.add('settled');
      });
    })();

    let latestSaleFetchInFlight = null;
    function fetchLatestSaleForToast(options = {}) {
      const forceNew = !!(options && options.forceNew);
      if (!forceNew && latestSaleFetchInFlight) return latestSaleFetchInFlight;
      const url = API + '/api/latest-sale?_=' + Date.now();
      const p = fetch(url, { credentials: 'same-origin', cache: 'no-store' })
        .then(function(r) { return r.ok ? r.json() : null; })
        .then(function(json) { return (json && json.ok && json.sale) ? json.sale : null; })
        .catch(function() { return null; })
        .finally(function() { if (latestSaleFetchInFlight === p) latestSaleFetchInFlight = null; });
      latestSaleFetchInFlight = p;
      return p;
    }

    function buildSalesKpiUpdateFromStats(data) {
      const rangeKey = getStatsRange();
      const sales = data && data.sales ? data.sales : {};
      const convertedCountMap = data && data.convertedCount ? data.convertedCount : {};
      const salesVal = typeof sales[rangeKey] === 'number' ? sales[rangeKey] : null;
      const orderCountVal = typeof convertedCountMap[rangeKey] === 'number' ? convertedCountMap[rangeKey] : null;
      return {
        labelText: orderCountVal != null ? (orderCountVal + ' Orders') : 'Orders',
        valueText: salesVal != null ? (formatRevenue(salesVal) || '\u2014') : '\u2014',
      };
    }

    // Sale sound: prime/unlock on first user interaction, and retry once on click if autoplay is blocked.
    function primeSaleAudio() {
      if (!saleAudio || saleAudioPrimed) return;
      const a = saleAudio;
      saleAudioPrimed = true;
      const prevMuted = !!a.muted;
      const prevVol = (typeof a.volume === 'number' && Number.isFinite(a.volume)) ? a.volume : 1;
      try { a.preload = 'auto'; } catch (_) {}
      try { a.load(); } catch (_) {}
      try { a.muted = true; } catch (_) {}
      try { a.volume = 0; } catch (_) {}
      try {
        const p = a.play();
        if (p && typeof p.then === 'function') {
          p.then(function() {
            try { a.pause(); } catch (_) {}
            try { a.currentTime = 0; } catch (_) {}
          }).catch(function() {
            saleAudioPrimed = false;
          }).finally(function() {
            try { a.pause(); } catch (_) {}
            try { a.currentTime = 0; } catch (_) {}
            try { a.muted = prevMuted; } catch (_) {}
            try { a.volume = prevVol; } catch (_) {}
          });
          return;
        }
      } catch (_) {
        saleAudioPrimed = false;
      }
      try { a.pause(); } catch (_) {}
      try { a.currentTime = 0; } catch (_) {}
      try { a.muted = prevMuted; } catch (_) {}
      try { a.volume = prevVol; } catch (_) {}
    }

    function playSaleSound(options = {}) {
      const deferOnClick = options.deferOnClick !== false;
      if (saleMuted || !saleAudio) return;
      try { saleAudio.currentTime = 0; } catch (_) {}
      const p = saleAudio.play();
      if (p && typeof p.catch === 'function') {
        p.catch(function() {
          if (!deferOnClick) return;
          if (saleSoundDeferredOnce) return;
          saleSoundDeferredOnce = true;
          document.addEventListener('click', function once() {
            saleSoundDeferredOnce = false;
            if (saleMuted || !saleAudio) return;
            try { saleAudio.currentTime = 0; } catch (_) {}
            saleAudio.play().catch(function() {});
          }, { once: true });
        });
      }
    }

    function triggerSaleToast(opts) {
      opts = opts && typeof opts === 'object' ? opts : {};
      const session = opts.session || null;
      const playSound = opts.playSound !== false;
      const payload = opts.payload || null;
      const skipLatest = !!opts.skipLatest;
      const persist = !!opts.persist;
      const toastToken = ++saleToastToken; // newest toast wins
      saleToastLastPayload = null;
      saleToastSessionId = session && session.session_id != null ? String(session.session_id) : null;
      saleToastLastOrderId = null;
      if (persist) {
        saleToastPinned = true;
        updateSaleToastToggle();
      } else if (saleToastPinned) {
        saleToastPinned = false;
        updateSaleToastToggle();
      }

      showSaleToast();

      if (payload) {
        setSaleToastContent(payload);
      } else {
        // Fast, best-effort content from the session update (then refined by truth).
        try {
          const cc = session && session.country_code ? String(session.country_code).toUpperCase().slice(0, 2) : 'XX';
          let productTitle = '';
          let productHandle = '';
          if (session && session.last_product_handle) productHandle = String(session.last_product_handle).trim();
          if (!productHandle && session && session.first_product_handle) productHandle = String(session.first_product_handle).trim();
          if (productHandle) productTitle = titleCaseFromHandle(String(productHandle));
          let amountGbp = null;
          if (session && session.order_total != null) {
            const n = typeof session.order_total === 'number' ? session.order_total : parseFloat(String(session.order_total));
            if (Number.isFinite(n)) amountGbp = n;
          }
          const createdAt = (session && session.purchased_at != null)
            ? session.purchased_at
            : (session && session.last_seen != null)
              ? session.last_seen
              : (session && session.started_at != null)
                ? session.started_at
                : Date.now();
          setSaleToastContent({
            countryCode: cc,
            productTitle: productTitle || 'Processing\u2026',
            amountGbp,
            productHandle: productHandle || '',
            createdAt,
          });
        } catch (_) {}
      }

      if (playSound) playSaleSound({ deferOnClick: true });

      if (saleToastHideTimer) clearTimeout(saleToastHideTimer);
      if (!persist) saleToastHideTimer = setTimeout(hideSaleToast, 10000);

      if (skipLatest) return;
      fetchLatestSaleForToast({ forceNew: true }).then(function(sale) {
        if (!sale) return;
        if (toastToken !== saleToastToken) return; // stale fetch (a newer sale toast is showing)
        if (!saleToastActive) return;
        const orderId = sale.orderId != null ? String(sale.orderId) : '';
        if (orderId) saleToastLastOrderId = orderId;
        const cc = sale.countryCode ? String(sale.countryCode).toUpperCase().slice(0, 2) : 'XX';
        const product = sale.productTitle && String(sale.productTitle).trim() ? String(sale.productTitle).trim() : '';
        const amount = sale.amountGbp != null ? Number(sale.amountGbp) : null;
        const productHandle = sale.productHandle != null ? String(sale.productHandle).trim() : '';
        const productThumbUrl = sale.productThumbUrl != null ? String(sale.productThumbUrl).trim() : '';
        const createdAt = sale.createdAt != null ? sale.createdAt : null;
        setSaleToastContent({
          countryCode: cc || 'XX',
          productTitle: product || (document.getElementById('sale-toast-product') ? document.getElementById('sale-toast-product').textContent : '—'),
          amountGbp: (amount != null && Number.isFinite(amount)) ? amount : null,
          productHandle: productHandle || '',
          productThumbUrl: productThumbUrl || '',
          createdAt,
        });
      });
    }

    function buildSaleToastPayloadFromSale(sale) {
      if (!sale) return null;
      const cc = sale.countryCode ? String(sale.countryCode).toUpperCase().slice(0, 2) : 'XX';
      const productTitle = sale.productTitle && String(sale.productTitle).trim() ? String(sale.productTitle).trim() : '';
      const amount = sale.amountGbp != null ? Number(sale.amountGbp) : null;
      return {
        countryCode: cc || 'XX',
        productTitle,
        amountGbp: (amount != null && Number.isFinite(amount)) ? amount : null,
        productHandle: sale.productHandle != null ? String(sale.productHandle).trim() : '',
        productThumbUrl: sale.productThumbUrl != null ? String(sale.productThumbUrl).trim() : '',
        createdAt: sale.createdAt != null ? sale.createdAt : null,
      };
    }

    function triggerManualSaleToast(persist) {
      const keep = !!persist;
      const cached = saleToastLastPayload;
      const cachedAt = cached && cached.createdAt != null ? toMs(cached.createdAt) : null;
      const latestAt = toMs(lastSaleAt);
      const cacheIsFresh = cachedAt != null && latestAt != null && Math.abs(cachedAt - latestAt) < 1000;
      if (cached && (cached.productTitle || cached.amountGbp != null || cached.productHandle || cached.productThumbUrl) && cacheIsFresh) {
        triggerSaleToast({ origin: 'manual', payload: cached, playSound: false, skipLatest: true, persist: keep });
        return;
      }
      fetchLatestSaleForToast({ forceNew: true }).then(function(sale) {
        const payload = buildSaleToastPayloadFromSale(sale);
        if (!payload) return;
        triggerSaleToast({ origin: 'manual', payload: payload, playSound: false, skipLatest: true, persist: keep });
      });
    }

    (function initSaleToastToggle() {
      const btn = document.getElementById('last-sale-toggle');
      if (!btn) return;
      updateSaleToastToggle();
      btn.addEventListener('click', function(e) {
        if (e && typeof e.preventDefault === 'function') e.preventDefault();
        if (saleToastPinned) {
          saleToastPinned = false;
          updateSaleToastToggle();
          hideSaleToast();
        } else {
          triggerManualSaleToast(true);
        }
      });
    })();

    function getShopParam() {
      var p = new URLSearchParams(window.location.search);
      var shop = p.get('shop') || '';
      return shop && /\.myshopify\.com$/i.test(shop) ? shop : null;
    }

    function fetchShopifySales() {
      var shop = getShopForSales();
      if (!shop || getStatsRange() !== 'today') {
        // If the store-base-url lookup is done and we still have no shop, stop waiting and fall back to DB.
        if (getStatsRange() === 'today' && storeBaseUrlLoaded && !shop) shopifySalesTodayLoaded = true;
        shopifySalesTodayLoading = false;
        return;
      }
      if (shopifySalesTodayLoading) return;
      shopifySalesTodayLoading = true;
      fetch(API + '/api/shopify-sales?shop=' + encodeURIComponent(shop), { credentials: 'same-origin' })
        .then(function(r) { return r.ok ? r.json() : null; })
        .then(function(data) {
          shopifySalesToday = data && typeof data.salesToday === 'number' ? data.salesToday : null;
          shopifyOrderCountToday = data && typeof data.orderCountToday === 'number' ? data.orderCountToday : null;
          shopifySalesTodayLoaded = true;
          shopifySalesTodayLoading = false;
          renderSales(statsCache);
          renderLiveKpis(getKpiData());
        })
        .catch(function() {
          shopifySalesToday = null;
          shopifyOrderCountToday = null;
          shopifySalesTodayLoaded = true;
          shopifySalesTodayLoading = false;
          renderSales(statsCache);
          renderLiveKpis(getKpiData());
        });
    }

    function fetchShopifySessions() {
      var shop = getShopForSales();
      if (!shop || getStatsRange() !== 'today') {
        if (getStatsRange() === 'today' && storeBaseUrlLoaded && !shop) shopifySessionsTodayLoaded = true;
        shopifySessionsTodayLoading = false;
        return;
      }
      if (shopifySessionsTodayLoading) return;
      shopifySessionsTodayLoading = true;
      fetch(API + '/api/shopify-sessions?shop=' + encodeURIComponent(shop), { credentials: 'same-origin' })
        .then(function(r) { return r.ok ? r.json() : null; })
        .then(function(data) {
          shopifySessionsToday = data && typeof data.sessionsToday === 'number' ? data.sessionsToday : null;
          shopifySessionsTodayLoaded = true;
          shopifySessionsTodayLoading = false;
          renderLiveKpis(getKpiData());
        })
        .catch(function() {
          shopifySessionsToday = null;
          shopifySessionsTodayLoaded = true;
          shopifySessionsTodayLoading = false;
          renderLiveKpis(getKpiData());
        });
    }

    function fetchBestSellers(options = {}) {
      const force = !!options.force;
      var shop = getShopParam() || shopForSalesFallback || null;
      if (!shop) {
        bestSellersCache = null;
        renderBestSellers(null);
        return Promise.resolve(null);
      }
      let url = API + '/api/shopify-best-sellers?shop=' + encodeURIComponent(shop) +
          '&range=' + encodeURIComponent(getStatsRange()) +
          '&page=' + encodeURIComponent(String(bestSellersPage || 1)) +
          '&pageSize=' + encodeURIComponent(String(TOP_TABLE_PAGE_SIZE)) +
          '&sort=' + encodeURIComponent(String(bestSellersSortBy || 'rev')) +
          '&dir=' + encodeURIComponent(String(bestSellersSortDir || 'desc'));
      if (force) url += '&_=' + Date.now();
      return fetchWithTimeout(url, { credentials: 'same-origin', cache: force ? 'no-store' : 'default' }, 30000)
        .then(function(r) { return r.json().then(function(data) { return { ok: r.ok, status: r.status, data: data || {} }; }).catch(function() { return { ok: r.ok, status: r.status, data: {} }; }); })
        .then(function(result) {
          if (result.ok) {
            bestSellersCache = result.data;
            renderBestSellers(result.data);
            return result.data;
          }
          var msg = (result.data && result.data.error) ? result.data.error : ('Error ' + result.status);
          if (result.data && result.data.hint) msg += '. ' + result.data.hint;
          bestSellersCache = null;
          renderBestSellers(null, msg);
          return null;
        })
        .catch(function() { bestSellersCache = null; renderBestSellers(null); return null; });
    }

    function normalizeProductsLeaderboardView(v) {
      const s = v != null ? String(v).trim().toLowerCase() : '';
      return s === 'type' ? 'type' : 'title';
    }

    function labelForProductsLeaderboardView(view) {
      return normalizeProductsLeaderboardView(view) === 'type' ? 'Product Type' : 'Product Title';
    }

    function updateProductsLeaderboardDropdownUi() {
      const view = normalizeProductsLeaderboardView(productsLeaderboardView);
      const labelEl = document.getElementById('products-leaderboard-label');
      const grid = document.getElementById('leaderboard-cards-grid');
      const wrap = document.getElementById('leaderboard-cards-wrap');
      const menu = document.getElementById('products-leaderboard-menu');
      if (labelEl) labelEl.textContent = labelForProductsLeaderboardView(view);
      if (grid) grid.setAttribute('data-leaderboard-view', view);
      if (wrap) wrap.setAttribute('data-leaderboard-view', view);
      if (menu) {
        const opts = menu.querySelectorAll('.aov-cards-title-option');
        opts.forEach(function(el) {
          const v = normalizeProductsLeaderboardView(el && el.getAttribute ? el.getAttribute('data-view') : '');
          el.setAttribute('aria-current', v === view ? 'true' : 'false');
        });
      }
    }

    function closeProductsLeaderboardMenu() {
      const btn = document.getElementById('products-leaderboard-btn');
      const menu = document.getElementById('products-leaderboard-menu');
      if (btn) btn.setAttribute('aria-expanded', 'false');
      if (menu) {
        menu.classList.remove('open');
        menu.setAttribute('aria-hidden', 'true');
      }
    }

    function toggleProductsLeaderboardMenu() {
      const btn = document.getElementById('products-leaderboard-btn');
      const menu = document.getElementById('products-leaderboard-menu');
      if (!btn || !menu) return;
      const open = btn.getAttribute('aria-expanded') === 'true';
      if (open) {
        closeProductsLeaderboardMenu();
      } else {
        btn.setAttribute('aria-expanded', 'true');
        menu.classList.add('open');
        menu.setAttribute('aria-hidden', 'false');
      }
    }

    function setProductsLeaderboardView(nextView, options = {}) {
      const force = !!(options && options.force);
      const view = normalizeProductsLeaderboardView(nextView);
      productsLeaderboardView = view;
      try { sessionStorage.setItem(PRODUCTS_LEADERBOARD_VIEW_KEY, view); } catch (_) {}
      updateProductsLeaderboardDropdownUi();
      closeProductsLeaderboardMenu();
      renderProductsLeaderboard(leaderboardCache);
      if (activeMainTab !== 'breakdown' && activeMainTab !== 'products') return;
      fetchProductsLeaderboard({ force }).catch(function() {});
    }

    (function initProductsLeaderboardDropdown() {
      updateProductsLeaderboardDropdownUi();
      const btn = document.getElementById('products-leaderboard-btn');
      const menu = document.getElementById('products-leaderboard-menu');
      const root = document.getElementById('products-leaderboard-dropdown');
      if (!btn || !menu || !root) return;
      btn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        toggleProductsLeaderboardMenu();
      });
      menu.addEventListener('click', function(e) {
        const t = e && e.target ? e.target : null;
        const opt = t && t.closest ? t.closest('.aov-cards-title-option') : null;
        if (!opt) return;
        e.preventDefault();
        e.stopPropagation();
        setProductsLeaderboardView(opt.getAttribute('data-view') || '', { force: false });
      });
      document.addEventListener('click', function(e) {
        const target = e && e.target ? e.target : null;
        if (target && root.contains && root.contains(target)) return;
        closeProductsLeaderboardMenu();
      });
      document.addEventListener('keydown', function(e) {
        if (!e || e.key !== 'Escape') return;
        closeProductsLeaderboardMenu();
      });
    })();

    function normalizeProductsVariantCardsView(v) {
      const s = v != null ? String(v).trim().toLowerCase() : '';
      if (s === 'lengths' || s === 'length') return 'lengths';
      return 'finishes';
    }

    function labelForProductsVariantCardsView(view) {
      return normalizeProductsVariantCardsView(view) === 'lengths' ? 'Variant Length' : 'Variant Finish';
    }

    function updateProductsVariantCardsDropdownUi() {
      const view = normalizeProductsVariantCardsView(productsVariantCardsView);
      const labelEl = document.getElementById('products-variant-cards-label');
      const grid = document.getElementById('finishes-cards-grid');
      const wrap = document.getElementById('finishes-cards-wrap');
      const menu = document.getElementById('products-variant-cards-menu');
      if (labelEl) labelEl.textContent = labelForProductsVariantCardsView(view);
      if (grid) grid.setAttribute('data-cards-view', view);
      if (wrap) wrap.setAttribute('data-cards-view', view);
      if (menu) {
        const opts = menu.querySelectorAll('.aov-cards-title-option');
        opts.forEach(function(el) {
          const v = normalizeProductsVariantCardsView(el && el.getAttribute ? el.getAttribute('data-view') : '');
          el.setAttribute('aria-current', v === view ? 'true' : 'false');
        });
      }
    }

    function closeProductsVariantCardsMenu() {
      const btn = document.getElementById('products-variant-cards-btn');
      const menu = document.getElementById('products-variant-cards-menu');
      if (btn) btn.setAttribute('aria-expanded', 'false');
      if (menu) {
        menu.classList.remove('open');
        menu.setAttribute('aria-hidden', 'true');
      }
    }

    function toggleProductsVariantCardsMenu() {
      const btn = document.getElementById('products-variant-cards-btn');
      const menu = document.getElementById('products-variant-cards-menu');
      if (!btn || !menu) return;
      const open = btn.getAttribute('aria-expanded') === 'true';
      if (open) {
        closeProductsVariantCardsMenu();
      } else {
        btn.setAttribute('aria-expanded', 'true');
        menu.classList.add('open');
        menu.setAttribute('aria-hidden', 'false');
      }
    }

    function setProductsVariantCardsView(nextView, options = {}) {
      const force = !!(options && options.force);
      const view = normalizeProductsVariantCardsView(nextView);
      productsVariantCardsView = view;
      try { sessionStorage.setItem(PRODUCTS_VARIANT_CARDS_VIEW_KEY, view); } catch (_) {}
      updateProductsVariantCardsDropdownUi();
      closeProductsVariantCardsMenu();
      if (activeMainTab !== 'breakdown' && activeMainTab !== 'products') return;
      if (view === 'lengths') {
        if (lengthsCache) renderLengths(lengthsCache);
        fetchLengths({ force }).catch(function() {});
      } else {
        if (finishesCache) renderFinishes(finishesCache);
        fetchFinishes({ force }).catch(function() {});
      }
    }

    (function initProductsVariantCardsDropdown() {
      updateProductsVariantCardsDropdownUi();
      const btn = document.getElementById('products-variant-cards-btn');
      const menu = document.getElementById('products-variant-cards-menu');
      const root = document.getElementById('products-variant-cards-dropdown');
      if (!btn || !menu || !root) return;
      btn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        toggleProductsVariantCardsMenu();
      });
      menu.addEventListener('click', function(e) {
        const t = e && e.target ? e.target : null;
        const opt = t && t.closest ? t.closest('.aov-cards-title-option') : null;
        if (!opt) return;
        e.preventDefault();
        e.stopPropagation();
        setProductsVariantCardsView(opt.getAttribute('data-view') || '', { force: false });
      });
      document.addEventListener('click', function(e) {
        const target = e && e.target ? e.target : null;
        if (target && root.contains && root.contains(target)) return;
        closeProductsVariantCardsMenu();
      });
      document.addEventListener('keydown', function(e) {
        if (!e || e.key !== 'Escape') return;
        closeProductsVariantCardsMenu();
      });
    })();

    function fetchProductsLeaderboard(options = {}) {
      const force = !!options.force;
      var shop = getShopParam() || shopForSalesFallback || null;
      if (!shop) {
        leaderboardLoading = false;
        leaderboardCache = null;
        renderProductsLeaderboard(null);
        return Promise.resolve(null);
      }
      leaderboardLoading = true;
      if (!leaderboardCache) renderProductsLeaderboard(null);
      let url = API + '/api/shopify-leaderboard?shop=' + encodeURIComponent(shop) +
        '&topProducts=' + encodeURIComponent(String(PRODUCTS_LEADERBOARD_FETCH_LIMIT)) +
        '&topTypes=' + encodeURIComponent(String(PRODUCTS_LEADERBOARD_FETCH_LIMIT)) +
        '&range=' + encodeURIComponent(getStatsRange());
      if (force) url += '&_=' + Date.now();
      return fetchWithTimeout(url, { credentials: 'same-origin', cache: force ? 'no-store' : 'default' }, 30000)
        .then(function(r) { return r.ok ? r.json() : null; })
        .then(function(data) {
          leaderboardCache = data;
          leaderboardLoading = false;
          renderProductsLeaderboard(data);
          renderAllTypeTables(data);
          return data;
        })
        .catch(function() { leaderboardCache = null; leaderboardLoading = false; renderProductsLeaderboard(null); renderAllTypeTables(null); return null; })
        .finally(function() { leaderboardLoading = false; });
    }

    function productsLeaderboardIsMobile() {
      return !!(window.matchMedia && window.matchMedia('(max-width: 768px)').matches);
    }

    function productsLeaderboardIsMedium() {
      return !!(window.matchMedia && window.matchMedia('(max-width: 980px)').matches);
    }

    function productsLeaderboardColumnsForView(view) {
      const v = normalizeProductsLeaderboardView(view);
      const isMobile = productsLeaderboardIsMobile();
      const isMedium = !isMobile && productsLeaderboardIsMedium();
      if (v === 'type') {
        if (isMobile) return 1;
        if (isMedium) return 2;
        return 4;
      }
      // v === 'title'
      if (isMobile) return 2;
      if (isMedium) return 4;
      return 6;
    }

    function productsLeaderboardMaxItems() {
      return productsLeaderboardIsMobile() ? 4 : 12;
    }

    function sliceProductsLeaderboardEven(list, view) {
      const arr = Array.isArray(list) ? list : [];
      const cols = productsLeaderboardColumnsForView(view);
      const max = productsLeaderboardMaxItems();
      const target = Math.min(arr.length, max);
      if (target <= 0) return [];
      if (cols <= 1 || target < cols) return arr.slice(0, target);
      const even = target - (target % cols);
      return arr.slice(0, even || target);
    }

    function renderProductsLeaderboard(data) {
      const view = normalizeProductsLeaderboardView(productsLeaderboardView);
      const grid = document.getElementById('leaderboard-cards-grid');
      if (!grid) return;
      grid.setAttribute('data-leaderboard-view', view);

      const hasData = !!(data && data.ok);
      const listAll = hasData ? (view === 'type' ? (data.byType || []) : (data.byTitle || [])) : [];
      const list = sliceProductsLeaderboardEven(listAll, view);

      if (!hasData || !listAll.length) {
        if (leaderboardLoading) {
          grid.innerHTML = '<div class="aov-card aov-card-empty aov-card--leaderboard-loading"><span class="inline-spinner" aria-hidden="true"></span><span>Building leaderboards...</span></div>';
        } else {
          grid.innerHTML = '<div class="aov-card aov-card-empty">No data</div>';
        }
        return;
      }

      if (view === 'type') {
        grid.innerHTML = list.map(function(row) {
          const label = row && (row.label || row.key) ? String(row.label || row.key) : 'Unknown';
          const rev = row && row.revenueGbp != null ? Number(row.revenueGbp) : 0;
          const value = formatMoneyCompact(Number.isFinite(rev) ? rev : 0, 'GBP') || '\u00A30';
          const cr = crPillHtml(row && row.cr);
          return '<div class="aov-card aov-card--leaderboard aov-card--leaderboard-type">' +
              '<div class="aov-card-left"><span class="aov-card-name leaderboard-type-name">' + escapeHtml(label || 'Unknown') + '</span></div>' +
              '<div class="aov-card-value"><span class="aov-card-value-main">' + escapeHtml(value) + '</span>' + cr + '</div>' +
            '</div>';
        }).join('');
        return;
      }

      // view === 'title'
      const mainBase = getMainBaseUrl();
      grid.innerHTML = list.map(function(row) {
        const title = row && row.title != null ? String(row.title) : 'Product';
        const handle = row && row.handle ? String(row.handle) : '';
        const thumb = row && row.thumb_url ? String(row.thumb_url) : '';
        const rev = row && row.revenueGbp != null ? Number(row.revenueGbp) : 0;
        const value = formatMoneyCompact(Number.isFinite(rev) ? rev : 0, 'GBP') || '\u00A30';
        const cr = crPillHtml(row && row.cr);
        const productUrl = (mainBase && handle) ? (mainBase + '/products/' + encodeURIComponent(handle)) : '';
        const thumbInner = '<span class="leaderboard-thumb-wrap">' +
            '<span class="leaderboard-thumb-placeholder" aria-hidden="true"></span>' +
            (thumb
              ? '<img class="leaderboard-thumb" src="' + escapeHtml(hotImgSquare(thumb) || thumb) + '" alt="" loading="lazy" onerror="this.classList.add(\'is-hidden\')">'
              : '') +
          '</span>';
        const img = productUrl
          ? '<a class="leaderboard-thumb-link" href="' + escapeHtml(productUrl) + '" target="_blank" rel="noopener" aria-label="Open product: ' + escapeHtml(title || 'Product') + '">' + thumbInner + '</a>'
          : thumbInner;
        return '<div class="aov-card aov-card--leaderboard aov-card--leaderboard-title">' +
            '<div class="aov-card-left">' +
              img +
              '<span class="aov-card-name sr-only">' + escapeHtml(title || 'Product') + '</span>' +
            '</div>' +
            '<div class="aov-card-value"><span class="aov-card-value-main">' + escapeHtml(value) + '</span>' + cr + '</div>' +
          '</div>';
      }).join('');
    }

    // ── Product Type Tables (Necklaces, Bracelets, Earrings, Sets, Charms, Extras) ──
    var TYPE_TABLE_DEFS = [
      { id: 'necklaces', keys: ['necklaces', 'necklace'] },
      { id: 'bracelets', keys: ['bracelets', 'bracelet'] },
      { id: 'earrings',  keys: ['earrings', 'earring'] },
      { id: 'sets',      keys: ['jewellery sets', 'jewellery set', 'jewelry sets', 'jewelry set', 'sets', 'set'] },
      { id: 'charms',    keys: ['charms', 'charm'] },
      { id: 'extras',    keys: ['extras', 'extra'] },
    ];
    var TYPE_TABLE_PAGE_SIZE = 5;
    var typeTablePages = {};
    TYPE_TABLE_DEFS.forEach(function(d) { typeTablePages[d.id] = 1; });

    function getTypeProducts(data, def) {
      if (!data || !data.productsByType) return [];
      var out = [];
      for (var i = 0; i < def.keys.length; i++) {
        var arr = data.productsByType[def.keys[i]];
        if (Array.isArray(arr)) out = out.concat(arr);
      }
      return out;
    }

    function renderTypeTable(data, def) {
      var tbody = document.getElementById('type-' + def.id + '-body');
      if (!tbody) return;
      var rows = getTypeProducts(data, def);
      if (!rows.length) {
        tbody.innerHTML = '<div class="grid-row" role="row"><div class="grid-cell empty span-all" role="cell">' + (leaderboardLoading ? 'Loading\u2026' : 'No data') + '</div></div>';
        updateCardPagination('type-' + def.id, 1, 1);
        return;
      }
      var totalPages = Math.max(1, Math.ceil(rows.length / TYPE_TABLE_PAGE_SIZE));
      var page = clampPage(typeTablePages[def.id] || 1, totalPages);
      typeTablePages[def.id] = page;
      updateCardPagination('type-' + def.id, page, totalPages);
      var start = (page - 1) * TYPE_TABLE_PAGE_SIZE;
      var pageRows = rows.slice(start, start + TYPE_TABLE_PAGE_SIZE);
      const mainBase = getMainBaseUrl();
      tbody.innerHTML = pageRows.map(function(r) {
        var title = r && r.title ? String(r.title) : '—';
        var orders = r && r.orders != null ? Number(r.orders) : 0;
        var sessions = r && r.sessions != null ? Number(r.sessions) : 0;
        var rev = r && r.revenueGbp != null ? formatRevenueTableHtml(r.revenueGbp) : '—';
        var cr = r && r.cr != null ? pct(r.cr) : '—';
        var handle = r && r.handle ? String(r.handle) : '';
        var thumb = r && r.thumb_url ? String(r.thumb_url) : '';
        var productUrl = (mainBase && handle) ? (mainBase + '/products/' + encodeURIComponent(handle)) : '';
        var thumbUrl = thumb ? (hotImgSquare(thumb) || thumb) : '';
        var thumbImg = '<span class="thumb-wrap">' +
          '<span class="bs-thumb-placeholder" aria-hidden="true"></span>' +
          (thumbUrl ? '<img class="bs-thumb" src="' + escapeHtml(thumbUrl) + '" alt="" loading="lazy" onerror="this.remove()">' : '') +
        '</span>';
        var thumbHtml = productUrl ? '<a href="' + escapeHtml(productUrl) + '" target="_blank" rel="noopener">' + thumbImg + '</a>' : thumbImg;
        var name = '<span class="bs-name" title="' + escapeHtml(title) + '">' + escapeHtml(title) + '</span>';
        return '<div class="grid-row" role="row">' +
          '<div class="grid-cell bs-product-col" role="cell"><div class="product-cell">' + thumbHtml + ' ' + name + '</div></div>' +
          '<div class="grid-cell" role="cell">' + formatSessions(orders) + '</div>' +
          '<div class="grid-cell" role="cell">' + formatSessions(sessions) + '</div>' +
          '<div class="grid-cell" role="cell">' + rev + '</div>' +
          '<div class="grid-cell" role="cell">' + cr + '</div>' +
        '</div>';
      }).join('');
    }

    function renderAllTypeTables(data) {
      TYPE_TABLE_DEFS.forEach(function(def) { renderTypeTable(data, def); });
    }

    (function initTypeTablePagination() {
      TYPE_TABLE_DEFS.forEach(function(def) {
        var prevBtn = document.getElementById('type-' + def.id + '-prev');
        var nextBtn = document.getElementById('type-' + def.id + '-next');
        if (prevBtn) prevBtn.addEventListener('click', function() {
          typeTablePages[def.id] = Math.max(1, (typeTablePages[def.id] || 1) - 1);
          renderTypeTable(leaderboardCache, def);
        });
        if (nextBtn) nextBtn.addEventListener('click', function() {
          typeTablePages[def.id] = (typeTablePages[def.id] || 1) + 1;
          renderTypeTable(leaderboardCache, def);
        });
      });
    })();

    (function initProductsLeaderboardResizeWatcher() {
      let raf = null;
      function schedule() {
        if (activeMainTab !== 'products') return;
        if (!leaderboardCache && !leaderboardLoading) return;
        if (typeof requestAnimationFrame !== 'function') {
          renderProductsLeaderboard(leaderboardCache);
          return;
        }
        if (raf) cancelAnimationFrame(raf);
        raf = requestAnimationFrame(function() {
          raf = null;
          if (activeMainTab !== 'products') return;
          renderProductsLeaderboard(leaderboardCache);
        });
      }
      try { window.addEventListener('resize', schedule); } catch (_) {}
    })();

    function fetchFinishes(options = {}) {
      const force = !!options.force;
      var shop = getShopParam() || shopForSalesFallback || null;
      if (!shop) {
        finishesLoading = false;
        finishesCache = null;
        if (normalizeProductsVariantCardsView(productsVariantCardsView) === 'finishes') renderFinishes(null);
        return Promise.resolve(null);
      }
      finishesLoading = true;
      if (!finishesCache && normalizeProductsVariantCardsView(productsVariantCardsView) === 'finishes') renderFinishes(null);
      let url = API + '/api/shopify-finishes?shop=' + encodeURIComponent(shop) +
          '&range=' + encodeURIComponent(getStatsRange());
      if (force) url += '&_=' + Date.now();
      return fetchWithTimeout(url, { credentials: 'same-origin', cache: force ? 'no-store' : 'default' }, 30000)
        .then(function(r) { return r.ok ? r.json() : null; })
        .then(function(data) {
          finishesCache = data;
          if (normalizeProductsVariantCardsView(productsVariantCardsView) === 'finishes') renderFinishes(data);
          return data;
        })
        .catch(function() { finishesCache = null; finishesLoading = false; if (normalizeProductsVariantCardsView(productsVariantCardsView) === 'finishes') renderFinishes(null); return null; })
        .finally(function() { finishesLoading = false; });
    }

    function fetchLengths(options = {}) {
      const force = !!options.force;
      var shop = getShopParam() || shopForSalesFallback || null;
      if (!shop) {
        lengthsLoading = false;
        lengthsCache = null;
        if (normalizeProductsVariantCardsView(productsVariantCardsView) === 'lengths') renderLengths(null);
        return Promise.resolve(null);
      }
      lengthsLoading = true;
      if (!lengthsCache && normalizeProductsVariantCardsView(productsVariantCardsView) === 'lengths') renderLengths(null);
      let url = API + '/api/shopify-lengths?shop=' + encodeURIComponent(shop) +
          '&range=' + encodeURIComponent(getStatsRange());
      if (force) url += '&_=' + Date.now();
      return fetchWithTimeout(url, { credentials: 'same-origin', cache: force ? 'no-store' : 'default' }, 30000)
        .then(function(r) { return r.ok ? r.json() : null; })
        .then(function(data) {
          lengthsCache = data;
          if (normalizeProductsVariantCardsView(productsVariantCardsView) === 'lengths') renderLengths(data);
          return data;
        })
        .catch(function() { lengthsCache = null; lengthsLoading = false; if (normalizeProductsVariantCardsView(productsVariantCardsView) === 'lengths') renderLengths(null); return null; })
        .finally(function() { lengthsLoading = false; });
    }

    function fetchChainStyles(options = {}) {
      const force = !!options.force;
      var shop = getShopParam() || shopForSalesFallback || null;
      if (!shop) {
        chainStylesLoading = false;
        chainStylesCache = null;
        return Promise.resolve(null);
      }
      chainStylesLoading = true;
      let url = API + '/api/shopify-chain-styles?shop=' + encodeURIComponent(shop) +
          '&range=' + encodeURIComponent(getStatsRange());
      if (force) url += '&_=' + Date.now();
      return fetchWithTimeout(url, { credentials: 'same-origin', cache: force ? 'no-store' : 'default' }, 30000)
        .then(function(r) { return r.ok ? r.json() : null; })
        .then(function(data) {
          chainStylesCache = data;
          chainStylesLoading = false;
          return data;
        })
        .catch(function() { chainStylesCache = null; chainStylesLoading = false; return null; })
        .finally(function() { chainStylesLoading = false; });
    }

    function fetchBestVariants(options = {}) {
      const force = !!options.force;
      var shop = getShopParam() || shopForSalesFallback || null;
      if (!shop) {
        bestVariantsCache = null;
        renderBestVariants(null);
        return Promise.resolve(null);
      }
      let url = API + '/api/shopify-best-variants?shop=' + encodeURIComponent(shop) +
          '&range=' + encodeURIComponent(getStatsRange()) +
          '&page=' + encodeURIComponent(String(bestVariantsPage || 1)) +
          '&pageSize=' + encodeURIComponent(String(TOP_TABLE_PAGE_SIZE));
      if (force) url += '&_=' + Date.now();
      return fetchWithTimeout(url, { credentials: 'same-origin', cache: force ? 'no-store' : 'default' }, 30000)
        .then(function(r) { return r.json().then(function(data) { return { ok: r.ok, status: r.status, data: data || {} }; }).catch(function() { return { ok: r.ok, status: r.status, data: {} }; }); })
        .then(function(result) {
          if (result.ok) {
            bestVariantsCache = result.data;
            renderBestVariants(result.data);
            return result.data;
          }
          var msg = (result.data && result.data.error) ? result.data.error : ('Error ' + result.status);
          if (result.data && result.data.hint) msg += '. ' + result.data.hint;
          bestVariantsCache = null;
          renderBestVariants(null, msg);
          return null;
        })
        .catch(function() { bestVariantsCache = null; renderBestVariants(null); return null; });
    }

    function renderBestVariants(data, errorMessage) {
      const tbody = document.getElementById('best-variants-body');
      if (!tbody) return;
      if (!data || !Array.isArray(data.bestVariants)) {
        tbody.innerHTML = '<div class="grid-row" role="row"><div class="grid-cell empty span-all" role="cell">' + (errorMessage ? escapeHtml(errorMessage) : 'No shop or no data') + '</div></div>';
        updateSortHeadersInContainer(document.getElementById('best-variants-table'), tableSortState.bestVariants.by, tableSortState.bestVariants.dir);
        updateCardPagination('best-variants', 1, 1);
        return;
      }
      const rows = data.bestVariants.slice();
      const bvBy = (tableSortState.bestVariants.by || 'rev').toString().trim().toLowerCase();
      const bvDir = (tableSortState.bestVariants.dir || 'desc').toString().trim().toLowerCase() === 'asc' ? 'asc' : 'desc';
      function displayVariantName(v) {
        const variantName = (v && v.variant_title && String(v.variant_title).trim()) ? String(v.variant_title).trim() : 'Default';
        const productName = (v && v.title && String(v.title).trim()) ? String(v.title).trim() : '';
        return variantName + (productName ? (' \u2014 ' + productName) : '');
      }
      rows.sort(function(a, b) {
        var primary = 0;
        if (bvBy === 'variant') primary = cmpNullableText(displayVariantName(a), displayVariantName(b), bvDir);
        else if (bvBy === 'sales') primary = cmpNullableNumber(a && a.orders, b && b.orders, bvDir);
        else if (bvBy === 'clicks') primary = cmpNullableNumber(a && a.clicks, b && b.clicks, bvDir);
        else if (bvBy === 'rev') primary = cmpNullableNumber(a && a.revenue, b && b.revenue, bvDir);
        else if (bvBy === 'cr') {
          primary = cmpNullableNumber(a && a.cr, b && b.cr, bvDir) ||
            cmpNullableNumber(a && a.orders, b && b.orders, 'desc');
        }
        return primary ||
          cmpNullableNumber(a && a.revenue, b && b.revenue, 'desc') ||
          cmpNullableNumber(a && a.orders, b && b.orders, 'desc') ||
          cmpNullableText(displayVariantName(a), displayVariantName(b), 'asc');
      });
      const pageSize = (data && typeof data.pageSize === 'number' && data.pageSize > 0) ? data.pageSize : TOP_TABLE_PAGE_SIZE;
      const totalCount = (data && typeof data.totalCount === 'number' && data.totalCount >= 0) ? data.totalCount : rows.length;
      const totalPages = Math.max(1, Math.ceil(totalCount / pageSize));
      bestVariantsPage = clampPage((data && typeof data.page === 'number') ? data.page : bestVariantsPage, totalPages);
      updateCardPagination('best-variants', bestVariantsPage, totalPages);
      if (rows.length === 0) {
        tbody.innerHTML = '<div class="grid-row" role="row"><div class="grid-cell empty span-all" role="cell">No orders in this range</div></div>';
        updateSortHeadersInContainer(document.getElementById('best-variants-table'), bvBy, bvDir);
        return;
      }
      tbody.innerHTML = rows.map(function(v) {
        const mainBase = getMainBaseUrl();
        const productUrl = (mainBase && v && v.handle) ? (mainBase + '/products/' + encodeURIComponent(String(v.handle))) : '';
        const thumbUrl = (v && v.thumb_url) ? (hotImgSquare(String(v.thumb_url)) || String(v.thumb_url)) : null;
        const ogThumb = productUrl ? ((API || '') + '/api/og-thumb?url=' + encodeURIComponent(productUrl) + '&width=100') : '';
        const thumbSrc = thumbUrl || ogThumb || '';
        const thumbImg = '<span class="thumb-wrap">' +
          '<span class="bs-thumb-placeholder" aria-hidden="true"></span>' +
          (thumbSrc ? '<img class="bs-thumb" src="' + escapeHtml(thumbSrc) + '" alt="" loading="lazy" onerror="this.remove()">' : '') +
        '</span>';
        const thumb = productUrl
          ? '<a href="' + escapeHtml(productUrl) + '" target="_blank" rel="noopener">' + thumbImg + '</a>'
          : thumbImg;

        const nameText = displayVariantName(v);
        const name = '<span class="bs-name" title="' + escapeHtml(nameText) + '">' + escapeHtml(nameText) + '</span>';

        const ordersNum = (v && typeof v.orders === 'number') ? v.orders : (v && v.orders != null ? Number(v.orders) : 0);
        const orders = formatSessions(Number(ordersNum) || 0);
        const clicks = (v && typeof v.clicks === 'number') ? formatSessions(v.clicks) : '\u2014';
        const revenue = formatRevenueTableHtml(v && v.revenue != null ? v.revenue : null);
        const crVal = (v && typeof v.cr === 'number') ? v.cr : null;
        const cr = crVal != null ? pct(crVal) : '\u2014';

        return '<div class="grid-row" role="row">' +
          '<div class="grid-cell bs-product-col" role="cell"><div class="product-cell">' + thumb + ' ' + name + '</div></div>' +
          '<div class="grid-cell" role="cell">' + orders + '</div>' +
          '<div class="grid-cell" role="cell">' + clicks + '</div>' +
          '<div class="grid-cell" role="cell">' + revenue + '</div>' +
          '<div class="grid-cell" role="cell">' + cr + '</div>' +
        '</div>';
      }).join('');
      updateSortHeadersInContainer(document.getElementById('best-variants-table'), bvBy, bvDir);
    }

    function renderBestSellers(data, errorMessage) {
      const tbody = document.getElementById('best-sellers-body');
      if (!tbody) return;
      if (!data || !Array.isArray(data.bestSellers)) {
        tbody.innerHTML = '<div class="grid-row" role="row"><div class="grid-cell empty span-all" role="cell">' + (errorMessage ? escapeHtml(errorMessage) : 'No shop or no data') + '</div></div>';
        updateBestSellersSortHeaders();
        updateCardPagination('best-sellers', 1, 1);
        return;
      }
      const rows = data.bestSellers.slice();
      const sortKey = (bestSellersSortBy || 'rev').toString().trim().toLowerCase();
      const sortDir = (bestSellersSortDir || 'desc').toString().trim().toLowerCase() === 'asc' ? 'asc' : 'desc';
      rows.sort(function(a, b) {
        if (sortKey === 'title') return cmpNullableText(a && a.title, b && b.title, sortDir);
        if (sortKey === 'orders') return cmpNullableNumber(a && a.orders, b && b.orders, sortDir);
        if (sortKey === 'clicks') return cmpNullableNumber(a && a.clicks, b && b.clicks, sortDir);
        if (sortKey === 'rev') return cmpNullableNumber(a && a.revenue, b && b.revenue, sortDir);
        if (sortKey === 'cr') {
          return cmpNullableNumber(a && a.cr, b && b.cr, sortDir) ||
            cmpNullableNumber(a && a.orders, b && b.orders, 'desc');
        }
        return 0;
      });
      const pageSize = (data && typeof data.pageSize === 'number' && data.pageSize > 0) ? data.pageSize : TOP_TABLE_PAGE_SIZE;
      const totalCount = (data && typeof data.totalCount === 'number' && data.totalCount >= 0) ? data.totalCount : rows.length;
      const totalPages = Math.max(1, Math.ceil(totalCount / pageSize));
      bestSellersPage = clampPage((data && typeof data.page === 'number') ? data.page : bestSellersPage, totalPages);
      updateCardPagination('best-sellers', bestSellersPage, totalPages);
      if (rows.length === 0) {
        tbody.innerHTML = '<div class="grid-row" role="row"><div class="grid-cell empty span-all" role="cell">No orders in this range</div></div>';
        updateBestSellersSortHeaders();
        return;
      }
      tbody.innerHTML = rows.map(function(p) {
        const mainBase = getMainBaseUrl();
        const productUrl = (mainBase && p.handle) ? (mainBase + '/products/' + encodeURIComponent(String(p.handle))) : '';
        const thumbUrl = p.thumb_url ? (hotImgSquare(String(p.thumb_url)) || String(p.thumb_url)) : null;
        const ogThumb = productUrl ? ((API || '') + '/api/og-thumb?url=' + encodeURIComponent(productUrl) + '&width=100') : '';
        const thumbSrc = thumbUrl || ogThumb || '';
        const thumbImg = '<span class="thumb-wrap">' +
          '<span class="bs-thumb-placeholder" aria-hidden="true"></span>' +
          (thumbSrc ? '<img class="bs-thumb" src="' + escapeHtml(thumbSrc) + '" alt="" loading="lazy" onerror="this.remove()">' : '') +
        '</span>';
        const thumb = productUrl ? '<a href="' + productUrl + '" target="_blank" rel="noopener">' + thumbImg + '</a>' : thumbImg;
        const name = '<span class="bs-name" title="' + escapeHtml(p.title) + '">' + escapeHtml(p.title) + '</span>';
        const orders = String(p.orders != null ? p.orders : 0);
        const clicks = (typeof p.clicks === 'number') ? formatSessions(p.clicks) : '\u2014';
        const revenue = formatRevenueTableHtml(p.revenue);
        const cr = p.cr != null ? pct(p.cr) : '\u2014';
        return '<div class="grid-row" role="row">' +
          '<div class="grid-cell bs-product-col" role="cell"><div class="product-cell">' + thumb + ' ' + name + '</div></div>' +
          '<div class="grid-cell" role="cell">' + orders + '</div>' +
          '<div class="grid-cell" role="cell">' + clicks + '</div>' +
          '<div class="grid-cell" role="cell">' + revenue + '</div>' +
          '<div class="grid-cell" role="cell">' + cr + '</div>' +
        '</div>';
      }).join('');
      updateBestSellersSortHeaders();
    }

    function updateBestSellersSortHeaders() {
      document.querySelectorAll('#best-sellers-wrap .grid-cell.sortable').forEach(function(th) {
        var col = th.getAttribute('data-sort');
        th.classList.remove('th-sort-asc', 'th-sort-desc');
        th.setAttribute('aria-sort', bestSellersSortBy === col ? (bestSellersSortDir === 'asc' ? 'ascending' : 'descending') : 'none');
        if (bestSellersSortBy === col) th.classList.add(bestSellersSortDir === 'asc' ? 'th-sort-asc' : 'th-sort-desc');
      });
    }

    function setupBestSellersSort() {
      document.querySelectorAll('#best-sellers-wrap .grid-cell.sortable').forEach(function(th) {
        function activate() {
          var col = (th.getAttribute('data-sort') || '').trim();
          if (!col) return;
          if (bestSellersSortBy === col) bestSellersSortDir = bestSellersSortDir === 'asc' ? 'desc' : 'asc';
          else { bestSellersSortBy = col; bestSellersSortDir = col === 'title' ? 'asc' : 'desc'; }
          bestSellersPage = 1;
          updateBestSellersSortHeaders();
          fetchBestSellers();
        }
        th.addEventListener('click', function(e) {
          if (e && typeof e.preventDefault === 'function') e.preventDefault();
          activate();
        });
        th.addEventListener('keydown', function(e) {
          if (!e || (e.key !== 'Enter' && e.key !== ' ')) return;
          e.preventDefault();
          activate();
        });
      });
    }

    function asSortText(v) {
      if (v == null) return '';
      return String(v).trim().toLowerCase();
    }

    function asFiniteNumber(v) {
      const n = (typeof v === 'number') ? v : Number(v);
      return Number.isFinite(n) ? n : null;
    }

    function cmpNullableText(a, b, dir) {
      const da = asSortText(a);
      const db = asSortText(b);
      const d = dir === 'asc' ? 'asc' : 'desc';
      if (!da && !db) return 0;
      if (!da) return 1;
      if (!db) return -1;
      if (da === db) return 0;
      if (d === 'asc') return da < db ? -1 : 1;
      return da < db ? 1 : -1;
    }

    function cmpNullableNumber(a, b, dir) {
      const na = asFiniteNumber(a);
      const nb = asFiniteNumber(b);
      const d = dir === 'asc' ? 'asc' : 'desc';
      if (na == null && nb == null) return 0;
      if (na == null) return 1;
      if (nb == null) return -1;
      if (na === nb) return 0;
      return d === 'asc' ? (na - nb) : (nb - na);
    }

    function updateSortHeadersInContainer(container, sortBy, sortDir) {
      const root = typeof container === 'string' ? document.querySelector(container) : container;
      if (!root) return;
      root.querySelectorAll('.grid-cell.sortable').forEach(function(th) {
        var col = (th.getAttribute('data-sort') || '').trim();
        th.classList.remove('th-sort-asc', 'th-sort-desc');
        th.setAttribute('aria-sort', sortBy === col ? (sortDir === 'asc' ? 'ascending' : 'descending') : 'none');
        if (sortBy === col) th.classList.add(sortDir === 'asc' ? 'th-sort-asc' : 'th-sort-desc');
      });
    }

    function setupTableSortHeaders(container, state, defaults, onChange) {
      const root = typeof container === 'string' ? document.querySelector(container) : container;
      if (!root || !state) return;
      root.querySelectorAll('.grid-cell.sortable').forEach(function(th) {
        function activate() {
          var col = (th.getAttribute('data-sort') || '').trim();
          if (!col) return;
          var prevCol = state.by;
          if (state.by === col) state.dir = state.dir === 'asc' ? 'desc' : 'asc';
          else { state.by = col; state.dir = (defaults && defaults[col]) ? defaults[col] : 'asc'; }
          state.dir = state.dir === 'asc' ? 'asc' : 'desc';
          updateSortHeadersInContainer(root, state.by, state.dir);
          if (typeof onChange === 'function') onChange({ by: state.by, dir: state.dir, columnChanged: prevCol !== state.by });
        }
        th.addEventListener('click', function(e) {
          if (e && typeof e.preventDefault === 'function') e.preventDefault();
          activate();
        });
        th.addEventListener('keydown', function(e) {
          if (!e || (e.key !== 'Enter' && e.key !== ' ')) return;
          e.preventDefault();
          activate();
        });
      });
      state.dir = state.dir === 'asc' ? 'asc' : 'desc';
      updateSortHeadersInContainer(root, state.by, state.dir);
    }

    function setupAllTableSorts() {
      setupTableSortHeaders(document.getElementById('country-table'), tableSortState.country, TABLE_SORT_DEFAULTS.country, function(info) {
        if (info && info.columnChanged) countryPage = 1;
        renderCountry(statsCache);
      });
      setupTableSortHeaders(document.getElementById('best-geo-products-table'), tableSortState.bestGeoProducts, TABLE_SORT_DEFAULTS.bestGeoProducts, function(info) {
        if (info && info.columnChanged) bestGeoProductsPage = 1;
        renderBestGeoProducts(statsCache);
      });
      setupTableSortHeaders(document.getElementById('best-variants-table'), tableSortState.bestVariants, TABLE_SORT_DEFAULTS.bestVariants, function(info) {
        if (info && info.columnChanged) {
          bestVariantsPage = 1;
          fetchBestVariants();
          return;
        }
        if (bestVariantsCache) renderBestVariants(bestVariantsCache);
        else fetchBestVariants();
      });
      setupTableSortHeaders(document.getElementById('traffic-sources-table'), tableSortState.trafficSources, TABLE_SORT_DEFAULTS.trafficSources, function() {
        renderTrafficTables(trafficCache || {});
      });
      setupTableSortHeaders(document.getElementById('traffic-types-table'), tableSortState.trafficTypes, TABLE_SORT_DEFAULTS.trafficTypes, function() {
        renderTrafficTables(trafficCache || {});
      });
    }

    function formatSessions(n) {
      if (n == null || typeof n !== 'number') return '—';
      return n.toLocaleString();
    }

    function clampPage(p, totalPages) {
      const n = typeof p === 'number' ? p : parseInt(String(p), 10);
      if (!Number.isFinite(n)) return 1;
      return Math.min(Math.max(1, n), Math.max(1, totalPages || 1));
    }

    function updateCardPagination(prefix, page, totalPages) {
      const wrap = document.getElementById(prefix + '-pagination');
      const prev = document.getElementById(prefix + '-prev');
      const next = document.getElementById(prefix + '-next');
      const label = document.getElementById(prefix + '-label');
      if (!wrap || !prev || !next || !label) return;
      const pages = Math.max(1, totalPages || 1);
      const show = pages > 1;
      wrap.dataset.paginated = show ? '1' : '0';
      wrap.dataset.pages = String(pages);
      wrap.dataset.page = String(page);
      wrap.classList.toggle('is-hidden', !show);
      prev.disabled = page <= 1;
      next.disabled = page >= pages;
      label.textContent = page + ' of ' + pages;
    }

    function scheduleBreakdownSync() {
      // No-op: layout is handled via CSS grid/flex.
    }

    function renderSales(data) {
      const sales = data.sales || {};
      const salesTodayEl = document.getElementById('sales-today');
      const range = getStatsRange();
      const baseSales = (sales[range] != null ? sales[range] : 0);
      if (salesTodayEl) salesTodayEl.textContent = formatRevenue(baseSales);
      const salesYesterdayEl = document.getElementById('sales-yesterday');
      if (salesYesterdayEl) salesYesterdayEl.textContent = formatRevenue(sales.yesterday);
    }

    function renderConversion(data) {
      const c = data.conversion || {};
      const range = getStatsRange();
      document.getElementById('conversion-range').textContent = pct(c[range]);
      const productCr = (data.productConversion || {})[range];
      const productCrEl = document.getElementById('conversion-product-cr');
      if (productCrEl) productCrEl.textContent = productCr != null ? pct(productCr) : '\u2014';
    }

    function renderSessions(data) {
      const breakdown = data && data.trafficBreakdown ? data.trafficBreakdown : {};
      const forRange = breakdown[getStatsRange()];
      const forYesterday = breakdown.yesterday;
      const main = forRange != null ? forRange.human_sessions : null;
      const yesterday = forYesterday != null ? forYesterday.human_sessions : null;
      const sessionsRangeEl = document.getElementById('sessions-range');
      const sessionsYesterdayEl = document.getElementById('sessions-yesterday');
      if (sessionsRangeEl) sessionsRangeEl.textContent = formatSessions(main);
      if (sessionsYesterdayEl) sessionsYesterdayEl.textContent = formatSessions(yesterday);
    }

    var breakdownAovPage = 1;
    function renderAov(data) {
      const rows = (data.country || {})[getStatsRange()] || [];
      const tbody = document.getElementById('breakdown-aov-body');
      if (!tbody) return;
      const filtered = rows.filter(r => (r && (r.revenue != null || r.aov != null || r.conversion != null)));
      if (filtered.length === 0) {
        tbody.innerHTML = '<div class="grid-row" role="row"><div class="grid-cell empty span-all" role="cell">No data</div></div>';
        updateCardPagination('breakdown-aov', 1, 1);
        return;
      }
      const list = filtered.slice();
      list.sort(function(a, b) {
        return cmpNullableNumber(a && a.revenue, b && b.revenue, 'desc') ||
          cmpNullableNumber(a && a.aov, b && b.aov, 'desc') ||
          cmpNullableNumber(a && a.conversion, b && b.conversion, 'desc');
      });
      var totalPages = Math.max(1, Math.ceil(list.length / TOP_TABLE_PAGE_SIZE));
      breakdownAovPage = clampPage(breakdownAovPage, totalPages);
      updateCardPagination('breakdown-aov', breakdownAovPage, totalPages);
      var start = (breakdownAovPage - 1) * TOP_TABLE_PAGE_SIZE;
      var pageRows = list.slice(start, start + TOP_TABLE_PAGE_SIZE);
      tbody.innerHTML = pageRows.map(r => {
        const iso = (r.country_code || 'XX').toUpperCase().slice(0, 2);
        const label = countryLabelFull(iso);
        const flag = flagImg(iso, label);
        const revenue = r && r.revenue != null ? formatRevenueTableHtml(r.revenue) : '—';
        const aov = r && r.aov != null ? formatRevenueTableHtml(r.aov) : '—';
        const cr = r && r.conversion != null ? pct(r.conversion) : '—';
        return '<div class="grid-row" role="row">' +
          '<div class="grid-cell" role="cell"><span class="country-cell">' + flag + '<span class="country-label"><span class="country-name">' + escapeHtml(label) + '</span></span></span></div>' +
          '<div class="grid-cell" role="cell">' + revenue + '</div>' +
          '<div class="grid-cell" role="cell">' + aov + '</div>' +
          '<div class="grid-cell" role="cell">' + cr + '</div>' +
        '</div>';
      }).join('');
    }

    function renderFinishes(data) {
      const grid = document.getElementById('finishes-cards-grid');
      if (!grid) return;
      const rows = (data && Array.isArray(data.finishes)) ? data.finishes : [];
      if (rows.length === 0) {
        const msg = finishesLoading ? 'Loading finishes…' : 'No data';
        grid.innerHTML = '<div class="aov-card aov-card-empty">' + escapeHtml(msg) + '</div>';
        return;
      }
      function iconFor(key) {
        const k = (key || '').toString().trim().toLowerCase();
        if (k === 'gold') return '<span class="finish-icon finish-icon-gold" aria-hidden="true"></span>';
        if (k === 'silver') return '<span class="finish-icon finish-icon-silver" aria-hidden="true"></span>';
        if (k === 'vermeil') return '<span class="finish-icon finish-icon-vermeil" aria-hidden="true"></span>';
        if (k === 'solid_silver' || k === 'solid-silver') return '<span class="finish-icon finish-icon-solid-silver" aria-hidden="true"></span>';
        return '<span class="finish-icon" aria-hidden="true"></span>';
      }
      const ordered = rows.slice();
      const orderIndex = { gold: 0, silver: 1, vermeil: 2, solid_silver: 3, 'solid-silver': 3 };
      ordered.sort(function(a, b) {
        const primary = cmpNullableNumber(a && a.revenueGbp, b && b.revenueGbp, 'desc');
        if (primary) return primary;
        const ak = a && a.key != null ? String(a.key) : '';
        const bk = b && b.key != null ? String(b.key) : '';
        const ai = Object.prototype.hasOwnProperty.call(orderIndex, ak) ? orderIndex[ak] : 99;
        const bi = Object.prototype.hasOwnProperty.call(orderIndex, bk) ? orderIndex[bk] : 99;
        return ai - bi;
      });
      grid.innerHTML = ordered.map(function(r) {
        const label = (r && r.label != null) ? String(r.label) : '';
        const revenue = (r && r.revenueGbp != null) ? Number(r.revenueGbp) : null;
        const value = (revenue != null && Number.isFinite(revenue)) ? formatRevenueTableHtml(revenue) : '—';
        const cr = crPillHtml(r && r.cr);
        return '<div class="aov-card">' +
          '<div class="aov-card-left">' + iconFor(r && r.key) + '<span class="aov-card-name">' + escapeHtml(label || '—') + '</span></div>' +
          '<div class="aov-card-value"><span class="aov-card-value-main">' + value + '</span>' + cr + '</div>' +
        '</div>';
      }).join('');
    }

    function renderLengths(data) {
      const grid = document.getElementById('finishes-cards-grid');
      if (!grid) return;
      const rows = (data && Array.isArray(data.lengths)) ? data.lengths : [];
      if (rows.length === 0) {
        const msg = lengthsLoading ? 'Loading lengths…' : 'No data';
        grid.innerHTML = '<div class="aov-card aov-card-empty">' + escapeHtml(msg) + '</div>';
        return;
      }
      const ordered = rows.slice();
      ordered.sort(function(a, b) {
        return cmpNullableNumber(a && a.revenueGbp, b && b.revenueGbp, 'desc') ||
          cmpNullableNumber(a && a.inches, b && b.inches, 'asc');
      });
      grid.innerHTML = ordered.map(function(r) {
        const inches = (r && r.inches != null) ? Number(r.inches) : null;
        const label = (r && r.label != null) ? String(r.label) : (inches != null && Number.isFinite(inches) ? (String(inches) + '"') : '');
        const revenue = (r && r.revenueGbp != null) ? Number(r.revenueGbp) : null;
        const value = (revenue != null && Number.isFinite(revenue)) ? formatRevenueTableHtml(revenue) : '—';
        const cr = crPillHtml(r && r.cr);
        const icon = '<span class="length-icon" aria-hidden="true"><span class="length-icon-text">' + escapeHtml(label || '—') + '</span></span>';
        const sr = '<span class="aov-card-name sr-only">' + escapeHtml((label || '—') + ' Inches') + '</span>';
        return '<div class="aov-card aov-card--length">' +
          '<div class="aov-card-left">' + icon + sr + '</div>' +
          '<div class="aov-card-value"><span class="aov-card-value-main">' + value + '</span>' + cr + '</div>' +
        '</div>';
      }).join('');
    }

    var breakdownTitlePage = 1;
    function renderBreakdownTitles(data) {
      const tbody = document.getElementById('breakdown-title-body');
      if (!tbody) return;
      const hasData = !!(data && data.ok);
      const list = hasData ? (data.byTitle || []) : [];
      if (!list.length) {
        tbody.innerHTML = '<div class="grid-row" role="row"><div class="grid-cell empty span-all" role="cell">' + (leaderboardLoading ? 'Loading\u2026' : 'No data') + '</div></div>';
        updateCardPagination('breakdown-title', 1, 1);
        return;
      }
      var totalPages = Math.max(1, Math.ceil(list.length / TOP_TABLE_PAGE_SIZE));
      breakdownTitlePage = clampPage(breakdownTitlePage, totalPages);
      updateCardPagination('breakdown-title', breakdownTitlePage, totalPages);
      var start = (breakdownTitlePage - 1) * TOP_TABLE_PAGE_SIZE;
      var pageRows = list.slice(start, start + TOP_TABLE_PAGE_SIZE);
      const mainBase = getMainBaseUrl();
      tbody.innerHTML = pageRows.map(function(row) {
        const title = row && row.title != null ? String(row.title) : 'Product';
        const handle = row && row.handle ? String(row.handle) : '';
        const thumb = row && row.thumb_url ? String(row.thumb_url) : '';
        const rev = row && row.revenueGbp != null ? Number(row.revenueGbp) : 0;
        const value = formatMoneyCompact(Number.isFinite(rev) ? rev : 0, 'GBP') || '\u00A30';
        const cr = row && row.cr != null ? pct(row.cr) : '\u2014';
        const productUrl = (mainBase && handle) ? (mainBase + '/products/' + encodeURIComponent(handle)) : '';
        const placeholderSvg = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><rect x="3" y="5" width="18" height="14" rx="2"></rect><path d="M8 12l2.5 2.5L16 9"></path></svg>';
        const imgInner = '<span class="breakdown-thumb-wrap">' +
          placeholderSvg +
          (thumb
            ? '<img class="breakdown-thumb" src="' + escapeHtml(hotImgSquare(thumb) || thumb) + '" alt="" loading="lazy" onerror="this.remove()">'
            : '') +
          '</span>';
        const img = productUrl
          ? '<a href="' + escapeHtml(productUrl) + '" target="_blank" rel="noopener" aria-label="Open product: ' + escapeHtml(title || 'Product') + '">' + imgInner + '</a>'
          : imgInner;
        return '<div class="grid-row" role="row">' +
          '<div class="grid-cell" role="cell"><span class="breakdown-cell">' + img + '<span class="breakdown-label"><span class="breakdown-product-name">' + escapeHtml(title) + '</span><span class="sr-only">' + escapeHtml(title) + '</span></span></span></div>' +
          '<div class="grid-cell" role="cell">' + escapeHtml(value) + '</div>' +
          '<div class="grid-cell" role="cell">' + cr + '</div>' +
        '</div>';
      }).join('');
    }

    function renderBreakdownTypes(data) {
      const tbody = document.getElementById('breakdown-type-body');
      if (!tbody) return;
      const hasData = !!(data && data.ok);
      const list = hasData ? (data.byType || []) : [];
      if (!list.length) {
        tbody.innerHTML = '<div class="grid-row" role="row"><div class="grid-cell empty span-all" role="cell">' + (leaderboardLoading ? 'Loading\u2026' : 'No data') + '</div></div>';
        return;
      }
      const iconSvg = '<span class="breakdown-icon" aria-hidden="true"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M20 12V7a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h7"></path><path d="M16 19l2 2 4-4"></path></svg></span>';
      tbody.innerHTML = list.map(function(row) {
        const label = row && (row.label || row.key) ? String(row.label || row.key) : 'Unknown';
        const rev = row && row.revenueGbp != null ? Number(row.revenueGbp) : 0;
        const value = formatMoneyCompact(Number.isFinite(rev) ? rev : 0, 'GBP') || '\u00A30';
        const cr = row && row.cr != null ? pct(row.cr) : '\u2014';
        return '<div class="grid-row" role="row">' +
          '<div class="grid-cell" role="cell"><span class="breakdown-cell">' + iconSvg + '<span class="breakdown-label">' + escapeHtml(label) + '</span></span></div>' +
          '<div class="grid-cell" role="cell">' + escapeHtml(value) + '</div>' +
          '<div class="grid-cell" role="cell">' + cr + '</div>' +
        '</div>';
      }).join('');
    }

    var breakdownFinishPage = 1;
    function renderBreakdownFinishes(data) {
      const tbody = document.getElementById('breakdown-finish-body');
      if (!tbody) return;
      const rows = (data && Array.isArray(data.finishes)) ? data.finishes : [];
      if (!rows.length) {
        tbody.innerHTML = '<div class="grid-row" role="row"><div class="grid-cell empty span-all" role="cell">' + (finishesLoading ? 'Loading\u2026' : 'No data') + '</div></div>';
        updateCardPagination('breakdown-finish', 1, 1);
        return;
      }
      function iconFor(key) {
        const k = (key || '').toString().trim().toLowerCase();
        if (k === 'gold') return '<span class="finish-icon finish-icon-gold" aria-hidden="true"></span>';
        if (k === 'silver') return '<span class="finish-icon finish-icon-silver" aria-hidden="true"></span>';
        if (k === 'vermeil') return '<span class="finish-icon finish-icon-vermeil" aria-hidden="true"></span>';
        if (k === 'solid_silver' || k === 'solid-silver') return '<span class="finish-icon finish-icon-solid-silver" aria-hidden="true"></span>';
        return '<span class="breakdown-icon" aria-hidden="true"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2l1.8 5.5H19l-4.4 3.2L16.4 16 12 12.8 7.6 16l1.8-5.3L5 7.5h5.2z"></path></svg></span>';
      }
      var ordered = rows.slice();
      ordered.sort(function(a, b) { return cmpNullableNumber(a && a.revenueGbp, b && b.revenueGbp, 'desc'); });
      var totalPages = Math.max(1, Math.ceil(ordered.length / BREAKDOWN_PAGE_SIZE));
      breakdownFinishPage = clampPage(breakdownFinishPage, totalPages);
      updateCardPagination('breakdown-finish', breakdownFinishPage, totalPages);
      var start = (breakdownFinishPage - 1) * BREAKDOWN_PAGE_SIZE;
      var pageRows = ordered.slice(start, start + BREAKDOWN_PAGE_SIZE);
      tbody.innerHTML = pageRows.map(function(r) {
        const label = (r && r.label != null) ? String(r.label) : '\u2014';
        const revenue = (r && r.revenueGbp != null) ? Number(r.revenueGbp) : null;
        const value = (revenue != null && Number.isFinite(revenue)) ? formatRevenueTableHtml(revenue) : '\u2014';
        const cr = r && r.cr != null ? pct(r.cr) : '\u2014';
        return '<div class="grid-row" role="row">' +
          '<div class="grid-cell" role="cell"><span class="breakdown-cell">' + iconFor(r && r.key) + '<span class="breakdown-label">' + escapeHtml(label) + '</span></span></div>' +
          '<div class="grid-cell" role="cell">' + value + '</div>' +
          '<div class="grid-cell" role="cell">' + cr + '</div>' +
        '</div>';
      }).join('');
    }

    var breakdownLengthPage = 1;
    function renderBreakdownLengths(data) {
      const tbody = document.getElementById('breakdown-length-body');
      if (!tbody) return;
      const rows = (data && Array.isArray(data.lengths)) ? data.lengths : [];
      if (!rows.length) {
        tbody.innerHTML = '<div class="grid-row" role="row"><div class="grid-cell empty span-all" role="cell">' + (lengthsLoading ? 'Loading\u2026' : 'No data') + '</div></div>';
        updateCardPagination('breakdown-length', 1, 1);
        return;
      }
      var ordered = rows.slice();
      ordered.sort(function(a, b) {
        return cmpNullableNumber(a && a.revenueGbp, b && b.revenueGbp, 'desc') ||
          cmpNullableNumber(a && a.inches, b && b.inches, 'asc');
      });
      var totalPages = Math.max(1, Math.ceil(ordered.length / BREAKDOWN_PAGE_SIZE));
      breakdownLengthPage = clampPage(breakdownLengthPage, totalPages);
      updateCardPagination('breakdown-length', breakdownLengthPage, totalPages);
      var start = (breakdownLengthPage - 1) * BREAKDOWN_PAGE_SIZE;
      var pageRows = ordered.slice(start, start + BREAKDOWN_PAGE_SIZE);
      const iconSvg = '<span class="breakdown-icon" aria-hidden="true"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M4 7h16"></path><path d="M6 7v10"></path><path d="M10 7v6"></path><path d="M14 7v6"></path><path d="M18 7v10"></path></svg></span>';
      tbody.innerHTML = pageRows.map(function(r) {
        const inches = (r && r.inches != null) ? Number(r.inches) : null;
        const label = (r && r.label != null) ? String(r.label) : (inches != null && Number.isFinite(inches) ? (String(inches) + '"') : '\u2014');
        const revenue = (r && r.revenueGbp != null) ? Number(r.revenueGbp) : null;
        const value = (revenue != null && Number.isFinite(revenue)) ? formatRevenueTableHtml(revenue) : '\u2014';
        const cr = r && r.cr != null ? pct(r.cr) : '\u2014';
        return '<div class="grid-row" role="row">' +
          '<div class="grid-cell" role="cell"><span class="breakdown-cell">' + iconSvg + '<span class="breakdown-label">' + escapeHtml(label) + '</span></span></div>' +
          '<div class="grid-cell" role="cell">' + value + '</div>' +
          '<div class="grid-cell" role="cell">' + cr + '</div>' +
        '</div>';
      }).join('');
    }

    var breakdownChainStylePage = 1;
    function renderBreakdownChainStyles(data) {
      const tbody = document.getElementById('breakdown-chainstyle-body');
      if (!tbody) return;
      const rows = (data && Array.isArray(data.chainStyles)) ? data.chainStyles : [];
      if (!rows.length) {
        tbody.innerHTML = '<div class="grid-row" role="row"><div class="grid-cell empty span-all" role="cell">' + (chainStylesLoading ? 'Loading\u2026' : 'No data') + '</div></div>';
        updateCardPagination('breakdown-chainstyle', 1, 1);
        return;
      }
      var ordered = rows.slice();
      ordered.sort(function(a, b) { return cmpNullableNumber(a && a.revenueGbp, b && b.revenueGbp, 'desc'); });
      var totalPages = Math.max(1, Math.ceil(ordered.length / BREAKDOWN_PAGE_SIZE));
      breakdownChainStylePage = clampPage(breakdownChainStylePage, totalPages);
      updateCardPagination('breakdown-chainstyle', breakdownChainStylePage, totalPages);
      var start = (breakdownChainStylePage - 1) * BREAKDOWN_PAGE_SIZE;
      var pageRows = ordered.slice(start, start + BREAKDOWN_PAGE_SIZE);
      const iconSvg = '<span class="breakdown-icon" aria-hidden="true"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></span>';
      tbody.innerHTML = pageRows.map(function(r) {
        const label = (r && r.label != null) ? String(r.label) : '\u2014';
        const revenue = (r && r.revenueGbp != null) ? Number(r.revenueGbp) : null;
        const value = (revenue != null && Number.isFinite(revenue)) ? formatRevenueTableHtml(revenue) : '\u2014';
        const cr = r && r.cr != null ? pct(r.cr) : '\u2014';
        return '<div class="grid-row" role="row">' +
          '<div class="grid-cell" role="cell"><span class="breakdown-cell">' + iconSvg + '<span class="breakdown-label">' + escapeHtml(label) + '</span></span></div>' +
          '<div class="grid-cell" role="cell">' + value + '</div>' +
          '<div class="grid-cell" role="cell">' + cr + '</div>' +
        '</div>';
      }).join('');
    }

    function renderCountry(data) {
      const c = data.country || {};
      const rows = c[getStatsRange()] || [];
      const tbody = document.getElementById('by-country-body');
      if (!tbody) return;
      if (rows.length === 0) {
        tbody.innerHTML = '<div class="grid-row" role="row"><div class="grid-cell empty span-all" role="cell">No data</div></div>';
        updateSortHeadersInContainer(document.getElementById('country-table'), tableSortState.country.by, tableSortState.country.dir);
        updateCardPagination('country', 1, 1);
        return;
      }
      const list = rows.slice();
      const countryBy = (tableSortState.country.by || 'rev').toString().trim().toLowerCase();
      const countryDir = (tableSortState.country.dir || 'desc').toString().trim().toLowerCase() === 'asc' ? 'asc' : 'desc';
      function labelFor(r) {
        const code = (r && r.country_code != null ? String(r.country_code) : 'XX').toUpperCase().slice(0, 2);
        return countryLabel(code);
      }
      list.sort(function(a, b) {
        if (countryBy === 'country') return cmpNullableText(labelFor(a), labelFor(b), countryDir);
        if (countryBy === 'cr') return cmpNullableNumber(a && a.conversion, b && b.conversion, countryDir) || cmpNullableText(labelFor(a), labelFor(b), 'asc');
        if (countryBy === 'sales') return cmpNullableNumber(a && a.converted, b && b.converted, countryDir) || cmpNullableText(labelFor(a), labelFor(b), 'asc');
        if (countryBy === 'clicks') return cmpNullableNumber(a && a.total, b && b.total, countryDir) || cmpNullableText(labelFor(a), labelFor(b), 'asc');
        if (countryBy === 'rev') return cmpNullableNumber(a && a.revenue, b && b.revenue, countryDir) || cmpNullableText(labelFor(a), labelFor(b), 'asc');
        return 0;
      });

      lastCountryRowCount = list.length;
      updateCardPagination('country', 1, 1);
      tbody.innerHTML = list.map(r => {
        const code = (r.country_code || 'XX').toUpperCase().slice(0, 2);
        const label = countryLabel(code);
        const conversion = pct(r.conversion);
        const salesCount = r.converted != null ? Number(r.converted) : 0;
        const clicks = r.total != null ? formatSessions(r.total) : '—';
        const revenue = formatRevenueTableHtml(r.revenue);
        const flag = flagImg(code, label);
        const labelHtml = '<span class="country-label"><span class="country-name">' + escapeHtml(label) + '</span><span class="country-code">' + escapeHtml(code) + '</span></span>';
        return '<div class="grid-row" role="row">' +
          '<div class="grid-cell" role="cell"><span class="country-cell">' + flag + labelHtml + '</span></div>' +
          '<div class="grid-cell" role="cell">' + conversion + '</div>' +
          '<div class="grid-cell" role="cell">' + salesCount + '</div>' +
          '<div class="grid-cell" role="cell">' + clicks + '</div>' +
          '<div class="grid-cell" role="cell">' + revenue + '</div>' +
        '</div>';
      }).join('');
      updateSortHeadersInContainer(document.getElementById('country-table'), countryBy, countryDir);
      scheduleBreakdownSync();
    }

    function renderBestGeoProducts(data) {
      const map = data && data.bestGeoProducts ? data.bestGeoProducts : {};
      const rows = map[getStatsRange()] || [];
      const tbody = document.getElementById('best-geo-products-body');
      if (!tbody) return;
      if (!Array.isArray(rows) || rows.length === 0) {
        tbody.innerHTML = '<div class="grid-row" role="row"><div class="grid-cell empty span-all" role="cell">No data</div></div>';
        updateSortHeadersInContainer(document.getElementById('best-geo-products-table'), tableSortState.bestGeoProducts.by, tableSortState.bestGeoProducts.dir);
        updateCardPagination('best-geo-products', 1, 1);
        return;
      }
      const list = rows.slice();
      const geoBy = (tableSortState.bestGeoProducts.by || 'rev').toString().trim().toLowerCase();
      const geoDir = (tableSortState.bestGeoProducts.dir || 'desc').toString().trim().toLowerCase() === 'asc' ? 'asc' : 'desc';
      function geoCountryLabel(r) {
        const iso = (r && r.country_code != null ? String(r.country_code) : 'XX').toUpperCase().slice(0, 2);
        return countryLabel(iso);
      }
      function geoProductTitle(r) {
        return (r && r.product_title != null) ? String(r.product_title).trim() : '';
      }
      list.sort(function(a, b) {
        if (geoBy === 'country') {
          return cmpNullableText(geoCountryLabel(a), geoCountryLabel(b), geoDir) ||
            cmpNullableText(geoProductTitle(a), geoProductTitle(b), 'asc');
        }
        if (geoBy === 'cr') return cmpNullableNumber(a && a.conversion, b && b.conversion, geoDir) || cmpNullableNumber(a && a.total, b && b.total, 'desc');
        if (geoBy === 'sales') return cmpNullableNumber(a && a.converted, b && b.converted, geoDir) || cmpNullableNumber(a && a.revenue, b && b.revenue, 'desc');
        if (geoBy === 'clicks') return cmpNullableNumber(a && a.total, b && b.total, geoDir) || cmpNullableNumber(a && a.converted, b && b.converted, 'desc');
        if (geoBy === 'rev') return cmpNullableNumber(a && a.revenue, b && b.revenue, geoDir) || cmpNullableNumber(a && a.converted, b && b.converted, 'desc');
        return 0;
      });

      const geoPageSize = Math.max(1, (lastCountryRowCount || COUNTRY_PAGE_SIZE) - 1);
      const totalPages = Math.max(1, Math.ceil(list.length / geoPageSize));
      bestGeoProductsPage = clampPage(bestGeoProductsPage, totalPages);
      updateCardPagination('best-geo-products', bestGeoProductsPage, totalPages);
      const start = (bestGeoProductsPage - 1) * geoPageSize;
      const pageRows = list.slice(start, start + geoPageSize);
      tbody.innerHTML = pageRows.map(r => {
        const iso = (r.country_code || 'XX').toUpperCase().slice(0, 2);
        const label = countryLabel(iso);
        const productTitle = (r.product_title && String(r.product_title).trim()) ? String(r.product_title).trim() : '—';
        const productHandle = (r && r.product_handle != null) ? String(r.product_handle).trim() : '';
        const productThumb = (r && r.product_thumb_url != null) ? String(r.product_thumb_url).trim() : '';
        const mainBase = getMainBaseUrl();
        const productUrl = (mainBase && productHandle) ? (mainBase + '/products/' + encodeURIComponent(productHandle)) : '';
        const conversion = pct(r.conversion);
        const salesCount = r.converted != null ? Number(r.converted) : 0;
        const clicks = r.total != null ? formatSessions(r.total) : '—';
        const revenue = formatRevenueTableHtml(r.revenue);
        const flag = flagImg(iso, label);
        const thumbImg = productThumb
          ? '<img src="' + escapeHtml(productThumb) + '" alt="' + escapeHtml(productTitle) + '" loading="lazy">'
          : '<span class="geo-product-thumb-placeholder" aria-hidden="true"></span>';
        const thumb = productUrl
          ? '<a class="geo-product-thumb" href="' + escapeHtml(productUrl) + '" target="_blank" rel="noopener" title="' + escapeHtml(productTitle) + '">' + thumbImg + '</a>'
          : '<span class="geo-product-thumb" title="' + escapeHtml(productTitle) + '">' + thumbImg + '</span>';
        const labelHtml = '<span class="country-label">' + thumb + '</span>';
        return '<div class="grid-row" role="row">' +
          '<div class="grid-cell" role="cell"><span class="country-cell">' + flag + labelHtml + '</span></div>' +
          '<div class="grid-cell" role="cell">' + conversion + '</div>' +
          '<div class="grid-cell" role="cell">' + salesCount + '</div>' +
          '<div class="grid-cell" role="cell">' + clicks + '</div>' +
          '<div class="grid-cell" role="cell">' + revenue + '</div>' +
        '</div>';
      }).join('');
      updateSortHeadersInContainer(document.getElementById('best-geo-products-table'), geoBy, geoDir);
      scheduleBreakdownSync();
    }

    function isCustomDayRangeKey(v) {
      return typeof v === 'string' && /^d:\d{4}-\d{2}-\d{2}$/.test(v);
    }

    function isCustomRangeKey(v) {
      return typeof v === 'string' && /^r:\d{4}-\d{2}-\d{2}:\d{4}-\d{2}-\d{2}$/.test(v);
    }

    function ymdFromDayKey(dayKey) {
      if (!isCustomDayRangeKey(dayKey)) return null;
      return dayKey.slice(2);
    }

    function ymdRangeFromRangeKey(rangeKey) {
      if (!isCustomRangeKey(rangeKey)) return null;
      const parts = String(rangeKey).split(':');
      if (parts.length !== 3) return null;
      const a = String(parts[1] || '').trim();
      const b = String(parts[2] || '').trim();
      if (!/^\d{4}-\d{2}-\d{2}$/.test(a) || !/^\d{4}-\d{2}-\d{2}$/.test(b)) return null;
      const startYmd = a <= b ? a : b;
      const endYmd = a <= b ? b : a;
      return { startYmd, endYmd };
    }

    function appliedYmdRangeFromDateRange() {
      if (isCustomRangeKey(dateRange)) return ymdRangeFromRangeKey(dateRange);
      if (isCustomDayRangeKey(dateRange)) {
        const ymd = ymdFromDayKey(dateRange);
        return ymd ? { startYmd: ymd, endYmd: ymd } : null;
      }
      return null;
    }

    function formatYmdLabel(ymd) {
      if (!ymd || !/^\d{4}-\d{2}-\d{2}$/.test(String(ymd))) return String(ymd || '');
      const y = parseInt(String(ymd).slice(0, 4), 10);
      const m = parseInt(String(ymd).slice(5, 7), 10);
      const d = parseInt(String(ymd).slice(8, 10), 10);
      if (!Number.isFinite(y) || !Number.isFinite(m) || !Number.isFinite(d)) return String(ymd || '');
      const dt = new Date(Date.UTC(y, m - 1, d, 12, 0, 0));
      try {
        return new Intl.DateTimeFormat('en-GB', { weekday: 'short', day: 'numeric', month: 'short' }).format(dt);
      } catch (_) {
        return String(ymd || '');
      }
    }

    function formatYmdRangeLabel(startYmd, endYmd) {
      if (!startYmd || !endYmd) return '';
      if (startYmd === endYmd) return formatYmdLabel(startYmd);
      return formatYmdLabel(startYmd) + ' – ' + formatYmdLabel(endYmd);
    }

    function makeRangeKeyFromYmds(startYmd, endYmd) {
      const a = String(startYmd || '').trim();
      const b = String(endYmd || '').trim();
      if (!/^\d{4}-\d{2}-\d{2}$/.test(a) || !/^\d{4}-\d{2}-\d{2}$/.test(b)) return null;
      const s = a <= b ? a : b;
      const e = a <= b ? b : a;
      return 'r:' + s + ':' + e;
    }

    function updateLiveViewTitle() {
      const tabsWrap = document.getElementById('table-title-tabs');
      const textEl = document.getElementById('table-title-text');
      const sel = document.getElementById('global-date-select');
      const showTabs = (dateRange === 'live' || dateRange === 'sales' || dateRange === 'today');
      if (tabsWrap) tabsWrap.classList.toggle('is-hidden', !showTabs);
      if (textEl) textEl.classList.toggle('is-hidden', showTabs);
      if (showTabs && tabsWrap) {
        ['today', 'sales', 'live'].forEach(function(r) {
          const btn = document.getElementById('table-tab-' + r);
          if (btn) btn.setAttribute('aria-selected', dateRange === r ? 'true' : 'false');
        });
      } else {
        let label = null;
        const applied = appliedYmdRangeFromDateRange();
        if (applied && applied.startYmd && applied.endYmd) {
          label = formatYmdRangeLabel(applied.startYmd, applied.endYmd);
        } else if (sel) {
          const opt = sel.querySelector('option[value="' + dateRange + '"]') || sel.options[sel.selectedIndex];
          label = opt && opt.textContent ? String(opt.textContent).trim() : null;
        }
        const fallback = { live: 'Now', today: 'Today', sales: 'Sales', yesterday: 'Yesterday', '3d': 'Last 3 Days', '7d': 'Last 7 Days', '1h': 'Last Hour', custom: 'Custom' };
        if (textEl) textEl.textContent = label || fallback[dateRange] || 'Today';
      }
    }

    function updateRowsPerPageVisibility() {
      const wrap = document.getElementById('rows-per-page-wrap');
      if (wrap) wrap.classList.toggle('is-hidden', dateRange === 'live');
    }

    function syncDateSelectOptions() {
      const sel = document.getElementById('global-date-select');
      if (!sel) return;
      if (activeMainTab === 'dashboard') return;
      const hasLive = sel.querySelector('option[value="live"]');
      if (hasLive) hasLive.remove();
      // Keep the "Custom" option stable, and create a dynamic option for the currently applied custom range.
      const customOpt = document.getElementById('date-opt-custom') || sel.querySelector('option[value="custom"]');
      if (customOpt) customOpt.textContent = 'Custom';

      // Remove previous dynamic custom-range option(s).
      sel.querySelectorAll('option[data-custom-range="1"]').forEach(function(o) { try { o.remove(); } catch (_) {} });

      // Normalize legacy single-day custom keys into the new range key.
      if (isCustomDayRangeKey(dateRange)) {
        const ymd = ymdFromDayKey(dateRange);
        const rk = ymd ? makeRangeKeyFromYmds(ymd, ymd) : null;
        if (rk) dateRange = rk;
      }

      const applied = appliedYmdRangeFromDateRange();
      if (applied && applied.startYmd && applied.endYmd) {
        customRangeStartYmd = applied.startYmd;
        customRangeEndYmd = applied.endYmd;
        const label = formatYmdRangeLabel(applied.startYmd, applied.endYmd) || 'Selected dates';
        const opt = document.createElement('option');
        opt.value = String(dateRange);
        opt.textContent = label;
        opt.setAttribute('data-custom-range', '1');
        if (customOpt && customOpt.parentNode === sel) sel.insertBefore(opt, customOpt);
        else sel.appendChild(opt);
        sel.value = String(dateRange);
      } else if (activeMainTab === 'spy') {
        // Spy supports live/sales table tabs; dropdown stays on Today/Yesterday/Custom.
        sel.value = (dateRange === 'live' || dateRange === 'sales' || dateRange === '1h') ? 'today' : String(dateRange || 'today');
      } else {
        // Other tabs only use day/range ranges; if somehow on live, treat as Today.
        if (dateRange === 'live') {
          dateRange = 'today';
          sessionsTotal = null;
        }
        sel.value = (dateRange === 'live' || dateRange === 'sales' || dateRange === '1h') ? 'today' : String(dateRange || 'today');
      }

      updateLiveViewTitle();
      updateRowsPerPageVisibility();
    }

    function applyRangeAvailable(available) {
      const sel = document.getElementById('global-date-select');
      if (!sel) return;
      const keys = ['today', 'yesterday'];
      const allowYesterday = floorAllowsYesterday();
      if (dateRange === 'yesterday' && !allowYesterday) {
        dateRange = 'today';
        customRangeStartYmd = null;
        customRangeEndYmd = null;
        syncDateSelectOptions();
      }
      keys.forEach((key) => {
        const o = sel.querySelector('option[value="' + key + '"]');
        if (!o) return;
        const ok = key === 'yesterday' ? (allowYesterday && !!(available && available[key])) : !!(available && available[key]);
        o.disabled = !ok;
        try { o.hidden = (key === 'yesterday' && !allowYesterday); } catch (_) {}
      });

      try {
        const menu = document.getElementById('mobile-date-menu');
        if (menu) {
          const item = menu.querySelector('.mobile-date-item[data-value="yesterday"]');
          if (item) item.style.display = allowYesterday ? '' : 'none';
        }
      } catch (_) {}
      if (dateRange !== 'live' && !isCustomDayRangeKey(dateRange) && !isCustomRangeKey(dateRange) && available && available[dateRange] === false) {
        dateRange = 'today';
        customRangeStartYmd = null;
        customRangeEndYmd = null;
        syncDateSelectOptions();
      }
      updateLiveViewTitle();
      updateRowsPerPageVisibility();
    }

    // Custom date calendar (last 30 days, disabled if no data)
    let availableDaysMemo = null;
    let availableDaysMemoAt = 0;
    let availableDaysInflight = null;
    const AVAILABLE_DAYS_MEMO_TTL_MS = 60 * 1000;

    function fetchAvailableDays(days, opts = {}) {
      const force = !!opts.force;
      const now = Date.now();
      if (!force && availableDaysMemo && (now - availableDaysMemoAt) < AVAILABLE_DAYS_MEMO_TTL_MS) {
        return Promise.resolve(availableDaysMemo);
      }
      if (!force && availableDaysInflight) return availableDaysInflight;
      const url = API + '/api/available-days?days=' + encodeURIComponent(String(days || 30)) + (force ? ('&_=' + now) : '');
      const p = fetchWithTimeout(url, { credentials: 'same-origin', cache: force ? 'no-store' : 'default' }, 20000)
        .then((r) => (r && r.ok) ? r.json() : null)
        .then((data) => {
          if (data && data.ok) {
            availableDaysMemo = data;
            availableDaysMemoAt = Date.now();
          }
          return data;
        })
        .catch(() => null)
        .finally(() => {
          if (availableDaysInflight === p) availableDaysInflight = null;
        });
      availableDaysInflight = p;
      return p;
    }

    function pad2(n) { return String(n).padStart(2, '0'); }

    function weekdayMon0(year, month, day, timeZone) {
      const dt = new Date(Date.UTC(year, month - 1, day, 12, 0, 0));
      try {
        const wd = new Intl.DateTimeFormat('en-US', { timeZone: timeZone || undefined, weekday: 'short' }).format(dt);
        const map = { Mon: 0, Tue: 1, Wed: 2, Thu: 3, Fri: 4, Sat: 5, Sun: 6 };
        if (map[wd] != null) return map[wd];
      } catch (_) {}
      const dow = dt.getUTCDay(); // 0=Sun..6=Sat
      return (dow + 6) % 7; // Mon=0..Sun=6
    }

    function daysInMonth(year, month) {
      // month: 1-12
      return new Date(Date.UTC(year, month, 0, 12, 0, 0)).getUTCDate();
    }

    function renderCustomCalendar(container, payload) {
      if (!container) return;
      const data = payload && payload.ok ? payload : null;
      if (!data || !Array.isArray(data.days)) {
        container.innerHTML = '<div class="muted">Could not load calendar.</div>';
        return;
      }
      const timeZone = data.timeZone || undefined;
      const list = data.days.slice(); // { date, hasSessions } (today -> older)
      let anySelectable = false;
      for (const it of list) {
        if (it && it.date && it.hasSessions) { anySelectable = true; break; }
      }
      if (!anySelectable) {
        container.innerHTML = '<div class="muted">Please select a supported date range (no dates found).</div>';
        return;
      }
      const availableByYmd = new Map();
      const ymdSet = new Set();
      for (const it of list) {
        if (!it || !it.date) continue;
        const ymd = String(it.date);
        ymdSet.add(ymd);
        availableByYmd.set(ymd, !!it.hasSessions);
      }
      const months = [];
      for (let i = list.length - 1; i >= 0; i--) {
        const ymd = list[i] && list[i].date ? String(list[i].date) : '';
        const key = ymd.slice(0, 7);
        if (key && (months.length === 0 || months[months.length - 1] !== key)) months.push(key);
      }
      const partsToMonthTitle = (year, month) => {
        const dt = new Date(Date.UTC(year, month - 1, 1, 12, 0, 0));
        try {
          return new Intl.DateTimeFormat('en-GB', { timeZone: timeZone || undefined, month: 'long', year: 'numeric' }).format(dt);
        } catch (_) {
          return year + '-' + pad2(month);
        }
      };
      let startSel = pendingCustomRangeStartYmd;
      let endSel = pendingCustomRangeEndYmd;
      if (startSel && endSel && startSel > endSel) {
        const tmp = startSel;
        startSel = endSel;
        endSel = tmp;
      }
      const weekdayLabels = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
      container.innerHTML = months.map((mk) => {
        const y = parseInt(mk.slice(0, 4), 10);
        const m = parseInt(mk.slice(5, 7), 10);
        if (!Number.isFinite(y) || !Number.isFinite(m)) return '';
        const firstOffset = weekdayMon0(y, m, 1, timeZone);
        const dim = daysInMonth(y, m);
        const title = partsToMonthTitle(y, m);
        const weekdayRow = '<div class="date-cal-weekdays">' + weekdayLabels.map((w) => '<div class="date-cal-weekday">' + w + '</div>').join('') + '</div>';
        let cells = '';
        for (let i = 0; i < firstOffset; i++) cells += '<div class="date-cal-spacer"></div>';
        for (let d = 1; d <= dim; d++) {
          const ymd = y + '-' + pad2(m) + '-' + pad2(d);
          if (!ymdSet.has(ymd)) {
            cells += '<div class="date-cal-spacer"></div>';
            continue;
          }
          const has = !!availableByYmd.get(ymd);
          const isStart = startSel && ymd === startSel;
          const isEnd = endSel && ymd === endSel;
          const inRange = startSel && endSel && ymd > startSel && ymd < endSel;
          const isToday = list[0] && String(list[0].date) === ymd;
          const cls = [
            'date-cal-day',
            has ? '' : 'disabled',
            inRange ? 'in-range' : '',
            isStart ? 'range-start' : '',
            isEnd ? 'range-end' : '',
            isToday ? 'today' : '',
          ].filter(Boolean).join(' ');
          const disabledAttr = has ? '' : ' disabled';
          cells += '<button type="button" class="' + cls + '" data-ymd="' + ymd + '"' + disabledAttr + '>' + d + '</button>';
        }
        return '<div class="date-cal-month">' +
          '<div class="date-cal-month-title">' + title + '</div>' +
          weekdayRow +
          '<div class="date-cal-grid">' + cells + '</div>' +
        '</div>';
      }).join('');
    }

    function closeCustomDateModal() {
      const modal = document.getElementById('date-custom-modal');
      if (!modal) return;
      modal.classList.remove('open');
      modal.setAttribute('aria-hidden', 'true');
      pendingCustomRangeStartYmd = null;
      pendingCustomRangeEndYmd = null;
      syncDateSelectOptions();
    }

    function applyDateRangeChange() {
      if (dateRange !== 'live') lastOnlineCount = null;
      countryPage = 1;
      bestGeoProductsPage = 1;
      aovPage = 1;
      bestSellersPage = 1;
      bestVariantsPage = 1;
      currentPage = 1;
      syncDateSelectOptions();
      // Reset caches when range changes.
      leaderboardCache = null;
      finishesCache = null;
      lengthsCache = null;
      chainStylesCache = null;
      bestSellersCache = null;
      bestVariantsCache = null;
      trafficCache = null;
      lastStatsFetchedAt = 0;
      lastBreakdownFetchedAt = 0;
      lastProductsFetchedAt = 0;
      lastTrafficFetchedAt = 0;
      updateNextUpdateUi();

      // Top KPI grid refreshes independently (every minute). On range change, force a refresh immediately.
      refreshKpis({ force: true });

      if (activeMainTab === 'stats') {
        refreshStats({ force: false });
      } else if (activeMainTab === 'breakdown') {
        refreshBreakdown({ force: false });
      } else if (activeMainTab === 'traffic') {
        refreshTraffic({ force: false });
      } else if (activeMainTab === 'products') {
        refreshProducts({ force: false });
      } else if (activeMainTab === 'ads') {
        try { if (window.__adsRefresh) window.__adsRefresh({ force: false }); } catch (_) {}
      } else {
        updateKpis();
        fetchSessions();
      }
    }

    function openCustomDateModal() {
      const modal = document.getElementById('date-custom-modal');
      const cal = document.getElementById('date-custom-calendar');
      if (!modal || !cal) return;
      modal.classList.add('open');
      modal.setAttribute('aria-hidden', 'false');
      const applied = appliedYmdRangeFromDateRange();
      pendingCustomRangeStartYmd = applied && applied.startYmd && applied.startYmd >= MIN_YMD ? applied.startYmd : null;
      pendingCustomRangeEndYmd = applied && applied.endYmd && applied.endYmd >= MIN_YMD ? applied.endYmd : null;
      customCalendarLastPayload = null;
      updateCustomDateFooter();
      cal.innerHTML = '<div class="muted">Loading…</div>';
      fetchAvailableDays(30).then((payload) => {
        customCalendarLastPayload = payload;
        renderCustomCalendar(cal, payload);
        updateCustomDateFooter();
      });
    }

    function updateCustomDateFooter() {
      const summaryEl = document.getElementById('date-custom-summary');
      const clearBtn = document.getElementById('date-custom-clear');
      const applyBtn = document.getElementById('date-custom-apply');
      if (!summaryEl) return;
      const a = pendingCustomRangeStartYmd;
      const b = pendingCustomRangeEndYmd;
      if (!a) {
        summaryEl.textContent = 'Select a start date.';
        if (clearBtn) clearBtn.disabled = true;
        if (applyBtn) applyBtn.disabled = true;
        return;
      }
      if (!b) {
        summaryEl.textContent = 'Start: ' + formatYmdLabel(a) + '. Select an end date.';
        if (clearBtn) clearBtn.disabled = false;
        if (applyBtn) applyBtn.disabled = true;
        return;
      }
      const startYmd = a <= b ? a : b;
      const endYmd = a <= b ? b : a;
      summaryEl.textContent = 'Selected: ' + (formatYmdRangeLabel(startYmd, endYmd) || (startYmd + ' – ' + endYmd));
      if (clearBtn) clearBtn.disabled = false;
      if (applyBtn) applyBtn.disabled = false;
    }

    let customDateModalInited = false;
    function initCustomDateModal() {
      if (customDateModalInited) return;
      customDateModalInited = true;
      const modal = document.getElementById('date-custom-modal');
      if (!modal) return;
      const closeBtn = document.getElementById('date-custom-close-btn');
      if (closeBtn) closeBtn.addEventListener('click', function(e) { e.preventDefault(); closeCustomDateModal(); });
      modal.addEventListener('click', function(e) {
        if (e && e.target === modal) closeCustomDateModal();
      });
      document.addEventListener('keydown', function(e) {
        if (!modal.classList.contains('open')) return;
        const key = e && (e.key || e.code) ? String(e.key || e.code) : '';
        if (key === 'Escape') closeCustomDateModal();
      });
      const clearBtn = document.getElementById('date-custom-clear');
      const applyBtn = document.getElementById('date-custom-apply');
      if (clearBtn) {
        clearBtn.addEventListener('click', function(e) {
          e.preventDefault();
          pendingCustomRangeStartYmd = null;
          pendingCustomRangeEndYmd = null;
          const cal = document.getElementById('date-custom-calendar');
          if (cal) renderCustomCalendar(cal, customCalendarLastPayload || availableDaysMemo);
          updateCustomDateFooter();
        });
      }
      if (applyBtn) {
        applyBtn.addEventListener('click', function(e) {
          e.preventDefault();
          const a = pendingCustomRangeStartYmd;
          const b = pendingCustomRangeEndYmd;
          if (!a || !b) return;
          const startYmd = a <= b ? a : b;
          const endYmd = a <= b ? b : a;
          if (startYmd < MIN_YMD || endYmd < MIN_YMD) return;
          const rk = makeRangeKeyFromYmds(startYmd, endYmd);
          if (!rk) return;
          customRangeStartYmd = startYmd;
          customRangeEndYmd = endYmd;
          dateRange = rk;
          closeCustomDateModal();
          applyDateRangeChange();
        });
      }
      const cal = document.getElementById('date-custom-calendar');
      if (cal) {
        cal.addEventListener('click', function(e) {
          const t = e && e.target ? e.target : null;
          if (!t) return;
          const btn = t.closest ? t.closest('button.date-cal-day') : null;
          if (!btn) return;
          if (btn.disabled) return;
          const ymd = btn.getAttribute('data-ymd') || '';
          if (!ymd) return;
          if (ymd < MIN_YMD) return;
          if (!pendingCustomRangeStartYmd || (pendingCustomRangeStartYmd && pendingCustomRangeEndYmd)) {
            pendingCustomRangeStartYmd = ymd;
            pendingCustomRangeEndYmd = null;
          } else {
            pendingCustomRangeEndYmd = ymd;
          }
          renderCustomCalendar(cal, customCalendarLastPayload || availableDaysMemo);
          updateCustomDateFooter();
        });
      }
    }

    function maybeTriggerSaleToastFromStatsLikeData(data) {
      const conv = data && data.convertedCount ? data.convertedCount : {};
      const haveToday = (typeof conv.today === 'number' && Number.isFinite(conv.today));
      if (!haveToday) return;

      // Reset the converted-count baseline daily (admin TZ).
      try {
        const day = ymdNowInTz();
        if (convertedCountDayYmd == null) convertedCountDayYmd = day;
        if (day && convertedCountDayYmd !== day) {
          convertedCountDayYmd = day;
          hasSeenConvertedCountToday = false;
          lastConvertedCountToday = 0;
        }
      } catch (_) {}

      // Guard against stale/cache drift where counts briefly move backwards (would cause double "sale" sounds).
      if (hasSeenConvertedCountToday && conv.today < lastConvertedCountToday) return;

      const increased = hasSeenConvertedCountToday && conv.today > lastConvertedCountToday;
      if (increased) {
        triggerSaleToast({ origin: 'stats', playSound: true });
        // Keep Home tables in sync when a toast fires outside SSE (Today/Sales/Live).
        if (activeMainTab === 'spy' && (dateRange === 'today' || dateRange === 'sales' || dateRange === 'live' || dateRange === '1h')) {
          try { fetchSessions(); } catch (_) {}
        }
        // Pull the authoritative timestamp (truth/evidence) so the footer is accurate.
        // Don't refresh Diagnostics in the background while the modal is open (avoid disrupting viewing).
        try {
          if (!(typeof isConfigModalOpen === 'function' && isConfigModalOpen())) {
            refreshConfigStatus();
          }
        } catch (_) {}
      }
      lastConvertedCountToday = conv.today;
      hasSeenConvertedCountToday = true;
    }

    function setLiveKpisLoading() {
      const spinner = '<span class="kpi-mini-spinner" aria-hidden="true"></span>';
      const ids = ['live-kpi-sales', 'live-kpi-sessions', 'live-kpi-conv', 'live-kpi-returning', 'live-kpi-aov', 'live-kpi-bounce'];
      ids.forEach(function(id) {
        const el = document.getElementById(id);
        if (!el) return;
        el.innerHTML = spinner;
      });
    }

    function renderStats(data) {
      statsCache = data || {};
      const statsRange = getStatsRange();
      if (statsRange !== 'today') {
        if (kpiCache && kpiCache.compare && !statsCache.compare) {
          kpiCache = { ...statsCache, compare: kpiCache.compare };
        } else {
          kpiCache = statsCache;
        }
      }
      maybeTriggerSaleToastFromStatsLikeData(statsCache);
      if (statsCache.rangeAvailable) applyRangeAvailable(statsCache.rangeAvailable);
      renderCountry(statsCache);
      renderBestGeoProducts(statsCache);
      renderAov(statsCache);
      renderLiveKpis(getKpiData());
      scheduleBreakdownSync();
    }

    function kpiDelta(current, baseline) {
      const cur = typeof current === 'number' ? current : NaN;
      const base = typeof baseline === 'number' ? baseline : NaN;
      if (!Number.isFinite(cur) || !Number.isFinite(base)) return null;
      const diff = cur - base;
      if (diff === 0) return 0;
      if (base <= 0) return diff > 0 ? 1 : -1;
      return diff / base;
    }

    var KPI_DELTA_SVG = '<svg viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M20.684 4.042A1.029 1.029 0 0 1 22 5.03l-.001 5.712a1.03 1.03 0 0 1-1.647.823L18.71 10.33l-4.18 5.568a1.647 1.647 0 0 1-2.155.428l-.15-.1-3.337-2.507-4.418 5.885c-.42.56-1.185.707-1.777.368l-.144-.095a1.372 1.372 0 0 1-.368-1.776l.095-.144 5.077-6.762a1.646 1.646 0 0 1 2.156-.428l.149.1 3.336 2.506 3.522-4.69-1.647-1.237a1.03 1.03 0 0 1 .194-1.76l.137-.05 5.485-1.595-.001.001z"/></svg>';
    var KPI_DELTA_SVG_DOWN = '<svg viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M21 12a1 1 0 0 0-2 0v2.3l-4.24-5a1 1 0 0 0-1.27-.21L9.22 11.7 4.77 6.36a1 1 0 1 0-1.54 1.28l5 6a1 1 0 0 0 1.28.22l4.28-2.57 4 4.71H15a1 1 0 0 0 0 2h5a1.1 1.1 0 0 0 .36-.07l.14-.08a1.19 1.19 0 0 0 .15-.09.75.75 0 0 0 .14-.17 1.1 1.1 0 0 0 .09-.14.64.64 0 0 0 .05-.17A.78.78 0 0 0 21 17z"/></svg>';
    function applyKpiDeltaColor(el, current, baseline, invert) {
      if (!el) return;
      var icon = el.querySelector && el.querySelector('.kpi-delta-icon');
      if (icon) icon.remove();
      const delta = kpiDelta(current, baseline);
      if (delta == null) return;
      if (Math.abs(delta) < 0.005) return;
      const toneDelta = invert ? -delta : delta;
      const toneClass = toneDelta > 0 ? 'kpi-delta-good' : 'kpi-delta-bad';
      if (delta > 0) {
        var span = document.createElement('span');
        span.className = 'kpi-delta-icon kpi-delta-icon-up ' + toneClass;
        span.setAttribute('aria-hidden', 'true');
        span.innerHTML = KPI_DELTA_SVG;
        el.appendChild(span);
      } else if (delta < 0) {
        var spanDown = document.createElement('span');
        spanDown.className = 'kpi-delta-icon kpi-delta-icon-down ' + toneClass;
        spanDown.setAttribute('aria-hidden', 'true');
        spanDown.innerHTML = KPI_DELTA_SVG_DOWN;
        el.appendChild(spanDown);
      }
    }

    // KPI boxes temporarily show N/A: sales/revenue dedupe and pixel-vs-Shopify alignment are not final;
    // numbers were over- or under-reporting. To restore real values: in renderLiveKpis below, remove the
    // "N/A" block and uncomment the "Real values (when fixed)" block so KPIs use data again.
    function renderLiveKpis(data) {
      const salesEl = document.getElementById('live-kpi-sales');
      const sessionsEl = document.getElementById('live-kpi-sessions');
      const convEl = document.getElementById('live-kpi-conv');
      const returningEl = document.getElementById('live-kpi-returning');
      const aovEl = document.getElementById('live-kpi-aov');
      const bounceEl = document.getElementById('live-kpi-bounce');
      const salesSubEl = document.getElementById('live-kpi-sales-sub');
      const sessionsSubEl = document.getElementById('live-kpi-sessions-sub');
      const convSubEl = document.getElementById('live-kpi-conv-sub');
      const returningSubEl = document.getElementById('live-kpi-returning-sub');
      const aovSubEl = document.getElementById('live-kpi-aov-sub');
      const bounceSubEl = document.getElementById('live-kpi-bounce-sub');
      const salesLabelEl = document.getElementById('live-kpi-sales-label');
      const sales = data && data.sales ? data.sales : {};
      const convertedCountMap = data && data.convertedCount ? data.convertedCount : {};
      const returningRevenue = data && data.returningRevenue ? data.returningRevenue : {};
      const breakdown = data && data.trafficBreakdown ? data.trafficBreakdown : {};
      const conv = data && data.conversion ? data.conversion : {};
      const aovMap = data && data.aov ? data.aov : {};
      const bounceMap = data && data.bounce ? data.bounce : {};
      const kpiRange = getStatsRange();
      const forRange = breakdown[kpiRange];
      const sessionsVal = forRange != null && typeof forRange.human_sessions === 'number' ? forRange.human_sessions : null;
      const salesVal = typeof sales[kpiRange] === 'number' ? sales[kpiRange] : null;
      const orderCountVal = typeof convertedCountMap[kpiRange] === 'number' ? convertedCountMap[kpiRange] : null;
      const returningVal = typeof returningRevenue[kpiRange] === 'number' ? returningRevenue[kpiRange] : null;
      const convVal = typeof conv[kpiRange] === 'number' ? conv[kpiRange] : null;
      const aovVal = typeof aovMap[kpiRange] === 'number' ? aovMap[kpiRange] : null;
      const bounceVal = typeof bounceMap[kpiRange] === 'number' ? bounceMap[kpiRange] : null;
      const compare = data && data.compare ? data.compare : null;
      const compareBreakdown = compare && compare.trafficBreakdown ? compare.trafficBreakdown : null;
      const compareSessionsVal = compareBreakdown && typeof compareBreakdown.human_sessions === 'number' ? compareBreakdown.human_sessions : null;
      const compareSalesVal = compare && typeof compare.sales === 'number' ? compare.sales : null;
      const compareReturningVal = compare && typeof compare.returningRevenue === 'number' ? compare.returningRevenue : null;
      const compareConvVal = compare && typeof compare.conversion === 'number' ? compare.conversion : null;
      const compareAovVal = compare && typeof compare.aov === 'number' ? compare.aov : null;
      const compareBounceVal = compare && typeof compare.bounce === 'number' ? compare.bounce : null;

      if (salesLabelEl) {
        salesLabelEl.textContent = orderCountVal != null ? (orderCountVal + ' Orders') : 'Orders';
        salesLabelEl.title = '';
      }
      if (salesEl) {
        animateOdometerText(salesEl, salesVal != null ? formatRevenue(salesVal) : '\u2014');
      }
      if (sessionsEl) sessionsEl.textContent = sessionsVal != null ? formatSessions(sessionsVal) : '\u2014';
      if (convEl) convEl.textContent = convVal != null ? pct(convVal) : '\u2014';
      if (returningEl) returningEl.textContent = returningVal != null ? formatRevenue(returningVal) : '\u2014';
      if (aovEl) aovEl.textContent = aovVal != null ? formatRevenue(aovVal) : '\u2014';
      if (bounceEl) bounceEl.textContent = bounceVal != null ? pct(bounceVal) : '\u2014';

      applyKpiDeltaColor(salesEl, salesVal, compareSalesVal, false);
      applyKpiDeltaColor(sessionsEl, sessionsVal, compareSessionsVal, false);
      applyKpiDeltaColor(convEl, convVal, compareConvVal, false);
      applyKpiDeltaColor(returningEl, returningVal, compareReturningVal, false);
      applyKpiDeltaColor(aovEl, aovVal, compareAovVal, false);
      applyKpiDeltaColor(bounceEl, bounceVal, compareBounceVal, true);

      const showYesterday = kpiRange === 'today';
      const kpiGrid = document.getElementById('live-kpi-grid');
      if (kpiGrid) kpiGrid.classList.toggle('kpi-not-today', !showYesterday);
      function setSub(el, text) {
        if (!el) return;
        if (!showYesterday || text === '' || text == null) {
          el.textContent = '';
          el.classList.add('is-hidden');
          return;
        }
        const compareSvg =
          '<svg fill="currentColor" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false">' +
            '<path d="M46.05,60.163H31.923c-0.836,0-1.513,0.677-1.513,1.513v21.934c0,0.836,0.677,1.513,1.513,1.513H46.05 c0.836,0,1.512-0.677,1.512-1.513V61.675C47.562,60.839,46.885,60.163,46.05,60.163z"></path>' +
            '<path d="M68.077,14.878H53.95c-0.836,0-1.513,0.677-1.513,1.513v67.218c0,0.836,0.677,1.513,1.513,1.513h14.127 c0.836,0,1.513-0.677,1.513-1.513V16.391C69.59,15.555,68.913,14.878,68.077,14.878z"></path>' +
            '<path d="M90.217,35.299H76.09c-0.836,0-1.513,0.677-1.513,1.513v46.797c0,0.836,0.677,1.513,1.513,1.513h14.126 c0.836,0,1.513-0.677,1.513-1.513V36.812C91.729,35.977,91.052,35.299,90.217,35.299z"></path>' +
            '<path d="M23.91,35.299H9.783c-0.836,0-1.513,0.677-1.513,1.513v46.797c0,0.836,0.677,1.513,1.513,1.513H23.91 c0.836,0,1.513-0.677,1.513-1.513V36.812C25.423,35.977,24.746,35.299,23.91,35.299z"></path>' +
          '</svg>';

        function compareBtn(kpiKey, ariaLabel) {
          return (
            '<button type="button" class="kpi-compare-inline-btn kpi-compare-open-btn" data-kpi-compare="' + escapeHtml(kpiKey) + '"' +
              ' aria-label="' + escapeHtml(ariaLabel) + '" title="Compare vs Shopify">' +
              compareSvg +
            '</button>'
          );
        }

        if (el === convSubEl) {
          el.innerHTML = compareBtn('conv', 'Compare conversion rate vs Shopify') + escapeHtml(text == null ? '' : String(text));
        } else if (el === sessionsSubEl) {
          el.innerHTML = compareBtn('sessions', 'Compare sessions vs Shopify') + escapeHtml(text == null ? '' : String(text));
        } else if (el === aovSubEl) {
          el.innerHTML = compareBtn('aov', 'Compare AOV vs Shopify') + escapeHtml(text == null ? '' : String(text));
        } else {
          el.textContent = text;
        }
        el.classList.remove('is-hidden');
      }
      setSub(salesSubEl, compareSalesVal != null ? formatRevenueSub(compareSalesVal) : '\u2014');
      setSub(sessionsSubEl, compareSessionsVal != null ? formatSessions(compareSessionsVal) : '\u2014');
      setSub(convSubEl, compareConvVal != null ? pct(compareConvVal) : '\u2014');
      setSub(returningSubEl, compareReturningVal != null ? formatRevenueSub(compareReturningVal) : '\u2014');
      setSub(aovSubEl, compareAovVal != null ? formatRevenueSub(compareAovVal) : '\u2014');
      setSub(bounceSubEl, compareBounceVal != null ? pct(compareBounceVal) : '\u2014');
      scheduleKpiPagerUpdate();
    }

    // KPI pager: swipe on mobile, page on desktop when labels wrap.
    let kpiPagerRaf = null;
    function scheduleKpiPagerUpdate() {
      if (typeof requestAnimationFrame !== 'function') {
        applyKpiPager();
        return;
      }
      if (kpiPagerRaf) cancelAnimationFrame(kpiPagerRaf);
      kpiPagerRaf = requestAnimationFrame(function() {
        kpiPagerRaf = null;
        applyKpiPager();
      });
    }
    function kpiLabelWraps(el) {
      if (!el) return false;
      const rect = el.getBoundingClientRect();
      const style = window.getComputedStyle ? window.getComputedStyle(el) : null;
      const lh = style ? parseFloat(style.lineHeight) : 0;
      const fs = style ? parseFloat(style.fontSize) : 0;
      const lineHeight = (Number.isFinite(lh) && lh > 0) ? lh : (Number.isFinite(fs) && fs > 0 ? fs * 1.2 : 0);
      if (!lineHeight) return false;
      return rect.height > lineHeight * 1.4;
    }
    function applyKpiPager() {
      const grid = document.getElementById('live-kpi-grid');
      const btn = document.getElementById('kpi-mobile-next');
      const wrap = document.querySelector('.kpi-mobile-pager');
      if (!grid || !btn) return;
      const isMobile = !!(window.matchMedia && window.matchMedia('(max-width: 768px)').matches);
      if (isMobile) {
        btn.classList.add('is-hidden');
        btn.disabled = true;
        if (wrap) wrap.classList.remove('kpi-pager-active');
        return;
      }
      const hasOverflow = wrap && wrap.scrollWidth > wrap.clientWidth;
      btn.classList.toggle('is-hidden', !hasOverflow);
      btn.disabled = !hasOverflow;
      btn.setAttribute('aria-label', hasOverflow ? 'Scroll KPIs right' : 'KPIs');
      if (wrap) {
        if (hasOverflow) wrap.classList.add('kpi-pager-active');
        else wrap.classList.remove('kpi-pager-active');
      }
    }
    (function initKpiPager() {
      const btn = document.getElementById('kpi-mobile-next');
      const wrap = document.querySelector('.kpi-mobile-pager');
      if (btn && wrap) {
        btn.addEventListener('click', function() {
          if (wrap.scrollWidth > wrap.clientWidth) {
            wrap.scrollLeft += Math.min(wrap.clientWidth * 0.75, wrap.scrollWidth - wrap.scrollLeft - wrap.clientWidth);
          }
        });
      }
      scheduleKpiPagerUpdate();
      window.addEventListener('resize', function() { scheduleKpiPagerUpdate(); scheduleBreakdownSync(); });
    })();

    function delay(ms) {
      const n = Number(ms) || 0;
      if (n <= 0) return Promise.resolve();
      return new Promise(function(resolve) { setTimeout(resolve, n); });
    }

    function fetchWithTimeout(url, options, timeoutMs) {
      const ms = Number(timeoutMs) || 0;
      const timeout = ms > 0 ? ms : 25000;
      if (typeof AbortController === 'undefined') {
        return Promise.race([
          fetch(url, options),
          new Promise(function(_, reject) {
            setTimeout(function() { reject(new Error('Request timed out')); }, timeout);
          }),
        ]);
      }
      const controller = new AbortController();
      const timer = setTimeout(function() { try { controller.abort(); } catch (_) {} }, timeout);
      const opts = Object.assign({}, options || {}, { signal: controller.signal });
      return fetch(url, opts).finally(function() { clearTimeout(timer); });
    }

    function startReportBuild(opts) {
      opts = opts && typeof opts === 'object' ? opts : {};
      const key = opts.key ? String(opts.key) : '';
      if (!key || !reportBuildTokens || typeof reportBuildTokens[key] !== 'number') {
        return { step: function() {}, finish: function() {} };
      }

      reportBuildTokens[key] = (reportBuildTokens[key] || 0) + 1;
      const token = reportBuildTokens[key];
      const overlayId = opts.overlayId ? String(opts.overlayId) : '';
      const stepId = opts.stepId ? String(opts.stepId) : '';
      const overlay = overlayId ? document.getElementById(overlayId) : null;
      const wrap = overlay ? overlay.parentElement : null;
      const stepEl = stepId ? document.getElementById(stepId) : null;

      if (wrap) wrap.classList.add('report-building');
      if (overlay) overlay.classList.remove('is-hidden');
      if (stepEl) stepEl.textContent = '';

      function step(text) {
        if (reportBuildTokens[key] !== token) return;
        if (!stepEl) return;
        stepEl.textContent = text != null ? String(text) : '';
      }

      function finish() {
        if (reportBuildTokens[key] !== token) return;
        if (overlay) overlay.classList.add('is-hidden');
        if (wrap) wrap.classList.remove('report-building');
      }

      return { step: step, finish: finish };
    }

    function fetchStatsData(options = {}) {
      const force = !!options.force;
      let url = API + '/api/stats?range=' + encodeURIComponent(getStatsRange());
      if (force) url += (url.indexOf('?') >= 0 ? '&' : '?') + '_=' + Date.now();
      const cacheMode = force ? 'no-store' : 'default';
      return fetchWithTimeout(url, { credentials: 'same-origin', cache: cacheMode }, 30000)
        .then(function(r) {
          if (!r.ok) throw new Error('Stats HTTP ' + r.status);
          return r.json();
        })
        .then(function(data) {
          lastStatsFetchedAt = Date.now();
          lastUpdateTime = new Date();
          updateServerTimeDisplay();
          renderStats(data && typeof data.country === 'object' ? data : {});
          return data;
        })
        .catch(function(err) {
          console.error(err);
          renderStats(statsCache || {});
          return null;
        });
    }

    const KPI_REFRESH_MS = 60000;
    const KPI_SPINNER_MIN_MS = 800;
    let kpisSpinnerShownOnce = false;

    function fetchKpisData(options = {}) {
      const force = !!options.force;
      let url = API + '/api/kpis?range=' + encodeURIComponent(getStatsRange());
      if (force) url += (url.indexOf('?') >= 0 ? '&' : '?') + 'force=1';
      return fetchWithTimeout(url, { credentials: 'same-origin', cache: 'no-store' }, 25000)
        .then(function(r) {
          if (!r.ok) throw new Error('KPIs HTTP ' + r.status);
          return r.json();
        });
    }

    function refreshKpis(options = {}) {
      const force = !!options.force;
      if (kpisRefreshInFlight) return kpisRefreshInFlight;

      // Only show the KPI mini spinners on the very first load (avoid visual noise on minute refreshes).
      const showSpinner = !kpisSpinnerShownOnce;
      if (showSpinner) {
        kpisSpinnerShownOnce = true;
        setLiveKpisLoading();
      }

      const fetchP = fetchKpisData({ force });
      kpisRefreshInFlight = (showSpinner ? Promise.all([fetchP, delay(KPI_SPINNER_MIN_MS)]) : fetchP)
        .then(function(partsOrData) {
          const data = showSpinner
            ? (partsOrData && partsOrData[0] && typeof partsOrData[0] === 'object' ? partsOrData[0] : null)
            : (partsOrData && typeof partsOrData === 'object' ? partsOrData : null);
          lastKpisFetchedAt = Date.now();
          if (data) {
            kpiCache = data;
            maybeTriggerSaleToastFromStatsLikeData(kpiCache);
          }
          renderLiveKpis(getKpiData());
          return data;
        })
        .catch(function(err) {
          console.error(err);
          renderLiveKpis(getKpiData());
          return null;
        })
        .finally(function() {
          kpisRefreshInFlight = null;
        });
      return kpisRefreshInFlight;
    }

    function refreshStats(options = {}) {
      const force = !!options.force;
      if (statsRefreshInFlight) return statsRefreshInFlight;

      const build = startReportBuild({ key: 'stats', overlayId: 'stats-loading-overlay', stepId: 'stats-build-step' });
      build.step('building countries...');
      statsRefreshInFlight = fetchStatsData({ force })
        .then(function(data) {
          build.step('building countries... done');
          return delay(180).then(function() {
            build.step('building average order...');
            return delay(120).then(function() {
              build.step('building average order... done');
              return delay(180).then(function() { return data; });
            });
          });
        })
        .finally(function() {
          statsRefreshInFlight = null;
          build.finish();
        });
      return statsRefreshInFlight;
    }

    function refreshBreakdown(options = {}) {
      const force = !!options.force;
      if (breakdownRefreshInFlight) return breakdownRefreshInFlight;
      var shop = getShopParam() || shopForSalesFallback || null;
      if (!shop) return Promise.resolve(null);

      const build = startReportBuild({ key: 'breakdown', overlayId: 'breakdown-loading-overlay', stepId: 'breakdown-build-step' });
      build.step('Loading\u2026');
      let leaderboardP = null;
      let finishesP = null;
      let lengthsP = null;
      let chainStylesP = null;
      try { leaderboardP = fetchProductsLeaderboard({ force }); } catch (err) { console.error(err); leaderboardP = Promise.resolve(null); }
      try { finishesP = fetchFinishes({ force }); } catch (err) { console.error(err); finishesP = Promise.resolve(null); }
      try { lengthsP = fetchLengths({ force }); } catch (err) { console.error(err); lengthsP = Promise.resolve(null); }
      try { chainStylesP = fetchChainStyles({ force }); } catch (err) { console.error(err); chainStylesP = Promise.resolve(null); }
      function settled(p) {
        return Promise.resolve(p)
          .then(function(v) { return { ok: true, value: v }; })
          .catch(function(err) { console.error(err); return { ok: false, error: err }; });
      }

      breakdownRefreshInFlight = Promise.all([settled(leaderboardP), settled(finishesP), settled(lengthsP), settled(chainStylesP)])
        .then(function() {
          renderBreakdownTitles(leaderboardCache);
          renderBreakdownTypes(leaderboardCache);
          renderBreakdownFinishes(finishesCache);
          renderBreakdownLengths(lengthsCache);
          renderBreakdownChainStyles(chainStylesCache);
          lastBreakdownFetchedAt = Date.now();
        })
        .catch(function(err) { console.error(err); return null; })
        .finally(function() { breakdownRefreshInFlight = null; build.finish(); });
      return breakdownRefreshInFlight;
    }

    function refreshProducts(options = {}) {
      const force = !!options.force;
      if (productsRefreshInFlight) return productsRefreshInFlight;
      var shop = getShopParam() || shopForSalesFallback || null;
      if (!shop) return Promise.resolve(null);

      const build = startReportBuild({ key: 'products', overlayId: 'products-loading-overlay', stepId: 'products-build-step' });
      let bestP = null;
      let variantsP = null;
      let leaderboardP = null;
      let variantCardsP = null;
      try { bestP = fetchBestSellers({ force }); } catch (err) { console.error(err); bestP = Promise.resolve(null); }
      try { variantsP = fetchBestVariants({ force }); } catch (err) { console.error(err); variantsP = Promise.resolve(null); }
      try { leaderboardP = fetchProductsLeaderboard({ force }); } catch (err) { console.error(err); leaderboardP = Promise.resolve(null); }
      try {
        variantCardsP = (normalizeProductsVariantCardsView(productsVariantCardsView) === 'lengths')
          ? fetchLengths({ force })
          : fetchFinishes({ force });
      } catch (err) {
        console.error(err);
        variantCardsP = Promise.resolve(null);
      }
      function settled(p) {
        return Promise.resolve(p)
          .then(function(v) { return { ok: true, value: v }; })
          .catch(function(err) { console.error(err); return { ok: false, error: err }; });
      }
      const bestS = settled(bestP);
      const variantsS = settled(variantsP);
      const leaderboardS = settled(leaderboardP);
      const variantCardsS = settled(variantCardsP);

      productsRefreshInFlight = Promise.resolve()
        .then(function() { build.step('building best products...'); return bestS; })
        .then(function() { build.step('building best products... done'); return delay(180); })
        .then(function() { build.step('building best variants...'); return variantsS; })
        .then(function() { build.step('building best variants... done'); return delay(180); })
        .then(function() { build.step('building leaderboard...'); return leaderboardS; })
        .then(function() { build.step('building leaderboard... done'); return delay(140); })
        .then(function() { build.step('building variants...'); return variantCardsS; })
        .then(function() { build.step('building variants... done'); return delay(140); })
        .then(function() { lastProductsFetchedAt = Date.now(); })
        .catch(function(err) {
          console.error(err);
          return null;
        })
        .finally(function() {
          productsRefreshInFlight = null;
          build.finish();
        });
      return productsRefreshInFlight;
    }

    function renderTrafficTables(data) {
      const sources = data && data.sources ? data.sources : null;
      const types = data && data.types ? data.types : null;
      const srcBy = (tableSortState.trafficSources.by || 'rev').toString().trim().toLowerCase();
      const srcDir = (tableSortState.trafficSources.dir || 'desc').toString().trim().toLowerCase() === 'asc' ? 'asc' : 'desc';
      const typeBy = (tableSortState.trafficTypes.by || 'rev').toString().trim().toLowerCase();
      const typeDir = (tableSortState.trafficTypes.dir || 'desc').toString().trim().toLowerCase() === 'asc' ? 'asc' : 'desc';

      function trafficSourceIconHtml(keyRaw, labelRaw) {
        function icon(src, alt, title, extraClass) {
          const cls = (extraClass ? (extraClass + ' ') : '') + 'source-icon-img';
          const t = title ? ' title="' + escapeHtml(String(title)) + '"' : '';
          return '<img src="' + escapeHtml(hotImg(src) || src || '') + '" alt="' + escapeHtml(alt || '') + '" class="' + cls + '" width="20" height="20"' + t + '>';
        }
        const key = keyRaw != null ? String(keyRaw).trim().toLowerCase() : '';
        const label = labelRaw != null ? String(labelRaw).trim() : '';
        if (!key) return escapeHtml(label || '—');
        const resolvedLabel = trafficSourceLabelForKey(key, label || key);
        const customIcon = trafficSourceIconUrlForKey(key);
        const src = customIcon || trafficSourceBuiltInIconSrc(key) || SOURCE_UNKNOWN_IMG;
        const extra = key === 'google_ads' ? 'source-googleads-img' : '';
        // Traffic tab: show icon + label (Home table is icon-only).
        return '<span class="traffic-source-cell">' +
          '<span class="source-icons">' + icon(src, resolvedLabel, resolvedLabel, extra) + '</span>' +
          '<span class="traffic-source-label">' + escapeHtml(resolvedLabel || label || key) + '</span>' +
        '</span>';
      }

      function renderRows(bodyId, rows, emptyText) {
        const body = document.getElementById(bodyId);
        if (!body) return;
        const list = Array.isArray(rows) ? rows.slice() : [];
        function sourceLabel(r) {
          const key = (r && r.key != null) ? String(r.key).trim().toLowerCase() : '';
          const labelText = (r && r.label) ? String(r.label) : (key || '—');
          return labelText;
        }
        list.sort(function(a, b) {
          var primary = 0;
          if (srcBy === 'source') primary = cmpNullableText(sourceLabel(a), sourceLabel(b), srcDir);
          else if (srcBy === 'cr') primary = cmpNullableNumber(a && a.conversionPct, b && b.conversionPct, srcDir);
          else if (srcBy === 'orders') primary = cmpNullableNumber(a && a.orders, b && b.orders, srcDir);
          else if (srcBy === 'sessions') primary = cmpNullableNumber(a && a.sessions, b && b.sessions, srcDir);
          else if (srcBy === 'rev') primary = cmpNullableNumber(a && a.revenueGbp, b && b.revenueGbp, srcDir);
          return primary ||
            cmpNullableNumber(a && a.revenueGbp, b && b.revenueGbp, 'desc') ||
            cmpNullableNumber(a && a.orders, b && b.orders, 'desc') ||
            cmpNullableNumber(a && a.sessions, b && b.sessions, 'desc') ||
            cmpNullableText(sourceLabel(a), sourceLabel(b), 'asc');
        });
        if (!list.length) {
          body.innerHTML = '<div class="grid-row" role="row"><div class="grid-cell empty span-all" role="cell">' + escapeHtml(emptyText || '—') + '</div></div>';
          return;
        }
        var filtered = list.filter(function(r) {
          var s = (r && typeof r.sessions === 'number') ? r.sessions : 0;
          var o = (r && typeof r.orders === 'number') ? r.orders : 0;
          return s >= 1 || o >= 1;
        });
        if (!filtered.length) {
          body.innerHTML = '<div class="grid-row" role="row"><div class="grid-cell empty span-all" role="cell">' + escapeHtml(emptyText || '—') + '</div></div>';
          return;
        }
        let html = '';
        filtered.forEach(function(r) {
          const key = (r && r.key != null) ? String(r.key).trim().toLowerCase() : '';
          const labelText = (r && r.label) ? String(r.label) : (key || '—');
          const labelCell = trafficSourceIconHtml(key, labelText);
          const cr = (r && typeof r.conversionPct === 'number') ? pct(r.conversionPct) : '—';
          const orders = (r && typeof r.orders === 'number') ? formatSessions(r.orders) : '—';
          const sessions = (r && typeof r.sessions === 'number') ? formatSessions(r.sessions) : '—';
          const rev = (r && typeof r.revenueGbp === 'number') ? formatRevenueTableHtml(r.revenueGbp) : '—';
          html += '<div class="grid-row" role="row">' +
            '<div class="grid-cell" role="cell">' + labelCell + '</div>' +
            '<div class="grid-cell" role="cell">' + escapeHtml(cr || '—') + '</div>' +
            '<div class="grid-cell" role="cell">' + escapeHtml(orders || '—') + '</div>' +
            '<div class="grid-cell" role="cell">' + escapeHtml(sessions || '—') + '</div>' +
            '<div class="grid-cell" role="cell">' + (rev || '—') + '</div>' +
            '</div>';
        });
        body.innerHTML = html;
      }

      renderRows('traffic-sources-body', sources ? sources.rows : [], 'Open Settings (footer) → Traffic to choose channels.');

      function trafficTypeDeviceIcon(device) {
        var d = (device || '').trim().toLowerCase();
        var s = 'width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"';
        if (d === 'desktop') return '<svg ' + s + '><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>';
        if (d === 'mobile') return '<svg ' + s + '><rect x="5" y="2" width="14" height="20" rx="2"/><line x1="12" y1="18" x2="12" y2="18"/></svg>';
        if (d === 'tablet') return '<svg ' + s + '><rect x="4" y="2" width="16" height="20" rx="2"/><line x1="12" y1="18" x2="12" y2="18"/></svg>';
        return '<svg ' + s + '><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>';
      }

      function trafficTypePlatformIcon(platform) {
        var p = (platform || '').trim().toLowerCase();
        if (p === 'ios' || p === 'mac') return '<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M18.71 19.5c-.83 1.24-1.71 2.45-3.05 2.47-1.34.03-1.77-.79-3.29-.79-1.53 0-2 .77-3.27.82-1.31.05-2.3-1.32-3.14-2.53C4.25 17 2.94 12.45 4.7 9.39c.87-1.52 2.43-2.48 4.12-2.51 1.28-.02 2.5.87 3.29.87.78 0 2.26-1.07 3.8-.91.65.03 2.47.26 3.64 1.98-.09.06-2.17 1.28-2.15 3.81.03 3.02 2.65 4.03 2.68 4.04-.03.07-.42 1.44-1.38 2.83M13 3.5c.73-.83 1.94-1.46 2.94-1.5.13 1.17-.34 2.35-1.04 3.19-.69.85-1.83 1.51-2.95 1.42-.15-1.15.41-2.35 1.05-3.11z"/></svg>';
        if (p === 'android') return '<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M17.6 9.48l1.84-3.18c.16-.31.04-.69-.27-.86-.31-.16-.69-.04-.86.27l-1.87 3.23C14.83 8.34 13.45 8.01 12 8.01s-2.83.33-4.44.93L5.69 5.71c-.16-.31-.54-.43-.86-.27-.31.16-.43.55-.27.86l1.84 3.18C3.39 11.13 1.43 14.08 1 17.5h22c-.43-3.42-2.39-6.37-5.4-8.02zM7 15.25a1.25 1.25 0 1 1 0-2.5 1.25 1.25 0 0 1 0 2.5zm10 0a1.25 1.25 0 1 1 0-2.5 1.25 1.25 0 0 1 0 2.5z"/></svg>';
        if (p === 'windows') return '<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M3 12V6.5l8-1.1V12H3zm0 .5h8v6.6l-8-1.1V12.5zm9 0h9V21l-9-1.2V12.5zm0-.5V4l9-1.2V12h-9z"/></svg>';
        if (p === 'linux') return '<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M12.5 2C10 2 8.2 4.1 8.2 6.6c0 1.4.5 2.6.9 3.8.4 1.2.6 2.3.4 3-.5 1.2-2 2-2.4 3.3-.2.7-.1 1.5.5 2.1.7.7 1.6.6 2.2.4.6-.2 1.1-.5 1.7-.5s1.1.3 1.7.5c.6.2 1.5.3 2.2-.4.6-.6.7-1.4.5-2.1-.4-1.3-1.9-2.1-2.4-3.3-.2-.7 0-1.8.4-3 .4-1.2.9-2.4.9-3.8C14.8 4.1 15 2 12.5 2z"/></svg>';
        return '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>';
      }

      (function renderTypeTree() {
        const body = document.getElementById('traffic-types-body');
        if (!body) return;
        const groups = types && Array.isArray(types.rows) ? types.rows.slice() : [];
        if (!groups.length) {
          body.innerHTML = '<div class="grid-row" role="row"><div class="grid-cell empty span-all" role="cell">' + escapeHtml('Open Settings (footer) → Traffic to choose device types.') + '</div></div>';
          return;
        }
        function typeLabel(r) {
          if (!r) return '—';
          if (r.label != null && String(r.label).trim() !== '') return String(r.label);
          if (r.platform != null && String(r.platform).trim() !== '') return String(r.platform);
          if (r.key != null && String(r.key).trim() !== '') return String(r.key);
          return '—';
        }
        groups.sort(function(a, b) {
          var primary = 0;
          if (typeBy === 'type') primary = cmpNullableText(typeLabel(a), typeLabel(b), typeDir);
          else if (typeBy === 'cr') primary = cmpNullableNumber(a && a.conversionPct, b && b.conversionPct, typeDir);
          else if (typeBy === 'orders') primary = cmpNullableNumber(a && a.orders, b && b.orders, typeDir);
          else if (typeBy === 'sessions') primary = cmpNullableNumber(a && a.sessions, b && b.sessions, typeDir);
          else if (typeBy === 'rev') primary = cmpNullableNumber(a && a.revenueGbp, b && b.revenueGbp, typeDir);
          return primary ||
            cmpNullableNumber(a && a.revenueGbp, b && b.revenueGbp, 'desc') ||
            cmpNullableNumber(a && a.orders, b && b.orders, 'desc') ||
            cmpNullableNumber(a && a.sessions, b && b.sessions, 'desc') ||
            cmpNullableText(typeLabel(a), typeLabel(b), 'asc');
        });

        var filteredGroups = groups.filter(function(g) {
          var s = (g && typeof g.sessions === 'number') ? g.sessions : 0;
          var o = (g && typeof g.orders === 'number') ? g.orders : 0;
          return s >= 1 || o >= 1;
        });
        if (!filteredGroups.length) {
          body.innerHTML = '<div class="grid-row" role="row"><div class="grid-cell empty span-all" role="cell">No traffic types with sessions or sales.</div></div>';
          return;
        }
        let html = '';
        filteredGroups.forEach(function(g) {
          const device = (g && g.device != null) ? String(g.device).trim().toLowerCase() : '';
          const open = trafficTypeExpanded === null ? true : !!(device && trafficTypeExpanded && trafficTypeExpanded[device]);
          const label = escapeHtml((g && g.label) ? String(g.label) : (g && g.key ? String(g.key) : '—'));
          const cr = (g && typeof g.conversionPct === 'number') ? pct(g.conversionPct) : '—';
          const orders = (g && typeof g.orders === 'number') ? formatSessions(g.orders) : '—';
          const sessions = (g && typeof g.sessions === 'number') ? formatSessions(g.sessions) : '—';
          const rev = (g && typeof g.revenueGbp === 'number') ? formatRevenueTableHtml(g.revenueGbp) : '—';
          html += '<div class="grid-row traffic-type-parent" role="row" data-device="' + escapeHtml(device) + '">' +
            '<div class="grid-cell" role="cell">' +
              '<button type="button" class="traffic-type-toggle" data-device="' + escapeHtml(device) + '" aria-expanded="' + (open ? 'true' : 'false') + '">' +
                '<span class="tt-device-icon" aria-hidden="true">' + trafficTypeDeviceIcon(device) + '</span>' +
                '<span>' + label + '</span>' +
              '</button>' +
            '</div>' +
            '<div class="grid-cell" role="cell">' + escapeHtml(cr || '—') + '</div>' +
            '<div class="grid-cell" role="cell">' + escapeHtml(orders || '—') + '</div>' +
            '<div class="grid-cell" role="cell">' + escapeHtml(sessions || '—') + '</div>' +
            '<div class="grid-cell" role="cell">' + (rev || '—') + '</div>' +
          '</div>';

          const kids = (g && Array.isArray(g.children)) ? g.children.slice() : [];
          kids.sort(function(a, b) {
            var primary = 0;
            if (typeBy === 'type') primary = cmpNullableText(typeLabel(a), typeLabel(b), typeDir);
            else if (typeBy === 'cr') primary = cmpNullableNumber(a && a.conversionPct, b && b.conversionPct, typeDir);
            else if (typeBy === 'orders') primary = cmpNullableNumber(a && a.orders, b && b.orders, typeDir);
            else if (typeBy === 'sessions') primary = cmpNullableNumber(a && a.sessions, b && b.sessions, typeDir);
            else if (typeBy === 'rev') primary = cmpNullableNumber(a && a.revenueGbp, b && b.revenueGbp, typeDir);
            return primary ||
              cmpNullableNumber(a && a.revenueGbp, b && b.revenueGbp, 'desc') ||
              cmpNullableNumber(a && a.orders, b && b.orders, 'desc') ||
              cmpNullableNumber(a && a.sessions, b && b.sessions, 'desc') ||
              cmpNullableText(typeLabel(a), typeLabel(b), 'asc');
          });
          kids.forEach(function(c) {
            const clabel = escapeHtml((c && c.label) ? String(c.label) : (c && c.platform ? String(c.platform) : (c && c.key ? String(c.key) : '—')));
            const ccr = (c && typeof c.conversionPct === 'number') ? pct(c.conversionPct) : '—';
            const corders = (c && typeof c.orders === 'number') ? formatSessions(c.orders) : '—';
            const csessions = (c && typeof c.sessions === 'number') ? formatSessions(c.sessions) : '—';
            const crev = (c && typeof c.revenueGbp === 'number') ? formatRevenueTableHtml(c.revenueGbp) : '—';
            html += '<div class="grid-row traffic-type-child' + (open ? '' : ' is-hidden') + '" role="row" data-parent="' + escapeHtml(device) + '">' +
              '<div class="grid-cell" role="cell">' + clabel + '</div>' +
              '<div class="grid-cell" role="cell">' + escapeHtml(ccr || '—') + '</div>' +
              '<div class="grid-cell" role="cell">' + escapeHtml(corders || '—') + '</div>' +
              '<div class="grid-cell" role="cell">' + escapeHtml(csessions || '—') + '</div>' +
              '<div class="grid-cell" role="cell">' + (crev || '—') + '</div>' +
            '</div>';
          });
        });
        body.innerHTML = html;
      })();

      updateSortHeadersInContainer(document.getElementById('traffic-sources-table'), srcBy, srcDir);
      updateSortHeadersInContainer(document.getElementById('traffic-types-table'), typeBy, typeDir);
    }

    function renderTrafficPickers(data) {
      function renderPicker(containerId, available, enabled, onChange) {
        const el = document.getElementById(containerId);
        if (!el) return;
        const have = new Set((enabled || []).map(function(k) { return String(k || '').trim().toLowerCase(); }).filter(Boolean));
        const list = Array.isArray(available) ? available.slice() : [];
        if (!list.length) {
          el.innerHTML = '<div class="dm-def-note">No items yet.</div>';
          return;
        }
        let html = '';
        list.forEach(function(item) {
          const key = item && item.key != null ? String(item.key).trim().toLowerCase() : '';
          if (!key) return;
          const label = escapeHtml(item.label != null ? String(item.label) : key);
          const checked = have.has(key);
          const meta = (item && typeof item.sessions === 'number') ? (formatSessions(item.sessions) + ' sessions') : '';
          html += '<label class="traffic-picker-item">' +
            '<input type="checkbox" data-key="' + key + '"' + (checked ? ' checked' : '') + ' />' +
            '<span>' + label + '</span>' +
            (meta ? ('<span class="traffic-picker-meta">' + escapeHtml(meta) + '</span>') : '') +
            '</label>';
        });
        el.innerHTML = html;
        el.onchange = function(e) {
          const t = e && e.target ? e.target : null;
          if (!t || t.tagName !== 'INPUT') return;
          const keys = Array.from(el.querySelectorAll('input[type="checkbox"][data-key]:checked'))
            .map(function(inp) { return (inp.getAttribute('data-key') || '').trim(); })
            .filter(Boolean);
          onChange(keys);
        };
      }

      renderPicker(
        'traffic-sources-picker',
        data && data.sources ? data.sources.available : [],
        data && data.sources ? data.sources.enabled : [],
        function(keys) { saveTrafficPrefs({ sourcesEnabled: keys }); }
      );
      renderPicker(
        'traffic-types-picker',
        data && data.types ? data.types.available : [],
        data && data.types ? data.types.enabled : [],
        function(keys) { saveTrafficPrefs({ typesEnabled: keys }); }
      );
    }

    function renderTraffic(data) {
      trafficCache = data || trafficCache || null;
      renderTrafficTables(trafficCache);
      renderTrafficPickers(trafficCache);
    }

    function fetchTrafficData(options = {}) {
      const force = !!options.force;
      let url = API + '/api/traffic?range=' + encodeURIComponent(getStatsRange());
      if (force) url += (url.indexOf('?') >= 0 ? '&' : '?') + '_=' + Date.now();
      const cacheMode = force ? 'no-store' : 'default';
      return fetchWithTimeout(url, { credentials: 'same-origin', cache: cacheMode }, 25000)
        .then(function(r) {
          if (!r.ok) throw new Error('Traffic HTTP ' + r.status);
          return r.json();
        })
        .then(function(data) {
          lastTrafficFetchedAt = Date.now();
          renderTraffic(data && typeof data === 'object' ? data : null);
          return data;
        })
        .catch(function(err) {
          console.error(err);
          renderTraffic(trafficCache || null);
          return null;
        });
    }

    function refreshTraffic(options = {}) {
      const force = !!options.force;
      if (trafficRefreshInFlight) return trafficRefreshInFlight;

      const build = startReportBuild({ key: 'traffic', overlayId: 'traffic-loading-overlay', stepId: 'traffic-build-step' });
      build.step('building channels...');
      trafficRefreshInFlight = fetchTrafficData({ force })
        .then(function(data) {
          build.step('building channels... done');
          return delay(180).then(function() {
            build.step('building traffic...');
            return delay(120).then(function() {
              build.step('building traffic... done');
              return delay(180).then(function() { return data; });
            });
          });
        })
        .finally(function() {
          trafficRefreshInFlight = null;
          build.finish();
        });
      return trafficRefreshInFlight;
    }

    function saveTrafficPrefs(payload) {
      if (!payload || typeof payload !== 'object') return Promise.resolve(null);
      return fetch(API + '/api/traffic-prefs', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'same-origin',
        cache: 'no-store',
        body: JSON.stringify(payload),
      })
        .then(function(r) { return r.ok ? r.json() : null; })
        .then(function(json) {
          if (!json || json.ok !== true) return null;
          // Re-fetch so tables match new enabled selections.
          refreshTraffic({ force: true });
          return json;
        })
        .catch(function(err) { console.error(err); return null; });
    }

    function sessionIdsEqual(a, b) {
      if (!a && !b) return true;
      if (!a || !b || a.length !== b.length) return false;
      for (var i = 0; i < a.length; i++) if (a[i].session_id !== b[i].session_id) return false;
      return true;
    }

    function fetchSessions() {
      if (liveRefreshInFlight) return liveRefreshInFlight;
      var overlay = document.getElementById('sessions-loading-overlay');
      if (overlay) overlay.classList.remove('is-hidden');
      var isLive = dateRange === 'live';
      var url;
      if (isLive) {
        url = API + '/api/sessions?filter=active&_=' + Date.now();
      } else {
        var limit = rowsPerPage;
        var offset = (currentPage - 1) * rowsPerPage;
        url = API + '/api/sessions?range=' + encodeURIComponent(dateRange) + '&limit=' + limit + '&offset=' + offset + '&timezone=' + encodeURIComponent(tz) + '&_=' + Date.now();
      }
      liveRefreshInFlight = fetch(url, { credentials: 'same-origin', cache: 'no-store' })
        .then(function(r) {
          if (!r.ok) {
            sessionsLoadError = r.status === 502 ? 'Server error (502). Try again or refresh.' : 'Server error (' + r.status + ').';
            sessions = [];
            sessionsTotal = null;
            renderTable();
            return null;
          }
          return r.json();
        })
        .then(function(data) {
          if (data == null) return null;
          sessionsLoadError = null;
          if (isLive) {
            sessionsTotal = null;
            var next = data.sessions || [];
            var cutoff = Date.now() - ACTIVE_WINDOW_MS;
            var arrivedCutoff = Date.now() - ARRIVED_WINDOW_MS;
            next = next.filter(function(s) {
              return (s.last_seen != null && s.last_seen >= cutoff) &&
                (s.started_at != null && s.started_at >= arrivedCutoff);
            });
            next.sort(function(a, b) { return (b.last_seen || 0) - (a.last_seen || 0); });
            var listChanged = !sessionIdsEqual(sessions, next);
            sessions = next;
            if (listChanged) currentPage = 1;
          } else {
            sessions = data.sessions || [];
            sessionsTotal = typeof data.total === 'number' ? data.total : sessions.length;
          }
          lastSessionsMode = isLive ? 'live' : 'range';
          lastSessionsFetchedAt = Date.now();
          if (isLive) nextLiveAt = Date.now() + LIVE_REFRESH_MS;
          else if (dateRange === 'today' || dateRange === 'sales' || dateRange === '1h') nextRangeAt = Date.now() + RANGE_REFRESH_MS;
          lastUpdateTime = new Date();
          updateServerTimeDisplay();
          renderTable();
          updateKpis();
          return sessions;
        })
        .catch(function() { sessionsLoadError = 'Could not load sessions. Check connection or refresh.'; sessions = []; sessionsTotal = null; currentPage = 1; renderTable(); return null; })
        .finally(function() {
          liveRefreshInFlight = null;
          if (overlay) overlay.classList.add('is-hidden');
        });
      return liveRefreshInFlight;
    }

    function fetchOnlineCount() {
      if (onlineCountInFlight) return;
      onlineCountInFlight = true;
      fetch(API + '/api/sessions?filter=active&countOnly=1&_=' + Date.now(), { credentials: 'same-origin', cache: 'no-store' })
        .then(function(r) { return r.ok ? r.json() : null; })
        .then(function(data) {
          if (data != null && typeof data.count === 'number') {
            lastOnlineCount = data.count;
          }
        })
        .catch(function() {})
        .then(function() {
          onlineCountInFlight = false;
          updateKpis();
        });
    }

    function updateKpis() {
      const el = document.getElementById('online-count');
      const spinner = document.getElementById('online-count-spinner');
      if (!el) return;
      function showSpinner() {
        if (spinner) spinner.classList.remove('is-hidden');
        el.classList.add('is-hidden');
      }
      function showCount(n) {
        if (spinner) spinner.classList.add('is-hidden');
        el.classList.remove('is-hidden');
        el.textContent = String(n);
      }
      if (dateRange === 'live') {
        if (lastSessionsMode !== 'live') {
          showSpinner();
          fetchSessions();
          return;
        }
        const active = sessions.filter(s => s.last_seen >= Date.now() - ACTIVE_WINDOW_MS).length;
        showCount(active);
        return;
      }
      // Online is real people online right now; show count regardless of date range (Today, Yesterday, etc.)
      if (lastOnlineCount != null) {
        showCount(lastOnlineCount);
      } else {
        showSpinner();
        fetchOnlineCount();
      }
    }

    function cfSection(title, value) {
      const v = value != null && String(value).trim() !== '' ? String(value).trim() : null;
      const cls = v ? 'cf-row' : 'cf-row empty';
      return '<div class="' + cls + '"><strong>' + escapeHtml(title) + ':</strong> ' + (v ? escapeHtml(v) : '\u2014') + '</div>';
    }

    function buildSidePanelCf(session) {
      const s = session || {};
      const blocks = [
        ['Country & Device', cfSection('Country', s.cf_country || s.country_code) + cfSection('Device', s.device)],
        ['Referrer / Entry', cfSection('Referrer', s.referrer) + cfSection('Entry URL', s.entry_url)],
        ['Colo / ASN', cfSection('Colo', s.cf_colo) + cfSection('ASN', s.cf_asn)],
        ['Bot', cfSection('Known bot', s.cf_known_bot != null ? (s.cf_known_bot === 1 ? 'Yes' : 'No') : null) + cfSection('Verified bot category', s.cf_verified_bot_category)],
        ['City', cfSection('City', null)]
      ];
      return blocks.map(function (b) { return '<div class="side-panel-cf-block"><div class="side-panel-cf-subtitle">' + escapeHtml(b[0]) + '</div>' + b[1] + '</div>'; }).join('');
    }

    function openSidePanel(sessionId) {
      const panel = document.getElementById('side-panel');
      panel.classList.remove('is-hidden');
      document.getElementById('side-events').innerHTML = '<li class="muted">Loading\u2026</li>';
      document.getElementById('side-meta').innerHTML = '<div class="side-panel-detail-row"><span class="side-panel-value muted">Loading\u2026</span></div>';
      const sideSourceEl = document.getElementById('side-source');
      if (sideSourceEl) sideSourceEl.textContent = '';
      document.getElementById('side-cf').innerHTML = '';
      fetch(API + '/api/sessions/' + encodeURIComponent(sessionId) + '/events?limit=20')
        .then(r => r.json())
        .then(data => {
          const session = sessions.find(s => s.session_id === sessionId) || {};
          const saleBlock = session.has_purchased
            ? '<div class="side-panel-sale"><strong>Sale</strong><br>Order: ' + escapeHtml(formatMoney(session.order_total, session.order_currency) || '\u2014') + (session.purchased_at ? '<br>Purchased: ' + formatTs(session.purchased_at) : '') + '</div>'
            : '';
          const mainBase = getMainBaseUrl();
          const eventList = (data.events || []).filter(e => e.type !== 'heartbeat').reverse();
          const eventsHtml = eventList.map(e => {
            var path = (e.path || '').trim();
            if (!path && e.product_handle) path = '/products/' + (e.product_handle || '');
            if (path && !path.startsWith('/')) path = '/' + path;
            var pathLabel = path ? (friendlyLabelFromPath(path) || path) : (e.product_handle || '');
            var fullUrl = mainBase && path ? mainBase + path : '';
            var thumb = fullUrl ? '<img class="landing-thumb" src="' + (API || '') + '/api/og-thumb?url=' + encodeURIComponent(fullUrl) + '&width=100' + '" alt="" onerror="this.classList.add(\'is-hidden\')">' : '';
            var text = formatTs(e.ts) + ' ' + escapeHtml(e.type) + ' ' + escapeHtml(pathLabel) + (e.qty_delta != null ? ' \u0394' + e.qty_delta : '');
            return '<li>' + thumb + '<span>' + text + '</span></li>';
          }).join('');
          document.getElementById('side-events').innerHTML = eventsHtml || '<li class="muted">No events</li>';
          const metaRows = [
            ['Session', sessionId],
            ['Visitor', session.visitor_id || '\u2014'],
            ['Started', formatTs(session.started_at)],
            ['Seen', formatTs(session.last_seen)],
            ['Cart qty', String(session.cart_qty ?? 0)]
          ].map(function (r) { return '<div class="side-panel-detail-row"><span class="side-panel-label">' + escapeHtml(r[0]) + '</span><span class="side-panel-value">' + escapeHtml(String(r[1])) + '</span></div>'; }).join('');
          var startedMs = session.started_at != null ? Number(session.started_at) : 0;
          var seenMs = session.last_seen != null ? Number(session.last_seen) : 0;
          var gapHours = (seenMs - startedMs) / (60 * 60 * 1000);
          var openTabHint = (gapHours >= 1) ? '<div class="side-panel-detail-row muted side-panel-hint">If Started and Seen are many hours apart, the visitor likely left the tab open; we receive a heartbeat every 30s which updates Seen.</div>' : '';
          document.getElementById('side-meta').innerHTML = metaRows + openTabHint + (saleBlock ? saleBlock : '');
          if (sideSourceEl) sideSourceEl.textContent = sourceDetailForPanel(session);
          document.getElementById('side-cf').innerHTML = buildSidePanelCf(session);
        })
        .catch(() => {
          document.getElementById('side-events').innerHTML = '<li class="muted">Failed to load.</li>';
          document.getElementById('side-meta').innerHTML = '<div class="side-panel-detail-row"><span class="side-panel-value muted">Failed to load.</span></div>';
        });
    }

    document.getElementById('side-close').addEventListener('click', () => {
      document.getElementById('side-panel').classList.add('is-hidden');
    });

    document.getElementById('pagination-prev').addEventListener('click', function() {
      if (currentPage <= 1) return;
      currentPage--;
      if (sessionsTotal != null) fetchSessions(); else renderTable();
    });
    document.getElementById('pagination-next').addEventListener('click', function() {
      const totalPages = sessionsTotal != null
        ? Math.max(1, Math.ceil(sessionsTotal / rowsPerPage))
        : Math.max(1, Math.ceil(getSortedSessions().length / rowsPerPage));
      if (currentPage >= totalPages) return;
      currentPage++;
      if (sessionsTotal != null) fetchSessions(); else renderTable();
    });

    setupSortableHeaders();
    setupBestSellersSort();
    setupAllTableSorts();

    (function initTopTablePagination() {
      function bind(prefix, onPrev, onNext) {
        const prev = document.getElementById(prefix + '-prev');
        const next = document.getElementById(prefix + '-next');
        if (prev) prev.addEventListener('click', function() { onPrev(); });
        if (next) next.addEventListener('click', function() { onNext(); });
      }
      bind('country',
        function() { countryPage = Math.max(1, countryPage - 1); renderCountry(statsCache); },
        function() { countryPage = countryPage + 1; renderCountry(statsCache); }
      );
      bind('best-geo-products',
        function() { bestGeoProductsPage = Math.max(1, bestGeoProductsPage - 1); renderBestGeoProducts(statsCache); },
        function() { bestGeoProductsPage = bestGeoProductsPage + 1; renderBestGeoProducts(statsCache); }
      );
      bind('best-sellers',
        function() { bestSellersPage = Math.max(1, bestSellersPage - 1); fetchBestSellers(); },
        function() { bestSellersPage = bestSellersPage + 1; fetchBestSellers(); }
      );
      bind('best-variants',
        function() { bestVariantsPage = Math.max(1, bestVariantsPage - 1); fetchBestVariants(); },
        function() { bestVariantsPage = bestVariantsPage + 1; fetchBestVariants(); }
      );
      bind('breakdown-aov',
        function() { breakdownAovPage = Math.max(1, breakdownAovPage - 1); renderAov(statsCache); },
        function() { breakdownAovPage = breakdownAovPage + 1; renderAov(statsCache); }
      );
      bind('breakdown-title',
        function() { breakdownTitlePage = Math.max(1, breakdownTitlePage - 1); renderBreakdownTitles(leaderboardCache); },
        function() { breakdownTitlePage = breakdownTitlePage + 1; renderBreakdownTitles(leaderboardCache); }
      );
      bind('breakdown-finish',
        function() { breakdownFinishPage = Math.max(1, breakdownFinishPage - 1); renderBreakdownFinishes(finishesCache); },
        function() { breakdownFinishPage = breakdownFinishPage + 1; renderBreakdownFinishes(finishesCache); }
      );
      bind('breakdown-length',
        function() { breakdownLengthPage = Math.max(1, breakdownLengthPage - 1); renderBreakdownLengths(lengthsCache); },
        function() { breakdownLengthPage = breakdownLengthPage + 1; renderBreakdownLengths(lengthsCache); }
      );
      bind('breakdown-chainstyle',
        function() { breakdownChainStylePage = Math.max(1, breakdownChainStylePage - 1); renderBreakdownChainStyles(chainStylesCache); },
        function() { breakdownChainStylePage = breakdownChainStylePage + 1; renderBreakdownChainStyles(chainStylesCache); }
      );
    })();

    (function initRowsPerPageSelect() {
      // Rows-per-page UI is intentionally hidden; keep page size fixed at default.
      const sel = document.getElementById('rows-per-page-select');
      if (sel) sel.value = String(rowsPerPage);
    })();

    function getConfigStatusUrl(options = {}) {
      var url = API + '/api/config-status';
      try {
        var shop = getShopParam();
        if (!shop && typeof shopForSalesFallback === 'string' && shopForSalesFallback) shop = shopForSalesFallback;
        if (shop) url += (url.indexOf('?') >= 0 ? '&' : '?') + 'shop=' + encodeURIComponent(shop);
      } catch (_) {}
      if (options && options.force) {
        url += (url.indexOf('?') >= 0 ? '&' : '?') + '_=' + Date.now();
      }
      return url;
    }

    function getReconcileSalesUrl(options = {}) {
      var url = API + '/api/reconcile-sales?range=7d';
      try {
        var shop = getShopParam();
        if (!shop && typeof shopForSalesFallback === 'string' && shopForSalesFallback) shop = shopForSalesFallback;
        if (shop) url += (url.indexOf('?') >= 0 ? '&' : '?') + 'shop=' + encodeURIComponent(shop);
      } catch (_) {}
      if (options && options.force) {
        url += (url.indexOf('?') >= 0 ? '&' : '?') + '_=' + Date.now();
      }
      return url;
    }

    function reconcileSalesTruth(options = {}) {
      const btn = document.getElementById('config-reconcile-btn');
      if (btn) {
        btn.classList.add('spinning');
        btn.disabled = true;
      }
      const p = fetch(getReconcileSalesUrl({ force: true }), {
        method: 'POST',
        credentials: 'same-origin',
        cache: 'no-store',
      })
        .then(r => r.json())
        .then(() => {
          try { refreshConfigStatus({ force: true, preserveView: true }); } catch (_) {}
          try { fetchTrafficData({ force: true }); } catch (_) {}
        })
        .catch(() => {
          // Best-effort: diagnostics panel already handles refresh errors.
        })
        .finally(() => {
          if (btn) {
            btn.classList.remove('spinning');
            btn.disabled = false;
          }
        });
      return p;
    }

    var activeDiagTabKey = 'sales';

    function isConfigModalOpen() {
      try {
        const m = document.getElementById('config-modal');
        return !!(m && m.classList && m.classList.contains('open'));
      } catch (_) {
        return false;
      }
    }

    function refreshConfigStatus(options = {}) {
      if (configStatusRefreshInFlight && !options.force) return configStatusRefreshInFlight;
      const refreshBtn = document.getElementById('config-refresh-btn');
      const configStatusEl = document.getElementById('config-status');
      const compareModalEl = document.getElementById('kpi-compare-modal');
      const compareRefreshBtn = document.getElementById('kpi-compare-refresh-btn');
      const compareStatusEl = document.getElementById('kpi-compare-status');
      const compareUpdatedEl = document.getElementById('kpi-compare-updated');
      const compareKickerEl = document.getElementById('kpi-compare-kicker');
      const compareOpen = !!(compareModalEl && compareModalEl.classList.contains('open'));
      const preserveView = !!(options && options.preserveView);
      const modalCardEl = preserveView ? document.querySelector('#config-modal .config-modal-card') : null;
      const prevModalScrollTop = (preserveView && modalCardEl) ? (modalCardEl.scrollTop || 0) : 0;
      if (configStatusEl && !preserveView) {
        configStatusEl.innerHTML = '<div class="dm-loading-spinner"><div class="report-build-wrap"><div class="spinner"></div><div class="report-build-title">building diagnostics</div><div class="report-build-step">—</div></div></div>';
      }
      if (compareOpen && compareStatusEl) compareStatusEl.innerHTML = '<div class="kpi-compare-loading"><div class="report-build-wrap"><div class="spinner"></div><div class="report-build-title">building KPI comparison</div><div class="report-build-step">—</div></div></div>';

      if (refreshBtn) refreshBtn.classList.add('spinning');
      if (compareOpen && compareRefreshBtn) compareRefreshBtn.classList.add('spinning');
      const p = fetch(getConfigStatusUrl({ force: !!options.force }), { credentials: 'same-origin', cache: 'no-store' })
        .then(r => r.json())
        .then(c => {
          function code(value) { return '<code>' + escapeHtml(value == null ? '' : String(value)) + '</code>'; }
          function pill(text, tone) {
            const t = (tone === 'bad' || tone === 'warn') ? tone : 'ok';
            return '<span class="diag-pill ' + t + '">' + escapeHtml(String(text || '')) + '</span>';
          }
          function kv(label, valueHtml) {
            return '<div class="diag-kv"><div class="k">' + escapeHtml(label) + '</div><div class="v">' + valueHtml + '</div></div>';
          }
          function icon(name, cls) {
            const k = cls ? (' class="' + cls + '"') : '';
            if (name === 'shield') {
              return '<svg' + k + ' viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>';
            }
            if (name === 'columns') {
              return '<svg' + k + ' viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M12 3v18"/><path d="M3 4h18v16H3z"/></svg>';
            }
            if (name === 'list') {
              return '<svg' + k + ' viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>';
            }
            if (name === 'bag') {
              return '<svg' + k + ' viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/><path d="M16 10a4 4 0 0 1-8 0"/></svg>';
            }
            if (name === 'activity') {
              return '<svg' + k + ' viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>';
            }
            if (name === 'bar') {
              return '<svg' + k + ' viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>';
            }
            if (name === 'server') {
              return '<svg' + k + ' viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><rect x="2" y="2" width="20" height="8" rx="2" ry="2"/><rect x="2" y="14" width="20" height="8" rx="2" ry="2"/><line x1="6" y1="6" x2="6.01" y2="6"/><line x1="6" y1="18" x2="6.01" y2="18"/></svg>';
            }
            if (name === 'key') {
              return '<svg' + k + ' viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M21 2l-2 2m-7.5 7.5a4.5 4.5 0 1 1 0-6.36A4.5 4.5 0 0 1 11.5 11.5z"/><path d="M15 7l4 4"/><path d="M13 9l2 2"/></svg>';
            }
            if (name === 'link') {
              return '<svg' + k + ' viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>';
            }
            if (name === 'chev') {
              return '<svg' + k + ' viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><polyline points="6 9 12 15 18 9"/></svg>';
            }
            return '';
          }
          function fmtSessions(n) { return (typeof n === 'number' && isFinite(n)) ? escapeHtml(formatSessions(n)) : '\u2014'; }
          function fmtRevenue(n) { return (typeof n === 'number' && isFinite(n)) ? escapeHtml(formatRevenue(n)) : '\u2014'; }
          function fmtTsMaybe(ms) { return (typeof ms === 'number' && isFinite(ms)) ? escapeHtml(formatTs(ms)) : '\u2014'; }
          function fmtPct(p) {
            if (typeof p !== 'number' || !isFinite(p)) return '\u2014';
            const s = (Math.round(p * 100) / 100).toFixed(2).replace(/\.?0+$/, '');
            return escapeHtml(s + '%');
          }
          function fmtSigned(n, fmtAbsFn, unitSuffix) {
            if (typeof n !== 'number' || !isFinite(n)) return '\u2014';
            const sign = n > 0 ? '+' : (n < 0 ? '-' : '');
            const abs = Math.abs(n);
            const core = fmtAbsFn ? fmtAbsFn(abs) : String(abs);
            return escapeHtml(sign + core + (unitSuffix || ''));
          }

          const app = c && c.app ? c.app : {};
          const shopify = c && c.shopify ? c.shopify : {};
          const db = c && c.db ? c.db : {};
          const ingest = c && c.ingest ? c.ingest : {};
          const reporting = c && c.reporting ? c.reporting : {};
          const traffic = c && c.traffic ? c.traffic : {};
          const sales = c && c.sales ? c.sales : {};
          const truth = sales && sales.truth ? sales.truth : {};
          const truthToday = truth && truth.today ? truth.today : {};
          const health = truth && truth.health ? truth.health : {};
          const evidenceToday = sales && sales.evidence && sales.evidence.today ? sales.evidence.today : {};
          const driftOrders = sales && sales.drift && typeof sales.drift.orders === 'number' ? sales.drift.orders : null;
          const pixelDerivedToday = sales && sales.pixel && sales.pixel.today ? sales.pixel.today : {};
          const pixelDerivedOrders = (typeof pixelDerivedToday.orderCount === 'number') ? pixelDerivedToday.orderCount : null;
          const pixelDerivedRevenue = (typeof pixelDerivedToday.revenueGbp === 'number') ? pixelDerivedToday.revenueGbp : null;
          const driftPixelOrders = sales && sales.drift && typeof sales.drift.pixelVsTruthOrders === 'number' ? sales.drift.pixelVsTruthOrders : null;
          const driftPixelRevenue = sales && sales.drift && typeof sales.drift.pixelVsTruthRevenueGbp === 'number' ? sales.drift.pixelVsTruthRevenueGbp : null;
          const missingEvidenceToday = sales && sales.missingEvidence && sales.missingEvidence.today ? sales.missingEvidence.today : {};
          const missingEvidenceCount = (missingEvidenceToday && typeof missingEvidenceToday.missingOrderCount === 'number')
            ? missingEvidenceToday.missingOrderCount
            : null;
          const missingEvidenceSample = (missingEvidenceToday && Array.isArray(missingEvidenceToday.missingOrdersSample))
            ? missingEvidenceToday.missingOrdersSample
            : [];
          const missingEvidenceNote = (missingEvidenceToday && typeof missingEvidenceToday.note === 'string')
            ? missingEvidenceToday.note
            : '';
          const pixel = c && c.pixel ? c.pixel : {};
          const appSettings = c && c.settings ? c.settings : {};
          const trackerDefinitions = c && c.trackerDefinitions ? c.trackerDefinitions : null;
          const pixelSessionMode = (appSettings && appSettings.pixelSessionMode != null)
            ? String(appSettings.pixelSessionMode).trim().toLowerCase()
            : 'legacy';
          const sharedSessionFixEnabled = pixelSessionMode === 'shared_ttl';

          const truthOrders = (typeof truthToday.orderCount === 'number') ? truthToday.orderCount : null;
          const truthRevenue = (typeof truthToday.revenueGbp === 'number') ? truthToday.revenueGbp : null;
          const truthCheckoutOrders = (typeof truthToday.checkoutOrderCount === 'number') ? truthToday.checkoutOrderCount : null;
          const truthCheckoutRevenue = (typeof truthToday.checkoutRevenueGbp === 'number') ? truthToday.checkoutRevenueGbp : null;
          const truthReturningCustomers = (typeof truthToday.returningCustomerCount === 'number') ? truthToday.returningCustomerCount : null;
          const truthReturningRevenue = (typeof truthToday.returningRevenueGbp === 'number') ? truthToday.returningRevenueGbp : null;
          const evTotal = (typeof evidenceToday.checkoutCompleted === 'number') ? evidenceToday.checkoutCompleted : null;
          const evSessions = (typeof evidenceToday.checkoutCompletedSessions === 'number') ? evidenceToday.checkoutCompletedSessions : null;
          const evLinked = (typeof evidenceToday.linked === 'number') ? evidenceToday.linked : null;
          const evUnlinked = (typeof evidenceToday.unlinked === 'number') ? evidenceToday.unlinked : null;
          const staleSec = (health && typeof health.staleMs === 'number') ? Math.round(health.staleMs / 1000) : null;

          const SHOPIFY_LOGO_URL = 'https://cdn.shopify.com/s/files/1/0847/7261/8587/files/shopify.png?v=1770259752';
          const KEXO_LOGO_URL = '/assets/kexo_logo_fullcolor.webp';

          const shopifySessionsToday = (traffic && typeof traffic.shopifySessionsToday === 'number') ? traffic.shopifySessionsToday : null;
          const shopifyConversionRateToday = (traffic && typeof traffic.shopifyConversionRateToday === 'number') ? traffic.shopifyConversionRateToday : null;
          const shopifyConversionRateNote = (traffic && typeof traffic.shopifyConversionRateTodayNote === 'string') ? traffic.shopifyConversionRateTodayNote : '';
          const kexoSessionsToday = (traffic && traffic.today && typeof traffic.today.humanSessions === 'number') ? traffic.today.humanSessions :
            (traffic && traffic.today && typeof traffic.today.sessionsReachedApp === 'number') ? traffic.today.sessionsReachedApp : null;
          const botsBlockedToday = (traffic && traffic.today && typeof traffic.today.botsBlockedAtEdge === 'number') ? traffic.today.botsBlockedAtEdge : null;
          const botsBlockedUpdatedAt = (traffic && traffic.today && typeof traffic.today.botsBlockedAtEdgeUpdatedAt === 'number') ? traffic.today.botsBlockedAtEdgeUpdatedAt : null;

          // Conversion rate used across Kexo tables: truth orders / sessions.
          // Prefer checkout-token truth orders (online-store proxy) when available.
          const convertedOrdersForCr = (truthCheckoutOrders != null ? truthCheckoutOrders : truthOrders);
          const shopifyCr = (shopifyConversionRateToday != null)
            ? shopifyConversionRateToday
            : ((convertedOrdersForCr != null && shopifySessionsToday != null && shopifySessionsToday > 0)
              ? (convertedOrdersForCr / shopifySessionsToday) * 100
              : null);
          const kexoCr = (convertedOrdersForCr != null && kexoSessionsToday != null && kexoSessionsToday > 0) ? (convertedOrdersForCr / kexoSessionsToday) * 100 : null;
          const shopifyCrSource = (shopifyConversionRateToday != null)
            ? 'traffic.shopifyConversionRateToday (ShopifyQL conversion_rate)'
            : 'computed: truth orders / Shopify sessions (fallback)';

          const driftPixelCheckoutOrders = (truthCheckoutOrders != null && pixelDerivedOrders != null) ? (pixelDerivedOrders - truthCheckoutOrders) : null;
          const driftPixelCheckoutRevenue = (truthCheckoutRevenue != null && pixelDerivedRevenue != null)
            ? (Math.round((pixelDerivedRevenue - truthCheckoutRevenue) * 100) / 100)
            : null;
          const driftEvidenceCheckoutOrders = (truthCheckoutOrders != null && evTotal != null) ? (evTotal - truthCheckoutOrders) : null;

          const sessionsDiff = (shopifySessionsToday != null && kexoSessionsToday != null) ? (shopifySessionsToday - kexoSessionsToday) : null;
          const crDiff = (shopifyCr != null && kexoCr != null) ? (shopifyCr - kexoCr) : null;

          const storedScopesStr = (shopify && shopify.storedScopes) ? String(shopify.storedScopes) : '';
          const serverScopesStr = (shopify && shopify.serverScopes) ? String(shopify.serverScopes) : '';
          const storedScopes = storedScopesStr ? storedScopesStr.split(',').map(s => s.trim()).filter(Boolean) : [];
          const serverScopes = serverScopesStr ? serverScopesStr.split(',').map(s => s.trim()).filter(Boolean) : [];
          const missingScopes = (storedScopes.length && serverScopes.length) ? serverScopes.filter(s => storedScopes.indexOf(s) === -1) : [];

          const pixelIngestUrl = (pixel && pixel.ingestUrl != null) ? String(pixel.ingestUrl) : '';
          const expectedIngestUrl = (ingest && ingest.effectiveIngestUrl != null) ? String(ingest.effectiveIngestUrl) : '';
          const ingestUrlMatch = (pixelIngestUrl && expectedIngestUrl) ? (pixelIngestUrl === expectedIngestUrl) : null;

          function diffCell(text, cls) {
            const c = cls ? (' ' + cls) : '';
            return '<span class="' + c.trim() + '">' + escapeHtml(text) + '</span>';
          }

          function renderTrackerDefinitions(defs) {
            if (!defs || !Array.isArray(defs.tables)) {
              return '<div class="dm-def-note">No tracker definitions available from server.</div>';
            }

            function pill2(text, tone) {
              const t = (tone === 'bad' || tone === 'warn') ? tone : 'ok';
              return '<span class="dm-pill dm-pill-' + t + '">' + escapeHtml(String(text || '')) + '</span>';
            }
            function code2(value) {
              return '<code class="dm-code">' + escapeHtml(value == null ? '' : String(value)) + '</code>';
            }
            function line2(label, valueHtml) {
              return (
                '<div class="dm-row-kv">' +
                  '<div class="dm-k">' + escapeHtml(label) + '</div>' +
                  '<div class="dm-v">' + (valueHtml || '\u2014') + '</div>' +
                '</div>'
              );
            }
            function sectionTitle2(text) {
              return '<div class="dm-def-section-title">' + escapeHtml(text) + '</div>';
            }

            const ver = (defs.version != null) ? String(defs.version) : '';
            const last = (defs.lastUpdated != null) ? String(defs.lastUpdated) : '';
            const note = defs.note ? String(defs.note) : '';
            const defsTables = Array.isArray(defs.tables) ? defs.tables : [];

            const byPage = {};
            for (const d of defsTables) {
              const p = (d && d.page) ? String(d.page) : 'Other';
              if (!byPage[p]) byPage[p] = [];
              byPage[p].push(d);
            }

            const preferredOrder = ['Home', 'Overview', 'Countries', 'Products', 'Traffic', 'Diagnostics', 'Other'];
            const pages = Object.keys(byPage || {});
            pages.sort(function(a, b) {
              const ia = preferredOrder.indexOf(a);
              const ib = preferredOrder.indexOf(b);
              if (ia === -1 && ib === -1) return String(a).localeCompare(String(b));
              if (ia === -1) return 1;
              if (ib === -1) return -1;
              return ia - ib;
            });

            let out = '';
            out += '<div class="dm-def-root">';
            const metaBits = [];
            if (ver) metaBits.push('v' + ver);
            if (last) metaBits.push('Last updated ' + last);
            if (metaBits.length) out += '<div class="dm-def-meta">' + escapeHtml(metaBits.join(' · ')) + '</div>';
            if (note) out += '<div class="dm-def-note">' + escapeHtml(note) + '</div>';

            if (!pages.length) {
              out += '<div class="dm-def-note">No definitions found.</div>';
              out += '</div>';
              return out;
            }

            for (const page of pages) {
              const list = Array.isArray(byPage[page]) ? byPage[page].slice() : [];
              list.sort(function(a, b) { return String((a && a.name) || '').localeCompare(String((b && b.name) || '')); });

              out += '<div class="dm-def-page-box">';
              out +=   '<div class="dm-def-page-title">' + escapeHtml(page) + '</div>';

              for (const d of list) {
                const id = (d && d.id) ? String(d.id) : '';
                const name = (d && d.name) ? String(d.name) : (id || 'Unnamed');
                const endpoint = (d && d.endpoint) ? d.endpoint : {};
                const method = endpoint && endpoint.method ? String(endpoint.method) : '';
                const path = endpoint && endpoint.path ? String(endpoint.path) : '';
                const params = (endpoint && Array.isArray(endpoint.params)) ? endpoint.params : [];
                const uiIds = (d && d.ui && Array.isArray(d.ui.elementIds)) ? d.ui.elementIds : [];
                const uiMissing = uiIds.filter(function(x) { return x && !document.getElementById(String(x)); });

                const checks = (d && d.checks) ? d.checks : {};
                const activeMissingTables = (checks && Array.isArray(checks.activeDbTablesMissing)) ? checks.activeDbTablesMissing : null;
                const missingTables = activeMissingTables != null
                  ? activeMissingTables
                  : ((checks && Array.isArray(checks.dbTablesMissing)) ? checks.dbTablesMissing : []);
                const dbOk = (missingTables.length === 0);
                const tokenOk = (checks && checks.shopifyTokenOk === true) || !(d && d.requires && d.requires.shopifyToken);
                const uiOk = (uiMissing.length === 0);
                const overallOk = dbOk && tokenOk && uiOk;

                const summaryBits = [];
                if (method && path) summaryBits.push(method + ' ' + path);
                if (params.length) summaryBits.push('params: ' + params.join(', '));
                if (!summaryBits.length && id) summaryBits.push(id);

                const chips = [];
                chips.push(overallOk ? pill2('OK', 'ok') : pill2('Check', (missingTables.length ? 'bad' : 'warn')));
                if (uiIds.length) chips.push(uiOk ? pill2('UI OK', 'ok') : pill2('UI missing', 'warn'));
                if (missingTables.length) chips.push(pill2('DB missing', 'bad'));
                if (d && d.requires && d.requires.shopifyToken) chips.push(tokenOk ? pill2('Token OK', 'ok') : pill2('Token missing', 'bad'));

                out += '<details class="dm-def-details">';
                out +=   '<summary>';
                out +=     '<div style="min-width:0;">';
                out +=       '<div class="dm-def-details-name">' + escapeHtml(name) + '</div>';
                out +=       '<div class="dm-def-details-sub">' + escapeHtml(summaryBits.join(' · ')) + '</div>';
                out +=     '</div>';
                out +=     '<div class="dm-def-details-chips">' + chips.join('') + '</div>';
                out +=   '</summary>';

                out +=   '<div class="dm-def-details-body">';
                if (id) out += line2('Id', code2(id));
                if (method && path) out += line2('Endpoint', code2(method + ' ' + path));
                if (params.length) out += line2('Params', code2(params.join(', ')));
                if (uiIds.length) out += line2('UI elementIds', code2(uiIds.join(', ')));
                if (uiMissing.length) out += line2('UI missing', code2(uiMissing.join(', ')));
                if (missingTables.length) out += line2('DB tables missing', code2(missingTables.join(', ')));
                if (d && d.requires && d.requires.shopifyToken) out += line2('Shopify token', tokenOk ? pill2('OK', 'ok') : pill2('Missing', 'bad'));

                const respects = (d && d.respectsReporting) ? d.respectsReporting : {};
                const rOrders = !!(respects && respects.ordersSource);
                const rSessions = !!(respects && respects.sessionsSource);
                const respectsBits = [];
                respectsBits.push('ordersSource ' + (rOrders ? 'YES' : 'NO'));
                respectsBits.push('sessionsSource ' + (rSessions ? 'YES' : 'NO'));
                const nowBits = [];
                if (rOrders && reporting && reporting.ordersSource) nowBits.push('ordersSource=' + reporting.ordersSource);
                if (rSessions && reporting && reporting.sessionsSource) nowBits.push('sessionsSource=' + reporting.sessionsSource);
                out += line2('Respects reporting', code2(respectsBits.join(' · ') + (nowBits.length ? (' · now ' + nowBits.join(', ')) : '')));

                const sources = (d && Array.isArray(d.sources)) ? d.sources : [];
                if (sources.length) {
                  out += sectionTitle2('Sources');
                  out += '<ul class="dm-def-list">';
                  for (const s of sources) {
                    const kind = (s && s.kind) ? String(s.kind) : 'source';
                    const st = (s && Array.isArray(s.tables)) ? s.tables : [];
                    const note2 = (s && s.note) ? String(s.note) : '';
                    let line = '<strong>' + escapeHtml(kind) + '</strong>';
                    if (st.length) line += ' · ' + escapeHtml(st.join(', '));
                    if (note2) line += ' — ' + escapeHtml(note2);
                    out += '<li>' + line + '</li>';
                  }
                  out += '</ul>';
                }

                const columns = (d && Array.isArray(d.columns)) ? d.columns : [];
                if (columns.length) {
                  out += sectionTitle2('Columns + math');
                  out += '<ul class="dm-def-list">';
                  for (const col of columns) {
                    const cn = (col && col.name) ? String(col.name) : 'Column';
                    const cv = (col && col.value != null) ? String(col.value) : '';
                    const cf = (col && col.formula != null) ? String(col.formula) : '';
                    let line = '<strong>' + escapeHtml(cn) + '</strong>';
                    if (cv) line += ' · ' + escapeHtml(cv);
                    if (cf) line += ' · <code class="dm-code">' + escapeHtml(cf) + '</code>';
                    out += '<li>' + line + '</li>';
                  }
                  out += '</ul>';
                }

                const math = (d && Array.isArray(d.math)) ? d.math : [];
                if (math.length) {
                  out += sectionTitle2('Notes');
                  out += '<ul class="dm-def-list">';
                  for (const m of math) {
                    const mn = (m && m.name) ? String(m.name) : 'Note';
                    const mv = (m && m.value != null) ? String(m.value) : '';
                    out += '<li><strong>' + escapeHtml(mn) + '</strong>' + (mv ? (' · ' + escapeHtml(mv)) : '') + '</li>';
                  }
                  out += '</ul>';
                }

                out +=   '</div>';
                out += '</details>';
              }

              out += '</div>';
            }

            out += '</div>';
            return out;
          }

          // --- New flattened, top-tab Diagnostics UI (inline-styled) ---
          const shopifyOrderRate = shopifyCr;
          const kexoOrderRate = kexoCr;
          const orderRateDiff = (shopifyOrderRate != null && kexoOrderRate != null) ? (shopifyOrderRate - kexoOrderRate) : null;

          const evidenceExpected = (truthCheckoutOrders != null ? truthCheckoutOrders : truthOrders);

          function pillInline(text, tone) {
            const t = (tone === 'bad' || tone === 'warn') ? tone : 'ok';
            return '<span class="dm-pill dm-pill-' + t + '">' + escapeHtml(String(text || '')) + '</span>';
          }
          function codeInline(value) {
            return '<code class="dm-code">' + escapeHtml(value == null ? '' : String(value)) + '</code>';
          }
          function card(title, bodyHtml) {
            const h = title ? ('<div class="dm-card-title">' + escapeHtml(title) + '</div>') : '';
            return '<div class="dm-card">' + h + (bodyHtml || '') + '</div>';
          }
          function brandHeader(name, iconUrl, subtitle, accentRgb) {
            const sub = subtitle ? ('<div class="dm-brand-sub">' + escapeHtml(subtitle) + '</div>') : '';
            return (
              '<div class="dm-brand-header">' +
                '<div class="dm-brand-header-inner">' +
                  '<img src="' + escapeHtml(String(iconUrl || '')) + '" alt="' + escapeHtml(String(name || '')) + '" class="dm-brand-icon" />' +
                  '<div style="min-width:0;line-height:1.1;">' +
                    '<div class="dm-brand-name">' + escapeHtml(String(name || '')) + '</div>' +
                    sub +
                  '</div>' +
                '</div>' +
              '</div>'
            );
          }
          function brandIconTiny(name, iconUrl, accentRgb) {
            return '<img src="' + escapeHtml(String(iconUrl || '')) + '" alt="' + escapeHtml(String(name || '')) + '" class="dm-brand-icon" />';
          }
          function metric(label, valueHtml) {
            return (
              '<div class="dm-metric">' +
                '<div class="dm-metric-label">' + escapeHtml(label) + '</div>' +
                '<div class="dm-metric-value">' + (valueHtml || '\u2014') + '</div>' +
              '</div>'
            );
          }
          function rowKV(label, valueHtml, noteHtml) {
            return (
              '<div class="dm-row-kv">' +
                '<div class="dm-k">' + escapeHtml(label) + '</div>' +
                '<div class="dm-v">' + (valueHtml || '\u2014') + '</div>' +
              '</div>' +
              (noteHtml ? ('<div class="dm-row-kv-note">' + noteHtml + '</div>') : '')
            );
          }
          function diffSpan(n, fmtAbsFn, unitSuffix) {
            if (typeof n !== 'number' || !isFinite(n)) return '\u2014';
            const abs = Math.abs(n);
            const sign = n > 0 ? '+' : (n < 0 ? '-' : '');
            const core = fmtAbsFn ? fmtAbsFn(abs) : String(abs);
            const tone = Math.abs(n) < 0.0001 ? 'ok' : 'warn';
            const text = sign + core + (unitSuffix || '');
            return pillInline(text, tone);
          }


          const headerMetaBits = [];
          if (shopify && shopify.shop) headerMetaBits.push('Shop ' + codeInline(shopify.shop));
          if (c && c.timeZone) headerMetaBits.push('TZ ' + codeInline(String(c.timeZone)));
          headerMetaBits.push('Updated ' + codeInline(formatTs(c && c.now ? c.now : Date.now())));

          const aiCopyGeneratedAt = new Date().toISOString();
          let aiCopyText = '';
          try {
            const convertedSessionsSource = (evSessions != null)
              ? 'sales.evidence.today.checkoutCompletedSessions'
              : (truthCheckoutOrders != null ? 'sales.truth.today.checkoutOrderCount (fallback)' : (truthOrders != null ? 'sales.truth.today.orderCount (fallback)' : 'unknown'));
            const aiPayload = {
              kind: 'kexo_diagnostics_v1',
              generatedAt: aiCopyGeneratedAt,
              page: {
                href: (typeof window !== 'undefined' && window.location) ? window.location.href : '',
              },
              browser: {
                userAgent: (typeof navigator !== 'undefined' && navigator.userAgent) ? navigator.userAgent : '',
                language: (typeof navigator !== 'undefined' && navigator.language) ? navigator.language : '',
              },
              aiNotes: [
                'Truth = Shopify Orders API cache (orders_shopify). This is authoritative.',
                'Evidence = Web Pixel checkout_completed events (purchase_events). Evidence < Truth usually means missing pixel events (consent/adblock/checkout surface) or non-storefront orders.',
                'Kexo derived = purchases built from evidence; if derived matches evidence, drift is upstream of purchases.',
                'Inspect rawConfigStatus.sales.missingEvidence.today.missingOrdersSample for a sample of truth orders missing evidence.',
              ],
              computed: {
                sessions: {
                  shopifyToday: shopifySessionsToday,
                  kexoHumanToday: kexoSessionsToday,
                  diff: sessionsDiff,
                },
                conversions: {
                  definition: 'Shopify CR% uses ShopifyQL conversion_rate; Kexo CR% uses truth orders / sessions * 100',
                  shopifyCrSource,
                  convertedSessionsSource,
                  shopifyCrPct: shopifyCr,
                  kexoCrPct: kexoCr,
                  crDiffPctPoints: crDiff,
                  ordersPerSessionPct: {
                    shopify: shopifyOrderRate,
                    kexo: kexoOrderRate,
                    diffPctPoints: orderRateDiff,
                  },
                },
                truth: {
                  ordersPaidToday: truthOrders,
                  revenueGbpToday: truthRevenue,
                  checkoutTokenOrdersPaidToday: truthCheckoutOrders,
                  checkoutTokenRevenueGbpToday: truthCheckoutRevenue,
                },
                pixelDerived: {
                  ordersToday: pixelDerivedOrders,
                  revenueGbpToday: pixelDerivedRevenue,
                },
                evidence: {
                  checkoutCompletedEventsToday: evTotal,
                  checkoutCompletedSessionsToday: evSessions,
                  linkedEventsToday: evLinked,
                  unlinkedEventsToday: evUnlinked,
                },
                drift: {
                  pixelVsTruthOrders: driftPixelOrders,
                  pixelVsTruthRevenueGbp: driftPixelRevenue,
                  evidenceVsCheckoutTokenOrders: driftEvidenceCheckoutOrders,
                },
                salesEvidence: {
                  evidenceCoveragePct: (truthCheckoutOrders != null && truthCheckoutOrders > 0 && evTotal != null) ? ((evTotal / truthCheckoutOrders) * 100) : null,
                  missingEvidenceOrderCount: missingEvidenceCount,
                  missingEvidenceSample: (missingEvidenceSample && missingEvidenceSample.length) ? missingEvidenceSample.slice(0, 25) : [],
                },
                pixel: {
                  shopifyWebPixelOk: (pixel && typeof pixel.ok === 'boolean') ? pixel.ok : null,
                  shopifyWebPixelInstalled: (pixel && typeof pixel.installed === 'boolean') ? pixel.installed : null,
                  pixelIngestUrl,
                  expectedIngestUrl,
                  ingestUrlMatch,
                },
                settings: {
                  pixelSessionMode,
                  sharedSessionFixEnabled,
                },
              },
              rawConfigStatus: c,
            };
            aiCopyText =
              'Kexo diagnostics (paste this for AI)\n' +
              'Generated: ' + aiCopyGeneratedAt + '\n' +
              (shopify && shopify.shop ? ('Shop: ' + shopify.shop + '\n') : '') +
              '\n```json\n' + JSON.stringify(aiPayload, null, 2) + '\n```\n';
          } catch (err) {
            aiCopyText = 'Kexo diagnostics (AI)\nGenerated: ' + aiCopyGeneratedAt + '\nError building payload: ' + (err && err.message ? String(err.message) : String(err)) + '\n';
          }

          const copyIcon = '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>';

          // SVG icons for tabs
          var tabIcons = {
            sales: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>',
            compare: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>',
            traffic: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>',
            pixel: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>',
            googleads: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.6 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>',
            shopify: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/><path d="M16 10a4 4 0 0 1-8 0"/></svg>',
            sources: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg>',
            system: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>',
            defs: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>'
          };

          function diagTab(key, label) {
            return '<button type="button" class="dm-tab-btn" data-diag-tab="' + escapeHtml(key) + '" aria-selected="false">' +
              (tabIcons[key] ? tabIcons[key] : '') +
              '<span>' + escapeHtml(label) + '</span>' +
            '</button>';
          }
          function diagTabPanel(key, innerHtml) {
            return '<div class="dm-tab-panel" data-diag-panel="' + escapeHtml(key) + '">' + (innerHtml || '') + '</div>';
          }

          let html = '';
          html += '<div id="be-diag-root" class="dm-root">';

          // ── HERO SECTION: comparison cards + bots (outside tabs) ──
          html += '<div class="dm-hero-section">';
          html +=   '<div class="dm-compare-row">';
          // Shopify card
          html +=     '<div class="dm-compare-card">';
          html +=       '<div class="dm-compare-card-head">';
          html +=         '<img class="dm-compare-card-icon" src="' + escapeHtml(SHOPIFY_LOGO_URL) + '" alt="Shopify" />';
          html +=         '<div><div class="dm-compare-card-title">Shopify</div></div>';
          html +=       '</div>';
          html +=       '<div class="dm-metrics">' +
                            metric('Sessions (today)', fmtSessions(shopifySessionsToday)) +
                            metric('CR%', fmtPct(shopifyCr)) +
                            metric('Orders (paid)', truthOrders != null ? escapeHtml(String(truthOrders)) : '\u2014') +
                            metric('Revenue (paid)', fmtRevenue(truthRevenue)) +
                          '</div>';
          html +=     '</div>';
          // Kexo card
          html +=     '<div class="dm-compare-card">';
          html +=       '<div class="dm-compare-card-head">';
          html +=         '<img class="dm-compare-card-icon" src="' + escapeHtml(KEXO_LOGO_URL) + '" alt="Kexo" />';
          html +=         '<div><div class="dm-compare-card-title">Kexo</div></div>';
          html +=       '</div>';
          html +=       '<div class="dm-metrics">' +
                            metric('Sessions (human, today)', fmtSessions(kexoSessionsToday)) +
                            metric('CR%', fmtPct(kexoCr)) +
                            metric('Orders (paid)', truthOrders != null ? escapeHtml(String(truthOrders)) : '\u2014') +
                            metric('Revenue (paid)', fmtRevenue(truthRevenue)) +
                          '</div>';
          html +=       '<div class="dm-bots-stat">Bots blocked today: <span class="dm-bots-stat-value">' + (botsBlockedToday != null ? fmtSessions(botsBlockedToday) : '\u2014') + '</span></div>';
          html +=     '</div>';
          html +=   '</div>'; // dm-compare-row
          html += '</div>'; // dm-hero-section

          // Compare
          let compare = '';
          compare += card('Comparison (today)', (
            '<div class="dm-table-wrap">' +
              '<div class="dm-table" role="table" aria-label="Comparison">' +
                '<div class="dm-table-row">' +
                  '<div class="dm-table-cell">Item</div>' +
                  '<div class="dm-table-cell"><span class="dm-table-cell-icon-wrap">' + brandIconTiny('Shopify', SHOPIFY_LOGO_URL, '149,191,71') + '<span>Shopify</span></span></div>' +
                  '<div class="dm-table-cell"><span class="dm-table-cell-icon-wrap">' + brandIconTiny('Kexo', KEXO_LOGO_URL, '13,148,136') + '<span>Kexo</span></span></div>' +
                  '<div class="dm-table-cell">Diff</div>' +
                '</div>' +
                '<div class="dm-table-row">' +
                  '<div class="dm-table-cell">Sessions</div>' +
                  '<div class="dm-table-cell">' + fmtSessions(shopifySessionsToday) + '</div>' +
                  '<div class="dm-table-cell">' + fmtSessions(kexoSessionsToday) + '</div>' +
                  '<div class="dm-table-cell">' + (sessionsDiff == null ? '\u2014' : diffSpan(sessionsDiff, function(a){ return formatSessions(a); }, '')) + '</div>' +
                '</div>' +
                '<div class="dm-table-row">' +
                  '<div class="dm-table-cell">Conversion rate</div>' +
                  '<div class="dm-table-cell">' + fmtPct(shopifyCr) + '</div>' +
                  '<div class="dm-table-cell">' + fmtPct(kexoCr) + '</div>' +
                  '<div class="dm-table-cell">' + (crDiff == null ? '\u2014' : diffSpan(crDiff, function(a){ const s=(Math.round(a*10)/10).toFixed(1).replace(/\\.0$/,''); return s; }, 'pp')) + '</div>' +
                '</div>' +
              '</div>' +
            '</div>'
          ));
          if (missingScopes.length) {
            compare += '<div class="dm-hint dm-mt">' + escapeHtml('Missing scopes: re-open the app from Shopify Admin to re-authorize and grant the missing scopes.') + '</div>';
          }
          if (evidenceExpected != null && evidenceExpected > 0 && evTotal === 0) {
            compare += '<div class="dm-hint dm-mt">Evidence can be 0 right after reinstall/pixel creation; it only starts counting from the next checkout.</div>';
          }

          // Sales
          let salesPanel = '';
          salesPanel += '<div class="dm-grid">';
          salesPanel += card('Quick drift', (
            rowKV('Pixel vs truth orders', driftPixelOrders == null ? '\u2014' : codeInline((driftPixelOrders >= 0 ? '+' : '') + String(driftPixelOrders))) +
            rowKV('Pixel vs truth revenue', driftPixelRevenue == null ? '\u2014' : codeInline('\u00a3' + (driftPixelRevenue >= 0 ? '+' : '') + String(driftPixelRevenue))) +
            rowKV('Evidence vs checkout-token', driftEvidenceCheckoutOrders == null ? '\u2014' : codeInline((driftEvidenceCheckoutOrders >= 0 ? '+' : '') + String(driftEvidenceCheckoutOrders)))
          ));
          salesPanel += card('Truth (paid)', (
            rowKV('Orders', truthOrders != null ? codeInline(String(truthOrders)) : '\u2014') +
            rowKV('Revenue', truthRevenue != null ? codeInline(formatRevenue(truthRevenue)) : '\u2014') +
            rowKV('Checkout-token orders', truthCheckoutOrders != null ? codeInline(String(truthCheckoutOrders)) : '\u2014') +
            rowKV('Checkout-token revenue', truthCheckoutRevenue != null ? codeInline(formatRevenue(truthCheckoutRevenue)) : '\u2014')
          ));
          salesPanel += card('Pixel (derived)', (
            rowKV('Derived orders', pixelDerivedOrders != null ? codeInline(String(pixelDerivedOrders)) : '\u2014') +
            rowKV('Derived revenue', pixelDerivedRevenue != null ? codeInline(formatRevenue(pixelDerivedRevenue)) : '\u2014') +
            rowKV('Drift vs truth (orders)', driftPixelOrders == null ? '\u2014' : codeInline((driftPixelOrders >= 0 ? '+' : '') + String(driftPixelOrders))) +
            rowKV('Drift vs truth (revenue)', driftPixelRevenue == null ? '\u2014' : codeInline('\u00a3' + (driftPixelRevenue >= 0 ? '+' : '') + String(driftPixelRevenue)))
          ));
          salesPanel += '</div>';
          salesPanel += '<div class="dm-grid dm-mt">';
          salesPanel += card('Evidence (checkout_completed)', (
            rowKV('Events (today)', evTotal != null ? codeInline(String(evTotal)) : '\u2014') +
            rowKV('Converted sessions (today)', evSessions != null ? codeInline(String(evSessions)) : '\u2014') +
            rowKV('Linked / unlinked', (evLinked != null && evUnlinked != null) ? (codeInline(String(evLinked)) + ' linked · ' + codeInline(String(evUnlinked)) + ' unlinked') : '\u2014') +
            (typeof evidenceToday.lastOccurredAt === 'number' ? rowKV('Last event', codeInline(formatTs(evidenceToday.lastOccurredAt))) : '')
          ));
          salesPanel += card('Returning', (
            rowKV('Returning customers', truthReturningCustomers != null ? codeInline(String(truthReturningCustomers)) : '\u2014') +
            rowKV('Returning revenue', truthReturningRevenue != null ? codeInline(formatRevenue(truthReturningRevenue)) : '\u2014')
          ));
          salesPanel += '</div>';

          // AI + future-agent guidance: interpret truth vs evidence drift
          try {
            const denomForCoverage = (truthCheckoutOrders != null ? truthCheckoutOrders : truthOrders);
            const missingOrders = (typeof missingEvidenceCount === 'number')
              ? missingEvidenceCount
              : ((denomForCoverage != null && evTotal != null) ? Math.max(0, denomForCoverage - evTotal) : null);
            const coveragePct = (denomForCoverage != null && denomForCoverage > 0 && evTotal != null)
              ? (evTotal / denomForCoverage) * 100
              : null;
            const cov = (coveragePct != null) ? (Math.round(coveragePct * 10) / 10) : null;
            const covTone = (cov == null) ? 'warn' : (cov >= 95 ? 'ok' : (cov >= 80 ? 'warn' : 'bad'));

            function missingLine(o) {
              if (!o || typeof o !== 'object') return '';
              const bits = [];
              const on = o.order_name != null ? String(o.order_name).trim() : '';
              const oid = o.order_id != null ? String(o.order_id).trim() : '';
              const ca = (o.created_at != null && isFinite(Number(o.created_at))) ? Number(o.created_at) : null;
              const src = o.source_name != null ? String(o.source_name).trim() : '';
              const refh = o.referring_site_host != null ? String(o.referring_site_host).trim() : '';
              const landh = o.landing_site_host != null ? String(o.landing_site_host).trim() : '';
              const gw = o.gateway != null ? String(o.gateway).trim() : '';
              if (on) bits.push(escapeHtml(on));
              if (oid) bits.push('id ' + escapeHtml(oid));
              if (ca != null) bits.push(escapeHtml(formatTs(ca)));
              if (src) bits.push('source=' + escapeHtml(src));
              if (landh) bits.push('landing=' + escapeHtml(landh));
              if (refh) bits.push('ref=' + escapeHtml(refh));
              if (gw) bits.push('gateway=' + escapeHtml(gw));
              if (!bits.length) return '';
              return '<div class="dm-missing-line">' + bits.join(' · ') + '</div>';
            }

            let missingSampleHtml = '';
            if (missingEvidenceSample && missingEvidenceSample.length) {
              const lines = missingEvidenceSample.slice(0, 25).map(missingLine).filter(Boolean).join('');
              missingSampleHtml =
                '<details class="dm-missing-details">' +
                  '<summary>Missing evidence orders (sample ' + escapeHtml(String(missingEvidenceSample.length)) + ')</summary>' +
                  '<div class="dm-def-details-body">' + (lines || '<div class="dm-def-note">No sample rows.</div>') + '</div>' +
                  '<div class="dm-hint">If these are mostly <code class="dm-code">source=web</code> but still missing evidence, it’s usually adblock/consent or pixel not running on the completion surface. If they’re <code class="dm-code">source=pos</code> / manual / subscription renewals, pixel evidence won’t exist.</div>' +
                '</details>';
            }

            const guide =
              '<div class="dm-guide dm-hint">' +
                '<div class="dm-guide-title">How to debug sales drift (Truth vs Kexo)</div>' +
                '<ul>' +
                  '<li><strong>Truth</strong> = Shopify Orders API cache (`orders_shopify`, paid, not cancelled). This is the authoritative number.</li>' +
                  '<li><strong>Evidence</strong> = Web Pixel <code class="dm-code">checkout_completed</code> events (`purchase_events`). If Evidence &lt; Truth, events are missing (capture issue), not a truth sync issue.</li>' +
                  '<li><strong>Kexo derived</strong> = `purchases` (built from evidence). If it matches Evidence (as it does when linked/unlinked looks healthy), drift is upstream of purchases.</li>' +
                  '<li>First check: pixel installed + ingestUrl match, and Evidence linked/unlinked (linking health). Then inspect the Missing Evidence sample below.</li>' +
                '</ul>' +
              '</div>';

            salesPanel += '<div class="dm-mt">' + card('Sales drift (AI notes)', (
              rowKV('Coverage (evidence / truth)', (evTotal != null && denomForCoverage != null)
                ? (codeInline(String(evTotal)) + ' / ' + codeInline(String(denomForCoverage)) + ' ' + pillInline((cov != null ? (cov + '%') : '\u2014') + ' evidence', covTone))
                : '\u2014'
              ) +
              rowKV('Missing evidence (count)', missingOrders == null ? '\u2014' : pillInline(String(missingOrders), missingOrders === 0 ? 'ok' : (missingOrders <= 3 ? 'warn' : 'bad'))) +
              (missingEvidenceNote ? ('<div class="dm-hint">' + escapeHtml(missingEvidenceNote) + '</div>') : '') +
              guide +
              (missingSampleHtml || '')
            )) + '</div>';
          } catch (_) {}

          // Traffic
          let trafficPanel = '';
          trafficPanel += '<div class="dm-grid">';
          trafficPanel += card('Sessions', (
            (traffic && traffic.today && typeof traffic.today.sessionsReachedApp === 'number' ? rowKV('Reached app (today)', codeInline(formatSessions(traffic.today.sessionsReachedApp))) : '') +
            (traffic && traffic.today && typeof traffic.today.humanSessions === 'number' ? rowKV('Human sessions (today)', codeInline(formatSessions(traffic.today.humanSessions))) : '') +
            (traffic && traffic.today && typeof traffic.today.botSessionsTagged === 'number' ? rowKV('Bot sessions tagged (today)', codeInline(formatSessions(traffic.today.botSessionsTagged))) : '') +
            (traffic && traffic.today && typeof traffic.today.totalTrafficEst === 'number' ? rowKV('Total traffic est. (today)', codeInline(formatSessions(traffic.today.totalTrafficEst)), 'Total traffic est. = sessions reached app + bots blocked at edge.') : '')
          ));
          let shopifySessionsNote = '';
          if (typeof traffic.shopifySessionsToday === 'number') {
            shopifySessionsNote += rowKV('Shopify sessions (today)', codeInline(formatSessions(traffic.shopifySessionsToday)));
            if (traffic && traffic.today && typeof traffic.today.humanSessions === 'number') {
              shopifySessionsNote += rowKV('Shopify − ours (human)', codeInline(formatSessions(traffic.shopifySessionsToday - traffic.today.humanSessions)));
            }
          } else if (traffic.shopifySessionsTodayNote) {
            shopifySessionsNote += rowKV('Shopify sessions (today)', '\u2014', escapeHtml(traffic.shopifySessionsTodayNote));
          }
          trafficPanel += card('Shopify vs ours', shopifySessionsNote || rowKV('Shopify sessions (today)', '\u2014'));
          trafficPanel += card('Traffic tab settings', (
            '<div class="dm-def-section-title">Channels</div>' +
            '<div id="traffic-sources-picker" class="traffic-picker-list"><div class="dm-def-note">Loading…</div></div>' +
            '<div class="dm-def-section-title">Device types</div>' +
            '<div id="traffic-types-picker" class="traffic-picker-list"><div class="dm-def-note">Loading…</div></div>' +
            '<div class="dm-def-note">These controls replace the Traffic tab table settings icons.</div>'
          ));
          trafficPanel += '</div>';

          // Pixel
          let pixelPanel = '';
          pixelPanel += '<div class="dm-grid">';
          pixelPanel += card('Pixel (Shopify)', (
            rowKV('Installed', pixel && pixel.installed === true ? pillInline('Yes', 'ok') : (pixel && pixel.installed === false ? pillInline('No', 'bad') : '\u2014')) +
            (pixel && pixel.message ? rowKV('Status', codeInline(pixel.message)) : '') +
            (pixelIngestUrl ? rowKV('Pixel ingestUrl', codeInline(pixelIngestUrl)) : '') +
            (expectedIngestUrl ? rowKV('Expected ingestUrl', codeInline(expectedIngestUrl)) : '') +
            (ingestUrlMatch == null ? '' : rowKV('IngestUrl match', ingestUrlMatch ? pillInline('Match', 'ok') : pillInline('Mismatch', 'bad')))
          ));
          pixelPanel += card('Session mode (beta)', (
            '<label class="dm-toggle-row">' +
              '<input type="checkbox" id="pixel-session-mode-toggle"' + (sharedSessionFixEnabled ? ' checked' : '') + ' />' +
              '<span>Share session across tabs (30m inactivity)</span>' +
            '</label>' +
            '<div class="dm-hint">Auto-saves. ON shares one session across tabs (30m inactivity) to reduce inflated session counts. OFF uses legacy per-tab sessions.</div>' +
            '<div id="pixel-session-mode-msg" class="dm-toggle-msg"></div>'
          ));
          pixelPanel += '</div>';

          // Shopify
          let shopifyPanel = '';
          shopifyPanel += '<div class="dm-grid">';
          shopifyPanel += card('Auth + scopes', (
            rowKV('Shop', shopify.shop ? codeInline(shopify.shop) : pillInline('Missing', 'bad')) +
            rowKV('Token stored', shopify.hasToken ? pillInline('Yes', 'ok') : pillInline('No', 'bad')) +
            (storedScopesStr ? rowKV('Stored scopes', codeInline(storedScopesStr)) : '') +
            (serverScopesStr ? rowKV('Required scopes', codeInline(serverScopesStr)) : '') +
            (missingScopes.length ? rowKV('Missing scopes', codeInline(missingScopes.join(', '))) : rowKV('Missing scopes', pillInline('None', 'ok')))
          ));
          shopifyPanel += card('Truth sync health', (
            rowKV('Sync age', staleSec != null ? codeInline(staleSec + 's') : '\u2014') +
            (health && health.lastSuccessAt ? rowKV('Last sync', codeInline(formatTs(health.lastSuccessAt))) : '') +
            (health && health.lastError ? rowKV('Last error', codeInline(String(health.lastError).slice(0, 220))) : '') +
            (typeof truthToday.lastOrderCreatedAt === 'number' ? rowKV('Last order', codeInline(formatTs(truthToday.lastOrderCreatedAt))) : '')
          ));
          shopifyPanel += '</div>';

          // Sources
          let sourcesPanel = '';
          sourcesPanel += card('Traffic source mapping', (
            '<div class="dm-hint">Map URL UTMs into custom sources + icons (affects Traffic + Home source icons). Unmapped tokens appear first.</div>' +
            '<div id="traffic-source-mapping-root"><div class="dm-loading">Loading…</div></div>'
          ));

          // Google Ads
          let googleAdsPanel = '';
          try {
            const ads = c && c.ads ? c.ads : {};
            const adsStatus = ads && ads.status ? ads.status : null;
            const providers = (adsStatus && Array.isArray(adsStatus.providers)) ? adsStatus.providers : [];
            const g = providers.find(function(p) { return p && String(p.key || '').toLowerCase() === 'google_ads'; }) || null;
            const connected = g && g.connected === true;
            const configured = g && g.configured === true;
            const customerId = (g && g.customerId) ? String(g.customerId) : '';
            const loginCustomerId = (g && g.loginCustomerId) ? String(g.loginCustomerId) : '';
            const hasRefreshToken = g && g.hasRefreshToken === true;
            const hasDeveloperToken = g && g.hasDeveloperToken === true;
            const hasAdsDb = g && g.adsDb === true;
            const apiVer = (ads && typeof ads.googleAdsApiVersion === 'string') ? ads.googleAdsApiVersion : '';

            function prettyJson(obj) {
              try { return JSON.stringify(obj, null, 2); } catch (_) { return String(obj || ''); }
            }

            googleAdsPanel += '<div class="dm-grid">';
            googleAdsPanel += card('Connection', (
              rowKV('Configured', configured ? pillInline('Yes', 'ok') : pillInline('No', 'bad')) +
              rowKV('Connected (refresh_token)', connected ? pillInline('Yes', 'ok') : pillInline('No', 'bad')) +
              rowKV('ADS DB', hasAdsDb ? pillInline('OK', 'ok') : pillInline('Missing', 'bad')) +
              (customerId ? rowKV('Customer ID', codeInline(customerId)) : '') +
              (loginCustomerId ? rowKV('Login Customer ID', codeInline(loginCustomerId)) : '') +
              rowKV('Developer token', hasDeveloperToken ? pillInline('Set', 'ok') : pillInline('Missing', 'bad')) +
              rowKV('Refresh token', hasRefreshToken ? pillInline('Present', 'ok') : pillInline('Missing', 'bad')) +
              (apiVer ? rowKV('API version hint', codeInline(apiVer)) : rowKV('API version hint', pillInline('Auto', 'ok')))
            ));

            const connectUrl = '/api/ads/google/connect?redirect=' + encodeURIComponent('/app/live-visitors');
            googleAdsPanel += card('Actions', (
              '<div class="dm-bar-actions" style="justify-content:flex-start;">' +
                '<a class="dm-copy-btn" href="' + escapeHtml(connectUrl) + '" title="Connect Google Ads (OAuth)">' + copyIcon + '<span>Connect</span></a>' +
                '<button type="button" id="ga-status-btn" class="dm-copy-btn" title="Fetch /api/ads/status">' + copyIcon + '<span>Status</span></button>' +
                '<button type="button" id="ga-summary-btn" class="dm-copy-btn" title="Fetch /api/ads/summary?range=7d">' + copyIcon + '<span>Summary</span></button>' +
                '<button type="button" id="ga-refresh-7d-btn" class="dm-copy-btn" title="POST /api/ads/refresh?range=7d">' + copyIcon + '<span>Refresh 7d</span></button>' +
                '<button type="button" id="ga-refresh-month-btn" class="dm-copy-btn" title="POST /api/ads/refresh?range=month">' + copyIcon + '<span>Refresh month</span></button>' +
                '<span id="ga-msg" class="dm-copy-msg"></span>' +
              '</div>' +
              '<div class="dm-hint">Refresh returns spend sync diagnostics including per-version attempts when Google Ads REST errors occur.</div>'
            ));

            googleAdsPanel += card('Output', (
              '<pre id="ga-output" class="dm-json-pre">' + escapeHtml(prettyJson({ ads: adsStatus })) + '</pre>'
            ));
            googleAdsPanel += '</div>';
          } catch (err) {
            googleAdsPanel = '<div class="dm-error">' + pillInline('Error', 'bad') + '<span>Google Ads diagnostics failed to render.</span></div>';
          }

          // System
          let systemPanel = '';
          systemPanel += '<div class="dm-grid">';
          systemPanel += card('Reporting', (
            (reporting && (reporting.ordersSource || reporting.sessionsSource))
              ? (
                (reporting.ordersSource ? rowKV('Orders source', codeInline(reporting.ordersSource)) : '') +
                (reporting.sessionsSource ? rowKV('Sessions source', codeInline(reporting.sessionsSource)) : '')
              )
              : rowKV('Sources', '\u2014')
          ));
          let tablesLine = '';
          if (db && db.tables) {
            const t = db.tables;
            const bits = [];
            function add(name, ok) { bits.push(name + (ok ? ' ✓' : ' ✗')); }
            add('settings', !!t.settings);
            add('shop_sessions', !!t.shop_sessions);
            add('visitors', !!t.visitors);
            add('sessions', !!t.sessions);
            add('events', !!t.events);
            add('purchases', !!t.purchases);
            add('orders_shopify', !!t.orders_shopify);
            add('orders_shopify_line_items', !!t.orders_shopify_line_items);
            add('customer_order_facts', !!t.customer_order_facts);
            add('purchase_events', !!t.purchase_events);
            add('reconcile_state', !!t.reconcile_state);
            add('reconcile_snapshots', !!t.reconcile_snapshots);
            add('shopify_sessions_snapshots', !!t.shopify_sessions_snapshots);
            add('audit_log', !!t.audit_log);
            add('bot_block_counts', !!t.bot_block_counts);
            tablesLine = codeInline(bits.join(' · '));
          }
          systemPanel += card('Runtime', (
            (app && app.version ? rowKV('App version', codeInline(app.version)) : '') +
            (db && db.engine ? rowKV('DB', codeInline(db.engine + (db.configured ? '' : ' (DB_URL not set)'))) : '') +
            (tablesLine ? rowKV('Tables', tablesLine) : '') +
            (app && typeof app.sentryConfigured === 'boolean' ? rowKV('Sentry', app.sentryConfigured ? pillInline('ON', 'ok') : pillInline('OFF', 'bad')) : '')
          ));
          systemPanel += '</div>';

          // Definitions (reuse existing renderer for content, but in its own top-level tab)
          let defsPanel = '';
          defsPanel += card('Metric + table definitions', renderTrackerDefinitions(trackerDefinitions));

          // ── TAB BAR ──
          html += '<div class="dm-tabs-bar" id="be-diag-tabs">';
          html +=   diagTab('sales', 'Sales');
          html +=   diagTab('compare', 'Compare');
          html +=   diagTab('traffic', 'Traffic');
          html +=   diagTab('pixel', 'Pixel');
          html +=   diagTab('googleads', 'Google Ads');
          html +=   diagTab('shopify', 'Shopify');
          html +=   diagTab('sources', 'Sources');
          html +=   diagTab('system', 'System');
          html +=   diagTab('defs', 'Definitions');
          html += '</div>';

          // Advanced copy dropdown — inside first tab panel but logically separate
          var advancedDropdown = '<details class="dm-copy-dropdown">';
          advancedDropdown += '<summary class="dm-copy-dropdown-summary">Advanced</summary>';
          advancedDropdown += '<div class="dm-copy-dropdown-body"><div class="dm-bar-row">';
          advancedDropdown +=   '<div class="dm-bar-meta">' + headerMetaBits.join(' · ') + '</div>';
          advancedDropdown +=   '<div class="dm-bar-actions">' +
                       '<button type="button" id="be-copy-ai-btn" class="dm-copy-btn" title="Copy a detailed diagnostics payload for AI">' + copyIcon + '<span>Copy AI debug</span></button>' +
                       '<a href="/auth/google?redirect=/app/live-visitors" class="dm-copy-btn" title="Sign in again with Google if your session expires">' + copyIcon + '<span>Re-login</span></a>' +
                       '<span id="be-copy-ai-msg" class="dm-copy-msg"></span>' +
                       (shopify && shopify.hasToken ? pillInline('Token OK', 'ok') : pillInline('Token missing', 'bad')) +
                       (missingScopes.length ? pillInline('Missing scopes', 'bad') : pillInline('Scopes OK', 'ok')) +
                     '</div>';
          advancedDropdown += '</div></div></details>';

          // ── TAB PANELS ──
          html += diagTabPanel('sales', advancedDropdown + salesPanel);
          html += diagTabPanel('compare', compare);
          html += diagTabPanel('traffic', trafficPanel);
          html += diagTabPanel('pixel', pixelPanel);
          html += diagTabPanel('googleads', googleAdsPanel);
          html += diagTabPanel('shopify', shopifyPanel);
          html += diagTabPanel('sources', sourcesPanel);
          html += diagTabPanel('system', systemPanel);
          html += diagTabPanel('defs', defsPanel);

          html += '</div>'; // be-diag-root

          const configStatusEl = document.getElementById('config-status');
          if (configStatusEl) configStatusEl.innerHTML = html;

          // ── Wire up tab switching ──
          (function initDiagTabs() {
            var tabBar = document.getElementById('be-diag-tabs');
            if (!tabBar) return;
            var btns = tabBar.querySelectorAll('.dm-tab-btn[data-diag-tab]');
            function activateTab(key) {
              try { activeDiagTabKey = key; } catch (_) {}
              btns.forEach(function(b) { b.setAttribute('aria-selected', b.getAttribute('data-diag-tab') === key ? 'true' : 'false'); });
              document.querySelectorAll('.dm-tab-panel[data-diag-panel]').forEach(function(p) {
                p.classList.toggle('dm-tab-panel--active', p.getAttribute('data-diag-panel') === key);
              });
            }
            btns.forEach(function(b) {
              b.addEventListener('click', function() { activateTab(b.getAttribute('data-diag-tab')); });
            });
            // Default: restore previously-selected tab (best-effort), else first.
            if (btns.length) {
              var preferred = (typeof activeDiagTabKey === 'string' && activeDiagTabKey) ? activeDiagTabKey : '';
              var exists = false;
              btns.forEach(function(b) { if (b.getAttribute('data-diag-tab') === preferred) exists = true; });
              activateTab(exists ? preferred : btns[0].getAttribute('data-diag-tab'));
            }
          })();

          // Preserve scroll position when refreshing while the modal is already open.
          try {
            if (preserveView && modalCardEl) modalCardEl.scrollTop = prevModalScrollTop;
          } catch (_) {}
          try {
            const compareIsOpenNow = !!(compareModalEl && compareModalEl.classList.contains('open'));
            if (compareIsOpenNow && compareStatusEl) {
              const updatedAtMs = (c && typeof c.now === 'number' && isFinite(c.now)) ? c.now : Date.now();

              function kickerForKey(key) {
                const k = key ? String(key).trim().toLowerCase() : '';
                if (k === 'sessions') return 'Sessions';
                if (k === 'aov') return 'AOV';
                return 'Conversion rate';
              }

              const compareKey = activeKpiCompareKey ? String(activeKpiCompareKey).trim().toLowerCase() : 'conv';
              if (compareKickerEl) compareKickerEl.textContent = kickerForKey(compareKey);

              function compareMetric(label, valueHtml) {
                return (
                  '<div class="kpi-compare-metric">' +
                    '<div class="kpi-compare-metric-label">' + escapeHtml(label) + '</div>' +
                    '<div class="kpi-compare-metric-value">' + (valueHtml || '\u2014') + '</div>' +
                  '</div>'
                );
              }
              function compareBrand(name, logoUrl, sub, rightHtml) {
                const right = rightHtml ? String(rightHtml) : '';
                return (
                  '<div class="kpi-compare-brand">' +
                    '<div class="kpi-compare-brand-left">' +
                      '<img class="kpi-compare-brand-icon" src="' + escapeHtml(String(logoUrl || '')) + '" width="28" height="28" alt="" aria-hidden="true" decoding="async" />' +
                      '<div class="kpi-compare-brand-text">' +
                        '<div class="kpi-compare-brand-name">' + escapeHtml(name || '') + '</div>' +
                        '<div class="kpi-compare-brand-sub">' + escapeHtml(sub || '') + '</div>' +
                      '</div>' +
                    '</div>' +
                    (right ? ('<div class="kpi-compare-brand-right">' + right + '</div>') : '') +
                  '</div>'
                );
              }
              function inlineMetric(label, valueHtml) {
                return (
                  '<span class="kpi-compare-inline-metric">' +
                    '<span class="kpi-compare-inline-label">' + escapeHtml(label || '') + '</span>' +
                    '<span class="kpi-compare-inline-value">' + (valueHtml || '\u2014') + '</span>' +
                  '</span>'
                );
              }

              function fmtSignedCount(v) {
                if (typeof v !== 'number' || !isFinite(v)) return '';
                const sign = v > 0 ? '+' : (v < 0 ? '-' : '');
                return sign + formatSessions(Math.abs(v));
              }
              function fmtSignedMoney(v) {
                if (typeof v !== 'number' || !isFinite(v)) return '';
                const sign = v > 0 ? '+' : (v < 0 ? '-' : '');
                return sign + formatRevenue(Math.abs(v));
              }
              function fmtSignedPp(v) {
                if (typeof v !== 'number' || !isFinite(v)) return '';
                const sign = v > 0 ? '+' : (v < 0 ? '-' : '');
                const abs = Math.abs(v);
                const s = (Math.round(abs * 100) / 100).toFixed(2).replace(/\.?0+$/, '');
                return sign + s + 'pp';
              }
              function safeAov(revenue, orders) {
                if (typeof revenue !== 'number' || !isFinite(revenue)) return null;
                if (typeof orders !== 'number' || !isFinite(orders) || orders <= 0) return null;
                return revenue / orders;
              }

              const botsTaggedToday = (traffic && traffic.today && typeof traffic.today.botSessionsTagged === 'number')
                ? traffic.today.botSessionsTagged
                : null;
              const totalTrafficEstToday = (traffic && traffic.today && typeof traffic.today.totalTrafficEst === 'number')
                ? traffic.today.totalTrafficEst
                : null;
              const sessionsReachedAppToday = (traffic && traffic.today && typeof traffic.today.sessionsReachedApp === 'number')
                ? traffic.today.sessionsReachedApp
                : null;

              const truthAov = safeAov(truthRevenue, truthOrders);
              const pixelAov = safeAov(pixelDerivedRevenue, pixelDerivedOrders);

              let diffText = '';
              if (compareKey === 'sessions') {
                const d = (kexoSessionsToday != null && shopifySessionsToday != null) ? (kexoSessionsToday - shopifySessionsToday) : null;
                diffText = (d != null) ? ('Δ Sessions ' + fmtSignedCount(d)) : '';
              } else if (compareKey === 'aov') {
                const d = (pixelAov != null && truthAov != null) ? (pixelAov - truthAov) : null;
                diffText = (d != null) ? ('Δ AOV ' + fmtSignedMoney(d)) : '';
              } else {
                const d = (kexoCr != null && shopifyCr != null) ? (kexoCr - shopifyCr) : null;
                diffText = (d != null) ? ('Δ CR ' + fmtSignedPp(d)) : '';
              }

              if (compareUpdatedEl) {
                compareUpdatedEl.textContent = 'Updated ' + formatTs(updatedAtMs) + (diffText ? (' · ' + diffText) : '');
              }

              const ordersHtml = (truthOrders != null) ? escapeHtml(String(truthOrders)) : '\u2014';
              const pixelOrdersHtml = (pixelDerivedOrders != null) ? escapeHtml(String(pixelDerivedOrders)) : '\u2014';
              const missingEvidenceHtml = (typeof missingEvidenceCount === 'number' && isFinite(missingEvidenceCount)) ? escapeHtml(String(missingEvidenceCount)) : '\u2014';
              const evidenceHtml = (typeof evTotal === 'number' && isFinite(evTotal)) ? escapeHtml(String(evTotal)) : '\u2014';

              let cmpHtml = '';
              cmpHtml += '<div class="kpi-compare-grid">';

              if (compareKey === 'sessions') {
                cmpHtml +=   '<div class="kpi-compare-card kpi-compare-card--simple">';
                cmpHtml +=     compareBrand('Shopify', SHOPIFY_LOGO_URL, 'ShopifyQL sessions', inlineMetric('Sessions', fmtSessions(shopifySessionsToday)));
                cmpHtml +=   '</div>';
                cmpHtml +=   '<div class="kpi-compare-card kpi-compare-card--simple">';
                cmpHtml +=     compareBrand('Kexo', KEXO_LOGO_URL, 'Human sessions', inlineMetric('Sessions', fmtSessions(kexoSessionsToday)));
                cmpHtml +=   '</div>';
              } else if (compareKey === 'aov') {
                cmpHtml +=   '<div class="kpi-compare-card kpi-compare-card--simple">';
                cmpHtml +=     compareBrand('Shopify', SHOPIFY_LOGO_URL, 'Paid truth orders', inlineMetric('AOV', fmtRevenue(truthAov)));
                cmpHtml +=   '</div>';
                cmpHtml +=   '<div class="kpi-compare-card kpi-compare-card--simple">';
                cmpHtml +=     compareBrand('Kexo', KEXO_LOGO_URL, 'Pixel purchases (deduped)', inlineMetric('AOV', fmtRevenue(pixelAov)));
                cmpHtml +=   '</div>';
              } else {
                cmpHtml +=   '<div class="kpi-compare-card">';
                cmpHtml +=     compareBrand('Shopify', SHOPIFY_LOGO_URL, 'ShopifyQL sessions · conversion_rate');
                cmpHtml +=     '<div class="kpi-compare-metrics">' +
                                 compareMetric('CR% (Shopify)', fmtPct(shopifyCr)) +
                                 compareMetric('Sessions (today)', fmtSessions(shopifySessionsToday)) +
                                 compareMetric('Orders (paid)', ordersHtml) +
                                 compareMetric('Revenue (paid)', fmtRevenue(truthRevenue)) +
                               '</div>';
                cmpHtml +=   '</div>';
                cmpHtml +=   '<div class="kpi-compare-card">';
                cmpHtml +=     compareBrand('Kexo', KEXO_LOGO_URL, 'Human sessions · bot signals');
                cmpHtml +=     '<div class="kpi-compare-metrics">' +
                                 compareMetric('CR% (truth)', fmtPct(kexoCr)) +
                                 compareMetric('Sessions (human, today)', fmtSessions(kexoSessionsToday)) +
                                 compareMetric('Bots blocked (today)', botsBlockedToday != null ? fmtSessions(botsBlockedToday) : '\u2014') +
                                 compareMetric('Bot-tagged (today)', botsTaggedToday != null ? fmtSessions(botsTaggedToday) : '\u2014') +
                               '</div>';
                cmpHtml +=   '</div>';
              }

              cmpHtml += '</div>';

              compareStatusEl.innerHTML = cmpHtml;
            }
          } catch (_) {}
          try { renderTrafficPickers(trafficCache || null); } catch (_) {}
          try {
            const btn = document.getElementById('be-copy-ai-btn');
            const msg = document.getElementById('be-copy-ai-msg');
            if (btn) {
              btn.onclick = function() {
                const text = aiCopyText || '';
                function setMsg(t, ok) {
                  if (!msg) return;
                  msg.textContent = t || '';
                  msg.classList.remove('dm-copy-msg--success', 'dm-copy-msg--error');
                  msg.classList.add(ok ? 'dm-copy-msg--success' : 'dm-copy-msg--error');
                }
                function fallbackCopy(t) {
                  const ta = document.createElement('textarea');
                  ta.value = t;
                  ta.setAttribute('readonly', 'readonly');
                  ta.style.position = 'fixed';
                  ta.style.top = '-9999px';
                  ta.style.left = '-9999px';
                  document.body.appendChild(ta);
                  ta.select();
                  ta.setSelectionRange(0, ta.value.length);
                  const ok = document.execCommand('copy');
                  document.body.removeChild(ta);
                  return ok;
                }
                try {
                  if (!text) {
                    setMsg('Nothing to copy', false);
                    return;
                  }
                  setMsg('Copying…', true);
                  if (navigator && navigator.clipboard && typeof navigator.clipboard.writeText === 'function') {
                    navigator.clipboard.writeText(text)
                      .then(function() { setMsg('Copied (' + text.length + ' chars)', true); })
                      .catch(function(err) {
                        const ok = fallbackCopy(text);
                        if (ok) setMsg('Copied (' + text.length + ' chars)', true);
                        else setMsg('Copy failed: ' + (err && err.message ? String(err.message) : 'error'), false);
                      });
                  } else {
                    const ok = fallbackCopy(text);
                    if (ok) setMsg('Copied (' + text.length + ' chars)', true);
                    else setMsg('Copy failed', false);
                  }
                } catch (err) {
                  setMsg('Copy failed: ' + (err && err.message ? String(err.message) : 'error'), false);
                }
              };
            }
          } catch (_) {}
          try { initTrafficSourceMappingPanel(); } catch (_) {}
          try {
            function setGaMsg(t, ok) {
              const msgEl = document.getElementById('ga-msg');
              if (!msgEl) return;
              msgEl.textContent = t || '';
              msgEl.classList.remove('dm-copy-msg--success', 'dm-copy-msg--error');
              msgEl.classList.add(ok ? 'dm-copy-msg--success' : 'dm-copy-msg--error');
            }
            function setGaOutput(obj) {
              const outEl = document.getElementById('ga-output');
              if (!outEl) return;
              try { outEl.textContent = JSON.stringify(obj, null, 2); }
              catch (_) { outEl.textContent = String(obj || ''); }
            }
            function fetchJson(url, options) {
              return fetch(url, options || { credentials: 'same-origin', cache: 'no-store' })
                .then(function(r) {
                  return r.text().then(function(t) {
                    let j = null;
                    try { j = t ? JSON.parse(t) : null; } catch (_) {}
                    return { ok: r.ok, status: r.status, json: j, text: t };
                  });
                });
            }
            const statusBtn = document.getElementById('ga-status-btn');
            const summaryBtn = document.getElementById('ga-summary-btn');
            const refresh7dBtn = document.getElementById('ga-refresh-7d-btn');
            const refreshMonthBtn = document.getElementById('ga-refresh-month-btn');
            if (statusBtn) {
              statusBtn.onclick = function() {
                setGaMsg('Fetching status…', true);
                fetchJson((API || '') + '/api/ads/status', { credentials: 'same-origin', cache: 'no-store' })
                  .then(function(r) {
                    setGaOutput({ endpoint: 'GET /api/ads/status', status: r.status, ok: r.ok, body: r.json || r.text });
                    setGaMsg(r.ok ? 'Status OK' : ('Status error ' + r.status), r.ok);
                  })
                  .catch(function(err) {
                    setGaOutput({ endpoint: 'GET /api/ads/status', error: err && err.message ? String(err.message) : 'request_failed' });
                    setGaMsg('Status request failed', false);
                  });
              };
            }
            if (summaryBtn) {
              summaryBtn.onclick = function() {
                setGaMsg('Fetching summary…', true);
                fetchJson((API || '') + '/api/ads/summary?range=7d', { credentials: 'same-origin', cache: 'no-store' })
                  .then(function(r) {
                    setGaOutput({ endpoint: 'GET /api/ads/summary?range=7d', status: r.status, ok: r.ok, body: r.json || r.text });
                    setGaMsg(r.ok ? 'Summary OK' : ('Summary error ' + r.status), r.ok);
                  })
                  .catch(function(err) {
                    setGaOutput({ endpoint: 'GET /api/ads/summary?range=7d', error: err && err.message ? String(err.message) : 'request_failed' });
                    setGaMsg('Summary request failed', false);
                  });
              };
            }
            function doRefresh(rangeKey) {
              setGaMsg('Refreshing ' + rangeKey + '…', true);
              fetchJson((API || '') + '/api/ads/refresh?range=' + encodeURIComponent(rangeKey), {
                method: 'POST',
                credentials: 'same-origin',
                cache: 'no-store',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ source: 'googleads' }),
              })
                .then(function(r) {
                  setGaOutput({ endpoint: 'POST /api/ads/refresh?range=' + rangeKey, status: r.status, ok: r.ok, body: r.json || r.text });
                  setGaMsg(r.ok ? ('Refresh ' + rangeKey + ' OK') : ('Refresh error ' + r.status), r.ok);
                })
                .catch(function(err) {
                  setGaOutput({ endpoint: 'POST /api/ads/refresh?range=' + rangeKey, error: err && err.message ? String(err.message) : 'request_failed' });
                  setGaMsg('Refresh request failed', false);
                });
            }
            if (refresh7dBtn) refresh7dBtn.onclick = function() { doRefresh('7d'); };
            if (refreshMonthBtn) refreshMonthBtn.onclick = function() { doRefresh('month'); };
          } catch (_) {}
          try {
            const toggle = document.getElementById('pixel-session-mode-toggle');
            const msgEl = document.getElementById('pixel-session-mode-msg');
            if (toggle) {
              toggle.onchange = function() {
                const enabled = !!toggle.checked;
                const nextMode = enabled ? 'shared_ttl' : 'legacy';
                toggle.disabled = true;
                if (msgEl) msgEl.textContent = 'Saving…';
                fetch(API + '/api/settings', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  credentials: 'same-origin',
                  cache: 'no-store',
                  body: JSON.stringify({ pixelSessionMode: nextMode }),
                })
                  .then(function(r) {
                    if (r.ok) return r.json();
                    return r.json().catch(function() { return null; }).then(function(j) {
                      const msg = j && j.error ? String(j.error) : ('HTTP ' + r.status);
                      throw new Error(msg);
                    });
                  })
                  .then(function() {
                    const shop = getShopParam();
                    if (shop && /\.myshopify\.com$/i.test(shop)) {
                      if (msgEl) msgEl.textContent = 'Saved. Syncing pixel settings…';
                      return fetch(API + '/api/pixel/ensure?shop=' + encodeURIComponent(shop), { credentials: 'same-origin', cache: 'no-store' })
                        .then(function(r) { return r.ok ? r.json() : null; })
                        .catch(function() { return null; });
                    }
                    return null;
                  })
                  .then(function() {
                    if (msgEl) msgEl.textContent = 'Saved. Applies on next page view.';
                  })
                  .catch(function(err) {
                    if (msgEl) {
                      msgEl.textContent = 'Save failed: ' + (err && err.message ? String(err.message).slice(0, 140) : 'error');
                    }
                  })
                  .finally(function() {
                    toggle.disabled = false;
                    // If the modal is open, refresh diagnostics so the UI reflects the saved setting,
                    // but preserve the current tab/scroll to avoid disrupting viewing.
                    try {
                      if (typeof isConfigModalOpen === 'function' && isConfigModalOpen()) {
                        refreshConfigStatus({ force: true, preserveView: true });
                      }
                    } catch (_) {}
                  });
              };
            }
          } catch (_) {}
          if (typeof evidenceToday !== 'undefined' && typeof evidenceToday.lastOccurredAt === 'number') {
            setLastSaleAt(evidenceToday.lastOccurredAt);
          }
          return c;
        })
        .catch(() => {
          const configStatusEl = document.getElementById('config-status');
          if (configStatusEl) {
            configStatusEl.innerHTML =
              '<div class="dm-error">' +
                '<span class="dm-pill dm-pill-bad">Error</span>' +
                '<span>Could not load diagnostics.</span>' +
              '</div>';
          }
          try {
            const compareIsOpenNow = !!(compareModalEl && compareModalEl.classList.contains('open'));
            if (compareIsOpenNow && compareStatusEl) {
              compareStatusEl.innerHTML =
                '<div class="kpi-compare-error">' +
                  '<div class="kpi-compare-error-title">Error</div>' +
                  '<div class="kpi-compare-error-body">Could not load comparison.</div>' +
                '</div>';
              if (compareUpdatedEl) compareUpdatedEl.textContent = 'Update failed';
            }
          } catch (_) {}
        })
        .finally(function() {
          if (refreshBtn) refreshBtn.classList.remove('spinning');
          if (compareRefreshBtn) compareRefreshBtn.classList.remove('spinning');
          if (configStatusRefreshInFlight === p) configStatusRefreshInFlight = null;
        });
      configStatusRefreshInFlight = p;
      return p;
    }

    // Best-effort: prime Diagnostics data in the background (modal is closed at load).
    try { refreshConfigStatus(); } catch (_) {}

    updateLastSaleAgo();
    setInterval(updateLastSaleAgo, 10000);

    (function initConfigModal() {
      const modal = document.getElementById('config-modal');
      const openBtn = document.getElementById('config-open-btn');
      const refreshBtn = document.getElementById('config-refresh-btn');
      const reconcileBtn = document.getElementById('config-reconcile-btn');
      const closeBtn = document.getElementById('config-close-btn');
      if (!modal) return;
      function open() {
        try { refreshConfigStatus({ force: true, preserveView: false }); } catch (_) {}
        try { fetchTrafficData({ force: true }); } catch (_) {}
        modal.classList.add('open');
        modal.setAttribute('aria-hidden', 'false');
      }
      function close() { modal.classList.remove('open'); modal.setAttribute('aria-hidden', 'true'); }
      if (openBtn) openBtn.addEventListener('click', open);
      if (refreshBtn) refreshBtn.addEventListener('click', function() { try { refreshConfigStatus({ force: true, preserveView: true }); } catch (_) {} });
      if (reconcileBtn) reconcileBtn.addEventListener('click', function() { try { reconcileSalesTruth({}); } catch (_) {} });
      if (closeBtn) closeBtn.addEventListener('click', close);
      modal.addEventListener('click', function(e) { if (e.target === modal) close(); });
      document.addEventListener('keydown', function(e) { if (e.key === 'Escape') close(); });
    })();

    (function initKpiCompareModal() {
      const modal = document.getElementById('kpi-compare-modal');
      const refreshBtn = document.getElementById('kpi-compare-refresh-btn');
      const closeBtn = document.getElementById('kpi-compare-close-btn');
      const kickerEl = document.getElementById('kpi-compare-kicker');
      if (!modal) return;

      function kickerForKey(key) {
        const k = key ? String(key).trim().toLowerCase() : '';
        if (k === 'sessions') return 'Sessions';
        if (k === 'aov') return 'AOV';
        return 'Conversion rate';
      }

      function open(key) {
        activeKpiCompareKey = key ? String(key).trim().toLowerCase() : 'conv';
        if (kickerEl) kickerEl.textContent = kickerForKey(activeKpiCompareKey);
        modal.classList.add('open');
        modal.setAttribute('aria-hidden', 'false');
        try { refreshConfigStatus({ force: true, preserveView: true }); } catch (_) {}
      }
      function close() { modal.classList.remove('open'); modal.setAttribute('aria-hidden', 'true'); }

      document.addEventListener('click', function(e) {
        const target = e && e.target ? e.target : null;
        const btn = target && target.closest ? target.closest('.kpi-compare-open-btn[data-kpi-compare]') : null;
        if (!btn) return;
        e.preventDefault();
        e.stopPropagation();
        const key = (btn.getAttribute('data-kpi-compare') || '').trim().toLowerCase();
        open(key || 'conv');
      });

      if (refreshBtn) refreshBtn.addEventListener('click', function() { try { refreshConfigStatus({ force: true, preserveView: true }); } catch (_) {} });
      if (closeBtn) closeBtn.addEventListener('click', close);
      modal.addEventListener('click', function(e) { if (e.target === modal) close(); });
      document.addEventListener('keydown', function(e) {
        if (e.key !== 'Escape') return;
        if (!modal.classList.contains('open')) return;
        close();
      });
    })();

    (function initTrafficTypeTree() {
      const body = document.getElementById('traffic-types-body');
      if (!body) return;
      body.addEventListener('click', function(e) {
        const target = e && e.target ? e.target : null;
        const btn = target && target.closest ? target.closest('.traffic-type-toggle') : null;
        if (!btn) return;
        e.preventDefault();
        e.stopPropagation();
        const device = (btn.getAttribute('data-device') || '').trim().toLowerCase();
        if (!device) return;
        if (!trafficTypeExpanded || typeof trafficTypeExpanded !== 'object') {
          // First click: snapshot current groups as all-open, then toggle the clicked one
          trafficTypeExpanded = {};
          document.querySelectorAll('.traffic-type-parent[data-device]').forEach(function(row) {
            var d = (row.getAttribute('data-device') || '').trim().toLowerCase();
            if (d) trafficTypeExpanded[d] = true;
          });
        }
        const nextOpen = !trafficTypeExpanded[device];
        trafficTypeExpanded[device] = nextOpen;
        btn.setAttribute('aria-expanded', nextOpen ? 'true' : 'false');
        body.querySelectorAll('.grid-row.traffic-type-child[data-parent="' + device + '"]').forEach(function(tr) {
          tr.classList.toggle('is-hidden', !nextOpen);
        });
      });
    })();

    (function initTopBar() {
      try { saleMuted = sessionStorage.getItem(SALE_MUTED_KEY) === 'true'; } catch (_) { saleMuted = false; }
      try { saleAudio = new Audio(CASH_REGISTER_MP3_URL); } catch (_) { saleAudio = null; }
      if (saleAudio) {
        try { saleAudio.preload = 'auto'; } catch (_) {}
        try { saleAudio.load(); } catch (_) {}
        // Prime/unlock audio on the first user interaction so sale sounds can play later.
        (function primeOnFirstGesture() {
          function prime() { try { primeSaleAudio(); } catch (_) {} }
          document.addEventListener('pointerdown', prime, { once: true, capture: true });
          document.addEventListener('keydown', prime, { once: true, capture: true });
          document.addEventListener('click', prime, { once: true, capture: true });
        })();
      }
      const muteBtn = document.getElementById('audio-mute-btn');
      const iconOn = muteBtn && muteBtn.querySelector('.sound-icon-on');
      const iconOff = muteBtn && muteBtn.querySelector('.sound-icon-off');
      if (muteBtn) {
        if (iconOn) iconOn.classList.toggle('is-hidden', saleMuted);
        if (iconOff) iconOff.classList.toggle('is-hidden', !saleMuted);
        muteBtn.classList.toggle('muted', saleMuted);
        muteBtn.addEventListener('click', function() {
          saleMuted = !saleMuted;
          try { sessionStorage.setItem(SALE_MUTED_KEY, String(saleMuted)); } catch (_) {}
          if (iconOn) iconOn.classList.toggle('is-hidden', saleMuted);
          if (iconOff) iconOff.classList.toggle('is-hidden', !saleMuted);
          muteBtn.classList.toggle('muted', saleMuted);
          if (!saleMuted) {
            // User gesture: unlock audio so future sale sounds work.
            try { primeSaleAudio(); } catch (_) {}
          }
        });
      }
      // Test sale sound: add ?cha=ching to the URL. Plays once when sound is on; if autoplay blocked, plays on first click.
      (function testChaChing() {
        if (new URLSearchParams(window.location.search).get('cha') !== 'ching' || !saleAudio) return;
        function playTest() {
          if (saleMuted) return;
          saleAudio.currentTime = 0;
          saleAudio.play().catch(function() {});
        }
        playTest();
        document.body.addEventListener('click', function once() {
          document.body.removeEventListener('click', once);
          playTest();
        }, { once: true });
      })();
      const dateSelect = document.getElementById('global-date-select');
      if (dateSelect) {
        syncDateSelectOptions();
        applyRangeAvailable({ today: true, yesterday: true });
        updateLiveViewTitle();
        updateRowsPerPageVisibility();
        dateSelect.addEventListener('change', function() {
          const next = String(this.value || '').trim().toLowerCase();
          try {
            const opt = this.querySelector('option[value="' + next + '"]');
            if (opt && opt.disabled) {
              this.value = 'today';
              return;
            }
          } catch (_) {}
          if (next === 'custom') {
            openCustomDateModal();
            // Revert the select so "Custom" can be selected again.
            syncDateSelectOptions();
            return;
          }
          if (next === 'today' || next === 'yesterday') {
            dateRange = next;
            applyDateRangeChange();
            return;
          }
          // Defensive: allow selecting an applied range key if present.
          if (isCustomRangeKey(next)) {
            dateRange = next;
            applyDateRangeChange();
          }
        });
        initCustomDateModal();
      }
      (function initMobileDateMenu() {
        const btn = document.getElementById('mobile-date-btn');
        const menu = document.getElementById('mobile-date-menu');
        const sel = document.getElementById('global-date-select');
        if (!btn || !menu || !sel) return;

        function close() {
          menu.classList.remove('open');
          btn.setAttribute('aria-expanded', 'false');
        }

        function syncSelection() {
          let cur = String(dateRange || 'today');
          if (cur === 'live' || cur === 'sales' || cur === '1h') cur = 'today';
          if (typeof cur === 'string' && (cur.startsWith('r:') || cur.startsWith('d:'))) cur = 'custom';
          menu.querySelectorAll('.mobile-date-item[data-value]').forEach(function(it) {
            const v = it.getAttribute('data-value');
            it.setAttribute('aria-current', v === cur ? 'true' : 'false');
          });
        }

        function toggle(e) {
          if (e) {
            e.preventDefault();
            e.stopPropagation();
          }
          const nextOpen = !menu.classList.contains('open');
          if (nextOpen) syncSelection();
          menu.classList.toggle('open', nextOpen);
          btn.setAttribute('aria-expanded', nextOpen ? 'true' : 'false');
        }

        btn.addEventListener('click', toggle);
        menu.querySelectorAll('.mobile-date-item[data-value]').forEach(function(it) {
          it.addEventListener('click', function(e) {
            e.preventDefault();
            const v = String(it.getAttribute('data-value') || '').trim().toLowerCase();
            if (!v) return;
            try {
              const opt = sel.querySelector('option[value="' + v + '"]');
              if (opt && opt.disabled) return;
            } catch (_) {}
            sel.value = v;
            try {
              sel.dispatchEvent(new Event('change', { bubbles: true }));
            } catch (_) {
              // Fallback for older browsers
              const ev = document.createEvent('Event');
              ev.initEvent('change', true, true);
              sel.dispatchEvent(ev);
            }
            close();
          });
        });

        document.addEventListener('click', function(e) {
          if (!menu.classList.contains('open')) return;
          const target = e.target;
          if (menu.contains(target) || btn.contains(target)) return;
          close();
        });
        document.addEventListener('keydown', function(e) {
          if (e.key !== 'Escape') return;
          close();
        });
      })();
      (function initTableTitleTabs() {
        const tabsWrap = document.getElementById('table-title-tabs');
        if (!tabsWrap) return;
        function setRangeFromTab(range) {
          dateRange = range;
          if (dateRange === 'sales' || dateRange === '1h') {
            const sel = document.getElementById('global-date-select');
            if (sel) sel.value = 'today';
          }
          lastOnlineCount = null;
          countryPage = 1;
          updateLiveViewTitle();
          updateRowsPerPageVisibility();
          refreshKpis({ force: true });
          updateKpis();
          fetchSessions();
          updateNextUpdateUi();
        }
        document.querySelectorAll('#table-title-tabs button[data-range]').forEach(function(btn) {
          btn.addEventListener('click', function() { setRangeFromTab(btn.getAttribute('data-range')); });
        });
      })();
      (function initMainTabs() {
        const TAB_KEY = 'kexo-main-tab';
        const VALID_TABS = ['dashboard', 'spy', 'stats', 'breakdown', 'products', 'traffic', 'ads'];
        const TAB_LABELS = { dashboard: 'Dashboard', spy: 'Live View', breakdown: 'Overview', stats: 'Countries', products: 'Products', traffic: 'Traffic', ads: 'Ads' };
        const HASH_TO_TAB = { dashboard: 'dashboard', 'live-view': 'spy', overview: 'breakdown', countries: 'stats', products: 'products', traffic: 'traffic', ads: 'ads' };
        const TAB_TO_HASH = { dashboard: 'dashboard', spy: 'live-view', breakdown: 'overview', stats: 'countries', products: 'products', traffic: 'traffic', ads: 'ads' };
        const tabDashboard = document.getElementById('nav-tab-dashboard');
        const tabSpy = document.getElementById('nav-tab-spy');
        const tabStats = document.getElementById('nav-tab-stats');
        const tabBreakdown = document.getElementById('nav-tab-breakdown');
        const tabProducts = document.getElementById('nav-tab-products');
        const tabTraffic = document.getElementById('nav-tab-traffic');
        const tabAds = document.getElementById('nav-tab-ads');
        const tabTools = document.getElementById('nav-tab-tools');
        const panelDashboard = document.getElementById('tab-panel-dashboard');
        const panelSpy = document.getElementById('tab-panel-spy');
        const panelStats = document.getElementById('tab-panel-stats');
        const panelBreakdown = document.getElementById('tab-panel-breakdown');
        const panelProducts = document.getElementById('tab-panel-products');
        const panelTraffic = document.getElementById('tab-panel-traffic');
        const panelAds = document.getElementById('tab-panel-ads');
        const mobileBtn = document.getElementById('mobile-tabs-btn');
        const mobileMenu = document.getElementById('mobile-tabs-menu');
        const mobileCurrent = document.getElementById('mobile-tabs-current');
        const pageTitleEl = document.getElementById('page-title');

        // Ads tab: lazy-load /ads.js only when Ads is opened.
        let adsLoading = null;
        let adsLoaded = false;
        function ensureAdsLoaded() {
          if (adsLoaded) return Promise.resolve(true);
          if (adsLoading) return adsLoading;
          adsLoading = new Promise(function(resolve) {
            const existing = document.querySelector('script[data-ads-js="1"]');
            if (existing) {
              adsLoaded = true;
              resolve(true);
              return;
            }
            const s = document.createElement('script');
            s.src = '/ads.js';
            s.async = true;
            s.defer = true;
            s.setAttribute('data-ads-js', '1');
            s.onload = function() {
              adsLoaded = true;
              resolve(true);
            };
            s.onerror = function() {
              resolve(false);
            };
            document.head.appendChild(s);
          }).finally(function() {
            adsLoading = null;
          });
          return adsLoading;
        }

        function closeMobileMenu() {
          if (!mobileMenu || !mobileBtn) return;
          mobileMenu.classList.remove('open');
          mobileBtn.setAttribute('aria-expanded', 'false');
        }

        function syncMobileMenu(tab) {
          if (mobileCurrent) {
            mobileCurrent.textContent = TAB_LABELS[tab] || 'Dashboard';
          }
          if (mobileMenu) {
            mobileMenu.querySelectorAll('.mobile-tabs-item[data-tab]').forEach(function(btn) {
              const t = btn.getAttribute('data-tab');
              btn.setAttribute('aria-current', t === tab ? 'true' : 'false');
            });
          }
        }

        function toggleMobileMenu() {
          if (!mobileMenu || !mobileBtn) return;
          const nextOpen = !mobileMenu.classList.contains('open');
          mobileMenu.classList.toggle('open', nextOpen);
          mobileBtn.setAttribute('aria-expanded', nextOpen ? 'true' : 'false');
        }

        function tabFromHash() {
          var h = location.hash ? location.hash.replace(/^#/, '').toLowerCase() : '';
          return HASH_TO_TAB[h] || null;
        }

        var hashUpdateInProgress = false;
        function setHash(tab) {
          var h = TAB_TO_HASH[tab] || 'dashboard';
          if (location.hash === '#' + h) return;
          hashUpdateInProgress = true;
          try { history.replaceState(null, '', '#' + h); } catch (_) {}
          hashUpdateInProgress = false;
        }

        function setTab(tab) {
          var isDashboard = tab === 'dashboard';
          var isSpy = tab === 'spy';
          var isStats = tab === 'stats';
          var isBreakdown = tab === 'breakdown';
          var isProducts = tab === 'products';
          var isTraffic = tab === 'traffic';
          var isAds = tab === 'ads';
          var isTools = tab === 'tools';
          if (isTools) {
            try {
              var qs = window.location && window.location.search ? String(window.location.search) : '';
              window.location.href = '/tools' + (qs || '');
              return;
            } catch (_) {
              window.location.href = '/tools';
              return;
            }
          }
          activeMainTab = tab;
          syncMobileMenu(tab);
          closeMobileMenu();
          setHash(tab);

          // Update page title
          if (pageTitleEl) {
            pageTitleEl.textContent = TAB_LABELS[tab] || 'Dashboard';
          }

          if (tabDashboard) tabDashboard.setAttribute('aria-selected', isDashboard ? 'true' : 'false');
          if (tabSpy) tabSpy.setAttribute('aria-selected', isSpy ? 'true' : 'false');
          if (tabStats) tabStats.setAttribute('aria-selected', isStats ? 'true' : 'false');
          if (tabBreakdown) tabBreakdown.setAttribute('aria-selected', isBreakdown ? 'true' : 'false');
          if (tabProducts) tabProducts.setAttribute('aria-selected', isProducts ? 'true' : 'false');
          if (tabTraffic) tabTraffic.setAttribute('aria-selected', isTraffic ? 'true' : 'false');
          if (tabAds) tabAds.setAttribute('aria-selected', isAds ? 'true' : 'false');
          if (tabTools) tabTools.setAttribute('aria-selected', 'false');
          if (panelDashboard) panelDashboard.classList.toggle('active', isDashboard);
          if (panelSpy) panelSpy.classList.toggle('active', isSpy);
          if (panelStats) panelStats.classList.toggle('active', isStats);
          if (panelBreakdown) panelBreakdown.classList.toggle('active', isBreakdown);
          if (panelProducts) panelProducts.classList.toggle('active', isProducts);
          if (panelTraffic) panelTraffic.classList.toggle('active', isTraffic);
          if (panelAds) panelAds.classList.toggle('active', isAds);
          var sharedKpiWrap = document.querySelector('.shared-kpi-wrap');
          if (sharedKpiWrap) sharedKpiWrap.style.display = isDashboard ? 'none' : '';
          var globalDateSel = document.getElementById('global-date-select');
          if (globalDateSel) globalDateSel.style.display = isDashboard ? 'none' : '';
          var mobileDateBtn = document.getElementById('mobile-date-btn');
          if (mobileDateBtn) mobileDateBtn.style.display = isDashboard ? 'none' : '';

          try { sessionStorage.setItem(TAB_KEY, tab); } catch (_) {}
          syncDateSelectOptions();
          updateNextUpdateUi();
          function ensureKpis() {
            var staleKpis = !lastKpisFetchedAt || (Date.now() - lastKpisFetchedAt) > KPI_REFRESH_MS;
            if (staleKpis) refreshKpis({ force: false });
            else renderLiveKpis(getKpiData());
          }
          if (tab === 'dashboard') {
            try { if (typeof refreshDashboard === 'function') refreshDashboard({ force: false }); } catch (_) {}
          } else if (tab === 'stats') {
            // Always refresh when entering Geos so tables are never stuck on "Loading..."
            refreshStats({ force: false });
            ensureKpis();
          } else if (tab === 'breakdown') {
            refreshBreakdown({ force: false });
            // AOV grid now lives on Overview tab; ensure stats data is loaded for it
            if (statsCache && statsCache.country) renderAov(statsCache);
            else refreshStats({ force: false });
            ensureKpis();
          } else if (tab === 'products') {
            refreshProducts({ force: false });
            ensureKpis();
          } else if (tab === 'traffic') {
            refreshTraffic({ force: false });
            ensureKpis();
          } else if (tab === 'ads') {
            ensureKpis();
            ensureAdsLoaded().then(function(ok) {
              if (!ok) return;
              try {
                if (window.__adsInit) window.__adsInit();
                else if (window.__adsRefresh) window.__adsRefresh({ force: false });
              } catch (_) {}
            });
          } else {
            var sessionStaleMs = dateRange === 'live' ? LIVE_REFRESH_MS : (dateRange === 'today' || dateRange === 'sales' || dateRange === '1h' ? RANGE_REFRESH_MS : LIVE_REFRESH_MS);
            var staleSessions = !lastSessionsFetchedAt || (Date.now() - lastSessionsFetchedAt) > sessionStaleMs;
            if (staleSessions) fetchSessions();
            ensureKpis();
          }
        }

        try { window.setTab = setTab; } catch (_) {}

        // Hash-based routing: hash overrides sessionStorage
        var initialTab = 'dashboard';
        var hashTab = tabFromHash();
        if (hashTab && VALID_TABS.indexOf(hashTab) !== -1) {
          initialTab = hashTab;
        } else {
          try {
            var saved = sessionStorage.getItem(TAB_KEY);
            if (saved && VALID_TABS.indexOf(saved) !== -1) initialTab = saved;
          } catch (_) {}
        }
        setTab(initialTab);

        window.addEventListener('hashchange', function() {
          if (hashUpdateInProgress) return;
          var t = tabFromHash();
          if (t && VALID_TABS.indexOf(t) !== -1 && t !== activeMainTab) setTab(t);
        });

        if (tabDashboard) tabDashboard.addEventListener('click', function() { setTab('dashboard'); });
        if (tabSpy) tabSpy.addEventListener('click', function() { setTab('spy'); });
        if (tabStats) tabStats.addEventListener('click', function() { setTab('stats'); });
        if (tabBreakdown) tabBreakdown.addEventListener('click', function() { setTab('breakdown'); });
        if (tabProducts) tabProducts.addEventListener('click', function() { setTab('products'); });
        if (tabTraffic) tabTraffic.addEventListener('click', function() { setTab('traffic'); });
        if (tabAds) tabAds.addEventListener('click', function() { setTab('ads'); });
        if (tabTools) tabTools.addEventListener('click', function() { setTab('tools'); });
        if (mobileBtn && mobileMenu) {
          mobileBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            toggleMobileMenu();
          });
          mobileMenu.querySelectorAll('.mobile-tabs-item[data-tab]').forEach(function(btn) {
            btn.addEventListener('click', function(e) {
              e.preventDefault();
              var t = btn.getAttribute('data-tab') || 'dashboard';
              setTab(t);
            });
          });
          document.addEventListener('click', function(e) {
            if (!mobileMenu.classList.contains('open')) return;
            var target = e.target;
            if (mobileMenu.contains(target) || mobileBtn.contains(target)) return;
            closeMobileMenu();
          });
          document.addEventListener('keydown', function(e) {
            if (e.key !== 'Escape') return;
            closeMobileMenu();
          });
        }
      })();
      (function initRefreshBtn() {
        const btn = document.getElementById('refresh-btn');
        if (btn) {
          btn.addEventListener('click', function() {
            btn.classList.add('spinning');
            setTimeout(function() { btn.classList.remove('spinning'); }, 800);
            // If Settings/Diagnostics modal is open, refresh diagnostics too (but keep the user's view).
            try {
              if (typeof isConfigModalOpen === 'function' && isConfigModalOpen()) {
                refreshConfigStatus({ force: true, preserveView: true });
              }
            } catch (_) {}
            if (activeMainTab === 'dashboard') { try { if (typeof refreshDashboard === 'function') refreshDashboard({ force: true }); } catch (_) {} }
            else if (activeMainTab === 'stats') refreshStats({ force: true });
            else if (activeMainTab === 'breakdown') refreshBreakdown({ force: true });
            else if (activeMainTab === 'products') refreshProducts({ force: true });
            else if (activeMainTab === 'traffic') refreshTraffic({ force: true });
            else if (activeMainTab === 'ads') { try { if (window.__adsRefresh) window.__adsRefresh({ force: true }); } catch (_) {} }
            else fetchSessions();
          });
        }
      })();
      updateServerTimeDisplay();
      updateNextUpdateUi();
      setInterval(function() {
        updateServerTimeDisplay();
        updateNextUpdateUi();
      }, 1000);
    })();

    (function setupStatsCardScrollHideHeader() {
      function onScroll(wrapId, cardId) {
        const wrap = document.getElementById(wrapId);
        const card = document.getElementById(cardId);
        if (!wrap || !card) return;
        function update() {
          card.classList.toggle('scrolled', wrap.scrollTop > 0);
        }
        wrap.addEventListener('scroll', update);
        update();
      }
      onScroll('country-table-wrap', 'stats-country');
      onScroll('best-sellers-wrap', 'stats-best-sellers');
      onScroll('best-variants-wrap', 'stats-best-variants');
    })();

    // Load traffic source mapping + custom icons (best-effort).
    try { refreshTrafficSourceMeta({ force: false }); } catch (_) {}

    function onLiveAutoRefreshTick() {
      if (activeMainTab !== 'spy') return;
      if (dateRange !== 'live') return;
      if (document.visibilityState !== 'visible') return;
      fetchSessions();
    }

    function onRangeAutoRefreshTick() {
      if (activeMainTab !== 'spy') return;
      if (dateRange !== 'today' && dateRange !== 'sales' && dateRange !== '1h') return;
      if (document.visibilityState !== 'visible') return;
      if (Date.now() < nextRangeAt) return;
      fetchSessions();
    }

    function onStatsAutoRefreshTick() {
      if (activeMainTab !== 'stats') return;
      if (getStatsRange() !== 'today') return;
      if (document.visibilityState !== 'visible') return;
      refreshStats({ force: false });
    }

    function onKpisAutoRefreshTick() {
      if (document.visibilityState !== 'visible') return;
      refreshKpis({ force: false });
    }

    function onBreakdownAutoRefreshTick() {
      if (activeMainTab !== 'breakdown') return;
      if (getStatsRange() !== 'today') return;
      if (document.visibilityState !== 'visible') return;
      refreshBreakdown({ force: false });
    }

    function onProductsAutoRefreshTick() {
      if (activeMainTab !== 'products') return;
      if (getStatsRange() !== 'today') return;
      if (document.visibilityState !== 'visible') return;
      refreshProducts({ force: false });
    }

    function onTrafficAutoRefreshTick() {
      if (activeMainTab !== 'traffic') return;
      if (getStatsRange() !== 'today') return;
      if (document.visibilityState !== 'visible') return;
      refreshTraffic({ force: false });
    }

    // Live: refresh every 60s. Today/Sales: refresh every 5 min. Breakdown/Products/Traffic: every 5 min (Today only).
    setInterval(onLiveAutoRefreshTick, LIVE_REFRESH_MS);
    setInterval(onRangeAutoRefreshTick, 60000); // check every 60s whether to refresh Today/Sales (5 min interval)
    setInterval(onKpisAutoRefreshTick, KPI_REFRESH_MS);
    setInterval(onStatsAutoRefreshTick, STATS_REFRESH_MS);
    setInterval(onBreakdownAutoRefreshTick, STATS_REFRESH_MS);
    setInterval(onProductsAutoRefreshTick, STATS_REFRESH_MS);
    setInterval(onTrafficAutoRefreshTick, STATS_REFRESH_MS);
    setInterval(tickTimeOnSite, 30000);
    // Online count: when not on Live, refresh every 60s so Online always shows real people online
    setInterval(function() {
      if (activeMainTab !== 'spy' || dateRange === 'live') return;
      fetchOnlineCount();
    }, LIVE_REFRESH_MS);
    // Prune stale sessions from Live list (e.g. tab left open, no SSE update) so they drop off after 10 min or if arrived too long ago
    setInterval(function() {
      if (activeMainTab !== 'spy' || dateRange !== 'live') return;
      var cutoff = Date.now() - ACTIVE_WINDOW_MS;
      var arrivedCutoff = Date.now() - ARRIVED_WINDOW_MS;
      var before = sessions.length;
      sessions = sessions.filter(function(s) {
        return s.last_seen != null && s.last_seen >= cutoff &&
          s.started_at != null && s.started_at >= arrivedCutoff;
      });
      if (sessions.length !== before) { currentPage = 1; renderTable(); updateKpis(); }
    }, 30000);

    document.addEventListener('visibilitychange', function() {
      if (document.visibilityState !== 'visible') return;
      updateNextUpdateUi();
      refreshKpis({ force: false });
      if (activeMainTab === 'stats') {
        const stale = !lastStatsFetchedAt || (Date.now() - lastStatsFetchedAt) > STATS_REFRESH_MS;
        if (stale) refreshStats({ force: false });
      } else if (activeMainTab === 'breakdown') {
        const staleBreakdown = !lastBreakdownFetchedAt || (Date.now() - lastBreakdownFetchedAt) > STATS_REFRESH_MS;
        if (staleBreakdown) refreshBreakdown({ force: false });
      } else if (activeMainTab === 'products') {
        const staleProducts = !lastProductsFetchedAt || (Date.now() - lastProductsFetchedAt) > STATS_REFRESH_MS;
        if (staleProducts) refreshProducts({ force: false });
      } else if (activeMainTab === 'traffic') {
        const staleTraffic = !lastTrafficFetchedAt || (Date.now() - lastTrafficFetchedAt) > STATS_REFRESH_MS;
        if (staleTraffic) refreshTraffic({ force: false });
      } else if (activeMainTab === 'ads') {
        try { if (window.__adsRefresh) window.__adsRefresh({ force: false }); } catch (_) {}
      } else {
        const sessionStaleMs = dateRange === 'live' ? LIVE_REFRESH_MS : (dateRange === 'today' || dateRange === 'sales' || dateRange === '1h' ? RANGE_REFRESH_MS : LIVE_REFRESH_MS);
        const stale = !lastSessionsFetchedAt || (Date.now() - lastSessionsFetchedAt) > sessionStaleMs;
        if (stale) fetchSessions();
      }
    });

    const es = new EventSource(API + '/api/stream');
    es.onmessage = (e) => {
      try {
        const msg = JSON.parse(e.data);
        if (msg.type === 'session_update' && msg.session) {
          const session = msg.session;
          // Keep footer "Last sale" correct even when not on Live tab.
          if (session && session.has_purchased && session.purchased_at != null) {
            setLastSaleAt(session.purchased_at);
          }
          if (activeMainTab !== 'spy' || dateRange !== 'live') return;
          const lastSeen = session.last_seen != null ? Number(session.last_seen) : 0;
          const startedAt = session.started_at != null ? Number(session.started_at) : 0;
          const withinActive = lastSeen >= Date.now() - ACTIVE_WINDOW_MS;
          const withinArrived = startedAt >= Date.now() - ARRIVED_WINDOW_MS;
          const idx = sessions.findIndex(s => s.session_id === session.session_id);
          let becamePurchased = false;
          let filledOrderTotal = false;
          let needRender = false;
          if (idx >= 0) {
            if (!withinActive || !withinArrived) {
              sessions.splice(idx, 1);
              needRender = true;
            } else {
              const wasPurchased = !!sessions[idx].has_purchased;
              const wasOrderTotal = sessions[idx].order_total != null;
              sessions[idx] = { ...sessions[idx], ...session };
              const nowPurchased = !!sessions[idx].has_purchased;
              const nowOrderTotal = sessions[idx].order_total != null;
              becamePurchased = (!wasPurchased && nowPurchased);
              filledOrderTotal = (nowPurchased && !wasOrderTotal && nowOrderTotal);
              sessions.sort(function(a, b) { return (b.last_seen || 0) - (a.last_seen || 0); });
              if (becamePurchased || filledOrderTotal) needRender = true;
              // Avoid a second "cha-ching" when order_total arrives after has_purchased.
              // If the toast is currently showing for this session, just patch the amount.
              if (filledOrderTotal) {
                try {
                  const sid = session && session.session_id != null ? String(session.session_id) : '';
                  if (sid && saleToastActive && saleToastSessionId && String(saleToastSessionId) === sid) {
                    const cc = session && session.country_code ? String(session.country_code).toUpperCase().slice(0, 2) : 'XX';
                    const productTitle = (session && session.last_product_handle) ? titleCaseFromHandle(String(session.last_product_handle)) : '';
                    const curTitle = document.getElementById('sale-toast-product') ? String(document.getElementById('sale-toast-product').textContent || '') : '';
                    let amountGbp = null;
                    if (session && session.order_total != null) {
                      const n = typeof session.order_total === 'number' ? session.order_total : parseFloat(String(session.order_total));
                      if (Number.isFinite(n)) amountGbp = n;
                    }
                    if (amountGbp != null && Number.isFinite(amountGbp)) {
                      setSaleToastContent({ countryCode: cc || 'XX', productTitle: (productTitle || curTitle || '—'), amountGbp });
                    }
                  }
                } catch (_) {}
              }
            }
          } else if (withinActive && withinArrived) {
            sessions.unshift(session);
            sessions.sort(function(a, b) { return (b.last_seen || 0) - (a.last_seen || 0); });
            // Don't play sound when adding a session that's already purchased (e.g. re-add after prune, or heartbeat from old sale)
            becamePurchased = false;
            needRender = true;
          }
          if (needRender) {
            if (becamePurchased) {
              currentPage = 1;
              triggerSaleToast({ origin: 'sse', session: session, playSound: true });
              // Update footer immediately when a sale happens.
              setLastSaleAt(session.purchased_at || session.last_seen || Date.now());
              // Keep the converted-count baseline in sync so KPI/stats refreshes don't double-trigger audio.
              try {
                const day = ymdNowInTz();
                if (convertedCountDayYmd == null) convertedCountDayYmd = day;
                if (day && convertedCountDayYmd !== day) {
                  convertedCountDayYmd = day;
                  hasSeenConvertedCountToday = false;
                  lastConvertedCountToday = 0;
                }
                if (hasSeenConvertedCountToday) lastConvertedCountToday = (Number(lastConvertedCountToday) || 0) + 1;
              } catch (_) {}
              // Avoid background refreshes while the Diagnostics modal is open (don't disrupt reading).
              try {
                if (!(typeof isConfigModalOpen === 'function' && isConfigModalOpen())) {
                  refreshConfigStatus();
                }
              } catch (_) {}
              // Pull updated KPIs so Sales/Orders can animate immediately.
              try { refreshKpis({ force: true }); } catch (_) {}
            }
            renderTable();
            updateKpis();
          }
        }
      } catch (_) {}
    };
    // ── Dashboard tab logic ──────────────────────────────────────────────
    (function initDashboard() {
      var dashCache = null;
      var dashLoading = false;
      var dashLastDays = 30;
      var dashCharts = {};
      var DASH_ACCENT = '#0d9488';
      var DASH_ACCENT_LIGHT = 'rgba(13,148,136,0.12)';
      var DASH_ORANGE = '#f59e0b';
      var DASH_ORANGE_LIGHT = 'rgba(245,158,11,0.10)';
      var DASH_BLUE = '#3b82f6';
      var DASH_BLUE_LIGHT = 'rgba(59,130,246,0.10)';
      var DASH_PURPLE = '#8b5cf6';
      var DASH_PURPLE_LIGHT = 'rgba(139,92,246,0.10)';

      function fmtGbp(n) { return '\u00A3' + (n % 1 === 0 ? n.toLocaleString() : n.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })); }
      function fmtNum(n) { return n != null ? n.toLocaleString() : '\u2014'; }
      function fmtPct(n) { return n != null ? n.toFixed(1) + '%' : '\u2014'; }
      function shortDate(ymd) {
        var parts = ymd.split('-');
        var d = parseInt(parts[2], 10);
        var months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
        var m = months[parseInt(parts[1], 10) - 1] || '';
        return d + ' ' + m;
      }

      function makeChart(canvasId, labels, datasets, opts) {
        if (typeof Chart === 'undefined') return null;
        var ctx = document.getElementById(canvasId);
        if (!ctx) return null;
        if (dashCharts[canvasId]) { try { dashCharts[canvasId].destroy(); } catch (_) {} }
        var yType = (opts && opts.pct) ? {
          ticks: { callback: function(v) { return v + '%'; }, font: { size: 11 } },
          beginAtZero: true,
          grid: { color: 'rgba(0,0,0,0.04)' }
        } : (opts && opts.currency) ? {
          ticks: { callback: function(v) { return '\u00A3' + v.toLocaleString(); }, font: { size: 11 } },
          beginAtZero: true,
          grid: { color: 'rgba(0,0,0,0.04)' }
        } : {
          ticks: { font: { size: 11 } },
          beginAtZero: true,
          grid: { color: 'rgba(0,0,0,0.04)' }
        };
        var chart = new Chart(ctx, {
          type: 'line',
          data: { labels: labels, datasets: datasets },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { intersect: false, mode: 'index' },
            plugins: {
              legend: { display: datasets.length > 1, position: 'top', labels: { usePointStyle: true, padding: 12, font: { size: 11 } } },
              tooltip: {
                backgroundColor: 'rgba(0,0,0,0.8)',
                titleFont: { size: 12 },
                bodyFont: { size: 12 },
                padding: 10,
                cornerRadius: 6,
                callbacks: (opts && opts.pct) ? {
                  label: function(ctx2) { return (ctx2.dataset.label || '') + ': ' + (ctx2.parsed.y != null ? ctx2.parsed.y.toFixed(1) + '%' : '\u2014'); }
                } : (opts && opts.currency) ? {
                  label: function(ctx2) { return (ctx2.dataset.label || '') + ': \u00A3' + (ctx2.parsed.y != null ? ctx2.parsed.y.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : '\u2014'); }
                } : {}
              }
            },
            scales: {
              x: { ticks: { font: { size: 10 }, maxRotation: 0, autoSkipPadding: 12 }, grid: { display: false } },
              y: yType
            },
            elements: { point: { radius: 2, hoverRadius: 5 }, line: { tension: 0.3 } }
          }
        });
        dashCharts[canvasId] = chart;
        return chart;
      }

      function renderDashboard(data) {
        if (!data) return;
        var s = data.summary || {};
        var el = function(id) { return document.getElementById(id); };
        if (el('dash-kpi-revenue')) el('dash-kpi-revenue').textContent = s.revenue != null ? fmtGbp(s.revenue) : '\u2014';
        if (el('dash-kpi-orders')) el('dash-kpi-orders').textContent = s.orders != null ? fmtNum(s.orders) : '\u2014';
        if (el('dash-kpi-sessions')) el('dash-kpi-sessions').textContent = s.sessions != null ? fmtNum(s.sessions) : '\u2014';
        if (el('dash-kpi-conv')) el('dash-kpi-conv').textContent = s.convRate != null ? fmtPct(s.convRate) : '\u2014';
        if (el('dash-kpi-aov')) el('dash-kpi-aov').textContent = s.aov != null ? fmtGbp(s.aov) : '\u2014';
        if (el('dash-kpi-adspend')) el('dash-kpi-adspend').textContent = s.adSpend != null && s.adSpend > 0 ? fmtGbp(s.adSpend) : '\u2014';

        var series = data.series || [];
        var labels = series.map(function(d) { return shortDate(d.date); });

        makeChart('dash-chart-revenue', labels, [{
          label: 'Revenue',
          data: series.map(function(d) { return d.revenue; }),
          borderColor: DASH_ACCENT,
          backgroundColor: DASH_ACCENT_LIGHT,
          fill: true,
          borderWidth: 2
        }], { currency: true });

        makeChart('dash-chart-orders', labels, [{
          label: 'Orders',
          data: series.map(function(d) { return d.orders; }),
          borderColor: DASH_BLUE,
          backgroundColor: DASH_BLUE_LIGHT,
          fill: true,
          borderWidth: 2
        }]);

        var hasShopifyConv = series.some(function(d) { return d.shopifyConvRate != null; });
        var convDatasets = [{
          label: 'Kexo Conv Rate',
          data: series.map(function(d) { return d.convRate; }),
          borderColor: DASH_PURPLE,
          backgroundColor: DASH_PURPLE_LIGHT,
          fill: true,
          borderWidth: 2
        }];
        if (hasShopifyConv) {
          convDatasets.push({
            label: 'Shopify Conv Rate',
            data: series.map(function(d) { return d.shopifyConvRate; }),
            borderColor: '#5c6ac4',
            backgroundColor: 'rgba(92,106,196,0.10)',
            fill: false,
            borderWidth: 2,
            borderDash: [5, 3]
          });
        }
        makeChart('dash-chart-conv', labels, convDatasets, { pct: true });

        makeChart('dash-chart-sessions', labels, [{
          label: 'Sessions',
          data: series.map(function(d) { return d.sessions; }),
          borderColor: DASH_ORANGE,
          backgroundColor: DASH_ORANGE_LIGHT,
          fill: true,
          borderWidth: 2
        }]);

        var hasAdSpend = series.some(function(d) { return d.adSpend > 0; });
        var adRow = el('dash-adspend-row');
        var roasRow = el('dash-roas-row');
        if (adRow) adRow.style.display = hasAdSpend ? '' : 'none';
        if (roasRow) roasRow.style.display = (hasAdSpend && s.roas != null) ? '' : 'none';
        if (hasAdSpend) {
          makeChart('dash-chart-adspend', labels, [{
            label: 'Revenue',
            data: series.map(function(d) { return d.revenue; }),
            borderColor: DASH_ACCENT,
            backgroundColor: 'transparent',
            borderWidth: 2
          }, {
            label: 'Ad Spend',
            data: series.map(function(d) { return d.adSpend; }),
            borderColor: '#ef4444',
            backgroundColor: 'rgba(239,68,68,0.08)',
            fill: true,
            borderWidth: 2
          }], { currency: true });
          if (el('dash-kpi-roas')) el('dash-kpi-roas').textContent = s.roas != null ? s.roas.toFixed(2) + 'x' : '\u2014';
        }

        var prodTbody = el('dash-top-products') ? el('dash-top-products').querySelector('tbody') : null;
        if (prodTbody) {
          var products = data.topProducts || [];
          if (!products.length) {
            prodTbody.innerHTML = '<tr><td colspan="3" class="dash-empty">No data</td></tr>';
          } else {
            prodTbody.innerHTML = products.map(function(p) {
              var thumbHtml = p.thumb_url
                ? '<img src="' + escapeHtml(hotImg(p.thumb_url)) + '" width="32" height="32" style="border-radius:4px;object-fit:cover;vertical-align:middle;margin-right:0.5rem" loading="lazy" alt="">'
                : '';
              return '<tr><td><span style="display:inline-flex;align-items:center">' + thumbHtml + escapeHtml(p.title) + '</span></td><td>' + fmtGbp(p.revenue) + '</td><td>' + p.orders + '</td></tr>';
            }).join('');
          }
        }

        var countryTbody = el('dash-top-countries') ? el('dash-top-countries').querySelector('tbody') : null;
        if (countryTbody) {
          var countries = data.topCountries || [];
          if (!countries.length) {
            countryTbody.innerHTML = '<tr><td colspan="3" class="dash-empty">No data</td></tr>';
          } else {
            countryTbody.innerHTML = countries.map(function(c) {
              var cc = (c.country || 'XX').toUpperCase();
              var name = (typeof countryLabelFull === 'function') ? countryLabelFull(cc) : cc;
              return '<tr><td><span style="display:inline-flex;align-items:center;gap:0.5rem">' + flagImg(cc, name) + ' ' + escapeHtml(name) + '</span></td><td>' + fmtGbp(c.revenue) + '</td><td>' + c.orders + '</td></tr>';
            }).join('');
          }
        }
      }

      function fetchDashboardData(days, force) {
        if (dashLoading && !force) return;
        try {
          var n = parseInt(days, 10);
          if (!Number.isFinite(n) || n <= 0) n = 30;
          var todayYmd = ymdNowInTz();
          if (todayYmd && todayYmd >= MIN_YMD) {
            var a = new Date(MIN_YMD + 'T00:00:00.000Z');
            var b = new Date(todayYmd + 'T00:00:00.000Z');
            var maxDays = Math.floor((b.getTime() - a.getTime()) / 86400000) + 1;
            if (Number.isFinite(maxDays) && maxDays > 0) n = Math.min(n, maxDays);
          } else {
            n = 1;
          }
          days = n;
        } catch (_) {}
        dashLoading = true;
        var url = API + '/api/dashboard-series?days=' + days + (force ? '&_=' + Date.now() : '');
        fetchWithTimeout(url, { credentials: 'same-origin', cache: force ? 'no-store' : 'default' }, 30000)
          .then(function(r) { return (r && r.ok) ? r.json() : null; })
          .then(function(data) {
            dashLoading = false;
            if (data) {
              dashCache = data;
              dashLastDays = days;
              renderDashboard(data);
            }
          })
          .catch(function() {
            dashLoading = false;
          });
      }

      window.refreshDashboard = function(opts) {
        var force = opts && opts.force;
        var days = dashLastDays || 30;
        try { days = parseInt(document.getElementById('dash-range-select').value, 10) || 30; } catch (_) {}
        if (!force && dashCache && dashCache.days === days) {
          renderDashboard(dashCache);
          return;
        }
        fetchDashboardData(days, force);
      };

      var rangeSel = document.getElementById('dash-range-select');
      if (rangeSel) {
        (function syncDashRangeOptions() {
          try {
            var todayYmd = ymdNowInTz();
            var maxDays = 1;
            if (todayYmd && todayYmd >= MIN_YMD) {
              var a = new Date(MIN_YMD + 'T00:00:00.000Z');
              var b = new Date(todayYmd + 'T00:00:00.000Z');
              var diff = Math.floor((b.getTime() - a.getTime()) / 86400000) + 1;
              if (Number.isFinite(diff) && diff > 0) maxDays = diff;
            }

            var hadOk = false;
            for (var i = 0; i < rangeSel.options.length; i++) {
              var opt = rangeSel.options[i];
              var v = parseInt(opt.value, 10);
              var ok = Number.isFinite(v) && v > 0 && v <= maxDays;
              opt.disabled = !ok;
              try { opt.hidden = !ok; } catch (_) {}
              if (ok) hadOk = true;
            }
            if (!hadOk) {
              var o = document.createElement('option');
              o.value = String(maxDays);
              o.textContent = 'Since ' + formatYmdLabel(MIN_YMD);
              o.selected = true;
              rangeSel.insertBefore(o, rangeSel.firstChild);
            } else {
              var selOpt = rangeSel.options[rangeSel.selectedIndex];
              if (selOpt && selOpt.disabled) {
                for (var j = 0; j < rangeSel.options.length; j++) {
                  if (!rangeSel.options[j].disabled) { rangeSel.selectedIndex = j; break; }
                }
              }
            }
          } catch (_) {}
        })();
        rangeSel.addEventListener('change', function() {
          var days = parseInt(rangeSel.value, 10) || 30;
          fetchDashboardData(days, true);
        });
      }

      // Initial fetch: refreshDashboard is defined after setTab('dashboard') runs,
      // so the initial setTab call can't trigger it. Kick it off now if dashboard is active.
      var dashPanel = document.getElementById('tab-panel-dashboard');
      if (dashPanel && dashPanel.classList.contains('active')) {
        fetchDashboardData(parseInt((rangeSel && rangeSel.value) || '30', 10), false);
      }
    })();
  </script>
</body>
</html>
