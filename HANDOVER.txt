KEXO Liveview — HANDOVER (keep current)
Last updated: 2026-02-13 (Tables: sticky ellipsis + no mobile header icons)

This repo ships a private Shopify app with a near-real-time Live Visitors dashboard. The frontend is Tabler-based and split into multiple HTML pages (folder-style routes) with shared partials and a shared JS bundle.

IMPORTANT (for future agents)
- Read this file before making changes (Cursor rules enforce this).
- Keep this file accurate. If you change core paths (routes/auth/dashboard UX/deploy), update this file in the SAME commit.
- This repo avoids new markdown docs; this handover is intentionally `HANDOVER.txt`.
- UI convention: cap font-weight at 500 (avoid heavier weights) for new dashboard UI.
- Diagnostics guardrail: when adding/moving/removing dashboard sections, update `server/trackerDefinitions.js` so Diagnostics → Definitions stays accurate.

---

## What KEXO looks like today (UX)

Desktop chrome (shared header across pages via `server/public/partials/header.html`):
- Top strip: live visitor count (left), centered logo, Settings dropdown (right). On new sale, a Tabler-style `tblr-banner` overlays the strip with gradient, "New Sale: Product Name" + price (10s auto-close; MP3 cha-ching).
- Main nav row below: grouped dropdown menus (Dashboard, Insights, Traffic, Integrations, Tools) + date range selector on the right.
- KPI strip: condensed KPI chips shown on most pages. Visibility is configurable per page via Settings → Layout → KPIs. It sits inside the sticky header wrapper so it stays pinned while scrolling.
- Page header: the per-page title row (category icon + pretitle + title + date control) stays inside the page body (not sticky). Layout is driven by `app.js` + `custom.css` (icon inside subtitle; title centered; date right) with segmented 2px connector lines around the title on simple pages.

Mobile:
- Uses the same shared top strip + main nav as desktop (no mobile-only hamburger header/overlay).
- Main nav is horizontally swipeable on touch screens; date-range control stays in the header row.
- Mobile UA requests are no longer redirected to `/mobile-unsupported`; dashboard/settings/tools routes render directly on mobile.
- Header stack is sticky via a shared wrapper (`.kexo-header-stack`) so strip + nav + KPI strip stay pinned together while scrolling.

KEXO “5-color” accents:
- The desktop nav uses a rotating 5-color accent for the active underline and related styling via `.kexo-5color`:
  - Accent 1: `#4b94e4` (blue)
  - Accent 2: `#3eb3ab` (teal)
  - Accent 3: `#f59e34` (orange)
  - Accent 4: `#8b5cf6` (purple)
  - Accent 5: `#ef4444` (red)
  - See: `server/public/custom.css` (`.kexo-5color`, `--kexo-accent-*`)

---

## Canonical pages + routes (folder URLs)

Rendered templates live under `server/public/**` and are served by `server/index.js` via `sendPage()` (includes + cache-control + asset versioning).

Dashboard:
- `/dashboard/overview` → `server/public/dashboard/overview.html` (`data-page="dashboard"`) — top tables now include CR%
- `/dashboard/live` → `server/public/dashboard/live.html` — desktop shows a Latest sales card beside the map (last 5 sales)
- `/dashboard/sales` → `server/public/dashboard/sales.html`
- `/dashboard/table` → `server/public/dashboard/table.html`

Insights:
- `/insights/countries` → `server/public/insights/countries.html`
- `/insights/products` → `server/public/insights/products.html`
- `/insights/variants` → `server/public/insights/variants.html`

Traffic:
- `/traffic/channels` → `server/public/traffic/channels.html`
- `/traffic/device` → `server/public/traffic/device.html`

Integrations:
- `/integrations/google-ads` → `server/public/integrations/google-ads.html`

Tools:
- `/tools/compare-conversion-rate` → `server/public/tools/compare-conversion-rate.html`
- `/tools/shipping-cr` → `server/public/tools/shipping-cr.html`

Settings:
- `/settings` → `server/public/settings.html`

Legacy redirects (kept, query preserved):
- `/tools/ads` and `/ads` → `/integrations/google-ads`
- `/date` → `/dashboard/table`
- `/overview`, `/live`, `/sales`, `/countries`, `/products`, `/variants`, `/channels`, `/type`, `/compare-conversion-rate`, `/shipping-cr` → canonical folder routes

Root `/`:
- Shopify embedded app URL. `auth.handleAppUrl()` decides:
  - render embedded dashboard overview, or
  - redirect to `/dashboard/overview` when logged in, else `/app/login`

---

## Settings (GLOBAL) — what’s configurable today

Settings scope is intentionally GLOBAL/shared (user-specific settings are disabled for now).

Settings UI:
- `server/public/settings.html`: Settings page layout + tab shells
- `server/public/settings-page.js`: tab switching, saving, and Settings panel wiring

Settings tabs:
- General: current config display + Settings scope (locked global)
- Theme: theme editor (colors/fonts/icons/header)
- Assets: override logo/image URLs
- Data & Reporting: reporting source toggles (orders/sessions) + pixel session mode
- Integrations: Pixel + Google Ads status/actions
- Sources: UTM/source mapping
- Insights: tab shell for Products/Countries plus active Variants mapping manager (custom table/rule editor)
- Layout:
  - Tables: accordion-based per-page table config (name/order/grid, rows-per-page options/default, optional sticky column min/max) + shared converted-row color modal for Live/Table/Sales sessions tables
  - Charts: per-chart enable/type/colors (see Charts section)
  - KPIs: KPI order/labels/visibility + date-range labels/availability + header KPI strip page visibility
- Diagnostics: config-status + reconcile utilities rendered as a Tabler accordion (no tabs; Settings-first)

Settings API:
- `GET/POST /api/settings` in `server/routes/settings.js`
- Returned payload includes (among other fields): `reporting`, `kpiUiConfig`, `chartsUiConfig`, `tablesUiConfig`, `insightsVariantsConfig`

---

## Theme + Icons (GLOBAL)

Theme persistence:
- `GET/POST /api/theme-defaults` (POST uses patch semantics: only provided keys update).
- First-paint CSS variables are injected via `GET /theme-vars.css` and loaded in head (see `server/public/partials/head-theme.html`) to prevent header flash (and to hide disabled charts before paint).

Theme UI:
- `server/public/theme-settings.js` renders the Theme panel inside Settings.
- Header subtab contains non-color header controls only (visibility toggles, border on/off toggles, radius fields, logo override, strip padding, strip border-bottom toggle).
- Color subtab has 5 editable hex inputs for accents 1–5; strip, settings dropdown, menu, and online badge colors are derived from accent 1.
  - Strip opacity filter and Menu opacity filter (0–100%) control darkening of strip/menu backgrounds. Menu hover opacity (0–100%) and hover color (black/white) control the tint on menu link and dropdown item hover.
  - Settings dropdown inherits menu: same background, opacity, border, and link colors as the main menu; no separate dropdown settings.
- Early hydration in `server/public/partials/head-theme.html` loads 5 accent hex values from localStorage before paint.

Header + nav theming:
- Desktop top strip + main nav are styled via CSS vars in `server/public/custom.css`, overridden by `/theme-vars.css`.
- Examples:
  - `--kexo-header-top-bg`, `--kexo-header-top-text-color`
  - `--kexo-top-menu-bg` / `--kexo-header-main-bg`
  - `--kexo-top-menu-border-color`, `--kexo-top-menu-shadow`
  - Settings dropdown + Online badge have dedicated vars (bg/text/border/radius/menu colors)

Icons:
- Font Awesome kit is loaded globally in `partials/head-theme.html`.
- Runtime adapter: `server/public/fontawesome-icons.js`
  - Converts Tabler icon placeholders / inline nav SVGs to Font Awesome.
  - Icons are keyed via `data-icon-key="..."` across the app.
  - Settings-only icon keys (`settings-tab-*`, `settings-diagnostics-*`) are locked for stability.

---

## Charts (GLOBAL)

Charts are centrally configurable in Settings → Layout → Charts:
- DB key: `charts_ui_config_v1`
- Served by: `GET /api/settings` as `chartsUiConfig`
- Saved by: `POST /api/settings` (`chartsUiConfig` payload)
- Settings-side charts table rendering is lazy-on-tab-open (render when Layout → Charts is active) to avoid hidden-panel select/input rendering glitches.

Runtime apply:
- `server/public/app.js`: dashboard/insights/traffic charts + map behavior
- `server/public/ads.js`: Google Ads overview chart

Chart hiding (no flicker):
- Chart wrappers/cards in HTML carry `data-kexo-chart-key="<chartKey>"`.
- `GET /theme-vars.css` injects `display:none!important` for disabled charts so they disappear before first paint.
- Dashboard paired charts expand to full width when their partner is disabled (CSS injected server-side).

Libraries:
- ApexCharts for most charts
- jsVectorMap for the Countries map (supports `map-animated` vs `map-flat` and a configurable accent color)
- Chart.js is used only inside the Google Ads campaign modal (lazy-loaded)

---

## KPI system (GLOBAL)

KPI/date-range UI config:
- DB key: `kpi_ui_config_v1` (in `GET /api/settings` as `kpiUiConfig`)
- Applied by: `server/public/app.js` to:
  - condensed KPI strip order/labels/visibility + display options
  - condensed KPI strip show/hide per page (settings-managed)
  - dashboard KPI card order/labels/visibility
  - date range menu labels/availability
- First-paint behavior:
  - `app.js` hydrates KPI UI config from localStorage (`kexo:kpi-ui-config:v1`) and applies it before `/api/settings` resolves.
  - `/theme-vars.css` also injects CSS to pre-hide disabled condensed KPI chips and disabled Dashboard KPI cards (`#dash-kpi-grid`) to reduce refresh flicker.

KPI data:
- `GET /api/kpis` (server cached; also localStorage warm-paint to avoid empty chips on navigation)
- `GET /api/kpis-expanded-extra` for Shopify-derived extras (COGS, returns, items ordered, etc.)

---

## Key frontend files (high-signal)

- `server/public/partials/head-theme.html`: early theme hydration + loads `/theme-vars.css` + Font Awesome + `fontawesome-icons.js`
- `server/public/partials/header.html`: desktop strip + desktop nav + KPI strip + mobile nav
- `server/public/app.js`: shared bootstrapping + report loader + charts/tables + Settings hydration
- `server/public/custom.css`: KEXO UI styling + header/nav theme vars + layout + KEXO 5-color logic
- `server/public/tabler-theme.css`: Tabler overrides
- `server/public/settings-page.js`: Settings tab logic + saving to `/api/settings`
- `server/public/theme-settings.js`: Theme UI
- `server/public/variants-page.js`: Insights → Variants rendering/paging/sorting (driven by `/api/insights-variants`)
- `server/public/sentry-helpers.js`: Sentry browser helpers (breadcrumbs, capture, fetch wrapper); loaded in head-theme.html
- `server/public/ads.js`: Google Ads page logic
- `server/public/tools.js`: Conversion Rate Compare tool logic

---

## Backend architecture highlights

- `server/index.js`: Express app, canonical page routes, auth middleware, static assets, startup migrations
- `server/middleware/dashboardAuth.js`: Shopify embed + direct OAuth cookie protection
- `server/store.js`: DB access + reporting queries + dedupe guardrails
- `server/variantInsightsConfig.js`: canonical Variants table/rule defaults + matching/validation helpers
- `server/variantInsightsService.js`: Variants data aggregation (truth orders + variant sessions) and validation sampling
- `server/migrations/*.js`: schema/index migrations run on startup
- Ingest: `POST /api/ingest` (strict JSON limit), writes events/sessions/purchases (append-only; no deletes)

Ops/reliability:
- Static assets are versioned into HTML (query param `?v=`) to avoid Shopify embed caching mismatches.
- `GET /api/version` returns `assetVersion` so clients can detect deploy drift after long-idle tabs (UI prompts user to click Refresh; no forced reload).
- `.md`/`/docs` paths are blocked in production (see `server/index.js`).

---

## Deployment notes

- GitHub Actions are manual (`workflow_dispatch`).
- Railway hosts production; deploys may auto-run from GitHub depending on Railway config.
- `npm start` runs `scripts/prune-runtime-files.js` (removes non-runtime files from the runtime image).
- SQLite is ephemeral on Railway; production should use Postgres via `DB_URL`.

---

## Guardrails

- Never delete/truncate core data tables (`purchases`, `purchase_events`, `orders_shopify`, `sessions`) to “fix numbers”.
- Handle over-reporting via dedupe in stats queries (see `server/store.js` helpers).
- When changing dashboard sections/definitions, update `server/trackerDefinitions.js`.

---

## Changelog (high-signal)

2026-02-13 (latest)
- Tables:
  - Sticky first-column cells now use border-aware CSS ellipsis that expands/contracts during resize.
  - Table headers no longer switch to icon-only labels on mobile (headers stay text + ellipsis).
  - Rows-per-page control (`kexo-table-rows-control`) is hidden on mobile.
- Footer redesign:
  - Layout: far left = eye + last sale; center = refresh | logo (40px) | sound; far right = back to top.
  - Logo: new `/assets/logos/kexo_footer.webp` (40px width), centered in footer.
  - Removed settings and theme icons from footer.
  - All footer icons use fa-jelly-filled; no hover effects on footer icons.
  - New icon keys: footer-back-to-top, footer-sound-muted (mapped in Settings → Theme → Icons).
  - Back-to-top scrolls to top smoothly (with document fallback); sound mute syncs with header state.

2026-02-13 (latest)
- Header + snapshot/profit:
  - Added a new configurable top-strip money button (`data-icon-key="header-business-snapshot"`) next to the Settings button.
  - Added `GET /api/business-snapshot?mode=yearly&year=YYYY` for Business Snapshot cards (Financial / Performance / Customers) with previous-period deltas where available.
  - Added Profit Rules persistence key `profit_rules_v1` and dedicated endpoints:
    - `GET /api/settings/profit-rules`
    - `PUT /api/settings/profit-rules`
  - Business Snapshot now includes an in-modal Profit Rules editor (enable toggle, rule list, add/edit/delete, priority up/down, per-rule enabled toggle, ISO country targeting).
  - Estimated profit formulas are now centralized server-side using paid Shopify truth orders and country-aware rule applicability.
  - Snapshot UX polish: modal is now XL, year selector sits in the modal header, deltas show trend icons, and the header has subtle low-opacity background art (no Summary panel).
  - Profit setup callout has been removed; use the Snapshot footer Settings link to open Profit Rules.
  - Snapshot loading is now last-request-wins (avoids stale year data) and shows an in-modal Retry button on failures.
  - Snapshot metrics audit fixes:
    - Conversion Rate % + Sessions are now sourced from **ShopifyQL sessions** over a **SINCE/UNTIL** range (uses `TIMESERIES day` + quoted `WITH TIMEZONE`) (not KEXO sessions), so year views don’t show `Sessions=0` when KEXO tracking is newer.
    - Revenue/Orders/AOV in Snapshot now use **checkout_token** truth orders (online-store aligned) so you don’t get impossible cases like `Orders > Sessions`.
    - All Time customers treat “Returning Customers” as **Repeat Customers** (>=2 paid orders in the all-time range), so Repeat Purchase Rate is meaningful.
    - Guardrails: if ShopifyQL sessions are unavailable, Snapshot shows **Unavailable** (never `Sessions=0` with nonzero Orders). If ShopifyQL conversion_rate is missing/0 but sessions exist, Snapshot derives a best-effort conversion from checkout orders/sessions.
  - Snapshot report-mode upgrade:
    - Snapshot selector is now **Year-only** in the UI (monthly mode remains supported by the API, but the UI no longer shows mode switch links/labels).
    - Default open state is now **Yearly / current year** (e.g. 2026), not All Time.
    - Yearly comparisons are now **same elapsed window** vs previous year (Jan 1 -> same month/day in prior year), and monthly comparisons are the same month vs prior year (partial when current month).
    - API now accepts `GET /api/business-snapshot?mode=yearly&year=YYYY` or `?mode=monthly&month=YYYY-MM`.
    - Financial now renders a full-width **Revenue & Cost** area chart (Revenue + Cost line) with a hover tooltip breakdown; Cost = **COGS** + enabled Profit Rule deductions + optional **Google Ads spend** (when enabled).
    - Remaining cards keep visible KPI sparklines (area for Conversion/AOV/Repeat/LTV; bars for Sessions/Orders).
    - Customers: “Returning Customers” is now customers who have **>=2 paid orders by the end of the selected window** (so early years like 2025 don’t incorrectly show 0 when repeats exist).
    - Fixed a Postgres reliability bug: returning customer query no longer uses a grouped outer reference (prevents `/api/business-snapshot` 500s).
  - Settings performance:
    - `/api/theme-defaults` and `/api/settings` now batch-read settings keys to avoid N+1 query warnings.
  - Sentry noise reduction:
    - Frontend ignores generic transient network errors (Load failed / Failed to fetch / aborted) and `sentry-helpers.js` skips capturing those for same-origin `GET /api/*` calls.
    - UI polish: deltas now render as a compact **icon + %** in the card top-right (no “vs previous period:” prefix) and the Snapshot header has subtle low-opacity bar-chart background art.
    - Profit Rules modal overlay is now extra-dark (~80%) when open so it visually separates from the Snapshot behind it.
  - Snapshot UI follow-up:
    - Removed the inline Profit Rules callout card; Snapshot settings moved to a **footer Settings link** (header gear removed).
    - Profit Rules modal now includes an **Integrations** tab with a toggle to include Google Ads spend in the Cost chart (`profit_rules_v1.integrations.includeGoogleAdsSpend`).
    - Snapshot modal title now uses the Shopify store’s display name (Shopify Admin API).
    - Added a real dark backdrop and removed “—” delta badges when comparisons aren’t available.
- Settings icon cleanup + style tweaks:
  - Disabled auto-injected inner card title icons on Settings page (`fontawesome-icons.js` skips `data-page="settings"`), so inner Settings cards/tables no longer get extra gear icons.
  - Added Theme Icons support for `header-business-snapshot` (including persistence via `theme_icon_glyph_header_business_snapshot`).
  - Updated Settings tab/diagnostics icon defaults from `fa-solid` to `fa-thin`.
  - Updated strip dropdown menu styling to include `padding: 0` and `font-size: 13px` on `.kexo-top-strip-settings-menu, .kexo-top-strip-online-menu`.

2026-02-13 (latest)
- Dashboard overview:
  - Added **CR%** column to Top Products, Top Countries, Trending Up, Trending Down.
  - Trending Up/Down rows are now single-line deltas (removed the “now vs prev” sub-lines).
- Live View:
  - Added desktop-only **Latest sales** table beside the map (last 5 sales).
  - New API: `GET /api/latest-sales?limit=5` (protected).
- Settings:
  - Diagnostics redesigned to a **Tabler accordion** (no tabs / no `dm-*` diagnostics markup).
  - Settings left-nav icons now match the corresponding panel card header icons (new locked icon key `settings-tab-layout`).
- Misc UX/stability:
  - Closing the sale toast no longer re-triggers the global page loader.
  - Source icon 404 fix: `google_ads` now uses the Google icon (no `/assets/adwords.png`).
  - `hotImg()` no longer appends duplicate `width=` params; `arrivedAgo()` now outputs compact strings (e.g. `9secs`, `1min`, `1hr`).

2026-02-13 (latest)
- KPI/header micro-alignment:
  - Dashboard KPI card sparkline wrapper is nudged down (`bottom: -5px`) with a small radius to better align the chart baseline with the card bottom.
  - Page header title now renders as block-level (`.page-header .page-title { display: block; }`) to avoid inline-flex centering quirks.

2026-02-13 (latest)
- KPI visibility flicker fix:
  - Disabled KPI items now hide at first paint (localStorage hydrate + server-injected CSS in `/theme-vars.css`), so hidden KPIs no longer flash briefly on refresh.

2026-02-13 (latest)
- Header/KPI visual polish:
  - Page header triple layout now uses segmented horizontal connector lines (`left/meta — title — date`) with 10px outer margins.
  - Triple-layout stability improved by checking only direct `.col-auto` children before disabling the layout (prevents unintended left-jump).
  - KPI strip bottom gap removed (no extra white band under the sticky KPI row).
  - Dashboard KPI sparkline profile tuned to read as stronger “peaks/mountains” (less y-padding, taller sparkline area, stronger fill/stroke).

2026-02-13 (latest)
- Settings UX + header KPI control:
  - Charts and KPIs settings moved into Settings → Layout as top tabs (Tables / Charts / KPIs); legacy `?tab=charts` and `?tab=kpis` URLs route into Layout.
  - KPI settings now include a per-page allowlist for the header KPI strip (so you can disable it on Settings/Dashboard without code changes).

2026-02-13 (latest)
- Page header layout + KPI sparklines:
  - Simple page headers now lay out as: **icon+subtitle left**, **page title centered**, **date control right**, with **2px dividers** between sections.
  - The header category icon is injected inside `.page-pretitle` (better vertical alignment).
  - Dashboard overview KPI sparklines now render as a single **filled area** line (no dashed compare series; solid fill).

2026-02-13 (latest)
- Sticky header + page title:
  - `assetVersion` now includes header/footer partial mtimes so deploy drift detection updates when shared chrome changes.

2026-02-13 (latest)
- Sticky header follow-up:
  - KPI strip is now inside `.kexo-header-stack` so the full header (strip + nav + KPIs) stays sticky while scrolling (prevents the header “stopping” at the start of `.page-body`).

2026-02-13 (latest)
- Tools page header alignment:
  - `/tools/shipping-cr` and `/tools/compare-conversion-rate` now center the page icon + pretitle + title + date control as one middle-aligned header group.
  - Page header category icon now uses inline-flex alignment (no float), improving subtitle baseline alignment.
  - Date control button now uses 40px height and larger left padding to match the requested layout.
  - Tools page title size is now `1rem`.
  - Follow-up: the divider is now a full-height straight line (stretch layout; zero gutters) so it visually reads as one centered unit.

2026-02-13 (latest)
- Theme default custom CSS:
  - Updated default `.kexo-product-link` style (blue, 13px, underlined, tighter underline offset).

2026-02-13 (latest)
- Header/table UX polish:
  - Avatar no longer moves on hover (removed margin-right).
  - Strip dropdowns (Online, Settings, Avatar): border-radius 4px, opacity 0.9.
  - Header KPI strip: swipeable overflow without scrollbar (overflow-x: auto, scrollbar hidden).
  - Sessions tables (live/sales/table): min-width 640px to prevent squashing; overflow-x swipeable with hidden scrollbar.
  - Page header category icon: padding 0, margin 2px 4px 0 0, font-size 12px.

2026-02-13 (latest)
- Tools + Sentry stability:
  - Added server shim route `GET /assets/cash-register.mp3` that redirects to Shopify CDN to eliminate residual audio 404s.
  - Shipping CR Sessions denominator now counts human sessions in the selected range where **checkout started OR purchase occurred**, with country match using `country_code` fallback to `cf_country`.
  - Fixed `dashCache is not defined` by sharing dashboard cache state across rows-per-page handlers.
  - Fixed `ensureApexCharts is not defined` in dashboard chart rendering by waiting on existing Apex loader helper.
  - Reduced Sentry frontend noise: fetch wrapper now skips capturing expected `AbortError` (and offline `Failed to fetch`) cases.
- Tools UI polish:
  - Shipping CR + Compare Conversion Rate buttons now use normal Tabler button size + `btn-list` grouping (removed tiny `btn-sm` usage).
  - Removed forced tools card radius override so tool containers follow default Tabler corner radius.

2026-02-13 (latest)
- Strip dropdowns (Online, Settings, Avatar): align left with main nav, white bg + black text/icons; removed Theme dropdown link/icon color settings; main-menu dropdown icons use lighter shade of accent (color-mix) instead of opacity.

2026-02-13 (latest)
- Header + theme UX:
  - Top strip: Online badge dropdown now links to **Live View** (same icon as main menu). Avatar dropdown removed; **Sign out** moved into the Settings dropdown.
  - Theme: added Custom CSS (saved in theme defaults, injected inline in head after stylesheets).
  - Main nav: dropdown item icons now inherit the parent accent color at 0.7 opacity.
  - Date picker: now relocates into the page header on mobile too (inline with the page title row).
  - Google Ads: sticky first-column width now syncs with the footer totals row.
- Chart + map observability hardening:
  - Added `kexoCaptureMessage()` in `server/public/sentry-helpers.js` and a chart-aware `console.error` Sentry bridge (with short dedupe) so frontend chart/map console failures are captured automatically.
  - Added explicit chart/map error/message capture hooks across `server/public/app.js`, `server/public/ads.js`, and `server/public/tools.js` for render failures and library-load failures.
- jsVectorMap stability follow-up:
  - Updated map region series values to numeric weights with explicit `scale` + `normalizeFunction: 'linear'` to prevent `setValues/getValue` runtime crashes on `/dashboard/live` and `/insights/countries`.

2026-02-13 (latest)
- Countries + Live jsVectorMap fixes:
  - Fixed map hover crash (`tooltip.html is not a function`) by adding a safe tooltip writer that supports jsVectorMap tooltip API variants (`html`, `text`, element fallback).
  - Replaced map numeric `scale/normalizeFunction` fill logic with deterministic ISO->color mapping to prevent `fill="undefined"` (which showed key regions as black).
  - Hardened `.jvm-tooltip` CSS (`display:none`, fixed positioning, non-interactive) so empty tooltip nodes do not appear in page flow/footer when inactive.
- Live chart mode behavior:
  - `live-online-chart` is now map-only (`map-animated` / `map-flat`) in Settings schema and Settings UI metadata.
  - Runtime mode sanitization in `app.js` now forces `/dashboard/live` to map mode when stale non-map config is cached.

2026-02-13 (latest)
- Traffic + Insights UX:
  - Traffic Channels/Device charts now default to a multi-line sessions trend over time (top 5 series) with a right-side label/value list.
  - Products page hides tables with 0 sessions and shows a footer note ("Tables without sessions are hidden").
  - Live View online chart now defaults to an animated world map of sessions seen in the last 5 minutes (can be switched back to bar/line/area in Settings → Charts).
  - Countries map default mode is now `map-flat` (Settings → Charts).
  - Countries map rendering now waits for the report loader to finish so the map doesn't initialize at 0x0 size (invisible/scale(0)).
  - Page headers now show the active top-menu category icon (Dashboard/Insights/Traffic/etc) next to the pretitle/title, using the same accent color as the active nav item.
  - Sessions tables (Live/Table/Sales): clicking a product link opens the Product Insights modal only; clicking the row opens the side panel.
  - Page layout: restored `page-body` flex growth so content always starts at the top (no vertical centering on short pages).

2026-02-13 (latest)
- Header/nav mobile follow-up:
  - Fixed inline nav left-edge clipping by zeroing nav row gutters/paddings and resetting mobile nav horizontal start position on page show.
  - Restored inline mobile dropdown usability by toggling nav-left overflow state while dropdowns are open (`.kexo-desktop-nav-left.is-dropdown-open`), preventing clipped menus.
- Date picker visibility:
  - `mountDesktopDatePickerIntoPageHeader()` now relocates the date picker into the page header on all viewports when a `.page-header` exists; otherwise it falls back to the nav slot.
  - Resize/orientation/pageshow listeners keep placement correct when viewport changes.
- KPI visibility:
  - Re-enabled Settings-driven dashboard KPI card hiding (`item.enabled === false`) in `applyDashboardKpiUiConfig`.
- Sticky header follow-up:
  - Updated `.page > .page-wrapper` flex sizing (`flex: 1 0 auto`) and kept `.page-body` overflow visible to avoid sticky header constraints ending near page-body start.

2026-02-13 (latest)
- Header/nav + mobile parity:
  - Stripped remaining Tabler mobile-menu JS branches from `server/public/app.js` (legacy `mobile-date-*` / `mobile-tabs-*` paths) so desktop and mobile use the same shared nav/date behavior.
  - Added hard overrides in `server/public/custom.css` to keep top nav inline/horizontal on mobile (no Tabler stacked navbar fallback).
- Sessions/sticky table UX:
  - Added a shared sticky-wrap marker class (`kexo-sticky-wrap`) during sticky initialization on all devices.
  - Sticky first-column width persistence is now split by viewport bucket (mobile/desktop) and constrained by remaining column count, preventing oversized first columns that caused very tall session rows ("10 secs ago" wrapping vertically).
  - Session age/history cells on Live/Sales/Table are now forced single-line in `custom.css`.
- `/dashboard/live` cleanup:
  - Removed the "Next update" markup from `server/public/dashboard/live.html` and limited next-update timer styling to Sales only.
- Sticky header behavior:
  - Explicitly set `.page` / `.page-wrapper` overflow to visible in `custom.css` to keep the sticky header stack tracking consistently while scrolling through page body content.

2026-02-13 (latest)
- Dashboard/header regressions fixed:
  - Disabled condensed KPI chips are now hidden pre-paint via `/theme-vars.css` (no refresh flash), while dashboard KPI cards no longer hide when KPI visibility toggles are off (order/labels still apply).
  - Dashboard now shows the condensed KPI strip again (settings page remains hidden).
  - Desktop nav date slot is hidden before relocation into page header (removes transient duplicate date box on refresh).
- Tools + tables:
  - `/tools/shipping-cr` now loads ApexCharts so condensed KPI sparklines render consistently on that page.
  - Dashboard overview API now returns up to 10 rows for Top Products, Top Countries, and Trending tables so 5/10 row selectors materially change visible rows.
- Countries map + sale sound reliability:
  - Countries map now shows explicit loading/disabled/no-data/error states; server-side chart-hide CSS no longer fully hides the countries map card when disabled.
  - Sale sound now prefers the Shopify CDN MP3 unless a custom assets base URL is configured, avoiding default `/assets/cash-register.mp3` 404s.

2026-02-13 (latest)
- Settings → Insights → Variants:
  - Table aliases are now a chip/tag input (Enter/comma/paste to add; click × to remove) to make merging Shopify option-name synonyms much easier.
  - Added per-table icon class (FontAwesome) editable next to “Add row mapping”; used on Insights → Variants table cards (default `fa-solid fa-grid-round`).
  - Footer layout: **Save** is now the only right-side button and is green; other actions (Suggest/Warn/Ignored/Reset) live on the left.

2026-02-12 (latest)
- Settings → Layout accordion: chevron moved to left, single chevron (rotates 180° when expanded), accordion-button font-size 16px, chevron fa-regular 14px #444.

2026-02-12 (latest)
- Refresh behavior:
  - Removed background polling/auto-refresh across the site (manual refresh only via browser reload or the in-theme Refresh buttons).
  - `/dashboard/live` + `/dashboard/sales` now poll for updates every 10s with smooth, non-janky row insertion/updates.
  - While paging/sorting, updates are queued and an **Updates available** button appears in the header actions.
  - Sale banner + footer “Last sale” continue updating globally via SSE (`/api/stream`).
- Settings -> Layout -> Tables UX refactor:
  - Replaced table-crammed layout editor with Tabler accordion sections (one accordion item per page, one control row per setting group).
  - Added per-table card controls with clearer fields for name, rows options/default, sticky bounds, grid toggle, and reorder actions.
- Added shared **Colors** controls in Settings -> Layout -> Tables for:
  - Dashboard · Live View
  - Dashboard · Table View
  - Dashboard · Recent Sales
  - Each row now has a far-right Colors button opening one shared modal that edits/saves the same values.
- Extended `tables_ui_config_v1` with shared converted-row color fields:
  - `iconColor`, `iconBackground`, `stickyBackground`, `convertedBackground`
  - Normalized in `server/routes/settings.js` and persisted via existing `/api/settings` tables config path.
- Runtime application + CSS updates:
  - `server/public/app.js` now applies the shared colors to CSS vars (`--kexo-converted-icon-color`, `--kexo-converted-icon-bg`, `--kexo-sticky-cell-bg`, `--kexo-converted-cell-bg`) from `tablesUiConfig`.
  - Updated converted-row styling in `server/public/custom.css` (+ parity updates in `server/public/app.css`) for icon block positioning, converted backgrounds, sticky background variable support, and converted-row hover consistency.
  - Fixed darker adjacent hover tint on converted rows by overriding second-cell hover styling for converted rows.

2026-02-12 (latest)
- Tools: added `/tools/shipping-cr` (Shipping CR) to report shipping option share-of-orders by country + date range.
  - Groups by Shopify `shipping_lines[].title` and charged shipping price (so “Standard Tracked Delivery” can appear as both Free and Paid).
  - Uses a dedicated fact table `orders_shopify_shipping_options` populated during Shopify truth reconcile (fast queries; avoids parsing orders JSON at request-time).
  - Date filter uses `orders_shopify.processed_at` when present (fallback to `created_at` when NULL). Added index on `(shop, processed_at)` for paid orders.
  - UI polish: country input shows an inline flag after ISO2 is recognized; results include a Sessions column (checkout-started sessions for that country+range; constant per row).
  - Flatpickr: tool date pickers are styled to match Tabler and hide adjacent-month days to avoid confusing month grids.
  - Shipping price detail: table stores and displays both **Paid shipping** and **Set shipping** (presentment currency) via extra columns on `orders_shopify_shipping_options` (migration 042).
- Migrations: startup/manual migration runners now include migration 039 (sessions index) and 040 (orders processed_at index).
- Restored session details drawer behavior on `/dashboard/live`, `/dashboard/sales`, and `/dashboard/table` by adding active `.side-panel` styling in `server/public/custom.css` (these pages do not load `app.css`).
- Refined the drawer with Tabler-aligned spacing, borders, section cards, and improved long URL wrapping so activity/source/network details remain readable.
- Added drawer backdrop + ESC close behavior in `server/public/app.js`, and stronger clickable-row hover affordance for session tables.

2026-02-12 (latest)
- Converted sale row styling/icons:
  - Live/session converted rows now prepend a configurable sale icon in the first converted cell (`data-icon-key="table-icon-converted-sale"`) via `server/public/app.js`.
  - Added new icon key default to both icon registries (`server/public/fontawesome-icons.js`, `server/public/theme-settings.js`) so it is editable in Settings → Theme → Icons.
  - Updated converted-row cell styling to a gradient background `#d8ecdb` (left) → `#f3f9f4` (right) in `server/public/custom.css` (and mirrored in `server/public/app.css` for legacy parity).

2026-02-12 (latest)
- Header/footer polish:
  - Added shared sticky wrapper in `server/public/partials/header.html` (`.kexo-header-stack`) around strip + nav; sticky behavior is applied to wrapper in `server/public/custom.css` to avoid split/staggered sticky glitches.
  - Removed desktop-only footer hiding rules in `server/public/custom.css`; desktop now shows the same footer structure as mobile.

2026-02-12 (latest)
- Mobile UX overhaul:
  - Removed UA-based mobile redirect gate in `server/index.js`; `/mobile-unsupported` now redirects to `/dashboard/overview`.
  - Removed mobile-only hamburger/overlay header markup from `server/public/partials/header.html`; shared desktop strip/nav now render on mobile.
  - Added touch horizontal scrolling behavior for top nav and condensed KPI strip in `server/public/custom.css` + `server/public/app.js`.
  - Tightened mobile table responsiveness across shared/page-specific styles (`custom.css`, `app.css`, `settings.html`, `settings-page.js`, `ads.js`, products/variants inline styles) to prevent viewport overflow and keep scroll within table wrappers.

2026-02-12 (latest)
- Sentry debugging: added browser SDK (CDN) + `sentry-helpers.js` (breadcrumbs, kexoCaptureError, fetch wrapper). All pages set `kexoSetContext(page)`; app.js, ads.js, settings-page.js, theme-settings.js, tools.js, variants-page.js instrumented. Backend routes: stats, kpis, sessions, insightsVariants, ads, dashboardSeries, tools get Sentry breadcrumbs + captureException in catch blocks. `GET /api/version` returns `sentryDsn` when SENTRY_DSN is set. `sendPage()` supports `{{SENTRY_DSN}}` template for sentry-init partial.

2026-02-12 (latest)
- Sale notification rework: replaced top-right toast modal with **tblr-banner** overlay on the desktop top strip. Banner shows flag – product – sale value, center-aligned, with close button far right; auto-closes after 10s; MP3 cha-ching preserved. Markup moved to `header.html` so it appears on all pages (fixes no-show on settings/variants/compare-conversion-rate). Removed old toast from 10 page templates; removed `sale-toast-time` icon key.

2026-02-12 (latest)
- Tools → Compare Conversion Rate: integrated with Settings → Insights → Variants mappings via a **Drill into variant labels** mode.
  - Loads available mapping tables and per-product label groups (Output labels) from the Variants config.
  - Compare requests can now return before/after CR breakdown by **label group** (not just raw Shopify variants), using the same title-matching logic as Insights → Variants.
  - If no mappings exist, the tool prompts the user to configure/suggest mappings first.

2026-02-12 (latest)
- Variants mappings now start **blank/custom-first** (no shipped default mapping tables/rules). Seed tables using Suggestions or build manually.
- Settings → Insights → Variants: added **Suggest mappings** (Shopify selectedOptions + recent observed activity) with one-click seed into editable custom tables.
- Applying suggestions now **merges by Output label** when possible (prevents duplicates like Gold/Vermeil being added twice; new aliases are folded into the existing row).
- Variants mapping tables now support **table aliases** (e.g. “Size, Chain Length, Bracelet Length”) used for scope inference and for suggestion seeding to merge multiple Shopify option labels into one table.
- New API endpoints:
  - `GET /api/insights-variants-suggestions` (build suggestions)
  - `POST /api/insights-variants-suggestions/apply` (apply selected seed tables into config)
- Suggest mappings now defaults to a **fast** build (skips truth reconcile); the modal includes a loader with elapsed time plus a **Refresh from Shopify** button for the slower/accurate refresh.
- Variants settings save is no longer blocked by unmapped coverage; it saves and returns **coverage warnings** to guide mapping/ignore.
- Coverage warnings no longer spam inline at the top of Settings → Variants; they are accessible via a **Warnings** button + modal.
- Settings → Variants: **Reset Variants** button (only shows when tables exist) wipes all mapping tables/rules/ignores (config only; no DB changes).
- Settings → Variants: added per-row **Merge** action to merge include aliases into another label and remove the source row (helps clean up seeded duplicates).
- Fixed settings editor escaping so Output labels can safely include quotes/ranges (e.g. `7.5" - 9" inches`).
- Insights → Variants: All Variant Stats now shows **Mapped+Ignored %** and a per-table **Top Unmapped (by sessions)** section.

2026-02-12 (latest)
- Added Settings → Layout → Tables: editable per-page table name/order/grid + rows-per-page options/default + optional sticky column min/max.
- New settings key: `tables_ui_config_v1` (cached client-side in localStorage as `kexo:tables-ui-config:v1`).
- Runtime apply in `server/public/app.js`:
  - table row selectors use config overrides for options/defaults
  - sticky column resize bounds can be overridden per table
  - table order/grid/title are applied via DOM transforms (titles are opt-in via `data-kexo-table-title="1"`)
- Variants validation/mapping is now scope-aware by table intent: length/style/finish tables skip out-of-scope titles before unmapped checks, reducing false save blockers on mixed catalogs.
- Variants diagnostics now include `outOfScope` totals/examples; All Variant Stats modal shows Total vs In Scope sessions, Out Of Scope sessions, and computes Mapped % from in-scope sessions.
- Settings -> Insights -> Variants messaging now clarifies that save blocking applies to unmapped in-scope titles and that out-of-scope titles are skipped.

2026-02-12 (latest)
- Variants mapping now auto-resolves overlap by specificity/order (most specific include wins; ties use rule order), reducing reliance on manual exclude maintenance.
- Variants settings save-blocking now targets unmapped titles; overlap-resolved cases are reported as diagnostics context rather than a hard-block category.
- Settings -> Insights -> Variants editor copy now explains auto-managed overlap and no longer presents `Exclude aliases` as required manual mapping input.
- Insights -> Variants now has header actions for **Variant Settings** and **All Variant Stats**, plus a new All Variant Stats modal with table-level totals and mapped-coverage-by-sessions diagnostics.
- Variants diagnostics payload now includes overlap-resolved totals/examples and session-attribution coverage (`?variant=` coverage against product-entry sessions) to highlight default-option attribution gaps.

2026-02-12 (latest)
- Footer eye (last-sale toggle): banner now shows immediately with cached/placeholder content, then refreshes when fetch completes; manual trigger now plays sale sound; MP3 loads from /assets/cash-register.mp3 with CDN fallback.
- Countries -> Country + Product no longer hard-caps to top 3 products per country in backend output; table row selector can now surface larger datasets (bounded by a global safety cap).
- Google Ads page refresh path now runs backend sync (`POST /api/ads/refresh`) on force refresh, with a guarded yesterday auto-sync when summary first returns empty.
- Google Ads GCLID backfill now queries ClickView **per-day** (required by the Google Ads API) to avoid refresh failures/misleading “endpoint not found” errors; Ads error modal diagnostics JSON is readable even in dark theme.
- Charts UI config apply now triggers active-view re-render in `app.js`, fixing stale chart mode/color/enable states (including Countries map) after settings changes.
- Row-per-page controls now rebind after icon/theme refresh events (`kexo:icon-theme-changed`) to prevent disappearing selectors.
- Settings -> Diagnostics now includes clearer Refresh vs Reconcile semantics, reconcile action feedback, enriched diagnostics payload metadata, and a Download JSON handoff action for AI/agent workflows.
- Tracker Definitions updated (v16) with explicit Settings -> Charts and Settings -> Diagnostics coverage; `/api/config-status` now returns diagnostics schema + chart/date-range settings summaries.

2026-02-12 (earlier)
- Product names across dashboard + insights tables are now clickable links that open the large Product Insights modal; removed product image thumbnails from those tables (modal is now the primary way to view product imagery).
- Product Insights modal now defaults to the **global** date range, shows KPI-style Clicks / Conversions / Conversion Rate, and includes a Top Countries section (when available) plus footer buttons for the storefront page + Shopify admin product page.
- Sessions tables (`/dashboard/live`, `/dashboard/sales`, `/dashboard/table`) now show a single product link in the Landing column that opens Product Insights (no entry/exit dual view, and no landing/product thumbnails in the table).
- Product Insights UI polish: full-width main image + horizontal thumbnail strip with arrows; main image auto-balances height vs right-side content; Revenue + Demand charts moved to the left and collapsed by default (expand via standard card chevron).
- Product Insights modal now follows Settings -> Insights Suggest Mapping modal behavior/styles more closely (Tabler modal/backdrop flow, padded header, grey footer, standard secondary/primary footer buttons), removes duplicate title/type text under the image, and removes the subtitle under the modal title.
- Product Insights right panel renamed to **Product details** and now renders as a proper Tabler-style table with metric/value headers and progress-style rows.
- `/api/product-insights` now returns `details` with cached lifetime product fields: `totalSalesLifetime`, `totalRevenueLifetimeGbp`, `costOfGoodsLifetimeGbp`, plus stock details (`inventoryUnits`, `inStockVariants`) from Shopify product metadata.
- API updates:
  - `/api/product-insights`: supports `14d` + `30d`, returns `topCountries` and `links.adminProductUrl`.
  - `/api/dashboard-series`: includes `handle` in `topProducts` and trending items so the frontend can open Product Insights from Dashboard tables.
- Insights -> Variants mapping-issues badge now uses dark style, cleaner header spacing, and per-item **Ignore** actions in the modal.
- Added persistent table-scoped ignored variant titles in `insights_variants_config_v1` (`table.ignored`), with save-time validation and runtime diagnostics excluding ignored titles from unmapped/ambiguous counts.
- Settings -> Insights -> Variants now includes an **Ignore List** button + modal to review/remove ignored titles and save.
- Row-per-page selector rebind now runs after report-build finish (`kexo:table-rows-changed`) and after Variants rerenders; Variants "Configure variants" buttons enforce white text.

2026-02-12
- Dropdown border removed; Settings moved from strip to nav; Settings dropdown aligns left with menu, opens below nav (not strip).
- Settings dropdown inherits menu: same background, opacity filter, border, link/icon colors. Removed theme_header_settings_menu_* keys.
- Menu hover tint: theme_menu_hover_opacity (0–100%) + theme_menu_hover_color (black/white) control hover overlay on nav links and dropdown items.

2026-02-12 (earlier)
- Theme refactor: 3 accents → 5 editable hex inputs (accent 1–5); 8 former settings (strip/settings/menu/dropdown colors) derived from accent 1; added Strip/Menu opacity filters, strip padding, strip border-bottom toggle; removed icons from Header & Color section.
- Charts tab: fixed layout, map type input width, color swatches, pie metric dropdown (mobile-friendly).
- Sources tab: Tabler-style restyle with tiny images in grid.
- Fixed underline on hover for active settings menu items.

2026-02-12 (earlier)
- Handover audit pass: updated to current UI + routes + Settings capabilities.
- Icons are customizable via `data-icon-key` + Font Awesome runtime adapter (`server/public/fontawesome-icons.js`).
- Added global Charts settings (`charts_ui_config_v1`) + server-injected hide CSS via `/theme-vars.css`.
- Refactored Theme settings: moved all desktop header/nav/dropdown/settings/online color controls from Header tab into Color tab; Header tab now keeps non-color controls.
- Locked Theme primary palette to KEXO brand 5-color accents in both settings UI and `head-theme` early hydration.
- Fixed Settings → Charts initial render timing so chart mode/pie selectors render with correct defaults/selections when tab is opened.
- Added Insights → Variants page (`/insights/variants`) and API (`/api/insights-variants`) with configurable mapping tables, variant-specific sessions denominator (`?variant=<id>`), sortable/paginated tables (default 5 rows, options 5/10), and strict save validation in Settings → Insights → Variants that blocks unmapped/ambiguous configs with detailed diagnostics.
- Fixed Countries → Country + Product denominator in `getBestGeoProducts()` so Sessions/CR% use country+product-handle sessions (product landing sessions in that country), not all sessions for the country.
- Fixed Variants page first-load UX: disabled generic app loader path for `data-page="variants"` and added a script-level fail-safe that hides stale loader overlays; empty state now includes a **Configure variants** button linking to `Settings → Insights`.
- Updated default Styles mappings to: Style 1, Style 2, Style 3, Satellite, Belcher, Anchor (removed prior chain defaults like cable/curb/figaro/rope/etc).
- Fixed Settings → Insights → Variants save reliability by syncing all editor field values from DOM at save time (prevents stale draft data from being re-saved when users edit and immediately click Save).
- Variants mapping-issue badge is now clickable and opens a modal with unmapped/ambiguous variant examples plus mapped coverage summary (sessions/orders/revenue) to help diagnose unusually high CR%.
- Added dedicated icon keys for Insights → Variants table headers (`table-icon-variants-*`) so each column icon is individually configurable in Settings → Theme → Icons.
