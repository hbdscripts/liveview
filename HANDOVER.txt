KEXO Liveview — HANDOVER (keep current)
Last updated: 2026-02-16 (Snapshot hides global header date picker)

This repo ships a private Shopify app with a near-real-time Live Visitors dashboard. The frontend is Tabler-based and split into multiple HTML pages (folder-style routes) with shared partials and a shared JS bundle.

IMPORTANT (for future agents)
- Read this file before making changes (Cursor rules enforce this).
- Keep this file accurate. If you change core paths (routes/auth/dashboard UX/deploy), update this file in the SAME commit.
- This repo avoids new markdown docs; this handover is intentionally `HANDOVER.txt`.
- UI convention: cap font-weight at 500 (avoid heavier weights) for new dashboard UI.
- Modal convention: use dark overlays by default (`.modal-backdrop` black with strong opacity); custom/fallback modals must include equivalent dark backdrop behavior.
- Diagnostics guardrail: when adding/moving/removing dashboard sections, update `server/trackerDefinitions.js` so Diagnostics → Definitions stays accurate.
- Live-status quick check (before saying "it's live"): run `git status -sb` and `git log --oneline --decorate -n 1`.

---

## STICKY: Fraud + Compliance + Click & Order Lookup (affiliate abuse detection)

Goal: a generic, network-agnostic affiliate abuse/fraud detector that is safe to run in production:
- Additive-only (no deletes); never blocks dashboards/ingest (fail-open).
- Never stores raw IP; IP + UA are HMAC-hashed using `FRAUD_IP_SALT`.
- Produces a deterministic **Fraud Score (0–100)** + **flags** + **safe evidence snapshot**, with optional AI narrative (feature-flagged).

### Data capture (ingest → attribution session row)

- Ingest route: `POST /api/ingest` (`server/index.js` → `server/store.js`).
- Attribution capture table: `affiliate_attribution_sessions` (migration `047_affiliate_attribution_and_fraud`).
- What we store (high level):
  - UTMs (source/medium/campaign/content)
  - Paid click IDs (e.g. `gclid`, `msclkid`, etc.)
  - Affiliate click IDs (generic `clickid`, `aff_id`, etc.)
  - Referrer + entry URL (for suspicious referrer and late injection signals)
  - Cloudflare bot/geo headers (e.g. `cf_country`, `cf_asn`, known/verified bot markers)
  - IP + UA hashes (HMAC; never raw)
- First-touch fields are immutable; only `last_seen_json` is updated in a rate-limited manner.

### Scoring (checkout_completed → fraud evaluation rows)

- Trigger point: checkout completion evidence (`checkout_completed`) writes/updates evaluations.
- Storage table: `fraud_evaluations` (one row per `(entity_type, entity_id)`; update-in-place with preserved `created_at`).
- Key fields:
  - `score` (0–100) + `triggered` boolean (score >= threshold)
  - `flags_json` (deterministic signals: conflicts, late injection, low engagement, suspicious referrer, duplicate patterns, missing evidence, etc.)
  - `evidence_json` (safe snapshot: attribution + engagement + derived signals; no raw IP)
  - `resolved_status/resolved_by/resolved_note` (admin-only resolution metadata)
- Config: `fraud_config` stores weights/thresholds (read via `server/fraud/config.js`).

### APIs (fail-open)

- Markers (batch): `GET /api/fraud/markers?entityType=session&ids=<csv>` (`server/routes/fraud.js`)
  - Used to render warnings quickly in tables with minimal DB load (server-side TTL cache).
- Detail (single): `GET /api/fraud/detail?entityType=session|order&entityId=...`
  - Returns evaluation + deterministic/AI narrative + safe evidence snapshot.
- Admin:
  - `GET/PUT /api/admin/fraud-config` (weights/threshold)
  - `POST /api/admin/fraud-resolution` (resolve/ignore with note)
- Click & Order Lookup:
  - Page: `/tools/click-order-lookup` (`server/public/tools/click-order-lookup.html`)
  - API: `GET /api/tools/click-order-lookup?q=...&shop=...` (`server/routes/tools.js` → `server/tools/clickOrderLookup.js`)
  - Search accepts: Kexo Click ID (session_id), Shopify order ID, checkout token, or Kexo order key (`token:`/`order:`/`h:`).

### UI surfaces

- Sessions tables (`/dashboard/live`, `/dashboard/sales`, `/dashboard/table`):
  - Added a narrow **Compliance** column immediately after the sticky Landing column.
  - It always shows a check (passed) or warning (triggered) based on `/api/fraud/markers`.
  - If the row is a sale, it also shows the sale (£) icon alongside check/warn.
  - The icons are **non-links**; clicking anywhere on the row (including the Compliance icons) opens the right-hand drawer for deep inspection.
  - Icon keys: `table-icon-compliance-header`, `table-icon-compliance-check`, `table-icon-compliance-warning`, `table-icon-converted-sale`.
- Right-hand session side panel:
  - The drawer’s **Compliance** section embeds the Click & Order Lookup view (single renderer + single payload source).
  - Copy affordances are **links** and appear **only for IDs**: Click ID, Shopify order ID, checkout token, Kexo order key.
  - Displays **Kexo Click Fraud Score** as an **animated half-donut gauge** (0–100) colored green/blue/red by risk.
  - `/tools/click-order-lookup` also shows the same Activity feed (the lookup API returns recent session `events`).
  - Drawer header shows inline row icons (country + channel + device) with small labels; icons/images are normalized to 12px and the header is not sticky. Source section includes **Copy URL** (copies entry URL with UTMs merged in when available).

### Optional AI narrative (feature-flagged)

- Controlled by `FRAUD_AI_ENABLED` (and model settings).
- Runs asynchronously; never blocks ingest or UI.
- Prompt is PII-safe (no raw IP); output is cached back into `fraud_evaluations.ai_summary`.

## What KEXO looks like today (UX)

Desktop chrome (shared header across pages via `server/public/partials/header.html`):
- Top strip: live visitor count (left), centered logo, Settings dropdown (right). On new sale, a Tabler-style `tblr-banner` overlays the strip with gradient, "New Sale: Product Name" + price (10s auto-close; MP3 cha-ching).
- Main nav row below: grouped dropdown menus (Dashboard, Insights, Traffic, Integrations, Tools) + date range selector on the right.
- KPI strip: condensed KPI chips shown on most pages. Visibility is configurable per page via Settings → Layout → KPIs. It sits inside the sticky header wrapper so it stays pinned while scrolling.
- Page header: the per-page title row (category icon + pretitle + title + date control) stays inside the page body (not sticky). Layout is driven by `app.js` + `custom.css` (icon inside subtitle; title centered; date right) with segmented 2px connector lines around the title on simple pages.

Mobile:
- Uses the same shared top strip + main nav as desktop (no mobile-only hamburger header/overlay).
- Main nav is horizontally swipeable on touch screens; date-range control stays in the header row.
- Mobile UA requests are no longer redirected to `/mobile-unsupported`; dashboard/settings/tools routes render directly on mobile.
- Header stack is sticky via a shared wrapper (`.kexo-header-stack`) so strip + nav + KPI strip stay pinned together while scrolling.

KEXO “5-color” accents:
- The desktop nav uses a rotating 5-color accent for the active underline and related styling via `.kexo-5color`:
  - Accent 1: `#4b94e4` (blue)
  - Accent 2: `#3eb3ab` (teal)
  - Accent 3: `#f59e34` (orange)
  - Accent 4: `#8b5cf6` (purple)
  - Accent 5: `#ef4444` (red)
  - See: `server/public/custom.css` (`.kexo-5color`, `--kexo-accent-*`)

---

## Canonical pages + routes (folder URLs)

Rendered templates live under `server/public/**` and are served by `server/index.js` via `sendPage()` (includes + cache-control + asset versioning).

Dashboard:
- `/dashboard/overview` → `server/public/dashboard/overview.html` (`data-page="dashboard"`) — top tables now include CR%
- `/dashboard/live` → `server/public/dashboard/live.html` — desktop shows a Latest sales card beside the map (last 5 sales)
- `/dashboard/sales` → `server/public/dashboard/sales.html`
- `/dashboard/table` → `server/public/dashboard/table.html`

Insights:
- `/insights/snapshot` → `server/public/insights/snapshot.html` (admin-only analytics view; non-admins see explicit Not authorised state)
- `/insights/countries` → `server/public/insights/countries.html`
- `/insights/products` → `server/public/insights/products.html`
- `/insights/variants` → `server/public/insights/variants.html`
- `/insights/abandoned-carts` → `server/public/insights/abandoned-carts.html`

Traffic:
- `/traffic/channels` → `server/public/traffic/channels.html`
- `/traffic/device` → `server/public/traffic/device.html`

Integrations:
- `/integrations/google-ads` → `server/public/integrations/google-ads.html`

Tools:
- `/tools/compare-conversion-rate` → `server/public/tools/compare-conversion-rate.html`
- `/tools/shipping-cr` → `server/public/tools/shipping-cr.html`
- `/tools/click-order-lookup` → `server/public/tools/click-order-lookup.html`

Settings:
- `/settings` → `server/public/settings.html`

Upgrade:
- `/upgrade` → `server/public/upgrade.html` (`data-page="upgrade"`) — TODO pricing page used by plan-gated Settings controls

Admin (admin-only):
- `/admin` → `server/public/admin.html`
  - Left menu now includes: Controls, Diagnostics, Users

Legacy redirects (kept, query preserved):
- `/tools/ads` and `/ads` → `/integrations/google-ads`
- `/date` → `/dashboard/table`
- `/overview`, `/live`, `/sales`, `/countries`, `/products`, `/variants`, `/abandoned-carts`, `/channels`, `/type`, `/compare-conversion-rate`, `/shipping-cr`, `/click-order-lookup` → canonical folder routes

Root `/`:
- Shopify embedded app URL. `auth.handleAppUrl()` decides:
  - render embedded dashboard overview, or
  - redirect to `/dashboard/overview` when logged in, else `/app/login`

---

## Settings (GLOBAL) — what’s configurable today

Settings scope is intentionally GLOBAL/shared (user-specific settings are disabled for now).

Settings UI:
- `server/public/settings.html`: Settings page layout + tab shells
- `server/public/settings-page.js`: tab switching, saving, and Settings panel wiring

Settings tabs:
- General: current config display (read-only)
- Kexo UI: theme editor (colors/fonts/icons/header/sale notification) — formerly Theme. Subtab Sale Notification: choose sale sound (presets Kexo 1–4; or custom URL/upload). Stored in `asset_overrides.saleSound`.
- Assets: upload/override favicon + logos (R2-backed) — plan-gated for normal accounts (Upgrade required)
- Integrations: Pixel + Google Ads status/actions
- Sources: Sources v2 rule editor (UTMs + entry params + referrer + affiliate attribution) with FA/SVG/upload icons + legacy v1 mapping (collapsible)
- Insights: tab shell for Products/Countries plus active Variants mapping manager (custom table/rule editor)
- Layout:
- Tables: accordion-based per-page table config (name/order/grid, rows-per-page options/default, optional sticky column min/max). **Insights · Variants** is a single accordion that controls all user-defined variant tables on /insights/variants (rows 5/10, sticky min/max).
  - Charts: accordion-based per-chart + per-KPI-bundle controls with live previews, hex palette inputs, sparkline mode/curve/width/height, delta typography/icon styling, and optional advanced Apex JSON overrides (see Charts section)
  - KPIs: KPI order/labels/visibility + date-range labels/availability + header KPI strip page visibility

Admin-only (moved out of `/settings`):
- Admin → Controls: per-page loader toggles + Data & Reporting + Settings scope (read-only global for now)
  - Preview mode: “Preview as tier” is UI-only (does not change server auth). Stored in localStorage `kexo:preview:v1` and shows a “Preview: X (Exit)” item in the Settings dropdown.
- Admin → Diagnostics: config-status + reconcile utilities

Settings API:
- `GET/POST /api/settings` in `server/routes/settings.js`
- Returned payload includes (among other fields): `reporting`, `kpiUiConfig`, `chartsUiConfig`, `tablesUiConfig`, `insightsVariantsConfig`, `trafficSourcesConfig`
- New: `pageLoaderEnabled` (per-page loader overlay toggles; stored under `page_loader_enabled_v1`)
- Assets helpers:
  - `GET /api/asset-overrides` (read `asset_overrides`)
  - `POST /api/assets/upload` (multipart → Cloudflare R2, returns public URL; URLs are persisted via `/api/settings` and `/api/theme-defaults`)

Admin Controls API (admin-only):
- `GET/PUT /api/admin/controls` in `server/routes/adminControls.js` (persists `page_loader_enabled_v1`)

Diagnostics access:
- `GET /api/config-status` is now **restricted for non-admins** (returns a minimal payload for Settings/Integrations/footer tags).
- Full diagnostics payload is only returned to admin requests (OAuth cookie + users.role=admin; legacy: master).
- `POST /api/reconcile-sales` is admin-only (gated in `server/index.js`).

---

## Theme + Icons (GLOBAL)

Theme persistence:
- `GET/POST /api/theme-defaults` (POST uses patch semantics: only provided keys update).
- First-paint CSS variables are injected via `GET /theme-vars.css` and loaded in head (see `server/public/partials/head-theme.html`) to prevent header flash (and to hide disabled charts before paint).

Theme UI:
- `server/public/theme-settings.js` renders the Theme panel inside Settings.
- Header subtab contains non-color header controls only (visibility toggles, border on/off toggles, radius fields, logo override, strip padding, strip border-bottom toggle).
- Color subtab has 5 editable hex inputs for accents 1–5; strip, settings dropdown, menu, and online badge colors are derived from accent 1.
  - Strip opacity filter and Menu opacity filter (0–100%) control darkening of strip/menu backgrounds. Menu hover opacity (0–100%) and hover color (black/white) control the tint on menu link and dropdown item hover.
  - Settings dropdown inherits menu: same background, opacity, border, and link colors as the main menu; no separate dropdown settings.
- Early hydration in `server/public/partials/head-theme.html` loads 5 accent hex values from localStorage before paint.

Header + nav theming:
- Desktop top strip + main nav are styled via CSS vars in `server/public/custom.css`, overridden by `/theme-vars.css`.
- Examples:
  - `--kexo-header-top-bg`, `--kexo-header-top-text-color`
  - `--kexo-top-menu-bg` / `--kexo-header-main-bg`
  - `--kexo-top-menu-border-color`, `--kexo-top-menu-shadow`
  - Settings dropdown + Online badge have dedicated vars (bg/text/border/radius/menu colors)

Icons:
- Font Awesome kit is loaded globally in `partials/head-theme.html`.
- Runtime adapter: `server/public/fontawesome-icons.js`
  - Converts Tabler icon placeholders / inline nav SVGs to Font Awesome.
  - Icons are keyed via `data-icon-key="..."` across the app.
  - Settings-only icon keys (`settings-tab-*`, `settings-diagnostics-*`) are locked for stability.
- Devices: Theme → Icons now includes a “Detected Devices” accordion group populated from all-time sessions counts via `GET /api/devices/observed?minClicks=2`. Sessions tables now render platform+device icons (from `sessions.ua_platform` + `sessions.ua_device_type`) instead of device words.

---

## Charts (GLOBAL)

Charts are centrally configurable in Settings → Layout → Charts:
- DB key: `charts_ui_config_v1`
- Served by: `GET /api/settings` as `chartsUiConfig`
- Saved by: `POST /api/settings` (`chartsUiConfig` payload)
- Settings-side chart/KPI bundle accordion rendering is lazy-on-tab-open (render when Layout → Charts is active) to avoid hidden-panel select/input rendering glitches.
- `charts_ui_config_v1.kpiBundles` now controls three runtime KPI bundles:
  - `dashboardCards`
  - `headerStrip`
  - `yearlySnapshot`
  Each bundle carries `palette`, `sparkline`, and `deltaStyle` settings.

Chart builder (mirrors table builder pattern):
- `server/public/kexo-chart-defs.js`: KEXO_CHART_DEFS keyed by chartKey (modes, series, height, pieMetric)
- `server/public/kexo-chart-builder.js`: kexoEnsureApexCharts, kexoWaitForContainerDimensions, kexoRenderApexChart, kexoRenderSparkline, preview helpers
- Chart defs used by Settings → Layout → Charts; builder waits for container dimensions before render (fixes "data with no visuals" in modals).

Runtime apply:
- `server/public/app.js`: dashboard/insights/traffic charts + map behavior
- `server/public/ads.js`: Google Ads overview chart
- `server/public/app.js` now applies `kpiBundles` palette/sparkline/delta style to dashboard KPI cards, header strip KPI chips, and Business Snapshot yearly cards/sparklines.

Guardrail:
- Do not hardcode KPI sparkline colors, compare-line color, delta font/icon sizes, or delta font/icon colors in runtime paths; these are user-managed via `charts_ui_config_v1`.

Chart hiding (no flicker):
- Chart wrappers/cards in HTML carry `data-kexo-chart-key="<chartKey>"`.
- `GET /theme-vars.css` injects `display:none!important` for disabled charts so they disappear before first paint.
- Dashboard paired charts expand to full width when their partner is disabled (CSS injected server-side).

Libraries:
- ApexCharts for most charts
- jsVectorMap for the Countries map (supports `map-animated` vs `map-flat` and a configurable accent color)
- Chart.js is used only inside the Google Ads campaign modal (lazy-loaded)

---

## KPI system (GLOBAL)

KPI/date-range UI config:
- DB key: `kpi_ui_config_v1` (in `GET /api/settings` as `kpiUiConfig`)
- Applied by: `server/public/app.js` to:
  - condensed KPI strip order/labels/visibility + display options
  - condensed KPI strip show/hide per page (settings-managed)
  - dashboard KPI card order/labels/visibility
  - date range menu labels/availability
- KPI visual styling (sparkline type/curve/width/height, delta typography/icon sizing/colors, up/down/same/compare colors) is now sourced from `charts_ui_config_v1.kpiBundles` rather than fixed CSS values.
- First-paint behavior:
  - `app.js` hydrates KPI UI config from localStorage (`kexo:kpi-ui-config:v1`) and applies it before `/api/settings` resolves.
  - `/theme-vars.css` also injects CSS to pre-hide disabled condensed KPI chips and disabled Dashboard KPI cards (`#dash-kpi-grid`) to reduce refresh flicker.

KPI data:
- `GET /api/kpis` (server cached; also localStorage warm-paint to avoid empty chips on navigation)
- `GET /api/kpis-expanded-extra` for Shopify-derived extras (COGS, returns, items ordered, etc.)

---

## Shared table builder

All data tables and settings config tables use the shared builder. No hand-written table markup.

Files:
- `server/public/kexo-table-builder.js`: `buildKexoGridTable`, `buildKexoNativeTable`, `buildKexoSettingsTable`
- `server/public/kexo-table-defs.js`: `KEXO_TABLE_DEFS`, `KEXO_NATIVE_TABLE_DEFS`, `KEXO_TOOLS_TABLE_DEFS`, `KEXO_VARIANTS_MODAL_TABLE_DEFS`, `KEXO_SETTINGS_MODAL_TABLE_DEFS`, `KEXO_APP_MODAL_TABLE_DEFS`, `KEXO_BREAKDOWN_TABLE_DEFS` (column definitions keyed by tableId)

Static HTML tables are replaced with mount points: `<div data-kexo-table="<tableId>"></div>`. On DOMContentLoaded, `app.js` init finds mounts, fetches def, calls builder, injects result. Scripts `kexo-table-builder.js` and `kexo-table-defs.js` must load before `app.js` / `settings-page.js` / `ads.js` / `variants-page.js`.

Table checklist:
- Grid-table: `.table-scroll-wrap` or `.country-table-wrap` + `.grid-table` with `.grid-row--header`, `.grid-cell`, `.th-label-long`, `.th-label-short` (icon key optional). Body ID must match app selectors (e.g. `table-body`, `best-sellers-body`).
- Native table: `.table-responsive` + `<table class="table table-vcenter card-table">` for dashboard overview / Latest sales.
- Settings tables: `.table-responsive` + `<table class="table table-sm table-vcenter">`.
- Card markup preserves `data-table-id`, `data-table-zone`, `data-table-class` for Layout → Tables config.

---

## Key frontend files (high-signal)

- `server/public/kexo-chart-defs.js`: chart definitions (KEXO_CHART_DEFS); load before app.js / settings-page.js
- `server/public/kexo-chart-builder.js`: chart render helpers (waitForContainerDimensions, ensureApexCharts, renderApexChart, renderSparkline)
- `server/public/partials/head-theme.html`: early theme hydration + loads `/theme-vars.css` + Font Awesome + `fontawesome-icons.js`
- `server/public/partials/header.html`: desktop strip + desktop nav + KPI strip + mobile nav
- `server/public/app.js`: shared bootstrapping + report loader + charts/tables + Settings hydration
- `server/public/custom.css`: KEXO UI styling + header/nav theme vars + layout + KEXO 5-color logic
- `server/public/tabler-theme.css`: Tabler overrides
- `server/public/settings-page.js`: Settings tab logic + saving to `/api/settings`
- `server/public/theme-settings.js`: Theme UI
- `server/public/variants-page.js`: Insights → Variants rendering/paging/sorting (driven by `/api/insights-variants`)
- `server/public/sentry-helpers.js`: Sentry browser helpers (breadcrumbs, capture, fetch wrapper); loaded in head-theme.html
- `server/public/ads.js`: Google Ads page logic
- `server/public/tools.js`: Conversion Rate Compare tool logic
- `server/public/tools-click-order-lookup.js`: Click & Order Lookup tool logic

---

## Backend architecture highlights

- `server/index.js`: Express app, canonical page routes, auth middleware, static assets, startup migrations
- `server/middleware/dashboardAuth.js`: Shopify embed + direct OAuth cookie protection
- Users/approvals (master accounts; pending blocked everywhere):
  - Migration: `server/migrations/045_users.js` (`users` table: status/role/tier + last login meta)
  - `server/usersService.js`: users CRUD + bootstrap master (`smlsites@gmail.com`)
  - `server/routes/localAuth.js`: `POST /auth/local/register` (pending) + `POST /auth/local/login` (active/master only)
  - `server/routes/me.js`: `GET /api/me` returns `{ email, status, role, tier, isMaster }` for UI gating
  - `server/middleware/requireMaster.js`: master-only gate for `/admin` + `/api/admin/**`
  - `server/routes/adminUsers.js`: Admin APIs (`/api/admin/users`, approve/deny/promote)
- `server/store.js`: DB access + reporting queries + dedupe guardrails
- `server/variantInsightsConfig.js`: canonical Variants table/rule defaults + matching/validation helpers
- `server/variantInsightsService.js`: Variants data aggregation (truth orders + variant sessions) and validation sampling
- `server/migrations/*.js`: schema/index migrations run on startup
- Ingest: `POST /api/ingest` (strict JSON limit), writes events/sessions/purchases (append-only; no deletes)

Ops/reliability:
- Static assets are versioned into HTML (query param `?v=`) to avoid Shopify embed caching mismatches.
- `GET /api/version` returns `assetVersion` so clients can detect deploy drift after long-idle tabs (UI prompts user to click Refresh; no forced reload).
- `.md`/`/docs` paths are blocked in production (see `server/index.js`).

---

## Deployment notes

- GitHub Actions are manual (`workflow_dispatch`).
- Railway hosts production and auto-deploys from git; do not run `railway up` — push to main is sufficient.
- `npm start` runs `scripts/prune-runtime-files.js` (removes non-runtime files from the runtime image).
- SQLite is ephemeral on Railway; production should use Postgres via `DB_URL`.

---

## Guardrails

- Never delete/truncate core data tables (`purchases`, `purchase_events`, `orders_shopify`, `sessions`) to “fix numbers”.
- Handle over-reporting via dedupe in stats queries (see `server/store.js` helpers).
- Sales product mapping: keep Product Insights links truth-stable (open by `product_id` when handle is missing). Avoid reintroducing handle-only linking or session-handle authority for sales widgets (see `server/store.js` `listLatestSales()` + `server/public/app.js` product links).
- Abandoned carts data: do not reintroduce Postgres upsert behaviour that overwrites `sessions.is_abandoned/abandoned_at/recovered_at`. Abandonment is marked asynchronously by the cleanup loop in `server/cleanup.js` based on inactivity beyond `ABANDONED_WINDOW_MINUTES`.
- ApexCharts 4.x line visibility: line charts must keep `stroke.show=true` and avoid `fill.opacity=0` (can render markers without connecting strokes). See `server/public/kexo-chart-builder.js` + `server/public/app.js` chart configs.
- When changing dashboard sections/definitions, update `server/trackerDefinitions.js`.
- Fraud/affiliate abuse detection: never store raw IP; IP/UA are HMAC-hashed using `FRAUD_IP_SALT`. Fraud tables are additive-only; dashboards must fail-open (no blocking if fraud APIs fail or tables missing).
- Multi-tenant scaling guardrail (FUTURE): do not run one deployment for multiple Shopify stores until tenant isolation is implemented:
  - Add `shop_id` (or `shop`) to core tracking tables (`sessions`, `events`, `visitors`, `purchases`) and index by `(shop_id, started_at/ts/last_seen)` so queries never scan other stores.
  - Ingest must validate/store the shop on every row; APIs + `report_cache` keys must be shop-scoped (avoid `shop: ''` cache collisions).
  - Background jobs (cleanup, ads attribution sync, truth warmups) must iterate shops safely (concurrency-limited) — no single-shop config fallbacks.
  - Prefer Shopify webhooks + bulk import for orders so `orders_shopify` stays mirrored without report-time Shopify pagination; add daily rollups + retention for raw events to keep reports fast at scale.

---

## Changelog (high-signal)

2026-02-16 (latest)
- Snapshot page header date control removed:
  - `server/public/app.js` now skips `mountDesktopDatePickerIntoPageHeader()` on `data-page="snapshot"` so Snapshot keeps only its own date-range control.
  - `server/public/custom.css` hides global nav/header date controls on Snapshot (`.kexo-nav-date-slot`, `.kexo-page-header-date-col`).

2026-02-16 (latest)
- Fraud scoring catch-up (drawer “Fraud scoring unavailable” fix for backfilled/reconciled sales):
  - Added a small, best-effort post-boot backfill that creates missing `fraud_evaluations` from `purchase_events` checkout-completed evidence (`server/fraud/backfillFromEvidence.js`, scheduled from `server/index.js`).
  - Fraud table availability checks now use a short negative-cache TTL (avoid “stuck disabled until restart” after transient DB errors) in `server/fraud/service.js`, `server/fraud/linker.js`, `server/fraud/affiliateAttribution.js`.
  - Drawer fraud block now distinguishes “system unavailable” vs “no evaluation yet” (`server/public/app.js`).

2026-02-16 (latest)
- Snapshot Profit Settings tab layout tweak:
  - In `server/public/insights/snapshot.html`, the Integrations tab now contains only the Google Ads spend toggle.
  - Shopify app bills, transaction fees, and Klarna fee toggles were moved to the first Rules tab (page 1) under “Additional cost groups”.

2026-02-16 (latest)
- Snapshot breakdown zero-row rendering fix:
  - `server/public/pages/insightsSnapshot.js` no longer filters out `amountGbp === 0` in cost breakdown maps, so enabled integration rows with `£0.00` now render under Cost as intended.

2026-02-16 (latest)
- Snapshot cost breakdown follow-up (fees/bills visibility):
  - Snapshot now keeps integration breakdown rows visible when toggled even if value is `£0.00` (Google Ads, Shopify app bills, transaction fees ex Klarna, Klarna fees), so users can see exactly which cost groups are enabled.
  - Shopify Payments fee/bill lookup now uses a dedicated newer Admin GraphQL API version path and exposes lookup status/errors in `sources.shopifyPaymentsDetail` for easier diagnostics when scopes/data are unavailable.

2026-02-16 (latest)
- Header KPI chip bar labels now mirror true deltas:
  - `server/public/app.js` (`applyCondensedKpiDelta`) now sets the progress-bar screenreader label from the real absolute delta percentage (e.g. `131.8% change`) instead of capped bar width (`100%`).
  - The bar still caps visual width at 100% for layout, but the reported change value now matches the KPI delta text.

2026-02-16 (latest)
- Today KPI compare windows now use matching partial session baselines:
  - `server/store.js` now detects partial historical day windows in `getSessionCounts()` and falls back to session-table counts for those windows (instead of day-level Shopify Sessions snapshots).
  - This fixes small KPI comparisons for Today (especially Sessions + Conversion Rate and any compare-dependent deltas), where yesterday baseline windows must be same-time, not full-day.

2026-02-16 (latest)
- Header KPI strip now always uses `/api/kpis` (truth + compare) on all pages:
  - `server/public/app.js` no longer overwrites KPI cache from the Stats report payload (which can drift and may not include compare windows).
  - Navigation `ensureKpis()` now treats non-`/api/kpis` KPI caches (or range mismatches) as stale and forces a refresh, fixing “dashboard KPIs correct, small KPIs wrong” on other pages.

2026-02-16 (latest)
- Snapshot cost breakdown + Profit Rules integration toggles:
  - Snapshot Revenue & Cost table now shows indented Cost breakdown lines (this/previous/delta) directly under the Cost KPI row.
  - Profit Rules → Integrations now includes toggles for Shopify app bills, transaction fees, and Klarna fees (in addition to Google Ads spend).
  - `GET /api/business-snapshot` now optionally includes Shopify Payments-derived app-bill + fee costs in Cost/Profit and in cost chart series for both current and compare windows; it fails open when Shopify Payments scope/data is unavailable.
  - Snapshot table styling updated to remove left cell padding + bottom borders, and the performance chart picker is compact/right-aligned (`Chart`) for tighter resolutions.

2026-02-16 (latest)
- Admin → Users login visibility:
  - Google OAuth logins now write user login metadata (`last_login_at` + geo/device fields) in `server/routes/oauthLogin.js` using the same metadata model as local auth.
  - First Google login now creates a pending user row with metadata (when missing) before approval gates run, so Admin → Users has immediate context.
  - `GET /api/admin/users?status=active` now appends Shopify auth rows sourced from `shop_sessions.updated_at` (store-level, provider `shopify`) so recent "Login with Shopify" activity appears in the Users table.
  - `server/public/admin-page.js` treats provider `shopify` rows as read-only session rows (no promote button; badge shown).

2026-02-16 (latest)
- Header KPI compare baseline refresh (Today):
  - `server/store.js` (`getKpis`) now derives one canonical previous-period window and, when range is `today`, also **blocks on** refreshing Shopify truth for the compare window (`yesterday` same-time) before calculating compare deltas.
  - This prevents stale yesterday-baseline values from making condensed/header KPI deltas (for orders/revenue/conversion and related compares) read incorrectly during Today views.

2026-02-16 (latest)
- Snapshot loader fix (stuck page-body overlay):
  - `server/public/app.js` now hard-disables the global page-body loader for `snapshot` (`defaultPageLoaderEnabledV1`, `normalizePageLoaderEnabledV1`, `isPageLoaderEnabled`) and includes `snapshot` in the prime-time no-loader list.
  - Reason: `/insights/snapshot` uses its own in-card loading states (`server/public/pages/insightsSnapshot.js`) and does not run the report-build overlay finish path, so the global overlay could remain indefinitely.

2026-02-16 (latest)
- Snapshot page migration (Business Snapshot modal retired):
  - New first-class page `/insights/snapshot` (`server/public/insights/snapshot.html` + `server/public/pages/insightsSnapshot.js`) with preset/custom date ranges, URL sync, KPI tables, chart overlays (this vs previous), loading/error states, and explicit non-admin Not authorised state.
  - Header nav moved Snapshot into Insights dropdown (`nav-tab-snapshot`) and removed the Settings dropdown Business Snapshot button.
  - Legacy `initBusinessSnapshotModal` block removed from `server/public/app.js`; nav state now treats `snapshot` as an Insights child; icon references to `header-business-snapshot` removed.
  - `GET /api/business-snapshot` now supports `mode=range&since=YYYY-MM-DD&until=YYYY-MM-DD&preset=...` with deterministic compare-window rules (rolling/custom, calendar month, and YTD), richer `sources.rangeYmd/compareRangeYmd`, and now/previous daily series payloads for overlays.
  - Snapshot cache key now includes exact current/compare range fields plus a profit-rules fingerprint so profit toggle/rule changes invalidate cached payloads predictably within the 10-minute TTL model.
  - Profit rules modal remains available from Snapshot via `GET/PUT /api/settings/profit-rules`; profit KPI visibility now honors enabled rules/integration + backend `financial.profit.visible`.

2026-02-16 (latest)
- Sale toast/beep hard dedupe + eye replay exception:
  - `server/public/app.js` now assigns persistent per-sale identity keys (order ID, checkout token, click/session + purchased timestamp, createdAt) and keeps a bounded seen-key cache in localStorage (`kexo:sale-toast-seen:v1`) so the same automatic sale notification cannot fire twice across SSE/stats overlap, reconnects, or refreshes.
  - `GET /api/latest-sale` (`server/routes/latestSale.js`) now includes `sale.sessionId` when evidence links exist, and stats-origin sale toasts fetch this endpoint first so dedupe aligns with SSE click/session identity instead of only count deltas.
  - Manual replay via the header/footer eye uses `allowReplay: true`, so "show last sale" always works on demand without changing the one-time uniqueness gate used for automatic notifications.

2026-02-16 (latest)
- Session drawer polish:
  - Side drawer header is **Session Details** and shows inline row icons (country + channel + device) with small labels; icons/images are normalized to 12px and the header is not sticky.
  - Source section adds **Copy URL** (copies the entry URL with UTMs merged in when available).
  - Network (Verified bot category + City) rows are forced left-aligned (City remains empty unless captured via Cloudflare/Worker headers).

2026-02-15 (latest)
- Settings loader + Sale Notification preview reliability:
  - Settings page loader overlay is now hard-disabled across runtime + settings bootstrap + admin controls + API normalization (`server/public/app.js`, `server/public/settings-page.js`, `server/public/admin-page.js`, `server/routes/settings.js`, `server/routes/adminControls.js`).
  - Admin Controls now shows Settings loader as locked off and does not persist it as configurable.
  - Settings → Kexo UI → Sale Notification Preview now prefers runtime audio via `window.__kexoPreviewSaleSound` in `server/public/app.js` (same primed `saleAudio` path as live sale notifications), with fallback + visible failure messaging in `server/public/theme-settings.js`.

2026-02-15 (latest)
- Compliance drawer + Click & Order Lookup unification:
  - Compliance icons are no longer links; clicking the row/icons opens the right-hand drawer.
  - Drawer embeds the Click & Order Lookup view (single payload/renderer) and shows the Kexo Click Fraud Score half-donut gauge.
  - `GET /api/tools/click-order-lookup` now returns `events` so the tools page can show the same Activity feed.
  - Copy affordances are links and IDs-only (Click ID, Shopify order ID, checkout token, Kexo order key).

2026-02-15 (latest)
- iOS sale notification sound + settings preview hardening:
  - Runtime sale toast sound now dedupes across SSE/stats overlap in `server/public/app.js` to prevent repeated chimes for the same sale (most visible on `/dashboard/sales`).
  - Stats-origin toast triggers now include a stable dedupe key (`stats:today:<convertedCount>`) and are suppressed when they immediately follow an SSE-origin trigger for the same moment.
  - iOS retry fallback no longer stacks repeated deferred listeners; it uses a single one-shot recovery listener across pointer/touch/click/keydown.
  - Settings → Kexo UI → Sale Notification Preview now reuses one persistent `Audio` instance in `server/public/theme-settings.js`, primes from first gesture, and shows user-visible failure feedback instead of silent catch-all failures.

2026-02-15 (latest)
- Google Ads network tracking (ValueTrack `{network}`):
  - Ingest now captures `bs_network` from `entry_url` into `sessions.bs_network` (migrate `048_sessions_bs_network`).
  - Ads campaign modal now shows a **Network** breakdown table (sessions + attributed orders/revenue) using `sessions.bs_network` + `ads_orders_attributed.visitor_network`.
  - Intended for account-level Final URL suffix usage: `bs_network={network}` (avoid unsupported placeholders like `{campaignname}` and avoid duplicating auto-tagging click IDs).
  - Hardening: `/api/ingest` now captures unexpected ingest errors to Sentry (rate-limited) and `store.upsertSession()` fails open if `sessions.bs_network` column is missing (pre-migration DB).

2026-02-15 (latest)
- Google Ads campaign modal enhancements:
  - Modal now has its own range selector (presets + custom `r:YYYY-MM-DD:YYYY-MM-DD`) independent of the global date filter.
  - Campaign detail modal adds **Device performance** + **Day parting** sections (Recent sales remains last), and hardens modal table header styling.
  - Backend: new Ads DB table `google_ads_device_daily` (Google segments.device) + persisted `ads_orders_attributed.visitor_device_type` so device ROAS can be computed without cross-DB joins.

2026-02-15 (latest)
- Dashboard KPI visibility fix:
  - KPI UI settings now correctly hide disabled dashboard cards even after moving some KPIs into `#dash-kpi-grid-lower` (COGS/Fulfilled/Returns/Items).

2026-02-15 (latest)
- Dashboard extras KPI sparklines (COGS / Fulfilled / Returns):
  - `/api/kpis-expanded-extra` now returns per-bucket spark series under `spark` (and compare under `compare.spark`), so these KPI cards have real charts behind them.
  - Dashboard KPI cards render these sparklines with a dashed compare overlay once extras load (silent re-render from cached dashboard).

2026-02-15 (latest)
- Sticky column + tools UX:
  - Sticky cells: new gradient bg (linear-gradient 90deg #fff→#f8fafc), border-right 1px #f8fafc, box-shadow removed, swipe/drag-scroll cursor removed.
  - CR% overflow: min-width 52px for dashboard 4-col tables (dash-top-products, dash-top-countries, dash-trending-up/down).
  - Mobile: country name hidden in sticky first column (flag only).
  - Sticky resize: added .tools-table-wrap to WRAP_SELECTOR so tools tables get resize handle.
  - Tool pages (compare-conversion-rate, shipping-cr, click-order-lookup): date range picker hidden in nav.

2026-02-15 (latest)
- Page loader animation: restored indeterminate progress bar animation (sliding bar) — custom KEXO gradient override had no animation; added pageLoaderIndeterminate keyframes.

2026-02-15 (latest)
- Tool pages loader fix: compare-conversion-rate, shipping-cr, click-order-lookup no longer show the page-body loader on init (they don't use the report build system and never called finish(), so the loader covered content indefinitely).

2026-02-15 (latest)
- Dashboard extras KPIs performance:
  - `/api/kpis-expanded-extra` (COGS/Fulfilled/Returns/Items) is cached for 30 minutes (server + client) to reduce slow/empty KPI cards.
  - Shopify updated-orders scan no longer fetches `line_items` (items ordered is DB-derived), reducing payload and improving reliability.
  - COGS is computed independently of the Shopify updated-orders scan, so it can populate even when Fulfilled/Returns are slow/limited.

2026-02-15 (latest)
- Devices icons + Sources v2 groundwork:
  - Devices: `GET /api/devices/observed?minClicks=2` (sessions-based counts) + Theme → Icons “Detected Devices” accordion; sessions tables Device column now renders platform+device icons (new keys: `type-platform-mac`, `type-platform-chromeos`).
  - Sources v2: new engine/config in `server/trafficSourcesConfig.js` persisted under Settings key `traffic_sources_config_v1` (exposed as `trafficSourcesConfig` on `/api/settings`).
  - Sources v2 APIs: `GET /api/traffic-sources-v2/suggestions`, `POST /api/traffic-sources-v2/suggestions/apply`, `GET /api/traffic-sources-v2/diagnostics`.
  - Settings → Sources rebuilt (new `server/public/traffic-sources-v2-settings.js`) and legacy v1 mapping kept under a collapsible panel.
  - Runtime: sessions API enriches rows with `traffic_source_v2_*` fields; sessions Source column now prefers v2 iconSpec (FA/SVG/URL) when available.

2026-02-15 (latest)
- Settings: Theme renamed to Kexo UI. Sale Notification moved from top-level tab into Kexo UI subtab (presets Kexo 1–4; custom URL/upload). Sale sound configurable via `asset_overrides.saleSound`; runtime uses it in `getCashRegisterMp3Url()`.

2026-02-15 (latest)
- Sticky column resize handle: replaced broken inline SVG with Font Awesome icon (`fa-solid fa-left-right`). New icon key `table-sticky-resize-handle` in Settings → Theme → Icons (Tables group); configurable like other table icons.

2026-02-15 (latest)
- Fraud alert system (affiliate abuse detection):
  - New tables/migration: `047_affiliate_attribution_and_fraud` adds `affiliate_attribution_sessions`, `fraud_evaluations`, `fraud_config`.
  - Ingest captures attribution signals (UTMs + paid/affiliate click IDs) with immutable first-touch + rate-limited `last_seen` updates; IP/UA are hashed (no raw IP storage).
  - Checkout-completed writes deterministic fraud evaluations (score 0–100 + flags + safe evidence snapshot); optional AI narrative is feature-flagged.
  - UI: sessions tables now show a narrow Compliance column (check/warn + optional sale icon) immediately after the sticky Landing column; icons link to Tools → Click & Order Lookup for deep inspection.
  - Tools: new `/tools/click-order-lookup` page + `GET /api/tools/click-order-lookup` search API to resolve click/order/token keys and print all captured info (fraud, attribution, geo, device, timing, truth links).
  - APIs: `GET /api/fraud/markers`, `GET /api/fraud/detail`, `GET /api/tools/click-order-lookup`, admin config/resolution under `/api/admin`.

2026-02-15 (latest)
- Sale sound reliability: (1) SSE first-sale no longer skipped when lastSaleAt is null — now fires toast+sound if sale is within 2 min (avoids race with hydrateLastSaleFooterFromApi). (2) Added touchstart to audio prime listeners and explicit prime on eye/footer last-sale toggle pointerdown/touchstart so sale sounds unlock on first footer interaction.

2026-02-16 (latest)
- Default logos: login `kexo_login.png`, header `kexo_new2.png`, footer `logo_foot.png`. Removed old assets (login.webp, kexo-color-*, kexo-white.png, etc.).

2026-02-15 (latest)
- Dashboard KPI sparklines + compare labels:
  - Dashboard KPI card sparklines now render the raw per-bucket series from `/api/dashboard-series` (no rescaling to end at KPI totals), fixing flat/inactive Yesterday/Day-before lines.
  - Compare labels now show explicit dates/date-ranges (e.g. `Feb 13`, `Feb 8 – Feb 14`) instead of generic “Day before” / “Previous 7 days”.
  - COGS / Fulfilled / Returns KPI cards no longer render synthetic diagonal sparklines (sparkline slots are cleared until real per-bucket series exists).

2026-02-15 (latest)
- Loader color update:
  - Unified page/report loaders now use KEXO 5-color segmented blocks (20% each) instead of blended gradients.
  - Updated shared loader progress bars (`.page-loader-progress`) and loader rings (`.report-build-spinner`, Ads loader spinner) to use accent colors 1→5 in order.

2026-02-15 (latest)
- Abandoned carts tables + footer last-sale reliability:
  - Added no-data block mode for abandoned carts top tables: when empty, headers/cells are hidden and a full-width centered padded message block is shown in-table.
  - Footer "Last sale" now hydrates from `/api/latest-sale` at startup (so non-admin/restricted diagnostics users still get a baseline timestamp).
  - `GET /api/latest-sale` now falls back to latest paid order overall when there is no paid order today (prevents persistent `Last sale: —` on low-volume days).

2026-02-15 (latest)
- Google Ads integration accuracy + audit:
  - Ads page now reads the global date picker correctly (Yesterday/14d/30d now work end-to-end).
  - New Audit modal on `/integrations/google-ads` with `GET /api/ads/audit?range=...` to show click→session coverage + mapping coverage.
  - Ads campaigns table headings/order updated (Clicks, Impr, Conv, Revenue, Spend, ROAS, Gross) and Audit icon is theme-configurable (`ads-actions-audit`).
  - Added geo-by-country sync into Ads DB (`google_ads_geo_daily`) using Google Ads `geographic_view`, wired into scheduled jobs and `POST /api/ads/refresh`.
  - Campaign modal now includes per-country clicks/spend/revenue/CR/ROAS; revenue groups by visitor session country via `ads_orders_attributed.session_id` + `visitor_country_code`.

2026-02-15 (latest)
- Modal/backdrop consistency:
  - Theme Icon Edit modal now always renders a dark backdrop (including fallback path when Bootstrap modal APIs are unavailable).
  - Theme Icon Edit modal close behavior fixed: header X, outside-click, and Escape now close reliably.
  - Business Snapshot modal backdrop darkened to match default modal overlay standard.
  - Global modal overlay default in `custom.css` is now dark (`.modal-backdrop` black, higher opacity) unless a modal explicitly overrides it.

2026-02-15 (latest)
- Sessions tables + settings polish:
  - Sessions tables: replaced the old leading sale/fraud icon columns with a single Compliance column after the sticky Landing column (check/warn + optional sale icon).
  - Settings: removed converted-row color configuration from Layout → Tables (runtime no longer applies converted-row CSS variables).
  - Recent Sales: removed the “Next update” header block (polling continues; updates auto-apply when safe).
  - Abandoned Carts: replaced the mode dropdown with an inline “Switch to …” link under the page title.

2026-02-15 (latest)
- Theme Icons visual editor shipped:
  - Settings -> Theme -> Icons now renders grouped accordion sections and an audit panel (missing in settings + removed/legacy keys).
  - Icon glyph inputs now support both Font Awesome classes and pasted SVG markup.
  - Each icon card includes an Edit action with a modal for optional per-icon size/color overrides; overrides persist under `theme_icon_overrides_json`.
  - Runtime icon renderer now applies overrides to both FA and SVG modes, and normalizes SVG sizing (ignores pasted intrinsic width/height unless override size is set).
  - Theme defaults API now persists `theme_icon_overrides_json`.

2026-02-15 (latest)
- Icon registry guardrails + drift prevention:
  - Added canonical icon registry at `server/shared/icon-registry.js` (defaults + locked keys + legacy keys + required active keys).
  - Frontend icon consumers now hydrate from `/icon-registry.js` (served by `server/index.js`) instead of maintaining duplicate hardcoded icon key maps.
  - Theme defaults whitelist in `server/routes/settings.js` now derives all `theme_icon_glyph_*` keys from canonical registry (`getThemeIconGlyphSettingKeys()`), preventing stale/missing whitelist drift.
  - Added `test/icon-registry-sync.test.js` to hard-fail drift between canonical registry, backend whitelist, and frontend consumers.
  - CI now runs `npm test` in `.github/workflows/ci.yml`, so icon drift is caught in automation.
  - Added Cursor rule `.cursor/rules/icon-registry-guardrails.mdc` to enforce canonical icon mapping workflow for future agents.

2026-02-15 (latest)
- Theme Icons audit + editor overhaul:
  - Settings -> Theme -> Icons now includes an audit summary for icon-key drift:
    - used in theme but missing from settings
    - in settings but removed from theme (legacy list)
  - Icon fields now accept either Font Awesome classes or pasted `<svg>...</svg>`.
  - Added per-icon **Edit** modal for optional size/color overrides (shared persistence key: `theme_icon_overrides_json`), applied in runtime for both FA and SVG output.
  - SVG rendering now ignores pasted intrinsic width/height and defaults to icon size unless override size is set.
  - Icons UI is grouped into accordion sections (Header/Nav, Footer, Tables, Cards/Charts, Runtime, Admin, Legacy, Misc).
  - Icon-key alignment fixes:
    - Added missing active keys: `nav-item-admin`, `admin-tab-controls`, `admin-tab-diagnostics`, `admin-tab-users`
    - Backend theme whitelist now includes `nav-dropdown-arrow`, `chart-builder-icon`, `table-icon-converted-sale`, admin keys, and removes stale backend-only keys (`sale_toast_time`, legacy `diag_tab_*`).

2026-02-15 (latest)
- Admin controls + loader UX + plan gating:
  - Admin now has Controls + Diagnostics panels; moved Settings scope + Data & Reporting + Diagnostics out of `/settings`.
  - Page loader overlay is now configurable per page (persisted `page_loader_enabled_v1`); Admin is always disabled; refresh/resume refreshes are silent (no overlay).
  - Branding overrides (favicon + logos) are plan-gated for normal accounts with an in-app `/upgrade` TODO pricing page; backend enforces `upgrade_required` for uploads/saves.
  - `/api/config-status` returns a restricted payload for non-masters; reconcile endpoint is master-only.
- Dashboard-series cache fix for "today" adaptive buckets:
  - Cache key now includes rangeEndTs (rounded to 1 min) for today/yesterday so the first request of the day does not serve stale data all day. Adaptive 15/30/60-min bucket logic was correct but cache was returning the first computed result regardless of current time.
- Dashboard KPI stability + exact Today compare + auto-refresh:
  - KPI deltas + sparkline tones treat ±5% as stable/blue (reduces noisy up/down flips on small changes).
  - `/api/dashboard-series` supports `endMs` clipping; dashboard compare series passes compare-end (rounded to 1 min) so Today compare uses the same 15/30/60-min buckets as Today.
  - Dashboard auto-refreshes dashboard-series every 60s for Today/1h (silent).
  - Dashboard compare label for `today` is now explicit: **Yesterday (same time)** (avoids confusion with full-day Yesterday values).
  - Returning sparkline buckets now classify returning orders using truth-aligned fallback when `customer_orders_count` is null (`customer_order_facts.first_paid_order_at < order.created_at`), preventing false-flat returning compare lines.
  - Dashboard extras `COGS`, `Fulfilled`, `Returns`, `Items ordered` now use neutral delta/sparkline tone (`#999`) instead of red/green.
  - Those four dashboard KPI cards are moved to a lower row below Trending Up/Down on `/dashboard/overview` (`#dash-kpi-grid-lower`); settings-driven KPI ordering now respects this lower group.

2026-02-15 (earlier)
- Sparkline data and compare-line alignment fixes:
  - FULFILLED, RETURNS, COGS: no longer use orders/revenue shape as fallback; use simple [baseline, current] two-point line when no per-bucket data (dashboard-series has no fulfilled/returns per bucket).
  - Compare-line alignment: use first N buckets of compare (same time-of-day) instead of last N; pad at end when compare has fewer buckets. Fixes RETURNING compare flat when activity was in early hours, and yesterday vs day-before compare alignment.

2026-02-15 (earlier)
- Adaptive today buckets + KPI fixes:
  - Dashboard sparklines for "today" now use adaptive bucket sizing: 15-min buckets when &lt;4h elapsed, 30-min when 4–8h, hourly when 8h+. Produces more data points early in the day (less flat sparklines).
  - KPI delta: when baseline is 0 and current is non-zero, show "new" instead of "+100%" (avoids misleading division-by-zero semantics).
  - Items Ordered: now sourced from `orders_shopify_line_items` (DB) instead of Shopify Orders API, so "Day before" and "Previous 7 days" show data reliably.

2026-02-15 (earlier)
- KPI compare line fixes and Settings:
  - Dashboard sparkline compare line now shows actual comparison-period data from `/api/dashboard-series?range=<compareRangeKey>` instead of scaled current-period shape. `ensureDashboardCompareSeries` is wired into `renderDashboard` and compare arrays are built from the fetched compare series (revenue, sessions, orders, returning, conv, aov, bounce, roas, items); fulfilled/returns/cogs fall back to scaled baseline (no series in dashboard-series).
  - Settings → Layout → Charts → Dashboard Cards: added "Use primary color at opacity" checkbox and "Compare opacity (%)" input. When enabled, compare line uses primary KPI color at specified opacity (default 50%) and is not dashed. When disabled, uses palette.compareLine (hex) with dashed stroke.
  - `charts_ui_config_v1.kpiBundles.dashboardCards.sparkline`: new `compareUsePrimaryColor` (bool), `compareOpacity` (0–100). Defaults: true, 50.

2026-02-15 (latest)
- Preview mode + Admin role rename:
  - Admin → Controls includes “Preview as tier” (UI-only) so admins can simulate what customers see.
  - Role is now `admin` (legacy `master` accepted during rollout). Migration 046 updates existing `users.role` values.
- Long-range report responsiveness + “no more silent waiting”:
  - Shopify truth reconciliation scopes unified across reports to avoid duplicate backfills (`range_<rangeKey>` via `salesTruth.scopeForRangeKey()`).
  - Non-today report reconciles are now non-blocking (fire-and-forget) so pages don’t hang for minutes on Shopify Orders API pagination.
  - Truth reconcile throttling is higher for historical scopes (min 15 min) to avoid refetching 30d/month ranges on every refresh.
  - Added an always-visible header date-range spinner while reports are building (`body.kexo-report-loading` toggled by `app.js`; Variants page participates too).
  - Settings → Diagnostics: Overview now has a Range selector (Today/Yesterday/7d/14d/30d) to compare Shopify sessions vs Kexo human sessions against truth orders; served by `GET /api/config-status?range=...` and backfills `shopify_sessions_snapshots` via ShopifyQL timeseries.
  - Server warms Shopify truth for `30d` shortly after boot (`server/index.js`) so long-range reports can read from our DB without first-hit Shopify pagination.
  - Multi-tenant readiness note: core tracking tables are currently global in places; future rollout to many stores requires tenant-scoped schemas/queries/caches and per-shop background jobs (see Guardrails).

2026-02-14 (latest)
- Auth pages UI refresh (Tabler templates):
  - `/app/login` now matches Tabler’s Sign in layout; bottom “social” buttons are **Google** + **Shopify** (neutral Tabler button styling, icons via inline SVG; no custom green/blue button backgrounds).
  - Added dedicated `/app/register` page matching Tabler’s Sign up layout (local email/password registration); successful signup redirects back to `/app/login?registered=1`.
  - Login/register pages use logo: `/assets/logos/new/kexo_login.png`.

2026-02-14 (latest)
- Admin accounts + approvals:
  - Added `users` table (migration 045) with statuses (`pending|active|denied`) + roles (`user|admin`) + last login meta (country/city/device/platform).
  - Pending/denied accounts are blocked everywhere by `dashboardAuth` (pages redirect to `/app/login?error=pending|denied` via logout).
  - Seed admin: `smlsites@gmail.com` (bootstrap to `active/admin` on first email-based session).
  - Added local email/password login + signup on `/app/login` (`/auth/local/register`, `/auth/local/login`).
  - Added admin-only Admin → Users page (`/admin`) with Active/Pending tabs + Approve/Deny/Promote-to-admin actions (`/api/admin/...`).
  - Top settings dropdown now contains **Admin** + **Business Snapshot** items, shown only for admins (client gates `.kexo-admin-only` via `GET /api/me`; server gates `GET /api/business-snapshot` via `requireMaster`).

2026-02-14 (latest)
- Active dropdown item (desktop): font-weight 700 + ::after 3px accent border at bottom when dropdown is open. Uses `var(--kexo-accent)` for icon colour.
- Nav dropdown accent: JS-driven. `initNavDropdownAccent()` listens for `show.bs.dropdown`/`hide.bs.dropdown` on `.kexo-desktop-nav-list`, adds/removes class `kexo-dropdown-open` on the nav-item, and injects a `<style id="kexo-nav-dropdown-accent">` block that forces accent on tab + dropdown when open. Fixes CSS conflicts where darker colour overrode accent. When closed, active tab uses transparent background (no bright blue). When open, tab + dropdown share same bright accent. Added `data-bs-popper="static"` to main nav dropdowns so they stay in DOM and inherit `--kexo-accent`. Dark-theme override ensures open dropdown stays accent.
- Page loader: disabled on settings page (`PAGE_LOADER_ENABLED.settings: false` in `app.js`). Horizontal page loader overlay never shows on `/settings`.
- Top menu (`custom.css`): active tab (dropdown closed) uses kexo accent background per nth-child (e.g. first = blue); when open, tab + dropdown share same accent. Dropdown items use `background: none`. Mobile open tab gets `height: -webkit-fill-available` and `border-radius: 0`.
- Login page refresh (`server/routes/login.js`):
  - Added a working **Login with Shopify** button beside Google in a 50/50 two-column grid.
  - Shopify button now uses the inline Shopify SVG; Google button uses the inline Google SVG.
  - Applied requested colors: page background `#19222e`, Shopify button `#3eb3ab`, Google button `#4b94e4`.
  - Heading updated to “Login to Kexo Below”.
  - Shopify button resolves shop from `?shop=` or `ALLOWED_SHOP_DOMAIN`; when missing, button is disabled with a guidance note.

2026-02-14 (latest)
- Auth/session UX hardening:
  - Frontend fetch wrapper (`server/public/sentry-helpers.js`) now detects same-origin API `401` and performs a one-time redirect to `/app/logout?error=session_expired&redirect=<current-path>` so users are signed out cleanly instead of staying on a broken page with repeated console/API errors.
  - Login page (`server/routes/login.js`) now accepts `?redirect=` and carries it into Google sign-in, returning users to their original page after login.
  - Login page mobile overflow fixed (responsive container sizing + `overflow-x:hidden`) to prevent side overhang on narrow screens.

2026-02-14 (latest)
- Top menu (desktop + mobile): icons white, opacity 0.3 by default, opacity 1 when active/open; no border-radius on nav link or dropdown; active tab full height and uses accent background (joins dropdown); dropdown uses same accent as its menu item (per-item colour via .nav-item.dropdown.show .dropdown-menu). Desktop: word + chevron shown, no grid. Mobile: words + chevron hidden, grid 20% each.

2026-02-14 (latest)
- Mobile nav: icons white by default, grid layout (20% each), removed Bootstrap focus ring/outer border.

2026-02-14 (latest)
- Mobile login blank dashboard fix: added pageshow (bfcache) and visibilitychange handlers so the dashboard refreshes when the page is restored from back-forward cache or when the user returns from OAuth (e.g. switching to Google app on mobile). Prevents blank dashboard until manual refresh after login.

2026-02-14 (latest)
- Range key normalization is now consistent across key analytics APIs:
  - Server endpoints now accept both UI-friendly keys (`7days`/`14days`/`30days`) and canonical keys (`7d`/`14d`/`30d`), plus `month` and custom keys (`d:YYYY-MM-DD`, `r:YYYY-MM-DD:YYYY-MM-DD`).
  - Shared helper: `server/rangeKey.js` (with unit tests) to prevent drift between routes.
  - Variants page now normalizes the header date selector before calling `/api/insights-variants` (`server/public/variants-page.js`).
- Product landing session denominators are faster + more consistent:
  - Migration: `server/migrations/044_backfill_first_product_handle.js` backfills `sessions.first_product_handle` from `first_path`/`entry_url` when missing.
  - Ingest now derives `product_handle` from `/products/<handle>` paths when payload omits it (`server/store.js`), so new sessions persist landing handles.
  - Product report routes now aggregate landings via SQL on `sessions.first_product_handle` (avoids scanning every landing session row):
    - `server/routes/shopifyBestSellers.js`
    - `server/routes/shopifyBestVariants.js`
    - `server/routes/shopifyLeaderboard.js`
    - `server/routes/worstProducts.js`
    - `server/routes/shopifyWorstVariants.js`
  - Geo product report no longer preloads all landing sessions; it aggregates only the selected country+handle pairs (`server/store.js` `getBestGeoProducts()`).

2026-02-14 (latest)
- Dashboard online KPI polling (`server/public/app.js`) is now 401-safe and rate-limited:
  - Added explicit auth-fail guard for `/api/sessions?filter=active&countOnly=1` so unauthorized responses stop auto-polling instead of request-looping.
  - Replaced immediate recursive polling with timed polling (`ONLINE_COUNT_POLL_MS`) plus stale/retry handling (`ONLINE_COUNT_RETRY_MS`) to prevent console/API spam during auth loss.

2026-02-14 (latest)
- Settings -> Layout -> Charts now includes expanded per-chart style controls (curve, stroke width, dash, marker size, fill opacity, grid dash, labels mode, toolbar toggle, animations toggle) in addition to colors/mode and raw Apex JSON.
- New chart style config is persisted under `charts_ui_config_v1.charts[].style` and normalized server-side in `server/routes/settings.js`.
- Runtime now applies these style controls across key chart paths (`server/public/app.js`, `server/public/ads.js`) by merging style-derived Apex overrides with `advancedApexOverride`.
- `server/public/kexo-chart-builder.js` preview/runtime builder now understands `chartStyle`, so Settings previews reflect the same style controls.

2026-02-14 (latest)
- Fixed Settings -> Layout -> Charts preview blank-on-load regression:
  - `server/public/kexo-chart-builder.js` now actively loads ApexCharts on demand for Settings preview rendering (instead of only retrying for a global that might not be loaded on `/settings`).
  - `server/public/settings-page.js` now re-renders preview charts/sparklines when an accordion item is expanded (`shown.bs.collapse`), so hidden panels paint immediately when opened.

2026-02-14 (latest)
- Restored Settings -> Layout -> Charts to the accordion-based chart/KPI-bundle editor after a regression back to the old flat table UI.
- `server/public/settings-page.js` now renders one accordion item per chart/bundle, includes live chart/sparkline previews, validates advanced Apex JSON, and persists `advancedApexOverride` + `kpiBundles`.
- `server/routes/settings.js` normalization/defaults now include `charts_ui_config_v1.kpiBundles` and chart-level `advancedApexOverride` so settings are retained on save/reload.
- `server/public/settings.html` chart-tab styles were updated for the new accordion inputs/previews (hex fields + swatches + preview cards).

2026-02-14 (latest)
- Insights Variants: fixed "Last 7 days" showing less data than "Yesterday". The header date selector sends 7days/14days/30days but the API expected 7d/14d/30d; unnormalized values fell back to today. Added range normalization (7days→7d, etc.) in insightsVariants route.

2026-02-14 (latest)
- Map tooltip stuck fix: added mouseleave + scroll listeners on countries/live map containers to hide .jvm-tooltip when cursor leaves the map or page scrolls. Prevents tooltip staying visible when user moves away.

2026-02-14 (latest)
- Product Insights modal: restored collapse chevrons on Revenue and Demand chart cards (left column). These were removed during chart-card gear-icon cleanup; modal cards now excluded from chart-only treatment so they keep expand/collapse chevrons.

2026-02-14 (latest)
- Settings → Layout → Charts was rebuilt as a Tables-style accordion with one item per chart/KPI bundle and live demo-data previews for every item.
- Added settings-managed KPI bundle styling across runtime:
  - `dashboardCards`, `headerStrip`, `yearlySnapshot` each support palette (`up/down/same/compareLine`), sparkline controls (mode/curve/stroke/height/compare), and delta typography/icon controls.
  - Runtime now applies saved bundle styling to dashboard KPI cards, top-strip KPI chips, and Business Snapshot yearly KPI cards.
- Added advanced Apex override support in chart config with normalization/sanitization and runtime merge in chart rendering paths.
- Consistency cleanup: chart defaults/allowed modes aligned across defs + settings UI + server validators (notably `live-online-chart` default `map-flat`, `ads-overview-chart` includes `bar` and defaults `bar`).

2026-02-14 (latest)
- KPI palette override applied for dashboard + condensed/small KPIs:
  - growth/up = `#20a034`
  - no-change/flat = `#2080a0`
  - decline/down = `#a02020`
- Dashboard KPI delta `%` text is now bold.
- Dashboard KPI sparkline compare line now uses fixed color `#bbc3c3`.

2026-02-14 (latest)
- Business Snapshot modal (`/api/business-snapshot`, `server/public/app.js`, `server/public/custom.css`) yearly UX overhaul:
  - Modal is now year-selector free (yearly current-year vs previous-year compare only in UI).
  - Added isolated server cache for `GET /api/business-snapshot` via endpoint key `business-snapshot` in `report_cache` (+ force bypass); keying remains endpoint-scoped so other pages are unaffected.
  - Added modal-local client cache (stale-while-revalidate) so repeat opens render instantly from fresh cached payload.
  - Revenue/Cost headline values in Snapshot now use compact currency (e.g. `£168K`) while tooltip/breakdown keeps detailed values.
  - KPI cards now include per-card validation tooltips (current period vs previous period) with explicit "No data for this period" messaging when prior data is unavailable.
  - Customer KPIs now include previous-period values in API payload so deltas/tooltips are consistent across all cards.
  - LTV moved from Customers cards into a header-right decorative radial callout (small centered label, centered value, delta below).
  - Snapshot sections now reveal in staged sequence and charts render with animated draw/fill rather than static prefilled output.
  - Header background art refreshed to a very light multi-colour chart motif using KEXO palette tones.

2026-02-14 (latest)
- Dashboard KPI sparkline visibility fix: line-only sparklines keep `fill.opacity=1` (ApexCharts 4.x quirk) so current + compare lines do not render with transparent stroke.

2026-02-14 (latest)
- Dashboard KPI sparklines now render line-only (no area fill) and include a second compare line (previous-period baseline) as a dashed overlay.
- Dashboard sparkline growth tone reverted to the original KEXO mapping (`kpiDeltaToneColor('up')` / accent-2), replacing the temporary hardcoded green override.

2026-02-14 (latest)
- Main nav dropdown (Dashboard/Insights/Traffic/Integrations/Tools): Mobile is full-width fixed below the sticky nav using JS-calculated top (`--kexo-mobile-nav-dropdown-top`). Seam hidden (margin-top:-1px; no top border). Caret chevron hidden on mobile. Desktop+mobile: opening/active state uses the tab accent as background (`--kexo-accent`) for both the tab and dropdown menu; dropdown items are white with no “sticky” highlight; active underline (::after) removed; dropdown arrows/icons no longer use the lighter color-mix (inherit item color). Close on scroll (mobile).
2026-02-14 (latest)
- Dashboard overview KPI sparklines now render with sharper/angular peaks (`curve: straight`) instead of smooth curves.
- Dashboard KPI sparkline growth tone now uses `#0b913d` (accent-2 override for sparkline up-tone).

2026-02-14 (latest)
- Map getValue crash (Option B): removed series.regions entirely from jsVectorMap config. Region fills are now applied after init via `map.regions[code].element.setStyle('fill', color)`. Fixes "Cannot read properties of undefined (reading 'getValue')" on live map and countries map.

2026-02-14 (latest)
- Mobile main nav: labels (Dashboard, Insights, etc.) wrapped in span.kexo-nav-label and hidden via display:none on mobile (foolproof; no font-size:0 white spec). Main nav dropdowns constrained to viewport via constrainNavDropdownToViewport on shown.bs.dropdown + resize.
2026-02-14 (latest)
- KPI delta semantics are now unified across condensed header KPIs, dashboard KPI cards, and Business Snapshot KPI cards:
  - up/growth = `--kexo-accent-2` (teal)
  - same/flat = `--kexo-accent-1` (blue)
  - down/decline = `--kexo-accent-4` (fallback `#e4644b`)
- Business Snapshot deltas now color both icon and text using the same semantic mapping; snapshot KPI sparkline trend colors now match these semantics.
- Condensed KPI progress bars now use the same semantic mapping as KPI deltas/sparklines (up teal, flat blue, down red).
- Zero-baseline KPI delta labels in condensed/dashboard cards no longer show `new`; they now show signed percentages (e.g. `+100%` when previous is 0 and current is >0).

2026-02-14 (latest)
- Insights: added `/insights/abandoned-carts` page (abandoned revenue line chart + top countries + top country+product + abandoned sessions table) with a mode switch (Abandoned Carts / Abandoned Checkouts) under the page title (drives the whole page).
- Backend: added `/api/abandoned-carts/*` endpoints and a cleanup marker pass to set `is_abandoned/abandoned_at` reliably; fixed Postgres `upsertSession` to preserve abandonment markers.
- Settings/Diagnostics: new chart + table defaults added in `server/routes/settings.js`; definitions added in `server/trackerDefinitions.js`.
- Charts: fixed “dots but no line” by enforcing visible strokes for line charts (`stroke.show=true` and line `fill.opacity=1`).
- Abandoned Carts: chart line color differs by mode (carts vs checkouts) and the series is prefetched/cached so mode switching feels instant.

2026-02-14 (latest)
- Side panel: padding changed to `0 1.05rem 1.05rem` (no top padding).
- Page title icon: fixed icons not showing next to page title. Icons now use `data-icon-key` (NAV_TO_ICON_KEY) and `KexoIconTheme.applyElement()` so they get the same theme treatment as menu icons.

2026-02-14 (latest)
- Nav dropdown arrow: fa-solid fa-angle-right (was fa-arrow-turn-down-right). Added nav-dropdown-arrow to theme-settings icon picker and ICON_GLYPH_META.
- Top menu: arrow icon moved from top-level toggle to dropdown items (Countries, Products, etc.); Bootstrap caret restored on toggles. Page title now shows the current page icon (globe, folder, etc.) via NAV_TO_ICON mapping (desktop only).

2026-02-14 (latest)
- Settings → Assets now supports uploading branding images to Cloudflare R2 (server-side upload) and applying favicon/footer/login/header logo overrides at runtime.
- New endpoints: `GET /api/asset-overrides`, `POST /api/assets/upload`. New env vars: `R2_*` (see `.env.example`).

2026-02-14 (latest)
- Landing column (sessions tables): removed path→label mapping (Home, Collection, All, Cart, Viewed Order). Sticky cell now uses Shopify product title, collection title, or meta title fallback via `server/shopifyLandingMeta.js`. Non-product paths show path as-is (e.g. `/`, `/cart`). Sessions enriched with `landing_title` in `listSessions` and `listSessionsByRange`.

2026-02-14 (latest)
- Live View Latest sales: `/api/latest-sales` now resolves a truth top line item (`product_id` + `product_title`) and the table opens Product Insights by `product_id` when handle is missing (reduces phantom/unclickable rows and prevents wrong-handle clicks).
- Ingest: `checkout_started` / `checkout_completed` always write `purchase_events`, and `checkout_completed` always writes `purchases` (even when `order_id` / `checkout_token` are missing) for better observability + dedupe.
  - Regression guardrails:
    - Backend mapping lives in `server/store.js` `listLatestSales()` (truth top line item via `orders_shopify_line_items`, evidence link via `purchase_events`).
    - Frontend links live in `server/public/app.js` (Latest sales uses `data-product-id` so modals open without handles).
    - Test coverage: `test/latest-sales.test.js` (truth `product_id/title` must win over session handles).

2026-02-14 (latest)
- Map getValue crash: removed `attribute: 'fill'` from jsVectorMap series.regions config so the library treats values as direct colors (ISO→color) instead of expecting a scale with getValue. Fixes "Cannot read properties of undefined (reading 'getValue')" on live map and countries map.

2026-02-14 (latest)
- Map black regions + tooltip: replaced numeric scale/Proxy with deterministic ISO→color mapping so no region gets `fill="undefined"`; fixed `onRegionTooltipShow` callback to `(event, tooltip, code)` for jsVectorMap 1.6; use `tooltip.text(html, true)` for HTML content; removed `.jvm-tooltip { display: none }` so tooltips can show. Applies to countries map and live map.

2026-02-14 (latest)
- Dashboard-series ratios: daily `convRate`, `bounceRate`, and `aov` now return NULL when the denominator is 0 (avoid misleading 0.0% / 0 AOV on days with no sessions/orders).

2026-02-14 (latest)
- Testability: added `SQLITE_DB_PATH` (optional) to point SQLite at a custom file for local/dev/tests; added an integration-style test for `/api/dashboard-series` (sessions=0 => CR% null; handle attribution via first_path).

2026-02-14 (latest)
- Metrics helper: added `server/metrics.js` (shared percent/rate rounding) + basic unit tests (`npm test`). Dashboard CR% now uses the shared helper (no 100% clamp).

2026-02-14 (latest)
- Stats caching: `/api/stats` now normalizes `range` keys and uses that range’s bounds for `report_cache` keys/metadata (more stable caching for custom day/range keys).

2026-02-14 (latest)
- Layout → Tables: added **Insights · Variants** accordion (single entry "Variant tables") controlling all tables on /insights/variants. Rows-per-page (5/10) and sticky min/max apply to every user-defined variant table. app.js resolveVariantsTableId maps variants-table-* to insights-variants-tables when on variants page.
2026-02-14 (latest)
- Table UX: sticky resize handle icon replaced with chevron/drag SVG (same grey #626976); horizontal scrollbars hidden on all table-scroll-wrap/country-table-wrap/table-responsive (desktop + mobile).
2026-02-14 (latest)
- Dashboard overview CR% guardrails:
  - Server: `/api/dashboard-series` now returns `cr: null` when Sessions=0 (CR% is undefined; never coerce to `0.0%`).
  - Attribution: Top Products session counts now resolve product handles from `first_path` (`/products/<handle>`), `first_product_handle`, or `entry_url` (aligns with Products → Best Sellers logic).
  - UI: Top Products / Top Countries tables render CR% as `—` whenever Sessions=0, with an info tooltip when Orders>0.

2026-02-13 (latest)
- Footer: bar uses grid 1fr auto 1fr (not flex) so logo is truly centered; diagnostics badges below now align with logo.
- Page header: connector lines 2px solid, SVG chevron arrow at end (`/assets/icons/connector-arrow.svg`), theme grey (color-mix body-color 70% black), no bottom border; subtitle → title → date. Settings page has no page-header div.
- Footer: back-to-top before settings; formatRelative caps at days (fixes "491952h ago"); diagnostics strip with Kexo Pixel Online/Offline, Google Ads Connected/Offline; uses kexo-status-indicator--online/offline (matches header Online dot). NOTE: Future integrations (e.g. new ad platforms, webhooks) should appear in this footer diagnostics strip.
2026-02-13 (latest)
- Sticky table UX: shadow right-edge only (no top/left/bottom bleed); drag-scroll works in Chrome device emulation when scrollbar hidden (touch events run our handler); window resize debounced refresh for is-drag-scroll/kexo-sticky-scrolled; transform/backface-visibility on sticky cells to reduce scroll jitter.
2026-02-13 (latest)
- Footer restructure:
  - Mobile: refresh | logo | back to top only (no last sale, eye, sound). Last sale + eye desktop-only.
  - Desktop: last sale left, logo center, back to top + settings drop-up right. Refresh + sound moved into settings drop-up.
  - New class `.kexo-footer` for custom styling; `.kexo-footer-action` replaces btn-icon (no hover). footer-settings-toggle icon configurable in Theme Icons.
  - Date picker hidden on Settings page (no relocate, CSS hide).
2026-02-13 (latest)
- Chart bugs: Sales chart shows time bucket (By hour/day/month) below chart; overview sparklines use consistent bottom alignment; products chart shows thumbnails below instead of titles; map regions no longer black (Proxy default 0 for missing codes); traffic channels/device legend font reduced, plot min-width + rAF for layout; Google Ads chart default bar mode (profit by campaign, green/red).
2026-02-13 (latest)
- Product name and clickability: Trending Up/Down, Top Products, best-sellers, variants, breakdown, country-product tables now show real product names and clickable links even when Shopify meta fetch fails or handle is missing. Backend: shopifyProductMetaCache normalizes GID to numeric before REST API call; salesTruth extractNumericId handles Product/Variant GIDs; Product Insights API accepts product_id and resolves handle via GraphQL. Frontend: product links use data-product-id when handle missing; modal opens by product_id.
2026-02-13 (latest)
- Page header connector lines: fixed vanishing on resize/pageshow (hasOtherAuto excluded leftCol); lighter color; explicit mobile hide.
2026-02-13 (latest)
- Sticky column resize on mobile: Removed CSS override that locked min/max/width to 200px on small screens; fixed getBounds so byRemainingCols cap is skipped when table is scrollable, and mobile uses 80% softMax so resize handle works.
2026-02-13 (latest)
- Sticky column: When table is horizontally scrolled (swipe/scroll right), sticky cells get a stronger outer shadow to indicate they stay fixed; class kexo-sticky-scrolled toggled via scroll listener in app.js.
2026-02-13 (latest)
- Table last row: No border-bottom on last row cells (grid tables, table-responsive, tsm-table, product-insights) so the card/table outer border provides the bottom edge.
2026-02-13 (latest)
- Table row hover: Removed nth-child(2) hover overrides so the first TD after the sticky column matches the rest of the row (no darker adjacent cell).
2026-02-13 (latest)
- Table icons: Every Layout table now has a unique icon key in Settings → Theme → Icons (card-title-table-*). Resolved by data-table-id when present; editable per table.
- Railway: Do not run `railway up`; auto-deploys from git. Updated commit-and-memory rule, HANDOVER, README.
2026-02-13 (latest)
- Table UX:
  - Rows-per-page selector hidden on all tables (page size still from config).
  - Table layout icon (links to Settings → Layout) replaced with gear; configurable via Settings → Theme → Icons (table-builder-icon).
2026-02-13 (latest)
- Live View Latest sales:
  - Removed table header (noHeader on latest-sales-table).
  - Removed country name from first column (flag only).
  - Product modal: when session lacks last/first_product_handle, derive handle from order line items via product_id → Shopify product meta (more products now clickable).

2026-02-13 (latest)
- Table builder bug fixes:
  - Dashboard overview/sales: ellipsis on fixed cells (product-cell, country-cell, last-action-cell; table-responsive).
  - Trending Down: product titles fallback to "Product {id}" when DB/meta missing.
  - Variants: kexo:variant-cards-rendered event for builder icon; min-width: 0 on cards to reduce scrollbars.
  - Traffic channels: source-icons margin-inline-end for gap before label.
  - Traffic device: traffic-type-parent first-cell ellipsis.
  - Google Ads: ads-footer syncs sticky width when ads-root is resized; run sticky resize after ads render.

2026-02-13 (latest)
- Chart cards: replaced collapse chevrons with gear icon linking to Settings → Layout (matches table builder). Chart-only cards now show kexo-builder-icon-link; collapse toggle removed.

2026-02-13 (earlier)
- Chart builder:
  - Added `kexo-chart-defs.js` (KEXO_CHART_DEFS) and `kexo-chart-builder.js` (ensureApexCharts, waitForContainerDimensions, renderApexChart, renderSparkline).
  - Settings → Layout → Charts now uses chart defs from kexo-chart-defs.js.
  - Traffic charts (channels, type), Business Snapshot charts now wait for container dimensions before render (fixes "data with no visuals" in modals and on first paint).
  - Chart scripts loaded before app.js on dashboard/traffic/insights/tools pages.

2026-02-13 (earlier)
- Variants page: removed header buttons (Variant Settings, All Variant Stats).
- Products page: hidden-tables note moved full-width above footer, shown only when at least one type table is hidden; PRODUCT_COLS numeric alignment fixed (text-end); builder tables use table-list icon link to Layout settings instead of collapse chevron.

2026-02-13 (latest)
- All tables builder migration:
  - Migrated tools.js (compare CR), tools-shipping-cr.js, variants-page.js (diagnostics modals), settings-page.js (Ignore List, Merge rules), app.js (kvTable, Profit Rules, Product insights), ads.js (modal sales) to use builder.
  - Added KEXO_TOOLS_TABLE_DEFS, KEXO_VARIANTS_MODAL_TABLE_DEFS, KEXO_SETTINGS_MODAL_TABLE_DEFS, KEXO_APP_MODAL_TABLE_DEFS, KEXO_BREAKDOWN_TABLE_DEFS.
  - Builder + defs scripts added to tools/compare-conversion-rate.html and tools/shipping-cr.html.
  - Breakdown defs added for future use (no HTML exists yet).

2026-02-13 (latest)
- Tables:
  - Sticky first-column cells now use border-aware CSS ellipsis that expands/contracts during resize.
  - Table headers no longer switch to icon-only labels on mobile (headers stay text + ellipsis).
  - Rows-per-page control (`kexo-table-rows-control`) is hidden on mobile.
  - Sticky resize now binds for dynamically inserted tables (notably Insights → Variants) and mobile max-width is no longer artificially constrained by 2-up grids.
  - Live View “Latest sales” table is exempt from sticky-first-column and shows country code beside the flag.
- Charts:
  - Added Layout → Charts setting “Hide charts on mobile” (default ON) to hide all chart cards on small screens.
- Footer redesign:
  - Layout: far left = eye + last sale; center = refresh | logo (40px) | sound; far right = back to top.
  - Logo: `/assets/logos/new/logo_foot.png` in footer; header uses `kexo_new2.png`.
  - Removed settings and theme icons from footer.
  - All footer icons use fa-jelly-filled; no hover effects on footer icons.
  - New icon keys: footer-back-to-top, footer-sound-muted (mapped in Settings → Theme → Icons).
  - Back-to-top scrolls to top smoothly (with document fallback); sound mute syncs with header state.

2026-02-13 (latest)
- Header + snapshot/profit:
  - Added a new configurable top-strip money button (`data-icon-key="header-business-snapshot"`) next to the Settings button.
  - Added `GET /api/business-snapshot?mode=yearly&year=YYYY` for Business Snapshot cards (Financial / Performance / Customers) with previous-period deltas where available.
  - Added Profit Rules persistence key `profit_rules_v1` and dedicated endpoints:
    - `GET /api/settings/profit-rules`
    - `PUT /api/settings/profit-rules`
  - Business Snapshot now includes an in-modal Profit Rules editor (enable toggle, rule list, add/edit/delete, priority up/down, per-rule enabled toggle, ISO country targeting).
  - Estimated profit formulas are now centralized server-side using paid Shopify truth orders and country-aware rule applicability.
  - Snapshot UX polish: modal is now XL, year selector sits in the modal header, deltas show trend icons, and the header has subtle low-opacity background art (no Summary panel).
  - Profit setup callout has been removed; use the Snapshot footer Settings link to open Profit Rules.
  - Snapshot loading is now last-request-wins (avoids stale year data) and shows an in-modal Retry button on failures.
  - Snapshot metrics audit fixes:
    - Conversion Rate % + Sessions are now sourced from **ShopifyQL sessions** over a **SINCE/UNTIL** range (uses `TIMESERIES day` + quoted `WITH TIMEZONE`) (not KEXO sessions), so year views don’t show `Sessions=0` when KEXO tracking is newer.
    - Revenue/Orders/AOV in Snapshot now use **checkout_token** truth orders (online-store aligned) so you don’t get impossible cases like `Orders > Sessions`.
    - All Time customers treat “Returning Customers” as **Repeat Customers** (>=2 paid orders in the all-time range), so Repeat Purchase Rate is meaningful.
    - Guardrails: if ShopifyQL sessions are unavailable, Snapshot shows **Unavailable** (never `Sessions=0` with nonzero Orders). If ShopifyQL conversion_rate is missing/0 but sessions exist, Snapshot derives a best-effort conversion from checkout orders/sessions.
  - Snapshot report-mode upgrade:
    - Snapshot selector is now **Year-only** in the UI (monthly mode remains supported by the API, but the UI no longer shows mode switch links/labels).
    - Default open state is now **Yearly / current year** (e.g. 2026), not All Time.
    - Yearly comparisons are now **same elapsed window** vs previous year (Jan 1 -> same month/day in prior year), and monthly comparisons are the same month vs prior year (partial when current month).
    - API now accepts `GET /api/business-snapshot?mode=yearly&year=YYYY` or `?mode=monthly&month=YYYY-MM`.
    - Financial now renders a full-width (edge-to-edge) **Revenue & Cost** line chart (no area/bar fill) with a hover tooltip breakdown; Cost = **COGS** + enabled Profit Rule deductions + optional **Google Ads spend** (when enabled).
    - Remaining cards keep visible KPI sparklines (line-only; no fills).
    - KPI colors in Snapshot are limited to 3 accents: up=growth, down=loss, flat=stable (matches `--kexo-accent-*` scheme).
    - Performance: Snapshot caches expensive sub-queries (ShopifyQL sessions + COGS + country summaries + Ads spend) via `report_cache` and adds DB indexes to speed common filters.
    - Customers: “Returning Customers” is now customers who have **>=2 paid orders by the end of the selected window** (so early years like 2025 don’t incorrectly show 0 when repeats exist).
    - Fixed a Postgres reliability bug: returning customer query no longer uses a grouped outer reference (prevents `/api/business-snapshot` 500s).
  - Settings performance:
    - `/api/theme-defaults` and `/api/settings` now batch-read settings keys to avoid N+1 query warnings.
  - Sentry noise reduction:
    - Frontend ignores generic transient network errors (Load failed / Failed to fetch / aborted) and `sentry-helpers.js` skips capturing those for same-origin `GET /api/*` calls.
    - UI polish: deltas now render as a compact **icon + %** in the card top-right (no “vs previous period:” prefix) and the Snapshot header has subtle low-opacity bar-chart background art.
    - Profit Rules modal overlay is now extra-dark (~80%) when open so it visually separates from the Snapshot behind it.
  - Snapshot UI follow-up:
    - Removed the inline Profit Rules callout card; Snapshot settings moved to a **footer Settings link** (header gear removed).
    - Profit Rules modal now includes an **Integrations** tab with a toggle to include Google Ads spend in the Cost chart (`profit_rules_v1.integrations.includeGoogleAdsSpend`).
    - Snapshot modal title now uses the Shopify store’s display name (Shopify Admin API).
    - Added a real dark backdrop and removed “—” delta badges when comparisons aren’t available.
- Settings icon cleanup + style tweaks:
  - Disabled auto-injected inner card title icons on Settings page (`fontawesome-icons.js` skips `data-page="settings"`), so inner Settings cards/tables no longer get extra gear icons.
  - Added Theme Icons support for `header-business-snapshot` (including persistence via `theme_icon_glyph_header_business_snapshot`).
  - Updated Settings tab/diagnostics icon defaults from `fa-solid` to `fa-thin`.
  - Updated strip dropdown menu styling to include `padding: 0` and `font-size: 13px` on `.kexo-top-strip-settings-menu, .kexo-top-strip-online-menu`.

2026-02-13 (latest)
- Dashboard overview:
  - Added **CR%** column to Top Products, Top Countries, Trending Up, Trending Down.
  - Trending Up/Down rows are now single-line deltas (removed the “now vs prev” sub-lines).
- Live View:
  - Added desktop-only **Latest sales** table beside the map (last 5 sales).
  - New API: `GET /api/latest-sales?limit=5` (protected).
- Settings:
  - Diagnostics redesigned to a **Tabler accordion** (no tabs / no `dm-*` diagnostics markup).
  - Settings left-nav icons now match the corresponding panel card header icons (new locked icon key `settings-tab-layout`).
- Misc UX/stability:
  - Closing the sale toast no longer re-triggers the global page loader.
  - Source icon 404 fix: `google_ads` now uses the Google icon (no `/assets/adwords.png`).
  - `hotImg()` no longer appends duplicate `width=` params; `arrivedAgo()` now outputs compact strings (e.g. `9secs`, `1min`, `1hr`).

2026-02-13 (latest)
- KPI/header micro-alignment:
  - Dashboard KPI card sparkline wrapper is nudged down (`bottom: -5px`) with a small radius to better align the chart baseline with the card bottom.
  - Page header title now renders as block-level (`.page-header .page-title { display: block; }`) to avoid inline-flex centering quirks.

2026-02-13 (latest)
- KPI visibility flicker fix:
  - Disabled KPI items now hide at first paint (localStorage hydrate + server-injected CSS in `/theme-vars.css`), so hidden KPIs no longer flash briefly on refresh.

2026-02-13 (latest)
- Header/KPI visual polish:
  - Page header triple layout now uses segmented horizontal connector lines (`left/meta — title — date`) with 10px outer margins.
  - Triple-layout stability improved by checking only direct `.col-auto` children before disabling the layout (prevents unintended left-jump).
  - KPI strip bottom gap removed (no extra white band under the sticky KPI row).
  - Dashboard KPI sparkline profile tuned to read as stronger “peaks/mountains” (less y-padding, taller sparkline area, stronger fill/stroke).

2026-02-13 (latest)
- Settings UX + header KPI control:
  - Charts and KPIs settings moved into Settings → Layout as top tabs (Tables / Charts / KPIs); legacy `?tab=charts` and `?tab=kpis` URLs route into Layout.
  - KPI settings now include a per-page allowlist for the header KPI strip (so you can disable it on Settings/Dashboard without code changes).

2026-02-13 (latest)
- Page header layout + KPI sparklines:
  - Simple page headers now lay out as: **icon+subtitle left**, **page title centered**, **date control right**, with **2px dividers** between sections.
  - The header category icon is injected inside `.page-pretitle` (better vertical alignment).
  - Dashboard overview KPI sparklines now render as a single **filled area** line (no dashed compare series; solid fill).

2026-02-13 (latest)
- Sticky header + page title:
  - `assetVersion` now includes header/footer partial mtimes so deploy drift detection updates when shared chrome changes.

2026-02-13 (latest)
- Sticky header follow-up:
  - KPI strip is now inside `.kexo-header-stack` so the full header (strip + nav + KPIs) stays sticky while scrolling (prevents the header “stopping” at the start of `.page-body`).

2026-02-13 (latest)
- Tools page header alignment:
  - `/tools/shipping-cr` and `/tools/compare-conversion-rate` now center the page icon + pretitle + title + date control as one middle-aligned header group.
  - Page header category icon now uses inline-flex alignment (no float), improving subtitle baseline alignment.
  - Date control button now uses 40px height and larger left padding to match the requested layout.
  - Tools page title size is now `1rem`.
  - Follow-up: the divider is now a full-height straight line (stretch layout; zero gutters) so it visually reads as one centered unit.

2026-02-13 (latest)
- Theme default custom CSS:
  - Updated default `.kexo-product-link` style (blue, 13px, underlined, tighter underline offset).

2026-02-13 (latest)
- Header/table UX polish:
  - Avatar no longer moves on hover (removed margin-right).
  - Strip dropdowns (Online, Settings, Avatar): border-radius 4px, opacity 0.9.
  - Header KPI strip: swipeable overflow without scrollbar (overflow-x: auto, scrollbar hidden).
  - Sessions tables (live/sales/table): min-width 640px to prevent squashing; overflow-x swipeable with hidden scrollbar.
  - Page header category icon: padding 0, margin 2px 4px 0 0, font-size 12px.

2026-02-13 (latest)
- Tools + Sentry stability:
  - Added server shim route `GET /assets/cash-register.mp3` that redirects to Shopify CDN to eliminate residual audio 404s.
  - Shipping CR Sessions denominator now counts human sessions in the selected range where **checkout started OR purchase occurred**, with country match using `country_code` fallback to `cf_country`.
  - Fixed `dashCache is not defined` by sharing dashboard cache state across rows-per-page handlers.
  - Fixed `ensureApexCharts is not defined` in dashboard chart rendering by waiting on existing Apex loader helper.
  - Reduced Sentry frontend noise: fetch wrapper now skips capturing expected `AbortError` (and offline `Failed to fetch`) cases.
- Tools UI polish:
  - Shipping CR + Compare Conversion Rate buttons now use normal Tabler button size + `btn-list` grouping (removed tiny `btn-sm` usage).
  - Removed forced tools card radius override so tool containers follow default Tabler corner radius.

2026-02-13 (latest)
- Strip dropdowns (Online, Settings, Avatar): align left with main nav, white bg + black text/icons; removed Theme dropdown link/icon color settings; main-menu dropdown icons use lighter shade of accent (color-mix) instead of opacity.

2026-02-13 (latest)
- Header + theme UX:
  - Top strip: Online badge dropdown now links to **Live View** (same icon as main menu). Avatar dropdown removed; **Sign out** moved into the Settings dropdown.
  - Theme: added Custom CSS (saved in theme defaults, injected inline in head after stylesheets).
  - Main nav: dropdown item icons now inherit the parent accent color at 0.7 opacity.
  - Date picker: now relocates into the page header on mobile too (inline with the page title row).
  - Google Ads: sticky first-column width now syncs with the footer totals row.
- Chart + map observability hardening:
  - Added `kexoCaptureMessage()` in `server/public/sentry-helpers.js` and a chart-aware `console.error` Sentry bridge (with short dedupe) so frontend chart/map console failures are captured automatically.
  - Added explicit chart/map error/message capture hooks across `server/public/app.js`, `server/public/ads.js`, and `server/public/tools.js` for render failures and library-load failures.
- jsVectorMap stability follow-up:
  - Updated map region series values to numeric weights with explicit `scale` + `normalizeFunction: 'linear'` to prevent `setValues/getValue` runtime crashes on `/dashboard/live` and `/insights/countries`.

2026-02-13 (latest)
- Countries + Live jsVectorMap fixes:
  - Fixed map hover crash (`tooltip.html is not a function`) by adding a safe tooltip writer that supports jsVectorMap tooltip API variants (`html`, `text`, element fallback).
  - Replaced map numeric `scale/normalizeFunction` fill logic with deterministic ISO->color mapping to prevent `fill="undefined"` (which showed key regions as black).
  - Hardened `.jvm-tooltip` CSS (`display:none`, fixed positioning, non-interactive) so empty tooltip nodes do not appear in page flow/footer when inactive.
- Live chart mode behavior:
  - `live-online-chart` is now map-only (`map-animated` / `map-flat`) in Settings schema and Settings UI metadata.
  - Runtime mode sanitization in `app.js` now forces `/dashboard/live` to map mode when stale non-map config is cached.

2026-02-13 (latest)
- Traffic + Insights UX:
  - Traffic Channels/Device charts now default to a multi-line sessions trend over time (top 5 series) with a right-side label/value list.
  - Products page hides tables with 0 sessions and shows a footer note ("Tables without sessions are hidden").
  - Live View online chart now defaults to an animated world map of sessions seen in the last 5 minutes (can be switched back to bar/line/area in Settings → Charts).
  - Countries map default mode is now `map-flat` (Settings → Charts).
  - Countries map rendering now waits for the report loader to finish so the map doesn't initialize at 0x0 size (invisible/scale(0)).
  - Page headers now show the active top-menu category icon (Dashboard/Insights/Traffic/etc) next to the pretitle/title, using the same accent color as the active nav item.
  - Sessions tables (Live/Table/Sales): clicking a product link opens the Product Insights modal only; clicking the row opens the side panel.
  - Page layout: restored `page-body` flex growth so content always starts at the top (no vertical centering on short pages).

2026-02-13 (latest)
- Header/nav mobile follow-up:
  - Fixed inline nav left-edge clipping by zeroing nav row gutters/paddings and resetting mobile nav horizontal start position on page show.
  - Restored inline mobile dropdown usability by toggling nav-left overflow state while dropdowns are open (`.kexo-desktop-nav-left.is-dropdown-open`), preventing clipped menus.
- Date picker visibility:
  - `mountDesktopDatePickerIntoPageHeader()` now relocates the date picker into the page header on all viewports when a `.page-header` exists; otherwise it falls back to the nav slot.
  - Resize/orientation/pageshow listeners keep placement correct when viewport changes.
- KPI visibility:
  - Re-enabled Settings-driven dashboard KPI card hiding (`item.enabled === false`) in `applyDashboardKpiUiConfig`.
- Sticky header follow-up:
  - Updated `.page > .page-wrapper` flex sizing (`flex: 1 0 auto`) and kept `.page-body` overflow visible to avoid sticky header constraints ending near page-body start.

2026-02-13 (latest)
- Header/nav + mobile parity:
  - Stripped remaining Tabler mobile-menu JS branches from `server/public/app.js` (legacy `mobile-date-*` / `mobile-tabs-*` paths) so desktop and mobile use the same shared nav/date behavior.
  - Added hard overrides in `server/public/custom.css` to keep top nav inline/horizontal on mobile (no Tabler stacked navbar fallback).
- Sessions/sticky table UX:
  - Added a shared sticky-wrap marker class (`kexo-sticky-wrap`) during sticky initialization on all devices.
  - Sticky first-column width persistence is now split by viewport bucket (mobile/desktop) and constrained by remaining column count, preventing oversized first columns that caused very tall session rows ("10 secs ago" wrapping vertically).
  - Session age/history cells on Live/Sales/Table are now forced single-line in `custom.css`.
- `/dashboard/live` cleanup:
  - Removed the "Next update" markup from `server/public/dashboard/live.html` and `server/public/dashboard/sales.html` (polling still runs; UI no longer shows the timer/CTA).
- Sticky header behavior:
  - Explicitly set `.page` / `.page-wrapper` overflow to visible in `custom.css` to keep the sticky header stack tracking consistently while scrolling through page body content.

2026-02-13 (latest)
- Dashboard/header regressions fixed:
  - Disabled condensed KPI chips are now hidden pre-paint via `/theme-vars.css` (no refresh flash), while dashboard KPI cards no longer hide when KPI visibility toggles are off (order/labels still apply).
  - Dashboard now shows the condensed KPI strip again (settings page remains hidden).
  - Desktop nav date slot is hidden before relocation into page header (removes transient duplicate date box on refresh).
- Tools + tables:
  - `/tools/shipping-cr` now loads ApexCharts so condensed KPI sparklines render consistently on that page.
  - Dashboard overview API now returns up to 10 rows for Top Products, Top Countries, and Trending tables so 5/10 row selectors materially change visible rows.
- Countries map + sale sound reliability:
  - Countries map now shows explicit loading/disabled/no-data/error states; server-side chart-hide CSS no longer fully hides the countries map card when disabled.
  - Sale sound now prefers the Shopify CDN MP3 unless a custom assets base URL is configured, avoiding default `/assets/cash-register.mp3` 404s.

2026-02-13 (latest)
- Settings → Insights → Variants:
  - Table aliases are now a chip/tag input (Enter/comma/paste to add; click × to remove) to make merging Shopify option-name synonyms much easier.
  - Added per-table icon class (FontAwesome) editable next to “Add row mapping”; used on Insights → Variants table cards (default `fa-solid fa-grid-round`).
  - Footer layout: **Save** is now the only right-side button and is green; other actions (Suggest/Warn/Ignored/Reset) live on the left.

2026-02-12 (latest)
- Settings → Layout accordion: chevron moved to left, single chevron (rotates 180° when expanded), accordion-button font-size 16px, chevron fa-regular 14px #444.

2026-02-12 (latest)
- Refresh behavior:
  - Removed background polling/auto-refresh across the site (manual refresh only via browser reload or the in-theme Refresh buttons).
  - `/dashboard/live` + `/dashboard/sales` now poll for updates every 10s with smooth, non-janky row insertion/updates.
  - While paging/sorting, updates are queued and an **Updates available** button appears in the header actions.
  - Sale banner + footer “Last sale” continue updating globally via SSE (`/api/stream`).
- Settings -> Layout -> Tables UX refactor:
  - Replaced table-crammed layout editor with Tabler accordion sections (one accordion item per page, one control row per setting group).
  - Added per-table card controls with clearer fields for name, rows options/default, sticky bounds, grid toggle, and reorder actions.
- Added shared **Colors** controls in Settings -> Layout -> Tables for:
  - Dashboard · Live View
  - Dashboard · Table View
  - Dashboard · Recent Sales
  - Each row now has a far-right Colors button opening one shared modal that edits/saves the same values.
- Extended `tables_ui_config_v1` with shared converted-row color fields:
  - `iconColor`, `iconBackground`, `stickyBackground`
  - Normalized in `server/routes/settings.js` and persisted via existing `/api/settings` tables config path.
- Runtime application + CSS updates:
  - `server/public/app.js` now applies the shared colors to CSS vars (`--kexo-converted-icon-color`, `--kexo-converted-icon-bg`, `--kexo-sticky-cell-bg`) from `tablesUiConfig`.
  - Updated converted-row styling in `server/public/custom.css` (+ parity updates in `server/public/app.css`) for the sale icon column + sticky background variable support.
  - Fixed darker adjacent hover tint on converted rows by overriding second-cell hover styling for converted rows.

2026-02-12 (latest)
- Tools: added `/tools/shipping-cr` (Shipping CR) to report shipping option share-of-orders by country + date range.
  - Groups by Shopify `shipping_lines[].title` and charged shipping price (so “Standard Tracked Delivery” can appear as both Free and Paid).
  - Uses a dedicated fact table `orders_shopify_shipping_options` populated during Shopify truth reconcile (fast queries; avoids parsing orders JSON at request-time).
  - Date filter uses `orders_shopify.processed_at` when present (fallback to `created_at` when NULL). Added index on `(shop, processed_at)` for paid orders.
  - UI polish: country input shows an inline flag after ISO2 is recognized; results include a Sessions column (checkout-started sessions for that country+range; constant per row).
  - Flatpickr: tool date pickers are styled to match Tabler and hide adjacent-month days to avoid confusing month grids.
  - Shipping price detail: table stores and displays both **Paid shipping** and **Set shipping** (presentment currency) via extra columns on `orders_shopify_shipping_options` (migration 042).
- Migrations: startup/manual migration runners now include migration 039 (sessions index) and 040 (orders processed_at index).
- Restored session details drawer behavior on `/dashboard/live`, `/dashboard/sales`, and `/dashboard/table` by adding active `.side-panel` styling in `server/public/custom.css` (these pages do not load `app.css`).
- Refined the drawer with Tabler-aligned spacing, borders, section cards, and improved long URL wrapping so activity/source/network details remain readable.
- Added drawer backdrop + ESC close behavior in `server/public/app.js`, and stronger clickable-row hover affordance for session tables.

2026-02-12 (latest)
- Converted sale row styling/icons:
  - Live/session converted rows now show a configurable sale icon in its own dedicated leading sessions-table column (`data-icon-key="table-icon-converted-sale"`) via `server/public/app.js`.
  - Added new icon key default to both icon registries (`server/public/fontawesome-icons.js`, `server/public/theme-settings.js`) so it is editable in Settings → Theme → Icons.
  - Converted-row visuals now rely on the dedicated icon column + converted row tint, not a per-row “converted background” setting.

2026-02-12 (latest)
- Header/footer polish:
  - Added shared sticky wrapper in `server/public/partials/header.html` (`.kexo-header-stack`) around strip + nav; sticky behavior is applied to wrapper in `server/public/custom.css` to avoid split/staggered sticky glitches.
  - Removed desktop-only footer hiding rules in `server/public/custom.css`; desktop now shows the same footer structure as mobile.

2026-02-12 (latest)
- Mobile UX overhaul:
  - Removed UA-based mobile redirect gate in `server/index.js`; `/mobile-unsupported` now redirects to `/dashboard/overview`.
  - Removed mobile-only hamburger/overlay header markup from `server/public/partials/header.html`; shared desktop strip/nav now render on mobile.
  - Added touch horizontal scrolling behavior for top nav and condensed KPI strip in `server/public/custom.css` + `server/public/app.js`.
  - Tightened mobile table responsiveness across shared/page-specific styles (`custom.css`, `app.css`, `settings.html`, `settings-page.js`, `ads.js`, products/variants inline styles) to prevent viewport overflow and keep scroll within table wrappers.

2026-02-12 (latest)
- Sentry debugging: added browser SDK (CDN) + `sentry-helpers.js` (breadcrumbs, kexoCaptureError, fetch wrapper). All pages set `kexoSetContext(page)`; app.js, ads.js, settings-page.js, theme-settings.js, tools.js, variants-page.js instrumented. Backend routes: stats, kpis, sessions, insightsVariants, ads, dashboardSeries, tools get Sentry breadcrumbs + captureException in catch blocks. `GET /api/version` returns `sentryDsn` when SENTRY_DSN is set. `sendPage()` supports `{{SENTRY_DSN}}` template for sentry-init partial.

2026-02-12 (latest)
- Sale notification rework: replaced top-right toast modal with **tblr-banner** overlay on the desktop top strip. Banner shows flag – product – sale value, center-aligned, with close button far right; auto-closes after 10s; MP3 cha-ching preserved. Markup moved to `header.html` so it appears on all pages (fixes no-show on settings/variants/compare-conversion-rate). Removed old toast from 10 page templates; removed `sale-toast-time` icon key.

2026-02-12 (latest)
- Tools → Compare Conversion Rate: integrated with Settings → Insights → Variants mappings via a **Drill into variant labels** mode.
  - Loads available mapping tables and per-product label groups (Output labels) from the Variants config.
  - Compare requests can now return before/after CR breakdown by **label group** (not just raw Shopify variants), using the same title-matching logic as Insights → Variants.
  - If no mappings exist, the tool prompts the user to configure/suggest mappings first.

2026-02-12 (latest)
- Variants mappings now start **blank/custom-first** (no shipped default mapping tables/rules). Seed tables using Suggestions or build manually.
- Settings → Insights → Variants: added **Suggest mappings** (Shopify selectedOptions + recent observed activity) with one-click seed into editable custom tables.
- Applying suggestions now **merges by Output label** when possible (prevents duplicates like Gold/Vermeil being added twice; new aliases are folded into the existing row).
- Variants mapping tables now support **table aliases** (e.g. “Size, Chain Length, Bracelet Length”) used for scope inference and for suggestion seeding to merge multiple Shopify option labels into one table.
- New API endpoints:
  - `GET /api/insights-variants-suggestions` (build suggestions)
  - `POST /api/insights-variants-suggestions/apply` (apply selected seed tables into config)
- Suggest mappings now defaults to a **fast** build (skips truth reconcile); the modal includes a loader with elapsed time plus a **Refresh from Shopify** button for the slower/accurate refresh.
- Variants settings save is no longer blocked by unmapped coverage; it saves and returns **coverage warnings** to guide mapping/ignore.
- Coverage warnings no longer spam inline at the top of Settings → Variants; they are accessible via a **Warnings** button + modal.
- Settings → Variants: **Reset Variants** button (only shows when tables exist) wipes all mapping tables/rules/ignores (config only; no DB changes).
- Settings → Variants: added per-row **Merge** action to merge include aliases into another label and remove the source row (helps clean up seeded duplicates).
- Fixed settings editor escaping so Output labels can safely include quotes/ranges (e.g. `7.5" - 9" inches`).
- Insights → Variants: All Variant Stats now shows **Mapped+Ignored %** and a per-table **Top Unmapped (by sessions)** section.

2026-02-12 (latest)
- Added Settings → Layout → Tables: editable per-page table name/order/grid + rows-per-page options/default + optional sticky column min/max.
- New settings key: `tables_ui_config_v1` (cached client-side in localStorage as `kexo:tables-ui-config:v1`).
- Runtime apply in `server/public/app.js`:
  - table row selectors use config overrides for options/defaults
  - sticky column resize bounds can be overridden per table
  - table order/grid/title are applied via DOM transforms (titles are opt-in via `data-kexo-table-title="1"`)
- Variants validation/mapping is now scope-aware by table intent: length/style/finish tables skip out-of-scope titles before unmapped checks, reducing false save blockers on mixed catalogs.
- Variants diagnostics now include `outOfScope` totals/examples; All Variant Stats modal shows Total vs In Scope sessions, Out Of Scope sessions, and computes Mapped % from in-scope sessions.
- Settings -> Insights -> Variants messaging now clarifies that save blocking applies to unmapped in-scope titles and that out-of-scope titles are skipped.

2026-02-12 (latest)
- Variants mapping now auto-resolves overlap by specificity/order (most specific include wins; ties use rule order), reducing reliance on manual exclude maintenance.
- Variants settings save-blocking now targets unmapped titles; overlap-resolved cases are reported as diagnostics context rather than a hard-block category.
- Settings -> Insights -> Variants editor copy now explains auto-managed overlap and no longer presents `Exclude aliases` as required manual mapping input.
- Insights -> Variants now has header actions for **Variant Settings** and **All Variant Stats**, plus a new All Variant Stats modal with table-level totals and mapped-coverage-by-sessions diagnostics.
- Variants diagnostics payload now includes overlap-resolved totals/examples and session-attribution coverage (`?variant=` coverage against product-entry sessions) to highlight default-option attribution gaps.

2026-02-12 (latest)
- Footer eye (last-sale toggle): banner now shows immediately with cached/placeholder content, then refreshes when fetch completes; manual trigger now plays sale sound; MP3 loads from /assets/cash-register.mp3 with CDN fallback.
- Countries -> Country + Product no longer hard-caps to top 3 products per country in backend output; table row selector can now surface larger datasets (bounded by a global safety cap).
- Google Ads page refresh path now runs backend sync (`POST /api/ads/refresh`) on force refresh, with a guarded yesterday auto-sync when summary first returns empty.
- Google Ads GCLID backfill now queries ClickView **per-day** (required by the Google Ads API) to avoid refresh failures/misleading “endpoint not found” errors; Ads error modal diagnostics JSON is readable even in dark theme.
- Charts UI config apply now triggers active-view re-render in `app.js`, fixing stale chart mode/color/enable states (including Countries map) after settings changes.
- Row-per-page controls now rebind after icon/theme refresh events (`kexo:icon-theme-changed`) to prevent disappearing selectors.
- Settings -> Diagnostics now includes clearer Refresh vs Reconcile semantics, reconcile action feedback, enriched diagnostics payload metadata, and a Download JSON handoff action for AI/agent workflows.
- Tracker Definitions updated (v16) with explicit Settings -> Charts and Settings -> Diagnostics coverage; `/api/config-status` now returns diagnostics schema + chart/date-range settings summaries.

2026-02-12 (earlier)
- Product names across dashboard + insights tables are now clickable links that open the large Product Insights modal; removed product image thumbnails from those tables (modal is now the primary way to view product imagery).
- Product Insights modal now defaults to the **global** date range, shows KPI-style Clicks / Conversions / Conversion Rate, and includes a Top Countries section (when available) plus footer buttons for the storefront page + Shopify admin product page.
- Sessions tables (`/dashboard/live`, `/dashboard/sales`, `/dashboard/table`) now show a single product link in the Landing column that opens Product Insights (no entry/exit dual view, and no landing/product thumbnails in the table).
- Product Insights UI polish: full-width main image + horizontal thumbnail strip with arrows; main image auto-balances height vs right-side content; Revenue + Demand charts moved to the left and collapsed by default (expand via standard card chevron).
- Product Insights modal now follows Settings -> Insights Suggest Mapping modal behavior/styles more closely (Tabler modal/backdrop flow, padded header, grey footer, standard secondary/primary footer buttons), removes duplicate title/type text under the image, and removes the subtitle under the modal title.
- Product Insights right panel renamed to **Product details** and now renders as a proper Tabler-style table with metric/value headers and progress-style rows.
- `/api/product-insights` now returns `details` with cached lifetime product fields: `totalSalesLifetime`, `totalRevenueLifetimeGbp`, `costOfGoodsLifetimeGbp`, plus stock details (`inventoryUnits`, `inStockVariants`) from Shopify product metadata.
- API updates:
  - `/api/product-insights`: supports `14d` + `30d`, returns `topCountries` and `links.adminProductUrl`.
  - `/api/dashboard-series`: includes `handle` in `topProducts` and trending items so the frontend can open Product Insights from Dashboard tables.
- Insights -> Variants mapping-issues badge now uses dark style, cleaner header spacing, and per-item **Ignore** actions in the modal.
- Added persistent table-scoped ignored variant titles in `insights_variants_config_v1` (`table.ignored`), with save-time validation and runtime diagnostics excluding ignored titles from unmapped/ambiguous counts.
- Settings -> Insights -> Variants now includes an **Ignore List** button + modal to review/remove ignored titles and save.
- Row-per-page selector rebind now runs after report-build finish (`kexo:table-rows-changed`) and after Variants rerenders; Variants "Configure variants" buttons enforce white text.

2026-02-12
- Dropdown border removed; Settings moved from strip to nav; Settings dropdown aligns left with menu, opens below nav (not strip).
- Settings dropdown inherits menu: same background, opacity filter, border, link/icon colors. Removed theme_header_settings_menu_* keys.
- Menu hover tint: theme_menu_hover_opacity (0–100%) + theme_menu_hover_color (black/white) control hover overlay on nav links and dropdown items.

2026-02-12 (earlier)
- Theme refactor: 3 accents → 5 editable hex inputs (accent 1–5); 8 former settings (strip/settings/menu/dropdown colors) derived from accent 1; added Strip/Menu opacity filters, strip padding, strip border-bottom toggle; removed icons from Header & Color section.
- Charts tab: fixed layout, map type input width, color swatches, pie metric dropdown (mobile-friendly).
- Sources tab: Tabler-style restyle with tiny images in grid.
- Fixed underline on hover for active settings menu items.

2026-02-12 (earlier)
- Handover audit pass: updated to current UI + routes + Settings capabilities.
- Icons are customizable via `data-icon-key` + Font Awesome runtime adapter (`server/public/fontawesome-icons.js`).
- Added global Charts settings (`charts_ui_config_v1`) + server-injected hide CSS via `/theme-vars.css`.
- Refactored Theme settings: moved all desktop header/nav/dropdown/settings/online color controls from Header tab into Color tab; Header tab now keeps non-color controls.
- Locked Theme primary palette to KEXO brand 5-color accents in both settings UI and `head-theme` early hydration.
- Fixed Settings → Charts initial render timing so chart mode/pie selectors render with correct defaults/selections when tab is opened.
- Added Insights → Variants page (`/insights/variants`) and API (`/api/insights-variants`) with configurable mapping tables, variant-specific sessions denominator (`?variant=<id>`), sortable/paginated tables (default 5 rows, options 5/10), and strict save validation in Settings → Insights → Variants that blocks unmapped/ambiguous configs with detailed diagnostics.
- Fixed Countries → Country + Product denominator in `getBestGeoProducts()` so Sessions/CR% use country+product-handle sessions (product landing sessions in that country), not all sessions for the country.
- Fixed Variants page first-load UX: disabled generic app loader path for `data-page="variants"` and added a script-level fail-safe that hides stale loader overlays; empty state now includes a **Configure variants** button linking to `Settings → Insights`.
- Updated default Styles mappings to: Style 1, Style 2, Style 3, Satellite, Belcher, Anchor (removed prior chain defaults like cable/curb/figaro/rope/etc).
- Fixed Settings → Insights → Variants save reliability by syncing all editor field values from DOM at save time (prevents stale draft data from being re-saved when users edit and immediately click Save).
- Variants mapping-issue badge is now clickable and opens a modal with unmapped/ambiguous variant examples plus mapped coverage summary (sessions/orders/revenue) to help diagnose unusually high CR%.
- Added dedicated icon keys for Insights → Variants table headers (`table-icon-variants-*`) so each column icon is individually configurable in Settings → Theme → Icons.
- Sticky table cells, header row, and footer row (e.g. ads-totals-row) now use unified surface-secondary background with color-mix gradient; removed conflicting background overrides from custom.css, app.css, ads.js.
- Migration 049: add sessions.utm_term (fixes NODE-1R traffic-sources-v2 diagnostics). trafficSourcesV2 fallback when column missing.
