KEXO Liveview — HANDOVER (keep current)
Last updated: 2026-02-12 (insights variants page + strict mapping settings + country+product session denominator fix)

This repo ships a private Shopify app with a near-real-time Live Visitors dashboard. The frontend is Tabler-based and split into multiple HTML pages (folder-style routes) with shared partials and a shared JS bundle.

IMPORTANT (for future agents)
- Read this file before making changes (Cursor rules enforce this).
- Keep this file accurate. If you change core paths (routes/auth/dashboard UX/deploy), update this file in the SAME commit.
- This repo avoids new markdown docs; this handover is intentionally `HANDOVER.txt`.
- UI convention: cap font-weight at 500 (avoid heavier weights) for new dashboard UI.
- Diagnostics guardrail: when adding/moving/removing dashboard sections, update `server/trackerDefinitions.js` so Diagnostics → Definitions stays accurate.

---

## What KEXO looks like today (UX)

Desktop chrome (shared header across pages via `server/public/partials/header.html`):
- Top strip: live visitor count (left), centered logo, Settings dropdown (right).
- Main nav row below: grouped dropdown menus (Dashboard, Insights, Traffic, Integrations, Tools) + date range selector on the right.
- KPI strip: condensed KPI chips shown on most pages; hidden on `/dashboard/overview` and `/settings`.

Mobile:
- Mobile topbar (hamburger + centered logo + date dropdown) + full-screen nav overlay (`#kexo-mobile-nav`).
- Mobile UA GET requests for dashboard/settings/tools/etc are redirected to `/mobile-unsupported` (see `server/index.js`).

KEXO “3-color” accents:
- The desktop nav uses a rotating 3-color accent for the active underline and related styling via `.kexo-3color`:
  - Accent 1: `#4b94e4` (blue)
  - Accent 2: `#3eb3ab` (teal)
  - Accent 3: `#f59e34` (orange)
  - See: `server/public/custom.css` (`.kexo-3color`, `--kexo-accent-*`)

---

## Canonical pages + routes (folder URLs)

Rendered templates live under `server/public/**` and are served by `server/index.js` via `sendPage()` (includes + cache-control + asset versioning).

Dashboard:
- `/dashboard/overview` → `server/public/dashboard/overview.html` (`data-page="dashboard"`)
- `/dashboard/live` → `server/public/dashboard/live.html`
- `/dashboard/sales` → `server/public/dashboard/sales.html`
- `/dashboard/table` → `server/public/dashboard/table.html`

Insights:
- `/insights/countries` → `server/public/insights/countries.html`
- `/insights/products` → `server/public/insights/products.html`
- `/insights/variants` → `server/public/insights/variants.html`

Traffic:
- `/traffic/channels` → `server/public/traffic/channels.html`
- `/traffic/device` → `server/public/traffic/device.html`

Integrations:
- `/integrations/google-ads` → `server/public/integrations/google-ads.html`

Tools:
- `/tools/compare-conversion-rate` → `server/public/tools/compare-conversion-rate.html`

Settings:
- `/settings` → `server/public/settings.html`

Legacy redirects (kept, query preserved):
- `/tools/ads` and `/ads` → `/integrations/google-ads`
- `/date` → `/dashboard/table`
- `/overview`, `/live`, `/sales`, `/countries`, `/products`, `/variants`, `/channels`, `/type`, `/compare-conversion-rate` → canonical folder routes

Root `/`:
- Shopify embedded app URL. `auth.handleAppUrl()` decides:
  - render embedded dashboard overview, or
  - redirect to `/dashboard/overview` when logged in, else `/app/login`

---

## Settings (GLOBAL) — what’s configurable today

Settings scope is intentionally GLOBAL/shared (user-specific settings are disabled for now).

Settings UI:
- `server/public/settings.html`: Settings page layout + tab shells
- `server/public/settings-page.js`: tab switching, saving, and Settings panel wiring

Settings tabs:
- General: current config display + Settings scope (locked global)
- Theme: theme editor (colors/fonts/icons/header)
- Assets: override logo/image URLs
- Data & Reporting: reporting source toggles (orders/sessions) + pixel session mode
- Integrations: Pixel + Google Ads status/actions
- Sources: UTM/source mapping
- KPIs & Date Ranges: KPI order/labels/visibility + date-range labels/availability
- Insights: tab shell for Products/Countries plus active Variants mapping manager (custom table/rule editor)
- Charts: per-chart enable/type/colors (see Charts section)
- Diagnostics: config-status + reconcile utilities (Settings-first)

Settings API:
- `GET/POST /api/settings` in `server/routes/settings.js`
- Returned payload includes (among other fields): `reporting`, `kpiUiConfig`, `chartsUiConfig`, `insightsVariantsConfig`

---

## Theme + Icons (GLOBAL)

Theme persistence:
- `GET/POST /api/theme-defaults` (POST uses patch semantics: only provided keys update).
- First-paint CSS variables are injected via `GET /theme-vars.css` and loaded in head (see `server/public/partials/head-theme.html`) to prevent header flash (and to hide disabled charts before paint).

Theme UI:
- `server/public/theme-settings.js` renders the Theme panel inside Settings.
- Header subtab now contains non-color header controls only (visibility toggles, border on/off toggles, radius fields, logo override).
- Color subtab now owns all desktop strip/nav/dropdown/settings/online-badge color fields.
- Primary color choices are restricted to KEXO 3 accents only:
  - Accent 1: `#4b94e4` (blue)
  - Accent 2: `#3eb3ab` (teal)
  - Accent 3: `#f59e34` (orange)
- Early hydration in `server/public/partials/head-theme.html` applies only those 3 primary options before paint.

Header + nav theming:
- Desktop top strip + main nav are styled via CSS vars in `server/public/custom.css`, overridden by `/theme-vars.css`.
- Examples:
  - `--kexo-header-top-bg`, `--kexo-header-top-text-color`
  - `--kexo-top-menu-bg` / `--kexo-header-main-bg`
  - `--kexo-top-menu-border-color`, `--kexo-top-menu-shadow`
  - Settings dropdown + Online badge have dedicated vars (bg/text/border/radius/menu colors)

Icons:
- Font Awesome kit is loaded globally in `partials/head-theme.html`.
- Runtime adapter: `server/public/fontawesome-icons.js`
  - Converts Tabler icon placeholders / inline nav SVGs to Font Awesome.
  - Icons are keyed via `data-icon-key="..."` across the app.
  - Settings-only icon keys (`settings-tab-*`, `settings-diagnostics-*`) are locked for stability.

---

## Charts (GLOBAL)

Charts are centrally configurable in Settings → Charts:
- DB key: `charts_ui_config_v1`
- Served by: `GET /api/settings` as `chartsUiConfig`
- Saved by: `POST /api/settings` (`chartsUiConfig` payload)
- Settings-side charts table rendering is lazy-on-tab-open (render when Charts tab is active) to avoid hidden-panel select/input rendering glitches.

Runtime apply:
- `server/public/app.js`: dashboard/insights/traffic charts + map behavior
- `server/public/ads.js`: Google Ads overview chart

Chart hiding (no flicker):
- Chart wrappers/cards in HTML carry `data-kexo-chart-key="<chartKey>"`.
- `GET /theme-vars.css` injects `display:none!important` for disabled charts so they disappear before first paint.
- Dashboard paired charts expand to full width when their partner is disabled (CSS injected server-side).

Libraries:
- ApexCharts for most charts
- jsVectorMap for the Countries map (supports `map-animated` vs `map-flat` and a configurable accent color)
- Chart.js is used only inside the Google Ads campaign modal (lazy-loaded)

---

## KPI system (GLOBAL)

KPI/date-range UI config:
- DB key: `kpi_ui_config_v1` (in `GET /api/settings` as `kpiUiConfig`)
- Applied by: `server/public/app.js` to:
  - condensed KPI strip order/labels/visibility + display options
  - dashboard KPI card order/labels/visibility
  - date range menu labels/availability

KPI data:
- `GET /api/kpis` (server cached; also localStorage warm-paint to avoid empty chips on navigation)
- `GET /api/kpis-expanded-extra` for Shopify-derived extras (COGS, returns, items ordered, etc.)

---

## Key frontend files (high-signal)

- `server/public/partials/head-theme.html`: early theme hydration + loads `/theme-vars.css` + Font Awesome + `fontawesome-icons.js`
- `server/public/partials/header.html`: desktop strip + desktop nav + KPI strip + mobile nav
- `server/public/app.js`: shared bootstrapping + report loader + charts/tables + Settings hydration
- `server/public/custom.css`: KEXO UI styling + header/nav theme vars + layout + KEXO 3-color logic
- `server/public/tabler-theme.css`: Tabler overrides
- `server/public/settings-page.js`: Settings tab logic + saving to `/api/settings`
- `server/public/theme-settings.js`: Theme UI
- `server/public/variants-page.js`: Insights → Variants rendering/paging/sorting (driven by `/api/insights-variants`)
- `server/public/ads.js`: Google Ads page logic
- `server/public/tools.js`: Conversion Rate Compare tool logic

---

## Backend architecture highlights

- `server/index.js`: Express app, canonical page routes, auth middleware, static assets, startup migrations
- `server/middleware/dashboardAuth.js`: Shopify embed + direct OAuth cookie protection
- `server/store.js`: DB access + reporting queries + dedupe guardrails
- `server/variantInsightsConfig.js`: canonical Variants table/rule defaults + matching/validation helpers
- `server/variantInsightsService.js`: Variants data aggregation (truth orders + variant sessions) and validation sampling
- `server/migrations/*.js`: schema/index migrations run on startup
- Ingest: `POST /api/ingest` (strict JSON limit), writes events/sessions/purchases (append-only; no deletes)

Ops/reliability:
- Static assets are versioned into HTML (query param `?v=`) to avoid Shopify embed caching mismatches.
- `GET /api/version` returns `assetVersion` so clients can self-recover after long-idle tabs.
- `.md`/`/docs` paths are blocked in production (see `server/index.js`).

---

## Deployment notes

- GitHub Actions are manual (`workflow_dispatch`).
- Railway hosts production; deploys may auto-run from GitHub depending on Railway config.
- `npm start` runs `scripts/prune-runtime-files.js` (removes non-runtime files from the runtime image).
- SQLite is ephemeral on Railway; production should use Postgres via `DB_URL`.

---

## Guardrails

- Never delete/truncate core data tables (`purchases`, `purchase_events`, `orders_shopify`, `sessions`) to “fix numbers”.
- Handle over-reporting via dedupe in stats queries (see `server/store.js` helpers).
- When changing dashboard sections/definitions, update `server/trackerDefinitions.js`.

---

## Changelog (high-signal)

2026-02-12
- Handover audit pass: updated to current UI + routes + Settings capabilities.
- Icons are customizable via `data-icon-key` + Font Awesome runtime adapter (`server/public/fontawesome-icons.js`).
- Added global Charts settings (`charts_ui_config_v1`) + server-injected hide CSS via `/theme-vars.css`.
- Refactored Theme settings: moved all desktop header/nav/dropdown/settings/online color controls from Header tab into Color tab; Header tab now keeps non-color controls.
- Locked Theme primary palette to KEXO brand 3-color accents in both settings UI and `head-theme` early hydration.
- Fixed Settings → Charts initial render timing so chart mode/pie selectors render with correct defaults/selections when tab is opened.
- Added Insights → Variants page (`/insights/variants`) and API (`/api/insights-variants`) with configurable mapping tables, variant-specific sessions denominator (`?variant=<id>`), sortable/paginated tables (default 5 rows, options 5/10), and strict save validation in Settings → Insights → Variants that blocks unmapped/ambiguous configs with detailed diagnostics.
- Fixed Countries → Country + Product denominator in `getBestGeoProducts()` so Sessions/CR% use country+product-handle sessions (product landing sessions in that country), not all sessions for the country.
