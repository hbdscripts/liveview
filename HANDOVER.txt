KEXO Liveview — HANDOVER (keep current)
Last updated: 2026-02-10 (stable KPI strip sizing across pages)

This repo ships a private Shopify app with a near-real-time Live Visitors dashboard. The frontend uses Tabler UI and is split into multiple HTML pages (instead of a single monolithic `live-visitors.html`).

IMPORTANT (for future agents)
- Keep this file accurate. If you change core paths (routes, auth, dashboard UX, deploy), update this file in the SAME commit.
- This repo avoids new markdown docs; this handover is intentionally `HANDOVER.txt`.
- UI convention: cap font-weight at 500 (avoid heavier weights) for new dashboard UI.
- Diagnostics guardrail: when adding/moving/removing dashboard sections, update `server/trackerDefinitions.js` so Diagnostics → Definitions stays accurate.

---

## Current UI structure (Tabler)

Pages (new, Tabler layout):
- `server/public/dashboard.html`
- `server/public/live.html`
- `server/public/sales.html`
- `server/public/date.html`
- `server/public/countries.html`
- `server/public/products.html`
- `server/public/channels.html`
- `server/public/type.html`
- `server/public/ads.html`
- `server/public/tools.html`
- `server/public/mobile-unsupported.html`: mobile redirect target (logo + "Desktop only" copy).

Shared assets:
- `server/public/app.js`: shared JS bundle with per-page bootstrapping via `data-page` on `<body>`.
- `server/public/partials/header.html`: shared top header (mobile only on desktop), Tabler dark desktop navbar, then KPI strip below.
- `server/public/partials/footer.html`: Shared footer + closes `.page-wrapper`/`.page`.
- `server/public/tabler-theme.css`: Tabler theme overrides + default primary teal (`#3eb3ab`).
- `server/public/tools.css`: tools page styles extracted from inline HTML.
- `server/public/diagnostics-modal.css`: diagnostics modal styling (still used across pages).

Legacy/backup:
- `server/public/live-visitors.html` kept as backup of the monolithic page.

---

## Routing + auth

Server routing (Express):
- Root `/` now loads the login screen or redirects to `/dashboard` if already authenticated.
- Explicit routes serve the per-page HTML: `/dashboard`, `/live`, `/sales`, `/date`, `/countries`, `/products`, `/channels`, `/type`, `/ads`, `/tools`.
- Mobile traffic: User-Agent detection redirects all mobile GET requests to `/mobile-unsupported` (logo + "Desktop only for now" copy).
- See: `server/index.js`.

Auth protection:
- `server/middleware/dashboardAuth.js` protects per-page routes + API routes.
- Embedded Shopify app support: signed query requests and signed referers now work for ALL dashboard pages (not just `/`), so API calls don't 401 when navigating in an iframe.
- Login flow redirects to `/dashboard` after OAuth (`server/routes/login.js`).

---

## Per-page bootstrapping behavior

`server/public/app.js`:
- Uses `document.body.dataset.page` to decide which page to bootstrap.
- Highlights nav by setting `aria-current="page"`.
- Ads page includes `/ads.js` directly (and `app.js` still has a lazy-load fallback for safety).
- KPI component lives below the dark nav and is a single condensed-strip DOM container across pages (expanded overlay removed).
- Embedded Shopify app support: internal nav links preserve Shopify signed query params (`shop`, `hmac`, `timestamp`, etc.) so auth does not break between pages.

---

## Dashboard (homepage) data wiring

`server/public/dashboard.html`:
- Homepage chart container IDs and table IDs are aligned to what `server/public/app.js` expects, so charts/tables render instead of showing empty state.

Date range normalization (frontend + backend):
- UI uses `7days/14days/30days`; APIs use `7d/14d/30d`. `server/public/app.js` normalizes keys before calling APIs.
- Backend now allows `14d/30d` where needed (routes + store).

Platform start/min date clamp:
- MIN_YMD + PLATFORM_START values were corrected back to 2025-02-01 so historical ranges aren't incorrectly clamped into the future.

---

## Tools page

- Rebuilt as Tabler layout (`server/public/tools.html`).
- All inline styles moved to `server/public/tools.css`.
- Back link points to `/dashboard`.
- `server/public/tools.js` uses class toggles instead of inline styles.

---

## KPI system (global, every page)

Date control (topbar, far-right):
- UI is in `server/public/partials/header.html` as a Tabler input-group dropdown in the desktop topbar right slot.
- It drives the hidden `select#global-date-select` so existing date/KPI logic in `server/public/app.js` keeps working.
- Mobile: topbar date icon dropdown updates the same `select#global-date-select`.

KPI component (below dark nav, every page):
- Markup lives directly in `server/public/partials/header.html` (pages do not include KPIs directly).
- Condensed KPI strip is always visible; expanded KPI overlay/toggle were removed.
- Condensed chips include value + delta + a small progress bar.
- Extra KPIs (Items ordered / Orders fulfilled / Returns value):
  - API: `GET /api/kpis-expanded-extra` (see `server/routes/kpisExpandedExtra.js`)
  - Computed from Shopify Orders API (not KEXO tables): items ordered = line-item qty (orders created in range), orders fulfilled = distinct orders with fulfillments created in range, returns = refund transaction value (shown as negative in UI).
  - Warmed in the background so condensed chips render without blanks.

KPI caching (perf + UX):
- `/api/kpis` is cached (server-side) for 2 minutes and also painted from `localStorage` on navigation to avoid empty KPI boxes.
- Slow KPI fields (bounce + returning customers) are cached longer server-side; expanded extras are cached 10 minutes.
- When the sale toast closes, KPI caches are invalidated and KPIs are force-refreshed.

---

## Layout (header + dark navbar)

- Shared wrapper uses a Tabler dark horizontal navbar, then a KPI strip below it, in `server/public/partials/header.html`. Mobile: top header with hamburger; desktop: header hidden, KPIs below dark nav.
- Pages use `container-fluid` for a fluid content area.
- Mobile: hamburger opens `#kexo-mobile-nav` overlay (backdrop click / Escape closes).

---

## Diagnostics modal

- Still uses `server/public/diagnostics-modal.css` and existing HTML hooks.
- If restyling is requested, update the modal markup + CSS to match Tabler components.

---

## Scripts

- `scripts/split-pages.js`: Node script used to split `live-visitors.html` into per-page Tabler templates.

---

## Deployment

- Pushes to `main` trigger deploy (GitHub Actions + Railway).

---

## Pending follow-ups (if requested)

- Full Tabler restyle of the Diagnostics modal.
- UI polish pass across new pages (align cards, spacing, cards in countries/products/channels/type).
## High-level architecture

Backend:
- `server/index.js`: Express app, routes, startup migrations, SSE wiring.
- DB: SQLite by default (local) or Postgres when `DB_URL` is set (production recommended).
- Migrations: `server/migrations/*.js`.

Frontend:
- `server/public/*`: multiple HTML pages (Tabler UI).
- Shared JS: `server/public/app.js`.

Shopify:
- Pixel extension: `extensions/live-visitors-pixel/`.
- Shopify Admin APIs for sales/sessions/best-sellers endpoints.

Edge (optional):
- Cloudflare Worker: `workers/ingest-enrich.js`.

---

## Data flow (end-to-end)

1) Storefront events
- Shopify Web Pixel sends events to `POST /api/ingest` (requires `INGEST_SECRET`).

2) Ingest processing
- `server/routes/ingest.js` parses requests, derives fields, writes events + sessions.

3) Storage
- `server/store.js` is the central store logic (sessions + stats queries).

4) Dashboard queries
- Live/SSE: `GET /api/stream`.
- Reports: `GET /api/kpis`, `/api/stats`, `/api/traffic`, `/api/worst-products`, `/api/shopify-best-sellers`.

---

## Deployment + ops notes

- Pushes to `main` trigger deploy (GitHub Actions + Railway).
- `npm start` runs `scripts/prune-runtime-files.js` (removes non-runtime files from the runtime image).
- SQLite is ephemeral on Railway; use Postgres (`DB_URL`) for persistence.

---

## Guardrails

- Do not delete rows from `purchases`, `purchase_events`, `orders_shopify`, or `sessions` to fix data drift.
- When changing dashboard sections, update `server/trackerDefinitions.js`.

---

## Changelog (summary)

2026-02-08
- Tabler UI rollout and split-page architecture (per-page HTML routes).
- Sticky navbar overlap layout and shared theme config (`tabler-theme.css`).
- Tools page rebuilt + styles moved to `tools.css`.

2026-02-09
- Fix “no data” on homepage: range-key normalization, correct min/platform-start clamps, and dashboard chart/table ID wiring.
- Auth hardening for embedded Shopify app: signed-query + signed-referer allowed across dashboard pages, and signed params propagated across internal links.
- UI: migrated to Tabler `layout-fluid-vertical` (dark sidebar) and removed prior sticky/top-nav + KEXO gradient theming.
- Products overview (`/products`): show an immediate loader, fix pagination controls (disable state + client-side paging), and add reliable card spacing so tables don’t touch.
- Navbar polish: top-nav link separators now adapt to dark mode, and top-nav items have no border radius (square edges).
- Mobile: sidebar toggler + Settings dropdown remain; date control is in the sidebar.
- Removed per-page `<h2 class="page-title" id="page-title">…</h2>` headers; current page is indicated by the nav.
- Nav dropdowns: when a child page is active, the dropdown toggle label becomes that child (e.g. “Live”), and the group label is shown inside the dropdown.
- Nav highlight: active top-level item is bold and dropdown caret spacing is increased for readability.
- DB perf: added targeted indexes for traffic + bounce counting; dashboard-series now batches sessions/bounce aggregation to avoid per-day query loops.
- Date control: sidebar date dropdown is visible on all pages (including Tools).
- KPI UX/perf: add 2-minute caching + localStorage warm-paint; reduce duplicate conversion/session work; invalidate KPI caches after the sale toast hides.
- KPI extras: Items ordered / Orders fulfilled / Returns now map directly to Shopify truth (Orders API) so the expanded KPI set matches Shopify (returns renders as negative currency).
- Header actions: desktop topbar now shows a single Settings button with a Tabler dropdown for Refresh/Sound/Theme/Diagnostics/Sign out (mobile still uses the settings dropdown).
- Condensed KPIs: delta chips now render consistently (including “new” when the baseline is 0) and only show arrows when movement is meaningful.
- Dashboard-series: include per-day returning-customer counts so the “Returning” sparkline can render (with a one-time forced refresh if an older cached payload is detected).
- Dashboard KPI correctness + consistency:
  - Returning Customers now uses returning-order rate (truth returning orders / total orders) instead of revenue share.
  - GBP formatting standardized (thousands separators) across KPI + dashboard secondary stats.
- Nav + theming:
  - Traffic dropdown now links to `/channels` and `/type` only (combined `/traffic` page removed).
  - Header/footer logo reverted to a single image (no dark-mode swap).
- Reliability/cleanup:
  - `ads.html` now includes `/ads.js` directly (still compatible with lazy-load logic).
  - Ads table totals are rendered in the `card-footer` (pinned) with a console sanity-check against campaign sums.
  - Ads table UX: campaigns table uses standard `.card > .country-table-wrap` structure; connection + refresh + errors live in `#ads-actions` just below the table (icons right, Tabler SVG), errors open a Tabler modal, loading is centered, and non-forced refreshes patch spend/profit/ROAS (+ Conv) in-place instead of wiping the table.
  - Ads table mobile: campaign column is sticky while horizontally scrolling so names remain readable.
  - Ads spend sync: server runs Google Ads spend sync in the background every 5 minutes (recent window), and the Ads UI refreshes by patching spend/profit/ROAS in-place (no “Syncing…” table wipe).
  - Ads boot: `app.js` waits for `/ads.js` to actually load/execute (when the script tag already exists) and defers init by one macrotask so `/ads` doesn’t render blank on slow networks.
  - Ads campaign modal: chart now lazy-loads Chart.js so clicking a campaign row always renders the spend vs sales graph.
  - Ads attribution coverage: `gclid_campaign_cache` now stores mappings for `gclid` + iOS click IDs (`gbraid`/`wbraid`), and order attribution can use session `entry_url` click IDs as a fallback when `bs_campaign_id` wasn’t present.
  - Ads attribution model: when a purchase session has no campaign id, we also attribute via **visitor last Google Ads click** (30-day window) using prior sessions for the same `visitor_id` (matches “last click” behavior and prevents undercount on returning/direct purchases).
  - Ads profit now uses Shopify truth orders attributed into Ads DB (`ads_orders_attributed`) so Ads revenue/profit can be served from Ads DB only (attribution from `orders_shopify.raw_json.landing_site` + evidence/session fallback). Google conversion value is not used for Sales/profit.
  - Ingest: do not overwrite pixel-provided `entry_url` with the request `Referer` header (which is often origin-only on cross-origin fetch). Preserves tracking params like `bs_campaign_id`/`gclid` for Ads attribution + gclid backfill.
  - Fix `/api/dashboard-series` 500 on Postgres: reorder params for conditional-aggregate queries so BIGINT columns don’t receive `shop` string params (affects Units Sold + session/bounce aggregation).
  - Grid-table headers use shared `kexo-grid-header` styling so headers match across pages.
  - Dashboard overview charts + top tables now respect the header date range (dashboard-series supports `range=` keys).
  - Shared Product Insights modal: clicking product thumbnails opens a Tabler modal with image gallery, Today-by-default range selector, KPI table, and charts powered by `/api/product-insights`.
  - Sessions table entry/exit links open the same modal, loading either product insights (for `/products/...`) or page insights (for non-product URLs) via `/api/page-insights`.
  - Removed dead breakdown auto-refresh timer and stale KPI comment in `app.js`.
  - De-duplicated grid-table CSS (kept definitions in `custom.css`).
  - Legacy `live-visitors.html` no longer references missing `/nav.css`.
  - Server-side include resolver: cache disabled in dev + missing include no longer crashes responses.
  - Dashboard series: secondary stats now use server `summary` fields (desktop/mobile + new/returning), and endpoint reconciles truth cache to avoid drift vs `/api/kpis`.
- Theme: global `<a>` link color now inherits surrounding text color (no default blue links).
- Theme: removed KEXO gradient vars; Theme Settings controls mode/scheme/font/base/radius; default primary is `#3eb3ab`.
- KPIs: condensed strip + expanded grid toggle live under the page header; expanded extras are warmed in the background.

2026-02-10
- Desktop layout update: removed the left sidebar on desktop and added a Tabler horizontal navigation bar directly under the KPI strip (mobile menu behavior unchanged).
- Desktop nav follow-up: horizontal nav is now grouped dropdowns (Dashboard/Breakdown/Traffic/Integrations/Tools) in Tabler style.
- Dashboard KPI cards: background sparkline overlays are now pinned to the bottom strip of each card (instead of filling from the top).
- Header/layout follow-up: removed sidebar markup entirely, switched desktop to a full-width dark Tabler-style top menu, moved logo to the first menu item.
- Layout: KPIs now load below the dark nav bar (not above). Desktop header is hidden; KPIs sit in a light strip under the nav.
- Header compact: KPI strip min-height 3.25rem (was 4.5rem), nav links tighter padding, dark nav 2.5rem.
- Mobile redirect: client-side viewport fallback in head-theme (redirect if width < 768px) so emulating mobile by resize works.
- KPI bar: margin-bottom 20px, box-shadow 2px 2px 2px #eee, background #fff.
- Layout: remove left gap site-wide (body margin: 0; page wrapper padding-left: 0).
- KPI strip: single line (flex-wrap: nowrap), 100% width, horizontal scroll if overflow; nav container full width.
- Desktop nav alignment: force menu/logo/settings onto one row (no wrap) so Settings no longer drops beneath the menu.
- KPI strip compact pass: reduced bar height, reduced chip spacing/font sizing, and reduced bottom gap so it no longer appears oversized.
- Dashboard: removed the entire "Vs previous period" KPI card section from `server/public/dashboard.html`.
- Layout/gutter fix: removed page-level left/right container padding on desktop (`.page-body > .container-fluid`, footer, KPI bar container, desktop nav container) to eliminate the persistent left gap.
- KPI responsiveness: `kexo-kpis-condensed-row` now has `padding: 12px 5px`, and the small-screen rule no longer hides `.kexo-kpis-navbar` so KPIs remain visible and horizontally overflow as needed.
- Nav sizing follow-up: desktop logo is now 24px high; mobile topbar height now matches desktop nav height (2.5rem), with smaller mobile icons and a smaller mobile logo.
- Gutter balance follow-up: nav and KPI *background bars* remain full-bleed (no left outer gap), while content gutters were restored (`.75rem`) for page content, first nav item spacing, and KPI inner content.
- KPI sizing stability: condensed KPI overflow logic no longer hides/shows chips based on page width; chip width is now stable and horizontal overflow handles narrow widths, preventing KPI bar size shifts between pages.
- KPI sparkline follow-up: condensed top-bar KPI chips now render a smaller sparkline in the top-right corner (after label area), while dashboard KPI card sparklines stay 100% width at the bottom strip.
- Dashboard KPI cards now show previous-period values in-card (Revenue/Orders/Conversion) instead of hardcoded Today/Avg or Target rows, with labels driven by selected date range.
- KPI sparkline reliability: when selected range returns only one data point (e.g. Today/Yesterday), dashboard and top condensed KPI chips now fall back to 7-day series for visible background trend charts.
- Header: pin Settings dropdown to the far-right of the top bar.
- Ops: version local CSS/JS URLs in rendered HTML so deploys don’t mix “new HTML + cached old JS/CSS” (fixes unstyled / stale KPI strip in embeds).
- Ads UI polish: move totals into the card footer, move connection/refresh/errors into an actions bar below the table (Tabler SVG), add Conv (orders) column, and make campaign column sticky on mobile horizontal scroll.
- Ads actions/status follow-up: force `#ads-actions` to sit after `#ads-footer` (below totals), and switch Ads action icons to Tabler filled SVGs with explicit connected/disconnected status icons.
- Sidebar: restore grouped nav parents (Dashboard/Breakdown/Traffic/Integrations) and move Settings actions into a bottom-pinned sidebar Settings dropup.
- KPIs: render from a single navbar-owned container (included from `partials/header.html`) and open the expanded grid as an overlay (no vertical layout shift); condensed chips now show delta + mini progress bars.
- Mobile topbar: hamburger left (opens sidebar drawer), logo perfectly centered, date icon right (Tabler dropdown bound to `#global-date-select`).
- KPI pager: show prev/next only on overflow, use smooth scrollBy clicks, auto-recompute via ResizeObserver/MutationObserver, and teardown listeners on unload.
- KPIs (follow-up): remove expanded/toggle path entirely (small chips only in header), inline KPI markup in `partials/header.html` (no nested include dependency), and move desktop date box to topbar far-right.
- Dashboard: add a dedicated "Vs previous period" KPI strip under the main KPI cards with trend deltas/icons and progress bars driven by `/api/kpis` compare values.
- UI audit + fixes: Online badge moved from Live/card header to sidebar under logo (green circle when active, grey when none); primary color `#3eb3ab`; active nav items white; Theme Settings button fixed (inject offcanvas on load + data-bs-toggle); mobile padding/typography polish.
- KPI sparklines: background graph effect on all dashboard cards (Conv, AOV, Bounce, Ad Spend) and condensed header chips; `renderCondensedSparklines(chartSeries)` called from dashboard when data loaded, `fetchCondensedSeries()` wired into `refreshKpis` for other pages.
- Mobile: sidebar is overlay-only (position fixed, off-screen when closed); no persistent strip — single top bar (hamburger + logo + date); backdrop tap-to-close wired in `initSidebarBackdropClose`.
- Countries: removed pie chart; map spans full width above both tables; map fill color #136363 (was blue).
- Header grid: logo row and KPI bar same height (--kexo-top-row-height: 4.5rem), border-bottom aligned; removed border-top from online badge, logo gets it; page gap: 0 so KPI bar touches sidebar on all pages.
- Mobile: hamburger replaced with Tabler ti-menu-2 icon; hamburger and date icon styled white on dark bar; hamburger opens flat mobile nav (kexo-mobile-nav) instead of sidebar; nav has Overview, Live View, etc. + Sign out.
- Theme: color mode picker removed (light only); border-radius setting now applies to --radius and --tblr-border-radius (+ card, sessions, overlays); Settings dropdown items full width on hover; head-theme always forces light.
- Layout: scrollbar-gutter stable on html to prevent KPI/content shift when modal/dropdown opens; uniform page-body partials (page-body-start, page-body-end) across all dashboard pages.
- Footer: on desktop hide all icons, logo, diagnostics; show only centered last-sale eye; reduce padding and remove white bar.
- Mobile header: logo uses footer.png (80x29); hamburger and date icons white, no background or border; topbar row min-height 60px, no border.
- Mobile tables: grid-tables use card layout on small screens (max-width 576px); no overflow-x; header hidden; each row is a card with data-label from header synced via MutationObserver; applies to country, traffic, products, sessions tables.
- Sidebar online badge: split into 2-column grid (left: website name + SVG globe icon; right: online count); real border; website name ellipsis when overflow; navbar brand img height 36px; shop display from /api/store-base-url (shopDisplayDomain).
- Layout: page-wrapper margin-left 0, page padding 0, KPI strip padding-left 0 so KPIs/content touch sidebar.
- Sidebar: .navbar-vertical > .container-fluid padding-right 0 so menu/KPIs touch (Bootstrap default ~15px caused gap).
- Badge: SHOP_DISPLAY_DOMAIN for custom domain (e.g. hbdjewellery.com); font 12px; border top/bottom only (dark); no left/right; background #1d2e40.
- Dashboard KPI cards: sparklines as background graphs (position absolute, opacity 0.18); allow 1 data point for Today range.
- Settings dropdown: full-width hover on list items (menu padding 0, items span edge-to-edge).
- Countries map: high-traffic fill uses primary teal (#3eb3ab) instead of dark #136363 (was appearing black).
- Sidebar badge: fallback to hbdjewellery.com when shopDisplayDomain is empty or derived from Shopify handle (e.g. 943925-c1.com).
- Desktop nav: rebuilt with Tabler `collapse navbar-collapse` + inner `.navbar` structure (`#navbar-menu`), centered grouped menu items, logo as first item, and settings kept in right-side nav column.
- Header KPI strip: chips now fill available topbar width more cleanly via smarter `gap` + `min-width`/`flex` behavior (better distribution before overflow hiding kicks in).
- Accessibility + semantics: desktop dropdown toggles now include `aria-haspopup="menu"` + `aria-controls`; desktop/mobile date buttons now provide explicit controls wiring; dashboard progress bars now maintain `aria-valuenow`/bounds/labels as values update.
- Routing fix: diagnostics Google Ads reconnect + re-login links now redirect to `/dashboard` (not legacy `/app/live-visitors`).
- SSE reliability: removed per-client heartbeat interval and switched to a shared timer with cleanup on `close`/`error`/`aborted`.
- Backend perf: batched `upsertTrafficSourceTokens` writes, parallelized Shopify sessions day-snapshot loading + missing-day fetches, and parallelized product meta lookups in dashboard-series.
- DB perf: added migration `039_active_sessions_last_seen_started_at_index.js` for active-session query support (`sessions(last_seen, started_at)`).
- Desktop nav styling follow-up: top navbar now uses `#1c2f42`, removes nav/dropdown borders, removes hover backgrounds, keeps text white, and shows active state on the outer `li.nav-item` indicator instead of link background.
- KPI strip fit follow-up: condensed chips now use JS width calculation against available strip width; trailing chips are hidden from the end when space runs out.
- Nav behavior cleanup: removed legacy JS that force-opened active dropdown menus (`.show` state) so grouped menus stay closed until clicked.
- Dead layout cleanup: removed obsolete sidebar-era CSS/JS (`navbar-vertical`, `kexo-sidebar-*`, `kexo-online-badge`, `#sidebar-menu` handling) no longer used by current Tabler horizontal layout.
- Theme parity follow-up: desktop nav markup now uses Tabler dark navbar semantics (`data-bs-theme="dark"`) and `aria-haspopup="true"` on dropdown toggles.
- KPI fit follow-up: condensed chips now use 15px fixed inter-chip gap with dynamic width/min-width calculation; trailing chips hide from the end when viewport shrinks.
- Nav active-state follow-up: JS no longer applies `.active` to dropdown toggle links; active state stays on outer `li.nav-item` to match Tabler behavior.
- Legacy naming cleanup: renamed `initSidebarDateMenu` helpers to `initHeaderDateMenu` variants in `server/public/app.js`.
- Mobile redirect: all mobile User-Agent traffic to dashboard/login paths now redirects to `/mobile-unsupported` with centered logo and "Desktop only for now" copy.
