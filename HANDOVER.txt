KEXO Liveview — HANDOVER (keep current)
Last updated: 2026-02-10 (UI: Ads table footer totals + actions bar; Tabler fluid-vertical sidebar + condensed KPIs)

This repo ships a private Shopify app with a near-real-time Live Visitors dashboard. The frontend uses Tabler UI and is split into multiple HTML pages (instead of a single monolithic `live-visitors.html`).

IMPORTANT (for future agents)
- Keep this file accurate. If you change core paths (routes, auth, dashboard UX, deploy), update this file in the SAME commit.
- This repo avoids new markdown docs; this handover is intentionally `HANDOVER.txt`.
- UI convention: cap font-weight at 500 (avoid heavier weights) for new dashboard UI.
- Diagnostics guardrail: when adding/moving/removing dashboard sections, update `server/trackerDefinitions.js` so Diagnostics → Definitions stays accurate.

---

## Current UI structure (Tabler)

Pages (new, Tabler layout):
- `server/public/dashboard.html`
- `server/public/live.html`
- `server/public/sales.html`
- `server/public/date.html`
- `server/public/countries.html`
- `server/public/products.html`
- `server/public/channels.html`
- `server/public/type.html`
- `server/public/ads.html`
- `server/public/tools.html`

Shared assets:
- `server/public/app.js`: shared JS bundle with per-page bootstrapping via `data-page` on `<body>`.
- `server/public/partials/header.html`: Tabler fluid-vertical wrapper (opens `.page` + sidebar + `.page-wrapper`).
- `server/public/partials/footer.html`: Shared footer + closes `.page-wrapper`/`.page`.
- `server/public/partials/kpis-expanded.html`: KPI component (condensed strip + expanded grid toggle).
- `server/public/tabler-theme.css`: Tabler theme overrides + sidebar active state + default primary green (`#2fb344`).
- `server/public/tools.css`: tools page styles extracted from inline HTML.
- `server/public/diagnostics-modal.css`: diagnostics modal styling (still used across pages).

Legacy/backup:
- `server/public/live-visitors.html` kept as backup of the monolithic page.

---

## Routing + auth

Server routing (Express):
- Root `/` now loads the login screen or redirects to `/dashboard` if already authenticated.
- Explicit routes serve the per-page HTML: `/dashboard`, `/live`, `/sales`, `/date`, `/countries`, `/products`, `/channels`, `/type`, `/ads`, `/tools`.
- See: `server/index.js`.

Auth protection:
- `server/middleware/dashboardAuth.js` protects per-page routes + API routes.
- Embedded Shopify app support: signed query requests and signed referers now work for ALL dashboard pages (not just `/`), so API calls don't 401 when navigating in an iframe.
- Login flow redirects to `/dashboard` after OAuth (`server/routes/login.js`).

---

## Per-page bootstrapping behavior

`server/public/app.js`:
- Uses `document.body.dataset.page` to decide which page to bootstrap.
- Highlights nav by setting `aria-current="page"`.
- Ads page includes `/ads.js` directly (and `app.js` still has a lazy-load fallback for safety).
- KPI component is now top-of-content with 2 mutually-exclusive states (persisted in `localStorage` as `kexo-kpis-expanded`):
  - Condensed KPI strip (always shown by default)
  - Expanded KPI grid (chevron toggle)
- Embedded Shopify app support: internal nav links preserve Shopify signed query params (`shop`, `hmac`, `timestamp`, etc.) so auth does not break between pages.

---

## Dashboard (homepage) data wiring

`server/public/dashboard.html`:
- Homepage chart container IDs and table IDs are aligned to what `server/public/app.js` expects, so charts/tables render instead of showing empty state.

Date range normalization (frontend + backend):
- UI uses `7days/14days/30days`; APIs use `7d/14d/30d`. `server/public/app.js` normalizes keys before calling APIs.
- Backend now allows `14d/30d` where needed (routes + store).

Platform start/min date clamp:
- MIN_YMD + PLATFORM_START values were corrected back to 2025-02-01 so historical ranges aren't incorrectly clamped into the future.

---

## Tools page

- Rebuilt as Tabler layout (`server/public/tools.html`).
- All inline styles moved to `server/public/tools.css`.
- Back link points to `/dashboard`.
- `server/public/tools.js` uses class toggles instead of inline styles.

---

## KPI system (global, every page)

Date control (sidebar, under logo):
- UI is in `server/public/partials/header.html` as a Tabler input-group dropdown.
- It drives the hidden `select#global-date-select` so existing date/KPI logic in `server/public/app.js` keeps working.

KPI component (top-of-content, every page):
- Markup lives in ONE include: `server/public/partials/kpis-expanded.html`.
- Condensed KPI strip is shown by default; expanded KPI grid toggles via chevrons.
- State is controlled in `server/public/app.js` and persisted in `localStorage` (`kexo-kpis-expanded`).
- Extra KPIs (Items ordered / Orders fulfilled / Returns value):
  - API: `GET /api/kpis-expanded-extra` (see `server/routes/kpisExpandedExtra.js`)
  - Computed from Shopify Orders API (not KEXO tables): items ordered = line-item qty (orders created in range), orders fulfilled = distinct orders with fulfillments created in range, returns = refund transaction value (shown as negative in UI).
  - Warmed in the background so condensed + expanded can both render without blanks.

KPI caching (perf + UX):
- `/api/kpis` is cached (server-side) for 2 minutes and also painted from `localStorage` on navigation to avoid empty KPI boxes.
- Slow KPI fields (bounce + returning customers) are cached longer server-side; expanded extras are cached 10 minutes.
- When the sale toast closes, KPI caches are invalidated and KPIs are force-refreshed.

---

## Layout (fluid vertical)

- Shared wrapper is Tabler fluid vertical: dark sidebar + `.page-wrapper` (see `server/public/partials/header.html`).
- Pages use `container-fluid` for a “fluid” feel (matching Tabler’s `layout-fluid-vertical`).

---

## Diagnostics modal

- Still uses `server/public/diagnostics-modal.css` and existing HTML hooks.
- If restyling is requested, update the modal markup + CSS to match Tabler components.

---

## Scripts

- `scripts/split-pages.js`: Node script used to split `live-visitors.html` into per-page Tabler templates.

---

## Deployment

- Pushes to `main` trigger deploy (GitHub Actions + Railway).

---

## Pending follow-ups (if requested)

- Full Tabler restyle of the Diagnostics modal.
- UI polish pass across new pages (align cards, spacing, cards in countries/products/channels/type).
## High-level architecture

Backend:
- `server/index.js`: Express app, routes, startup migrations, SSE wiring.
- DB: SQLite by default (local) or Postgres when `DB_URL` is set (production recommended).
- Migrations: `server/migrations/*.js`.

Frontend:
- `server/public/*`: multiple HTML pages (Tabler UI).
- Shared JS: `server/public/app.js`.

Shopify:
- Pixel extension: `extensions/live-visitors-pixel/`.
- Shopify Admin APIs for sales/sessions/best-sellers endpoints.

Edge (optional):
- Cloudflare Worker: `workers/ingest-enrich.js`.

---

## Data flow (end-to-end)

1) Storefront events
- Shopify Web Pixel sends events to `POST /api/ingest` (requires `INGEST_SECRET`).

2) Ingest processing
- `server/routes/ingest.js` parses requests, derives fields, writes events + sessions.

3) Storage
- `server/store.js` is the central store logic (sessions + stats queries).

4) Dashboard queries
- Live/SSE: `GET /api/stream`.
- Reports: `GET /api/kpis`, `/api/stats`, `/api/traffic`, `/api/worst-products`, `/api/shopify-best-sellers`.

---

## Deployment + ops notes

- Pushes to `main` trigger deploy (GitHub Actions + Railway).
- `npm start` runs `scripts/prune-runtime-files.js` (removes non-runtime files from the runtime image).
- SQLite is ephemeral on Railway; use Postgres (`DB_URL`) for persistence.

---

## Guardrails

- Do not delete rows from `purchases`, `purchase_events`, `orders_shopify`, or `sessions` to fix data drift.
- When changing dashboard sections, update `server/trackerDefinitions.js`.

---

## Changelog (summary)

2026-02-08
- Tabler UI rollout and split-page architecture (per-page HTML routes).
- Sticky navbar overlap layout and shared theme config (`tabler-theme.css`).
- Tools page rebuilt + styles moved to `tools.css`.

2026-02-09
- Fix “no data” on homepage: range-key normalization, correct min/platform-start clamps, and dashboard chart/table ID wiring.
- Auth hardening for embedded Shopify app: signed-query + signed-referer allowed across dashboard pages, and signed params propagated across internal links.
- UI: migrated to Tabler `layout-fluid-vertical` (dark sidebar) and removed prior sticky/top-nav + KEXO gradient theming.
- Products overview (`/products`): show an immediate loader, fix pagination controls (disable state + client-side paging), and add reliable card spacing so tables don’t touch.
- Navbar polish: top-nav link separators now adapt to dark mode, and top-nav items have no border radius (square edges).
- Mobile: sidebar toggler + Settings dropdown remain; date control is in the sidebar.
- Removed per-page `<h2 class="page-title" id="page-title">…</h2>` headers; current page is indicated by the nav.
- Nav dropdowns: when a child page is active, the dropdown toggle label becomes that child (e.g. “Live”), and the group label is shown inside the dropdown.
- Nav highlight: active top-level item is bold and dropdown caret spacing is increased for readability.
- DB perf: added targeted indexes for traffic + bounce counting; dashboard-series now batches sessions/bounce aggregation to avoid per-day query loops.
- Date control: sidebar date dropdown is visible on all pages (including Tools).
- KPI UX/perf: add 2-minute caching + localStorage warm-paint; reduce duplicate conversion/session work; invalidate KPI caches after the sale toast hides.
- KPI extras: Items ordered / Orders fulfilled / Returns now map directly to Shopify truth (Orders API) so the expanded KPI set matches Shopify (returns renders as negative currency).
- Header actions: desktop topbar now shows a single Settings button with a Tabler dropdown for Refresh/Sound/Theme/Diagnostics/Sign out (mobile still uses the settings dropdown).
- Condensed KPIs: delta chips now render consistently (including “new” when the baseline is 0) and only show arrows when movement is meaningful.
- Dashboard-series: include per-day returning-customer counts so the “Returning” sparkline can render (with a one-time forced refresh if an older cached payload is detected).
- Dashboard KPI correctness + consistency:
  - Returning Customers now uses returning-order rate (truth returning orders / total orders) instead of revenue share.
  - GBP formatting standardized (thousands separators) across KPI + dashboard secondary stats.
- Nav + theming:
  - Traffic dropdown now links to `/channels` and `/type` only (combined `/traffic` page removed).
  - Header/footer logo reverted to a single image (no dark-mode swap).
- Reliability/cleanup:
  - `ads.html` now includes `/ads.js` directly (still compatible with lazy-load logic).
  - Ads table totals are rendered in the `card-footer` (pinned) with a console sanity-check against campaign sums.
  - Ads table UX: campaigns table uses standard `.card > .country-table-wrap` structure; connection + refresh + errors live in `#ads-actions` just below the table (icons right), errors open a Tabler modal, loading is centered, and non-forced refreshes patch spend/profit/ROAS in-place instead of wiping the table.
  - Ads spend sync: server runs Google Ads spend sync in the background every 5 minutes (recent window), and the Ads UI refreshes by patching spend/profit/ROAS in-place (no “Syncing…” table wipe).
  - Ads boot: `app.js` waits for `/ads.js` to actually load/execute (when the script tag already exists) and defers init by one macrotask so `/ads` doesn’t render blank on slow networks.
  - Ads campaign modal: chart now lazy-loads Chart.js so clicking a campaign row always renders the spend vs sales graph.
  - Ads attribution coverage: `gclid_campaign_cache` now stores mappings for `gclid` + iOS click IDs (`gbraid`/`wbraid`), and order attribution can use session `entry_url` click IDs as a fallback when `bs_campaign_id` wasn’t present.
  - Ads attribution model: when a purchase session has no campaign id, we also attribute via **visitor last Google Ads click** (30-day window) using prior sessions for the same `visitor_id` (matches “last click” behavior and prevents undercount on returning/direct purchases).
  - Ads profit now uses Shopify truth orders attributed into Ads DB (`ads_orders_attributed`) so Ads revenue/profit can be served from Ads DB only (attribution from `orders_shopify.raw_json.landing_site` + evidence/session fallback). Google conversion value is not used for Sales/profit.
  - Ingest: do not overwrite pixel-provided `entry_url` with the request `Referer` header (which is often origin-only on cross-origin fetch). Preserves tracking params like `bs_campaign_id`/`gclid` for Ads attribution + gclid backfill.
  - Fix `/api/dashboard-series` 500 on Postgres: reorder params for conditional-aggregate queries so BIGINT columns don’t receive `shop` string params (affects Units Sold + session/bounce aggregation).
  - Grid-table headers use shared `kexo-grid-header` styling so headers match across pages.
  - Dashboard overview charts + top tables now respect the header date range (dashboard-series supports `range=` keys).
  - Shared Product Insights modal: clicking product thumbnails opens a Tabler modal with image gallery, Today-by-default range selector, KPI table, and charts powered by `/api/product-insights`.
  - Sessions table entry/exit links open the same modal, loading either product insights (for `/products/...`) or page insights (for non-product URLs) via `/api/page-insights`.
  - Removed dead breakdown auto-refresh timer and stale KPI comment in `app.js`.
  - De-duplicated grid-table CSS (kept definitions in `custom.css`).
  - Legacy `live-visitors.html` no longer references missing `/nav.css`.
  - Server-side include resolver: cache disabled in dev + missing include no longer crashes responses.
  - Dashboard series: secondary stats now use server `summary` fields (desktop/mobile + new/returning), and endpoint reconciles truth cache to avoid drift vs `/api/kpis`.
- Theme: global `<a>` link color now inherits surrounding text color (no default blue links).
- Theme: removed KEXO gradient vars; Theme Settings controls mode/scheme/font/base/radius; default primary is `#2fb344`.
- KPIs: condensed strip + expanded grid toggle live under the page header; expanded extras are warmed in the background.

2026-02-10
- Header: pin Settings dropdown to the far-right of the top bar.
- Ops: version local CSS/JS URLs in rendered HTML so deploys don’t mix “new HTML + cached old JS/CSS” (fixes unstyled / stale KPI strip in embeds).
- Ads UI polish: move totals into the card footer, move connection/refresh/errors into an actions bar below the table, and use a Tabler modal for error details.
