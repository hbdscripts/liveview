KEXO Liveview — HANDOVER (keep current)
Last updated: 2026-02-12 (Google Ads GCLID per-day backfill + Ads diagnostics readability + Countries map load guard)

This repo ships a private Shopify app with a near-real-time Live Visitors dashboard. The frontend is Tabler-based and split into multiple HTML pages (folder-style routes) with shared partials and a shared JS bundle.

IMPORTANT (for future agents)
- Read this file before making changes (Cursor rules enforce this).
- Keep this file accurate. If you change core paths (routes/auth/dashboard UX/deploy), update this file in the SAME commit.
- This repo avoids new markdown docs; this handover is intentionally `HANDOVER.txt`.
- UI convention: cap font-weight at 500 (avoid heavier weights) for new dashboard UI.
- Diagnostics guardrail: when adding/moving/removing dashboard sections, update `server/trackerDefinitions.js` so Diagnostics → Definitions stays accurate.

---

## What KEXO looks like today (UX)

Desktop chrome (shared header across pages via `server/public/partials/header.html`):
- Top strip: live visitor count (left), centered logo, Settings dropdown (right). On new sale, a Tabler-style `tblr-banner` overlays the strip with flag – product – sale value (10s auto-close; MP3 cha-ching).
- Main nav row below: grouped dropdown menus (Dashboard, Insights, Traffic, Integrations, Tools) + date range selector on the right.
- KPI strip: condensed KPI chips shown on most pages; hidden on `/dashboard/overview` and `/settings`.

Mobile:
- Mobile topbar (hamburger + centered logo + date dropdown) + full-screen nav overlay (`#kexo-mobile-nav`).
- Mobile UA GET requests for dashboard/settings/tools/etc are redirected to `/mobile-unsupported` (see `server/index.js`).

KEXO “5-color” accents:
- The desktop nav uses a rotating 5-color accent for the active underline and related styling via `.kexo-5color`:
  - Accent 1: `#4b94e4` (blue)
  - Accent 2: `#3eb3ab` (teal)
  - Accent 3: `#f59e34` (orange)
  - Accent 4: `#8b5cf6` (purple)
  - Accent 5: `#ef4444` (red)
  - See: `server/public/custom.css` (`.kexo-5color`, `--kexo-accent-*`)

---

## Canonical pages + routes (folder URLs)

Rendered templates live under `server/public/**` and are served by `server/index.js` via `sendPage()` (includes + cache-control + asset versioning).

Dashboard:
- `/dashboard/overview` → `server/public/dashboard/overview.html` (`data-page="dashboard"`)
- `/dashboard/live` → `server/public/dashboard/live.html`
- `/dashboard/sales` → `server/public/dashboard/sales.html`
- `/dashboard/table` → `server/public/dashboard/table.html`

Insights:
- `/insights/countries` → `server/public/insights/countries.html`
- `/insights/products` → `server/public/insights/products.html`
- `/insights/variants` → `server/public/insights/variants.html`

Traffic:
- `/traffic/channels` → `server/public/traffic/channels.html`
- `/traffic/device` → `server/public/traffic/device.html`

Integrations:
- `/integrations/google-ads` → `server/public/integrations/google-ads.html`

Tools:
- `/tools/compare-conversion-rate` → `server/public/tools/compare-conversion-rate.html`

Settings:
- `/settings` → `server/public/settings.html`

Legacy redirects (kept, query preserved):
- `/tools/ads` and `/ads` → `/integrations/google-ads`
- `/date` → `/dashboard/table`
- `/overview`, `/live`, `/sales`, `/countries`, `/products`, `/variants`, `/channels`, `/type`, `/compare-conversion-rate` → canonical folder routes

Root `/`:
- Shopify embedded app URL. `auth.handleAppUrl()` decides:
  - render embedded dashboard overview, or
  - redirect to `/dashboard/overview` when logged in, else `/app/login`

---

## Settings (GLOBAL) — what’s configurable today

Settings scope is intentionally GLOBAL/shared (user-specific settings are disabled for now).

Settings UI:
- `server/public/settings.html`: Settings page layout + tab shells
- `server/public/settings-page.js`: tab switching, saving, and Settings panel wiring

Settings tabs:
- General: current config display + Settings scope (locked global)
- Theme: theme editor (colors/fonts/icons/header)
- Assets: override logo/image URLs
- Data & Reporting: reporting source toggles (orders/sessions) + pixel session mode
- Integrations: Pixel + Google Ads status/actions
- Sources: UTM/source mapping
- KPIs & Date Ranges: KPI order/labels/visibility + date-range labels/availability
- Insights: tab shell for Products/Countries plus active Variants mapping manager (custom table/rule editor)
- Charts: per-chart enable/type/colors (see Charts section)
- Layout: per-page table config (name/order/grid, rows-per-page options/default, optional sticky column min/max)
- Diagnostics: config-status + reconcile utilities (Settings-first)

Settings API:
- `GET/POST /api/settings` in `server/routes/settings.js`
- Returned payload includes (among other fields): `reporting`, `kpiUiConfig`, `chartsUiConfig`, `tablesUiConfig`, `insightsVariantsConfig`

---

## Theme + Icons (GLOBAL)

Theme persistence:
- `GET/POST /api/theme-defaults` (POST uses patch semantics: only provided keys update).
- First-paint CSS variables are injected via `GET /theme-vars.css` and loaded in head (see `server/public/partials/head-theme.html`) to prevent header flash (and to hide disabled charts before paint).

Theme UI:
- `server/public/theme-settings.js` renders the Theme panel inside Settings.
- Header subtab contains non-color header controls only (visibility toggles, border on/off toggles, radius fields, logo override, strip padding, strip border-bottom toggle).
- Color subtab has 5 editable hex inputs for accents 1–5; strip, settings dropdown, menu, and online badge colors are derived from accent 1.
  - Strip opacity filter and Menu opacity filter (0–100%) control darkening of strip/menu backgrounds. Menu hover opacity (0–100%) and hover color (black/white) control the tint on menu link and dropdown item hover.
  - Settings dropdown inherits menu: same background, opacity, border, and link colors as the main menu; no separate dropdown settings.
- Early hydration in `server/public/partials/head-theme.html` loads 5 accent hex values from localStorage before paint.

Header + nav theming:
- Desktop top strip + main nav are styled via CSS vars in `server/public/custom.css`, overridden by `/theme-vars.css`.
- Examples:
  - `--kexo-header-top-bg`, `--kexo-header-top-text-color`
  - `--kexo-top-menu-bg` / `--kexo-header-main-bg`
  - `--kexo-top-menu-border-color`, `--kexo-top-menu-shadow`
  - Settings dropdown + Online badge have dedicated vars (bg/text/border/radius/menu colors)

Icons:
- Font Awesome kit is loaded globally in `partials/head-theme.html`.
- Runtime adapter: `server/public/fontawesome-icons.js`
  - Converts Tabler icon placeholders / inline nav SVGs to Font Awesome.
  - Icons are keyed via `data-icon-key="..."` across the app.
  - Settings-only icon keys (`settings-tab-*`, `settings-diagnostics-*`) are locked for stability.

---

## Charts (GLOBAL)

Charts are centrally configurable in Settings → Charts:
- DB key: `charts_ui_config_v1`
- Served by: `GET /api/settings` as `chartsUiConfig`
- Saved by: `POST /api/settings` (`chartsUiConfig` payload)
- Settings-side charts table rendering is lazy-on-tab-open (render when Charts tab is active) to avoid hidden-panel select/input rendering glitches.

Runtime apply:
- `server/public/app.js`: dashboard/insights/traffic charts + map behavior
- `server/public/ads.js`: Google Ads overview chart

Chart hiding (no flicker):
- Chart wrappers/cards in HTML carry `data-kexo-chart-key="<chartKey>"`.
- `GET /theme-vars.css` injects `display:none!important` for disabled charts so they disappear before first paint.
- Dashboard paired charts expand to full width when their partner is disabled (CSS injected server-side).

Libraries:
- ApexCharts for most charts
- jsVectorMap for the Countries map (supports `map-animated` vs `map-flat` and a configurable accent color)
- Chart.js is used only inside the Google Ads campaign modal (lazy-loaded)

---

## KPI system (GLOBAL)

KPI/date-range UI config:
- DB key: `kpi_ui_config_v1` (in `GET /api/settings` as `kpiUiConfig`)
- Applied by: `server/public/app.js` to:
  - condensed KPI strip order/labels/visibility + display options
  - dashboard KPI card order/labels/visibility
  - date range menu labels/availability

KPI data:
- `GET /api/kpis` (server cached; also localStorage warm-paint to avoid empty chips on navigation)
- `GET /api/kpis-expanded-extra` for Shopify-derived extras (COGS, returns, items ordered, etc.)

---

## Key frontend files (high-signal)

- `server/public/partials/head-theme.html`: early theme hydration + loads `/theme-vars.css` + Font Awesome + `fontawesome-icons.js`
- `server/public/partials/header.html`: desktop strip + desktop nav + KPI strip + mobile nav
- `server/public/app.js`: shared bootstrapping + report loader + charts/tables + Settings hydration
- `server/public/custom.css`: KEXO UI styling + header/nav theme vars + layout + KEXO 5-color logic
- `server/public/tabler-theme.css`: Tabler overrides
- `server/public/settings-page.js`: Settings tab logic + saving to `/api/settings`
- `server/public/theme-settings.js`: Theme UI
- `server/public/variants-page.js`: Insights → Variants rendering/paging/sorting (driven by `/api/insights-variants`)
- `server/public/ads.js`: Google Ads page logic
- `server/public/tools.js`: Conversion Rate Compare tool logic

---

## Backend architecture highlights

- `server/index.js`: Express app, canonical page routes, auth middleware, static assets, startup migrations
- `server/middleware/dashboardAuth.js`: Shopify embed + direct OAuth cookie protection
- `server/store.js`: DB access + reporting queries + dedupe guardrails
- `server/variantInsightsConfig.js`: canonical Variants table/rule defaults + matching/validation helpers
- `server/variantInsightsService.js`: Variants data aggregation (truth orders + variant sessions) and validation sampling
- `server/migrations/*.js`: schema/index migrations run on startup
- Ingest: `POST /api/ingest` (strict JSON limit), writes events/sessions/purchases (append-only; no deletes)

Ops/reliability:
- Static assets are versioned into HTML (query param `?v=`) to avoid Shopify embed caching mismatches.
- `GET /api/version` returns `assetVersion` so clients can self-recover after long-idle tabs.
- `.md`/`/docs` paths are blocked in production (see `server/index.js`).

---

## Deployment notes

- GitHub Actions are manual (`workflow_dispatch`).
- Railway hosts production; deploys may auto-run from GitHub depending on Railway config.
- `npm start` runs `scripts/prune-runtime-files.js` (removes non-runtime files from the runtime image).
- SQLite is ephemeral on Railway; production should use Postgres via `DB_URL`.

---

## Guardrails

- Never delete/truncate core data tables (`purchases`, `purchase_events`, `orders_shopify`, `sessions`) to “fix numbers”.
- Handle over-reporting via dedupe in stats queries (see `server/store.js` helpers).
- When changing dashboard sections/definitions, update `server/trackerDefinitions.js`.

---

## Changelog (high-signal)

2026-02-12 (latest)
- Sale notification rework: replaced top-right toast modal with **tblr-banner** overlay on the desktop top strip. Banner shows flag – product – sale value, center-aligned, with close button far right; auto-closes after 10s; MP3 cha-ching preserved. Markup moved to `header.html` so it appears on all pages (fixes no-show on settings/variants/compare-conversion-rate). Removed old toast from 10 page templates; removed `sale-toast-time` icon key.

2026-02-12 (latest)
- Variants mappings now start **blank/custom-first** (no shipped default mapping tables/rules). Seed tables using Suggestions or build manually.
- Settings → Insights → Variants: added **Suggest mappings** (Shopify selectedOptions + recent observed activity) with one-click seed into editable custom tables.
- Applying suggestions now **merges by Output label** when possible (prevents duplicates like Gold/Vermeil being added twice; new aliases are folded into the existing row).
- New API endpoints:
  - `GET /api/insights-variants-suggestions` (build suggestions)
  - `POST /api/insights-variants-suggestions/apply` (apply selected seed tables into config)
- Variants settings save is no longer blocked by unmapped coverage; it saves and returns **coverage warnings** to guide mapping/ignore.
- Fixed settings editor escaping so Output labels can safely include quotes/ranges (e.g. `7.5" - 9" inches`).
- Insights → Variants: All Variant Stats now shows **Mapped+Ignored %** and a per-table **Top Unmapped (by sessions)** section.

2026-02-12 (latest)
- Added Settings → Layout → Tables: editable per-page table name/order/grid + rows-per-page options/default + optional sticky column min/max.
- New settings key: `tables_ui_config_v1` (cached client-side in localStorage as `kexo:tables-ui-config:v1`).
- Runtime apply in `server/public/app.js`:
  - table row selectors use config overrides for options/defaults
  - sticky column resize bounds can be overridden per table
  - table order/grid/title are applied via DOM transforms (titles are opt-in via `data-kexo-table-title="1"`)
- Variants validation/mapping is now scope-aware by table intent: length/style/finish tables skip out-of-scope titles before unmapped checks, reducing false save blockers on mixed catalogs.
- Variants diagnostics now include `outOfScope` totals/examples; All Variant Stats modal shows Total vs In Scope sessions, Out Of Scope sessions, and computes Mapped % from in-scope sessions.
- Settings -> Insights -> Variants messaging now clarifies that save blocking applies to unmapped in-scope titles and that out-of-scope titles are skipped.

2026-02-12 (latest)
- Variants mapping now auto-resolves overlap by specificity/order (most specific include wins; ties use rule order), reducing reliance on manual exclude maintenance.
- Variants settings save-blocking now targets unmapped titles; overlap-resolved cases are reported as diagnostics context rather than a hard-block category.
- Settings -> Insights -> Variants editor copy now explains auto-managed overlap and no longer presents `Exclude aliases` as required manual mapping input.
- Insights -> Variants now has header actions for **Variant Settings** and **All Variant Stats**, plus a new All Variant Stats modal with table-level totals and mapped-coverage-by-sessions diagnostics.
- Variants diagnostics payload now includes overlap-resolved totals/examples and session-attribution coverage (`?variant=` coverage against product-entry sessions) to highlight default-option attribution gaps.

2026-02-12 (latest)
- Countries -> Country + Product no longer hard-caps to top 3 products per country in backend output; table row selector can now surface larger datasets (bounded by a global safety cap).
- Google Ads page refresh path now runs backend sync (`POST /api/ads/refresh`) on force refresh, with a guarded yesterday auto-sync when summary first returns empty.
- Google Ads GCLID backfill now queries ClickView **per-day** (required by the Google Ads API) to avoid refresh failures/misleading “endpoint not found” errors; Ads error modal diagnostics JSON is readable even in dark theme.
- Charts UI config apply now triggers active-view re-render in `app.js`, fixing stale chart mode/color/enable states (including Countries map) after settings changes.
- Row-per-page controls now rebind after icon/theme refresh events (`kexo:icon-theme-changed`) to prevent disappearing selectors.
- Settings -> Diagnostics now includes clearer Refresh vs Reconcile semantics, reconcile action feedback, enriched diagnostics payload metadata, and a Download JSON handoff action for AI/agent workflows.
- Tracker Definitions updated (v16) with explicit Settings -> Charts and Settings -> Diagnostics coverage; `/api/config-status` now returns diagnostics schema + chart/date-range settings summaries.

2026-02-12 (earlier)
- Product names across dashboard + insights tables are now clickable links that open the large Product Insights modal; removed product image thumbnails from those tables (modal is now the primary way to view product imagery).
- Product Insights modal now defaults to the **global** date range, shows KPI-style Clicks / Conversions / Conversion Rate, and includes a Top Countries section (when available) plus footer buttons for the storefront page + Shopify admin product page.
- Sessions tables (`/dashboard/live`, `/dashboard/sales`, `/dashboard/table`) now show a single product link in the Landing column that opens Product Insights (no entry/exit dual view, and no landing/product thumbnails in the table).
- Product Insights UI polish: full-width main image + horizontal thumbnail strip with arrows; main image auto-balances height vs right-side content; Revenue + Demand charts moved to the left and collapsed by default (expand via standard card chevron).
- Product Insights modal now follows Settings -> Insights Suggest Mapping modal behavior/styles more closely (Tabler modal/backdrop flow, padded header, grey footer, standard secondary/primary footer buttons), removes duplicate title/type text under the image, and removes the subtitle under the modal title.
- Product Insights right panel renamed to **Product details** and now renders as a proper Tabler-style table with metric/value headers and progress-style rows.
- `/api/product-insights` now returns `details` with cached lifetime product fields: `totalSalesLifetime`, `totalRevenueLifetimeGbp`, `costOfGoodsLifetimeGbp`, plus stock details (`inventoryUnits`, `inStockVariants`) from Shopify product metadata.
- API updates:
  - `/api/product-insights`: supports `14d` + `30d`, returns `topCountries` and `links.adminProductUrl`.
  - `/api/dashboard-series`: includes `handle` in `topProducts` and trending items so the frontend can open Product Insights from Dashboard tables.
- Insights -> Variants mapping-issues badge now uses dark style, cleaner header spacing, and per-item **Ignore** actions in the modal.
- Added persistent table-scoped ignored variant titles in `insights_variants_config_v1` (`table.ignored`), with save-time validation and runtime diagnostics excluding ignored titles from unmapped/ambiguous counts.
- Settings -> Insights -> Variants now includes an **Ignore List** button + modal to review/remove ignored titles and save.
- Row-per-page selector rebind now runs after report-build finish (`kexo:table-rows-changed`) and after Variants rerenders; Variants "Configure variants" buttons enforce white text.

2026-02-12
- Dropdown border removed; Settings moved from strip to nav; Settings dropdown aligns left with menu, opens below nav (not strip).
- Settings dropdown inherits menu: same background, opacity filter, border, link/icon colors. Removed theme_header_settings_menu_* keys.
- Menu hover tint: theme_menu_hover_opacity (0–100%) + theme_menu_hover_color (black/white) control hover overlay on nav links and dropdown items.

2026-02-12 (earlier)
- Theme refactor: 3 accents → 5 editable hex inputs (accent 1–5); 8 former settings (strip/settings/menu/dropdown colors) derived from accent 1; added Strip/Menu opacity filters, strip padding, strip border-bottom toggle; removed icons from Header & Color section.
- Charts tab: fixed layout, map type input width, color swatches, pie metric dropdown (mobile-friendly).
- Sources tab: Tabler-style restyle with tiny images in grid.
- Fixed underline on hover for active settings menu items.

2026-02-12 (earlier)
- Handover audit pass: updated to current UI + routes + Settings capabilities.
- Icons are customizable via `data-icon-key` + Font Awesome runtime adapter (`server/public/fontawesome-icons.js`).
- Added global Charts settings (`charts_ui_config_v1`) + server-injected hide CSS via `/theme-vars.css`.
- Refactored Theme settings: moved all desktop header/nav/dropdown/settings/online color controls from Header tab into Color tab; Header tab now keeps non-color controls.
- Locked Theme primary palette to KEXO brand 5-color accents in both settings UI and `head-theme` early hydration.
- Fixed Settings → Charts initial render timing so chart mode/pie selectors render with correct defaults/selections when tab is opened.
- Added Insights → Variants page (`/insights/variants`) and API (`/api/insights-variants`) with configurable mapping tables, variant-specific sessions denominator (`?variant=<id>`), sortable/paginated tables (default 5 rows, options 5/10), and strict save validation in Settings → Insights → Variants that blocks unmapped/ambiguous configs with detailed diagnostics.
- Fixed Countries → Country + Product denominator in `getBestGeoProducts()` so Sessions/CR% use country+product-handle sessions (product landing sessions in that country), not all sessions for the country.
- Fixed Variants page first-load UX: disabled generic app loader path for `data-page="variants"` and added a script-level fail-safe that hides stale loader overlays; empty state now includes a **Configure variants** button linking to `Settings → Insights`.
- Updated default Styles mappings to: Style 1, Style 2, Style 3, Satellite, Belcher, Anchor (removed prior chain defaults like cable/curb/figaro/rope/etc).
- Fixed Settings → Insights → Variants save reliability by syncing all editor field values from DOM at save time (prevents stale draft data from being re-saved when users edit and immediately click Save).
- Variants mapping-issue badge is now clickable and opens a modal with unmapped/ambiguous variant examples plus mapped coverage summary (sessions/orders/revenue) to help diagnose unusually high CR%.
- Added dedicated icon keys for Insights → Variants table headers (`table-icon-variants-*`) so each column icon is individually configurable in Settings → Theme → Icons.
