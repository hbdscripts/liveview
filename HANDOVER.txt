Live Visitors / AI ENGINE — HANDOVER (keep current)
Last updated: 2026-02-05

This repo ships a private Shopify app that shows a near-real-time Live Visitors dashboard inside Shopify admin.
The dashboard is a single vanilla HTML page and the backend is a Node/Express server with SQLite/Postgres support.

IMPORTANT (for future agents)
- Keep this file accurate. If you change core paths (routes, schema, ingest fields, dashboard UX/auth/deploy), update this file in the SAME commit.
- This repo avoids creating new markdown docs; this handover is intentionally `HANDOVER.txt` (markdown-formatted text).

---

## What the app looks like today (user-facing)

Dashboard URL:
- `/app/live-visitors` (also `/` typically redirects here after app URL handling)

Main tabs (top row):
- Home: live visitors table + top KPI grid
  - KPI grid refreshes independently every ~60s via `GET /api/kpis` (shows a small spinner in each KPI while refreshing)
  - SSE drives live session updates + sale toast (desktop: Home shows as the birdseye PNG icon; mobile: tabs collapse into a hamburger menu with the birdseye logo centered between hamburger + date picker, plus a larger green logo above the dashboard)
  - Mobile-only: hide “Last Hour” quick-tab; “Next update” shows icon only (Live + pulse unchanged)
- Home “Landing Page” cell:
  - If both entry + exit pages are known, shows two overlapping thumbnails and two lines:
    - `Entry: <name>`
    - `Exit: <name>`
    - Exit thumbnail is smaller than entry (visual hierarchy)
  - Otherwise, shows the single thumbnail + label (existing behaviour)
- Breakdown: Countries + Average Order Value tables for selected date range
- Products: Best / Worst / Variants tables for selected date range (all tables show Sales / Clicks / Rev / CR)
- Traffic: two tables (Source + Traffic Type)
  - Channels table renders the same source icons used on the Home table (not text labels)

Global date range picker (applies to Breakdown + Products + Traffic):
- Today / Yesterday / Custom…
  - Custom opens a calendar popup (last 30 days). Grey dates have no session data.
  - Custom selection is represented internally as a day key: `d:YYYY-MM-DD` (admin timezone) and is supported across sessions/stats/products/traffic APIs.

Traffic tab (new)
- Layout:
  - Desktop: 2-column grid (50% / 50%) with two cards
  - Mobile: stacked (100% each)
- Tables:
  - Channels table: “Google Ads”, “Google Organic”, “Bing Ads”, “Bing Organic”, “Facebook Ads/Organic”, “Omnisend”, “Direct”, etc.
  - Traffic table: device → platform breakdown (expandable): Desktop/Mobile/Tablet parents with OS children (Windows/Mac/Linux/Chrome OS/iOS/Android/Unknown)
- Each table has a ⚙ settings button that opens a picker modal:
  - Shows every *detected* source/type (last ~30 days)
  - Tick which ones should appear in the tables
  - Selections persist across visits

---

## High-level architecture

Backend:
- `server/index.js`: Express app, routes, startup migrations, SSE wiring, cleanup timer
- DB: SQLite by default (local) or Postgres when `DB_URL` is set (production recommended)
- Migrations: `server/migrations/*.js` (run on startup and via `npm run migrate`)

Frontend:
- `server/public/live-visitors.html`: single-page dashboard (vanilla JS + Fetch + SSE)

Shopify:
- Pixel extension: `extensions/live-visitors-pixel/` (Shopify Web Pixels)
- Shopify Admin APIs used for sales/sessions/best-sellers endpoints

Edge (optional but used for better bot signals):
- Cloudflare Worker: `workers/ingest-enrich.js`
  - Enriches ingest requests with CF headers (country/colo/asn + bot signals)
  - Optional bot blocking at the edge (see `docs/CLOUDFLARE_INGEST_SETUP.md`)

---

## Data flow (end-to-end)

1) Storefront events
- Shopify Web Pixel sends events to `POST /api/ingest`
- Ingest requires `INGEST_SECRET` (header `X-Ingest-Secret` or Bearer auth)
- Cloudflare (optional) adds bot/geo signals via headers

2) Ingest processing
- `server/routes/ingest.js` parses request, applies whitelist, adds derived fields, writes events + session updates

3) Storage
- Central store logic in `server/store.js`
- Session upsert writes to `sessions` table (and related tables as needed)

4) Dashboard queries
- Home uses SSE: `GET /api/stream`
- Breakdown uses: `GET /api/stats`
- Traffic uses: `GET /api/traffic`
- Traffic prefs saved via: `POST /api/traffic-prefs`

---

## Traffic feature (what was implemented)

### Schema
Migration added:
- `server/migrations/021_sessions_traffic_fields.js`

New `sessions` columns (both SQLite + Postgres):
- `traffic_source_key` (TEXT): normalized marketing/source category (e.g. `google_ads`, `direct`)
- `ua_device_type` (TEXT): `desktop | mobile | tablet`
- `ua_platform` (TEXT): `windows | mac | ios | android | chromeos | linux | other`
- `ua_model` (TEXT, optional): e.g. `iphone`, `ipad` when detected

Indexes added for the above fields.

### Derivation + storage
Ingest UA parsing:
- `server/routes/ingest.js` derives `ua_device_type`, `ua_platform`, `ua_model` from the User-Agent string

Traffic source classification:
- `server/store.js` derives `traffic_source_key` using a “smart” cascade:
  - UTMs: `utm_source`, `utm_medium`, `utm_campaign`, `utm_content`
  - Click IDs in entry URL: `gclid`, `fbclid`, `msclkid`, etc.
  - Referrer host + internal-host detection
  - Fallback: `direct` when no usable signal

Session upsert:
- `server/store.js` `upsertSession` writes the derived fields into `sessions`
- UA fields are normalized (only allowed values) before write

### Traffic API
New module:
- `server/routes/traffic.js`

Endpoints:
- `GET /api/traffic?range=today|yesterday|d:YYYY-MM-DD` (legacy `3d`/`7d` still accepted)
  - Returns:
    - available sources/types (detected over recent window)
    - enabled sources/types (from settings)
    - breakdown rows for enabled items: sessions, orders, revenue (GBP), conversion rate
- `POST /api/traffic-prefs`
  - Body can include `sourcesEnabled` and/or `typesEnabled`
  - Persists to `settings` keys:
    - `traffic_sources_enabled`
    - `traffic_types_enabled`

### Traffic UI
File:
- `server/public/live-visitors.html`

Additions:
- New “Traffic” tab + panel
- Two responsive cards (Source / Traffic Type) with tables
- Two modals for selection pickers
- Auto-refresh integration (same cadence as Breakdown)

---

## Auth / access model (important)

Dashboard access:
- Requests originating from Shopify admin (Referer/Origin) are allowed (embedded app UX)
- Direct visits can require Google OAuth cookie when configured
- Middleware: `server/middleware/dashboardAuth.js`

API routes:
- Most `/api/*` routes are currently registered BEFORE `app.use(dashboardAuth.middleware)` in `server/index.js`,
  so they are effectively NOT protected by that middleware.
- The Traffic endpoints (`/api/traffic`, `/api/traffic-prefs`) intentionally follow this pattern so embedded usage works.
  (A previous route-level auth check was removed to prevent 401s in embedded contexts.)

If you decide to secure API routes:
- Be careful not to break embedded Shopify admin fetches
- Apply a consistent auth strategy (e.g. signed token / session that works in iframes)

---

## Deployment + ops notes

Deploy model:
- Push to `main` triggers deploy (Railway + GitHub Actions)
- The repo also uses `railway up` for manual deploys

Production pruning:
- `npm start` runs `scripts/prune-runtime-files.js` to remove non-runtime files from the runtime image
  (docs, scripts, workers, extensions, .cursor, .github, etc.)

DB persistence:
- SQLite is ephemeral on many hosts (Railway filesystem is ephemeral)
- Use Postgres (`DB_URL`) for persistence in production

---

## Guardrails / project conventions

- Do not delete rows from app tables (especially `purchases`). Handle over-reporting via dedupe in stats queries.
- Never delete or truncate `purchases`, `purchase_events`, `orders_shopify`, or `sessions` to “fix” mismatches vs Shopify. Fix mismatches by changing reporting sources, improving reconciliation, or using snapshots/backups.
- When making code/config changes: commit + push (deploys are push-driven).
- “Sentry” checks should be done via the `user-sentry` MCP tools (project: Node, org: lee-cooper, region: de).

---

## Sales, sessions, backups (non-destructive)

Core rule:
- **We never delete/truncate rows** in `purchases`, `purchase_events`, `orders_shopify`, or `sessions` to make numbers “match Shopify”.
- If numbers differ, we **change reporting sources** (truth vs pixel; our sessions vs Shopify sessions), run reconciliation, or add snapshots — we do **not** remove data.

Reporting source config (settings table):
- Orders source (`settings.key = reporting_orders_source`):
  - `orders_shopify` (default): report using Shopify Orders truth cached in `orders_shopify`
  - `pixel`: report using pixel-derived orders in `purchases` (deduped in queries; no deletes)
- Sessions source (`settings.key = reporting_sessions_source`):
  - `sessions` (default): report using our `sessions` table
  - `shopify_sessions`: report using `shopify_sessions_snapshots` (ShopifyQL snapshots)

Append-only audit tables:
- `reconcile_snapshots`: appended after every successful `salesTruth.reconcileRange` (shop/scope/range + Shopify orderCount/revenueGbp + fetched_at)
- `shopify_sessions_snapshots`: appended whenever we fetch Shopify sessions (and on-demand when using Shopify sessions reporting)

Verify vs reconcile:
- `GET /api/verify-sales`: **verify-only** drift (no reconciliation, no writes to `orders_shopify`). Optional: `?source=snapshot` uses latest `reconcile_snapshots`.
- `POST/GET /api/reconcile-sales`: reconciliation (Shopify → `orders_shopify`) and snapshot append.

Backups + recovery:
- Daily backups run in-process (fail-open) and keep the **last 7** backups.
- Manual/cron backup command: `npm run backup:daily` (runs `server/runDailyBackup.js`).
- SQLite backups:
  - Location: `server/backups/` (files like `live_visitors_daily_YYYYMMDD_HHMMSS.sqlite`)
  - Restore: stop the server and replace `live_visitors.sqlite` with a chosen backup file.
- Postgres backups:
  - Stored as backup tables (e.g. `orders_shopify_backup_daily_YYYYMMDD_HHMMSS`)
  - Restore: copy data from backup tables back into the live tables (do this carefully; prefer restoring to a new DB then switching `DB_URL`).
- Disable in-process scheduled backups with `DISABLE_SCHEDULED_BACKUPS=1`.

---

## Direction (where the app is heading)

Near-term direction:
- Build richer attribution + breakdowns without collecting PII:
  - More traffic sources (TikTok/Pinterest/Snap/Klaviyo/etc.)
  - Better device/platform splits (and optionally browser family later)
  - Use CF country/colo/asn for geo + network breakdowns
- Keep embedded Shopify admin experience smooth (avoid auth strategies that break iframe fetches)
- Keep stats “truthy” by relying on Shopify Orders truth/reconciliation where appropriate

Performance direction:
- If Traffic queries become heavy, consider:
  - caching by range
  - pre-aggregation tables for daily breakdowns

---

## Known weaknesses + remedies (high priority)

Report load speed (biggest pain):
- **Symptoms**: “Products” / “Breakdown” / “Traffic” reports can feel slow or appear stuck (client uses long fetches + overlays; server work can exceed client timeouts on large datasets).
- **Root causes** (current):
  - “Breakdown” + “Traffic” endpoints do multiple DB queries + joins; large `sessions` tables and wide ranges amplify this.
  - Shopify reconciliation (Orders API fetch) can still dominate first-run latency for a range (network + rate limiting).
  - Some caches are still **in-memory** (e.g. Shopify product metadata); persisted caching now exists for report payloads (see below).
  - SQLite in production is slow/ephemeral; Postgres is recommended for real shops.
- **Implemented (non-destructive)**:
  - **Persisted line-item facts**: `orders_shopify_line_items` (migration 025) populated during `server/salesTruth.js` reconciliation (UPSERT). Product reports are now SQL `GROUP BY` (no `orders_shopify.raw_json` parsing in request path).
  - **Persistent caching**: `report_cache` (migration 026) stores precomputed report payloads with TTL; used by `/api/shopify-best-sellers`, `/api/shopify-best-variants`, `/api/worst-products`, `/api/traffic`, `/api/stats`.
  - **Instrumentation**: lightweight per-endpoint timing logs (trigger with `?timing=1`, and also logs when slow).
- **Still recommended**:
  - **Daily rollups**: maintain `daily_stats` tables (orders/revenue/sessions by day + channel/device/etc.) and serve report ranges by summing days.
  - **More targeted indexes**: keep adding composite indexes matching the most expensive query patterns (especially for joined report queries).

Shopify sessions snapshots (new capability, still limited):
- Currently we snapshot Shopify “today” sessions in `shopify_sessions_snapshots` when fetched.
- For range reporting with Shopify sessions, we need either:
  - scheduled daily snapshots for every day, or
  - on-demand backfill (ShopifyQL `DURING YYYY-MM-DD`) with caching and rate-limit handling.

Backups durability:
- SQLite backups live in `server/backups/` (on-disk). On Railway ephemeral storage, this is **not durable**.
- For production, prefer:
  - Postgres with backup tables, plus a **real** external backup/export (or use managed Postgres backups),
  - or upload SQLite backups to durable storage (S3/R2) from a cron job.

---

## Changelog (high level)

2026-02-05
- KPI grid: independent ~60s refresh via `GET /api/kpis` with mini spinners while updating (no longer tied to Breakdown/Products/Traffic refresh cadence)
- Mobile: centered birdseye logo in main tabs bar + green logo header; hide “Last Hour”; “Next update” label hidden (icon only)
- Mobile: abbreviate table headers (TH labels) on small screens to avoid overlapping text
- KPIs: Returning revenue (Shopify truth) uses Shopify returning-customer signal (`orders_shopify.customer_orders_count >= 2`) rather than session “returning” heuristics
- Products: align Best/Worst/Variants tables to Sales / Clicks / Rev / CR (and add handle-based click counts to best sellers/variants)
- Products: product title column is responsive (more width + larger titles on desktop; clamped multi-line on smaller screens)
- Products: rename Variants → Best Variants and add Worst Variants (new endpoint `GET /api/shopify-worst-variants`)
- Traffic: Channels table renders source icons (same icon set as Home table Source column)
- Home table: when Entry+Exit are present, Exit thumbnail is smaller; cart value shown as whole £ (no decimals)
- UI: converted row highlight uses bg `#f6fefd`; table cells use font-weight 500
- Home table: Landing Page thumbs no longer use the `checkout.webp` placeholder (checkouts fall back to product thumb or icon)
- Diagnostics: redesigned config/diagnostics modal into a Shopify vs Birdseye grid + side-by-side diff table, with collapsible technical tabs (SVG icons)

2026-02-04
- Added Traffic tab (Source + Traffic Type) with persistent pickers
- Added derived traffic fields to `sessions` via migration 021
- Added `/api/traffic` + `/api/traffic-prefs`
- Date picker: change dropdown to Today / Yesterday / Custom (calendar for last 30 days)
  - Added `GET /api/available-days` and custom day keys `d:YYYY-MM-DD` across report endpoints
- Sales/sessions non-destructive foundations:
  - Added `reconcile_snapshots` + `shopify_sessions_snapshots` (append-only)
  - Added reporting source settings (`reporting_orders_source`, `reporting_sessions_source`) and wired stats/traffic/worst-products to use them
  - Made `/api/verify-sales` verify-only (no reconcile first), with optional snapshot compare
  - Added daily backup scheduling + `npm run backup:daily` (retain last 7)
- Dashboard: use footer settings SVG on Traffic pickers; show purchased badge as a tiny overlay on the landing thumbnail (and avoid the checkout placeholder for purchased sessions)
- Dashboard: make footer “Last sale” use authoritative truth/evidence timestamps (avoid “page load” false positives)
- Dashboard: mobile hamburger menu for main tabs; rename “Live” to “Now”; Live “Next update” becomes a pulsing dot + “Live”; Online indicator uses a user icon + spinner until real count is known
- Dashboard: add “Products” tab and move Best/Worst/Variants tables out of Breakdown
- Dashboard: show Entry + Exit pages in Home table when available (two thumbs, two-line label)
- Traffic: make “Traffic Type” hierarchical (Device → OS children with expand/collapse)
- Dashboard: Breakdown/Products/Traffic show a “building reports” overlay (with step text) until all tables are ready
- Performance: add persisted Shopify line-item facts (`orders_shopify_line_items`) + DB-backed report caching (`report_cache`) to make product/traffic reports fast and avoid cold-start “stuck building reports”
- Dashboard: replace Home tab SVG icon with birdseye PNG (25x25)
- Fix embedded app load loop (“cookies” error): render dashboard on the signed App URL request (avoid internal redirect) and allow signed `GET /` even if Referer is stripped
- Dashboard: sale toast overlays Sales+Sessions KPIs (flag + top product + order £) for 10s; Sales/Orders KPI ticks up after fade using a ticker animation (`/api/latest-sale`)
