KEXO Liveview — HANDOVER (keep current)
Last updated: 2026-02-09 (Remove per-page titles)

This repo ships a private Shopify app with a near-real-time Live Visitors dashboard. The frontend uses Tabler UI and is split into multiple HTML pages (instead of a single monolithic `live-visitors.html`).

IMPORTANT (for future agents)
- Keep this file accurate. If you change core paths (routes, auth, dashboard UX, deploy), update this file in the SAME commit.
- This repo avoids new markdown docs; this handover is intentionally `HANDOVER.txt`.
- UI convention: cap font-weight at 500 (avoid heavier weights) for new dashboard UI.
- Diagnostics guardrail: when adding/moving/removing dashboard sections, update `server/trackerDefinitions.js` so Diagnostics → Definitions stays accurate.

---

## Current UI structure (Tabler)

Pages (new, Tabler layout):
- `server/public/dashboard.html`
- `server/public/live.html`
- `server/public/overview.html`
- `server/public/countries.html`
- `server/public/products.html`
- `server/public/channels.html`
- `server/public/type.html`
- `server/public/ads.html`
- `server/public/tools.html`

Shared assets:
- `server/public/app.js`: shared JS bundle with per-page bootstrapping via `data-page` on `<body>`.
- `server/public/tabler-theme.css`: Tabler theme tokens + sticky navbar overlap styling.
- `server/public/tools.css`: tools page styles extracted from inline HTML.
- `server/public/diagnostics-modal.css`: diagnostics modal styling (still used across pages).

Legacy/backup:
- `server/public/live-visitors.html` kept as backup of the monolithic page.

---

## Routing + auth

Server routing (Express):
- Root `/` now loads the login screen or redirects to `/dashboard` if already authenticated.
- Explicit routes serve the per-page HTML: `/dashboard`, `/live`, `/overview`, `/countries`, `/products`, `/channels`, `/type`, `/ads`, `/tools`.
- See: `server/index.js`.

Auth protection:
- `server/middleware/dashboardAuth.js` protects per-page routes + API routes.
- Embedded Shopify app support: signed query requests and signed referers now work for ALL dashboard pages (not just `/`), so API calls don't 401 when navigating in an iframe.
- Login flow redirects to `/dashboard` after OAuth (`server/routes/login.js`).

---

## Per-page bootstrapping behavior

`server/public/app.js`:
- Uses `document.body.dataset.page` to decide which page to bootstrap.
- Highlights nav by setting `aria-current="page"`.
- Ads page lazily loads `/ads.js` when needed.
- Tools page hides shared KPI/date controls and skips auto-refresh.
- Embedded Shopify app support: internal nav links preserve Shopify signed query params (`shop`, `hmac`, `timestamp`, etc.) so auth does not break between pages.

---

## Dashboard (homepage) data wiring

`server/public/dashboard.html`:
- Homepage chart container IDs and table IDs are aligned to what `server/public/app.js` expects, so charts/tables render instead of showing empty state.

Date range normalization (frontend + backend):
- UI uses `7days/14days/30days`; APIs use `7d/14d/30d`. `server/public/app.js` normalizes keys before calling APIs.
- Backend now allows `14d/30d` where needed (routes + store).

Platform start/min date clamp:
- MIN_YMD + PLATFORM_START values were corrected back to 2025-02-01 so historical ranges aren't incorrectly clamped into the future.

---

## Tools page

- Rebuilt as Tabler layout (`server/public/tools.html`).
- All inline styles moved to `server/public/tools.css`.
- Back link points to `/dashboard`.
- `server/public/tools.js` uses class toggles instead of inline styles.

---

## Sticky navbar overlap

Tabler “navbar-overlap” layout applied:
- All new pages include `class="navbar-overlap-page"` on `<body>`.
- Sticky overlap styling lives in `server/public/tabler-theme.css`.

---

## Diagnostics modal

- Still uses `server/public/diagnostics-modal.css` and existing HTML hooks.
- If restyling is requested, update the modal markup + CSS to match Tabler components.

---

## Scripts

- `scripts/split-pages.js`: Node script used to split `live-visitors.html` into per-page Tabler templates.

---

## Deployment

- Pushes to `main` trigger deploy (GitHub Actions + Railway).

---

## Pending follow-ups (if requested)

- Full Tabler restyle of the Diagnostics modal.
- UI polish pass across new pages (align cards, spacing, cards in countries/products/channels/type).
## High-level architecture

Backend:
- `server/index.js`: Express app, routes, startup migrations, SSE wiring.
- DB: SQLite by default (local) or Postgres when `DB_URL` is set (production recommended).
- Migrations: `server/migrations/*.js`.

Frontend:
- `server/public/*`: multiple HTML pages (Tabler UI).
- Shared JS: `server/public/app.js`.

Shopify:
- Pixel extension: `extensions/live-visitors-pixel/`.
- Shopify Admin APIs for sales/sessions/best-sellers endpoints.

Edge (optional):
- Cloudflare Worker: `workers/ingest-enrich.js`.

---

## Data flow (end-to-end)

1) Storefront events
- Shopify Web Pixel sends events to `POST /api/ingest` (requires `INGEST_SECRET`).

2) Ingest processing
- `server/routes/ingest.js` parses requests, derives fields, writes events + sessions.

3) Storage
- `server/store.js` is the central store logic (sessions + stats queries).

4) Dashboard queries
- Live/SSE: `GET /api/stream`.
- Reports: `GET /api/kpis`, `/api/stats`, `/api/traffic`, `/api/worst-products`, `/api/shopify-best-sellers`.

---

## Deployment + ops notes

- Pushes to `main` trigger deploy (GitHub Actions + Railway).
- `npm start` runs `scripts/prune-runtime-files.js` (removes non-runtime files from the runtime image).
- SQLite is ephemeral on Railway; use Postgres (`DB_URL`) for persistence.

---

## Guardrails

- Do not delete rows from `purchases`, `purchase_events`, `orders_shopify`, or `sessions` to fix data drift.
- When changing dashboard sections, update `server/trackerDefinitions.js`.

---

## Changelog (summary)

2026-02-08
- Tabler UI rollout and split-page architecture (per-page HTML routes).
- Sticky navbar overlap layout and shared theme config (`tabler-theme.css`).
- Tools page rebuilt + styles moved to `tools.css`.

2026-02-09
- Fix “no data” on homepage: range-key normalization, correct min/platform-start clamps, and dashboard chart/table ID wiring.
- Auth hardening for embedded Shopify app: signed-query + signed-referer allowed across dashboard pages, and signed params propagated across internal links.
- Begin rollout of Tabler “navbar-sticky” two-part (white header + white menu) across pages; removes `navbar-brand-autodark`/dark theme usage that caused the logo to appear white.
- Products overview (`/products`): show an immediate loader, fix pagination controls (disable state + client-side paging), and add reliable card spacing so tables don’t touch.
- Navbar polish: top-nav link separators now adapt to dark mode, and top-nav items have no border radius (square edges).
- Mobile: topbar collapses action icons + date picker under a single settings dropdown (desktop unchanged).
- Removed per-page `<h2 class="page-title" id="page-title">…</h2>` headers; current page is indicated by the nav.
- Dashboard KPI correctness + consistency:
  - Returning Customers now uses returning-order rate (truth returning orders / total orders) instead of revenue share.
  - GBP formatting standardized (thousands separators) across KPI + dashboard secondary stats.
- Nav + theming:
  - Traffic dropdown now links to `/channels` and `/type` only (combined `/traffic` page removed).
  - Header/footer logo reverted to a single image (no dark-mode swap).
- Reliability/cleanup:
  - `ads.html` now includes `/ads.js` directly (still compatible with lazy-load logic).
  - Ads table totals row is rendered at the bottom (with a console sanity-check against campaign sums).
  - Ads profit now uses KEXO-attributed sales (purchases→sessions rollup); Google conversion value is not used for Sales/profit.
  - Grid-table headers use shared `kexo-grid-header` styling so headers match across pages.
  - Dashboard overview charts + top tables now respect the header date range (dashboard-series supports `range=` keys).
  - Shared Product Insights modal: clicking product thumbnails opens a Tabler modal with image gallery, Today-by-default range selector, KPI table, and charts powered by `/api/product-insights`.
  - Sessions table entry/exit links open the same modal, loading either product insights (for `/products/...`) or page insights (for non-product URLs) via `/api/page-insights`.
  - Removed dead breakdown auto-refresh timer and stale KPI comment in `app.js`.
  - De-duplicated grid-table CSS (kept definitions in `custom.css`).
  - Legacy `live-visitors.html` no longer references missing `/nav.css`.
  - Server-side include resolver: cache disabled in dev + missing include no longer crashes responses.
  - Dashboard series: secondary stats now use server `summary` fields (desktop/mobile + new/returning), and endpoint reconciles truth cache to avoid drift vs `/api/kpis`.
