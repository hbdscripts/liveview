Live Visitors / AI ENGINE — HANDOVER (keep current)
Last updated: 2026-02-05 (traffic source mapping fullscreen + key reuse)

This repo ships a private Shopify app that shows a near-real-time Live Visitors dashboard inside Shopify admin.
The dashboard is a single vanilla HTML page and the backend is a Node/Express server with SQLite/Postgres support.

IMPORTANT (for future agents)
- Keep this file accurate. If you change core paths (routes, schema, ingest fields, dashboard UX/auth/deploy), update this file in the SAME commit.
- This repo avoids creating new markdown docs; this handover is intentionally `HANDOVER.txt` (markdown-formatted text).

---

## What the app looks like today (user-facing)

Dashboard URL:
- `/app/live-visitors` (also `/` typically redirects here after app URL handling)

Main tabs (top row):
- Home: live visitors table + top KPI grid
  - KPI grid refreshes independently every ~60s via `GET /api/kpis` (shows a small spinner in each KPI while refreshing)
  - KPI grid: mobile is swipeable; desktop pages only when KPI labels wrap
  - SSE drives live session updates + sale toast (desktop: Home shows as the birdseye PNG icon; mobile: tabs collapse into a hamburger menu with the birdseye logo centered between hamburger + date picker)
  - Mobile-only: hide “Last Hour” quick-tab; “Next update” shows icon only (Live + pulse unchanged)
- Home “Landing Page” cell:
  - If both entry + exit pages are known, shows two overlapping thumbnails and two lines:
    - Entry line: green “<” + page name (screen-reader text includes “Entry:”)
    - Exit line: red “>” + page name (screen-reader text includes “Exit:”)
    - Exit thumbnail is smaller than entry (visual hierarchy)
  - Otherwise, shows the single thumbnail + label (existing behaviour)
- Breakdown: Countries + Best GEO Products + Average Order Value tables for selected date range
- Products: Best / Worst / Variants tables for selected date range (all tables show Sales / Clicks / Rev / CR)
- Traffic: two tables (Source + Traffic Type)
  - Channels table renders the same source icons used on the Home table (not text labels)

Global date range picker (applies to Breakdown + Products + Traffic):
- Today / Yesterday / Choose dates…
  - Choose dates opens a calendar popup (last 30 days). Grey dates have no session data.
  - Range selection: click a start day then an end day, preview highlights, then press Apply (Clear resets).
  - Custom ranges are represented as `r:YYYY-MM-DD:YYYY-MM-DD` (admin timezone). Legacy single-day keys `d:YYYY-MM-DD` are still accepted.
  - After applying, the dropdown shows the chosen date label (not “Custom”).
  - UX fix: “Choose dates…” remains re-selectable (dropdown resets after opening the modal, so you don’t have to click Today/Yesterday first).
  - Supported across: `/api/stats`, `/api/kpis`, `/api/traffic`, `/api/worst-products`, `/api/shopify-best-sellers`, `/api/shopify-best-variants`, `/api/shopify-worst-variants` (and `server/store.js#getRangeBounds`).

Traffic tab (new)
- Layout:
  - Desktop: 2-column grid (50% / 50%) with two cards
  - Mobile: stacked (100% each)
- Tables:
  - Channels table: “Google Ads”, “Google Organic”, “Bing Ads”, “Bing Organic”, “Facebook Ads/Organic”, “Omnisend”, “Direct”, etc.
  - Traffic table: device → platform breakdown (expandable): Desktop/Mobile/Tablet parents with OS children (Windows/Mac/Linux/Chrome OS/iOS/Android/Unknown)
- Each table has a ⚙ settings button that opens a picker modal:
  - Shows every *detected* source/type (last ~30 days)
  - Tick which ones should appear in the tables
  - Selections persist across visits
  - “Traffic · Sources” modal also contains a “Source mapping” section (click to open full-screen):
    - Shows unmapped UTM tokens detected in session entry URLs
    - Lets you map tokens → Sources (reuses built-in keys like `google_ads`/`bing_ads` when labels match; otherwise creates `custom_...`)
    - If a token is mapped again, the newest mapping wins (overrides earlier rules)
    - Icon previews fall back to built-in source icons when no custom icon URL is set

---

## Requested next work (not shipped yet)

- (none queued)

## High-level architecture

Backend:
- `server/index.js`: Express app, routes, startup migrations, SSE wiring, cleanup timer
- DB: SQLite by default (local) or Postgres when `DB_URL` is set (production recommended)
- Migrations: `server/migrations/*.js` (run on startup and via `npm run migrate`)

Frontend:
- `server/public/live-visitors.html`: single-page dashboard (vanilla JS + Fetch + SSE)

Shopify:
- Pixel extension: `extensions/live-visitors-pixel/` (Shopify Web Pixels)
- Shopify Admin APIs used for sales/sessions/best-sellers endpoints

Edge (optional but used for better bot signals):
- Cloudflare Worker: `workers/ingest-enrich.js`
  - Enriches ingest requests with CF headers (country/colo/asn + bot signals)
  - Optional bot blocking at the edge (see `docs/CLOUDFLARE_INGEST_SETUP.md`)

---

## Data flow (end-to-end)

1) Storefront events
- Shopify Web Pixel sends events to `POST /api/ingest`
- Ingest requires `INGEST_SECRET` (header `X-Ingest-Secret` or Bearer auth)
- Cloudflare (optional) adds bot/geo signals via headers

2) Ingest processing
- `server/routes/ingest.js` parses request, applies whitelist, adds derived fields, writes events + session updates

3) Storage
- Central store logic in `server/store.js`
- Session upsert writes to `sessions` table (and related tables as needed)

4) Dashboard queries
- Home uses SSE: `GET /api/stream`
- Breakdown uses: `GET /api/stats`
- Traffic uses: `GET /api/traffic`
- Traffic prefs saved via: `POST /api/traffic-prefs`

---

## Traffic feature (what was implemented)

### Schema
Migration added:
- `server/migrations/021_sessions_traffic_fields.js`

New `sessions` columns (both SQLite + Postgres):
- `traffic_source_key` (TEXT): normalized marketing/source category (e.g. `google_ads`, `direct`)
- `ua_device_type` (TEXT): `desktop | mobile | tablet`
- `ua_platform` (TEXT): `windows | mac | ios | android | chromeos | linux | other`
- `ua_model` (TEXT, optional): e.g. `iphone`, `ipad` when detected

Indexes added for the above fields.

### Derivation + storage
Ingest UA parsing:
- `server/routes/ingest.js` derives `ua_device_type`, `ua_platform`, `ua_model` from the User-Agent string

Traffic source classification:
- `server/store.js` derives `traffic_source_key` using a “smart” cascade:
  - UTMs: `utm_source`, `utm_medium`, `utm_campaign`, `utm_content`
  - Click IDs in entry URL: `gclid`, `fbclid`, `msclkid`, etc.
  - Referrer host + internal-host detection
  - Fallback: `direct` when zero referrer + no UTMs/click IDs; otherwise `other` (so sessions are never dropped from Traffic)

Custom source mapping (new):
- Migration: `server/migrations/027_traffic_source_maps.js`
  - Tables:
    - `traffic_source_tokens`: distinct UTM tokens observed from `sessions.entry_url` (+ counts + timestamps)
    - `traffic_source_rules`: mapping rules from `utm_param` + `utm_value` → `source_key` (supports multiple keys per token)
    - `traffic_source_meta`: per-source label + optional icon URL
- Store logic: `server/store.js`
  - On first capture of `sessions.entry_url`, extract allowed UTM params and upsert into `traffic_source_tokens` (for UI discovery)
  - `traffic_source_key` derivation consults `traffic_source_rules` first; if matched, the mapped `source_key` wins
  - When a new mapping rule is added, we backfill `traffic_source_key` for matching sessions (last ~30d) so the new source appears in Traffic immediately
- Endpoints (admin UI):
  - `GET /api/traffic-source-meta` (meta + rules for icon rendering)
  - `GET /api/traffic-source-maps` (tokens + rules + sources for config UI)
  - `POST /api/traffic-source-maps/map` (create mapping + source meta + backfill)
  - `POST /api/traffic-source-maps/meta` (update label/icon URL)
  - `POST /api/traffic-source-maps/backfill` (scan recent sessions to populate tokens table)

Session upsert:
- `server/store.js` `upsertSession` writes the derived fields into `sessions`
- UA fields are normalized (only allowed values) before write

### Traffic API
New module:
- `server/routes/traffic.js`

Endpoints:
- `GET /api/traffic?range=today|yesterday|d:YYYY-MM-DD` (legacy `3d`/`7d` still accepted)
  - Returns:
    - available sources/types (detected over recent window)
    - enabled sources/types (from settings)
    - breakdown rows for enabled items: sessions, orders, revenue (GBP), conversion rate
- `POST /api/traffic-prefs`
  - Body can include `sourcesEnabled` and/or `typesEnabled`
  - Persists to `settings` keys:
    - `traffic_sources_enabled`
    - `traffic_types_enabled`

### Traffic UI
File:
- `server/public/live-visitors.html`

Additions:
- New “Traffic” tab + panel
- Two responsive cards (Source / Traffic Type) with tables
- Two modals for selection pickers
- Auto-refresh integration (same cadence as Breakdown)

---

## Auth / access model (important)

Dashboard access:
- Requests originating from Shopify admin (Referer/Origin) are allowed (embedded app UX)
- Direct visits can require Google OAuth cookie when configured
- Middleware: `server/middleware/dashboardAuth.js`

API routes:
- Most `/api/*` routes are currently registered BEFORE `app.use(dashboardAuth.middleware)` in `server/index.js`,
  so they are effectively NOT protected by that middleware.
- The Traffic endpoints (`/api/traffic`, `/api/traffic-prefs`) intentionally follow this pattern so embedded usage works.
  (A previous route-level auth check was removed to prevent 401s in embedded contexts.)

If you decide to secure API routes:
- Be careful not to break embedded Shopify admin fetches
- Apply a consistent auth strategy (e.g. signed token / session that works in iframes)

---

## Deployment + ops notes

Deploy model:
- Push to `main` triggers deploy (Railway + GitHub Actions)
- The repo also uses `railway up` for manual deploys

Production pruning:
- `npm start` runs `scripts/prune-runtime-files.js` to remove non-runtime files from the runtime image
  (docs, scripts, workers, extensions, .cursor, .github, etc.)

DB persistence:
- SQLite is ephemeral on many hosts (Railway filesystem is ephemeral)
- Use Postgres (`DB_URL`) for persistence in production

---

## Guardrails / project conventions

- Do not delete rows from app tables (especially `purchases`). Handle over-reporting via dedupe in stats queries.
- Never delete or truncate `purchases`, `purchase_events`, `orders_shopify`, or `sessions` to “fix” mismatches vs Shopify. Fix mismatches by changing reporting sources, improving reconciliation, or using snapshots/backups.
- When making code/config changes: commit + push (deploys are push-driven).
- “Sentry” checks should be done via the `user-sentry` MCP tools (project: Node, org: lee-cooper, region: de).

---

## Sales, sessions, backups (non-destructive)

Core rule:
- **We never delete/truncate rows** in `purchases`, `purchase_events`, `orders_shopify`, or `sessions` to make numbers “match Shopify”.
- If numbers differ, we **change reporting sources** (truth vs pixel; our sessions vs Shopify sessions), run reconciliation, or add snapshots — we do **not** remove data.

Reporting source config (settings table):
- Orders source (`settings.key = reporting_orders_source`):
  - `orders_shopify` (default): report using Shopify Orders truth cached in `orders_shopify`
  - `pixel`: report using pixel-derived orders in `purchases` (deduped in queries; no deletes)
- Sessions source (`settings.key = reporting_sessions_source`):
  - `sessions` (default): report using our `sessions` table
  - `shopify_sessions`: report using `shopify_sessions_snapshots` (ShopifyQL snapshots)

Append-only audit tables:
- `reconcile_snapshots`: appended after every successful `salesTruth.reconcileRange` (shop/scope/range + Shopify orderCount/revenueGbp + fetched_at)
- `shopify_sessions_snapshots`: appended whenever we fetch Shopify sessions (and on-demand when using Shopify sessions reporting)

Verify vs reconcile:
- `GET /api/verify-sales`: **verify-only** drift (no reconciliation, no writes to `orders_shopify`). Optional: `?source=snapshot` uses latest `reconcile_snapshots`.
- `POST/GET /api/reconcile-sales`: reconciliation (Shopify → `orders_shopify`) and snapshot append.

Backups + recovery:
- Daily backups run in-process (fail-open) and keep the **last 7** backups.
- Manual/cron backup command: `npm run backup:daily` (runs `server/runDailyBackup.js`).
- SQLite backups:
  - Location: `server/backups/` (files like `live_visitors_daily_YYYYMMDD_HHMMSS.sqlite`)
  - Restore: stop the server and replace `live_visitors.sqlite` with a chosen backup file.
- Postgres backups:
  - Stored as backup tables (e.g. `orders_shopify_backup_daily_YYYYMMDD_HHMMSS`)
  - Restore: copy data from backup tables back into the live tables (do this carefully; prefer restoring to a new DB then switching `DB_URL`).
- Disable in-process scheduled backups with `DISABLE_SCHEDULED_BACKUPS=1`.

---

## Direction (where the app is heading)

Near-term direction:
- Build richer attribution + breakdowns without collecting PII:
  - More traffic sources (TikTok/Pinterest/Snap/Klaviyo/etc.)
  - Better device/platform splits (and optionally browser family later)
  - Use CF country/colo/asn for geo + network breakdowns
- Keep embedded Shopify admin experience smooth (avoid auth strategies that break iframe fetches)
- Keep stats “truthy” by relying on Shopify Orders truth/reconciliation where appropriate

Performance direction:
- If Traffic queries become heavy, consider:
  - caching by range
  - pre-aggregation tables for daily breakdowns

---

## Known weaknesses + remedies (high priority)

Report load speed (biggest pain):
- **Symptoms**: “Products” / “Breakdown” / “Traffic” reports can feel slow or appear stuck (client uses long fetches + overlays; server work can exceed client timeouts on large datasets).
- **Root causes** (current):
  - “Breakdown” + “Traffic” endpoints do multiple DB queries + joins; large `sessions` tables and wide ranges amplify this.
  - Shopify reconciliation (Orders API fetch) can still dominate first-run latency for a range (network + rate limiting).
  - Some caches are still **in-memory** (e.g. Shopify product metadata); persisted caching now exists for report payloads (see below).
  - SQLite in production is slow/ephemeral; Postgres is recommended for real shops.
- **Implemented (non-destructive)**:
  - **Persisted line-item facts**: `orders_shopify_line_items` (migration 025) populated during `server/salesTruth.js` reconciliation (UPSERT). Product reports are now SQL `GROUP BY` (no `orders_shopify.raw_json` parsing in request path).
  - **Persistent caching**: `report_cache` (migration 026) stores precomputed report payloads with TTL; used by `/api/shopify-best-sellers`, `/api/shopify-best-variants`, `/api/worst-products`, `/api/traffic`, `/api/stats`.
  - **Instrumentation**: lightweight per-endpoint timing logs (trigger with `?timing=1`, and also logs when slow).
- **Still recommended**:
  - **Daily rollups**: maintain `daily_stats` tables (orders/revenue/sessions by day + channel/device/etc.) and serve report ranges by summing days.
  - **More targeted indexes**: keep adding composite indexes matching the most expensive query patterns (especially for joined report queries).

Shopify sessions snapshots (new capability, still limited):
- Currently we snapshot Shopify “today” sessions in `shopify_sessions_snapshots` when fetched.
- For range reporting with Shopify sessions, we need either:
  - scheduled daily snapshots for every day, or
  - on-demand backfill (ShopifyQL `DURING YYYY-MM-DD`) with caching and rate-limit handling.

Backups durability:
- SQLite backups live in `server/backups/` (on-disk). On Railway ephemeral storage, this is **not durable**.
- For production, prefer:
  - Postgres with backup tables, plus a **real** external backup/export (or use managed Postgres backups),
  - or upload SQLite backups to durable storage (S3/R2) from a cron job.

---

## Changelog (high level)

2026-02-05
- Date picker: redesign “Custom” into “Choose dates…” range picker (two-click selection + highlight + Clear/Apply). Custom ranges use `r:YYYY-MM-DD:YYYY-MM-DD` (admin TZ), are accepted by all report endpoints (`/api/stats`, `/api/kpis`, products, traffic), and the dropdown displays the chosen dates (not “Custom”).
- Ingest/Sales evidence: on checkout_completed append purchase_events evidence (append-only), link to Shopify orders when possible (order_id / checkout_token), and also insert into `purchases` (pixel-derived “Birdseye” drift/debug).
- Fix: harden purchase dedupe keys to **ignore non-string checkout_token / order_id** (avoid `"[object Object]"` collapsing all purchases into one) and normalize order_id to stable numeric ids when possible.
- Ops: added migration `028_backfill_purchases_from_evidence` (one-time, idempotent) to backfill `purchases` from recent `purchase_events` using the original occurred_at timestamps (backdated). This is debug-only unless reporting source is switched to `pixel`.
- Edge: Worker ingest matcher now normalizes trailing slashes so `/api/ingest/` is treated as ingest (enrichment/bot handling applies consistently).
- KPI grid: independent ~60s refresh via `GET /api/kpis` with mini spinners while updating (no longer tied to Breakdown/Products/Traffic refresh cadence)
- Auto-refresh: non-live tables now refresh every 5 minutes (Today/Last Hour, Breakdown/Products/Traffic); Live remains 60s.
- UI: update Online user icon + standardise SVG icon colouring (match footer icons).
- Breakdown: add “Best GEO Products” card (top 3 products per country) powered by `/api/stats` (`bestGeoProducts` truth query: purchase_events → sessions.country_code + orders_shopify_line_items revenue).
- UI: fix product table names disappearing on large screens (product name cell no longer inherits country-table flex rules; name now reliably ellipsizes instead of collapsing).
- UI: browser tab title is now “Birdseye Tracker”.
- UI: restyle `/app/login` (Birdseye logo + green primary Google sign-in button).
- UI: sale toast (2-KPI overlay) restyled (green bg, bird icon, inline country flag, gold amount) + debug trigger `?birdseye_sale=1`.
- UI: dashboard + login favicon now uses `/assets/favicon.png` (local).
- UI: Home tab icon swaps to green image when active.
- UI: add vertical margin to Landing Page entry/exit lines block.
- UI: Entry/Exit labels use directional arrows in the Landing Page details.
- KPI grid: mobile swipe horizontally (no pager); desktop pager appears only if KPI labels wrap. KPI mini-spinners only show on first load (silent refreshes after).
- Mobile: centered birdseye logo in main tabs bar + green logo header; hide “Last Hour”; “Next update” label hidden (icon only)
- Mobile: table headers use icon abbreviations (Geo text) to avoid overlaps
- KPIs: Returning revenue (Shopify truth) uses Shopify returning-customer signal (`orders_shopify.customer_orders_count >= 2`) rather than session “returning” heuristics
- Products: align Best/Worst/Variants tables to Sales / Clicks / Rev / CR (and add handle-based click counts to best sellers/variants)
- Products: product title column is responsive (more width + larger titles on desktop; clamped multi-line on smaller screens)
- Products: rename Variants → Best Variants and add Worst Variants (new endpoint `GET /api/shopify-worst-variants`)
- Traffic: Channels table renders source icons (same icon set as Home table Source column)
- Home table: when Entry+Exit are present, Exit thumbnail is smaller; cart value shown as whole £ (no decimals)
- Home table: conversion badge on the landing thumbnail uses a green SVG icon (replaces the dollar image).
- UI: converted row highlight uses bg `#f6fefd`; table cells use font-weight 500
- Home table: Landing Page thumbs no longer use the `checkout.webp` placeholder (checkouts fall back to product thumb or icon)
- Diagnostics: redesigned config/diagnostics modal into a Shopify vs Birdseye grid + side-by-side diff table, with collapsible technical tabs (SVG icons)
- UI: make all dashboard table headers sortable on click (Home sessions + Breakdown/Products/Traffic tables), with sort arrows + keyboard (Enter/Space)
- UI: prevent duplicate “cha-ching” for a single sale (avoid double-trigger when order totals arrive later / KPI refresh drift)
- UI: sale toast: newest sale wins (no stale latest-sale overwrite) + add dismiss (×) button for faster clear
- UI: modernise pagination styling across all tables (pill buttons, chevrons, better disabled/hover, compact rows selector)
- UI: if a card has its own header bar (e.g. Traffic), only that bar is grey; table header row is white
- Traffic: add Direct + Other handling and a configurable “Source mapping” UI (map UTM tokens → custom sources + icon URLs); mapping affects Traffic picker, Traffic channels icons, and Home table source icons
- UI: remove duplicate mobile top-bar logo and update the centered tabs logo to the green Birdseye mark
- UI: landing thumbnails framed + stacked overlap tweak; hide purchase overlay and instead show a 3px green left bar on converted rows; update link colour (`--link-fg`)
- UI: update the Home tab active icon to use the latest green Birdseye asset
- UI: Landing Page entry/exit arrows now text “< >” (green/red) and mobile keeps entry/exit lines visible
- UI: table header abbreviations replaced with icons (country uses “Geo” text)
- UI: Best GEO Products now shows product thumbnails (flag + thumb; no country name)
- KPI grid: default value color is grey, with green/red highlight when ≥10% vs same time yesterday; mobile swipe, desktop pager when labels wrap
- UI: sale toast typography/amount styling refreshed (smaller product title, amount pill)
- UI: font-weight 500 only on converted row cells (not all tds)
- UI: dashboard favicon now uses the CDN asset
- UI: tables use green outer borders with zebra striping (no inner borders)
- UI: Breakdown AOV now renders as a card strip above the country/geo tables, and pagination only shows to balance table heights
- UI: Best-by-GEO row pill styling added around product thumbs
- UI: mobile icon headers shift sort arrows up for clearer alignment
- UI: icon-mode tables round revenue values to whole pounds
- UI: desktop tables render revenue decimals smaller than the whole-pound value
- UI: table borders reverted to neutral; converted row accent sits on the table edge
- UI: Landing Page entry/exit arrows now use SVG chevrons (entry →, exit ←); /pages/contact shows as “Contact”
- UI: hide “Rows” label in mobile pagination to prevent line wrapping
- UI: KPI neutral color set to #444 (red/green thresholds unchanged)
- Mobile: replace the date range select with a compact “Date” button (calendar icon) that opens a small menu (Today/Yesterday/Choose dates…)
- UI: Best-by-GEO first column no longer forces white backgrounds; row striping stays consistent
- Mobile: product names in product tables truncate to a single line with ellipsis (no 3-line wraps)
- UI: product name styling uses normal font-weight (400) and no clamp-based sizing/line-clamping
- UI: pagination controls are now joined (segmented) and hover no longer lifts buttons
- UI: AOV cards use neutral border + subtle shadow (matches table card styling)
- UI: breakdown table zebra striping applies cleanly across first column (flag/thumb) without white blocks
- UI: Live table pagination is a single joined control (Prev / page / Next / Rows) without hover lift
- UI: rows-per-page selector removed; Live sessions pagination defaults to 25 rows
- UI: sessions table now expands to fill the card width (prevents blank white area to the right on wide screens)
- UI: tweak landing entry/exit stack spacing (landing-lines margin + remove gap)
- UI: map `/account/login` to “Login” in Landing Page entry/exit labels
- UI: widen Landing Page column + remove max-width clamp to prevent entry/exit layout spilling into adjacent columns
- Mobile: Breakdown tables stack 100% width (override `.stats-row.breakdown-row` two-column grid on small screens)
- Mobile: date button width tightened to 55px
- UI: card pagination controls use a 30px tall segmented style (tighter padding/gaps)
- UI: removed the converted-row left accent pseudo-element (`::before`) in the sessions table
- UI: KPI grid shows green up-arrow / red down-arrow SVG at end of value when better/worse vs yesterday
- Traffic: Source mapping panel opens full-screen from the Traffic · Sources modal and uses larger input boxes for faster mapping
- Traffic: mapping now prefers built-in keys/icons (e.g. Google/Bing) and remapping a token overrides older rules (newest wins)

2026-02-04
- Added Traffic tab (Source + Traffic Type) with persistent pickers
- Added derived traffic fields to `sessions` via migration 021
- Added `/api/traffic` + `/api/traffic-prefs`
- Date picker: change dropdown to Today / Yesterday / Custom (calendar for last 30 days)
  - Added `GET /api/available-days` and custom day keys `d:YYYY-MM-DD` across report endpoints
- Sales/sessions non-destructive foundations:
  - Added `reconcile_snapshots` + `shopify_sessions_snapshots` (append-only)
  - Added reporting source settings (`reporting_orders_source`, `reporting_sessions_source`) and wired stats/traffic/worst-products to use them
  - Made `/api/verify-sales` verify-only (no reconcile first), with optional snapshot compare
  - Added daily backup scheduling + `npm run backup:daily` (retain last 7)
- Dashboard: use footer settings SVG on Traffic pickers; show purchased badge as a tiny overlay on the landing thumbnail (and avoid the checkout placeholder for purchased sessions)
- Dashboard: make footer “Last sale” use authoritative truth/evidence timestamps (avoid “page load” false positives)
- Dashboard: mobile hamburger menu for main tabs; rename “Live” to “Now”; Live “Next update” becomes a pulsing dot + “Live”; Online indicator uses a user icon + spinner until real count is known
- Dashboard: add “Products” tab and move Best/Worst/Variants tables out of Breakdown
- Dashboard: show Entry + Exit pages in Home table when available (two thumbs, two-line label)
- Traffic: make “Traffic Type” hierarchical (Device → OS children with expand/collapse)
- Dashboard: Breakdown/Products/Traffic show a “building reports” overlay (with step text) until all tables are ready
- Performance: add persisted Shopify line-item facts (`orders_shopify_line_items`) + DB-backed report caching (`report_cache`) to make product/traffic reports fast and avoid cold-start “stuck building reports”
- Dashboard: replace Home tab SVG icon with birdseye PNG (25x25)
- Fix embedded app load loop (“cookies” error): render dashboard on the signed App URL request (avoid internal redirect) and allow signed `GET /` even if Referer is stripped
- Dashboard: sale toast overlays Sales+Sessions KPIs (flag + top product + order £) for 10s; Sales/Orders KPI ticks up after fade using a ticker animation (`/api/latest-sale`)
