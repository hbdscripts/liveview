---
description: Prevent whole-site spinner/hang regressions
globs:
alwaysApply: true
---

# Runtime hang guardrails (always-on)

When users report "site down", "stuck loader", "spins forever", or "everything is slow", treat this as a production incident.

## Incident workflow (mandatory)

- Query Sentry **spans/transactions** first (Performance), not only Issues.
- Check last 30-60 minutes for slow transactions on:
  - `GET /dashboard/overview`
  - `GET /api/kpis`
  - `GET /api/kexo-score`
  - `GET /api/kpis-expanded-extra`
- Include `release` in queries and verify whether the latest pushed release is receiving traffic.
- Do not declare fixed until newer traces show improved latency (not only "no exceptions").

## Coding guardrails (mandatory)

- Never use a global mutable Postgres transaction client shared across requests.
  - Transaction context must be request-scoped (e.g. `AsyncLocalStorage`).
- Do not `await` long-running reconcile/backup/network work in hot request paths.
  - For user-facing routes/APIs, run slow warmups in the background and fail-open.
- Keep pre-reconcile backups non-blocking for request lifecycle.

## Regression guardrail

- Keep `test/runtime-hang-guardrails.test.js` passing.
- If changing DB transaction plumbing or KPI/truth reconciliation behavior, update the guardrail test in the same commit.
