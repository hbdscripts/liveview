---
description: Never delete database data without a backup
globs: 
alwaysApply: true
---

# Database: no deletes without backup

- **Do not delete rows from app tables** (e.g. `purchases`, `sessions`, `events`) in application code or migrations unless a backup of the affected data has been taken first (or the operation is explicitly required and documented).
- **Purchase/sales data**: We never delete from `purchases`. Over-reporting is handled by **dedupe in stats queries only** (e.g. exclude duplicate h: rows when a token/order row exists for the same session+total+currency+15min). See `server/store.js` (`purchaseFilterExcludeDuplicateH`, `getSalesTotal`, `getConvertedCount`, etc.).
- If a migration or feature would delete data, either: (1) skip the delete and handle dedupe in queries, or (2) document that a backup must be taken before running, or (3) make the delete opt-in or reversible.
