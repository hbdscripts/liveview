# =============================================================================
# Kexo – copy to .env and fill. For Railway: set same vars in Service → Variables.
# Base URL for this app: https://app.kexo.io
# =============================================================================

# --- Shopify app (from Partners or Admin → Apps → Develop apps) ---
# Client ID from app overview
SHOPIFY_API_KEY=
# Client secret (click "Show" on the app)
SHOPIFY_API_SECRET=
# Must be this app's public URL (no trailing slash). Same as shopify.app.toml application_url.
SHOPIFY_APP_URL=https://app.kexo.io
# Scopes; must include write_pixels/read_customer_events for pixel API and read_shopify_payments for Snapshot fee/app-bill breakdowns.
# NOTE: read_all_orders is required to match Shopify "returning customers" when prior orders are older than 60 days.
SHOPIFY_SCOPES=read_products,read_orders,read_all_orders,write_pixels,read_customer_events,read_reports,read_shopify_payments

# --- Pixel ingest (required for dashboard to receive events) ---
# Generate once: node scripts/generate-ingest-secret.js  then paste below and into pixel extension settings
INGEST_SECRET=
# Optional: CF-proxied ingest hostname so pixel traffic goes through Cloudflare (Worker + bot header). No trailing slash. If set, pixel Ingest URL = INGEST_PUBLIC_URL/api/ingest; otherwise SHOPIFY_APP_URL/api/ingest.
INGEST_PUBLIC_URL=https://ingest.kexo.io
# Optional: comma-separated origins allowed for ensure?ingestUrl= (e.g. https://lv-ingest.hbdjewellery.com). Set this too so replicas without INGEST_PUBLIC_URL can accept the script’s URL override.
ALLOWED_INGEST_ORIGINS=https://ingest.kexo.io

# --- Display ---
ADMIN_TIMEZONE=Europe/London

# --- Sales Truth (Shopify Orders cache) ---
# Reconcile cadence for "today" (Shopify Orders API → orders_shopify). 60–120s recommended.
SALES_TRUTH_RECONCILE_MIN_INTERVAL_SECONDS=90

# --- Time windows (minutes unless noted) ---
ACTIVE_WINDOW_MINUTES=5
# Live dashboard: only show sessions that arrived within this many minutes (default 60)
LIVE_ARRIVED_WINDOW_MINUTES=60
RECENT_WINDOW_MINUTES=15
SESSION_TTL_MINUTES=1440
# Retention for stats stability: cleanup deletes sessions only when BOTH last_seen and started_at are older than this (days)
SESSION_RETENTION_DAYS=30
ABANDONED_WINDOW_MINUTES=15
ABANDONED_RETENTION_HOURS=24
RETURNING_GAP_MINUTES=30
CHECKOUT_STARTED_WINDOW_MINUTES=15

# --- Database ---
# Local: leave empty (SQLite file). Railway: REQUIRED – add Postgres service, then Variables → DB_URL = Postgres connection string (e.g. from Postgres service → Connect → DATABASE_URL)
DB_URL=

# --- Tracking default (DB setting can override at runtime) ---
TRACKING_DEFAULT_ENABLED=true
# Stats traffic filter: all (default) or human_only (exclude cf_known_bot=1). Dashboard can override via ?traffic=human.
TRAFFIC_MODE=all

# --- Limits ---
MAX_EVENTS_PER_SESSION=50
MAX_EVENT_PAYLOAD_BYTES=8192
RATE_LIMIT_EVENTS_PER_MINUTE=120

# --- Sentry (optional). Project → Settings → Client Keys (DSN). Leave empty to disable.
SENTRY_DSN=

# --- Fraud / affiliate abuse detection (optional) ---
# Secret salt used to hash IP/UA (HMAC-SHA256). Never store raw IPs.
FRAUD_IP_SALT=
# Optional AI narrative generation (never blocks dashboards). Requires OPENAI_API_KEY.
FRAUD_AI_ENABLED=false
OPENAI_API_KEY=

# --- Dashboard: direct visit = Google sign-in only (from Shopify Admin = no login) ---
# Google Cloud Console → APIs & Services → Credentials → Create OAuth 2.0 Client ID (Web application)
# Authorized redirect URI: https://app.kexo.io/auth/google/callback
GOOGLE_CLIENT_ID=
GOOGLE_CLIENT_SECRET=
# Sign session cookie (generate once): node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
OAUTH_COOKIE_SECRET=
# Optional: comma-separated emails that can sign in. Empty = any Google account.
ALLOWED_GOOGLE_EMAILS=
# Storefront domain when dashboard opened without ?shop= (e.g. mystore.myshopify.com). Used for product thumbnails and for Today Sales from Shopify when visiting directly. Falls back to ALLOWED_SHOP_DOMAIN.
SHOP_DOMAIN=
# Main/public store URL for product images and links (e.g. https://www.hbdjewellery.com). When set, dashboard uses this for og-thumb and last-action links instead of Shopify URL.
STORE_MAIN_DOMAIN=
# Display domain for sidebar badge (e.g. hbdjewellery.com). When set, overrides storeMainDomain/shopDomain so badge shows custom domain not myshopify.com.
SHOP_DISPLAY_DOMAIN=
# Base URL for dashboard assets (favicon.png, checkout.webp, cash-register.mp3, adwords.png). When set, dashboard loads these from this URL to save app bandwidth. No trailing slash.
ASSETS_BASE_URL=

# --- Cloudflare R2 (uploads for Settings → Assets) ---
# S3 API credentials (Cloudflare dashboard → R2 → Manage R2 API Tokens)
R2_ACCOUNT_ID=
R2_ACCESS_KEY_ID=
R2_SECRET_ACCESS_KEY=
R2_BUCKET=
# Public base URL where uploaded objects are served from (no trailing slash). Example: https://assets.yourdomain.com
R2_PUBLIC_BASE_URL=
